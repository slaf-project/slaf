<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/apple-touch-icon.png" />
    <link rel="manifest" crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          // Guard against race condition where iframe isn't ready
          if (!obj.contentWindow?.document?.documentElement) {
            return;
          }
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        // Only observe if iframe content is ready
        if (obj.contentWindow?.document?.body) {
          resizeObserver.observe(obj.contentWindow.document.body);
        }
      }
    </script>
    <marimo-filename hidden>02-lazy-processing.py</marimo-filename>
    <!-- TODO(Trevor): Legacy, required by VS Code plugin. Remove when plugin is updated (see marimo/server/_templates/template.py) -->
    <marimo-version data-version="{{ version }}" hidden></marimo-version>
    <marimo-user-config data-config="{{ user_config }}" hidden></marimo-user-config>
    <marimo-server-token data-token="{{ server_token }}" hidden></marimo-server-token>
    <!-- /TODO -->
    <title>02-lazy-processing</title>
    <script type="module" crossorigin crossorigin="anonymous" src="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/index-CmLKiEd5.js"></script>
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/preload-helper-DImqtvgl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/chunk-DZLz74EQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/react-BcIddLXZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/jsx-runtime-DvsdsEjx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-CLazWf1X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/react-dom-D6bRRS5R.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/namespace-Cw55ynVb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/cn-CwmWKpZ_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-BiHHvE7B.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/menu-items-CE6I2UvI.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useEventListener-g9rPKvBX.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/tslib.es6-C9vXkBtU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/fullscreen-DoREeXhW.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/events-BGfCi1Xy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-DT6vyuIM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/createLucideIcon-Dz-D6iuz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/check-CmOWIaur.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/select-DIqNYEaz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/accordion-D8h6M7fo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/chevron-right-kGH9aJGk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dropdown-menu-D3tww20d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/tooltip-CW-4dtRh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/Logger-BkkOJyg0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/hotkeys-ZAWHeY7d.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/react-7g8sREeT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_Uint8Array-D5Z9rM2X.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_getTag-CVRrQL_Q.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_baseIsEqual-BF8660ot.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/invariant-B43sqCFA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/isArrayLikeObject-DKyJYtr8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/merge-BgA7kxZb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/zod-U2NFpcFA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/utils-DLuqCLqV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/requests-BW3DqHQI.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/once-4nUTgcVU.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/toDate-BNd9AHNi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_baseSlice-B27Cqkm6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_arrayMap-DQI2GUNb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/isSymbol-xTSywenE.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/toString-CBnct2wx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_hasUnicode-CPHpt5EV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/upperFirst-DOlTOwhh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/capitalize-CkrfIDeS.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/ai-model-dropdown-D-i9tuGn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/documentation-B7z6bB-t.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/badge-Cbb7s63B.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/button-g1jf7cM6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/use-toast-BKA5A0CC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/constants-Cv7-oioA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/Deferred-Mppm0cvJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/config-BeIk_wvs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/uuid-4lb_EYpq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/key-Pb6bybhb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/connection-UyRAkvTk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useLifecycle-DmdhGVVs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useNonce-DvpkYOW9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useTheme-BWXNjHkw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/createReducer-CFr1RdS2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-BNtnpgX8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-B8v7AWk6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-Ct0a8Isf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-AWYmVWdt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-Q2QzNScK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-BFifaB39.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-D80s9YgJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-Nl79A0iO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-CtJ8WONl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/stex-w1KpyykF.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_baseProperty-CIKnF2iY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/toNumber-CTOPJrpu.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/now-B6JN1xKT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/debounce-70y9MzDK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/toInteger-Bor4StOs.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/type-CYsuWFDa.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/marked.esm-BB_RKOA5.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/main-CCaZmKLi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/cells-BEhFXxEH.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/kbd-CrDndhyw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/renderShortcut-Bjp5Xukk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useEvent-itkPNnCe.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useDeleteCell-CIqS2s5l.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/icons-15z_NdNZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/spinner-fS9J74Ro.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/datasource-CwGVmPnG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/add-missing-import-0FwDfOhv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/ansi_up-CAiCs1Gk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/blob-BC4M7Onc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dom-Ckypy4pz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/errors-CmwnOe1B.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/extends-B47kqttt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/objectWithoutPropertiesLoose-ClrKK0Xi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/esm-Bp1Lbm07.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/es-Ctpp-mTr.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/play-C5VC4Hal.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/sparkles-DLotTEZ2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/shim-FF_l0CN4.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/add-cell-with-ai-BQY4AwHL.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/ErrorBoundary-Bj7QJPi8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/alert-dialog-DiIW1jDy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dialog-gSaRWBIN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useDebounce-BZnPO5jA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/numbers-P4hvbAnW.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/context-BwP_-Md9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useNumberFormatter-BQOmTFFk.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/input-DGY-1Oes.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/ImperativeModal-DSAh6fUR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/filename-dpoTdlj9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/cell-link-D8x9Ez3U.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/alert-D4GhiyiD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/links-DH7hmhHO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/state-5DtoeNLQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/MarimoErrorOutput-CD3rG7IK.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/copy-BxPDuBrN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/copy-CGWkBrzb.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/copy-icon-7_c6G_tO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/RenderHTML-B398JcWn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/emotion-is-prop-valid.esm-Tm8TdcWf.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/with-selector-ChXsBWGQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/JsonOutput-BU4PIFXg.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_arrayReduce-DDpPg0Qh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/startCase-DOk4LYuA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/strings-CrHTFiMt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/command-W6QvsWS0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/popover-IOch2AIR.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/table-CMFDmrFM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/tabs-CswUuyA0.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useAsyncData-BB0ZlY9B.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/LazyAnyLanguageCodeMirror-CInCxHCy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/error-banner-CHF-jGs2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/defaultLocale-DEWTIUVh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/precisionRound-BLxyDkD7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/defaultLocale-B9-NA0ur.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/vega-loader.browser.module-B3yPAbRZ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/loader-BcHzCbiy.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/formats-Dbfcbsil.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/en-US-D7J6fBFv.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/isValid-BxWQIw0s.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dates-D2l0yAKQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/download-RtEDTktT.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/maps-duCv2i7k.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useDateFormatter-BapFytxP.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/range-BB1DXJJn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/list-filter-DQ2_e3bh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/columns-BeFC1dXm.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/focus-BP3h9dJJ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useInstallPackage-CDwTdPy7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/column-preview-CC6unPyM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useAddCell-ClSRUhA6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/toggle-DL9DPBMc.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useHotkey-CivJpvvx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/globals-BGEnYYSz.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/mode-kUHLEZT6.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/share-ChWJhz87.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/dist-I8SxGjN9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/memoize-CAcr7Wct.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_toKey-Di_xoXjD.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_baseSet-Dmzd-CnA.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/utilities.esm-Dj3BexHh.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/floating-outline-CwHsH4x8.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/eye-off-wMFrY47K.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/plus-Ckxr6pwY.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/readonly-python-code-DI18L7Ip.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/file-video-camera-D5oKA5-e.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/file-text-Ds68BFYI.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/file-BX8VjCCQ.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/types-Zo5TA9DG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/label-CFxcdBki.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/form-mBAxBzPt.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/textarea-BcNYHZLG.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/circle-x-CPCvpiTN.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/refresh-ccw-D1hQMnx_.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/trash-2-Cex53SxB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/form-CN-qI0dC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/field-D-WfasXC.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/switch-C2Bk9ykO.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useBoolean-7LAl9weo.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/useDeepCompareMemoize-CbO9MTKn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/types-TRUculCV.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/prop-types-ShpF60yB.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/es-W4OhtMWM.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/VisuallyHidden-BfudlHw2.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_baseFlatten-8yEsQJi9.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/get-BYzWDFJH.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/hasIn-WaG0qjy7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/_basePickBy-6ZBTv_cn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/pick-BZA77Trx.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/square-DpWGO_-7.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/chart-no-axes-column-3piSAXMi.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/download-CHejLEQn.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/globe-TqnwljOq.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/send-D9MERKWw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/refresh-cw-CmHE3eNl.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/settings-ByREbWaw.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/square-function-B5j-8u3J.js">
    <link rel="modulepreload" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/bundle.esm-BoludFkg.js">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/documentation-BvrC6Bsv.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/columns-j3zW187k.css">
    <link rel="stylesheet" crossorigin crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/@marimo-team/frontend@0.17.0/dist/assets/index-DrbV-Ps3.css">

<script data-marimo="true">
    window.__MARIMO_STATIC__ = {};
    window.__MARIMO_STATIC__.files = {};
</script>
</head>
  <body>
    <div id="root"></div>
    <!-- This is a portal for the data editor to render in -->
    <div id="portal" data-testid="glide-portal" style="position: fixed; left: 0; top: 0; z-index: 9999"></div>
    <script data-marimo="true">
      window.__MARIMO_MOUNT_CONFIG__ = {
            "filename": "02-lazy-processing.py",
            "mode": "read",
            "version": "0.17.0",
            "serverToken": "static",
            "config": {"ai": {"models": {"custom_models": [], "displayed_models": []}}, "completion": {"activate_on_typing": true, "copilot": false}, "diagnostics": {"sql_linter": true}, "display": {"cell_output": "above", "code_editor_font_size": 14, "dataframes": "rich", "default_table_max_columns": 50, "default_table_page_size": 10, "default_width": "medium", "reference_highlighting": false, "theme": "light"}, "formatting": {"line_length": 79}, "keymap": {"overrides": {}, "preset": "default"}, "language_servers": {"pylsp": {"enable_flake8": false, "enable_mypy": true, "enable_pydocstyle": false, "enable_pyflakes": false, "enable_pylint": false, "enable_ruff": true, "enabled": true}}, "mcp": {"mcpServers": {}, "presets": []}, "package_management": {"manager": "pip"}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "default_sql_output": "auto", "on_cell_change": "autorun", "output_max_bytes": 8000000, "reactive_tests": true, "std_stream_max_bytes": 1000000, "watcher_on_save": "lazy"}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "server": {"browser": "default", "follow_symlink": false}, "snippets": {"custom_paths": [], "include_default_snippets": true}},
            "configOverrides": {},
            "appConfig": {"sql_output": "auto", "width": "medium"},
            "view": {"showAppCode": true},
            "notebook": {"cells": [{"code": "import time\n\nimport marimo as mo\nimport numpy as np\nfrom scipy.sparse import csr_matrix\n\nfrom slaf.integrations import scanpy as slaf_scanpy\nfrom slaf.integrations.anndata import read_slaf", "code_hash": "ed00924d0b1dc03b23b23907ed6bd955", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hbol", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n# SLAF Lazy Processing Deep Dive\n\nThis notebook explores SLAF's lazy evaluation capabilities in detail. You'll learn how to:\n\n- Build complex analysis pipelines without loading data\n- Apply multiple transformations efficiently\n- Use different slicing patterns\n- Control when computation happens\n- Understand performance benefits\n\n**Key Concept**: Lazy evaluation means operations are stored as instructions and only executed when you explicitly request the results.\n\n**Key Benefits:**\n- \ud83d\ude80 **Instant Pipeline Building**: No waiting for data loading\n- \ud83d\udcbe **Memory Efficient**: Only load what you need\n- \ud83d\udd04 **Composable**: Operations can be combined and preserved\n- \u26a1 **SQL Performance**: Leverage database-level optimizations\n- \ud83e\uddec **Scanpy Compatible**: Familiar interface with performance benefits\n\"\"\"\n)", "code_hash": "6377adf053e9550184c48dd346df4127", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "MJUe", "name": "_"}, {"code": "# Load data for lazy processing examples\nadata = read_slaf(\"../slaf-datasets/pbmc3k_processed.slaf\")\nprint(f\"\u2705 Loaded dataset: {adata.shape[0]:,} cells \u00d7 {adata.shape[1]:,} genes\")\nprint(f\"   Type: {type(adata)}\")\nprint(f\"   Expression matrix type: {type(adata.X)}\")", "code_hash": "1b3a67a5f4de2dd7e33027b6ffe747db", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "vblA", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 1. Understanding Lazy Objects\n\nSLAF provides two main lazy object types:\n\n- **LazyAnnData**: Lazy version of AnnData with scanpy compatibility\n\n- **LazyExpressionMatrix**: Lazy version of the expression matrix\n\"\"\"\n)", "code_hash": "75f5c8abad0ffa3e12f1e8ea9d969ccd", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "bkHC", "name": "_"}, {"code": "# Demonstrate lazy object types\nprint(\"\ud83d\udd0d Lazy Object Types\")\nprint(\"=\" * 30)\n\nprint(f\"1. LazyAnnData type: {type(adata)}\")\nprint(f\"   - Shape: {adata.shape}\")\nprint(\n    f\"   - Obs columns: {list(adata.obs.columns) if hasattr(adata, 'obs') and adata.obs is not None else 'Not loaded'}\"\n)\nprint(\n    f\"   - Var columns: {list(adata.var.columns) if hasattr(adata, 'var') and adata.var is not None else 'Not loaded'}\"\n)\n\nprint(f\"\\n2. LazyExpressionMatrix type: {type(adata.X)}\")\nprint(f\"   - Shape: {adata.X.shape}\")\nprint(\n    f\"   - Parent: {type(adata.X.parent_adata) if hasattr(adata.X, 'parent_adata') else 'None'}\"\n)\n\nprint(\"\\n3. Key insight: These objects store operations, not data!\")\nprint(\"   - No data is loaded until you call .compute()\")\nprint(\"   - Operations are composed efficiently\")\nprint(\"   - Memory usage stays low\")", "code_hash": "92a84b2748225d0e982a0654322e63a6", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "lEQa", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 2. Explicit Computation Control\n\nYou control when data is actually computed using these methods:\n\"\"\"\n)", "code_hash": "a5cb9b5af5e969c286ca73720febe56e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "PKri", "name": "_"}, {"code": "def demonstrate_computation_control():\n    # Demonstrate explicit computation control\n    print(\"\ud83c\udf9b\ufe0f Explicit Computation Control\")\n    print(\"=\" * 35)\n\n    print(\"Available computation methods:\")\n    print(\"1. adata.compute() \u2192 native AnnData object\")\n    print(\"2. adata.X.compute() \u2192 scipy.sparse.csr_matrix\")\n    print(\"3. adata.obs \u2192 pandas.DataFrame (cell metadata)\")\n    print(\"4. adata.var \u2192 pandas.DataFrame (gene metadata)\")\n\n    print(\"\\nLet's demonstrate:\")\n\n    # Compute just the expression matrix\n    print(\"\\n1. Computing expression matrix...\")\n    start_time = time.time()\n    sparse_matrix = adata.X.compute()\n    compute_time = time.time() - start_time\n    print(f\"   \u2705 Computed in {compute_time:.4f}s\")\n    print(f\"   Type: {type(sparse_matrix)}\")\n    print(f\"   Shape: {sparse_matrix.shape}\")\n    print(f\"   Memory: {sparse_matrix.data.nbytes / 1024 / 1024:.1f} MB\")\n\n    # Access cell metadata\n    print(\"\\n2. Accessing cell metadata...\")\n    start_time = time.time()\n    obs_df = adata.obs\n    obs_time = time.time() - start_time\n    print(f\"   \u2705 Accessed in {obs_time:.4f}s\")\n    print(f\"   Type: {type(obs_df)}\")\n    print(f\"   Shape: {obs_df.shape}\")\n\n    return (sparse_matrix, obs_df)\n\nsparse_matrix, obs_df = demonstrate_computation_control()", "code_hash": "5b178fc99a1c074c19665d89a06f9f4c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Xref", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 3. Slicing Patterns - All the Ways to Slice\n\nSLAF supports multiple slicing patterns, all of which are lazy:\n\"\"\"\n)", "code_hash": "c63d9fc9f55bad77978773a461777efa", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "SFPL", "name": "_"}, {"code": "# Demonstrate different slicing patterns\ndef demonstrate_slicing_patterns(adata):\n    print(\"\u2702\ufe0f Slicing Patterns\")\n    print(\"=\" * 25)\n\n    print(\"1. Basic integer slicing:\")\n    slice1 = adata[:100, :50]\n    print(f\"   adata[:100, :50] \u2192 {type(slice1)} with shape {slice1.shape}\")\n\n    print(\"\\n2. Expression matrix slicing:\")\n    slice2 = adata.X[:100, :50]\n    print(f\"   adata.X[:100, :50] \u2192 {type(slice2)} with shape {slice2.shape}\")\n\n    print(\"\\n3. Boolean indexing (after QC metrics are available):\")\n    # First add some QC metrics\n    if (\n        hasattr(adata, \"obs\")\n        and adata.obs is not None\n        and \"n_genes_by_counts\" in adata.obs.columns\n    ):\n        high_quality_mask = adata.obs[\"n_genes_by_counts\"] > 1000\n        slice3 = adata[high_quality_mask, :]\n        print(\n            f\"   adata[high_quality_mask, :] \u2192 {type(slice3)} with shape {slice3.shape}\"\n        )\n    else:\n        print(\n            \"   (QC metrics not available yet - will be computed in preprocessing section)\"\n        )\n\n    print(\"\\n4. Mixed indexing:\")\n    slice4 = adata[:100, adata.var.index[:50]]\n    print(\n        f\"   adata[:100, adata.var.index[:50]] \u2192 {type(slice4)} with shape {slice4.shape}\"\n    )\n\n    print(\"\\nKey insight: All slicing returns lazy objects!\")\n\ndemonstrate_slicing_patterns(adata)", "code_hash": "199d1d90390bd28f946f91839a475656", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "BYtC", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 4. Transformation Patterns\n\nSLAF supports lazy transformations that are stored and applied when needed:\n\"\"\"\n)", "code_hash": "8dcce7dd085aa1c193e37db381119a96", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "RGSE", "name": "_"}, {"code": "# Load fresh data for transformation examples\nadata_fresh = read_slaf(\"../slaf-datasets/pbmc3k_processed.slaf\")\nprint(\"\u2705 Loaded fresh dataset for transformations\")", "code_hash": "dab326a7d7603e0f09f85c86171ff8aa", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Kclp", "name": "_"}, {"code": "# Demonstrate transformation patterns\nprint(\"\ud83d\udd04 Transformation Patterns\")\nprint(\"=\" * 30)\n\nprint(\"1. Single transformation:\")\nadata_norm = slaf_scanpy.pp.normalize_total(\n    adata_fresh, target_sum=1e4, inplace=False\n)\nprint(f\"   normalize_total() \u2192 {type(adata_norm)}\")\nprint(\n    f\"   Transformations stored: {list(adata_norm._transformations.keys()) if hasattr(adata_norm, '_transformations') else 'None'}\"\n)\n\nprint(\"\\n2. Chained transformations:\")\nadata_processed = slaf_scanpy.pp.normalize_total(\n    adata_fresh, target_sum=1e4, inplace=False\n)\nadata_processed = slaf_scanpy.pp.log1p(adata_processed, inplace=False)\nprint(f\"   normalize_total().log1p() \u2192 {type(adata_processed)}\")\nprint(\n    f\"   Transformations stored: {list(adata_processed._transformations.keys()) if hasattr(adata_processed, '_transformations') else 'None'}\"\n)\n\nprint(\"\\n3. Transformation on sliced data:\")\n# First slice, then apply transformation (safer pattern)\nslice_data = adata_fresh[:100, :50]\nslice_transformed = slaf_scanpy.pp.normalize_total(\n    slice_data, target_sum=1e4, inplace=False\n)\nprint(f\"   adata[:100, :50].normalize_total() \u2192 {type(slice_transformed)}\")\nprint(f\"   Shape: {slice_transformed.shape}\")\n\nprint(\"\\n4. Multiple transformations on slice:\")\n# First slice, then apply transformations (safer pattern)\nslice_data = adata_fresh[:100, :50]\nslice_multi = slaf_scanpy.pp.normalize_total(\n    slice_data, target_sum=1e4, inplace=False\n)\nslice_multi = slaf_scanpy.pp.log1p(slice_multi, inplace=False)\nprint(f\"   Multiple transformations on slice \u2192 {type(slice_multi)}\")\nprint(\n    f\"   Transformations: {list(slice_multi._transformations.keys()) if hasattr(slice_multi, '_transformations') else 'None'}\"\n)", "code_hash": "90470737f8e58133255f917a2d70b750", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "emfo", "name": "_"}, {"code": "def demonstrate_transformation_application():\n    # Demonstrate transformation application\n    print(\"\u26a1 Applying Transformations\")\n    print(\"=\" * 30)\n\n    print(\"1. Computing transformed data:\")\n    start_time = time.time()\n    native_processed = adata_processed.compute()\n    process_time = time.time() - start_time\n    print(f\"   \u2705 Computed in {process_time:.4f}s\")\n    print(f\"   Type: {type(native_processed)}\")\n    print(f\"   Shape: {native_processed.shape}\")\n\n    print(\"\\n2. Computing transformed slice:\")\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    native_slice_matrix = slice_transformed.X.compute()\n    slice_time = time.time() - start_time\n    print(f\"   \u2705 Computed in {slice_time:.4f}s\")\n    print(f\"   Type: {type(native_slice_matrix)}\")\n    print(f\"   Shape: {native_slice_matrix.shape}\")\n\n    print(\"\\n3. Computing multi-transformed slice:\")\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    native_multi_matrix = slice_multi.X.compute()\n    multi_time = time.time() - start_time\n    print(f\"   \u2705 Computed in {multi_time:.4f}s\")\n    print(f\"   Type: {type(native_multi_matrix)}\")\n    print(f\"   Shape: {native_multi_matrix.shape}\")\n\n    return (native_processed, native_slice_matrix, native_multi_matrix)\n\ndemonstrate_transformation_application()", "code_hash": "62e478d2b023db6c22f2b1be709a793e", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Hstk", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 5. Transformation Preservation Through Operations\n\nTransformations are preserved through slicing and other operations:\n\"\"\"\n)", "code_hash": "31cc1e49d33335690bedb214b1570f4d", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nWHF", "name": "_"}, {"code": "# Load fresh data for preservation examples\nadata_preserve = read_slaf(\"../slaf-datasets/pbmc3k.slaf\")", "code_hash": "9f46c11315ca9c36ae8db9e93d02530b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "iLit", "name": "_"}, {"code": "# Demonstrate transformation preservation\nprint(\"\ud83d\udd04 Transformation Preservation\")\nprint(\"=\" * 35)\n\nprint(\"1. Apply transformations first, then slice:\")\nadata_transformed = slaf_scanpy.pp.normalize_total(\n    adata_preserve, target_sum=1e4, inplace=False\n)\nadata_transformed = slaf_scanpy.pp.log1p(adata_transformed, inplace=False)\nslice_after = adata_transformed[:100, :50]\nprint(\n    f\"   Original transformations: {list(adata_transformed._transformations.keys()) if hasattr(adata_transformed, '_transformations') else 'None'}\"\n)\nprint(\n    f\"   Slice transformations: {list(slice_after._transformations.keys()) if hasattr(slice_after, '_transformations') else 'None'}\"\n)\n\nprint(\"\\n2. Slice first, then apply transformations:\")\nslice_before = adata_preserve[:100, :50]\ntransformed_slice = slaf_scanpy.pp.normalize_total(\n    slice_before, target_sum=1e4, inplace=False\n)\ntransformed_slice = slaf_scanpy.pp.log1p(transformed_slice, inplace=False)\nprint(f\"   Transformed slice: {type(transformed_slice)}\")\nprint(\n    f\"   Transformations: {list(transformed_slice._transformations.keys()) if hasattr(transformed_slice, '_transformations') else 'None'}\"\n)\n\nprint(\"\\n3. Complex slicing patterns preserve transformations:\")\nprint(\n    \"   Note: Chained slicing (e.g., adata[:200, :100][:50, :25]) is not supported.\"\n)\nprint(\"   Use single-step slicing instead: adata[50:250, 25:125]\")\n\n# Single-step slicing (equivalent to nested slicing)\nsingle_step_slice = adata_transformed[50:250, 25:125]\nprint(f\"   Single-step slice: {type(single_step_slice)}\")\nprint(\n    f\"   Transformations preserved: {list(single_step_slice._transformations.keys()) if hasattr(single_step_slice, '_transformations') else 'None'}\"\n)\n\n# Boolean mask slicing\ncell_mask = np.zeros(adata_transformed.shape[0], dtype=bool)\ncell_mask[50:250] = True\ngene_mask = np.zeros(adata_transformed.shape[1], dtype=bool)\ngene_mask[25:125] = True\nboolean_slice = adata_transformed[cell_mask, gene_mask]\nprint(f\"   Boolean mask slice: {type(boolean_slice)}\")\nprint(\n    f\"   Transformations preserved: {list(boolean_slice._transformations.keys()) if hasattr(boolean_slice, '_transformations') else 'None'}\"\n)\n\n# Step slicing\nstep_slice = adata_transformed[::4, ::2]  # Every 4th cell, every 2nd gene\nprint(f\"   Step slice: {type(step_slice)}\")\nprint(\n    f\"   Transformations preserved: {list(step_slice._transformations.keys()) if hasattr(step_slice, '_transformations') else 'None'}\"\n)", "code_hash": "c138eff20683fb4432bde50af820ae29", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZHCJ", "name": "_"}, {"code": "def verify_transformation_preservation():\n    # Verify transformation preservation by computing\n    print(\"\u2705 Verifying Transformation Preservation\")\n    print(\"=\" * 40)\n\n    print(\"1. Computing slice with preserved transformations:\")\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    result1 = slice_after.X.compute()\n    time1 = time.time() - start_time\n    print(f\"   \u2705 Computed in {time1:.4f}s\")\n    print(f\"   Type: {type(result1)}\")\n    print(f\"   Shape: {result1.shape}\")\n\n    print(\"\\n2. Computing slice with applied transformations:\")\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    result2 = transformed_slice.X.compute()\n    time2 = time.time() - start_time\n    print(f\"   \u2705 Computed in {time2:.4f}s\")\n    print(f\"   Type: {type(result2)}\")\n    print(f\"   Shape: {result2.shape}\")\n\n    print(\"\\n3. Computing single-step slice with preserved transformations:\")\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    result3 = single_step_slice.X.compute()\n    time3 = time.time() - start_time\n    print(f\"   \u2705 Computed in {time3:.4f}s\")\n    print(f\"   Type: {type(result3)}\")\n    print(f\"   Shape: {result3.shape}\")\n\nverify_transformation_preservation()", "code_hash": "db504fe99748952d3271dfa968c75d56", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ROlb", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 6. Performance Benefits - Building Complex Pipelines\n\nLet's see how lazy evaluation enables efficient complex pipelines:\n\"\"\"\n)", "code_hash": "87bb153b5d40e6bd9067b2faef2f8e30", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "qnkX", "name": "_"}, {"code": "# Demonstrate performance benefits\n\ndef demonstrate_complex_pipeline(adata):\n    print(\"\u26a1 Performance Benefits\")\n    print(\"=\" * 25)\n\n    print(\"1. Building complex pipeline (no computation yet):\")\n    start_time = time.time()\n\n    # Build a complex pipeline\n    pipeline = slaf_scanpy.pp.normalize_total(adata, target_sum=1e4, inplace=False)\n    pipeline = slaf_scanpy.pp.log1p(pipeline, inplace=False)\n\n    # Note: highly_variable_genes returns a DataFrame, not a LazyAnnData object\n    # so it can't be chained in the pipeline like other transformations\n\n    # Slice the processed data\n    final_slice = pipeline[:500, :200]\n\n    build_time = time.time() - start_time\n    print(f\"   \u2705 Pipeline built in {build_time:.4f}s\")\n    print(f\"   Final object: {type(final_slice)}\")\n    print(\n        \"   Expected shape: (500, 200)\"\n    )  # Avoid accessing .shape on transformed slice\n    print(\n        f\"   Transformations: {list(final_slice._transformations.keys()) if hasattr(final_slice, '_transformations') else 'None'}\"\n    )\n\n    print(\"\\n2. Computing the final result:\")\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    final_result = final_slice.X.compute()\n    compute_time = time.time() - start_time\n    print(f\"   \u2705 Computed in {compute_time:.4f}s\")\n    print(f\"   Type: {type(final_result)}\")\n    print(f\"   Shape: {final_result.shape}\")\n\n    print(f\"\\n3. Total time: {build_time + compute_time:.4f}s\")\n    print(\n        \"   Key insight: Pipeline building is instant, computation happens only when needed!\"\n    )\n\ndemonstrate_complex_pipeline(adata)", "code_hash": "3b710cc181d374a19352beaef1e67062", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TqIu", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 7. Memory Efficiency Comparison\n\nLet's compare memory usage between lazy and eager approaches:\n\"\"\"\n)", "code_hash": "7f9fa546b1b9f8744da767eb2af75d33", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Vxnm", "name": "_"}, {"code": "# Memory efficiency comparison\nprint(\"\ud83d\udcbe Memory Efficiency Comparison\")\nprint(\"=\" * 35)\n\nimport gc\n\nimport psutil\n\ndef get_memory_usage():\n    \"\"\"Get current memory usage in MB\"\"\"\n    process = psutil.Process()\n    return process.memory_info().rss / 1024 / 1024\n\n# Load fresh data\nadata_mem = read_slaf(\"../slaf-datasets/pbmc3k_processed.slaf\")\n\nprint(\"1. Memory after loading lazy data:\")\ngc.collect()\nlazy_memory = get_memory_usage()\nprint(f\"   Lazy loading: {lazy_memory:.1f} MB\")\n\nprint(\"\\n2. Memory after computing full dataset:\")\ngc.collect()\nstart_memory = get_memory_usage()\n_ = adata_mem.compute()\nend_memory = get_memory_usage()\nprint(f\"   Eager loading: {end_memory:.1f} MB\")\nprint(f\"   Memory increase: {end_memory - start_memory:.1f} MB\")\n\nprint(\"\\n3. Memory after computing small slice:\")\ngc.collect()\nslice_memory_before = get_memory_usage()\n_ = adata_mem[:100, :50].compute()\nslice_memory_after = get_memory_usage()\nprint(f\"   Small slice: {slice_memory_after:.1f} MB\")\nprint(f\"   Memory increase: {slice_memory_after - slice_memory_before:.1f} MB\")\n\nprint(\n    f\"\\nKey insight: Lazy loading uses {lazy_memory:.1f} MB vs eager loading {end_memory:.1f} MB\"\n)\nprint(f\"Memory savings: {((end_memory - lazy_memory) / end_memory * 100):.1f}%\")", "code_hash": "99fff8ad7e20569c9edd28c26927ac0a", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "DnEU", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 8. Advanced Slicing Patterns\n\nLet's explore more advanced slicing patterns:\n\"\"\"\n)", "code_hash": "c7949aa9588890c8628bbf631d148263", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ulZA", "name": "_"}, {"code": "# Advanced slicing patterns\nprint(\"\ud83d\udd2c Advanced Slicing Patterns\")\nprint(\"=\" * 35)\n\n# Load data and add QC metrics\nadata_advanced = read_slaf(\"../slaf-datasets/pbmc3k_processed.slaf\")\nslaf_scanpy.pp.calculate_qc_metrics(adata_advanced, inplace=True)\n\nprint(\"1. Boolean indexing with QC metrics:\")\nhigh_quality_mask = adata_advanced.obs[\"n_genes_by_counts\"] > 1000\nhigh_quality_cells = adata_advanced[high_quality_mask, :]\nprint(f\"   High quality cells: {high_quality_cells.shape}\")\n\nprint(\"\\n2. Gene-based filtering:\")\nif (\n    hasattr(adata_advanced, \"var\")\n    and adata_advanced.var is not None\n    and \"highly_variable\" in adata_advanced.var.columns\n):\n    hvg_mask = adata_advanced.var[\"highly_variable\"]\n    hvg_genes = adata_advanced[:, hvg_mask]\n    print(f\"   Highly variable genes: {hvg_genes.shape}\")\nelse:\n    print(\"   (Highly variable genes not available yet)\")\n\nprint(\"\\n3. Combined cell and gene filtering:\")\ncombined = adata_advanced[high_quality_mask, :100]\nprint(f\"   Combined filtering: {combined.shape}\")\n\nprint(\"\\n4. Expression-based filtering:\")\n# Get cells with high total counts\nhigh_counts_mask = adata_advanced.obs[\"total_counts\"] > 2000\nhigh_counts_cells = adata_advanced[high_counts_mask, :]\nprint(f\"   High count cells: {high_counts_cells.shape}\")", "code_hash": "dffdba99970cf8c9c6e6f630db42c1b8", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ecfG", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 9. Lazy vs Eager Performance Comparison\n\nLet's compare the performance of lazy vs eager approaches:\n\"\"\"\n)", "code_hash": "e44442767b8873d3214ad6e019ecdce0", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "Pvdt", "name": "_"}, {"code": "# Performance comparison\ndef compare_lazy_vs_eager_performance(adata):\n    print(\"\u26a1 Lazy vs Eager Performance\")\n    print(\"=\" * 35)\n\n    # Test scenario: Apply transformations and slice\n    print(\"Scenario: normalize_total \u2192 log1p \u2192 slice[:100, :50]\")\n\n    # Lazy approach\n    print(\"\\n1. Lazy approach:\")\n    adata_lazy = adata\n\n    start_time = time.time()\n    lazy_pipeline = slaf_scanpy.pp.normalize_total(\n        adata_lazy, target_sum=1e4, inplace=False\n    )\n    lazy_pipeline = slaf_scanpy.pp.log1p(lazy_pipeline, inplace=False)\n    lazy_slice = lazy_pipeline[:100, :50]\n    lazy_build_time = time.time() - start_time\n\n    start_time = time.time()\n    # Use .X.compute() to avoid the metadata mismatch issue\n    _ = lazy_slice.X.compute()\n    lazy_compute_time = time.time() - start_time\n\n    print(f\"   Build time: {lazy_build_time:.4f}s\")\n    print(f\"   Compute time: {lazy_compute_time:.4f}s\")\n    print(f\"   Total time: {lazy_build_time + lazy_compute_time:.4f}s\")\n\n    # Eager approach (simulated)\n    print(\"\\n2. Eager approach (simulated):\")\n\n    start_time = time.time()\n    _ = adata.compute()\n    eager_load_time = time.time() - start_time\n\n    # Simulate eager transformations (this would be done in memory)\n    print(f\"   Load time: {eager_load_time:.4f}s\")\n    print(\"   Transformations would be done in memory (slower for large datasets)\")\n\n    print(\"\\n3. Key benefits:\")\n    print(\"   - Lazy: Build complex pipelines instantly\")\n    print(\"   - Lazy: Only compute what you need\")\n    print(\"   - Lazy: Memory efficient\")\n    print(\"   - Lazy: SQL-level performance for operations\")\n\ncompare_lazy_vs_eager_performance(adata)", "code_hash": "9f270672f0d74f498325e648828e5372", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "ZBYS", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 10. Best Practices and Tips\n\nHere are some best practices for using SLAF's lazy evaluation:\n\"\"\"\n)", "code_hash": "8c92a9bf3966af0721a5b557dc7b5265", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "aLJB", "name": "_"}, {"code": "# Best practices\nprint(\"\ud83d\udca1 Best Practices and Tips\")\nprint(\"=\" * 30)\n\nprint(\"1. Pipeline Building:\")\nprint(\"   \u2705 Build complete pipelines before computing\")\nprint(\"   \u2705 Chain transformations: adata.normalize_total().log1p()\")\nprint(\"   \u2705 Slice after transformations for efficiency\")\n\nprint(\"\\n2. Computation Control:\")\nprint(\"   \u2705 Use .compute() only when you need the data\")\nprint(\"   \u2705 Use .obs or .var for metadata\")\nprint(\"   \u2705 Use .X.compute() for expression matrix only\")\n\nprint(\"\\n3. Memory Management:\")\nprint(\"   \u2705 Keep lazy objects for intermediate results\")\nprint(\"   \u2705 Compute only final results\")\nprint(\"   \u2705 Use slicing to reduce memory usage\")\n\nprint(\"\\n4. Performance Optimization:\")\nprint(\"   \u2705 Leverage SQL-level operations\")\nprint(\"   \u2705 Use boolean indexing for filtering\")\nprint(\"   \u2705 Combine operations in single queries when possible\")\n\nprint(\"\\n5. Debugging:\")\nprint(\"   \u2705 Check object types: type(adata)\")\nprint(\"   \u2705 Check transformations: adata._transformations\")\nprint(\"   \u2705 Use .info() for dataset overview\")", "code_hash": "30984769f5ac44466ef17d45e8db9ef9", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "nHfw", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 11. Working with Layers\n\nSLAF supports AnnData layers (alternative expression matrices) stored in the `layers.lance` table.\n\nLet's create a synthetic dataset with layers, convert it to SLAF, and demonstrate layer operations:\n\"\"\"\n)", "code_hash": "ec34aed38fcedd25305a4521175d3bcc", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "xXTn", "name": "_"}, {"code": "# Create synthetic AnnData with layers, obsm, varm, and uns for demonstration\nimport scanpy as sc\n\n# Create a small synthetic dataset\nn_cells, n_genes = 200, 500\nnp.random.seed(42)\n\n# Main expression matrix\nX = csr_matrix(np.random.lognormal(0, 1, (n_cells, n_genes)).astype(np.float32))\n\n# Create AnnData object\nadata_synthetic = sc.AnnData(X=X)\n\n# Add obs metadata\nadata_synthetic.obs[\"cell_type\"] = np.random.choice(\n    [\"T_cell\", \"B_cell\", \"NK_cell\"], n_cells\n)\nadata_synthetic.obs[\"total_counts\"] = X.sum(axis=1).A1\n\n# Add var metadata\nadata_synthetic.var[\"highly_variable\"] = np.random.choice(\n    [True, False], n_genes, p=[0.2, 0.8]\n)\n\n# Add layers (alternative expression matrices)\nadata_synthetic.layers[\"spliced\"] = csr_matrix(\n    np.random.lognormal(0, 1, (n_cells, n_genes)).astype(np.float32)\n)\nadata_synthetic.layers[\"unspliced\"] = csr_matrix(\n    np.random.lognormal(0, 1, (n_cells, n_genes)).astype(np.float32)\n)\n\n# Add obsm (cell embeddings)\nadata_synthetic.obsm[\"X_umap\"] = np.random.randn(n_cells, 2).astype(np.float32)\nadata_synthetic.obsm[\"X_pca\"] = np.random.randn(n_cells, 50).astype(np.float32)\n\n# Add varm (gene embeddings)\nadata_synthetic.varm[\"PCs\"] = np.random.randn(n_genes, 50).astype(np.float32)\n\n# Add uns (unstructured metadata)\nadata_synthetic.uns[\"neighbors\"] = {\n    \"params\": {\"n_neighbors\": 15, \"metric\": \"euclidean\"}\n}\nadata_synthetic.uns[\"pca\"] = {\n    \"variance_ratio\": np.random.rand(50).tolist(),\n    \"variance\": np.random.rand(50).tolist(),\n}\n\nprint(\n    f\"\u2705 Created synthetic AnnData: {adata_synthetic.shape[0]} cells \u00d7 {adata_synthetic.shape[1]} genes\"\n)\nprint(f\"   Layers: {list(adata_synthetic.layers.keys())}\")\nprint(f\"   Obsm: {list(adata_synthetic.obsm.keys())}\")\nprint(f\"   Varm: {list(adata_synthetic.varm.keys())}\")\nprint(f\"   Uns: {list(adata_synthetic.uns.keys())}\")", "code_hash": "1e4303d5a8ce81d235ba476a43c4e071", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "AjVT", "name": "_"}, {"code": "# Convert synthetic AnnData to SLAF format\nimport os\nimport tempfile\n\nfrom slaf.data.converter import SLAFConverter\n\n# Create temporary directory for SLAF dataset\ntemp_dir = tempfile.mkdtemp()\nslaf_path = os.path.join(temp_dir, \"synthetic_with_metadata.slaf\")\n\n# Convert to SLAF (use chunked=False for small in-memory AnnData objects)\nconverter = SLAFConverter(chunked=False)\nconverter.convert_anndata(adata_synthetic, slaf_path)\nprint(f\"\u2705 Converted synthetic dataset to SLAF: {slaf_path}\")", "code_hash": "78ff2fe88138b6d0529954b648835e0b", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "pHFh", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## 12. Working with Metadata Views\n\nSLAF provides lazy views for all AnnData metadata objects (obs, var, obsm, varm, uns):\n\"\"\"\n)", "code_hash": "d43f82cd098ddea3a74681fe9e41ab38", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "NCOB", "name": "_"}, {"code": "# Load the converted SLAF dataset with all metadata\nadata_metadata = read_slaf(slaf_path)\nprint(\n    f\"\u2705 Loaded SLAF dataset: {adata_metadata.shape[0]} cells \u00d7 {adata_metadata.shape[1]} genes\"\n)", "code_hash": "6197495b9ed0ee3d7f0ae334f31c44af", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "aqbW", "name": "_"}, {"code": "def demonstrate_layers():\n    print(\"\ud83d\udcda Working with Layers\")\n    print(\"=\" * 30)\n\n    print(\"1. Check available layers:\")\n    available_layers = list(adata_metadata.layers.keys())\n    print(f\"   Available layers: {available_layers}\")\n    print(f\"   Number of layers: {len(available_layers)}\")\n\n    print(\"\\n2. Access a layer:\")\n    if available_layers:\n        layer_name = available_layers[0]\n        layer_matrix = adata_metadata.layers[layer_name]\n        print(f\"   Layer '{layer_name}' type: {type(layer_matrix)}\")\n        print(f\"   Layer shape: {layer_matrix.shape}\")\n        print(f\"   Layer is lazy: {hasattr(layer_matrix, 'compute')}\")\n\n    print(\"\\n3. Compute a layer (lazy evaluation):\")\n    if available_layers:\n        layer_name = available_layers[0]\n        layer_matrix = adata_metadata.layers[layer_name]\n        layer_data = layer_matrix.compute()\n        print(\n            f\"   Computed '{layer_name}': {type(layer_data)}, shape {layer_data.shape}\"\n        )\n\n    print(\"\\n4. Create a new layer:\")\n    # Create a simple normalized layer as example\n    normalized = adata_metadata.X.compute()\n    # Simple normalization example\n    normalized = normalized / normalized.sum(axis=1) * 10000\n    adata_metadata.layers[\"normalized\"] = csr_matrix(normalized)\n    print(\"   Created 'normalized' layer\")\n    print(f\"   Updated layers: {list(adata_metadata.layers.keys())}\")\n\n    print(\"\\n5. Layer operations:\")\n    print(\"   - Dictionary-like interface: layers['name'], 'name' in layers\")\n    print(\"   - Lazy evaluation: layers['name'].compute()\")\n    print(\"   - Immutability: Converted layers are protected from deletion\")\n    print(\"   - Wide format: Stored in layers.lance table (one column per layer)\")\n\ndemonstrate_layers()", "code_hash": "f933f08a969e8da6bdb56a8ae1f4633c", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TRpd", "name": "_"}, {"code": "def demonstrate_metadata_views():\n    print(\"\ud83d\udcca Working with Metadata Views\")\n    print(\"=\" * 35)\n\n    print(\"1. Obs (cell metadata) - DataFrame-like interface:\")\n    print(f\"   Available columns: {list(adata_metadata.obs.columns)[:5]}...\")\n    print(f\"   Number of columns: {len(adata_metadata.obs.columns)}\")\n    print(\"   - DataFrame-like: obs.columns, obs.head(), obs['col']\")\n    print(\"   - Dict-like: 'col' in obs, len(obs)\")\n    print(\"   - Mutations: obs['new_col'] = values\")\n\n    print(\"\\n2. Var (gene metadata) - DataFrame-like interface:\")\n    print(f\"   Available columns: {list(adata_metadata.var.columns)[:5]}...\")\n    print(f\"   Number of columns: {len(adata_metadata.var.columns)}\")\n    print(\"   - Same interface as obs\")\n    print(\"   - Mutations: var['new_col'] = values\")\n\n    print(\"\\n3. Obsm (cell embeddings) - Dictionary-like interface:\")\n    obsm_keys = list(adata_metadata.obsm.keys())\n    if obsm_keys:\n        print(f\"   Available keys: {obsm_keys}\")\n        for key in obsm_keys[:2]:  # Show first 2\n            arr = adata_metadata.obsm[key]\n            print(f\"   - {key}: shape {arr.shape}, type {type(arr)}\")\n    else:\n        print(\"   No obsm keys found (can add: adata.obsm['X_umap'] = coords)\")\n\n    print(\"\\n4. Varm (gene embeddings) - Dictionary-like interface:\")\n    varm_keys = list(adata_metadata.varm.keys())\n    if varm_keys:\n        print(f\"   Available keys: {varm_keys}\")\n        for key in varm_keys[:2]:  # Show first 2\n            arr = adata_metadata.varm[key]\n            print(f\"   - {key}: shape {arr.shape}, type {type(arr)}\")\n    else:\n        print(\"   No varm keys found (can add: adata.varm['PCs'] = loadings)\")\n\n    print(\"\\n5. Uns (unstructured metadata) - Dictionary-like interface:\")\n    uns_keys = list(adata_metadata.uns.keys())\n    if uns_keys:\n        print(f\"   Available keys: {uns_keys}\")\n        print(f\"   Example: {list(uns_keys)[:3]}\")\n    else:\n        print(\"   No uns keys found (can add: adata.uns['analysis'] = {...})\")\n\n    print(\"\\n6. Key features:\")\n    print(\"   - Lazy evaluation: Metadata accessed on-demand\")\n    print(\"   - Immutability: Converted columns/keys are protected\")\n    print(\"   - Subsetting: Views respect cell/gene selectors\")\n    print(\"   - Persistence: Changes are saved to Lance tables\")\n\ndemonstrate_metadata_views()", "code_hash": "e2f53bd890c22e19d4e9a15e4fdd9560", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "TXez", "name": "_"}, {"code": "def demonstrate_metadata_mutations():\n    print(\"\u270f\ufe0f Metadata Mutations Example\")\n    print(\"=\" * 35)\n\n    print(\"1. Create obs column:\")\n    cluster_labels = np.random.choice([\"A\", \"B\", \"C\"], adata_metadata.n_obs)\n    adata_metadata.obs[\"clusters\"] = cluster_labels\n    print(\n        f\"   \u2705 Created 'clusters' column with {len(np.unique(cluster_labels))} unique values\"\n    )\n    print(\"   Column is immediately saved to cells.lance\")\n\n    print(\"\\n2. Create var column:\")\n    hvg_flags = np.random.choice([True, False], adata_metadata.n_vars, p=[0.3, 0.7])\n    adata_metadata.var[\"is_hvg\"] = hvg_flags\n    print(\n        f\"   \u2705 Created 'is_hvg' column: {hvg_flags.sum()} genes marked as highly variable\"\n    )\n    print(\"   Column is immediately saved to genes.lance\")\n\n    print(\"\\n3. Store obsm (cell embeddings):\")\n    # Create a new embedding (different from existing X_umap)\n    new_embedding = np.random.randn(adata_metadata.n_obs, 3).astype(np.float32)\n    adata_metadata.obsm[\"X_custom\"] = new_embedding\n    print(f\"   \u2705 Created 'X_custom' embedding: shape {new_embedding.shape}\")\n    print(\"   Stored as FixedSizeListArray in cells.lance\")\n    print(f\"   Available obsm keys: {list(adata_metadata.obsm.keys())}\")\n\n    print(\"\\n4. Store varm (gene embeddings):\")\n    # Create a new gene embedding (different from existing PCs)\n    new_loadings = np.random.randn(adata_metadata.n_vars, 20).astype(np.float32)\n    adata_metadata.varm[\"custom_loadings\"] = new_loadings\n    print(f\"   \u2705 Created 'custom_loadings' embedding: shape {new_loadings.shape}\")\n    print(\"   Stored as FixedSizeListArray in genes.lance\")\n    print(f\"   Available varm keys: {list(adata_metadata.varm.keys())}\")\n\n    print(\"\\n5. Store uns (unstructured metadata):\")\n    adata_metadata.uns[\"custom_analysis\"] = {\n        \"params\": {\"n_neighbors\": 15, \"resolution\": 0.5}\n    }\n    print(\"   \u2705 Created 'custom_analysis' key in uns\")\n    print(\"   Stored in uns.json file\")\n    print(f\"   Available uns keys: {list(adata_metadata.uns.keys())}\")\n\n    print(\"\\n6. Delete mutable columns/keys:\")\n    # Delete the columns/keys we just created (they're mutable)\n    del adata_metadata.obs[\"clusters\"]\n    print(\"   \u2705 Deleted 'clusters' column (mutable)\")\n    del adata_metadata.var[\"is_hvg\"]\n    print(\"   \u2705 Deleted 'is_hvg' column (mutable)\")\n    del adata_metadata.obsm[\"X_custom\"]\n    print(\"   \u2705 Deleted 'X_custom' embedding (mutable)\")\n    del adata_metadata.varm[\"custom_loadings\"]\n    print(\"   \u2705 Deleted 'custom_loadings' embedding (mutable)\")\n    del adata_metadata.uns[\"custom_analysis\"]\n    print(\"   \u2705 Deleted 'custom_analysis' key from uns\")\n    print(\n        \"\\n   Note: Immutable columns/keys (converted from h5ad) cannot be deleted\"\n    )\n\ndemonstrate_metadata_mutations()", "code_hash": "82e5c7bdd31e18b5f68acad2dd210dde", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "dNNg", "name": "_"}, {"code": "mo.md(\n    \"\"\"\n## Summary\n\n**What you've learned about SLAF's lazy processing:**\n\n1. **Lazy Objects**: LazyAnnData and LazyExpressionMatrix store operations, not data\n2. **Explicit Control**: Use .compute() methods to control when data is processed\n3. **Slicing Patterns**: Multiple slicing patterns, all lazy and composable\n4. **Transformations**: Lazy transformations that are preserved through operations\n5. **Performance**: Build complex pipelines instantly, compute only when needed\n6. **Memory Efficiency**: Significant memory savings compared to eager loading\n7. **Best Practices**: Guidelines for optimal lazy evaluation usage\n8. **Layers**: Alternative expression matrices stored in layers.lance (wide format)\n9. **Metadata Views**: Full support for obs, var, obsm, varm, and uns with lazy evaluation\n\n**Next Steps:**\n- **03-ml-training-pipeline.py**: Complete ML training workflows with tokenizers and dataloaders\n\"\"\"\n)", "code_hash": "ff43f9f68a1aa5aecf8ae5990b5f26eb", "config": {"column": null, "disabled": false, "hide_code": false}, "id": "yCnT", "name": "_"}], "metadata": {"marimo_version": "0.17.0"}, "version": "1"},
            "session": {"cells": [{"code_hash": "ed00924d0b1dc03b23b23907ed6bd955", "console": [], "id": "Hbol", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "6377adf053e9550184c48dd346df4127", "console": [], "id": "MJUe", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h1 id=\"slaf-lazy-processing-deep-dive\">SLAF Lazy Processing Deep Dive</h1>\n<span class=\"paragraph\">This notebook explores SLAF's lazy evaluation capabilities in detail. You'll learn how to:</span>\n<ul>\n<li>Build complex analysis pipelines without loading data</li>\n<li>Apply multiple transformations efficiently</li>\n<li>Use different slicing patterns</li>\n<li>Control when computation happens</li>\n<li>Understand performance benefits</li>\n</ul>\n<span class=\"paragraph\"><strong>Key Concept</strong>: Lazy evaluation means operations are stored as instructions and only executed when you explicitly request the results.</span>\n<span class=\"paragraph\"><strong>Key Benefits:</strong></span>\n<ul>\n<li>\ud83d\ude80 <strong>Instant Pipeline Building</strong>: No waiting for data loading</li>\n<li>\ud83d\udcbe <strong>Memory Efficient</strong>: Only load what you need</li>\n<li>\ud83d\udd04 <strong>Composable</strong>: Operations can be combined and preserved</li>\n<li>\u26a1 <strong>SQL Performance</strong>: Leverage database-level optimizations</li>\n<li>\ud83e\uddec <strong>Scanpy Compatible</strong>: Familiar interface with performance benefits</li>\n</ul></span>"}, "type": "data"}]}, {"code_hash": "1b3a67a5f4de2dd7e33027b6ffe747db", "console": [{"name": "stderr", "text": "2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:display_ascii_art:29 - \n  z Z\n ( - . - )\n /  ^ \\ \u26a1\n(  (_)  (_) )\n \\_______/ \n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:222 - \n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:242 - \ud83d\udcca SLAF Dataset Loaded: pbmc3k_processed.slaf\n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:243 -    \u2022 Shape: 2,695 cells \u00d7 1,863 genes\n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:244 -    \u2022 Format: SLAF v0.1\n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:262 -    \u2022 Optimizations: use_integer_keys: True\n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:265 -    \u2022 Status: Ready for queries (metadata loading in background)\n2025-12-16 15:00:54.721 | INFO     | slaf.core.slaf:_display_initialization_message:266 - \n", "type": "stream"}, {"name": "stdout", "text": "\u2705 Loaded dataset: 2,695 cells \u00d7 1,863 genes\n   Type: <class 'slaf.integrations.anndata.LazyAnnData'>\n   Expression matrix type: <class 'slaf.integrations.anndata.LazyExpressionMatrix'>\n", "type": "stream"}], "id": "vblA", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "75f5c8abad0ffa3e12f1e8ea9d969ccd", "console": [], "id": "bkHC", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"1-understanding-lazy-objects\">1. Understanding Lazy Objects</h2>\n<span class=\"paragraph\">SLAF provides two main lazy object types:</span>\n<ul>\n<li><strong>LazyAnnData</strong>: Lazy version of AnnData with scanpy compatibility</li>\n<li><strong>LazyExpressionMatrix</strong>: Lazy version of the expression matrix</li>\n</ul></span>"}, "type": "data"}]}, {"code_hash": "92a84b2748225d0e982a0654322e63a6", "console": [{"name": "stdout", "text": "\ud83d\udd0d Lazy Object Types\n==============================\n1. LazyAnnData type: <class 'slaf.integrations.anndata.LazyAnnData'>\n   - Shape: (2695, 1863)\n", "type": "stream"}, {"name": "stdout", "text": "   - Obs columns: ['n_genes', 'n_genes_by_counts', 'total_counts', 'leiden', 'batch', 'high_mito', 'pct_counts_mt', 'high_genes']\n   - Var columns: ['gene_ids', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm']\n\n2. LazyExpressionMatrix type: <class 'slaf.integrations.anndata.LazyExpressionMatrix'>\n   - Shape: (2695, 1863)\n   - Parent: <class 'slaf.integrations.anndata.LazyAnnData'>\n\n3. Key insight: These objects store operations, not data!\n   - No data is loaded until you call .compute()\n   - Operations are composed efficiently\n   - Memory usage stays low\n", "type": "stream"}], "id": "lEQa", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "a5cb9b5af5e969c286ca73720febe56e", "console": [], "id": "PKri", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"2-explicit-computation-control\">2. Explicit Computation Control</h2>\n<span class=\"paragraph\">You control when data is actually computed using these methods:</span></span>"}, "type": "data"}]}, {"code_hash": "5b178fc99a1c074c19665d89a06f9f4c", "console": [{"name": "stdout", "text": "\ud83c\udf9b\ufe0f Explicit Computation Control\n===================================\nAvailable computation methods:\n1. adata.compute() \u2192 native AnnData object\n2. adata.X.compute() \u2192 scipy.sparse.csr_matrix\n3. adata.obs \u2192 pandas.DataFrame (cell metadata)\n4. adata.var \u2192 pandas.DataFrame (gene metadata)\n\nLet's demonstrate:\n\n1. Computing expression matrix...\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.1001s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (2695, 1863)\n   Memory: 1.6 MB\n\n2. Accessing cell metadata...\n   \u2705 Accessed in 0.0000s\n   Type: <class 'slaf.integrations.anndata.LazyObsView'>\n   Shape: (2695, 1863)\n", "type": "stream"}], "id": "Xref", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c63d9fc9f55bad77978773a461777efa", "console": [], "id": "SFPL", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"3-slicing-patterns-all-the-ways-to-slice\">3. Slicing Patterns - All the Ways to Slice</h2>\n<span class=\"paragraph\">SLAF supports multiple slicing patterns, all of which are lazy:</span></span>"}, "type": "data"}]}, {"code_hash": "199d1d90390bd28f946f91839a475656", "console": [{"name": "stdout", "text": "\u2702\ufe0f Slicing Patterns\n=========================\n1. Basic integer slicing:\n", "type": "stream"}, {"name": "stdout", "text": "   adata[:100, :50] \u2192 <class 'slaf.integrations.anndata.LazyAnnData'> with shape (100, 50)\n\n2. Expression matrix slicing:\n   adata.X[:100, :50] \u2192 <class 'slaf.integrations.anndata.LazyExpressionMatrix'> with shape (100, 50)\n\n3. Boolean indexing (after QC metrics are available):\n", "type": "stream"}, {"name": "stdout", "text": "   adata[high_quality_mask, :] \u2192 <class 'slaf.integrations.anndata.LazyAnnData'> with shape (2695, 1863)\n\n4. Mixed indexing:\n", "type": "stream"}, {"name": "stdout", "text": "   adata[:100, adata.var.index[:50]] \u2192 <class 'slaf.integrations.anndata.LazyAnnData'> with shape (100, 1863)\n\nKey insight: All slicing returns lazy objects!\n", "type": "stream"}], "id": "BYtC", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "8dcce7dd085aa1c193e37db381119a96", "console": [], "id": "RGSE", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"4-transformation-patterns\">4. Transformation Patterns</h2>\n<span class=\"paragraph\">SLAF supports lazy transformations that are stored and applied when needed:</span></span>"}, "type": "data"}]}, {"code_hash": "dab326a7d7603e0f09f85c86171ff8aa", "console": [{"name": "stderr", "text": "2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:display_ascii_art:29 - \n  z Z\n ( - . - )\n /  ^ \\ \u26a1\n(  (_)  (_) )\n \\_______/ \n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:222 - \n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:242 - \ud83d\udcca SLAF Dataset Loaded: pbmc3k_processed.slaf\n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:243 -    \u2022 Shape: 2,695 cells \u00d7 1,863 genes\n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:244 -    \u2022 Format: SLAF v0.1\n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:262 -    \u2022 Optimizations: use_integer_keys: True\n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:265 -    \u2022 Status: Ready for queries (metadata loading in background)\n2025-12-16 15:00:54.892 | INFO     | slaf.core.slaf:_display_initialization_message:266 - \n", "type": "stream"}, {"name": "stdout", "text": "\u2705 Loaded fresh dataset for transformations\n", "type": "stream"}], "id": "Kclp", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "90470737f8e58133255f917a2d70b750", "console": [{"name": "stdout", "text": "\ud83d\udd04 Transformation Patterns\n==============================\n1. Single transformation:\n", "type": "stream"}, {"name": "stdout", "text": "   normalize_total() \u2192 <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations stored: ['normalize_total']\n\n2. Chained transformations:\n   normalize_total().log1p() \u2192 <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations stored: ['normalize_total', 'log1p']\n\n3. Transformation on sliced data:\n", "type": "stream"}, {"name": "stdout", "text": "   adata[:100, :50].normalize_total() \u2192 <class 'slaf.integrations.anndata.LazyAnnData'>\n   Shape: (100, 50)\n\n4. Multiple transformations on slice:\n", "type": "stream"}, {"name": "stdout", "text": "   Multiple transformations on slice \u2192 <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations: ['normalize_total', 'log1p']\n", "type": "stream"}], "id": "emfo", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "62e478d2b023db6c22f2b1be709a793e", "console": [{"name": "stdout", "text": "\u26a1 Applying Transformations\n==============================\n1. Computing transformed data:\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 1.6905s\n   Type: <class 'anndata._core.anndata.AnnData'>\n   Shape: (2695, 1863)\n\n2. Computing transformed slice:\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.1012s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (2695, 1863)\n\n3. Computing multi-transformed slice:\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.0990s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (2695, 1863)\n", "type": "stream"}], "id": "Hstk", "outputs": [{"data": {"application/json": "[\"text/plain:AnnData object with n_obs \\u00d7 n_vars = 2695 \\u00d7 1863\\n    obs: 'n_genes', 'n_genes_by_counts', 'total_counts', 'leiden', 'batch', 'high_mito', 'pct_counts_mt', 'high_genes'\\n    var: 'gene_ids', 'n_cells', 'mt', 'n_cells_by_counts', 'mean_counts', 'pct_dropout_by_counts', 'total_counts', 'highly_variable', 'means', 'dispersions', 'dispersions_norm'\", \"text/plain:<Compressed Sparse Row sparse matrix of dtype 'float32'\\n\\twith 415134 stored elements and shape (2695, 1863)>\\n  Coords\\tValues\\n  (0, 5)\\t88.40198516845703\\n  (0, 16)\\t64.94987487792969\\n  (0, 24)\\t64.94987487792969\\n  (0, 48)\\t64.94987487792969\\n  (0, 52)\\t64.94987487792969\\n  (0, 56)\\t64.94987487792969\\n  (0, 68)\\t64.94987487792969\\n  (0, 114)\\t64.94987487792969\\n  (0, 122)\\t64.94987487792969\\n  (0, 140)\\t113.72039794921875\\n  (0, 152)\\t64.94987487792969\\n  (0, 176)\\t88.40198516845703\\n  (0, 185)\\t64.94987487792969\\n  (0, 204)\\t64.94987487792969\\n  (0, 212)\\t64.94987487792969\\n  (0, 226)\\t64.94987487792969\\n  (0, 230)\\t64.94987487792969\\n  (0, 232)\\t64.94987487792969\\n  (0, 239)\\t88.40198516845703\\n  (0, 242)\\t64.94987487792969\\n  (0, 243)\\t64.94987487792969\\n  (0, 268)\\t64.94987487792969\\n  (0, 278)\\t64.94987487792969\\n  (0, 284)\\t64.94987487792969\\n  (0, 313)\\t64.94987487792969\\n  :\\t:\\n  (2694, 1398)\\t1.798457384109497\\n  (2694, 1401)\\t1.798457384109497\\n  (2694, 1404)\\t1.798457384109497\\n  (2694, 1412)\\t1.798457384109497\\n  (2694, 1413)\\t1.798457384109497\\n  (2694, 1424)\\t1.798457384109497\\n  (2694, 1451)\\t1.798457384109497\\n  (2694, 1473)\\t1.798457384109497\\n  (2694, 1475)\\t2.4051997661590576\\n  (2694, 1495)\\t1.798457384109497\\n  (2694, 1500)\\t1.798457384109497\\n  (2694, 1505)\\t1.798457384109497\\n  (2694, 1545)\\t2.4051997661590576\\n  (2694, 1554)\\t1.798457384109497\\n  (2694, 1584)\\t1.798457384109497\\n  (2694, 1606)\\t1.798457384109497\\n  (2694, 1616)\\t1.798457384109497\\n  (2694, 1626)\\t1.798457384109497\\n  (2694, 1688)\\t1.798457384109497\\n  (2694, 1754)\\t1.798457384109497\\n  (2694, 1809)\\t1.798457384109497\\n  (2694, 1814)\\t2.4051997661590576\\n  (2694, 1826)\\t1.798457384109497\\n  (2694, 1830)\\t1.798457384109497\\n  (2694, 1839)\\t1.798457384109497\", \"text/plain:<Compressed Sparse Row sparse matrix of dtype 'float32'\\n\\twith 415134 stored elements and shape (2695, 1863)>\\n  Coords\\tValues\\n  (0, 5)\\t4.493143081665039\\n  (0, 16)\\t4.188894748687744\\n  (0, 24)\\t4.188894748687744\\n  (0, 48)\\t4.188894748687744\\n  (0, 52)\\t4.188894748687744\\n  (0, 56)\\t4.188894748687744\\n  (0, 68)\\t4.188894748687744\\n  (0, 114)\\t4.188894748687744\\n  (0, 122)\\t4.188894748687744\\n  (0, 140)\\t4.74249792098999\\n  (0, 152)\\t4.188894748687744\\n  (0, 176)\\t4.493143081665039\\n  (0, 185)\\t4.188894748687744\\n  (0, 204)\\t4.188894748687744\\n  (0, 212)\\t4.188894748687744\\n  (0, 226)\\t4.188894748687744\\n  (0, 230)\\t4.188894748687744\\n  (0, 232)\\t4.188894748687744\\n  (0, 239)\\t4.493143081665039\\n  (0, 242)\\t4.188894748687744\\n  (0, 243)\\t4.188894748687744\\n  (0, 268)\\t4.188894748687744\\n  (0, 278)\\t4.188894748687744\\n  (0, 284)\\t4.188894748687744\\n  (0, 313)\\t4.188894748687744\\n  :\\t:\\n  (2694, 1398)\\t1.0290683507919312\\n  (2694, 1401)\\t1.0290683507919312\\n  (2694, 1404)\\t1.0290683507919312\\n  (2694, 1412)\\t1.0290683507919312\\n  (2694, 1413)\\t1.0290683507919312\\n  (2694, 1424)\\t1.0290683507919312\\n  (2694, 1451)\\t1.0290683507919312\\n  (2694, 1473)\\t1.0290683507919312\\n  (2694, 1475)\\t1.2253036499023438\\n  (2694, 1495)\\t1.0290683507919312\\n  (2694, 1500)\\t1.0290683507919312\\n  (2694, 1505)\\t1.0290683507919312\\n  (2694, 1545)\\t1.2253036499023438\\n  (2694, 1554)\\t1.0290683507919312\\n  (2694, 1584)\\t1.0290683507919312\\n  (2694, 1606)\\t1.0290683507919312\\n  (2694, 1616)\\t1.0290683507919312\\n  (2694, 1626)\\t1.0290683507919312\\n  (2694, 1688)\\t1.0290683507919312\\n  (2694, 1754)\\t1.0290683507919312\\n  (2694, 1809)\\t1.0290683507919312\\n  (2694, 1814)\\t1.2253036499023438\\n  (2694, 1826)\\t1.0290683507919312\\n  (2694, 1830)\\t1.0290683507919312\\n  (2694, 1839)\\t1.0290683507919312\"]"}, "type": "data"}]}, {"code_hash": "31cc1e49d33335690bedb214b1570f4d", "console": [], "id": "nWHF", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"5-transformation-preservation-through-operations\">5. Transformation Preservation Through Operations</h2>\n<span class=\"paragraph\">Transformations are preserved through slicing and other operations:</span></span>"}, "type": "data"}]}, {"code_hash": "9f46c11315ca9c36ae8db9e93d02530b", "console": [{"name": "stderr", "text": "2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:display_ascii_art:29 - \n  z Z\n ( - . - )\n /  ^ \\ \u26a1\n(  (_)  (_) )\n \\_______/ \n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:222 - \n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:242 - \ud83d\udcca SLAF Dataset Loaded: pbmc3k.slaf\n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:243 -    \u2022 Shape: 2,700 cells \u00d7 32,738 genes\n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:244 -    \u2022 Format: SLAF v0.1\n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:262 -    \u2022 Optimizations: use_integer_keys: True\n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:265 -    \u2022 Status: Ready for queries (metadata loading in background)\n2025-12-16 15:00:56.863 | INFO     | slaf.core.slaf:_display_initialization_message:266 - \n", "type": "stream"}], "id": "iLit", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c138eff20683fb4432bde50af820ae29", "console": [{"name": "stdout", "text": "\ud83d\udd04 Transformation Preservation\n===================================\n1. Apply transformations first, then slice:\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:56.863 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:56.863 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:246 - Using parallel processing for operation: normalize_total\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:56.878 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:436 - Completed cell totals for fragment 3/3\n2025-12-16 15:00:56.881 | INFO     | slaf.core.slaf:_load_metadata:462 - No precomputed cell_start_index found, calculating from expression data...\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:56.894 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:436 - Completed cell totals for fragment 1/3\n2025-12-16 15:00:56.896 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:436 - Completed cell totals for fragment 2/3\n", "type": "stream"}, {"name": "stderr", "text": "{'record': {'elapsed': 'PT2.251498S', 'exception': None, 'extra': {}, 'file': {'name': 'fragment_processor.py', 'path': '/Users/pavan/slaf-project/slaf/slaf/core/fragment_processor.py'}, 'function': '_build_normalize_total_pipeline_parallel', 'level': {'icon': '\ud83d\udc1e', 'name': 'DEBUG', 'no': 10}, 'line': 476, 'message': 'Completed normalization for fragment 3/3', 'module': 'fragment_processor', 'name': 'slaf.core.fragment_processor', 'process': {'id': 14438, 'name': 'Process-1'}, 'thread': {'id': 8616429568, 'name': 'MainThread'}, 'time': {}}}", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:56.933 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:476 - Completed normalization for fragment 1/3\n2025-12-16 15:00:56.938 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:476 - Completed normalization for fragment 2/3\n2025-12-16 15:00:56.938 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n2025-12-16 15:00:56.938 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:56.938 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:249 - Using sequential processing for operation: log1p\n2025-12-16 15:00:56.938 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 1/3\n2025-12-16 15:00:56.938 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 2/3\n2025-12-16 15:00:56.938 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 3/3\n2025-12-16 15:00:56.939 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n", "type": "stream"}, {"name": "stdout", "text": "   Original transformations: ['normalize_total', 'log1p']\n   Slice transformations: ['normalize_total', 'log1p']\n\n2. Slice first, then apply transformations:\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:56.996 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:56.997 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:246 - Using parallel processing for operation: normalize_total\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.011 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:436 - Completed cell totals for fragment 3/3\n2025-12-16 15:00:57.019 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:436 - Completed cell totals for fragment 2/3\n2025-12-16 15:00:57.020 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:436 - Completed cell totals for fragment 1/3\n", "type": "stream"}, {"name": "stderr", "text": "{'record': {'elapsed': 'PT2.37043S', 'exception': None, 'extra': {}, 'file': {'name': 'fragment_processor.py', 'path': '/Users/pavan/slaf-project/slaf/slaf/core/fragment_processor.py'}, 'function': '_build_normalize_total_pipeline_parallel', 'level': {'icon': '\ud83d\udc1e', 'name': 'DEBUG', 'no': 10}, 'line': 476, 'message': 'Completed normalization for fragment 3/3', 'module': 'fragment_processor', 'name': 'slaf.core.fragment_processor', 'process': {'id': 14438, 'name': 'Process-1'}, 'thread': {'id': 8616429568, 'name': 'MainThread'}, 'time': {}}}", "type": "stream"}, {"name": "stderr", "text": "{'record': {'elapsed': 'PT2.386113S', 'exception': None, 'extra': {}, 'file': {'name': 'fragment_processor.py', 'path': '/Users/pavan/slaf-project/slaf/slaf/core/fragment_processor.py'}, 'function': '_build_normalize_total_pipeline_parallel', 'level': {'icon': '\ud83d\udc1e', 'name': 'DEBUG', 'no': 10}, 'line': 476, 'message': 'Completed normalization for fragment 2/3', 'module': 'fragment_processor', 'name': 'slaf.core.fragment_processor', 'process': {'id': 14438, 'name': 'Process-1'}, 'thread': {'id': 8616429568, 'name': 'MainThread'}, 'time': {}}}", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.067 | DEBUG    | slaf.core.fragment_processor:_build_normalize_total_pipeline_parallel:476 - Completed normalization for fragment 1/3\n2025-12-16 15:00:57.067 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n2025-12-16 15:00:57.067 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:57.067 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:249 - Using sequential processing for operation: log1p\n2025-12-16 15:00:57.067 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 1/3\n2025-12-16 15:00:57.067 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 2/3\n2025-12-16 15:00:57.068 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 3/3\n2025-12-16 15:00:57.068 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n", "type": "stream"}, {"name": "stdout", "text": "   Transformed slice: <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations: ['normalize_total', 'log1p']\n\n3. Complex slicing patterns preserve transformations:\n   Note: Chained slicing (e.g., adata[:200, :100][:50, :25]) is not supported.\n   Use single-step slicing instead: adata[50:250, 25:125]\n", "type": "stream"}, {"name": "stdout", "text": "   Single-step slice: <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations preserved: ['normalize_total', 'log1p']\n", "type": "stream"}, {"name": "stdout", "text": "   Boolean mask slice: <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations preserved: ['normalize_total', 'log1p']\n   Step slice: <class 'slaf.integrations.anndata.LazyAnnData'>\n   Transformations preserved: ['normalize_total', 'log1p']\n", "type": "stream"}], "id": "ZHCJ", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "db504fe99748952d3271dfa968c75d56", "console": [{"name": "stdout", "text": "\u2705 Verifying Transformation Preservation\n========================================\n1. Computing slice with preserved transformations:\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.163 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:57.163 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:249 - Using sequential processing for operation: compute_matrix\n2025-12-16 15:00:57.163 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 1/3\n2025-12-16 15:00:57.163 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 2/3\n2025-12-16 15:00:57.163 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 3/3\n2025-12-16 15:00:57.164 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.0827s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (100, 50)\n\n2. Computing slice with applied transformations:\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.246 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:57.246 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:249 - Using sequential processing for operation: compute_matrix\n2025-12-16 15:00:57.246 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 1/3\n2025-12-16 15:00:57.246 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 2/3\n2025-12-16 15:00:57.246 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 3/3\n2025-12-16 15:00:57.246 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.0700s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (2700, 32738)\n\n3. Computing single-step slice with preserved transformations:\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.317 | DEBUG    | slaf.core.fragment_processor:__init__:73 - Initialized FragmentProcessor with 3 fragments\n2025-12-16 15:00:57.317 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline_smart:249 - Using sequential processing for operation: compute_matrix\n2025-12-16 15:00:57.317 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 1/3\n2025-12-16 15:00:57.319 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 2/3\n2025-12-16 15:00:57.319 | DEBUG    | slaf.core.fragment_processor:build_lazy_pipeline:122 - Building lazy pipeline for fragment 3/3\n2025-12-16 15:00:57.319 | INFO     | slaf.core.fragment_processor:compute:612 - Executing lazy pipeline...\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.0650s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (200, 100)\n", "type": "stream"}], "id": "ROlb", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "87bb153b5d40e6bd9067b2faef2f8e30", "console": [], "id": "qnkX", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"6-performance-benefits-building-complex-pipelines\">6. Performance Benefits - Building Complex Pipelines</h2>\n<span class=\"paragraph\">Let's see how lazy evaluation enables efficient complex pipelines:</span></span>"}, "type": "data"}]}, {"code_hash": "3b710cc181d374a19352beaef1e67062", "console": [{"name": "stdout", "text": "\u26a1 Performance Benefits\n=========================\n1. Building complex pipeline (no computation yet):\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Pipeline built in 0.0349s\n   Final object: <class 'slaf.integrations.anndata.LazyAnnData'>\n   Expected shape: (500, 200)\n   Transformations: ['normalize_total', 'log1p']\n\n2. Computing the final result:\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Computed in 0.0351s\n   Type: <class 'scipy.sparse._csr.csr_matrix'>\n   Shape: (500, 200)\n\n3. Total time: 0.0699s\n   Key insight: Pipeline building is instant, computation happens only when needed!\n", "type": "stream"}], "id": "TqIu", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "7f9fa546b1b9f8744da767eb2af75d33", "console": [], "id": "Vxnm", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"7-memory-efficiency-comparison\">7. Memory Efficiency Comparison</h2>\n<span class=\"paragraph\">Let's compare memory usage between lazy and eager approaches:</span></span>"}, "type": "data"}]}, {"code_hash": "99fff8ad7e20569c9edd28c26927ac0a", "console": [{"name": "stdout", "text": "\ud83d\udcbe Memory Efficiency Comparison\n===================================\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:display_ascii_art:29 - \n  z Z\n ( - . - )\n /  ^ \\ \u26a1\n(  (_)  (_) )\n \\_______/ \n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:222 - \n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:242 - \ud83d\udcca SLAF Dataset Loaded: pbmc3k_processed.slaf\n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:243 -    \u2022 Shape: 2,695 cells \u00d7 1,863 genes\n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:244 -    \u2022 Format: SLAF v0.1\n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:262 -    \u2022 Optimizations: use_integer_keys: True\n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:265 -    \u2022 Status: Ready for queries (metadata loading in background)\n2025-12-16 15:00:57.455 | INFO     | slaf.core.slaf:_display_initialization_message:266 - \n", "type": "stream"}, {"name": "stdout", "text": "1. Memory after loading lazy data:\n   Lazy loading: 680.8 MB\n\n2. Memory after computing full dataset:\n", "type": "stream"}, {"name": "stdout", "text": "   Eager loading: 659.5 MB\n   Memory increase: -12.0 MB\n\n3. Memory after computing small slice:\n", "type": "stream"}, {"name": "stdout", "text": "   Small slice: 654.8 MB\n   Memory increase: -0.1 MB\n\nKey insight: Lazy loading uses 680.8 MB vs eager loading 659.5 MB\nMemory savings: -3.2%\n", "type": "stream"}], "id": "DnEU", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "c7949aa9588890c8628bbf631d148263", "console": [], "id": "ulZA", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"8-advanced-slicing-patterns\">8. Advanced Slicing Patterns</h2>\n<span class=\"paragraph\">Let's explore more advanced slicing patterns:</span></span>"}, "type": "data"}]}, {"code_hash": "dffdba99970cf8c9c6e6f630db42c1b8", "console": [{"name": "stdout", "text": "\ud83d\udd2c Advanced Slicing Patterns\n===================================\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:display_ascii_art:29 - \n  z Z\n ( - . - )\n /  ^ \\ \u26a1\n(  (_)  (_) )\n \\_______/ \n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:222 - \n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:242 - \ud83d\udcca SLAF Dataset Loaded: pbmc3k_processed.slaf\n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:243 -    \u2022 Shape: 2,695 cells \u00d7 1,863 genes\n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:244 -    \u2022 Format: SLAF v0.1\n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:262 -    \u2022 Optimizations: use_integer_keys: True\n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:265 -    \u2022 Status: Ready for queries (metadata loading in background)\n2025-12-16 15:00:57.845 | INFO     | slaf.core.slaf:_display_initialization_message:266 - \n", "type": "stream"}, {"name": "stdout", "text": "1. Boolean indexing with QC metrics:\n", "type": "stream"}, {"name": "stdout", "text": "   High quality cells: (2695, 1863)\n\n2. Gene-based filtering:\n", "type": "stream"}, {"name": "stdout", "text": "   Highly variable genes: (2695, 1863)\n\n3. Combined cell and gene filtering:\n", "type": "stream"}, {"name": "stdout", "text": "   Combined filtering: (2695, 100)\n\n4. Expression-based filtering:\n", "type": "stream"}, {"name": "stdout", "text": "   High count cells: (2695, 1863)\n", "type": "stream"}], "id": "ecfG", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "e44442767b8873d3214ad6e019ecdce0", "console": [], "id": "Pvdt", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"9-lazy-vs-eager-performance-comparison\">9. Lazy vs Eager Performance Comparison</h2>\n<span class=\"paragraph\">Let's compare the performance of lazy vs eager approaches:</span></span>"}, "type": "data"}]}, {"code_hash": "9f270672f0d74f498325e648828e5372", "console": [{"name": "stdout", "text": "\u26a1 Lazy vs Eager Performance\n===================================\nScenario: normalize_total \u2192 log1p \u2192 slice[:100, :50]\n\n1. Lazy approach:\n", "type": "stream"}, {"name": "stdout", "text": "   Build time: 0.0320s\n   Compute time: 0.0150s\n   Total time: 0.0470s\n\n2. Eager approach (simulated):\n", "type": "stream"}, {"name": "stdout", "text": "   Load time: 0.0927s\n   Transformations would be done in memory (slower for large datasets)\n\n3. Key benefits:\n   - Lazy: Build complex pipelines instantly\n   - Lazy: Only compute what you need\n   - Lazy: Memory efficient\n   - Lazy: SQL-level performance for operations\n", "type": "stream"}], "id": "ZBYS", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "8c92a9bf3966af0721a5b557dc7b5265", "console": [], "id": "aLJB", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"10-best-practices-and-tips\">10. Best Practices and Tips</h2>\n<span class=\"paragraph\">Here are some best practices for using SLAF's lazy evaluation:</span></span>"}, "type": "data"}]}, {"code_hash": "30984769f5ac44466ef17d45e8db9ef9", "console": [{"name": "stdout", "text": "\ud83d\udca1 Best Practices and Tips\n==============================\n1. Pipeline Building:\n   \u2705 Build complete pipelines before computing\n   \u2705 Chain transformations: adata.normalize_total().log1p()\n   \u2705 Slice after transformations for efficiency\n\n2. Computation Control:\n   \u2705 Use .compute() only when you need the data\n   \u2705 Use .obs or .var for metadata\n   \u2705 Use .X.compute() for expression matrix only\n\n3. Memory Management:\n   \u2705 Keep lazy objects for intermediate results\n   \u2705 Compute only final results\n   \u2705 Use slicing to reduce memory usage\n\n4. Performance Optimization:\n   \u2705 Leverage SQL-level operations\n   \u2705 Use boolean indexing for filtering\n   \u2705 Combine operations in single queries when possible\n\n5. Debugging:\n   \u2705 Check object types: type(adata)\n   \u2705 Check transformations: adata._transformations\n   \u2705 Use .info() for dataset overview\n", "type": "stream"}], "id": "nHfw", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "ec34aed38fcedd25305a4521175d3bcc", "console": [], "id": "xXTn", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"11-working-with-layers\">11. Working with Layers</h2>\n<span class=\"paragraph\">SLAF supports AnnData layers (alternative expression matrices) stored in the <code>layers.lance</code> table.</span>\n<span class=\"paragraph\">Let's create a synthetic dataset with layers, convert it to SLAF, and demonstrate layer operations:</span></span>"}, "type": "data"}]}, {"code_hash": "1e4303d5a8ce81d235ba476a43c4e071", "console": [{"name": "stdout", "text": "\u2705 Created synthetic AnnData: 200 cells \u00d7 500 genes\n   Layers: ['spliced', 'unspliced']\n   Obsm: ['X_umap', 'X_pca']\n   Varm: ['PCs']\n   Uns: ['neighbors', 'pca']\n", "type": "stream"}], "id": "AjVT", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "78ff2fe88138b6d0529954b648835e0b", "console": [{"name": "stderr", "text": "2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:convert_anndata:485 - Converting AnnData object to SLAF format...\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:convert_anndata:486 - Optimizations: int_keys=True\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:convert_anndata:487 - Loaded: 200 cells \u00d7 500 genes\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2463 - Validating AnnData object's expression data fits in optimized data types...\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2482 - Sampling expression values to determine data type...\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2525 - Float expression values detected: [0.011497750878334045, 88.1539077758789]\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2526 - Using float32 for normalized/float data\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2463 - Validating AnnData object's expression data fits in optimized data types...\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2482 - Sampling expression values to determine data type...\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2525 - Float expression values detected: [0.011497750878334045, 88.1539077758789]\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_validate_optimized_dtypes_anndata:2526 - Using float32 for normalized/float data\n2025-12-16 15:00:58.153 | INFO     | slaf.data.converter:_convert_anndata:1360 - Creating integer key mappings...\n2025-12-16 15:00:58.156 | INFO     | slaf.data.converter:_convert_anndata:1365 - Converting expression data to COO format...\n2025-12-16 15:00:58.156 | INFO     | slaf.data.converter:_sparse_to_coo_table:2712 - Processing 100,000 non-zero elements...\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:58.173 | INFO     | slaf.data.converter:_convert_anndata:1374 - Converting metadata...\n2025-12-16 15:00:58.173 | INFO     | slaf.data.converter:_convert_anndata:1382 - Precomputing cell start indices...\n2025-12-16 15:00:58.173 | INFO     | slaf.data.converter:_compute_cell_start_indices_anndata:3472 - Calculating gene counts from expression data...\n2025-12-16 15:00:58.179 | INFO     | slaf.data.converter:_convert_anndata:1395 - Writing Lance tables...\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:58.223 | INFO     | slaf.data.converter:_convert_anndata:1407 - Converting 2 layers...\n2025-12-16 15:00:58.223 | INFO     | slaf.data.converter:_convert_layers:2882 - Converting layers to wide format...\n2025-12-16 15:00:58.234 | INFO     | slaf.data.converter:_convert_layers:2901 - Converting layer 'spliced'...\n", "type": "stream"}, {"name": "stderr", "text": "{'record': {'elapsed': 'PT3.569193S', 'exception': None, 'extra': {}, 'file': {'name': 'converter.py', 'path': '/Users/pavan/slaf-project/slaf/slaf/data/converter.py'}, 'function': '_sparse_to_coo_table', 'level': {'icon': '\u2139\ufe0f', 'name': 'INFO', 'no': 20}, 'line': 2712, 'message': 'Processing 100,000 non-zero elements...', 'module': 'converter', 'name': 'slaf.data.converter', 'process': {'id': 14438, 'name': 'Process-1'}, 'thread': {'id': 8616429568, 'name': 'MainThread'}, 'time': {}}}", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:58.256 | INFO     | slaf.data.converter:_convert_layers:2901 - Converting layer 'unspliced'...\n2025-12-16 15:00:58.257 | INFO     | slaf.data.converter:_sparse_to_coo_table:2712 - Processing 100,000 non-zero elements...\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:58.276 | INFO     | slaf.data.converter:_convert_layers:2945 - Writing layers table to /var/folders/4g/t2xnyv255vd8pmccptg62wq80000gn/T/tmpb_k5b1y7/synthetic_with_metadata.slaf/layers.lance...\n[2025-12-16T23:00:58Z WARN  lance::dataset::write::insert] No existing dataset at /var/folders/4g/t2xnyv255vd8pmccptg62wq80000gn/T/tmpb_k5b1y7/synthetic_with_metadata.slaf/layers.lance, it will be created\n2025-12-16 15:00:58.282 | INFO     | slaf.data.converter:_convert_layers:2957 - Successfully converted 2 layers: ['spliced', 'unspliced']\n2025-12-16 15:00:58.283 | INFO     | slaf.data.converter:_convert_anndata:1419 - Converting 2 obsm embeddings...\n2025-12-16 15:00:58.283 | INFO     | slaf.data.converter:_convert_obsm:2983 - Converting obsm embeddings to FixedSizeListArray columns...\n2025-12-16 15:00:58.283 | INFO     | slaf.data.converter:_convert_obsm:2993 - Converting obsm 'X_umap'...\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:58.290 | INFO     | slaf.data.converter:_convert_obsm:2993 - Converting obsm 'X_pca'...\n2025-12-16 15:00:58.297 | INFO     | slaf.data.converter:_convert_obsm:3073 - Successfully converted 2 obsm embeddings: ['X_umap', 'X_pca']\n2025-12-16 15:00:58.298 | INFO     | slaf.data.converter:_convert_anndata:1430 - Converting 1 varm embeddings...\n2025-12-16 15:00:58.298 | INFO     | slaf.data.converter:_convert_varm:3101 - Converting varm embeddings to FixedSizeListArray columns...\n2025-12-16 15:00:58.298 | INFO     | slaf.data.converter:_convert_varm:3111 - Converting varm 'PCs'...\n", "type": "stream"}, {"name": "stderr", "text": "2025-12-16 15:00:58.304 | INFO     | slaf.data.converter:_convert_varm:3191 - Successfully converted 1 varm embeddings: ['PCs']\n2025-12-16 15:00:58.305 | INFO     | slaf.data.converter:_convert_anndata:1440 - Converting uns metadata...\n2025-12-16 15:00:58.305 | INFO     | slaf.data.converter:_convert_uns:3209 - Converting uns metadata to uns.json...\n2025-12-16 15:00:58.305 | INFO     | slaf.data.converter:_convert_uns:3233 - Successfully converted uns metadata with 2 keys\n2025-12-16 15:00:58.305 | INFO     | slaf.data.converter:_save_config:3636 - Computing dataset statistics...\n2025-12-16 15:00:58.305 | INFO     | slaf.data.converter:_compute_expression_statistics:3536 - Computing expression statistics using fragment-by-fragment processing...\n2025-12-16 15:00:58.305 | INFO     | slaf.data.converter:_compute_expression_statistics:3553 - Processing 1 fragments for statistics computation...\n\rComputing statistics:   0%|                                                                                                                          | 0/1 [00:00<?, ?it/s]", "type": "stream"}, {"name": "stderr", "text": "\rComputing statistics: 100%|\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588\u2588| 1/1 [00:00<00:00, 168.13it/s]\n2025-12-16 15:00:58.318 | INFO     | slaf.data.converter:_compute_expression_statistics:3617 - Statistics computed: min=0.01, max=88.15, mean=1.65, std=2.14\n2025-12-16 15:00:58.319 | INFO     | slaf.data.converter:_convert_anndata:1455 - Conversion complete! Saved to /var/folders/4g/t2xnyv255vd8pmccptg62wq80000gn/T/tmpb_k5b1y7/synthetic_with_metadata.slaf\n", "type": "stream"}, {"name": "stdout", "text": "\u2705 Converted synthetic dataset to SLAF: /var/folders/4g/t2xnyv255vd8pmccptg62wq80000gn/T/tmpb_k5b1y7/synthetic_with_metadata.slaf\n", "type": "stream"}], "id": "pHFh", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "d43f82cd098ddea3a74681fe9e41ab38", "console": [], "id": "NCOB", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"12-working-with-metadata-views\">12. Working with Metadata Views</h2>\n<span class=\"paragraph\">SLAF provides lazy views for all AnnData metadata objects (obs, var, obsm, varm, uns):</span></span>"}, "type": "data"}]}, {"code_hash": "6197495b9ed0ee3d7f0ae334f31c44af", "console": [{"name": "stderr", "text": "2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:display_ascii_art:29 - \n  z Z\n ( - . - )\n /  ^ \\ \u26a1\n(  (_)  (_) )\n \\_______/ \n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:222 - \n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:242 - \ud83d\udcca SLAF Dataset Loaded: synthetic_with_metadata.slaf\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:243 -    \u2022 Shape: 200 cells \u00d7 500 genes\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:244 -    \u2022 Format: SLAF v0.4\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:252 -    \u2022 Expression records: 100,000\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:256 -    \u2022 Sparsity: 0.0%\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:262 -    \u2022 Optimizations: use_integer_keys: True, optimize_storage: True\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:265 -    \u2022 Status: Ready for queries (metadata loading in background)\n2025-12-16 15:00:58.321 | INFO     | slaf.core.slaf:_display_initialization_message:266 - \n", "type": "stream"}, {"name": "stdout", "text": "\u2705 Loaded SLAF dataset: 200 cells \u00d7 500 genes\n", "type": "stream"}], "id": "aqbW", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "f933f08a969e8da6bdb56a8ae1f4633c", "console": [{"name": "stdout", "text": "\ud83d\udcda Working with Layers\n==============================\n1. Check available layers:\n   Available layers: ['spliced', 'unspliced']\n   Number of layers: 2\n\n2. Access a layer:\n   Layer 'spliced' type: <class 'slaf.integrations.anndata.LazyExpressionMatrix'>\n   Layer shape: (200, 500)\n   Layer is lazy: True\n\n3. Compute a layer (lazy evaluation):\n", "type": "stream"}, {"name": "stderr", "text": "{'record': {'elapsed': 'PT3.664837S', 'exception': None, 'extra': {}, 'file': {'name': 'slaf.py', 'path': '/Users/pavan/slaf-project/slaf/slaf/core/slaf.py'}, 'function': '_load_metadata', 'level': {'icon': '\u2139\ufe0f', 'name': 'INFO', 'no': 20}, 'line': 441, 'message': 'Using precomputed cell_start_index from cells table', 'module': 'slaf', 'name': 'slaf.core.slaf', 'process': {'id': 14438, 'name': 'Process-1'}, 'thread': {'id': 6296481792, 'name': 'Thread-11 (_load_metadata_async)'}, 'time': {}}}", "type": "stream"}, {"name": "stdout", "text": "   Computed 'spliced': <class 'scipy.sparse._csr.csr_matrix'>, shape (200, 500)\n\n4. Create a new layer:\n", "type": "stream"}, {"name": "stdout", "text": "   Created 'normalized' layer\n", "type": "stream"}, {"name": "stderr", "text": "/var/folders/4g/t2xnyv255vd8pmccptg62wq80000gn/T/marimo_14438/__marimo__cell_TRpd_.py:34: UserWarning: Layer names in config.json (['spliced', 'unspliced']) don't match layers table (['spliced', 'unspliced', 'normalized']). Using config.json values.\n  print(f\"   Updated layers: {list(adata_metadata.layers.keys())}\")\n", "type": "stream"}, {"name": "stdout", "text": "   Updated layers: ['spliced', 'unspliced']\n\n5. Layer operations:\n   - Dictionary-like interface: layers['name'], 'name' in layers\n   - Lazy evaluation: layers['name'].compute()\n   - Immutability: Converted layers are protected from deletion\n   - Wide format: Stored in layers.lance table (one column per layer)\n", "type": "stream"}], "id": "TRpd", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "e2f53bd890c22e19d4e9a15e4fdd9560", "console": [{"name": "stdout", "text": "\ud83d\udcca Working with Metadata Views\n===================================\n1. Obs (cell metadata) - DataFrame-like interface:\n   Available columns: ['cell_type', 'total_counts', 'cell_start_index']...\n   Number of columns: 3\n   - DataFrame-like: obs.columns, obs.head(), obs['col']\n   - Dict-like: 'col' in obs, len(obs)\n   - Mutations: obs['new_col'] = values\n\n2. Var (gene metadata) - DataFrame-like interface:\n", "type": "stream"}, {"name": "stdout", "text": "   Available columns: ['highly_variable']...\n   Number of columns: 1\n   - Same interface as obs\n   - Mutations: var['new_col'] = values\n\n3. Obsm (cell embeddings) - Dictionary-like interface:\n   Available keys: ['X_umap', 'X_pca']\n   - X_umap: shape (200, 2), type <class 'numpy.ndarray'>\n   - X_pca: shape (200, 50), type <class 'numpy.ndarray'>\n\n4. Varm (gene embeddings) - Dictionary-like interface:\n", "type": "stream"}, {"name": "stdout", "text": "   Available keys: ['PCs']\n   - PCs: shape (500, 50), type <class 'numpy.ndarray'>\n\n5. Uns (unstructured metadata) - Dictionary-like interface:\n   Available keys: ['neighbors', 'pca']\n   Example: ['neighbors', 'pca']\n\n6. Key features:\n   - Lazy evaluation: Metadata accessed on-demand\n   - Immutability: Converted columns/keys are protected\n   - Subsetting: Views respect cell/gene selectors\n   - Persistence: Changes are saved to Lance tables\n", "type": "stream"}], "id": "TXez", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "82e5c7bdd31e18b5f68acad2dd210dde", "console": [{"name": "stdout", "text": "\u270f\ufe0f Metadata Mutations Example\n===================================\n1. Create obs column:\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Created 'clusters' column with 3 unique values\n   Column is immediately saved to cells.lance\n\n2. Create var column:\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Created 'is_hvg' column: 155 genes marked as highly variable\n   Column is immediately saved to genes.lance\n\n3. Store obsm (cell embeddings):\n", "type": "stream"}, {"name": "stdout", "text": "   \u2705 Created 'X_custom' embedding: shape (200, 3)\n   Stored as FixedSizeListArray in cells.lance\n   Available obsm keys: ['X_custom', 'X_pca', 'X_umap']\n\n4. Store varm (gene embeddings):\n", "type": "stream"}], "id": "dNNg", "outputs": [{"data": {"text/plain": ""}, "type": "data"}]}, {"code_hash": "ff43f9f68a1aa5aecf8ae5990b5f26eb", "console": [], "id": "yCnT", "outputs": [{"data": {"text/html": "<span class=\"markdown prose dark:prose-invert\"><h2 id=\"summary\">Summary</h2>\n<span class=\"paragraph\"><strong>What you've learned about SLAF's lazy processing:</strong></span>\n<ol>\n<li><strong>Lazy Objects</strong>: LazyAnnData and LazyExpressionMatrix store operations, not data</li>\n<li><strong>Explicit Control</strong>: Use .compute() methods to control when data is processed</li>\n<li><strong>Slicing Patterns</strong>: Multiple slicing patterns, all lazy and composable</li>\n<li><strong>Transformations</strong>: Lazy transformations that are preserved through operations</li>\n<li><strong>Performance</strong>: Build complex pipelines instantly, compute only when needed</li>\n<li><strong>Memory Efficiency</strong>: Significant memory savings compared to eager loading</li>\n<li><strong>Best Practices</strong>: Guidelines for optimal lazy evaluation usage</li>\n<li><strong>Layers</strong>: Alternative expression matrices stored in layers.lance (wide format)</li>\n<li><strong>Metadata Views</strong>: Full support for obs, var, obsm, varm, and uns with lazy evaluation</li>\n</ol>\n<span class=\"paragraph\"><strong>Next Steps:</strong></span>\n<ul>\n<li><strong>03-ml-training-pipeline.py</strong>: Complete ML training workflows with tokenizers and dataloaders</li>\n</ul></span>"}, "type": "data"}]}], "metadata": {"marimo_version": "0.17.0"}, "version": "1"},
            "runtimeConfig": null,
        };
    </script>

<marimo-code hidden="">
    import%20marimo%0A%0A__generated_with%20%3D%20%220.17.0%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20time%0A%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20numpy%20as%20np%0A%20%20%20%20from%20scipy.sparse%20import%20csr_matrix%0A%0A%20%20%20%20from%20slaf.integrations%20import%20scanpy%20as%20slaf_scanpy%0A%20%20%20%20from%20slaf.integrations.anndata%20import%20read_slaf%0A%20%20%20%20return%20csr_matrix%2C%20mo%2C%20np%2C%20read_slaf%2C%20slaf_scanpy%2C%20time%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%20SLAF%20Lazy%20Processing%20Deep%20Dive%0A%0A%20%20%20%20This%20notebook%20explores%20SLAF's%20lazy%20evaluation%20capabilities%20in%20detail.%20You'll%20learn%20how%20to%3A%0A%0A%20%20%20%20-%20Build%20complex%20analysis%20pipelines%20without%20loading%20data%0A%20%20%20%20-%20Apply%20multiple%20transformations%20efficiently%0A%20%20%20%20-%20Use%20different%20slicing%20patterns%0A%20%20%20%20-%20Control%20when%20computation%20happens%0A%20%20%20%20-%20Understand%20performance%20benefits%0A%0A%20%20%20%20**Key%20Concept**%3A%20Lazy%20evaluation%20means%20operations%20are%20stored%20as%20instructions%20and%20only%20executed%20when%20you%20explicitly%20request%20the%20results.%0A%0A%20%20%20%20**Key%20Benefits%3A**%0A%20%20%20%20-%20%F0%9F%9A%80%20**Instant%20Pipeline%20Building**%3A%20No%20waiting%20for%20data%20loading%0A%20%20%20%20-%20%F0%9F%92%BE%20**Memory%20Efficient**%3A%20Only%20load%20what%20you%20need%0A%20%20%20%20-%20%F0%9F%94%84%20**Composable**%3A%20Operations%20can%20be%20combined%20and%20preserved%0A%20%20%20%20-%20%E2%9A%A1%20**SQL%20Performance**%3A%20Leverage%20database-level%20optimizations%0A%20%20%20%20-%20%F0%9F%A7%AC%20**Scanpy%20Compatible**%3A%20Familiar%20interface%20with%20performance%20benefits%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(read_slaf)%3A%0A%20%20%20%20%23%20Load%20data%20for%20lazy%20processing%20examples%0A%20%20%20%20adata%20%3D%20read_slaf(%22..%2Fslaf-datasets%2Fpbmc3k_processed.slaf%22)%0A%20%20%20%20print(f%22%E2%9C%85%20Loaded%20dataset%3A%20%7Badata.shape%5B0%5D%3A%2C%7D%20cells%20%C3%97%20%7Badata.shape%5B1%5D%3A%2C%7D%20genes%22)%0A%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(adata)%7D%22)%0A%20%20%20%20print(f%22%20%20%20Expression%20matrix%20type%3A%20%7Btype(adata.X)%7D%22)%0A%20%20%20%20return%20(adata%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%201.%20Understanding%20Lazy%20Objects%0A%0A%20%20%20%20SLAF%20provides%20two%20main%20lazy%20object%20types%3A%0A%0A%20%20%20%20-%20**LazyAnnData**%3A%20Lazy%20version%20of%20AnnData%20with%20scanpy%20compatibility%0A%0A%20%20%20%20-%20**LazyExpressionMatrix**%3A%20Lazy%20version%20of%20the%20expression%20matrix%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata)%3A%0A%20%20%20%20%23%20Demonstrate%20lazy%20object%20types%0A%20%20%20%20print(%22%F0%9F%94%8D%20Lazy%20Object%20Types%22)%0A%20%20%20%20print(%22%3D%22%20*%2030)%0A%0A%20%20%20%20print(f%221.%20LazyAnnData%20type%3A%20%7Btype(adata)%7D%22)%0A%20%20%20%20print(f%22%20%20%20-%20Shape%3A%20%7Badata.shape%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20-%20Obs%20columns%3A%20%7Blist(adata.obs.columns)%20if%20hasattr(adata%2C%20'obs')%20and%20adata.obs%20is%20not%20None%20else%20'Not%20loaded'%7D%22%0A%20%20%20%20)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20-%20Var%20columns%3A%20%7Blist(adata.var.columns)%20if%20hasattr(adata%2C%20'var')%20and%20adata.var%20is%20not%20None%20else%20'Not%20loaded'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20print(f%22%5Cn2.%20LazyExpressionMatrix%20type%3A%20%7Btype(adata.X)%7D%22)%0A%20%20%20%20print(f%22%20%20%20-%20Shape%3A%20%7Badata.X.shape%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20-%20Parent%3A%20%7Btype(adata.X.parent_adata)%20if%20hasattr(adata.X%2C%20'parent_adata')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22%5Cn3.%20Key%20insight%3A%20These%20objects%20store%20operations%2C%20not%20data!%22)%0A%20%20%20%20print(%22%20%20%20-%20No%20data%20is%20loaded%20until%20you%20call%20.compute()%22)%0A%20%20%20%20print(%22%20%20%20-%20Operations%20are%20composed%20efficiently%22)%0A%20%20%20%20print(%22%20%20%20-%20Memory%20usage%20stays%20low%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%202.%20Explicit%20Computation%20Control%0A%0A%20%20%20%20You%20control%20when%20data%20is%20actually%20computed%20using%20these%20methods%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata%2C%20time)%3A%0A%20%20%20%20def%20demonstrate_computation_control()%3A%0A%20%20%20%20%20%20%20%20%23%20Demonstrate%20explicit%20computation%20control%0A%20%20%20%20%20%20%20%20print(%22%F0%9F%8E%9B%EF%B8%8F%20Explicit%20Computation%20Control%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20%20%20%20%20print(%22Available%20computation%20methods%3A%22)%0A%20%20%20%20%20%20%20%20print(%221.%20adata.compute()%20%E2%86%92%20native%20AnnData%20object%22)%0A%20%20%20%20%20%20%20%20print(%222.%20adata.X.compute()%20%E2%86%92%20scipy.sparse.csr_matrix%22)%0A%20%20%20%20%20%20%20%20print(%223.%20adata.obs%20%E2%86%92%20pandas.DataFrame%20(cell%20metadata)%22)%0A%20%20%20%20%20%20%20%20print(%224.%20adata.var%20%E2%86%92%20pandas.DataFrame%20(gene%20metadata)%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5CnLet's%20demonstrate%3A%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Compute%20just%20the%20expression%20matrix%0A%20%20%20%20%20%20%20%20print(%22%5Cn1.%20Computing%20expression%20matrix...%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20sparse_matrix%20%3D%20adata.X.compute()%0A%20%20%20%20%20%20%20%20compute_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Bcompute_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(sparse_matrix)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bsparse_matrix.shape%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Memory%3A%20%7Bsparse_matrix.data.nbytes%20%2F%201024%20%2F%201024%3A.1f%7D%20MB%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Access%20cell%20metadata%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Accessing%20cell%20metadata...%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20obs_df%20%3D%20adata.obs%0A%20%20%20%20%20%20%20%20obs_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Accessed%20in%20%7Bobs_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(obs_df)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bobs_df.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20return%20(sparse_matrix%2C%20obs_df)%0A%0A%20%20%20%20sparse_matrix%2C%20obs_df%20%3D%20demonstrate_computation_control()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%203.%20Slicing%20Patterns%20-%20All%20the%20Ways%20to%20Slice%0A%0A%20%20%20%20SLAF%20supports%20multiple%20slicing%20patterns%2C%20all%20of%20which%20are%20lazy%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata)%3A%0A%20%20%20%20%23%20Demonstrate%20different%20slicing%20patterns%0A%20%20%20%20def%20demonstrate_slicing_patterns(adata)%3A%0A%20%20%20%20%20%20%20%20print(%22%E2%9C%82%EF%B8%8F%20Slicing%20Patterns%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2025)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Basic%20integer%20slicing%3A%22)%0A%20%20%20%20%20%20%20%20slice1%20%3D%20adata%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20adata%5B%3A100%2C%20%3A50%5D%20%E2%86%92%20%7Btype(slice1)%7D%20with%20shape%20%7Bslice1.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Expression%20matrix%20slicing%3A%22)%0A%20%20%20%20%20%20%20%20slice2%20%3D%20adata.X%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20adata.X%5B%3A100%2C%20%3A50%5D%20%E2%86%92%20%7Btype(slice2)%7D%20with%20shape%20%7Bslice2.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Boolean%20indexing%20(after%20QC%20metrics%20are%20available)%3A%22)%0A%20%20%20%20%20%20%20%20%23%20First%20add%20some%20QC%20metrics%0A%20%20%20%20%20%20%20%20if%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20hasattr(adata%2C%20%22obs%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20and%20adata.obs%20is%20not%20None%0A%20%20%20%20%20%20%20%20%20%20%20%20and%20%22n_genes_by_counts%22%20in%20adata.obs.columns%0A%20%20%20%20%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20high_quality_mask%20%3D%20adata.obs%5B%22n_genes_by_counts%22%5D%20%3E%201000%0A%20%20%20%20%20%20%20%20%20%20%20%20slice3%20%3D%20adata%5Bhigh_quality_mask%2C%20%3A%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%20%20%20adata%5Bhigh_quality_mask%2C%20%3A%5D%20%E2%86%92%20%7Btype(slice3)%7D%20with%20shape%20%7Bslice3.shape%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22%20%20%20(QC%20metrics%20not%20available%20yet%20-%20will%20be%20computed%20in%20preprocessing%20section)%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn4.%20Mixed%20indexing%3A%22)%0A%20%20%20%20%20%20%20%20slice4%20%3D%20adata%5B%3A100%2C%20adata.var.index%5B%3A50%5D%5D%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22%20%20%20adata%5B%3A100%2C%20adata.var.index%5B%3A50%5D%5D%20%E2%86%92%20%7Btype(slice4)%7D%20with%20shape%20%7Bslice4.shape%7D%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20print(%22%5CnKey%20insight%3A%20All%20slicing%20returns%20lazy%20objects!%22)%0A%0A%20%20%20%20demonstrate_slicing_patterns(adata)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%204.%20Transformation%20Patterns%0A%0A%20%20%20%20SLAF%20supports%20lazy%20transformations%20that%20are%20stored%20and%20applied%20when%20needed%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(read_slaf)%3A%0A%20%20%20%20%23%20Load%20fresh%20data%20for%20transformation%20examples%0A%20%20%20%20adata_fresh%20%3D%20read_slaf(%22..%2Fslaf-datasets%2Fpbmc3k_processed.slaf%22)%0A%20%20%20%20print(%22%E2%9C%85%20Loaded%20fresh%20dataset%20for%20transformations%22)%0A%20%20%20%20return%20(adata_fresh%2C)%0A%0A%0A%40app.cell%0Adef%20_(adata_fresh%2C%20slaf_scanpy)%3A%0A%20%20%20%20%23%20Demonstrate%20transformation%20patterns%0A%20%20%20%20print(%22%F0%9F%94%84%20Transformation%20Patterns%22)%0A%20%20%20%20print(%22%3D%22%20*%2030)%0A%0A%20%20%20%20print(%221.%20Single%20transformation%3A%22)%0A%20%20%20%20adata_norm%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20adata_fresh%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20)%0A%20%20%20%20print(f%22%20%20%20normalize_total()%20%E2%86%92%20%7Btype(adata_norm)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%20stored%3A%20%7Blist(adata_norm._transformations.keys())%20if%20hasattr(adata_norm%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22%5Cn2.%20Chained%20transformations%3A%22)%0A%20%20%20%20adata_processed%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20adata_fresh%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20)%0A%20%20%20%20adata_processed%20%3D%20slaf_scanpy.pp.log1p(adata_processed%2C%20inplace%3DFalse)%0A%20%20%20%20print(f%22%20%20%20normalize_total().log1p()%20%E2%86%92%20%7Btype(adata_processed)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%20stored%3A%20%7Blist(adata_processed._transformations.keys())%20if%20hasattr(adata_processed%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22%5Cn3.%20Transformation%20on%20sliced%20data%3A%22)%0A%20%20%20%20%23%20First%20slice%2C%20then%20apply%20transformation%20(safer%20pattern)%0A%20%20%20%20slice_data%20%3D%20adata_fresh%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20slice_transformed%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20slice_data%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20)%0A%20%20%20%20print(f%22%20%20%20adata%5B%3A100%2C%20%3A50%5D.normalize_total()%20%E2%86%92%20%7Btype(slice_transformed)%7D%22)%0A%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bslice_transformed.shape%7D%22)%0A%0A%20%20%20%20print(%22%5Cn4.%20Multiple%20transformations%20on%20slice%3A%22)%0A%20%20%20%20%23%20First%20slice%2C%20then%20apply%20transformations%20(safer%20pattern)%0A%20%20%20%20slice_data%20%3D%20adata_fresh%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20slice_multi%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20slice_data%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20)%0A%20%20%20%20slice_multi%20%3D%20slaf_scanpy.pp.log1p(slice_multi%2C%20inplace%3DFalse)%0A%20%20%20%20print(f%22%20%20%20Multiple%20transformations%20on%20slice%20%E2%86%92%20%7Btype(slice_multi)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%3A%20%7Blist(slice_multi._transformations.keys())%20if%20hasattr(slice_multi%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%20%20%20%20return%20adata_processed%2C%20slice_multi%2C%20slice_transformed%0A%0A%0A%40app.cell%0Adef%20_(adata_processed%2C%20slice_multi%2C%20slice_transformed%2C%20time)%3A%0A%20%20%20%20def%20demonstrate_transformation_application()%3A%0A%20%20%20%20%20%20%20%20%23%20Demonstrate%20transformation%20application%0A%20%20%20%20%20%20%20%20print(%22%E2%9A%A1%20Applying%20Transformations%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2030)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Computing%20transformed%20data%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20native_processed%20%3D%20adata_processed.compute()%0A%20%20%20%20%20%20%20%20process_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Bprocess_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(native_processed)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bnative_processed.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Computing%20transformed%20slice%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20native_slice_matrix%20%3D%20slice_transformed.X.compute()%0A%20%20%20%20%20%20%20%20slice_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Bslice_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(native_slice_matrix)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bnative_slice_matrix.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Computing%20multi-transformed%20slice%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20native_multi_matrix%20%3D%20slice_multi.X.compute()%0A%20%20%20%20%20%20%20%20multi_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Bmulti_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(native_multi_matrix)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bnative_multi_matrix.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20return%20(native_processed%2C%20native_slice_matrix%2C%20native_multi_matrix)%0A%0A%20%20%20%20demonstrate_transformation_application()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%205.%20Transformation%20Preservation%20Through%20Operations%0A%0A%20%20%20%20Transformations%20are%20preserved%20through%20slicing%20and%20other%20operations%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(read_slaf)%3A%0A%20%20%20%20%23%20Load%20fresh%20data%20for%20preservation%20examples%0A%20%20%20%20adata_preserve%20%3D%20read_slaf(%22..%2Fslaf-datasets%2Fpbmc3k.slaf%22)%0A%20%20%20%20return%20(adata_preserve%2C)%0A%0A%0A%40app.cell%0Adef%20_(adata_preserve%2C%20np%2C%20slaf_scanpy)%3A%0A%20%20%20%20%23%20Demonstrate%20transformation%20preservation%0A%20%20%20%20print(%22%F0%9F%94%84%20Transformation%20Preservation%22)%0A%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20print(%221.%20Apply%20transformations%20first%2C%20then%20slice%3A%22)%0A%20%20%20%20adata_transformed%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20adata_preserve%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20)%0A%20%20%20%20adata_transformed%20%3D%20slaf_scanpy.pp.log1p(adata_transformed%2C%20inplace%3DFalse)%0A%20%20%20%20slice_after%20%3D%20adata_transformed%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Original%20transformations%3A%20%7Blist(adata_transformed._transformations.keys())%20if%20hasattr(adata_transformed%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Slice%20transformations%3A%20%7Blist(slice_after._transformations.keys())%20if%20hasattr(slice_after%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22%5Cn2.%20Slice%20first%2C%20then%20apply%20transformations%3A%22)%0A%20%20%20%20slice_before%20%3D%20adata_preserve%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20transformed_slice%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20slice_before%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20)%0A%20%20%20%20transformed_slice%20%3D%20slaf_scanpy.pp.log1p(transformed_slice%2C%20inplace%3DFalse)%0A%20%20%20%20print(f%22%20%20%20Transformed%20slice%3A%20%7Btype(transformed_slice)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%3A%20%7Blist(transformed_slice._transformations.keys())%20if%20hasattr(transformed_slice%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20print(%22%5Cn3.%20Complex%20slicing%20patterns%20preserve%20transformations%3A%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%22%20%20%20Note%3A%20Chained%20slicing%20(e.g.%2C%20adata%5B%3A200%2C%20%3A100%5D%5B%3A50%2C%20%3A25%5D)%20is%20not%20supported.%22%0A%20%20%20%20)%0A%20%20%20%20print(%22%20%20%20Use%20single-step%20slicing%20instead%3A%20adata%5B50%3A250%2C%2025%3A125%5D%22)%0A%0A%20%20%20%20%23%20Single-step%20slicing%20(equivalent%20to%20nested%20slicing)%0A%20%20%20%20single_step_slice%20%3D%20adata_transformed%5B50%3A250%2C%2025%3A125%5D%0A%20%20%20%20print(f%22%20%20%20Single-step%20slice%3A%20%7Btype(single_step_slice)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%20preserved%3A%20%7Blist(single_step_slice._transformations.keys())%20if%20hasattr(single_step_slice%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Boolean%20mask%20slicing%0A%20%20%20%20cell_mask%20%3D%20np.zeros(adata_transformed.shape%5B0%5D%2C%20dtype%3Dbool)%0A%20%20%20%20cell_mask%5B50%3A250%5D%20%3D%20True%0A%20%20%20%20gene_mask%20%3D%20np.zeros(adata_transformed.shape%5B1%5D%2C%20dtype%3Dbool)%0A%20%20%20%20gene_mask%5B25%3A125%5D%20%3D%20True%0A%20%20%20%20boolean_slice%20%3D%20adata_transformed%5Bcell_mask%2C%20gene_mask%5D%0A%20%20%20%20print(f%22%20%20%20Boolean%20mask%20slice%3A%20%7Btype(boolean_slice)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%20preserved%3A%20%7Blist(boolean_slice._transformations.keys())%20if%20hasattr(boolean_slice%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Step%20slicing%0A%20%20%20%20step_slice%20%3D%20adata_transformed%5B%3A%3A4%2C%20%3A%3A2%5D%20%20%23%20Every%204th%20cell%2C%20every%202nd%20gene%0A%20%20%20%20print(f%22%20%20%20Step%20slice%3A%20%7Btype(step_slice)%7D%22)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%20preserved%3A%20%7Blist(step_slice._transformations.keys())%20if%20hasattr(step_slice%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20)%0A%20%20%20%20return%20single_step_slice%2C%20slice_after%2C%20transformed_slice%0A%0A%0A%40app.cell%0Adef%20_(single_step_slice%2C%20slice_after%2C%20time%2C%20transformed_slice)%3A%0A%20%20%20%20def%20verify_transformation_preservation()%3A%0A%20%20%20%20%20%20%20%20%23%20Verify%20transformation%20preservation%20by%20computing%0A%20%20%20%20%20%20%20%20print(%22%E2%9C%85%20Verifying%20Transformation%20Preservation%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2040)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Computing%20slice%20with%20preserved%20transformations%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20result1%20%3D%20slice_after.X.compute()%0A%20%20%20%20%20%20%20%20time1%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Btime1%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(result1)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bresult1.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Computing%20slice%20with%20applied%20transformations%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20result2%20%3D%20transformed_slice.X.compute()%0A%20%20%20%20%20%20%20%20time2%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Btime2%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(result2)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bresult2.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Computing%20single-step%20slice%20with%20preserved%20transformations%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20result3%20%3D%20single_step_slice.X.compute()%0A%20%20%20%20%20%20%20%20time3%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Btime3%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(result3)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bresult3.shape%7D%22)%0A%0A%20%20%20%20verify_transformation_preservation()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%206.%20Performance%20Benefits%20-%20Building%20Complex%20Pipelines%0A%0A%20%20%20%20Let's%20see%20how%20lazy%20evaluation%20enables%20efficient%20complex%20pipelines%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata%2C%20slaf_scanpy%2C%20time)%3A%0A%20%20%20%20%23%20Demonstrate%20performance%20benefits%0A%0A%20%20%20%20def%20demonstrate_complex_pipeline(adata)%3A%0A%20%20%20%20%20%20%20%20print(%22%E2%9A%A1%20Performance%20Benefits%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2025)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Building%20complex%20pipeline%20(no%20computation%20yet)%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%0A%20%20%20%20%20%20%20%20%23%20Build%20a%20complex%20pipeline%0A%20%20%20%20%20%20%20%20pipeline%20%3D%20slaf_scanpy.pp.normalize_total(adata%2C%20target_sum%3D1e4%2C%20inplace%3DFalse)%0A%20%20%20%20%20%20%20%20pipeline%20%3D%20slaf_scanpy.pp.log1p(pipeline%2C%20inplace%3DFalse)%0A%0A%20%20%20%20%20%20%20%20%23%20Note%3A%20highly_variable_genes%20returns%20a%20DataFrame%2C%20not%20a%20LazyAnnData%20object%0A%20%20%20%20%20%20%20%20%23%20so%20it%20can't%20be%20chained%20in%20the%20pipeline%20like%20other%20transformations%0A%0A%20%20%20%20%20%20%20%20%23%20Slice%20the%20processed%20data%0A%20%20%20%20%20%20%20%20final_slice%20%3D%20pipeline%5B%3A500%2C%20%3A200%5D%0A%0A%20%20%20%20%20%20%20%20build_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Pipeline%20built%20in%20%7Bbuild_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Final%20object%3A%20%7Btype(final_slice)%7D%22)%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%20%20%20Expected%20shape%3A%20(500%2C%20200)%22%0A%20%20%20%20%20%20%20%20)%20%20%23%20Avoid%20accessing%20.shape%20on%20transformed%20slice%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22%20%20%20Transformations%3A%20%7Blist(final_slice._transformations.keys())%20if%20hasattr(final_slice%2C%20'_transformations')%20else%20'None'%7D%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Computing%20the%20final%20result%3A%22)%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20final_result%20%3D%20final_slice.X.compute()%0A%20%20%20%20%20%20%20%20compute_time%20%3D%20time.time()%20-%20start_time%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Computed%20in%20%7Bcompute_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Type%3A%20%7Btype(final_result)%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Shape%3A%20%7Bfinal_result.shape%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(f%22%5Cn3.%20Total%20time%3A%20%7Bbuild_time%20%2B%20compute_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%20%20%20Key%20insight%3A%20Pipeline%20building%20is%20instant%2C%20computation%20happens%20only%20when%20needed!%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20demonstrate_complex_pipeline(adata)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%207.%20Memory%20Efficiency%20Comparison%0A%0A%20%20%20%20Let's%20compare%20memory%20usage%20between%20lazy%20and%20eager%20approaches%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(read_slaf)%3A%0A%20%20%20%20%23%20Memory%20efficiency%20comparison%0A%20%20%20%20print(%22%F0%9F%92%BE%20Memory%20Efficiency%20Comparison%22)%0A%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20import%20gc%0A%0A%20%20%20%20import%20psutil%0A%0A%20%20%20%20def%20get_memory_usage()%3A%0A%20%20%20%20%20%20%20%20%22%22%22Get%20current%20memory%20usage%20in%20MB%22%22%22%0A%20%20%20%20%20%20%20%20process%20%3D%20psutil.Process()%0A%20%20%20%20%20%20%20%20return%20process.memory_info().rss%20%2F%201024%20%2F%201024%0A%0A%20%20%20%20%23%20Load%20fresh%20data%0A%20%20%20%20adata_mem%20%3D%20read_slaf(%22..%2Fslaf-datasets%2Fpbmc3k_processed.slaf%22)%0A%0A%20%20%20%20print(%221.%20Memory%20after%20loading%20lazy%20data%3A%22)%0A%20%20%20%20gc.collect()%0A%20%20%20%20lazy_memory%20%3D%20get_memory_usage()%0A%20%20%20%20print(f%22%20%20%20Lazy%20loading%3A%20%7Blazy_memory%3A.1f%7D%20MB%22)%0A%0A%20%20%20%20print(%22%5Cn2.%20Memory%20after%20computing%20full%20dataset%3A%22)%0A%20%20%20%20gc.collect()%0A%20%20%20%20start_memory%20%3D%20get_memory_usage()%0A%20%20%20%20_%20%3D%20adata_mem.compute()%0A%20%20%20%20end_memory%20%3D%20get_memory_usage()%0A%20%20%20%20print(f%22%20%20%20Eager%20loading%3A%20%7Bend_memory%3A.1f%7D%20MB%22)%0A%20%20%20%20print(f%22%20%20%20Memory%20increase%3A%20%7Bend_memory%20-%20start_memory%3A.1f%7D%20MB%22)%0A%0A%20%20%20%20print(%22%5Cn3.%20Memory%20after%20computing%20small%20slice%3A%22)%0A%20%20%20%20gc.collect()%0A%20%20%20%20slice_memory_before%20%3D%20get_memory_usage()%0A%20%20%20%20_%20%3D%20adata_mem%5B%3A100%2C%20%3A50%5D.compute()%0A%20%20%20%20slice_memory_after%20%3D%20get_memory_usage()%0A%20%20%20%20print(f%22%20%20%20Small%20slice%3A%20%7Bslice_memory_after%3A.1f%7D%20MB%22)%0A%20%20%20%20print(f%22%20%20%20Memory%20increase%3A%20%7Bslice_memory_after%20-%20slice_memory_before%3A.1f%7D%20MB%22)%0A%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%5CnKey%20insight%3A%20Lazy%20loading%20uses%20%7Blazy_memory%3A.1f%7D%20MB%20vs%20eager%20loading%20%7Bend_memory%3A.1f%7D%20MB%22%0A%20%20%20%20)%0A%20%20%20%20print(f%22Memory%20savings%3A%20%7B((end_memory%20-%20lazy_memory)%20%2F%20end_memory%20*%20100)%3A.1f%7D%25%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%208.%20Advanced%20Slicing%20Patterns%0A%0A%20%20%20%20Let's%20explore%20more%20advanced%20slicing%20patterns%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(read_slaf%2C%20slaf_scanpy)%3A%0A%20%20%20%20%23%20Advanced%20slicing%20patterns%0A%20%20%20%20print(%22%F0%9F%94%AC%20Advanced%20Slicing%20Patterns%22)%0A%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20%23%20Load%20data%20and%20add%20QC%20metrics%0A%20%20%20%20adata_advanced%20%3D%20read_slaf(%22..%2Fslaf-datasets%2Fpbmc3k_processed.slaf%22)%0A%20%20%20%20slaf_scanpy.pp.calculate_qc_metrics(adata_advanced%2C%20inplace%3DTrue)%0A%0A%20%20%20%20print(%221.%20Boolean%20indexing%20with%20QC%20metrics%3A%22)%0A%20%20%20%20high_quality_mask%20%3D%20adata_advanced.obs%5B%22n_genes_by_counts%22%5D%20%3E%201000%0A%20%20%20%20high_quality_cells%20%3D%20adata_advanced%5Bhigh_quality_mask%2C%20%3A%5D%0A%20%20%20%20print(f%22%20%20%20High%20quality%20cells%3A%20%7Bhigh_quality_cells.shape%7D%22)%0A%0A%20%20%20%20print(%22%5Cn2.%20Gene-based%20filtering%3A%22)%0A%20%20%20%20if%20(%0A%20%20%20%20%20%20%20%20hasattr(adata_advanced%2C%20%22var%22)%0A%20%20%20%20%20%20%20%20and%20adata_advanced.var%20is%20not%20None%0A%20%20%20%20%20%20%20%20and%20%22highly_variable%22%20in%20adata_advanced.var.columns%0A%20%20%20%20)%3A%0A%20%20%20%20%20%20%20%20hvg_mask%20%3D%20adata_advanced.var%5B%22highly_variable%22%5D%0A%20%20%20%20%20%20%20%20hvg_genes%20%3D%20adata_advanced%5B%3A%2C%20hvg_mask%5D%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Highly%20variable%20genes%3A%20%7Bhvg_genes.shape%7D%22)%0A%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20print(%22%20%20%20(Highly%20variable%20genes%20not%20available%20yet)%22)%0A%0A%20%20%20%20print(%22%5Cn3.%20Combined%20cell%20and%20gene%20filtering%3A%22)%0A%20%20%20%20combined%20%3D%20adata_advanced%5Bhigh_quality_mask%2C%20%3A100%5D%0A%20%20%20%20print(f%22%20%20%20Combined%20filtering%3A%20%7Bcombined.shape%7D%22)%0A%0A%20%20%20%20print(%22%5Cn4.%20Expression-based%20filtering%3A%22)%0A%20%20%20%20%23%20Get%20cells%20with%20high%20total%20counts%0A%20%20%20%20high_counts_mask%20%3D%20adata_advanced.obs%5B%22total_counts%22%5D%20%3E%202000%0A%20%20%20%20high_counts_cells%20%3D%20adata_advanced%5Bhigh_counts_mask%2C%20%3A%5D%0A%20%20%20%20print(f%22%20%20%20High%20count%20cells%3A%20%7Bhigh_counts_cells.shape%7D%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%209.%20Lazy%20vs%20Eager%20Performance%20Comparison%0A%0A%20%20%20%20Let's%20compare%20the%20performance%20of%20lazy%20vs%20eager%20approaches%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata%2C%20slaf_scanpy%2C%20time)%3A%0A%20%20%20%20%23%20Performance%20comparison%0A%20%20%20%20def%20compare_lazy_vs_eager_performance(adata)%3A%0A%20%20%20%20%20%20%20%20print(%22%E2%9A%A1%20Lazy%20vs%20Eager%20Performance%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20%20%20%20%20%23%20Test%20scenario%3A%20Apply%20transformations%20and%20slice%0A%20%20%20%20%20%20%20%20print(%22Scenario%3A%20normalize_total%20%E2%86%92%20log1p%20%E2%86%92%20slice%5B%3A100%2C%20%3A50%5D%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Lazy%20approach%0A%20%20%20%20%20%20%20%20print(%22%5Cn1.%20Lazy%20approach%3A%22)%0A%20%20%20%20%20%20%20%20adata_lazy%20%3D%20adata%0A%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20lazy_pipeline%20%3D%20slaf_scanpy.pp.normalize_total(%0A%20%20%20%20%20%20%20%20%20%20%20%20adata_lazy%2C%20target_sum%3D1e4%2C%20inplace%3DFalse%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20lazy_pipeline%20%3D%20slaf_scanpy.pp.log1p(lazy_pipeline%2C%20inplace%3DFalse)%0A%20%20%20%20%20%20%20%20lazy_slice%20%3D%20lazy_pipeline%5B%3A100%2C%20%3A50%5D%0A%20%20%20%20%20%20%20%20lazy_build_time%20%3D%20time.time()%20-%20start_time%0A%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20%23%20Use%20.X.compute()%20to%20avoid%20the%20metadata%20mismatch%20issue%0A%20%20%20%20%20%20%20%20_%20%3D%20lazy_slice.X.compute()%0A%20%20%20%20%20%20%20%20lazy_compute_time%20%3D%20time.time()%20-%20start_time%0A%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Build%20time%3A%20%7Blazy_build_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Compute%20time%3A%20%7Blazy_compute_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Total%20time%3A%20%7Blazy_build_time%20%2B%20lazy_compute_time%3A.4f%7Ds%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Eager%20approach%20(simulated)%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Eager%20approach%20(simulated)%3A%22)%0A%0A%20%20%20%20%20%20%20%20start_time%20%3D%20time.time()%0A%20%20%20%20%20%20%20%20_%20%3D%20adata.compute()%0A%20%20%20%20%20%20%20%20eager_load_time%20%3D%20time.time()%20-%20start_time%0A%0A%20%20%20%20%20%20%20%20%23%20Simulate%20eager%20transformations%20(this%20would%20be%20done%20in%20memory)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Load%20time%3A%20%7Beager_load_time%3A.4f%7Ds%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Transformations%20would%20be%20done%20in%20memory%20(slower%20for%20large%20datasets)%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Key%20benefits%3A%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Lazy%3A%20Build%20complex%20pipelines%20instantly%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Lazy%3A%20Only%20compute%20what%20you%20need%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Lazy%3A%20Memory%20efficient%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Lazy%3A%20SQL-level%20performance%20for%20operations%22)%0A%0A%20%20%20%20compare_lazy_vs_eager_performance(adata)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%2010.%20Best%20Practices%20and%20Tips%0A%0A%20%20%20%20Here%20are%20some%20best%20practices%20for%20using%20SLAF's%20lazy%20evaluation%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20Best%20practices%0A%20%20%20%20print(%22%F0%9F%92%A1%20Best%20Practices%20and%20Tips%22)%0A%20%20%20%20print(%22%3D%22%20*%2030)%0A%0A%20%20%20%20print(%221.%20Pipeline%20Building%3A%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Build%20complete%20pipelines%20before%20computing%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Chain%20transformations%3A%20adata.normalize_total().log1p()%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Slice%20after%20transformations%20for%20efficiency%22)%0A%0A%20%20%20%20print(%22%5Cn2.%20Computation%20Control%3A%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Use%20.compute()%20only%20when%20you%20need%20the%20data%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Use%20.obs%20or%20.var%20for%20metadata%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Use%20.X.compute()%20for%20expression%20matrix%20only%22)%0A%0A%20%20%20%20print(%22%5Cn3.%20Memory%20Management%3A%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Keep%20lazy%20objects%20for%20intermediate%20results%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Compute%20only%20final%20results%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Use%20slicing%20to%20reduce%20memory%20usage%22)%0A%0A%20%20%20%20print(%22%5Cn4.%20Performance%20Optimization%3A%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Leverage%20SQL-level%20operations%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Use%20boolean%20indexing%20for%20filtering%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Combine%20operations%20in%20single%20queries%20when%20possible%22)%0A%0A%20%20%20%20print(%22%5Cn5.%20Debugging%3A%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Check%20object%20types%3A%20type(adata)%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Check%20transformations%3A%20adata._transformations%22)%0A%20%20%20%20print(%22%20%20%20%E2%9C%85%20Use%20.info()%20for%20dataset%20overview%22)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%2011.%20Working%20with%20Layers%0A%0A%20%20%20%20SLAF%20supports%20AnnData%20layers%20(alternative%20expression%20matrices)%20stored%20in%20the%20%60layers.lance%60%20table.%0A%0A%20%20%20%20Let's%20create%20a%20synthetic%20dataset%20with%20layers%2C%20convert%20it%20to%20SLAF%2C%20and%20demonstrate%20layer%20operations%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(csr_matrix%2C%20np)%3A%0A%20%20%20%20%23%20Create%20synthetic%20AnnData%20with%20layers%2C%20obsm%2C%20varm%2C%20and%20uns%20for%20demonstration%0A%20%20%20%20import%20scanpy%20as%20sc%0A%0A%20%20%20%20%23%20Create%20a%20small%20synthetic%20dataset%0A%20%20%20%20n_cells%2C%20n_genes%20%3D%20200%2C%20500%0A%20%20%20%20np.random.seed(42)%0A%0A%20%20%20%20%23%20Main%20expression%20matrix%0A%20%20%20%20X%20%3D%20csr_matrix(np.random.lognormal(0%2C%201%2C%20(n_cells%2C%20n_genes)).astype(np.float32))%0A%0A%20%20%20%20%23%20Create%20AnnData%20object%0A%20%20%20%20adata_synthetic%20%3D%20sc.AnnData(X%3DX)%0A%0A%20%20%20%20%23%20Add%20obs%20metadata%0A%20%20%20%20adata_synthetic.obs%5B%22cell_type%22%5D%20%3D%20np.random.choice(%0A%20%20%20%20%20%20%20%20%5B%22T_cell%22%2C%20%22B_cell%22%2C%20%22NK_cell%22%5D%2C%20n_cells%0A%20%20%20%20)%0A%20%20%20%20adata_synthetic.obs%5B%22total_counts%22%5D%20%3D%20X.sum(axis%3D1).A1%0A%0A%20%20%20%20%23%20Add%20var%20metadata%0A%20%20%20%20adata_synthetic.var%5B%22highly_variable%22%5D%20%3D%20np.random.choice(%0A%20%20%20%20%20%20%20%20%5BTrue%2C%20False%5D%2C%20n_genes%2C%20p%3D%5B0.2%2C%200.8%5D%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Add%20layers%20(alternative%20expression%20matrices)%0A%20%20%20%20adata_synthetic.layers%5B%22spliced%22%5D%20%3D%20csr_matrix(%0A%20%20%20%20%20%20%20%20np.random.lognormal(0%2C%201%2C%20(n_cells%2C%20n_genes)).astype(np.float32)%0A%20%20%20%20)%0A%20%20%20%20adata_synthetic.layers%5B%22unspliced%22%5D%20%3D%20csr_matrix(%0A%20%20%20%20%20%20%20%20np.random.lognormal(0%2C%201%2C%20(n_cells%2C%20n_genes)).astype(np.float32)%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Add%20obsm%20(cell%20embeddings)%0A%20%20%20%20adata_synthetic.obsm%5B%22X_umap%22%5D%20%3D%20np.random.randn(n_cells%2C%202).astype(np.float32)%0A%20%20%20%20adata_synthetic.obsm%5B%22X_pca%22%5D%20%3D%20np.random.randn(n_cells%2C%2050).astype(np.float32)%0A%0A%20%20%20%20%23%20Add%20varm%20(gene%20embeddings)%0A%20%20%20%20adata_synthetic.varm%5B%22PCs%22%5D%20%3D%20np.random.randn(n_genes%2C%2050).astype(np.float32)%0A%0A%20%20%20%20%23%20Add%20uns%20(unstructured%20metadata)%0A%20%20%20%20adata_synthetic.uns%5B%22neighbors%22%5D%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22params%22%3A%20%7B%22n_neighbors%22%3A%2015%2C%20%22metric%22%3A%20%22euclidean%22%7D%0A%20%20%20%20%7D%0A%20%20%20%20adata_synthetic.uns%5B%22pca%22%5D%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%22variance_ratio%22%3A%20np.random.rand(50).tolist()%2C%0A%20%20%20%20%20%20%20%20%22variance%22%3A%20np.random.rand(50).tolist()%2C%0A%20%20%20%20%7D%0A%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%E2%9C%85%20Created%20synthetic%20AnnData%3A%20%7Badata_synthetic.shape%5B0%5D%7D%20cells%20%C3%97%20%7Badata_synthetic.shape%5B1%5D%7D%20genes%22%0A%20%20%20%20)%0A%20%20%20%20print(f%22%20%20%20Layers%3A%20%7Blist(adata_synthetic.layers.keys())%7D%22)%0A%20%20%20%20print(f%22%20%20%20Obsm%3A%20%7Blist(adata_synthetic.obsm.keys())%7D%22)%0A%20%20%20%20print(f%22%20%20%20Varm%3A%20%7Blist(adata_synthetic.varm.keys())%7D%22)%0A%20%20%20%20print(f%22%20%20%20Uns%3A%20%7Blist(adata_synthetic.uns.keys())%7D%22)%0A%20%20%20%20return%20(adata_synthetic%2C)%0A%0A%0A%40app.cell%0Adef%20_(adata_synthetic)%3A%0A%20%20%20%20%23%20Convert%20synthetic%20AnnData%20to%20SLAF%20format%0A%20%20%20%20import%20os%0A%20%20%20%20import%20tempfile%0A%0A%20%20%20%20from%20slaf.data.converter%20import%20SLAFConverter%0A%0A%20%20%20%20%23%20Create%20temporary%20directory%20for%20SLAF%20dataset%0A%20%20%20%20temp_dir%20%3D%20tempfile.mkdtemp()%0A%20%20%20%20slaf_path%20%3D%20os.path.join(temp_dir%2C%20%22synthetic_with_metadata.slaf%22)%0A%0A%20%20%20%20%23%20Convert%20to%20SLAF%20(use%20chunked%3DFalse%20for%20small%20in-memory%20AnnData%20objects)%0A%20%20%20%20converter%20%3D%20SLAFConverter(chunked%3DFalse)%0A%20%20%20%20converter.convert_anndata(adata_synthetic%2C%20slaf_path)%0A%20%20%20%20print(f%22%E2%9C%85%20Converted%20synthetic%20dataset%20to%20SLAF%3A%20%7Bslaf_path%7D%22)%0A%20%20%20%20return%20(slaf_path%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%2012.%20Working%20with%20Metadata%20Views%0A%0A%20%20%20%20SLAF%20provides%20lazy%20views%20for%20all%20AnnData%20metadata%20objects%20(obs%2C%20var%2C%20obsm%2C%20varm%2C%20uns)%3A%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(read_slaf%2C%20slaf_path)%3A%0A%20%20%20%20%23%20Load%20the%20converted%20SLAF%20dataset%20with%20all%20metadata%0A%20%20%20%20adata_metadata%20%3D%20read_slaf(slaf_path)%0A%20%20%20%20print(%0A%20%20%20%20%20%20%20%20f%22%E2%9C%85%20Loaded%20SLAF%20dataset%3A%20%7Badata_metadata.shape%5B0%5D%7D%20cells%20%C3%97%20%7Badata_metadata.shape%5B1%5D%7D%20genes%22%0A%20%20%20%20)%0A%20%20%20%20return%20(adata_metadata%2C)%0A%0A%0A%40app.cell%0Adef%20_(adata_metadata%2C%20csr_matrix)%3A%0A%20%20%20%20def%20demonstrate_layers()%3A%0A%20%20%20%20%20%20%20%20print(%22%F0%9F%93%9A%20Working%20with%20Layers%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2030)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Check%20available%20layers%3A%22)%0A%20%20%20%20%20%20%20%20available_layers%20%3D%20list(adata_metadata.layers.keys())%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20layers%3A%20%7Bavailable_layers%7D%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Number%20of%20layers%3A%20%7Blen(available_layers)%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Access%20a%20layer%3A%22)%0A%20%20%20%20%20%20%20%20if%20available_layers%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20layer_name%20%3D%20available_layers%5B0%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20layer_matrix%20%3D%20adata_metadata.layers%5Blayer_name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Layer%20'%7Blayer_name%7D'%20type%3A%20%7Btype(layer_matrix)%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Layer%20shape%3A%20%7Blayer_matrix.shape%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Layer%20is%20lazy%3A%20%7Bhasattr(layer_matrix%2C%20'compute')%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Compute%20a%20layer%20(lazy%20evaluation)%3A%22)%0A%20%20%20%20%20%20%20%20if%20available_layers%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20layer_name%20%3D%20available_layers%5B0%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20layer_matrix%20%3D%20adata_metadata.layers%5Blayer_name%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20layer_data%20%3D%20layer_matrix.compute()%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20f%22%20%20%20Computed%20'%7Blayer_name%7D'%3A%20%7Btype(layer_data)%7D%2C%20shape%20%7Blayer_data.shape%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn4.%20Create%20a%20new%20layer%3A%22)%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20simple%20normalized%20layer%20as%20example%0A%20%20%20%20%20%20%20%20normalized%20%3D%20adata_metadata.X.compute()%0A%20%20%20%20%20%20%20%20%23%20Simple%20normalization%20example%0A%20%20%20%20%20%20%20%20normalized%20%3D%20normalized%20%2F%20normalized.sum(axis%3D1)%20*%2010000%0A%20%20%20%20%20%20%20%20adata_metadata.layers%5B%22normalized%22%5D%20%3D%20csr_matrix(normalized)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Created%20'normalized'%20layer%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Updated%20layers%3A%20%7Blist(adata_metadata.layers.keys())%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn5.%20Layer%20operations%3A%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Dictionary-like%20interface%3A%20layers%5B'name'%5D%2C%20'name'%20in%20layers%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Lazy%20evaluation%3A%20layers%5B'name'%5D.compute()%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Immutability%3A%20Converted%20layers%20are%20protected%20from%20deletion%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Wide%20format%3A%20Stored%20in%20layers.lance%20table%20(one%20column%20per%20layer)%22)%0A%0A%20%20%20%20demonstrate_layers()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata_metadata)%3A%0A%20%20%20%20def%20demonstrate_metadata_views()%3A%0A%20%20%20%20%20%20%20%20print(%22%F0%9F%93%8A%20Working%20with%20Metadata%20Views%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Obs%20(cell%20metadata)%20-%20DataFrame-like%20interface%3A%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20columns%3A%20%7Blist(adata_metadata.obs.columns)%5B%3A5%5D%7D...%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Number%20of%20columns%3A%20%7Blen(adata_metadata.obs.columns)%7D%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20DataFrame-like%3A%20obs.columns%2C%20obs.head()%2C%20obs%5B'col'%5D%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Dict-like%3A%20'col'%20in%20obs%2C%20len(obs)%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Mutations%3A%20obs%5B'new_col'%5D%20%3D%20values%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Var%20(gene%20metadata)%20-%20DataFrame-like%20interface%3A%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20columns%3A%20%7Blist(adata_metadata.var.columns)%5B%3A5%5D%7D...%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Number%20of%20columns%3A%20%7Blen(adata_metadata.var.columns)%7D%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Same%20interface%20as%20obs%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Mutations%3A%20var%5B'new_col'%5D%20%3D%20values%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Obsm%20(cell%20embeddings)%20-%20Dictionary-like%20interface%3A%22)%0A%20%20%20%20%20%20%20%20obsm_keys%20%3D%20list(adata_metadata.obsm.keys())%0A%20%20%20%20%20%20%20%20if%20obsm_keys%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20keys%3A%20%7Bobsm_keys%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20key%20in%20obsm_keys%5B%3A2%5D%3A%20%20%23%20Show%20first%202%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arr%20%3D%20adata_metadata.obsm%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20-%20%7Bkey%7D%3A%20shape%20%7Barr.shape%7D%2C%20type%20%7Btype(arr)%7D%22)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%20%20%20No%20obsm%20keys%20found%20(can%20add%3A%20adata.obsm%5B'X_umap'%5D%20%3D%20coords)%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn4.%20Varm%20(gene%20embeddings)%20-%20Dictionary-like%20interface%3A%22)%0A%20%20%20%20%20%20%20%20varm_keys%20%3D%20list(adata_metadata.varm.keys())%0A%20%20%20%20%20%20%20%20if%20varm_keys%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20keys%3A%20%7Bvarm_keys%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20for%20key%20in%20varm_keys%5B%3A2%5D%3A%20%20%23%20Show%20first%202%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20arr%20%3D%20adata_metadata.varm%5Bkey%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20-%20%7Bkey%7D%3A%20shape%20%7Barr.shape%7D%2C%20type%20%7Btype(arr)%7D%22)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%20%20%20No%20varm%20keys%20found%20(can%20add%3A%20adata.varm%5B'PCs'%5D%20%3D%20loadings)%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn5.%20Uns%20(unstructured%20metadata)%20-%20Dictionary-like%20interface%3A%22)%0A%20%20%20%20%20%20%20%20uns_keys%20%3D%20list(adata_metadata.uns.keys())%0A%20%20%20%20%20%20%20%20if%20uns_keys%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20keys%3A%20%7Buns_keys%7D%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20print(f%22%20%20%20Example%3A%20%7Blist(uns_keys)%5B%3A3%5D%7D%22)%0A%20%20%20%20%20%20%20%20else%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20print(%22%20%20%20No%20uns%20keys%20found%20(can%20add%3A%20adata.uns%5B'analysis'%5D%20%3D%20%7B...%7D)%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn6.%20Key%20features%3A%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Lazy%20evaluation%3A%20Metadata%20accessed%20on-demand%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Immutability%3A%20Converted%20columns%2Fkeys%20are%20protected%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Subsetting%3A%20Views%20respect%20cell%2Fgene%20selectors%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20-%20Persistence%3A%20Changes%20are%20saved%20to%20Lance%20tables%22)%0A%0A%20%20%20%20demonstrate_metadata_views()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(adata_metadata%2C%20np)%3A%0A%20%20%20%20def%20demonstrate_metadata_mutations()%3A%0A%20%20%20%20%20%20%20%20print(%22%E2%9C%8F%EF%B8%8F%20Metadata%20Mutations%20Example%22)%0A%20%20%20%20%20%20%20%20print(%22%3D%22%20*%2035)%0A%0A%20%20%20%20%20%20%20%20print(%221.%20Create%20obs%20column%3A%22)%0A%20%20%20%20%20%20%20%20cluster_labels%20%3D%20np.random.choice(%5B%22A%22%2C%20%22B%22%2C%20%22C%22%5D%2C%20adata_metadata.n_obs)%0A%20%20%20%20%20%20%20%20adata_metadata.obs%5B%22clusters%22%5D%20%3D%20cluster_labels%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22%20%20%20%E2%9C%85%20Created%20'clusters'%20column%20with%20%7Blen(np.unique(cluster_labels))%7D%20unique%20values%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Column%20is%20immediately%20saved%20to%20cells.lance%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn2.%20Create%20var%20column%3A%22)%0A%20%20%20%20%20%20%20%20hvg_flags%20%3D%20np.random.choice(%5BTrue%2C%20False%5D%2C%20adata_metadata.n_vars%2C%20p%3D%5B0.3%2C%200.7%5D)%0A%20%20%20%20%20%20%20%20adata_metadata.var%5B%22is_hvg%22%5D%20%3D%20hvg_flags%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20f%22%20%20%20%E2%9C%85%20Created%20'is_hvg'%20column%3A%20%7Bhvg_flags.sum()%7D%20genes%20marked%20as%20highly%20variable%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Column%20is%20immediately%20saved%20to%20genes.lance%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn3.%20Store%20obsm%20(cell%20embeddings)%3A%22)%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20new%20embedding%20(different%20from%20existing%20X_umap)%0A%20%20%20%20%20%20%20%20new_embedding%20%3D%20np.random.randn(adata_metadata.n_obs%2C%203).astype(np.float32)%0A%20%20%20%20%20%20%20%20adata_metadata.obsm%5B%22X_custom%22%5D%20%3D%20new_embedding%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Created%20'X_custom'%20embedding%3A%20shape%20%7Bnew_embedding.shape%7D%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Stored%20as%20FixedSizeListArray%20in%20cells.lance%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20obsm%20keys%3A%20%7Blist(adata_metadata.obsm.keys())%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn4.%20Store%20varm%20(gene%20embeddings)%3A%22)%0A%20%20%20%20%20%20%20%20%23%20Create%20a%20new%20gene%20embedding%20(different%20from%20existing%20PCs)%0A%20%20%20%20%20%20%20%20new_loadings%20%3D%20np.random.randn(adata_metadata.n_vars%2C%2020).astype(np.float32)%0A%20%20%20%20%20%20%20%20adata_metadata.varm%5B%22custom_loadings%22%5D%20%3D%20new_loadings%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20%E2%9C%85%20Created%20'custom_loadings'%20embedding%3A%20shape%20%7Bnew_loadings.shape%7D%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Stored%20as%20FixedSizeListArray%20in%20genes.lance%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20varm%20keys%3A%20%7Blist(adata_metadata.varm.keys())%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn5.%20Store%20uns%20(unstructured%20metadata)%3A%22)%0A%20%20%20%20%20%20%20%20adata_metadata.uns%5B%22custom_analysis%22%5D%20%3D%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%22params%22%3A%20%7B%22n_neighbors%22%3A%2015%2C%20%22resolution%22%3A%200.5%7D%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20print(%22%20%20%20%E2%9C%85%20Created%20'custom_analysis'%20key%20in%20uns%22)%0A%20%20%20%20%20%20%20%20print(%22%20%20%20Stored%20in%20uns.json%20file%22)%0A%20%20%20%20%20%20%20%20print(f%22%20%20%20Available%20uns%20keys%3A%20%7Blist(adata_metadata.uns.keys())%7D%22)%0A%0A%20%20%20%20%20%20%20%20print(%22%5Cn6.%20Delete%20mutable%20columns%2Fkeys%3A%22)%0A%20%20%20%20%20%20%20%20%23%20Delete%20the%20columns%2Fkeys%20we%20just%20created%20(they're%20mutable)%0A%20%20%20%20%20%20%20%20del%20adata_metadata.obs%5B%22clusters%22%5D%0A%20%20%20%20%20%20%20%20print(%22%20%20%20%E2%9C%85%20Deleted%20'clusters'%20column%20(mutable)%22)%0A%20%20%20%20%20%20%20%20del%20adata_metadata.var%5B%22is_hvg%22%5D%0A%20%20%20%20%20%20%20%20print(%22%20%20%20%E2%9C%85%20Deleted%20'is_hvg'%20column%20(mutable)%22)%0A%20%20%20%20%20%20%20%20del%20adata_metadata.obsm%5B%22X_custom%22%5D%0A%20%20%20%20%20%20%20%20print(%22%20%20%20%E2%9C%85%20Deleted%20'X_custom'%20embedding%20(mutable)%22)%0A%20%20%20%20%20%20%20%20del%20adata_metadata.varm%5B%22custom_loadings%22%5D%0A%20%20%20%20%20%20%20%20print(%22%20%20%20%E2%9C%85%20Deleted%20'custom_loadings'%20embedding%20(mutable)%22)%0A%20%20%20%20%20%20%20%20del%20adata_metadata.uns%5B%22custom_analysis%22%5D%0A%20%20%20%20%20%20%20%20print(%22%20%20%20%E2%9C%85%20Deleted%20'custom_analysis'%20key%20from%20uns%22)%0A%20%20%20%20%20%20%20%20print(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%5Cn%20%20%20Note%3A%20Immutable%20columns%2Fkeys%20(converted%20from%20h5ad)%20cannot%20be%20deleted%22%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20demonstrate_metadata_mutations()%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_(mo)%3A%0A%20%20%20%20mo.md(%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%23%23%20Summary%0A%0A%20%20%20%20**What%20you've%20learned%20about%20SLAF's%20lazy%20processing%3A**%0A%0A%20%20%20%201.%20**Lazy%20Objects**%3A%20LazyAnnData%20and%20LazyExpressionMatrix%20store%20operations%2C%20not%20data%0A%20%20%20%202.%20**Explicit%20Control**%3A%20Use%20.compute()%20methods%20to%20control%20when%20data%20is%20processed%0A%20%20%20%203.%20**Slicing%20Patterns**%3A%20Multiple%20slicing%20patterns%2C%20all%20lazy%20and%20composable%0A%20%20%20%204.%20**Transformations**%3A%20Lazy%20transformations%20that%20are%20preserved%20through%20operations%0A%20%20%20%205.%20**Performance**%3A%20Build%20complex%20pipelines%20instantly%2C%20compute%20only%20when%20needed%0A%20%20%20%206.%20**Memory%20Efficiency**%3A%20Significant%20memory%20savings%20compared%20to%20eager%20loading%0A%20%20%20%207.%20**Best%20Practices**%3A%20Guidelines%20for%20optimal%20lazy%20evaluation%20usage%0A%20%20%20%208.%20**Layers**%3A%20Alternative%20expression%20matrices%20stored%20in%20layers.lance%20(wide%20format)%0A%20%20%20%209.%20**Metadata%20Views**%3A%20Full%20support%20for%20obs%2C%20var%2C%20obsm%2C%20varm%2C%20and%20uns%20with%20lazy%20evaluation%0A%0A%20%20%20%20**Next%20Steps%3A**%0A%20%20%20%20-%20**03-ml-training-pipeline.py**%3A%20Complete%20ML%20training%20workflows%20with%20tokenizers%20and%20dataloaders%0A%20%20%20%20%22%22%22%0A%20%20%20%20)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A
</marimo-code>

<marimo-code-hash hidden="">09ccbb5e44f7fc0ea5b41c383d0b503b14085a7dbf2d8af4ce9c5f3d4df31c0a</marimo-code-hash>
</body>
</html>
