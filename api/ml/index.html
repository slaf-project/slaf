<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Sparse Lazy Array Format - High-performance single-cell data storage and analysis"><meta name=author content="Pavan Ramkumar"><link href=https://slaf-project.github.io/slaf/api/ml/ rel=canonical><link href=../integrations/ rel=prev><link href=../../development/contributing/ rel=next><link rel=icon href=../../assets/slaf-icon-transparent-dark-mono.svg><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>ML - SLAF Documentation</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../stylesheets/extra.css><link rel=stylesheet href=../../stylesheets/logo-theme.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#machine-learning-api class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="SLAF Documentation" class="md-header__button md-logo" aria-label="SLAF Documentation" data-md-component=logo> <img src=../../assets/slaf-icon-transparent-dark-mono.svg alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> SLAF Documentation </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> ML </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/slaf-project/slaf title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> slaf-project/slaf </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="SLAF Documentation" class="md-nav__button md-logo" aria-label="SLAF Documentation" data-md-component=logo> <img src=../../assets/slaf-icon-transparent-dark-mono.svg alt=logo> </a> SLAF Documentation </label> <div class=md-nav__source> <a href=https://github.com/slaf-project/slaf title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> slaf-project/slaf </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../getting-started/quickstart/ class=md-nav__link> <span class=md-ellipsis> Quick Start </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> User Guide </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../user-guide/how-slaf-works/ class=md-nav__link> <span class=md-ellipsis> How SLAF Works </span> </a> </li> <li class=md-nav__item> <a href=../../user-guide/migrating-to-slaf/ class=md-nav__link> <span class=md-ellipsis> Migrating to SLAF </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Examples </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Examples </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../examples/getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> </a> </li> <li class=md-nav__item> <a href=../../examples/lazy-processing/ class=md-nav__link> <span class=md-ellipsis> Lazy Processing </span> </a> </li> <li class=md-nav__item> <a href=../../examples/ml-training/ class=md-nav__link> <span class=md-ellipsis> ML Training </span> </a> </li> <li class=md-nav__item> <a href=../../examples/sql-queries/ class=md-nav__link> <span class=md-ellipsis> SQL Queries </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Benchmarks </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Benchmarks </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../benchmarks/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../benchmarks/bioinformatics_benchmarks/ class=md-nav__link> <span class=md-ellipsis> For Bioinformaticians </span> </a> </li> <li class=md-nav__item> <a href=../../benchmarks/ml_benchmarks/ class=md-nav__link> <span class=md-ellipsis> For ML Engineers </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6 checked> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> API Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=true> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> API Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../core/ class=md-nav__link> <span class=md-ellipsis> Core </span> </a> </li> <li class=md-nav__item> <a href=../data/ class=md-nav__link> <span class=md-ellipsis> Data </span> </a> </li> <li class=md-nav__item> <a href=../integrations/ class=md-nav__link> <span class=md-ellipsis> Integrations </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> ML </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> ML </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#dataloaders class=md-nav__link> <span class=md-ellipsis> DataLoaders </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.dataloaders class=md-nav__link> <span class=md-ellipsis> dataloaders </span> </a> <nav class=md-nav aria-label=dataloaders> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders-classes class=md-nav__link> <span class=md-ellipsis> Classes </span> </a> <nav class=md-nav aria-label=Classes> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.SLAFDataLoader class=md-nav__link> <span class=md-ellipsis> SLAFDataLoader </span> </a> <nav class=md-nav aria-label=SLAFDataLoader> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.SLAFDataLoader-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.SLAFDataLoader.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.dataloaders-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.get_optimal_device class=md-nav__link> <span class=md-ellipsis> get_optimal_device </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.get_device_info class=md-nav__link> <span class=md-ellipsis> get_device_info </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders class=md-nav__link> <span class=md-ellipsis> tiledb_dataloaders </span> </a> <nav class=md-nav aria-label=tiledb_dataloaders> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders-classes class=md-nav__link> <span class=md-ellipsis> Classes </span> </a> <nav class=md-nav aria-label=Classes> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch class=md-nav__link> <span class=md-ellipsis> TileDBPrefetchBatch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor class=md-nav__link> <span class=md-ellipsis> TileDBBatchProcessor </span> </a> <nav class=md-nav aria-label=TileDBBatchProcessor> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.reset_for_epoch class=md-nav__link> <span class=md-ellipsis> reset_for_epoch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.load_prefetch_batch class=md-nav__link> <span class=md-ellipsis> load_prefetch_batch </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher class=md-nav__link> <span class=md-ellipsis> TileDBAsyncPrefetcher </span> </a> <nav class=md-nav aria-label=TileDBAsyncPrefetcher> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.start class=md-nav__link> <span class=md-ellipsis> start </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.stop class=md-nav__link> <span class=md-ellipsis> stop </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_batch class=md-nav__link> <span class=md-ellipsis> get_batch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.has_batch class=md-nav__link> <span class=md-ellipsis> has_batch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_stats class=md-nav__link> <span class=md-ellipsis> get_stats </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset class=md-nav__link> <span class=md-ellipsis> TileDBIterableDataset </span> </a> <nav class=md-nav aria-label=TileDBIterableDataset> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader class=md-nav__link> <span class=md-ellipsis> TileDBDataLoader </span> </a> <nav class=md-nav aria-label=TileDBDataLoader> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.print_prefetch class=md-nav__link> <span class=md-ellipsis> print_prefetch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.print_training class=md-nav__link> <span class=md-ellipsis> print_training </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#tokenizers class=md-nav__link> <span class=md-ellipsis> Tokenizers </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers class=md-nav__link> <span class=md-ellipsis> tokenizers </span> </a> <nav class=md-nav aria-label=tokenizers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers-classes class=md-nav__link> <span class=md-ellipsis> Classes </span> </a> <nav class=md-nav aria-label=Classes> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.TokenizerType class=md-nav__link> <span class=md-ellipsis> TokenizerType </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer class=md-nav__link> <span class=md-ellipsis> SLAFTokenizer </span> </a> <nav class=md-nav aria-label=SLAFTokenizer> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.tokenize class=md-nav__link> <span class=md-ellipsis> tokenize </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.get_vocab_info class=md-nav__link> <span class=md-ellipsis> get_vocab_info </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.decode_tokens class=md-nav__link> <span class=md-ellipsis> decode_tokens </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/contributing/ class=md-nav__link> <span class=md-ellipsis> For Contributors </span> </a> </li> <li class=md-nav__item> <a href=../../development/maintaining/ class=md-nav__link> <span class=md-ellipsis> For Maintainers </span> </a> </li> <li class=md-nav__item> <a href=../../development/benchmarks/ class=md-nav__link> <span class=md-ellipsis> Benchmarks </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex> <span class=md-ellipsis> Blog </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../blog/ class=md-nav__link> <span class=md-ellipsis> Blog Home </span> </a> </li> <li class=md-nav__item> <a href=../../blog/huggingface/ class=md-nav__link> <span class=md-ellipsis> SLAF on Hugging Face </span> </a> </li> <li class=md-nav__item> <a href=../../blog/introducing-slaf/ class=md-nav__link> <span class=md-ellipsis> Introducing SLAF </span> </a> </li> <li class=md-nav__item> <a href=../../blog/blazing-fast-dataloaders/ class=md-nav__link> <span class=md-ellipsis> Blazing Fast Dataloaders </span> </a> </li> <li class=md-nav__item> <a href=../../blog/blazing-fast-dataloaders-2/ class=md-nav__link> <span class=md-ellipsis> Mixture of Scanners </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#dataloaders class=md-nav__link> <span class=md-ellipsis> DataLoaders </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.dataloaders class=md-nav__link> <span class=md-ellipsis> dataloaders </span> </a> <nav class=md-nav aria-label=dataloaders> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders-classes class=md-nav__link> <span class=md-ellipsis> Classes </span> </a> <nav class=md-nav aria-label=Classes> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.SLAFDataLoader class=md-nav__link> <span class=md-ellipsis> SLAFDataLoader </span> </a> <nav class=md-nav aria-label=SLAFDataLoader> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.SLAFDataLoader-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.SLAFDataLoader.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.dataloaders-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.get_optimal_device class=md-nav__link> <span class=md-ellipsis> get_optimal_device </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.dataloaders.get_device_info class=md-nav__link> <span class=md-ellipsis> get_device_info </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders class=md-nav__link> <span class=md-ellipsis> tiledb_dataloaders </span> </a> <nav class=md-nav aria-label=tiledb_dataloaders> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders-classes class=md-nav__link> <span class=md-ellipsis> Classes </span> </a> <nav class=md-nav aria-label=Classes> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch class=md-nav__link> <span class=md-ellipsis> TileDBPrefetchBatch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor class=md-nav__link> <span class=md-ellipsis> TileDBBatchProcessor </span> </a> <nav class=md-nav aria-label=TileDBBatchProcessor> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.reset_for_epoch class=md-nav__link> <span class=md-ellipsis> reset_for_epoch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.load_prefetch_batch class=md-nav__link> <span class=md-ellipsis> load_prefetch_batch </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher class=md-nav__link> <span class=md-ellipsis> TileDBAsyncPrefetcher </span> </a> <nav class=md-nav aria-label=TileDBAsyncPrefetcher> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.start class=md-nav__link> <span class=md-ellipsis> start </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.stop class=md-nav__link> <span class=md-ellipsis> stop </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_batch class=md-nav__link> <span class=md-ellipsis> get_batch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.has_batch class=md-nav__link> <span class=md-ellipsis> has_batch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_stats class=md-nav__link> <span class=md-ellipsis> get_stats </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset class=md-nav__link> <span class=md-ellipsis> TileDBIterableDataset </span> </a> <nav class=md-nav aria-label=TileDBIterableDataset> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader class=md-nav__link> <span class=md-ellipsis> TileDBDataLoader </span> </a> <nav class=md-nav aria-label=TileDBDataLoader> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.print_prefetch class=md-nav__link> <span class=md-ellipsis> print_prefetch </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tiledb_dataloaders.print_training class=md-nav__link> <span class=md-ellipsis> print_training </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#tokenizers class=md-nav__link> <span class=md-ellipsis> Tokenizers </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers class=md-nav__link> <span class=md-ellipsis> tokenizers </span> </a> <nav class=md-nav aria-label=tokenizers> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers-classes class=md-nav__link> <span class=md-ellipsis> Classes </span> </a> <nav class=md-nav aria-label=Classes> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.TokenizerType class=md-nav__link> <span class=md-ellipsis> TokenizerType </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer class=md-nav__link> <span class=md-ellipsis> SLAFTokenizer </span> </a> <nav class=md-nav aria-label=SLAFTokenizer> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer-functions class=md-nav__link> <span class=md-ellipsis> Functions </span> </a> <nav class=md-nav aria-label=Functions> <ul class=md-nav__list> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.tokenize class=md-nav__link> <span class=md-ellipsis> tokenize </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.get_vocab_info class=md-nav__link> <span class=md-ellipsis> get_vocab_info </span> </a> </li> <li class=md-nav__item> <a href=#slaf.ml.tokenizers.SLAFTokenizer.decode_tokens class=md-nav__link> <span class=md-ellipsis> decode_tokens </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=machine-learning-api>Machine Learning API<a class=headerlink href=#machine-learning-api title="Permanent link">&para;</a></h1> <p>ML utilities including dataloaders and tokenizers.</p> <h2 id=dataloaders>DataLoaders<a class=headerlink href=#dataloaders title="Permanent link">&para;</a></h2> <div class="doc doc-object doc-module"> <h2 id=slaf.ml.dataloaders class="doc doc-heading"> <code>slaf.ml.dataloaders</code> <a href=#slaf.ml.dataloaders class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents first"> <div class="doc doc-children"> <h3 id=slaf.ml.dataloaders-classes>Classes<a href=#slaf.ml.dataloaders-classes class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.dataloaders.SLAFDataLoader class="doc doc-heading"> <code>SLAFDataLoader</code> <a href=#slaf.ml.dataloaders.SLAFDataLoader class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>High-performance DataLoader for SLAF data optimized for ML training.</p> <p>SLAFDataLoader provides efficient streaming of single-cell data for machine learning applications with multiple loading strategies for different use cases. It uses async batch processing and provides device-agnostic CPU tensor output for maximum training flexibility.</p> <details class=key-features open> <summary>Key Features</summary> <ul> <li>Multiple tokenization strategies (GeneFormer, scGPT)</li> <li>Multiple loading modes for different entropy requirements:<ul> <li>Mixture of Scanners (MoS): Maximum entropy, best randomization (default)</li> <li>Fragment-based loading: Higher entropy, moderate performance</li> <li>Sequential loading: Fastest, lowest entropy</li> </ul> </li> <li>Pre-tokenized sequences for maximum performance (tokenized mode)</li> <li>Raw data output for external processing (raw mode)</li> <li>Device-agnostic CPU tensor output</li> <li>Async batch processing with background prefetching</li> <li>Memory-efficient streaming</li> <li>Multi-epoch training support</li> <li>Comprehensive error handling and validation</li> </ul> </details> <details class=loading-modes open> <summary>Loading Modes</summary> <ol> <li>Mixture of Scanners (default): Randomly samples from multiple fragment generators for maximum entropy and randomization (88% of random entropy)</li> <li>Fragment-based: Loads complete Lance fragments for higher data entropy</li> <li>Sequential: Loads contiguous Lance batches for maximum throughput</li> </ol> </details> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic usage with default settings (MoS loading)</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>SLAFArray</span><span class=p>(</span><span class=s2>&quot;path/to/data.slaf&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>dataloader</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch shape: </span><span class=si>{</span><span class=n>batch</span><span class=p>[</span><span class=s1>&#39;input_ids&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cell IDs: </span><span class=si>{</span><span class=n>batch</span><span class=p>[</span><span class=s1>&#39;cell_ids&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=k>break</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Batch shape: torch.Size([32, 2048])</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>Cell IDs: tensor([0, 1, 2, ..., 29, 30, 31])</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=go>MoS enabled: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>by_fragment</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sequential loading: </span><span class=si>{</span><span class=ow>not</span><span class=w> </span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Sequential loading: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Fragment-based loading for higher entropy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>by_fragment</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Fragment-based loading: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>by_fragment</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Fragment-based loading: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Raw mode for external processing</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>raw_mode</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>dataloader</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Raw data type: </span><span class=si>{</span><span class=nb>type</span><span class=p>(</span><span class=n>batch</span><span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>])</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>    <span class=k>break</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>Raw data type: &lt;class &#39;polars.dataframe.frame.DataFrame&#39;&gt;</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Multi-epoch training</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_epochs</span><span class=o>=</span><span class=mi>5</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Number of epochs: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>n_epochs</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Number of epochs: 5</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Custom configuration for training</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;scgpt&quot;</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span><span class=p>,</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>max_genes</span><span class=o>=</span><span class=mi>1024</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Tokenizer type: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>tokenizer_type</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>Tokenizer type: scgpt</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Training loop example</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>batch_idx</span><span class=p>,</span> <span class=n>batch</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>dataloader</span><span class=p>):</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>input_ids</span> <span class=o>=</span> <span class=n>batch</span><span class=p>[</span><span class=s2>&quot;input_ids&quot;</span><span class=p>]</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>batch</span><span class=p>[</span><span class=s2>&quot;attention_mask&quot;</span><span class=p>]</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>cell_ids</span> <span class=o>=</span> <span class=n>batch</span><span class=p>[</span><span class=s2>&quot;cell_ids&quot;</span><span class=p>]</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=c1># Your training code here</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>batch_idx</span> <span class=o>&gt;=</span> <span class=mi>2</span><span class=p>:</span>  <span class=c1># Just test first few batches</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>        <span class=k>break</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Training loop completed&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=go>Training loop completed</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Error handling for invalid tokenizer type</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;invalid&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span><span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Error: Unsupported tokenizer type: invalid</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-159>159</a></span>
<span class=normal><a href=#__codelineno-0-160>160</a></span>
<span class=normal><a href=#__codelineno-0-161>161</a></span>
<span class=normal><a href=#__codelineno-0-162>162</a></span>
<span class=normal><a href=#__codelineno-0-163>163</a></span>
<span class=normal><a href=#__codelineno-0-164>164</a></span>
<span class=normal><a href=#__codelineno-0-165>165</a></span>
<span class=normal><a href=#__codelineno-0-166>166</a></span>
<span class=normal><a href=#__codelineno-0-167>167</a></span>
<span class=normal><a href=#__codelineno-0-168>168</a></span>
<span class=normal><a href=#__codelineno-0-169>169</a></span>
<span class=normal><a href=#__codelineno-0-170>170</a></span>
<span class=normal><a href=#__codelineno-0-171>171</a></span>
<span class=normal><a href=#__codelineno-0-172>172</a></span>
<span class=normal><a href=#__codelineno-0-173>173</a></span>
<span class=normal><a href=#__codelineno-0-174>174</a></span>
<span class=normal><a href=#__codelineno-0-175>175</a></span>
<span class=normal><a href=#__codelineno-0-176>176</a></span>
<span class=normal><a href=#__codelineno-0-177>177</a></span>
<span class=normal><a href=#__codelineno-0-178>178</a></span>
<span class=normal><a href=#__codelineno-0-179>179</a></span>
<span class=normal><a href=#__codelineno-0-180>180</a></span>
<span class=normal><a href=#__codelineno-0-181>181</a></span>
<span class=normal><a href=#__codelineno-0-182>182</a></span>
<span class=normal><a href=#__codelineno-0-183>183</a></span>
<span class=normal><a href=#__codelineno-0-184>184</a></span>
<span class=normal><a href=#__codelineno-0-185>185</a></span>
<span class=normal><a href=#__codelineno-0-186>186</a></span>
<span class=normal><a href=#__codelineno-0-187>187</a></span>
<span class=normal><a href=#__codelineno-0-188>188</a></span>
<span class=normal><a href=#__codelineno-0-189>189</a></span>
<span class=normal><a href=#__codelineno-0-190>190</a></span>
<span class=normal><a href=#__codelineno-0-191>191</a></span>
<span class=normal><a href=#__codelineno-0-192>192</a></span>
<span class=normal><a href=#__codelineno-0-193>193</a></span>
<span class=normal><a href=#__codelineno-0-194>194</a></span>
<span class=normal><a href=#__codelineno-0-195>195</a></span>
<span class=normal><a href=#__codelineno-0-196>196</a></span>
<span class=normal><a href=#__codelineno-0-197>197</a></span>
<span class=normal><a href=#__codelineno-0-198>198</a></span>
<span class=normal><a href=#__codelineno-0-199>199</a></span>
<span class=normal><a href=#__codelineno-0-200>200</a></span>
<span class=normal><a href=#__codelineno-0-201>201</a></span>
<span class=normal><a href=#__codelineno-0-202>202</a></span>
<span class=normal><a href=#__codelineno-0-203>203</a></span>
<span class=normal><a href=#__codelineno-0-204>204</a></span>
<span class=normal><a href=#__codelineno-0-205>205</a></span>
<span class=normal><a href=#__codelineno-0-206>206</a></span>
<span class=normal><a href=#__codelineno-0-207>207</a></span>
<span class=normal><a href=#__codelineno-0-208>208</a></span>
<span class=normal><a href=#__codelineno-0-209>209</a></span>
<span class=normal><a href=#__codelineno-0-210>210</a></span>
<span class=normal><a href=#__codelineno-0-211>211</a></span>
<span class=normal><a href=#__codelineno-0-212>212</a></span>
<span class=normal><a href=#__codelineno-0-213>213</a></span>
<span class=normal><a href=#__codelineno-0-214>214</a></span>
<span class=normal><a href=#__codelineno-0-215>215</a></span>
<span class=normal><a href=#__codelineno-0-216>216</a></span>
<span class=normal><a href=#__codelineno-0-217>217</a></span>
<span class=normal><a href=#__codelineno-0-218>218</a></span>
<span class=normal><a href=#__codelineno-0-219>219</a></span>
<span class=normal><a href=#__codelineno-0-220>220</a></span>
<span class=normal><a href=#__codelineno-0-221>221</a></span>
<span class=normal><a href=#__codelineno-0-222>222</a></span>
<span class=normal><a href=#__codelineno-0-223>223</a></span>
<span class=normal><a href=#__codelineno-0-224>224</a></span>
<span class=normal><a href=#__codelineno-0-225>225</a></span>
<span class=normal><a href=#__codelineno-0-226>226</a></span>
<span class=normal><a href=#__codelineno-0-227>227</a></span>
<span class=normal><a href=#__codelineno-0-228>228</a></span>
<span class=normal><a href=#__codelineno-0-229>229</a></span>
<span class=normal><a href=#__codelineno-0-230>230</a></span>
<span class=normal><a href=#__codelineno-0-231>231</a></span>
<span class=normal><a href=#__codelineno-0-232>232</a></span>
<span class=normal><a href=#__codelineno-0-233>233</a></span>
<span class=normal><a href=#__codelineno-0-234>234</a></span>
<span class=normal><a href=#__codelineno-0-235>235</a></span>
<span class=normal><a href=#__codelineno-0-236>236</a></span>
<span class=normal><a href=#__codelineno-0-237>237</a></span>
<span class=normal><a href=#__codelineno-0-238>238</a></span>
<span class=normal><a href=#__codelineno-0-239>239</a></span>
<span class=normal><a href=#__codelineno-0-240>240</a></span>
<span class=normal><a href=#__codelineno-0-241>241</a></span>
<span class=normal><a href=#__codelineno-0-242>242</a></span>
<span class=normal><a href=#__codelineno-0-243>243</a></span>
<span class=normal><a href=#__codelineno-0-244>244</a></span>
<span class=normal><a href=#__codelineno-0-245>245</a></span>
<span class=normal><a href=#__codelineno-0-246>246</a></span>
<span class=normal><a href=#__codelineno-0-247>247</a></span>
<span class=normal><a href=#__codelineno-0-248>248</a></span>
<span class=normal><a href=#__codelineno-0-249>249</a></span>
<span class=normal><a href=#__codelineno-0-250>250</a></span>
<span class=normal><a href=#__codelineno-0-251>251</a></span>
<span class=normal><a href=#__codelineno-0-252>252</a></span>
<span class=normal><a href=#__codelineno-0-253>253</a></span>
<span class=normal><a href=#__codelineno-0-254>254</a></span>
<span class=normal><a href=#__codelineno-0-255>255</a></span>
<span class=normal><a href=#__codelineno-0-256>256</a></span>
<span class=normal><a href=#__codelineno-0-257>257</a></span>
<span class=normal><a href=#__codelineno-0-258>258</a></span>
<span class=normal><a href=#__codelineno-0-259>259</a></span>
<span class=normal><a href=#__codelineno-0-260>260</a></span>
<span class=normal><a href=#__codelineno-0-261>261</a></span>
<span class=normal><a href=#__codelineno-0-262>262</a></span>
<span class=normal><a href=#__codelineno-0-263>263</a></span>
<span class=normal><a href=#__codelineno-0-264>264</a></span>
<span class=normal><a href=#__codelineno-0-265>265</a></span>
<span class=normal><a href=#__codelineno-0-266>266</a></span>
<span class=normal><a href=#__codelineno-0-267>267</a></span>
<span class=normal><a href=#__codelineno-0-268>268</a></span>
<span class=normal><a href=#__codelineno-0-269>269</a></span>
<span class=normal><a href=#__codelineno-0-270>270</a></span>
<span class=normal><a href=#__codelineno-0-271>271</a></span>
<span class=normal><a href=#__codelineno-0-272>272</a></span>
<span class=normal><a href=#__codelineno-0-273>273</a></span>
<span class=normal><a href=#__codelineno-0-274>274</a></span>
<span class=normal><a href=#__codelineno-0-275>275</a></span>
<span class=normal><a href=#__codelineno-0-276>276</a></span>
<span class=normal><a href=#__codelineno-0-277>277</a></span>
<span class=normal><a href=#__codelineno-0-278>278</a></span>
<span class=normal><a href=#__codelineno-0-279>279</a></span>
<span class=normal><a href=#__codelineno-0-280>280</a></span>
<span class=normal><a href=#__codelineno-0-281>281</a></span>
<span class=normal><a href=#__codelineno-0-282>282</a></span>
<span class=normal><a href=#__codelineno-0-283>283</a></span>
<span class=normal><a href=#__codelineno-0-284>284</a></span>
<span class=normal><a href=#__codelineno-0-285>285</a></span>
<span class=normal><a href=#__codelineno-0-286>286</a></span>
<span class=normal><a href=#__codelineno-0-287>287</a></span>
<span class=normal><a href=#__codelineno-0-288>288</a></span>
<span class=normal><a href=#__codelineno-0-289>289</a></span>
<span class=normal><a href=#__codelineno-0-290>290</a></span>
<span class=normal><a href=#__codelineno-0-291>291</a></span>
<span class=normal><a href=#__codelineno-0-292>292</a></span>
<span class=normal><a href=#__codelineno-0-293>293</a></span>
<span class=normal><a href=#__codelineno-0-294>294</a></span>
<span class=normal><a href=#__codelineno-0-295>295</a></span>
<span class=normal><a href=#__codelineno-0-296>296</a></span>
<span class=normal><a href=#__codelineno-0-297>297</a></span>
<span class=normal><a href=#__codelineno-0-298>298</a></span>
<span class=normal><a href=#__codelineno-0-299>299</a></span>
<span class=normal><a href=#__codelineno-0-300>300</a></span>
<span class=normal><a href=#__codelineno-0-301>301</a></span>
<span class=normal><a href=#__codelineno-0-302>302</a></span>
<span class=normal><a href=#__codelineno-0-303>303</a></span>
<span class=normal><a href=#__codelineno-0-304>304</a></span>
<span class=normal><a href=#__codelineno-0-305>305</a></span>
<span class=normal><a href=#__codelineno-0-306>306</a></span>
<span class=normal><a href=#__codelineno-0-307>307</a></span>
<span class=normal><a href=#__codelineno-0-308>308</a></span>
<span class=normal><a href=#__codelineno-0-309>309</a></span>
<span class=normal><a href=#__codelineno-0-310>310</a></span>
<span class=normal><a href=#__codelineno-0-311>311</a></span>
<span class=normal><a href=#__codelineno-0-312>312</a></span>
<span class=normal><a href=#__codelineno-0-313>313</a></span>
<span class=normal><a href=#__codelineno-0-314>314</a></span>
<span class=normal><a href=#__codelineno-0-315>315</a></span>
<span class=normal><a href=#__codelineno-0-316>316</a></span>
<span class=normal><a href=#__codelineno-0-317>317</a></span>
<span class=normal><a href=#__codelineno-0-318>318</a></span>
<span class=normal><a href=#__codelineno-0-319>319</a></span>
<span class=normal><a href=#__codelineno-0-320>320</a></span>
<span class=normal><a href=#__codelineno-0-321>321</a></span>
<span class=normal><a href=#__codelineno-0-322>322</a></span>
<span class=normal><a href=#__codelineno-0-323>323</a></span>
<span class=normal><a href=#__codelineno-0-324>324</a></span>
<span class=normal><a href=#__codelineno-0-325>325</a></span>
<span class=normal><a href=#__codelineno-0-326>326</a></span>
<span class=normal><a href=#__codelineno-0-327>327</a></span>
<span class=normal><a href=#__codelineno-0-328>328</a></span>
<span class=normal><a href=#__codelineno-0-329>329</a></span>
<span class=normal><a href=#__codelineno-0-330>330</a></span>
<span class=normal><a href=#__codelineno-0-331>331</a></span>
<span class=normal><a href=#__codelineno-0-332>332</a></span>
<span class=normal><a href=#__codelineno-0-333>333</a></span>
<span class=normal><a href=#__codelineno-0-334>334</a></span>
<span class=normal><a href=#__codelineno-0-335>335</a></span>
<span class=normal><a href=#__codelineno-0-336>336</a></span>
<span class=normal><a href=#__codelineno-0-337>337</a></span>
<span class=normal><a href=#__codelineno-0-338>338</a></span>
<span class=normal><a href=#__codelineno-0-339>339</a></span>
<span class=normal><a href=#__codelineno-0-340>340</a></span>
<span class=normal><a href=#__codelineno-0-341>341</a></span>
<span class=normal><a href=#__codelineno-0-342>342</a></span>
<span class=normal><a href=#__codelineno-0-343>343</a></span>
<span class=normal><a href=#__codelineno-0-344>344</a></span>
<span class=normal><a href=#__codelineno-0-345>345</a></span>
<span class=normal><a href=#__codelineno-0-346>346</a></span>
<span class=normal><a href=#__codelineno-0-347>347</a></span>
<span class=normal><a href=#__codelineno-0-348>348</a></span>
<span class=normal><a href=#__codelineno-0-349>349</a></span>
<span class=normal><a href=#__codelineno-0-350>350</a></span>
<span class=normal><a href=#__codelineno-0-351>351</a></span>
<span class=normal><a href=#__codelineno-0-352>352</a></span>
<span class=normal><a href=#__codelineno-0-353>353</a></span>
<span class=normal><a href=#__codelineno-0-354>354</a></span>
<span class=normal><a href=#__codelineno-0-355>355</a></span>
<span class=normal><a href=#__codelineno-0-356>356</a></span>
<span class=normal><a href=#__codelineno-0-357>357</a></span>
<span class=normal><a href=#__codelineno-0-358>358</a></span>
<span class=normal><a href=#__codelineno-0-359>359</a></span>
<span class=normal><a href=#__codelineno-0-360>360</a></span>
<span class=normal><a href=#__codelineno-0-361>361</a></span>
<span class=normal><a href=#__codelineno-0-362>362</a></span>
<span class=normal><a href=#__codelineno-0-363>363</a></span>
<span class=normal><a href=#__codelineno-0-364>364</a></span>
<span class=normal><a href=#__codelineno-0-365>365</a></span>
<span class=normal><a href=#__codelineno-0-366>366</a></span>
<span class=normal><a href=#__codelineno-0-367>367</a></span>
<span class=normal><a href=#__codelineno-0-368>368</a></span>
<span class=normal><a href=#__codelineno-0-369>369</a></span>
<span class=normal><a href=#__codelineno-0-370>370</a></span>
<span class=normal><a href=#__codelineno-0-371>371</a></span>
<span class=normal><a href=#__codelineno-0-372>372</a></span>
<span class=normal><a href=#__codelineno-0-373>373</a></span>
<span class=normal><a href=#__codelineno-0-374>374</a></span>
<span class=normal><a href=#__codelineno-0-375>375</a></span>
<span class=normal><a href=#__codelineno-0-376>376</a></span>
<span class=normal><a href=#__codelineno-0-377>377</a></span>
<span class=normal><a href=#__codelineno-0-378>378</a></span>
<span class=normal><a href=#__codelineno-0-379>379</a></span>
<span class=normal><a href=#__codelineno-0-380>380</a></span>
<span class=normal><a href=#__codelineno-0-381>381</a></span>
<span class=normal><a href=#__codelineno-0-382>382</a></span>
<span class=normal><a href=#__codelineno-0-383>383</a></span>
<span class=normal><a href=#__codelineno-0-384>384</a></span>
<span class=normal><a href=#__codelineno-0-385>385</a></span>
<span class=normal><a href=#__codelineno-0-386>386</a></span>
<span class=normal><a href=#__codelineno-0-387>387</a></span>
<span class=normal><a href=#__codelineno-0-388>388</a></span>
<span class=normal><a href=#__codelineno-0-389>389</a></span>
<span class=normal><a href=#__codelineno-0-390>390</a></span>
<span class=normal><a href=#__codelineno-0-391>391</a></span>
<span class=normal><a href=#__codelineno-0-392>392</a></span>
<span class=normal><a href=#__codelineno-0-393>393</a></span>
<span class=normal><a href=#__codelineno-0-394>394</a></span>
<span class=normal><a href=#__codelineno-0-395>395</a></span>
<span class=normal><a href=#__codelineno-0-396>396</a></span>
<span class=normal><a href=#__codelineno-0-397>397</a></span>
<span class=normal><a href=#__codelineno-0-398>398</a></span>
<span class=normal><a href=#__codelineno-0-399>399</a></span>
<span class=normal><a href=#__codelineno-0-400>400</a></span>
<span class=normal><a href=#__codelineno-0-401>401</a></span>
<span class=normal><a href=#__codelineno-0-402>402</a></span>
<span class=normal><a href=#__codelineno-0-403>403</a></span>
<span class=normal><a href=#__codelineno-0-404>404</a></span>
<span class=normal><a href=#__codelineno-0-405>405</a></span>
<span class=normal><a href=#__codelineno-0-406>406</a></span>
<span class=normal><a href=#__codelineno-0-407>407</a></span>
<span class=normal><a href=#__codelineno-0-408>408</a></span>
<span class=normal><a href=#__codelineno-0-409>409</a></span>
<span class=normal><a href=#__codelineno-0-410>410</a></span>
<span class=normal><a href=#__codelineno-0-411>411</a></span>
<span class=normal><a href=#__codelineno-0-412>412</a></span>
<span class=normal><a href=#__codelineno-0-413>413</a></span>
<span class=normal><a href=#__codelineno-0-414>414</a></span>
<span class=normal><a href=#__codelineno-0-415>415</a></span>
<span class=normal><a href=#__codelineno-0-416>416</a></span>
<span class=normal><a href=#__codelineno-0-417>417</a></span>
<span class=normal><a href=#__codelineno-0-418>418</a></span>
<span class=normal><a href=#__codelineno-0-419>419</a></span>
<span class=normal><a href=#__codelineno-0-420>420</a></span>
<span class=normal><a href=#__codelineno-0-421>421</a></span>
<span class=normal><a href=#__codelineno-0-422>422</a></span>
<span class=normal><a href=#__codelineno-0-423>423</a></span>
<span class=normal><a href=#__codelineno-0-424>424</a></span>
<span class=normal><a href=#__codelineno-0-425>425</a></span>
<span class=normal><a href=#__codelineno-0-426>426</a></span>
<span class=normal><a href=#__codelineno-0-427>427</a></span>
<span class=normal><a href=#__codelineno-0-428>428</a></span>
<span class=normal><a href=#__codelineno-0-429>429</a></span>
<span class=normal><a href=#__codelineno-0-430>430</a></span>
<span class=normal><a href=#__codelineno-0-431>431</a></span>
<span class=normal><a href=#__codelineno-0-432>432</a></span>
<span class=normal><a href=#__codelineno-0-433>433</a></span>
<span class=normal><a href=#__codelineno-0-434>434</a></span>
<span class=normal><a href=#__codelineno-0-435>435</a></span>
<span class=normal><a href=#__codelineno-0-436>436</a></span>
<span class=normal><a href=#__codelineno-0-437>437</a></span>
<span class=normal><a href=#__codelineno-0-438>438</a></span>
<span class=normal><a href=#__codelineno-0-439>439</a></span>
<span class=normal><a href=#__codelineno-0-440>440</a></span>
<span class=normal><a href=#__codelineno-0-441>441</a></span>
<span class=normal><a href=#__codelineno-0-442>442</a></span>
<span class=normal><a href=#__codelineno-0-443>443</a></span>
<span class=normal><a href=#__codelineno-0-444>444</a></span>
<span class=normal><a href=#__codelineno-0-445>445</a></span>
<span class=normal><a href=#__codelineno-0-446>446</a></span>
<span class=normal><a href=#__codelineno-0-447>447</a></span>
<span class=normal><a href=#__codelineno-0-448>448</a></span>
<span class=normal><a href=#__codelineno-0-449>449</a></span>
<span class=normal><a href=#__codelineno-0-450>450</a></span>
<span class=normal><a href=#__codelineno-0-451>451</a></span>
<span class=normal><a href=#__codelineno-0-452>452</a></span>
<span class=normal><a href=#__codelineno-0-453>453</a></span>
<span class=normal><a href=#__codelineno-0-454>454</a></span>
<span class=normal><a href=#__codelineno-0-455>455</a></span>
<span class=normal><a href=#__codelineno-0-456>456</a></span>
<span class=normal><a href=#__codelineno-0-457>457</a></span>
<span class=normal><a href=#__codelineno-0-458>458</a></span>
<span class=normal><a href=#__codelineno-0-459>459</a></span>
<span class=normal><a href=#__codelineno-0-460>460</a></span>
<span class=normal><a href=#__codelineno-0-461>461</a></span>
<span class=normal><a href=#__codelineno-0-462>462</a></span>
<span class=normal><a href=#__codelineno-0-463>463</a></span>
<span class=normal><a href=#__codelineno-0-464>464</a></span>
<span class=normal><a href=#__codelineno-0-465>465</a></span>
<span class=normal><a href=#__codelineno-0-466>466</a></span>
<span class=normal><a href=#__codelineno-0-467>467</a></span>
<span class=normal><a href=#__codelineno-0-468>468</a></span>
<span class=normal><a href=#__codelineno-0-469>469</a></span>
<span class=normal><a href=#__codelineno-0-470>470</a></span>
<span class=normal><a href=#__codelineno-0-471>471</a></span>
<span class=normal><a href=#__codelineno-0-472>472</a></span>
<span class=normal><a href=#__codelineno-0-473>473</a></span>
<span class=normal><a href=#__codelineno-0-474>474</a></span>
<span class=normal><a href=#__codelineno-0-475>475</a></span>
<span class=normal><a href=#__codelineno-0-476>476</a></span>
<span class=normal><a href=#__codelineno-0-477>477</a></span>
<span class=normal><a href=#__codelineno-0-478>478</a></span>
<span class=normal><a href=#__codelineno-0-479>479</a></span>
<span class=normal><a href=#__codelineno-0-480>480</a></span>
<span class=normal><a href=#__codelineno-0-481>481</a></span>
<span class=normal><a href=#__codelineno-0-482>482</a></span>
<span class=normal><a href=#__codelineno-0-483>483</a></span>
<span class=normal><a href=#__codelineno-0-484>484</a></span>
<span class=normal><a href=#__codelineno-0-485>485</a></span>
<span class=normal><a href=#__codelineno-0-486>486</a></span>
<span class=normal><a href=#__codelineno-0-487>487</a></span>
<span class=normal><a href=#__codelineno-0-488>488</a></span>
<span class=normal><a href=#__codelineno-0-489>489</a></span>
<span class=normal><a href=#__codelineno-0-490>490</a></span>
<span class=normal><a href=#__codelineno-0-491>491</a></span>
<span class=normal><a href=#__codelineno-0-492>492</a></span>
<span class=normal><a href=#__codelineno-0-493>493</a></span>
<span class=normal><a href=#__codelineno-0-494>494</a></span>
<span class=normal><a href=#__codelineno-0-495>495</a></span>
<span class=normal><a href=#__codelineno-0-496>496</a></span>
<span class=normal><a href=#__codelineno-0-497>497</a></span>
<span class=normal><a href=#__codelineno-0-498>498</a></span>
<span class=normal><a href=#__codelineno-0-499>499</a></span>
<span class=normal><a href=#__codelineno-0-500>500</a></span>
<span class=normal><a href=#__codelineno-0-501>501</a></span>
<span class=normal><a href=#__codelineno-0-502>502</a></span>
<span class=normal><a href=#__codelineno-0-503>503</a></span>
<span class=normal><a href=#__codelineno-0-504>504</a></span>
<span class=normal><a href=#__codelineno-0-505>505</a></span>
<span class=normal><a href=#__codelineno-0-506>506</a></span>
<span class=normal><a href=#__codelineno-0-507>507</a></span>
<span class=normal><a href=#__codelineno-0-508>508</a></span>
<span class=normal><a href=#__codelineno-0-509>509</a></span>
<span class=normal><a href=#__codelineno-0-510>510</a></span>
<span class=normal><a href=#__codelineno-0-511>511</a></span>
<span class=normal><a href=#__codelineno-0-512>512</a></span>
<span class=normal><a href=#__codelineno-0-513>513</a></span>
<span class=normal><a href=#__codelineno-0-514>514</a></span>
<span class=normal><a href=#__codelineno-0-515>515</a></span>
<span class=normal><a href=#__codelineno-0-516>516</a></span>
<span class=normal><a href=#__codelineno-0-517>517</a></span>
<span class=normal><a href=#__codelineno-0-518>518</a></span>
<span class=normal><a href=#__codelineno-0-519>519</a></span>
<span class=normal><a href=#__codelineno-0-520>520</a></span>
<span class=normal><a href=#__codelineno-0-521>521</a></span>
<span class=normal><a href=#__codelineno-0-522>522</a></span>
<span class=normal><a href=#__codelineno-0-523>523</a></span>
<span class=normal><a href=#__codelineno-0-524>524</a></span>
<span class=normal><a href=#__codelineno-0-525>525</a></span>
<span class=normal><a href=#__codelineno-0-526>526</a></span>
<span class=normal><a href=#__codelineno-0-527>527</a></span>
<span class=normal><a href=#__codelineno-0-528>528</a></span>
<span class=normal><a href=#__codelineno-0-529>529</a></span>
<span class=normal><a href=#__codelineno-0-530>530</a></span>
<span class=normal><a href=#__codelineno-0-531>531</a></span>
<span class=normal><a href=#__codelineno-0-532>532</a></span>
<span class=normal><a href=#__codelineno-0-533>533</a></span>
<span class=normal><a href=#__codelineno-0-534>534</a></span>
<span class=normal><a href=#__codelineno-0-535>535</a></span>
<span class=normal><a href=#__codelineno-0-536>536</a></span>
<span class=normal><a href=#__codelineno-0-537>537</a></span>
<span class=normal><a href=#__codelineno-0-538>538</a></span>
<span class=normal><a href=#__codelineno-0-539>539</a></span>
<span class=normal><a href=#__codelineno-0-540>540</a></span>
<span class=normal><a href=#__codelineno-0-541>541</a></span>
<span class=normal><a href=#__codelineno-0-542>542</a></span>
<span class=normal><a href=#__codelineno-0-543>543</a></span>
<span class=normal><a href=#__codelineno-0-544>544</a></span>
<span class=normal><a href=#__codelineno-0-545>545</a></span>
<span class=normal><a href=#__codelineno-0-546>546</a></span>
<span class=normal><a href=#__codelineno-0-547>547</a></span>
<span class=normal><a href=#__codelineno-0-548>548</a></span>
<span class=normal><a href=#__codelineno-0-549>549</a></span>
<span class=normal><a href=#__codelineno-0-550>550</a></span>
<span class=normal><a href=#__codelineno-0-551>551</a></span>
<span class=normal><a href=#__codelineno-0-552>552</a></span>
<span class=normal><a href=#__codelineno-0-553>553</a></span>
<span class=normal><a href=#__codelineno-0-554>554</a></span>
<span class=normal><a href=#__codelineno-0-555>555</a></span>
<span class=normal><a href=#__codelineno-0-556>556</a></span>
<span class=normal><a href=#__codelineno-0-557>557</a></span>
<span class=normal><a href=#__codelineno-0-558>558</a></span>
<span class=normal><a href=#__codelineno-0-559>559</a></span>
<span class=normal><a href=#__codelineno-0-560>560</a></span>
<span class=normal><a href=#__codelineno-0-561>561</a></span>
<span class=normal><a href=#__codelineno-0-562>562</a></span>
<span class=normal><a href=#__codelineno-0-563>563</a></span>
<span class=normal><a href=#__codelineno-0-564>564</a></span>
<span class=normal><a href=#__codelineno-0-565>565</a></span>
<span class=normal><a href=#__codelineno-0-566>566</a></span>
<span class=normal><a href=#__codelineno-0-567>567</a></span>
<span class=normal><a href=#__codelineno-0-568>568</a></span>
<span class=normal><a href=#__codelineno-0-569>569</a></span>
<span class=normal><a href=#__codelineno-0-570>570</a></span>
<span class=normal><a href=#__codelineno-0-571>571</a></span>
<span class=normal><a href=#__codelineno-0-572>572</a></span>
<span class=normal><a href=#__codelineno-0-573>573</a></span>
<span class=normal><a href=#__codelineno-0-574>574</a></span>
<span class=normal><a href=#__codelineno-0-575>575</a></span>
<span class=normal><a href=#__codelineno-0-576>576</a></span>
<span class=normal><a href=#__codelineno-0-577>577</a></span>
<span class=normal><a href=#__codelineno-0-578>578</a></span>
<span class=normal><a href=#__codelineno-0-579>579</a></span>
<span class=normal><a href=#__codelineno-0-580>580</a></span>
<span class=normal><a href=#__codelineno-0-581>581</a></span>
<span class=normal><a href=#__codelineno-0-582>582</a></span>
<span class=normal><a href=#__codelineno-0-583>583</a></span>
<span class=normal><a href=#__codelineno-0-584>584</a></span>
<span class=normal><a href=#__codelineno-0-585>585</a></span>
<span class=normal><a href=#__codelineno-0-586>586</a></span>
<span class=normal><a href=#__codelineno-0-587>587</a></span>
<span class=normal><a href=#__codelineno-0-588>588</a></span>
<span class=normal><a href=#__codelineno-0-589>589</a></span>
<span class=normal><a href=#__codelineno-0-590>590</a></span>
<span class=normal><a href=#__codelineno-0-591>591</a></span>
<span class=normal><a href=#__codelineno-0-592>592</a></span>
<span class=normal><a href=#__codelineno-0-593>593</a></span>
<span class=normal><a href=#__codelineno-0-594>594</a></span>
<span class=normal><a href=#__codelineno-0-595>595</a></span>
<span class=normal><a href=#__codelineno-0-596>596</a></span>
<span class=normal><a href=#__codelineno-0-597>597</a></span>
<span class=normal><a href=#__codelineno-0-598>598</a></span>
<span class=normal><a href=#__codelineno-0-599>599</a></span>
<span class=normal><a href=#__codelineno-0-600>600</a></span>
<span class=normal><a href=#__codelineno-0-601>601</a></span>
<span class=normal><a href=#__codelineno-0-602>602</a></span>
<span class=normal><a href=#__codelineno-0-603>603</a></span>
<span class=normal><a href=#__codelineno-0-604>604</a></span>
<span class=normal><a href=#__codelineno-0-605>605</a></span>
<span class=normal><a href=#__codelineno-0-606>606</a></span>
<span class=normal><a href=#__codelineno-0-607>607</a></span>
<span class=normal><a href=#__codelineno-0-608>608</a></span>
<span class=normal><a href=#__codelineno-0-609>609</a></span>
<span class=normal><a href=#__codelineno-0-610>610</a></span>
<span class=normal><a href=#__codelineno-0-611>611</a></span>
<span class=normal><a href=#__codelineno-0-612>612</a></span>
<span class=normal><a href=#__codelineno-0-613>613</a></span>
<span class=normal><a href=#__codelineno-0-614>614</a></span>
<span class=normal><a href=#__codelineno-0-615>615</a></span>
<span class=normal><a href=#__codelineno-0-616>616</a></span>
<span class=normal><a href=#__codelineno-0-617>617</a></span>
<span class=normal><a href=#__codelineno-0-618>618</a></span>
<span class=normal><a href=#__codelineno-0-619>619</a></span>
<span class=normal><a href=#__codelineno-0-620>620</a></span>
<span class=normal><a href=#__codelineno-0-621>621</a></span>
<span class=normal><a href=#__codelineno-0-622>622</a></span>
<span class=normal><a href=#__codelineno-0-623>623</a></span>
<span class=normal><a href=#__codelineno-0-624>624</a></span>
<span class=normal><a href=#__codelineno-0-625>625</a></span>
<span class=normal><a href=#__codelineno-0-626>626</a></span>
<span class=normal><a href=#__codelineno-0-627>627</a></span>
<span class=normal><a href=#__codelineno-0-628>628</a></span>
<span class=normal><a href=#__codelineno-0-629>629</a></span>
<span class=normal><a href=#__codelineno-0-630>630</a></span>
<span class=normal><a href=#__codelineno-0-631>631</a></span>
<span class=normal><a href=#__codelineno-0-632>632</a></span>
<span class=normal><a href=#__codelineno-0-633>633</a></span>
<span class=normal><a href=#__codelineno-0-634>634</a></span>
<span class=normal><a href=#__codelineno-0-635>635</a></span>
<span class=normal><a href=#__codelineno-0-636>636</a></span>
<span class=normal><a href=#__codelineno-0-637>637</a></span>
<span class=normal><a href=#__codelineno-0-638>638</a></span>
<span class=normal><a href=#__codelineno-0-639>639</a></span>
<span class=normal><a href=#__codelineno-0-640>640</a></span>
<span class=normal><a href=#__codelineno-0-641>641</a></span>
<span class=normal><a href=#__codelineno-0-642>642</a></span>
<span class=normal><a href=#__codelineno-0-643>643</a></span>
<span class=normal><a href=#__codelineno-0-644>644</a></span>
<span class=normal><a href=#__codelineno-0-645>645</a></span>
<span class=normal><a href=#__codelineno-0-646>646</a></span>
<span class=normal><a href=#__codelineno-0-647>647</a></span>
<span class=normal><a href=#__codelineno-0-648>648</a></span>
<span class=normal><a href=#__codelineno-0-649>649</a></span>
<span class=normal><a href=#__codelineno-0-650>650</a></span>
<span class=normal><a href=#__codelineno-0-651>651</a></span>
<span class=normal><a href=#__codelineno-0-652>652</a></span>
<span class=normal><a href=#__codelineno-0-653>653</a></span>
<span class=normal><a href=#__codelineno-0-654>654</a></span>
<span class=normal><a href=#__codelineno-0-655>655</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-159><a id=__codelineno-0-159 name=__codelineno-0-159></a><span class=k>class</span><span class=w> </span><span class=nc>SLAFDataLoader</span><span class=p>:</span>
</span><span id=__span-0-160><a id=__codelineno-0-160 name=__codelineno-0-160></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-161><a id=__codelineno-0-161 name=__codelineno-0-161></a><span class=sd>    High-performance DataLoader for SLAF data optimized for ML training.</span>
</span><span id=__span-0-162><a id=__codelineno-0-162 name=__codelineno-0-162></a>
</span><span id=__span-0-163><a id=__codelineno-0-163 name=__codelineno-0-163></a><span class=sd>    SLAFDataLoader provides efficient streaming of single-cell data for machine learning</span>
</span><span id=__span-0-164><a id=__codelineno-0-164 name=__codelineno-0-164></a><span class=sd>    applications with multiple loading strategies for different use cases. It uses async</span>
</span><span id=__span-0-165><a id=__codelineno-0-165 name=__codelineno-0-165></a><span class=sd>    batch processing and provides device-agnostic CPU tensor output for maximum training flexibility.</span>
</span><span id=__span-0-166><a id=__codelineno-0-166 name=__codelineno-0-166></a>
</span><span id=__span-0-167><a id=__codelineno-0-167 name=__codelineno-0-167></a><span class=sd>    Key Features:</span>
</span><span id=__span-0-168><a id=__codelineno-0-168 name=__codelineno-0-168></a><span class=sd>        - Multiple tokenization strategies (GeneFormer, scGPT)</span>
</span><span id=__span-0-169><a id=__codelineno-0-169 name=__codelineno-0-169></a><span class=sd>        - Multiple loading modes for different entropy requirements:</span>
</span><span id=__span-0-170><a id=__codelineno-0-170 name=__codelineno-0-170></a><span class=sd>            * Mixture of Scanners (MoS): Maximum entropy, best randomization (default)</span>
</span><span id=__span-0-171><a id=__codelineno-0-171 name=__codelineno-0-171></a><span class=sd>            * Fragment-based loading: Higher entropy, moderate performance</span>
</span><span id=__span-0-172><a id=__codelineno-0-172 name=__codelineno-0-172></a><span class=sd>            * Sequential loading: Fastest, lowest entropy</span>
</span><span id=__span-0-173><a id=__codelineno-0-173 name=__codelineno-0-173></a><span class=sd>        - Pre-tokenized sequences for maximum performance (tokenized mode)</span>
</span><span id=__span-0-174><a id=__codelineno-0-174 name=__codelineno-0-174></a><span class=sd>        - Raw data output for external processing (raw mode)</span>
</span><span id=__span-0-175><a id=__codelineno-0-175 name=__codelineno-0-175></a><span class=sd>        - Device-agnostic CPU tensor output</span>
</span><span id=__span-0-176><a id=__codelineno-0-176 name=__codelineno-0-176></a><span class=sd>        - Async batch processing with background prefetching</span>
</span><span id=__span-0-177><a id=__codelineno-0-177 name=__codelineno-0-177></a><span class=sd>        - Memory-efficient streaming</span>
</span><span id=__span-0-178><a id=__codelineno-0-178 name=__codelineno-0-178></a><span class=sd>        - Multi-epoch training support</span>
</span><span id=__span-0-179><a id=__codelineno-0-179 name=__codelineno-0-179></a><span class=sd>        - Comprehensive error handling and validation</span>
</span><span id=__span-0-180><a id=__codelineno-0-180 name=__codelineno-0-180></a>
</span><span id=__span-0-181><a id=__codelineno-0-181 name=__codelineno-0-181></a><span class=sd>    Loading Modes:</span>
</span><span id=__span-0-182><a id=__codelineno-0-182 name=__codelineno-0-182></a><span class=sd>        1. Mixture of Scanners (default): Randomly samples from multiple fragment generators</span>
</span><span id=__span-0-183><a id=__codelineno-0-183 name=__codelineno-0-183></a><span class=sd>           for maximum entropy and randomization (88% of random entropy)</span>
</span><span id=__span-0-184><a id=__codelineno-0-184 name=__codelineno-0-184></a><span class=sd>        2. Fragment-based: Loads complete Lance fragments for higher data entropy</span>
</span><span id=__span-0-185><a id=__codelineno-0-185 name=__codelineno-0-185></a><span class=sd>        3. Sequential: Loads contiguous Lance batches for maximum throughput</span>
</span><span id=__span-0-186><a id=__codelineno-0-186 name=__codelineno-0-186></a>
</span><span id=__span-0-187><a id=__codelineno-0-187 name=__codelineno-0-187></a><span class=sd>    Examples:</span>
</span><span id=__span-0-188><a id=__codelineno-0-188 name=__codelineno-0-188></a><span class=sd>        &gt;&gt;&gt; # Basic usage with default settings (MoS loading)</span>
</span><span id=__span-0-189><a id=__codelineno-0-189 name=__codelineno-0-189></a><span class=sd>        &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-190><a id=__codelineno-0-190 name=__codelineno-0-190></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array)</span>
</span><span id=__span-0-191><a id=__codelineno-0-191 name=__codelineno-0-191></a><span class=sd>        &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-192><a id=__codelineno-0-192 name=__codelineno-0-192></a><span class=sd>        ...     print(f&quot;Batch shape: {batch[&#39;input_ids&#39;].shape}&quot;)</span>
</span><span id=__span-0-193><a id=__codelineno-0-193 name=__codelineno-0-193></a><span class=sd>        ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-194><a id=__codelineno-0-194 name=__codelineno-0-194></a><span class=sd>        ...     break</span>
</span><span id=__span-0-195><a id=__codelineno-0-195 name=__codelineno-0-195></a><span class=sd>        Batch shape: torch.Size([32, 2048])</span>
</span><span id=__span-0-196><a id=__codelineno-0-196 name=__codelineno-0-196></a><span class=sd>        Cell IDs: tensor([0, 1, 2, ..., 29, 30, 31])</span>
</span><span id=__span-0-197><a id=__codelineno-0-197 name=__codelineno-0-197></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-198><a id=__codelineno-0-198 name=__codelineno-0-198></a><span class=sd>        MoS enabled: True</span>
</span><span id=__span-0-199><a id=__codelineno-0-199 name=__codelineno-0-199></a>
</span><span id=__span-0-200><a id=__codelineno-0-200 name=__codelineno-0-200></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-201><a id=__codelineno-0-201 name=__codelineno-0-201></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-202><a id=__codelineno-0-202 name=__codelineno-0-202></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-203><a id=__codelineno-0-203 name=__codelineno-0-203></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-204><a id=__codelineno-0-204 name=__codelineno-0-204></a><span class=sd>        ...     by_fragment=False</span>
</span><span id=__span-0-205><a id=__codelineno-0-205 name=__codelineno-0-205></a><span class=sd>        ... )</span>
</span><span id=__span-0-206><a id=__codelineno-0-206 name=__codelineno-0-206></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-207><a id=__codelineno-0-207 name=__codelineno-0-207></a><span class=sd>        Sequential loading: True</span>
</span><span id=__span-0-208><a id=__codelineno-0-208 name=__codelineno-0-208></a>
</span><span id=__span-0-209><a id=__codelineno-0-209 name=__codelineno-0-209></a><span class=sd>        &gt;&gt;&gt; # Fragment-based loading for higher entropy</span>
</span><span id=__span-0-210><a id=__codelineno-0-210 name=__codelineno-0-210></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-211><a id=__codelineno-0-211 name=__codelineno-0-211></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-212><a id=__codelineno-0-212 name=__codelineno-0-212></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-213><a id=__codelineno-0-213 name=__codelineno-0-213></a><span class=sd>        ...     by_fragment=True</span>
</span><span id=__span-0-214><a id=__codelineno-0-214 name=__codelineno-0-214></a><span class=sd>        ... )</span>
</span><span id=__span-0-215><a id=__codelineno-0-215 name=__codelineno-0-215></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Fragment-based loading: {dataloader.by_fragment}&quot;)</span>
</span><span id=__span-0-216><a id=__codelineno-0-216 name=__codelineno-0-216></a><span class=sd>        Fragment-based loading: True</span>
</span><span id=__span-0-217><a id=__codelineno-0-217 name=__codelineno-0-217></a>
</span><span id=__span-0-218><a id=__codelineno-0-218 name=__codelineno-0-218></a><span class=sd>        &gt;&gt;&gt; # Raw mode for external processing</span>
</span><span id=__span-0-219><a id=__codelineno-0-219 name=__codelineno-0-219></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-220><a id=__codelineno-0-220 name=__codelineno-0-220></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-221><a id=__codelineno-0-221 name=__codelineno-0-221></a><span class=sd>        ...     raw_mode=True</span>
</span><span id=__span-0-222><a id=__codelineno-0-222 name=__codelineno-0-222></a><span class=sd>        ... )</span>
</span><span id=__span-0-223><a id=__codelineno-0-223 name=__codelineno-0-223></a><span class=sd>        &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-224><a id=__codelineno-0-224 name=__codelineno-0-224></a><span class=sd>        ...     print(f&quot;Raw data type: {type(batch[&#39;x&#39;])}&quot;)</span>
</span><span id=__span-0-225><a id=__codelineno-0-225 name=__codelineno-0-225></a><span class=sd>        ...     break</span>
</span><span id=__span-0-226><a id=__codelineno-0-226 name=__codelineno-0-226></a><span class=sd>        Raw data type: &lt;class &#39;polars.dataframe.frame.DataFrame&#39;&gt;</span>
</span><span id=__span-0-227><a id=__codelineno-0-227 name=__codelineno-0-227></a>
</span><span id=__span-0-228><a id=__codelineno-0-228 name=__codelineno-0-228></a><span class=sd>        &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-229><a id=__codelineno-0-229 name=__codelineno-0-229></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-230><a id=__codelineno-0-230 name=__codelineno-0-230></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-231><a id=__codelineno-0-231 name=__codelineno-0-231></a><span class=sd>        ...     n_epochs=5</span>
</span><span id=__span-0-232><a id=__codelineno-0-232 name=__codelineno-0-232></a><span class=sd>        ... )</span>
</span><span id=__span-0-233><a id=__codelineno-0-233 name=__codelineno-0-233></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Number of epochs: {dataloader.n_epochs}&quot;)</span>
</span><span id=__span-0-234><a id=__codelineno-0-234 name=__codelineno-0-234></a><span class=sd>        Number of epochs: 5</span>
</span><span id=__span-0-235><a id=__codelineno-0-235 name=__codelineno-0-235></a>
</span><span id=__span-0-236><a id=__codelineno-0-236 name=__codelineno-0-236></a><span class=sd>        &gt;&gt;&gt; # Custom configuration for training</span>
</span><span id=__span-0-237><a id=__codelineno-0-237 name=__codelineno-0-237></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-238><a id=__codelineno-0-238 name=__codelineno-0-238></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-239><a id=__codelineno-0-239 name=__codelineno-0-239></a><span class=sd>        ...     tokenizer_type=&quot;scgpt&quot;,</span>
</span><span id=__span-0-240><a id=__codelineno-0-240 name=__codelineno-0-240></a><span class=sd>        ...     batch_size=64,</span>
</span><span id=__span-0-241><a id=__codelineno-0-241 name=__codelineno-0-241></a><span class=sd>        ...     max_genes=1024</span>
</span><span id=__span-0-242><a id=__codelineno-0-242 name=__codelineno-0-242></a><span class=sd>        ... )</span>
</span><span id=__span-0-243><a id=__codelineno-0-243 name=__codelineno-0-243></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Tokenizer type: {dataloader.tokenizer_type}&quot;)</span>
</span><span id=__span-0-244><a id=__codelineno-0-244 name=__codelineno-0-244></a><span class=sd>        Tokenizer type: scgpt</span>
</span><span id=__span-0-245><a id=__codelineno-0-245 name=__codelineno-0-245></a>
</span><span id=__span-0-246><a id=__codelineno-0-246 name=__codelineno-0-246></a><span class=sd>        &gt;&gt;&gt; # Training loop example</span>
</span><span id=__span-0-247><a id=__codelineno-0-247 name=__codelineno-0-247></a><span class=sd>        &gt;&gt;&gt; for batch_idx, batch in enumerate(dataloader):</span>
</span><span id=__span-0-248><a id=__codelineno-0-248 name=__codelineno-0-248></a><span class=sd>        ...     input_ids = batch[&quot;input_ids&quot;]</span>
</span><span id=__span-0-249><a id=__codelineno-0-249 name=__codelineno-0-249></a><span class=sd>        ...     attention_mask = batch[&quot;attention_mask&quot;]</span>
</span><span id=__span-0-250><a id=__codelineno-0-250 name=__codelineno-0-250></a><span class=sd>        ...     cell_ids = batch[&quot;cell_ids&quot;]</span>
</span><span id=__span-0-251><a id=__codelineno-0-251 name=__codelineno-0-251></a><span class=sd>        ...     # Your training code here</span>
</span><span id=__span-0-252><a id=__codelineno-0-252 name=__codelineno-0-252></a><span class=sd>        ...     if batch_idx &gt;= 2:  # Just test first few batches</span>
</span><span id=__span-0-253><a id=__codelineno-0-253 name=__codelineno-0-253></a><span class=sd>        ...         break</span>
</span><span id=__span-0-254><a id=__codelineno-0-254 name=__codelineno-0-254></a><span class=sd>        &gt;&gt;&gt; print(&quot;Training loop completed&quot;)</span>
</span><span id=__span-0-255><a id=__codelineno-0-255 name=__codelineno-0-255></a><span class=sd>        Training loop completed</span>
</span><span id=__span-0-256><a id=__codelineno-0-256 name=__codelineno-0-256></a>
</span><span id=__span-0-257><a id=__codelineno-0-257 name=__codelineno-0-257></a><span class=sd>        &gt;&gt;&gt; # Error handling for invalid tokenizer type</span>
</span><span id=__span-0-258><a id=__codelineno-0-258 name=__codelineno-0-258></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-259><a id=__codelineno-0-259 name=__codelineno-0-259></a><span class=sd>        ...     dataloader = SLAFDataLoader(slaf_array, tokenizer_type=&quot;invalid&quot;)</span>
</span><span id=__span-0-260><a id=__codelineno-0-260 name=__codelineno-0-260></a><span class=sd>        ... except ValueError as e:</span>
</span><span id=__span-0-261><a id=__codelineno-0-261 name=__codelineno-0-261></a><span class=sd>        ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-262><a id=__codelineno-0-262 name=__codelineno-0-262></a><span class=sd>        Error: Unsupported tokenizer type: invalid</span>
</span><span id=__span-0-263><a id=__codelineno-0-263 name=__codelineno-0-263></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-264><a id=__codelineno-0-264 name=__codelineno-0-264></a>
</span><span id=__span-0-265><a id=__codelineno-0-265 name=__codelineno-0-265></a>    <span class=n>device</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=s2>&quot;torch.device&quot;</span><span class=p>]</span>  <span class=c1># type: ignore</span>
</span><span id=__span-0-266><a id=__codelineno-0-266 name=__codelineno-0-266></a>    <span class=n>tokenizer</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=s2>&quot;SLAFTokenizer&quot;</span><span class=p>]</span>  <span class=c1># type: ignore</span>
</span><span id=__span-0-267><a id=__codelineno-0-267 name=__codelineno-0-267></a>
</span><span id=__span-0-268><a id=__codelineno-0-268 name=__codelineno-0-268></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-269><a id=__codelineno-0-269 name=__codelineno-0-269></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-270><a id=__codelineno-0-270 name=__codelineno-0-270></a>        <span class=n>slaf_array</span><span class=p>:</span> <span class=n>SLAFArray</span><span class=p>,</span>
</span><span id=__span-0-271><a id=__codelineno-0-271 name=__codelineno-0-271></a>        <span class=n>tokenizer_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;geneformer&quot;</span><span class=p>,</span>
</span><span id=__span-0-272><a id=__codelineno-0-272 name=__codelineno-0-272></a>        <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-273><a id=__codelineno-0-273 name=__codelineno-0-273></a>        <span class=n>max_genes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2048</span><span class=p>,</span>
</span><span id=__span-0-274><a id=__codelineno-0-274 name=__codelineno-0-274></a>        <span class=n>vocab_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span>
</span><span id=__span-0-275><a id=__codelineno-0-275 name=__codelineno-0-275></a>        <span class=n>n_expression_bins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-0-276><a id=__codelineno-0-276 name=__codelineno-0-276></a>        <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># Add n_epochs parameter</span>
</span><span id=__span-0-277><a id=__codelineno-0-277 name=__codelineno-0-277></a>        <span class=n>raw_mode</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>  <span class=c1># Add raw_mode parameter</span>
</span><span id=__span-0-278><a id=__codelineno-0-278 name=__codelineno-0-278></a>        <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>  <span class=c1># Add verbose parameter</span>
</span><span id=__span-0-279><a id=__codelineno-0-279 name=__codelineno-0-279></a>        <span class=n>batches_per_chunk</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># Default to 1 for MoS (was 50 for sequential)</span>
</span><span id=__span-0-280><a id=__codelineno-0-280 name=__codelineno-0-280></a>        <span class=n>by_fragment</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>  <span class=c1># Default to True for MoS (was False for sequential)</span>
</span><span id=__span-0-281><a id=__codelineno-0-281 name=__codelineno-0-281></a>        <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>  <span class=c1># Default to True for MoS (was False)</span>
</span><span id=__span-0-282><a id=__codelineno-0-282 name=__codelineno-0-282></a>        <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>16</span><span class=p>,</span>  <span class=c1># Add n_scanners parameter for MoS</span>
</span><span id=__span-0-283><a id=__codelineno-0-283 name=__codelineno-0-283></a>        <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>4194304</span><span class=p>,</span>  <span class=c1># Add prefetch_batch_size parameter for MoS</span>
</span><span id=__span-0-284><a id=__codelineno-0-284 name=__codelineno-0-284></a>        <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5000</span><span class=p>,</span>  <span class=c1># Add max_queue_size parameter</span>
</span><span id=__span-0-285><a id=__codelineno-0-285 name=__codelineno-0-285></a>        <span class=n>parallelize_fragment_reads</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>  <span class=c1># Parallelize fragment reads in MoS (cloud optimization)</span>
</span><span id=__span-0-286><a id=__codelineno-0-286 name=__codelineno-0-286></a>    <span class=p>):</span>
</span><span id=__span-0-287><a id=__codelineno-0-287 name=__codelineno-0-287></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-288><a id=__codelineno-0-288 name=__codelineno-0-288></a><span class=sd>        Initialize the SLAF DataLoader with training configuration.</span>
</span><span id=__span-0-289><a id=__codelineno-0-289 name=__codelineno-0-289></a>
</span><span id=__span-0-290><a id=__codelineno-0-290 name=__codelineno-0-290></a><span class=sd>        Args:</span>
</span><span id=__span-0-291><a id=__codelineno-0-291 name=__codelineno-0-291></a><span class=sd>            slaf_array: SLAFArray instance containing the single-cell data.</span>
</span><span id=__span-0-292><a id=__codelineno-0-292 name=__codelineno-0-292></a><span class=sd>                       Must be a valid SLAFArray with proper Lance dataset structure.</span>
</span><span id=__span-0-293><a id=__codelineno-0-293 name=__codelineno-0-293></a>
</span><span id=__span-0-294><a id=__codelineno-0-294 name=__codelineno-0-294></a><span class=sd>            # Tokenization Configuration</span>
</span><span id=__span-0-295><a id=__codelineno-0-295 name=__codelineno-0-295></a><span class=sd>            tokenizer_type: Tokenization strategy to use. Options: &quot;geneformer&quot;, &quot;scgpt&quot;.</span>
</span><span id=__span-0-296><a id=__codelineno-0-296 name=__codelineno-0-296></a><span class=sd>                          Geneformer uses ranked gene sequences, scGPT uses interleaved</span>
</span><span id=__span-0-297><a id=__codelineno-0-297 name=__codelineno-0-297></a><span class=sd>                          gene-expression pairs. Ignored when raw_mode=True.</span>
</span><span id=__span-0-298><a id=__codelineno-0-298 name=__codelineno-0-298></a><span class=sd>            max_genes: Maximum number of genes to include in each cell&#39;s tokenization.</span>
</span><span id=__span-0-299><a id=__codelineno-0-299 name=__codelineno-0-299></a><span class=sd>                     For Geneformer: same as sequence length. For scGPT: number of</span>
</span><span id=__span-0-300><a id=__codelineno-0-300 name=__codelineno-0-300></a><span class=sd>                     gene-expression pairs (sequence length = 2*max_genes+2).</span>
</span><span id=__span-0-301><a id=__codelineno-0-301 name=__codelineno-0-301></a><span class=sd>            vocab_size: Size of the tokenizer vocabulary. Higher values allow more</span>
</span><span id=__span-0-302><a id=__codelineno-0-302 name=__codelineno-0-302></a><span class=sd>                       genes but use more memory. Range: 1000-100000, default: 50000.</span>
</span><span id=__span-0-303><a id=__codelineno-0-303 name=__codelineno-0-303></a><span class=sd>            n_expression_bins: Number of expression level bins for scGPT discretization.</span>
</span><span id=__span-0-304><a id=__codelineno-0-304 name=__codelineno-0-304></a><span class=sd>                             Higher values provide finer expression resolution.</span>
</span><span id=__span-0-305><a id=__codelineno-0-305 name=__codelineno-0-305></a><span class=sd>                             Range: 1-1000, default: 10.</span>
</span><span id=__span-0-306><a id=__codelineno-0-306 name=__codelineno-0-306></a>
</span><span id=__span-0-307><a id=__codelineno-0-307 name=__codelineno-0-307></a><span class=sd>            # Training Configuration</span>
</span><span id=__span-0-308><a id=__codelineno-0-308 name=__codelineno-0-308></a><span class=sd>            batch_size: Number of cells per batch. Larger batches use more memory</span>
</span><span id=__span-0-309><a id=__codelineno-0-309 name=__codelineno-0-309></a><span class=sd>                       but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-310><a id=__codelineno-0-310 name=__codelineno-0-310></a><span class=sd>            n_epochs: Number of epochs to run. The generator will automatically reset</span>
</span><span id=__span-0-311><a id=__codelineno-0-311 name=__codelineno-0-311></a><span class=sd>                     after each epoch, enabling multi-epoch training on small datasets.</span>
</span><span id=__span-0-312><a id=__codelineno-0-312 name=__codelineno-0-312></a><span class=sd>                     Default: 1.</span>
</span><span id=__span-0-313><a id=__codelineno-0-313 name=__codelineno-0-313></a>
</span><span id=__span-0-314><a id=__codelineno-0-314 name=__codelineno-0-314></a><span class=sd>            # Output Mode Configuration</span>
</span><span id=__span-0-315><a id=__codelineno-0-315 name=__codelineno-0-315></a><span class=sd>            raw_mode: If True, return raw cell  gene data as Polars DataFrames</span>
</span><span id=__span-0-316><a id=__codelineno-0-316 name=__codelineno-0-316></a><span class=sd>                     instead of pre-tokenized sequences. This bypasses tokenization</span>
</span><span id=__span-0-317><a id=__codelineno-0-317 name=__codelineno-0-317></a><span class=sd>                     and windowing for maximum flexibility. Default: False.</span>
</span><span id=__span-0-318><a id=__codelineno-0-318 name=__codelineno-0-318></a>
</span><span id=__span-0-319><a id=__codelineno-0-319 name=__codelineno-0-319></a><span class=sd>            # Loading Strategy Configuration (MoS is now default)</span>
</span><span id=__span-0-320><a id=__codelineno-0-320 name=__codelineno-0-320></a><span class=sd>            batches_per_chunk: Number of Lance batches to load per chunk for sequential loading.</span>
</span><span id=__span-0-321><a id=__codelineno-0-321 name=__codelineno-0-321></a><span class=sd>                             Higher values use more memory but may improve throughput.</span>
</span><span id=__span-0-322><a id=__codelineno-0-322 name=__codelineno-0-322></a><span class=sd>                             Range: 1-200, default: 1 (optimized for MoS). Only used when by_fragment=False.</span>
</span><span id=__span-0-323><a id=__codelineno-0-323 name=__codelineno-0-323></a><span class=sd>            by_fragment: If True, use fragment-based loading instead of batch-based loading.</span>
</span><span id=__span-0-324><a id=__codelineno-0-324 name=__codelineno-0-324></a><span class=sd>                        Fragment-based loading provides higher entropy but may be slightly slower.</span>
</span><span id=__span-0-325><a id=__codelineno-0-325 name=__codelineno-0-325></a><span class=sd>                        Automatically enabled when use_mixture_of_scanners=True.</span>
</span><span id=__span-0-326><a id=__codelineno-0-326 name=__codelineno-0-326></a><span class=sd>                        Default: True (enabled for MoS).</span>
</span><span id=__span-0-327><a id=__codelineno-0-327 name=__codelineno-0-327></a><span class=sd>            use_mixture_of_scanners: If True, use mixture of scanners (MoS) approach for higher</span>
</span><span id=__span-0-328><a id=__codelineno-0-328 name=__codelineno-0-328></a><span class=sd>                                   entropy by randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-329><a id=__codelineno-0-329 name=__codelineno-0-329></a><span class=sd>                                   This provides the best randomization and is now the default</span>
</span><span id=__span-0-330><a id=__codelineno-0-330 name=__codelineno-0-330></a><span class=sd>                                   for foundation model training. Default: True.</span>
</span><span id=__span-0-331><a id=__codelineno-0-331 name=__codelineno-0-331></a><span class=sd>            n_scanners: Number of fragment generators to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-332><a id=__codelineno-0-332 name=__codelineno-0-332></a><span class=sd>                       Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-333><a id=__codelineno-0-333 name=__codelineno-0-333></a><span class=sd>                       Range: 1-100, default: 16. Only used when use_mixture_of_scanners=True.</span>
</span><span id=__span-0-334><a id=__codelineno-0-334 name=__codelineno-0-334></a><span class=sd>            prefetch_batch_size: Target number of rows to load per prefetch batch when using MoS.</span>
</span><span id=__span-0-335><a id=__codelineno-0-335 name=__codelineno-0-335></a><span class=sd>                               Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-336><a id=__codelineno-0-336 name=__codelineno-0-336></a><span class=sd>                               Range: 1000-10000000, default: 4194304. Only used when</span>
</span><span id=__span-0-337><a id=__codelineno-0-337 name=__codelineno-0-337></a><span class=sd>                               use_mixture_of_scanners=True.</span>
</span><span id=__span-0-338><a id=__codelineno-0-338 name=__codelineno-0-338></a><span class=sd>            parallelize_fragment_reads: Whether to parallelize fragment reads in MoS mode.</span>
</span><span id=__span-0-339><a id=__codelineno-0-339 name=__codelineno-0-339></a><span class=sd>                                       Critical for cloud scenarios where network latency</span>
</span><span id=__span-0-340><a id=__codelineno-0-340 name=__codelineno-0-340></a><span class=sd>                                       dominates (can improve throughput 10-30x). For local</span>
</span><span id=__span-0-341><a id=__codelineno-0-341 name=__codelineno-0-341></a><span class=sd>                                       data, sequential reads are typically more efficient as</span>
</span><span id=__span-0-342><a id=__codelineno-0-342 name=__codelineno-0-342></a><span class=sd>                                       parallelization adds overhead without benefit.</span>
</span><span id=__span-0-343><a id=__codelineno-0-343 name=__codelineno-0-343></a><span class=sd>                                       Default: False. Only used when use_mixture_of_scanners=True.</span>
</span><span id=__span-0-344><a id=__codelineno-0-344 name=__codelineno-0-344></a>
</span><span id=__span-0-345><a id=__codelineno-0-345 name=__codelineno-0-345></a><span class=sd>            # System Configuration</span>
</span><span id=__span-0-346><a id=__codelineno-0-346 name=__codelineno-0-346></a><span class=sd>            verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-347><a id=__codelineno-0-347 name=__codelineno-0-347></a><span class=sd>                    If False, suppress all SLAF internal prints for clean output.</span>
</span><span id=__span-0-348><a id=__codelineno-0-348 name=__codelineno-0-348></a><span class=sd>                    Default: True.</span>
</span><span id=__span-0-349><a id=__codelineno-0-349 name=__codelineno-0-349></a>
</span><span id=__span-0-350><a id=__codelineno-0-350 name=__codelineno-0-350></a><span class=sd>        Raises:</span>
</span><span id=__span-0-351><a id=__codelineno-0-351 name=__codelineno-0-351></a><span class=sd>            ValueError: If tokenizer_type is not supported or parameters are invalid.</span>
</span><span id=__span-0-352><a id=__codelineno-0-352 name=__codelineno-0-352></a><span class=sd>            RuntimeError: If PyTorch is not available or datasets module is missing.</span>
</span><span id=__span-0-353><a id=__codelineno-0-353 name=__codelineno-0-353></a><span class=sd>            TypeError: If slaf_array is not a valid SLAFArray instance.</span>
</span><span id=__span-0-354><a id=__codelineno-0-354 name=__codelineno-0-354></a><span class=sd>            ImportError: If required dependencies are not available.</span>
</span><span id=__span-0-355><a id=__codelineno-0-355 name=__codelineno-0-355></a>
</span><span id=__span-0-356><a id=__codelineno-0-356 name=__codelineno-0-356></a><span class=sd>        Loading Strategy Selection Guide:</span>
</span><span id=__span-0-357><a id=__codelineno-0-357 name=__codelineno-0-357></a><span class=sd>            - For foundation model training: Use default settings (MoS provides 88% random entropy)</span>
</span><span id=__span-0-358><a id=__codelineno-0-358 name=__codelineno-0-358></a><span class=sd>            - For cloud data: Enable parallelize_fragment_reads=True for 10-30x throughput improvement</span>
</span><span id=__span-0-359><a id=__codelineno-0-359 name=__codelineno-0-359></a><span class=sd>            - For local data: Keep parallelize_fragment_reads=False (sequential reads are more efficient)</span>
</span><span id=__span-0-360><a id=__codelineno-0-360 name=__codelineno-0-360></a><span class=sd>            - For maximum throughput: Set use_mixture_of_scanners=False, by_fragment=False</span>
</span><span id=__span-0-361><a id=__codelineno-0-361 name=__codelineno-0-361></a><span class=sd>            - For external processing: Set raw_mode=True</span>
</span><span id=__span-0-362><a id=__codelineno-0-362 name=__codelineno-0-362></a>
</span><span id=__span-0-363><a id=__codelineno-0-363 name=__codelineno-0-363></a><span class=sd>        Examples:</span>
</span><span id=__span-0-364><a id=__codelineno-0-364 name=__codelineno-0-364></a><span class=sd>            &gt;&gt;&gt; # Basic initialization (MoS is now default)</span>
</span><span id=__span-0-365><a id=__codelineno-0-365 name=__codelineno-0-365></a><span class=sd>            &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-366><a id=__codelineno-0-366 name=__codelineno-0-366></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array)</span>
</span><span id=__span-0-367><a id=__codelineno-0-367 name=__codelineno-0-367></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Batch size: {dataloader.batch_size}&quot;)</span>
</span><span id=__span-0-368><a id=__codelineno-0-368 name=__codelineno-0-368></a><span class=sd>            Batch size: 32</span>
</span><span id=__span-0-369><a id=__codelineno-0-369 name=__codelineno-0-369></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS enabled: {dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-370><a id=__codelineno-0-370 name=__codelineno-0-370></a><span class=sd>            MoS enabled: True</span>
</span><span id=__span-0-371><a id=__codelineno-0-371 name=__codelineno-0-371></a>
</span><span id=__span-0-372><a id=__codelineno-0-372 name=__codelineno-0-372></a><span class=sd>            &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-373><a id=__codelineno-0-373 name=__codelineno-0-373></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-374><a id=__codelineno-0-374 name=__codelineno-0-374></a><span class=sd>            ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-375><a id=__codelineno-0-375 name=__codelineno-0-375></a><span class=sd>            ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-376><a id=__codelineno-0-376 name=__codelineno-0-376></a><span class=sd>            ...     by_fragment=False</span>
</span><span id=__span-0-377><a id=__codelineno-0-377 name=__codelineno-0-377></a><span class=sd>            ... )</span>
</span><span id=__span-0-378><a id=__codelineno-0-378 name=__codelineno-0-378></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-379><a id=__codelineno-0-379 name=__codelineno-0-379></a><span class=sd>            Sequential loading: True</span>
</span><span id=__span-0-380><a id=__codelineno-0-380 name=__codelineno-0-380></a>
</span><span id=__span-0-381><a id=__codelineno-0-381 name=__codelineno-0-381></a><span class=sd>            &gt;&gt;&gt; # Fragment-based loading for higher entropy</span>
</span><span id=__span-0-382><a id=__codelineno-0-382 name=__codelineno-0-382></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-383><a id=__codelineno-0-383 name=__codelineno-0-383></a><span class=sd>            ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-384><a id=__codelineno-0-384 name=__codelineno-0-384></a><span class=sd>            ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-385><a id=__codelineno-0-385 name=__codelineno-0-385></a><span class=sd>            ...     by_fragment=True</span>
</span><span id=__span-0-386><a id=__codelineno-0-386 name=__codelineno-0-386></a><span class=sd>            ... )</span>
</span><span id=__span-0-387><a id=__codelineno-0-387 name=__codelineno-0-387></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Fragment-based loading: {dataloader.by_fragment}&quot;)</span>
</span><span id=__span-0-388><a id=__codelineno-0-388 name=__codelineno-0-388></a><span class=sd>            Fragment-based loading: True</span>
</span><span id=__span-0-389><a id=__codelineno-0-389 name=__codelineno-0-389></a>
</span><span id=__span-0-390><a id=__codelineno-0-390 name=__codelineno-0-390></a><span class=sd>            &gt;&gt;&gt; # Raw mode for external processing</span>
</span><span id=__span-0-391><a id=__codelineno-0-391 name=__codelineno-0-391></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-392><a id=__codelineno-0-392 name=__codelineno-0-392></a><span class=sd>            ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-393><a id=__codelineno-0-393 name=__codelineno-0-393></a><span class=sd>            ...     raw_mode=True</span>
</span><span id=__span-0-394><a id=__codelineno-0-394 name=__codelineno-0-394></a><span class=sd>            ... )</span>
</span><span id=__span-0-395><a id=__codelineno-0-395 name=__codelineno-0-395></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Raw mode: {dataloader.raw_mode}&quot;)</span>
</span><span id=__span-0-396><a id=__codelineno-0-396 name=__codelineno-0-396></a><span class=sd>            Raw mode: True</span>
</span><span id=__span-0-397><a id=__codelineno-0-397 name=__codelineno-0-397></a>
</span><span id=__span-0-398><a id=__codelineno-0-398 name=__codelineno-0-398></a><span class=sd>            &gt;&gt;&gt; # Cloud data optimization: parallelize fragment reads</span>
</span><span id=__span-0-399><a id=__codelineno-0-399 name=__codelineno-0-399></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-400><a id=__codelineno-0-400 name=__codelineno-0-400></a><span class=sd>            ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-401><a id=__codelineno-0-401 name=__codelineno-0-401></a><span class=sd>            ...     parallelize_fragment_reads=True,  # Critical for accelerating cloud data loading</span>
</span><span id=__span-0-402><a id=__codelineno-0-402 name=__codelineno-0-402></a><span class=sd>            ...     batches_per_chunk=16,  # Combine with higher batches_per_chunk for best results</span>
</span><span id=__span-0-403><a id=__codelineno-0-403 name=__codelineno-0-403></a><span class=sd>            ... )</span>
</span><span id=__span-0-404><a id=__codelineno-0-404 name=__codelineno-0-404></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Parallel fragment reads: {dataloader.parallelize_fragment_reads}&quot;)</span>
</span><span id=__span-0-405><a id=__codelineno-0-405 name=__codelineno-0-405></a><span class=sd>            Parallel fragment reads: True</span>
</span><span id=__span-0-406><a id=__codelineno-0-406 name=__codelineno-0-406></a>
</span><span id=__span-0-407><a id=__codelineno-0-407 name=__codelineno-0-407></a><span class=sd>            &gt;&gt;&gt; # Error handling for invalid parameters</span>
</span><span id=__span-0-408><a id=__codelineno-0-408 name=__codelineno-0-408></a><span class=sd>            &gt;&gt;&gt; try:</span>
</span><span id=__span-0-409><a id=__codelineno-0-409 name=__codelineno-0-409></a><span class=sd>            ...     dataloader = SLAFDataLoader(slaf_array, n_scanners=0)</span>
</span><span id=__span-0-410><a id=__codelineno-0-410 name=__codelineno-0-410></a><span class=sd>            ... except ValueError as e:</span>
</span><span id=__span-0-411><a id=__codelineno-0-411 name=__codelineno-0-411></a><span class=sd>            ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-412><a id=__codelineno-0-412 name=__codelineno-0-412></a><span class=sd>            Error: n_scanners must be at least 1</span>
</span><span id=__span-0-413><a id=__codelineno-0-413 name=__codelineno-0-413></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-414><a id=__codelineno-0-414 name=__codelineno-0-414></a>        <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>slaf_array</span>
</span><span id=__span-0-415><a id=__codelineno-0-415 name=__codelineno-0-415></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>=</span> <span class=n>tokenizer_type</span>
</span><span id=__span-0-416><a id=__codelineno-0-416 name=__codelineno-0-416></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-417><a id=__codelineno-0-417 name=__codelineno-0-417></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_genes</span> <span class=o>=</span> <span class=n>max_genes</span>
</span><span id=__span-0-418><a id=__codelineno-0-418 name=__codelineno-0-418></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-419><a id=__codelineno-0-419 name=__codelineno-0-419></a>        <span class=bp>self</span><span class=o>.</span><span class=n>raw_mode</span> <span class=o>=</span> <span class=n>raw_mode</span>  <span class=c1># Add raw_mode attribute</span>
</span><span id=__span-0-420><a id=__codelineno-0-420 name=__codelineno-0-420></a>        <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>  <span class=c1># Add verbose attribute</span>
</span><span id=__span-0-421><a id=__codelineno-0-421 name=__codelineno-0-421></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batches_per_chunk</span> <span class=o>=</span> <span class=n>batches_per_chunk</span>  <span class=c1># Add batches_per_chunk attribute</span>
</span><span id=__span-0-422><a id=__codelineno-0-422 name=__codelineno-0-422></a>        <span class=bp>self</span><span class=o>.</span><span class=n>by_fragment</span> <span class=o>=</span> <span class=n>by_fragment</span>  <span class=c1># Add by_fragment attribute</span>
</span><span id=__span-0-423><a id=__codelineno-0-423 name=__codelineno-0-423></a>        <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>  <span class=c1># Add MoS attribute</span>
</span><span id=__span-0-424><a id=__codelineno-0-424 name=__codelineno-0-424></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>  <span class=c1># Add n_scanners attribute</span>
</span><span id=__span-0-425><a id=__codelineno-0-425 name=__codelineno-0-425></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-426><a id=__codelineno-0-426 name=__codelineno-0-426></a>            <span class=n>prefetch_batch_size</span>  <span class=c1># Add prefetch_batch_size attribute</span>
</span><span id=__span-0-427><a id=__codelineno-0-427 name=__codelineno-0-427></a>        <span class=p>)</span>
</span><span id=__span-0-428><a id=__codelineno-0-428 name=__codelineno-0-428></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>  <span class=c1># Add max_queue_size attribute</span>
</span><span id=__span-0-429><a id=__codelineno-0-429 name=__codelineno-0-429></a>        <span class=bp>self</span><span class=o>.</span><span class=n>parallelize_fragment_reads</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-430><a id=__codelineno-0-430 name=__codelineno-0-430></a>            <span class=n>parallelize_fragment_reads</span>  <span class=c1># Add parallelize_fragment_reads attribute</span>
</span><span id=__span-0-431><a id=__codelineno-0-431 name=__codelineno-0-431></a>        <span class=p>)</span>
</span><span id=__span-0-432><a id=__codelineno-0-432 name=__codelineno-0-432></a>
</span><span id=__span-0-433><a id=__codelineno-0-433 name=__codelineno-0-433></a>        <span class=c1># Validate MoS parameters</span>
</span><span id=__span-0-434><a id=__codelineno-0-434 name=__codelineno-0-434></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-435><a id=__codelineno-0-435 name=__codelineno-0-435></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-436><a id=__codelineno-0-436 name=__codelineno-0-436></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners must be at least 1&quot;</span><span class=p>)</span>
</span><span id=__span-0-437><a id=__codelineno-0-437 name=__codelineno-0-437></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span><span id=__span-0-438><a id=__codelineno-0-438 name=__codelineno-0-438></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners cannot exceed 100&quot;</span><span class=p>)</span>
</span><span id=__span-0-439><a id=__codelineno-0-439 name=__codelineno-0-439></a>            <span class=k>if</span> <span class=p>(</span>
</span><span id=__span-0-440><a id=__codelineno-0-440 name=__codelineno-0-440></a>                <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>&lt;</span> <span class=mi>1000</span>
</span><span id=__span-0-441><a id=__codelineno-0-441 name=__codelineno-0-441></a>            <span class=p>):</span>  <span class=c1># Allow smaller values for warm-up strategy</span>
</span><span id=__span-0-442><a id=__codelineno-0-442 name=__codelineno-0-442></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;prefetch_batch_size must be at least 1,000&quot;</span><span class=p>)</span>
</span><span id=__span-0-443><a id=__codelineno-0-443 name=__codelineno-0-443></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>&gt;</span> <span class=mi>10000000</span><span class=p>:</span>
</span><span id=__span-0-444><a id=__codelineno-0-444 name=__codelineno-0-444></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;prefetch_batch_size cannot exceed 10,000,000&quot;</span><span class=p>)</span>
</span><span id=__span-0-445><a id=__codelineno-0-445 name=__codelineno-0-445></a>
</span><span id=__span-0-446><a id=__codelineno-0-446 name=__codelineno-0-446></a>        <span class=c1># Device-agnostic: always return CPU tensors</span>
</span><span id=__span-0-447><a id=__codelineno-0-447 name=__codelineno-0-447></a>        <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-448><a id=__codelineno-0-448 name=__codelineno-0-448></a>
</span><span id=__span-0-449><a id=__codelineno-0-449 name=__codelineno-0-449></a>        <span class=c1># Check that required modules are available</span>
</span><span id=__span-0-450><a id=__codelineno-0-450 name=__codelineno-0-450></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>DATASETS_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-451><a id=__codelineno-0-451 name=__codelineno-0-451></a>            <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span>
</span><span id=__span-0-452><a id=__codelineno-0-452 name=__codelineno-0-452></a>                <span class=s2>&quot;SLAFIterableDataset is required but not available. Please install required dependencies.&quot;</span>
</span><span id=__span-0-453><a id=__codelineno-0-453 name=__codelineno-0-453></a>            <span class=p>)</span>
</span><span id=__span-0-454><a id=__codelineno-0-454 name=__codelineno-0-454></a>
</span><span id=__span-0-455><a id=__codelineno-0-455 name=__codelineno-0-455></a>        <span class=c1># Initialize tokenizer (only needed for non-raw mode)</span>
</span><span id=__span-0-456><a id=__codelineno-0-456 name=__codelineno-0-456></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_mode</span><span class=p>:</span>
</span><span id=__span-0-457><a id=__codelineno-0-457 name=__codelineno-0-457></a>            <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span>
</span><span id=__span-0-458><a id=__codelineno-0-458 name=__codelineno-0-458></a>                <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-459><a id=__codelineno-0-459 name=__codelineno-0-459></a>                <span class=n>tokenizer_type</span><span class=o>=</span><span class=n>tokenizer_type</span><span class=p>,</span>
</span><span id=__span-0-460><a id=__codelineno-0-460 name=__codelineno-0-460></a>                <span class=n>vocab_size</span><span class=o>=</span><span class=n>vocab_size</span><span class=p>,</span>
</span><span id=__span-0-461><a id=__codelineno-0-461 name=__codelineno-0-461></a>                <span class=n>n_expression_bins</span><span class=o>=</span><span class=n>n_expression_bins</span><span class=p>,</span>
</span><span id=__span-0-462><a id=__codelineno-0-462 name=__codelineno-0-462></a>            <span class=p>)</span>
</span><span id=__span-0-463><a id=__codelineno-0-463 name=__codelineno-0-463></a>
</span><span id=__span-0-464><a id=__codelineno-0-464 name=__codelineno-0-464></a>            <span class=c1># Get special tokens from tokenizer</span>
</span><span id=__span-0-465><a id=__codelineno-0-465 name=__codelineno-0-465></a>            <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>special_tokens</span>
</span><span id=__span-0-466><a id=__codelineno-0-466 name=__codelineno-0-466></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-467><a id=__codelineno-0-467 name=__codelineno-0-467></a>            <span class=c1># For raw mode, we don&#39;t need a tokenizer</span>
</span><span id=__span-0-468><a id=__codelineno-0-468 name=__codelineno-0-468></a>            <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-469><a id=__codelineno-0-469 name=__codelineno-0-469></a>            <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-470><a id=__codelineno-0-470 name=__codelineno-0-470></a>
</span><span id=__span-0-471><a id=__codelineno-0-471 name=__codelineno-0-471></a>        <span class=c1># Use IterableDataset</span>
</span><span id=__span-0-472><a id=__codelineno-0-472 name=__codelineno-0-472></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_dataset</span> <span class=o>=</span> <span class=n>SLAFIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-473><a id=__codelineno-0-473 name=__codelineno-0-473></a>            <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-474><a id=__codelineno-0-474 name=__codelineno-0-474></a>            <span class=n>tokenizer</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span><span class=p>,</span>
</span><span id=__span-0-475><a id=__codelineno-0-475 name=__codelineno-0-475></a>            <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-476><a id=__codelineno-0-476 name=__codelineno-0-476></a>            <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>  <span class=c1># TODO: make configurable</span>
</span><span id=__span-0-477><a id=__codelineno-0-477 name=__codelineno-0-477></a>            <span class=n>max_queue_size</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>,</span>  <span class=c1># Pass max_queue_size to dataset</span>
</span><span id=__span-0-478><a id=__codelineno-0-478 name=__codelineno-0-478></a>            <span class=n>tokenizer_type</span><span class=o>=</span><span class=n>tokenizer_type</span><span class=p>,</span>
</span><span id=__span-0-479><a id=__codelineno-0-479 name=__codelineno-0-479></a>            <span class=n>n_epochs</span><span class=o>=</span><span class=n>n_epochs</span><span class=p>,</span>  <span class=c1># Pass n_epochs to dataset</span>
</span><span id=__span-0-480><a id=__codelineno-0-480 name=__codelineno-0-480></a>            <span class=n>raw_mode</span><span class=o>=</span><span class=n>raw_mode</span><span class=p>,</span>  <span class=c1># Pass raw_mode to dataset</span>
</span><span id=__span-0-481><a id=__codelineno-0-481 name=__codelineno-0-481></a>            <span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>,</span>  <span class=c1># Pass verbose to dataset</span>
</span><span id=__span-0-482><a id=__codelineno-0-482 name=__codelineno-0-482></a>            <span class=n>batches_per_chunk</span><span class=o>=</span><span class=n>batches_per_chunk</span><span class=p>,</span>  <span class=c1># Pass batches_per_chunk to dataset</span>
</span><span id=__span-0-483><a id=__codelineno-0-483 name=__codelineno-0-483></a>            <span class=n>by_fragment</span><span class=o>=</span><span class=n>by_fragment</span><span class=p>,</span>  <span class=c1># Pass by_fragment to dataset</span>
</span><span id=__span-0-484><a id=__codelineno-0-484 name=__codelineno-0-484></a>            <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=n>use_mixture_of_scanners</span><span class=p>,</span>  <span class=c1># Pass MoS to dataset</span>
</span><span id=__span-0-485><a id=__codelineno-0-485 name=__codelineno-0-485></a>            <span class=n>n_scanners</span><span class=o>=</span><span class=n>n_scanners</span><span class=p>,</span>  <span class=c1># Pass n_scanners to dataset</span>
</span><span id=__span-0-486><a id=__codelineno-0-486 name=__codelineno-0-486></a>            <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=n>prefetch_batch_size</span><span class=p>,</span>  <span class=c1># Pass prefetch_batch_size to dataset</span>
</span><span id=__span-0-487><a id=__codelineno-0-487 name=__codelineno-0-487></a>            <span class=n>parallelize_fragment_reads</span><span class=o>=</span><span class=n>parallelize_fragment_reads</span><span class=p>,</span>  <span class=c1># Pass parallelize_fragment_reads</span>
</span><span id=__span-0-488><a id=__codelineno-0-488 name=__codelineno-0-488></a>        <span class=p>)</span>
</span><span id=__span-0-489><a id=__codelineno-0-489 name=__codelineno-0-489></a>
</span><span id=__span-0-490><a id=__codelineno-0-490 name=__codelineno-0-490></a>    <span class=k>def</span><span class=w> </span><span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-491><a id=__codelineno-0-491 name=__codelineno-0-491></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-492><a id=__codelineno-0-492 name=__codelineno-0-492></a><span class=sd>        Iterate through batches of single-cell data based on the configured mode.</span>
</span><span id=__span-0-493><a id=__codelineno-0-493 name=__codelineno-0-493></a>
</span><span id=__span-0-494><a id=__codelineno-0-494 name=__codelineno-0-494></a><span class=sd>        Yields batches of data suitable for machine learning training. The output format</span>
</span><span id=__span-0-495><a id=__codelineno-0-495 name=__codelineno-0-495></a><span class=sd>        depends on the configuration:</span>
</span><span id=__span-0-496><a id=__codelineno-0-496 name=__codelineno-0-496></a>
</span><span id=__span-0-497><a id=__codelineno-0-497 name=__codelineno-0-497></a><span class=sd>        - **Tokenized mode** (default): Yields pre-tokenized sequences with attention masks</span>
</span><span id=__span-0-498><a id=__codelineno-0-498 name=__codelineno-0-498></a><span class=sd>        - **Raw mode**: Yields raw Polars DataFrames for external processing</span>
</span><span id=__span-0-499><a id=__codelineno-0-499 name=__codelineno-0-499></a><span class=sd>        - **Multi-epoch**: Automatically handles epoch transitions when n_epochs &gt; 1</span>
</span><span id=__span-0-500><a id=__codelineno-0-500 name=__codelineno-0-500></a>
</span><span id=__span-0-501><a id=__codelineno-0-501 name=__codelineno-0-501></a><span class=sd>        The loading strategy (sequential, fragment-based, or Mixture of Scanners) affects</span>
</span><span id=__span-0-502><a id=__codelineno-0-502 name=__codelineno-0-502></a><span class=sd>        data entropy and throughput but not the output format.</span>
</span><span id=__span-0-503><a id=__codelineno-0-503 name=__codelineno-0-503></a>
</span><span id=__span-0-504><a id=__codelineno-0-504 name=__codelineno-0-504></a><span class=sd>        Yields:</span>
</span><span id=__span-0-505><a id=__codelineno-0-505 name=__codelineno-0-505></a><span class=sd>            dict: Batch dictionary containing:</span>
</span><span id=__span-0-506><a id=__codelineno-0-506 name=__codelineno-0-506></a><span class=sd>                - **Tokenized mode** (raw_mode=False):</span>
</span><span id=__span-0-507><a id=__codelineno-0-507 name=__codelineno-0-507></a><span class=sd>                    - input_ids: Pre-tokenized gene expression data (torch.Tensor)</span>
</span><span id=__span-0-508><a id=__codelineno-0-508 name=__codelineno-0-508></a><span class=sd>                    - attention_mask: Boolean mask indicating valid tokens (torch.Tensor)</span>
</span><span id=__span-0-509><a id=__codelineno-0-509 name=__codelineno-0-509></a><span class=sd>                    - cell_ids: Integer IDs of cells in the batch (torch.Tensor)</span>
</span><span id=__span-0-510><a id=__codelineno-0-510 name=__codelineno-0-510></a><span class=sd>                - **Raw mode** (raw_mode=True):</span>
</span><span id=__span-0-511><a id=__codelineno-0-511 name=__codelineno-0-511></a><span class=sd>                    - x: Raw cell  gene data as Polars DataFrame</span>
</span><span id=__span-0-512><a id=__codelineno-0-512 name=__codelineno-0-512></a><span class=sd>                    - cell_ids: List of cell integer IDs in the batch</span>
</span><span id=__span-0-513><a id=__codelineno-0-513 name=__codelineno-0-513></a><span class=sd>                - **Multi-epoch** (when n_epochs &gt; 1):</span>
</span><span id=__span-0-514><a id=__codelineno-0-514 name=__codelineno-0-514></a><span class=sd>                    - epoch: Current epoch number (int)</span>
</span><span id=__span-0-515><a id=__codelineno-0-515 name=__codelineno-0-515></a>
</span><span id=__span-0-516><a id=__codelineno-0-516 name=__codelineno-0-516></a><span class=sd>        Note:</span>
</span><span id=__span-0-517><a id=__codelineno-0-517 name=__codelineno-0-517></a><span class=sd>            All tensors are returned on CPU for device-agnostic training.</span>
</span><span id=__span-0-518><a id=__codelineno-0-518 name=__codelineno-0-518></a><span class=sd>            The training loop should handle device transfer as needed.</span>
</span><span id=__span-0-519><a id=__codelineno-0-519 name=__codelineno-0-519></a>
</span><span id=__span-0-520><a id=__codelineno-0-520 name=__codelineno-0-520></a><span class=sd>        Raises:</span>
</span><span id=__span-0-521><a id=__codelineno-0-521 name=__codelineno-0-521></a><span class=sd>            ValueError: If the tokenizer type is not supported.</span>
</span><span id=__span-0-522><a id=__codelineno-0-522 name=__codelineno-0-522></a><span class=sd>            RuntimeError: If batch processing fails.</span>
</span><span id=__span-0-523><a id=__codelineno-0-523 name=__codelineno-0-523></a>
</span><span id=__span-0-524><a id=__codelineno-0-524 name=__codelineno-0-524></a><span class=sd>        Examples:</span>
</span><span id=__span-0-525><a id=__codelineno-0-525 name=__codelineno-0-525></a><span class=sd>            &gt;&gt;&gt; # Basic iteration (tokenized mode)</span>
</span><span id=__span-0-526><a id=__codelineno-0-526 name=__codelineno-0-526></a><span class=sd>            &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-527><a id=__codelineno-0-527 name=__codelineno-0-527></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array, batch_size=16)</span>
</span><span id=__span-0-528><a id=__codelineno-0-528 name=__codelineno-0-528></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-529><a id=__codelineno-0-529 name=__codelineno-0-529></a><span class=sd>            ...     print(f&quot;Batch keys: {list(batch.keys())}&quot;)</span>
</span><span id=__span-0-530><a id=__codelineno-0-530 name=__codelineno-0-530></a><span class=sd>            ...     print(f&quot;Input shape: {batch[&#39;input_ids&#39;].shape}&quot;)</span>
</span><span id=__span-0-531><a id=__codelineno-0-531 name=__codelineno-0-531></a><span class=sd>            ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-532><a id=__codelineno-0-532 name=__codelineno-0-532></a><span class=sd>            ...     break</span>
</span><span id=__span-0-533><a id=__codelineno-0-533 name=__codelineno-0-533></a><span class=sd>            Batch keys: [&#39;input_ids&#39;, &#39;attention_mask&#39;, &#39;cell_ids&#39;]</span>
</span><span id=__span-0-534><a id=__codelineno-0-534 name=__codelineno-0-534></a><span class=sd>            Input shape: (16, 2048)</span>
</span><span id=__span-0-535><a id=__codelineno-0-535 name=__codelineno-0-535></a><span class=sd>            Cell IDs: tensor([0, 1, 2, ..., 13, 14, 15])</span>
</span><span id=__span-0-536><a id=__codelineno-0-536 name=__codelineno-0-536></a>
</span><span id=__span-0-537><a id=__codelineno-0-537 name=__codelineno-0-537></a><span class=sd>            &gt;&gt;&gt; # Raw mode iteration</span>
</span><span id=__span-0-538><a id=__codelineno-0-538 name=__codelineno-0-538></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array, raw_mode=True, batch_size=16)</span>
</span><span id=__span-0-539><a id=__codelineno-0-539 name=__codelineno-0-539></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-540><a id=__codelineno-0-540 name=__codelineno-0-540></a><span class=sd>            ...     print(f&quot;Raw data type: {type(batch[&#39;x&#39;])}&quot;)</span>
</span><span id=__span-0-541><a id=__codelineno-0-541 name=__codelineno-0-541></a><span class=sd>            ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-542><a id=__codelineno-0-542 name=__codelineno-0-542></a><span class=sd>            ...     break</span>
</span><span id=__span-0-543><a id=__codelineno-0-543 name=__codelineno-0-543></a><span class=sd>            Raw data type: &lt;class &#39;polars.dataframe.frame.DataFrame&#39;&gt;</span>
</span><span id=__span-0-544><a id=__codelineno-0-544 name=__codelineno-0-544></a><span class=sd>            Cell IDs: [0, 1, 2, ..., 13, 14, 15]</span>
</span><span id=__span-0-545><a id=__codelineno-0-545 name=__codelineno-0-545></a>
</span><span id=__span-0-546><a id=__codelineno-0-546 name=__codelineno-0-546></a><span class=sd>            &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-547><a id=__codelineno-0-547 name=__codelineno-0-547></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array, n_epochs=3)</span>
</span><span id=__span-0-548><a id=__codelineno-0-548 name=__codelineno-0-548></a><span class=sd>            &gt;&gt;&gt; epochs_seen = set()</span>
</span><span id=__span-0-549><a id=__codelineno-0-549 name=__codelineno-0-549></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-550><a id=__codelineno-0-550 name=__codelineno-0-550></a><span class=sd>            ...     if &#39;epoch&#39; in batch:</span>
</span><span id=__span-0-551><a id=__codelineno-0-551 name=__codelineno-0-551></a><span class=sd>            ...         epochs_seen.add(batch[&#39;epoch&#39;])</span>
</span><span id=__span-0-552><a id=__codelineno-0-552 name=__codelineno-0-552></a><span class=sd>            ...     if len(epochs_seen) &gt;= 3:  # Stop after seeing all epochs</span>
</span><span id=__span-0-553><a id=__codelineno-0-553 name=__codelineno-0-553></a><span class=sd>            ...         break</span>
</span><span id=__span-0-554><a id=__codelineno-0-554 name=__codelineno-0-554></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Epochs completed: {sorted(epochs_seen)}&quot;)</span>
</span><span id=__span-0-555><a id=__codelineno-0-555 name=__codelineno-0-555></a><span class=sd>            Epochs completed: [0, 1, 2]</span>
</span><span id=__span-0-556><a id=__codelineno-0-556 name=__codelineno-0-556></a>
</span><span id=__span-0-557><a id=__codelineno-0-557 name=__codelineno-0-557></a><span class=sd>            &gt;&gt;&gt; # Training loop with error handling</span>
</span><span id=__span-0-558><a id=__codelineno-0-558 name=__codelineno-0-558></a><span class=sd>            &gt;&gt;&gt; for batch_idx, batch in enumerate(dataloader):</span>
</span><span id=__span-0-559><a id=__codelineno-0-559 name=__codelineno-0-559></a><span class=sd>            ...     try:</span>
</span><span id=__span-0-560><a id=__codelineno-0-560 name=__codelineno-0-560></a><span class=sd>            ...         if &#39;input_ids&#39; in batch:  # Tokenized mode</span>
</span><span id=__span-0-561><a id=__codelineno-0-561 name=__codelineno-0-561></a><span class=sd>            ...             input_ids = batch[&quot;input_ids&quot;]</span>
</span><span id=__span-0-562><a id=__codelineno-0-562 name=__codelineno-0-562></a><span class=sd>            ...             attention_mask = batch[&quot;attention_mask&quot;]</span>
</span><span id=__span-0-563><a id=__codelineno-0-563 name=__codelineno-0-563></a><span class=sd>            ...             cell_ids = batch[&quot;cell_ids&quot;]</span>
</span><span id=__span-0-564><a id=__codelineno-0-564 name=__codelineno-0-564></a><span class=sd>            ...         else:  # Raw mode</span>
</span><span id=__span-0-565><a id=__codelineno-0-565 name=__codelineno-0-565></a><span class=sd>            ...             x = batch[&quot;x&quot;]</span>
</span><span id=__span-0-566><a id=__codelineno-0-566 name=__codelineno-0-566></a><span class=sd>            ...             cell_ids = batch[&quot;cell_ids&quot;]</span>
</span><span id=__span-0-567><a id=__codelineno-0-567 name=__codelineno-0-567></a><span class=sd>            ...         # Your training code here</span>
</span><span id=__span-0-568><a id=__codelineno-0-568 name=__codelineno-0-568></a><span class=sd>            ...         print(f&quot;Processed batch {batch_idx}&quot;)</span>
</span><span id=__span-0-569><a id=__codelineno-0-569 name=__codelineno-0-569></a><span class=sd>            ...     except Exception as e:</span>
</span><span id=__span-0-570><a id=__codelineno-0-570 name=__codelineno-0-570></a><span class=sd>            ...         print(f&quot;Error in batch {batch_idx}: {e}&quot;)</span>
</span><span id=__span-0-571><a id=__codelineno-0-571 name=__codelineno-0-571></a><span class=sd>            ...         continue</span>
</span><span id=__span-0-572><a id=__codelineno-0-572 name=__codelineno-0-572></a><span class=sd>            ...     if batch_idx &gt;= 2:  # Just first few batches</span>
</span><span id=__span-0-573><a id=__codelineno-0-573 name=__codelineno-0-573></a><span class=sd>            ...         break</span>
</span><span id=__span-0-574><a id=__codelineno-0-574 name=__codelineno-0-574></a><span class=sd>            Processed batch 0</span>
</span><span id=__span-0-575><a id=__codelineno-0-575 name=__codelineno-0-575></a><span class=sd>            Processed batch 1</span>
</span><span id=__span-0-576><a id=__codelineno-0-576 name=__codelineno-0-576></a><span class=sd>            Processed batch 2</span>
</span><span id=__span-0-577><a id=__codelineno-0-577 name=__codelineno-0-577></a>
</span><span id=__span-0-578><a id=__codelineno-0-578 name=__codelineno-0-578></a><span class=sd>            &gt;&gt;&gt; # Different tokenizer types</span>
</span><span id=__span-0-579><a id=__codelineno-0-579 name=__codelineno-0-579></a><span class=sd>            &gt;&gt;&gt; dataloader_geneformer = SLAFDataLoader(slaf_array, tokenizer_type=&quot;geneformer&quot;)</span>
</span><span id=__span-0-580><a id=__codelineno-0-580 name=__codelineno-0-580></a><span class=sd>            &gt;&gt;&gt; dataloader_scgpt = SLAFDataLoader(slaf_array, tokenizer_type=&quot;scgpt&quot;)</span>
</span><span id=__span-0-581><a id=__codelineno-0-581 name=__codelineno-0-581></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-582><a id=__codelineno-0-582 name=__codelineno-0-582></a><span class=sd>            &gt;&gt;&gt; # Compare batch shapes</span>
</span><span id=__span-0-583><a id=__codelineno-0-583 name=__codelineno-0-583></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader_geneformer:</span>
</span><span id=__span-0-584><a id=__codelineno-0-584 name=__codelineno-0-584></a><span class=sd>            ...     print(f&quot;Geneformer input shape: {batch[&#39;input_ids&#39;].shape}&quot;)</span>
</span><span id=__span-0-585><a id=__codelineno-0-585 name=__codelineno-0-585></a><span class=sd>            ...     break</span>
</span><span id=__span-0-586><a id=__codelineno-0-586 name=__codelineno-0-586></a><span class=sd>            Geneformer input shape: (32, 2048)</span>
</span><span id=__span-0-587><a id=__codelineno-0-587 name=__codelineno-0-587></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader_scgpt:</span>
</span><span id=__span-0-588><a id=__codelineno-0-588 name=__codelineno-0-588></a><span class=sd>            ...     print(f&quot;scGPT input shape: {batch[&#39;input_ids&#39;].shape}&quot;)</span>
</span><span id=__span-0-589><a id=__codelineno-0-589 name=__codelineno-0-589></a><span class=sd>            ...     break</span>
</span><span id=__span-0-590><a id=__codelineno-0-590 name=__codelineno-0-590></a><span class=sd>            scGPT input shape: (32, 1024)</span>
</span><span id=__span-0-591><a id=__codelineno-0-591 name=__codelineno-0-591></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-592><a id=__codelineno-0-592 name=__codelineno-0-592></a>        <span class=k>yield from</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dataset</span>
</span><span id=__span-0-593><a id=__codelineno-0-593 name=__codelineno-0-593></a>
</span><span id=__span-0-594><a id=__codelineno-0-594 name=__codelineno-0-594></a>    <span class=k>def</span><span class=w> </span><span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-595><a id=__codelineno-0-595 name=__codelineno-0-595></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-596><a id=__codelineno-0-596 name=__codelineno-0-596></a><span class=sd>        Return the number of batches in the dataset.</span>
</span><span id=__span-0-597><a id=__codelineno-0-597 name=__codelineno-0-597></a>
</span><span id=__span-0-598><a id=__codelineno-0-598 name=__codelineno-0-598></a><span class=sd>        Note: Since SLAFDataLoader uses an IterableDataset that streams data,</span>
</span><span id=__span-0-599><a id=__codelineno-0-599 name=__codelineno-0-599></a><span class=sd>        the exact number of batches is not known in advance. This method</span>
</span><span id=__span-0-600><a id=__codelineno-0-600 name=__codelineno-0-600></a><span class=sd>        returns 0 to indicate an unknown length for streaming datasets.</span>
</span><span id=__span-0-601><a id=__codelineno-0-601 name=__codelineno-0-601></a>
</span><span id=__span-0-602><a id=__codelineno-0-602 name=__codelineno-0-602></a><span class=sd>        Returns:</span>
</span><span id=__span-0-603><a id=__codelineno-0-603 name=__codelineno-0-603></a><span class=sd>            int: Always returns 0 to indicate unknown length for streaming datasets.</span>
</span><span id=__span-0-604><a id=__codelineno-0-604 name=__codelineno-0-604></a>
</span><span id=__span-0-605><a id=__codelineno-0-605 name=__codelineno-0-605></a><span class=sd>        Examples:</span>
</span><span id=__span-0-606><a id=__codelineno-0-606 name=__codelineno-0-606></a><span class=sd>            &gt;&gt;&gt; # Check dataset length</span>
</span><span id=__span-0-607><a id=__codelineno-0-607 name=__codelineno-0-607></a><span class=sd>            &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-608><a id=__codelineno-0-608 name=__codelineno-0-608></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array)</span>
</span><span id=__span-0-609><a id=__codelineno-0-609 name=__codelineno-0-609></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Dataset length: {len(dataloader)}&quot;)</span>
</span><span id=__span-0-610><a id=__codelineno-0-610 name=__codelineno-0-610></a><span class=sd>            Dataset length: 0</span>
</span><span id=__span-0-611><a id=__codelineno-0-611 name=__codelineno-0-611></a>
</span><span id=__span-0-612><a id=__codelineno-0-612 name=__codelineno-0-612></a><span class=sd>            &gt;&gt;&gt; # IterableDataset behavior</span>
</span><span id=__span-0-613><a id=__codelineno-0-613 name=__codelineno-0-613></a><span class=sd>            &gt;&gt;&gt; batch_count = 0</span>
</span><span id=__span-0-614><a id=__codelineno-0-614 name=__codelineno-0-614></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-615><a id=__codelineno-0-615 name=__codelineno-0-615></a><span class=sd>            ...     batch_count += 1</span>
</span><span id=__span-0-616><a id=__codelineno-0-616 name=__codelineno-0-616></a><span class=sd>            ...     if batch_count &gt;= 5:  # Just count first 5 batches</span>
</span><span id=__span-0-617><a id=__codelineno-0-617 name=__codelineno-0-617></a><span class=sd>            ...         break</span>
</span><span id=__span-0-618><a id=__codelineno-0-618 name=__codelineno-0-618></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Actually processed {batch_count} batches&quot;)</span>
</span><span id=__span-0-619><a id=__codelineno-0-619 name=__codelineno-0-619></a><span class=sd>            Actually processed 5 batches</span>
</span><span id=__span-0-620><a id=__codelineno-0-620 name=__codelineno-0-620></a>
</span><span id=__span-0-621><a id=__codelineno-0-621 name=__codelineno-0-621></a><span class=sd>            &gt;&gt;&gt; # Length is consistent</span>
</span><span id=__span-0-622><a id=__codelineno-0-622 name=__codelineno-0-622></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Length check: {len(dataloader)}&quot;)</span>
</span><span id=__span-0-623><a id=__codelineno-0-623 name=__codelineno-0-623></a><span class=sd>            Length check: 0</span>
</span><span id=__span-0-624><a id=__codelineno-0-624 name=__codelineno-0-624></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-625><a id=__codelineno-0-625 name=__codelineno-0-625></a>        <span class=k>return</span> <span class=mi>0</span>  <span class=c1># Indicates unknown length</span>
</span><span id=__span-0-626><a id=__codelineno-0-626 name=__codelineno-0-626></a>
</span><span id=__span-0-627><a id=__codelineno-0-627 name=__codelineno-0-627></a>    <span class=k>def</span><span class=w> </span><span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-628><a id=__codelineno-0-628 name=__codelineno-0-628></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-629><a id=__codelineno-0-629 name=__codelineno-0-629></a><span class=sd>        Cleanup method to stop async prefetching.</span>
</span><span id=__span-0-630><a id=__codelineno-0-630 name=__codelineno-0-630></a>
</span><span id=__span-0-631><a id=__codelineno-0-631 name=__codelineno-0-631></a><span class=sd>        This method is called when the DataLoader object is garbage collected.</span>
</span><span id=__span-0-632><a id=__codelineno-0-632 name=__codelineno-0-632></a><span class=sd>        It ensures that the underlying dataset&#39;s prefetcher is properly cleaned up</span>
</span><span id=__span-0-633><a id=__codelineno-0-633 name=__codelineno-0-633></a><span class=sd>        to prevent resource leaks.</span>
</span><span id=__span-0-634><a id=__codelineno-0-634 name=__codelineno-0-634></a>
</span><span id=__span-0-635><a id=__codelineno-0-635 name=__codelineno-0-635></a><span class=sd>        Examples:</span>
</span><span id=__span-0-636><a id=__codelineno-0-636 name=__codelineno-0-636></a><span class=sd>            &gt;&gt;&gt; # DataLoader cleanup happens automatically</span>
</span><span id=__span-0-637><a id=__codelineno-0-637 name=__codelineno-0-637></a><span class=sd>            &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-638><a id=__codelineno-0-638 name=__codelineno-0-638></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array)</span>
</span><span id=__span-0-639><a id=__codelineno-0-639 name=__codelineno-0-639></a><span class=sd>            &gt;&gt;&gt; print(&quot;DataLoader created&quot;)</span>
</span><span id=__span-0-640><a id=__codelineno-0-640 name=__codelineno-0-640></a><span class=sd>            DataLoader created</span>
</span><span id=__span-0-641><a id=__codelineno-0-641 name=__codelineno-0-641></a><span class=sd>            &gt;&gt;&gt; # When dataloader goes out of scope, __del__ is called automatically</span>
</span><span id=__span-0-642><a id=__codelineno-0-642 name=__codelineno-0-642></a><span class=sd>            &gt;&gt;&gt; del dataloader</span>
</span><span id=__span-0-643><a id=__codelineno-0-643 name=__codelineno-0-643></a><span class=sd>            &gt;&gt;&gt; print(&quot;DataLoader destroyed and cleaned up&quot;)</span>
</span><span id=__span-0-644><a id=__codelineno-0-644 name=__codelineno-0-644></a><span class=sd>            DataLoader destroyed and cleaned up</span>
</span><span id=__span-0-645><a id=__codelineno-0-645 name=__codelineno-0-645></a>
</span><span id=__span-0-646><a id=__codelineno-0-646 name=__codelineno-0-646></a><span class=sd>            &gt;&gt;&gt; # Manual cleanup (not usually needed)</span>
</span><span id=__span-0-647><a id=__codelineno-0-647 name=__codelineno-0-647></a><span class=sd>            &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array)</span>
</span><span id=__span-0-648><a id=__codelineno-0-648 name=__codelineno-0-648></a><span class=sd>            &gt;&gt;&gt; dataloader.__del__()</span>
</span><span id=__span-0-649><a id=__codelineno-0-649 name=__codelineno-0-649></a><span class=sd>            &gt;&gt;&gt; print(&quot;Manual cleanup completed&quot;)</span>
</span><span id=__span-0-650><a id=__codelineno-0-650 name=__codelineno-0-650></a><span class=sd>            Manual cleanup completed</span>
</span><span id=__span-0-651><a id=__codelineno-0-651 name=__codelineno-0-651></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-652><a id=__codelineno-0-652 name=__codelineno-0-652></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_dataset&quot;</span><span class=p>):</span>
</span><span id=__span-0-653><a id=__codelineno-0-653 name=__codelineno-0-653></a>            <span class=c1># The SLAFIterableDataset doesn&#39;t have a stop method,</span>
</span><span id=__span-0-654><a id=__codelineno-0-654 name=__codelineno-0-654></a>            <span class=c1># so we just let it finish its current epoch.</span>
</span><span id=__span-0-655><a id=__codelineno-0-655 name=__codelineno-0-655></a>            <span class=k>pass</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <h5 id=slaf.ml.dataloaders.SLAFDataLoader-functions>Functions<a href=#slaf.ml.dataloaders.SLAFDataLoader-functions class=headerlink title="Permanent link">&para;</a></h5> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.dataloaders.SLAFDataLoader.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>:</span> <span class=n>SLAFArray</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s1>&#39;geneformer&#39;</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span> <span class=n>max_genes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2048</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span> <span class=n>n_expression_bins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span> <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>raw_mode</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>batches_per_chunk</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>by_fragment</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>16</span><span class=p>,</span> <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>4194304</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5000</span><span class=p>,</span> <span class=n>parallelize_fragment_reads</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>)</span></code> <a href=#slaf.ml.dataloaders.SLAFDataLoader.__init__ class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Initialize the SLAF DataLoader with training configuration.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>slaf_array</code> </td> <td> <code><a class="autorefs autorefs-internal" title=slaf.core.slaf.SLAFArray href=../core/#slaf.core.slaf.SLAFArray>SLAFArray</a></code> </td> <td> <div class=doc-md-description> <p>SLAFArray instance containing the single-cell data. Must be a valid SLAFArray with proper Lance dataset structure.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tokenizer_type</code> </td> <td> <code><span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>Tokenization strategy to use. Options: "geneformer", "scgpt". Geneformer uses ranked gene sequences, scGPT uses interleaved gene-expression pairs. Ignored when raw_mode=True.</p> </div> </td> <td> <code>&#39;geneformer&#39;</code> </td> </tr> <tr class=doc-section-item> <td> <code>max_genes</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Maximum number of genes to include in each cell's tokenization. For Geneformer: same as sequence length. For scGPT: number of gene-expression pairs (sequence length = 2*max_genes+2).</p> </div> </td> <td> <code>2048</code> </td> </tr> <tr class=doc-section-item> <td> <code>vocab_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Size of the tokenizer vocabulary. Higher values allow more genes but use more memory. Range: 1000-100000, default: 50000.</p> </div> </td> <td> <code>50000</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_expression_bins</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of expression level bins for scGPT discretization. Higher values provide finer expression resolution. Range: 1-1000, default: 10.</p> </div> </td> <td> <code>10</code> </td> </tr> <tr class=doc-section-item> <td> <code>batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells per batch. Larger batches use more memory but may improve training efficiency. Range: 1-512, default: 32.</p> </div> </td> <td> <code>32</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_epochs</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of epochs to run. The generator will automatically reset after each epoch, enabling multi-epoch training on small datasets. Default: 1.</p> </div> </td> <td> <code>1</code> </td> </tr> <tr class=doc-section-item> <td> <code>raw_mode</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, return raw cell  gene data as Polars DataFrames instead of pre-tokenized sequences. This bypasses tokenization and windowing for maximum flexibility. Default: False.</p> </div> </td> <td> <code>False</code> </td> </tr> <tr class=doc-section-item> <td> <code>batches_per_chunk</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of Lance batches to load per chunk for sequential loading. Higher values use more memory but may improve throughput. Range: 1-200, default: 1 (optimized for MoS). Only used when by_fragment=False.</p> </div> </td> <td> <code>1</code> </td> </tr> <tr class=doc-section-item> <td> <code>by_fragment</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, use fragment-based loading instead of batch-based loading. Fragment-based loading provides higher entropy but may be slightly slower. Automatically enabled when use_mixture_of_scanners=True. Default: True (enabled for MoS).</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>use_mixture_of_scanners</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, use mixture of scanners (MoS) approach for higher entropy by randomly sampling from multiple fragment generators. This provides the best randomization and is now the default for foundation model training. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_scanners</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of fragment generators to sample from simultaneously when using MoS. Higher values provide better entropy but use more memory. Range: 1-100, default: 16. Only used when use_mixture_of_scanners=True.</p> </div> </td> <td> <code>16</code> </td> </tr> <tr class=doc-section-item> <td> <code>prefetch_batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Target number of rows to load per prefetch batch when using MoS. Higher values improve throughput but use more memory. Range: 1000-10000000, default: 4194304. Only used when use_mixture_of_scanners=True.</p> </div> </td> <td> <code>4194304</code> </td> </tr> <tr class=doc-section-item> <td> <code>parallelize_fragment_reads</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>Whether to parallelize fragment reads in MoS mode. Critical for cloud scenarios where network latency dominates (can improve throughput 10-30x). For local data, sequential reads are typically more efficient as parallelization adds overhead without benefit. Default: False. Only used when use_mixture_of_scanners=True.</p> </div> </td> <td> <code>False</code> </td> </tr> <tr class=doc-section-item> <td> <code>verbose</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, print detailed timing and progress information. If False, suppress all SLAF internal prints for clean output. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If tokenizer_type is not supported or parameters are invalid.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=RuntimeError>RuntimeError</span></code> </td> <td> <div class=doc-md-description> <p>If PyTorch is not available or datasets module is missing.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=TypeError>TypeError</span></code> </td> <td> <div class=doc-md-description> <p>If slaf_array is not a valid SLAFArray instance.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=ImportError>ImportError</span></code> </td> <td> <div class=doc-md-description> <p>If required dependencies are not available.</p> </div> </td> </tr> </tbody> </table> <details class=loading-strategy-selection-guide open> <summary>Loading Strategy Selection Guide</summary> <ul> <li>For foundation model training: Use default settings (MoS provides 88% random entropy)</li> <li>For cloud data: Enable parallelize_fragment_reads=True for 10-30x throughput improvement</li> <li>For local data: Keep parallelize_fragment_reads=False (sequential reads are more efficient)</li> <li>For maximum throughput: Set use_mixture_of_scanners=False, by_fragment=False</li> <li>For external processing: Set raw_mode=True</li> </ul> </details> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic initialization (MoS is now default)</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>SLAFArray</span><span class=p>(</span><span class=s2>&quot;path/to/data.slaf&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch size: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>batch_size</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=go>Batch size: 32</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>MoS enabled: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>by_fragment</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sequential loading: </span><span class=si>{</span><span class=ow>not</span><span class=w> </span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Sequential loading: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Fragment-based loading for higher entropy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>by_fragment</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Fragment-based loading: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>by_fragment</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Fragment-based loading: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Raw mode for external processing</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>raw_mode</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Raw mode: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>raw_mode</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Raw mode: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Cloud data optimization: parallelize fragment reads</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>parallelize_fragment_reads</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>  <span class=c1># Critical for accelerating cloud data loading</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batches_per_chunk</span><span class=o>=</span><span class=mi>16</span><span class=p>,</span>  <span class=c1># Combine with higher batches_per_chunk for best results</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Parallel fragment reads: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>parallelize_fragment_reads</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Parallel fragment reads: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Error handling for invalid parameters</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>dataloader</span> <span class=o>=</span> <span class=n>SLAFDataLoader</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>,</span> <span class=n>n_scanners</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span><span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Error: n_scanners must be at least 1</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-268>268</a></span>
<span class=normal><a href=#__codelineno-0-269>269</a></span>
<span class=normal><a href=#__codelineno-0-270>270</a></span>
<span class=normal><a href=#__codelineno-0-271>271</a></span>
<span class=normal><a href=#__codelineno-0-272>272</a></span>
<span class=normal><a href=#__codelineno-0-273>273</a></span>
<span class=normal><a href=#__codelineno-0-274>274</a></span>
<span class=normal><a href=#__codelineno-0-275>275</a></span>
<span class=normal><a href=#__codelineno-0-276>276</a></span>
<span class=normal><a href=#__codelineno-0-277>277</a></span>
<span class=normal><a href=#__codelineno-0-278>278</a></span>
<span class=normal><a href=#__codelineno-0-279>279</a></span>
<span class=normal><a href=#__codelineno-0-280>280</a></span>
<span class=normal><a href=#__codelineno-0-281>281</a></span>
<span class=normal><a href=#__codelineno-0-282>282</a></span>
<span class=normal><a href=#__codelineno-0-283>283</a></span>
<span class=normal><a href=#__codelineno-0-284>284</a></span>
<span class=normal><a href=#__codelineno-0-285>285</a></span>
<span class=normal><a href=#__codelineno-0-286>286</a></span>
<span class=normal><a href=#__codelineno-0-287>287</a></span>
<span class=normal><a href=#__codelineno-0-288>288</a></span>
<span class=normal><a href=#__codelineno-0-289>289</a></span>
<span class=normal><a href=#__codelineno-0-290>290</a></span>
<span class=normal><a href=#__codelineno-0-291>291</a></span>
<span class=normal><a href=#__codelineno-0-292>292</a></span>
<span class=normal><a href=#__codelineno-0-293>293</a></span>
<span class=normal><a href=#__codelineno-0-294>294</a></span>
<span class=normal><a href=#__codelineno-0-295>295</a></span>
<span class=normal><a href=#__codelineno-0-296>296</a></span>
<span class=normal><a href=#__codelineno-0-297>297</a></span>
<span class=normal><a href=#__codelineno-0-298>298</a></span>
<span class=normal><a href=#__codelineno-0-299>299</a></span>
<span class=normal><a href=#__codelineno-0-300>300</a></span>
<span class=normal><a href=#__codelineno-0-301>301</a></span>
<span class=normal><a href=#__codelineno-0-302>302</a></span>
<span class=normal><a href=#__codelineno-0-303>303</a></span>
<span class=normal><a href=#__codelineno-0-304>304</a></span>
<span class=normal><a href=#__codelineno-0-305>305</a></span>
<span class=normal><a href=#__codelineno-0-306>306</a></span>
<span class=normal><a href=#__codelineno-0-307>307</a></span>
<span class=normal><a href=#__codelineno-0-308>308</a></span>
<span class=normal><a href=#__codelineno-0-309>309</a></span>
<span class=normal><a href=#__codelineno-0-310>310</a></span>
<span class=normal><a href=#__codelineno-0-311>311</a></span>
<span class=normal><a href=#__codelineno-0-312>312</a></span>
<span class=normal><a href=#__codelineno-0-313>313</a></span>
<span class=normal><a href=#__codelineno-0-314>314</a></span>
<span class=normal><a href=#__codelineno-0-315>315</a></span>
<span class=normal><a href=#__codelineno-0-316>316</a></span>
<span class=normal><a href=#__codelineno-0-317>317</a></span>
<span class=normal><a href=#__codelineno-0-318>318</a></span>
<span class=normal><a href=#__codelineno-0-319>319</a></span>
<span class=normal><a href=#__codelineno-0-320>320</a></span>
<span class=normal><a href=#__codelineno-0-321>321</a></span>
<span class=normal><a href=#__codelineno-0-322>322</a></span>
<span class=normal><a href=#__codelineno-0-323>323</a></span>
<span class=normal><a href=#__codelineno-0-324>324</a></span>
<span class=normal><a href=#__codelineno-0-325>325</a></span>
<span class=normal><a href=#__codelineno-0-326>326</a></span>
<span class=normal><a href=#__codelineno-0-327>327</a></span>
<span class=normal><a href=#__codelineno-0-328>328</a></span>
<span class=normal><a href=#__codelineno-0-329>329</a></span>
<span class=normal><a href=#__codelineno-0-330>330</a></span>
<span class=normal><a href=#__codelineno-0-331>331</a></span>
<span class=normal><a href=#__codelineno-0-332>332</a></span>
<span class=normal><a href=#__codelineno-0-333>333</a></span>
<span class=normal><a href=#__codelineno-0-334>334</a></span>
<span class=normal><a href=#__codelineno-0-335>335</a></span>
<span class=normal><a href=#__codelineno-0-336>336</a></span>
<span class=normal><a href=#__codelineno-0-337>337</a></span>
<span class=normal><a href=#__codelineno-0-338>338</a></span>
<span class=normal><a href=#__codelineno-0-339>339</a></span>
<span class=normal><a href=#__codelineno-0-340>340</a></span>
<span class=normal><a href=#__codelineno-0-341>341</a></span>
<span class=normal><a href=#__codelineno-0-342>342</a></span>
<span class=normal><a href=#__codelineno-0-343>343</a></span>
<span class=normal><a href=#__codelineno-0-344>344</a></span>
<span class=normal><a href=#__codelineno-0-345>345</a></span>
<span class=normal><a href=#__codelineno-0-346>346</a></span>
<span class=normal><a href=#__codelineno-0-347>347</a></span>
<span class=normal><a href=#__codelineno-0-348>348</a></span>
<span class=normal><a href=#__codelineno-0-349>349</a></span>
<span class=normal><a href=#__codelineno-0-350>350</a></span>
<span class=normal><a href=#__codelineno-0-351>351</a></span>
<span class=normal><a href=#__codelineno-0-352>352</a></span>
<span class=normal><a href=#__codelineno-0-353>353</a></span>
<span class=normal><a href=#__codelineno-0-354>354</a></span>
<span class=normal><a href=#__codelineno-0-355>355</a></span>
<span class=normal><a href=#__codelineno-0-356>356</a></span>
<span class=normal><a href=#__codelineno-0-357>357</a></span>
<span class=normal><a href=#__codelineno-0-358>358</a></span>
<span class=normal><a href=#__codelineno-0-359>359</a></span>
<span class=normal><a href=#__codelineno-0-360>360</a></span>
<span class=normal><a href=#__codelineno-0-361>361</a></span>
<span class=normal><a href=#__codelineno-0-362>362</a></span>
<span class=normal><a href=#__codelineno-0-363>363</a></span>
<span class=normal><a href=#__codelineno-0-364>364</a></span>
<span class=normal><a href=#__codelineno-0-365>365</a></span>
<span class=normal><a href=#__codelineno-0-366>366</a></span>
<span class=normal><a href=#__codelineno-0-367>367</a></span>
<span class=normal><a href=#__codelineno-0-368>368</a></span>
<span class=normal><a href=#__codelineno-0-369>369</a></span>
<span class=normal><a href=#__codelineno-0-370>370</a></span>
<span class=normal><a href=#__codelineno-0-371>371</a></span>
<span class=normal><a href=#__codelineno-0-372>372</a></span>
<span class=normal><a href=#__codelineno-0-373>373</a></span>
<span class=normal><a href=#__codelineno-0-374>374</a></span>
<span class=normal><a href=#__codelineno-0-375>375</a></span>
<span class=normal><a href=#__codelineno-0-376>376</a></span>
<span class=normal><a href=#__codelineno-0-377>377</a></span>
<span class=normal><a href=#__codelineno-0-378>378</a></span>
<span class=normal><a href=#__codelineno-0-379>379</a></span>
<span class=normal><a href=#__codelineno-0-380>380</a></span>
<span class=normal><a href=#__codelineno-0-381>381</a></span>
<span class=normal><a href=#__codelineno-0-382>382</a></span>
<span class=normal><a href=#__codelineno-0-383>383</a></span>
<span class=normal><a href=#__codelineno-0-384>384</a></span>
<span class=normal><a href=#__codelineno-0-385>385</a></span>
<span class=normal><a href=#__codelineno-0-386>386</a></span>
<span class=normal><a href=#__codelineno-0-387>387</a></span>
<span class=normal><a href=#__codelineno-0-388>388</a></span>
<span class=normal><a href=#__codelineno-0-389>389</a></span>
<span class=normal><a href=#__codelineno-0-390>390</a></span>
<span class=normal><a href=#__codelineno-0-391>391</a></span>
<span class=normal><a href=#__codelineno-0-392>392</a></span>
<span class=normal><a href=#__codelineno-0-393>393</a></span>
<span class=normal><a href=#__codelineno-0-394>394</a></span>
<span class=normal><a href=#__codelineno-0-395>395</a></span>
<span class=normal><a href=#__codelineno-0-396>396</a></span>
<span class=normal><a href=#__codelineno-0-397>397</a></span>
<span class=normal><a href=#__codelineno-0-398>398</a></span>
<span class=normal><a href=#__codelineno-0-399>399</a></span>
<span class=normal><a href=#__codelineno-0-400>400</a></span>
<span class=normal><a href=#__codelineno-0-401>401</a></span>
<span class=normal><a href=#__codelineno-0-402>402</a></span>
<span class=normal><a href=#__codelineno-0-403>403</a></span>
<span class=normal><a href=#__codelineno-0-404>404</a></span>
<span class=normal><a href=#__codelineno-0-405>405</a></span>
<span class=normal><a href=#__codelineno-0-406>406</a></span>
<span class=normal><a href=#__codelineno-0-407>407</a></span>
<span class=normal><a href=#__codelineno-0-408>408</a></span>
<span class=normal><a href=#__codelineno-0-409>409</a></span>
<span class=normal><a href=#__codelineno-0-410>410</a></span>
<span class=normal><a href=#__codelineno-0-411>411</a></span>
<span class=normal><a href=#__codelineno-0-412>412</a></span>
<span class=normal><a href=#__codelineno-0-413>413</a></span>
<span class=normal><a href=#__codelineno-0-414>414</a></span>
<span class=normal><a href=#__codelineno-0-415>415</a></span>
<span class=normal><a href=#__codelineno-0-416>416</a></span>
<span class=normal><a href=#__codelineno-0-417>417</a></span>
<span class=normal><a href=#__codelineno-0-418>418</a></span>
<span class=normal><a href=#__codelineno-0-419>419</a></span>
<span class=normal><a href=#__codelineno-0-420>420</a></span>
<span class=normal><a href=#__codelineno-0-421>421</a></span>
<span class=normal><a href=#__codelineno-0-422>422</a></span>
<span class=normal><a href=#__codelineno-0-423>423</a></span>
<span class=normal><a href=#__codelineno-0-424>424</a></span>
<span class=normal><a href=#__codelineno-0-425>425</a></span>
<span class=normal><a href=#__codelineno-0-426>426</a></span>
<span class=normal><a href=#__codelineno-0-427>427</a></span>
<span class=normal><a href=#__codelineno-0-428>428</a></span>
<span class=normal><a href=#__codelineno-0-429>429</a></span>
<span class=normal><a href=#__codelineno-0-430>430</a></span>
<span class=normal><a href=#__codelineno-0-431>431</a></span>
<span class=normal><a href=#__codelineno-0-432>432</a></span>
<span class=normal><a href=#__codelineno-0-433>433</a></span>
<span class=normal><a href=#__codelineno-0-434>434</a></span>
<span class=normal><a href=#__codelineno-0-435>435</a></span>
<span class=normal><a href=#__codelineno-0-436>436</a></span>
<span class=normal><a href=#__codelineno-0-437>437</a></span>
<span class=normal><a href=#__codelineno-0-438>438</a></span>
<span class=normal><a href=#__codelineno-0-439>439</a></span>
<span class=normal><a href=#__codelineno-0-440>440</a></span>
<span class=normal><a href=#__codelineno-0-441>441</a></span>
<span class=normal><a href=#__codelineno-0-442>442</a></span>
<span class=normal><a href=#__codelineno-0-443>443</a></span>
<span class=normal><a href=#__codelineno-0-444>444</a></span>
<span class=normal><a href=#__codelineno-0-445>445</a></span>
<span class=normal><a href=#__codelineno-0-446>446</a></span>
<span class=normal><a href=#__codelineno-0-447>447</a></span>
<span class=normal><a href=#__codelineno-0-448>448</a></span>
<span class=normal><a href=#__codelineno-0-449>449</a></span>
<span class=normal><a href=#__codelineno-0-450>450</a></span>
<span class=normal><a href=#__codelineno-0-451>451</a></span>
<span class=normal><a href=#__codelineno-0-452>452</a></span>
<span class=normal><a href=#__codelineno-0-453>453</a></span>
<span class=normal><a href=#__codelineno-0-454>454</a></span>
<span class=normal><a href=#__codelineno-0-455>455</a></span>
<span class=normal><a href=#__codelineno-0-456>456</a></span>
<span class=normal><a href=#__codelineno-0-457>457</a></span>
<span class=normal><a href=#__codelineno-0-458>458</a></span>
<span class=normal><a href=#__codelineno-0-459>459</a></span>
<span class=normal><a href=#__codelineno-0-460>460</a></span>
<span class=normal><a href=#__codelineno-0-461>461</a></span>
<span class=normal><a href=#__codelineno-0-462>462</a></span>
<span class=normal><a href=#__codelineno-0-463>463</a></span>
<span class=normal><a href=#__codelineno-0-464>464</a></span>
<span class=normal><a href=#__codelineno-0-465>465</a></span>
<span class=normal><a href=#__codelineno-0-466>466</a></span>
<span class=normal><a href=#__codelineno-0-467>467</a></span>
<span class=normal><a href=#__codelineno-0-468>468</a></span>
<span class=normal><a href=#__codelineno-0-469>469</a></span>
<span class=normal><a href=#__codelineno-0-470>470</a></span>
<span class=normal><a href=#__codelineno-0-471>471</a></span>
<span class=normal><a href=#__codelineno-0-472>472</a></span>
<span class=normal><a href=#__codelineno-0-473>473</a></span>
<span class=normal><a href=#__codelineno-0-474>474</a></span>
<span class=normal><a href=#__codelineno-0-475>475</a></span>
<span class=normal><a href=#__codelineno-0-476>476</a></span>
<span class=normal><a href=#__codelineno-0-477>477</a></span>
<span class=normal><a href=#__codelineno-0-478>478</a></span>
<span class=normal><a href=#__codelineno-0-479>479</a></span>
<span class=normal><a href=#__codelineno-0-480>480</a></span>
<span class=normal><a href=#__codelineno-0-481>481</a></span>
<span class=normal><a href=#__codelineno-0-482>482</a></span>
<span class=normal><a href=#__codelineno-0-483>483</a></span>
<span class=normal><a href=#__codelineno-0-484>484</a></span>
<span class=normal><a href=#__codelineno-0-485>485</a></span>
<span class=normal><a href=#__codelineno-0-486>486</a></span>
<span class=normal><a href=#__codelineno-0-487>487</a></span>
<span class=normal><a href=#__codelineno-0-488>488</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-268><a id=__codelineno-0-268 name=__codelineno-0-268></a><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-269><a id=__codelineno-0-269 name=__codelineno-0-269></a>    <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-270><a id=__codelineno-0-270 name=__codelineno-0-270></a>    <span class=n>slaf_array</span><span class=p>:</span> <span class=n>SLAFArray</span><span class=p>,</span>
</span><span id=__span-0-271><a id=__codelineno-0-271 name=__codelineno-0-271></a>    <span class=n>tokenizer_type</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;geneformer&quot;</span><span class=p>,</span>
</span><span id=__span-0-272><a id=__codelineno-0-272 name=__codelineno-0-272></a>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-273><a id=__codelineno-0-273 name=__codelineno-0-273></a>    <span class=n>max_genes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>2048</span><span class=p>,</span>
</span><span id=__span-0-274><a id=__codelineno-0-274 name=__codelineno-0-274></a>    <span class=n>vocab_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span>
</span><span id=__span-0-275><a id=__codelineno-0-275 name=__codelineno-0-275></a>    <span class=n>n_expression_bins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-0-276><a id=__codelineno-0-276 name=__codelineno-0-276></a>    <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># Add n_epochs parameter</span>
</span><span id=__span-0-277><a id=__codelineno-0-277 name=__codelineno-0-277></a>    <span class=n>raw_mode</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>  <span class=c1># Add raw_mode parameter</span>
</span><span id=__span-0-278><a id=__codelineno-0-278 name=__codelineno-0-278></a>    <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>  <span class=c1># Add verbose parameter</span>
</span><span id=__span-0-279><a id=__codelineno-0-279 name=__codelineno-0-279></a>    <span class=n>batches_per_chunk</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>  <span class=c1># Default to 1 for MoS (was 50 for sequential)</span>
</span><span id=__span-0-280><a id=__codelineno-0-280 name=__codelineno-0-280></a>    <span class=n>by_fragment</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>  <span class=c1># Default to True for MoS (was False for sequential)</span>
</span><span id=__span-0-281><a id=__codelineno-0-281 name=__codelineno-0-281></a>    <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>  <span class=c1># Default to True for MoS (was False)</span>
</span><span id=__span-0-282><a id=__codelineno-0-282 name=__codelineno-0-282></a>    <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>16</span><span class=p>,</span>  <span class=c1># Add n_scanners parameter for MoS</span>
</span><span id=__span-0-283><a id=__codelineno-0-283 name=__codelineno-0-283></a>    <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>4194304</span><span class=p>,</span>  <span class=c1># Add prefetch_batch_size parameter for MoS</span>
</span><span id=__span-0-284><a id=__codelineno-0-284 name=__codelineno-0-284></a>    <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>5000</span><span class=p>,</span>  <span class=c1># Add max_queue_size parameter</span>
</span><span id=__span-0-285><a id=__codelineno-0-285 name=__codelineno-0-285></a>    <span class=n>parallelize_fragment_reads</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>  <span class=c1># Parallelize fragment reads in MoS (cloud optimization)</span>
</span><span id=__span-0-286><a id=__codelineno-0-286 name=__codelineno-0-286></a><span class=p>):</span>
</span><span id=__span-0-287><a id=__codelineno-0-287 name=__codelineno-0-287></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-288><a id=__codelineno-0-288 name=__codelineno-0-288></a><span class=sd>    Initialize the SLAF DataLoader with training configuration.</span>
</span><span id=__span-0-289><a id=__codelineno-0-289 name=__codelineno-0-289></a>
</span><span id=__span-0-290><a id=__codelineno-0-290 name=__codelineno-0-290></a><span class=sd>    Args:</span>
</span><span id=__span-0-291><a id=__codelineno-0-291 name=__codelineno-0-291></a><span class=sd>        slaf_array: SLAFArray instance containing the single-cell data.</span>
</span><span id=__span-0-292><a id=__codelineno-0-292 name=__codelineno-0-292></a><span class=sd>                   Must be a valid SLAFArray with proper Lance dataset structure.</span>
</span><span id=__span-0-293><a id=__codelineno-0-293 name=__codelineno-0-293></a>
</span><span id=__span-0-294><a id=__codelineno-0-294 name=__codelineno-0-294></a><span class=sd>        # Tokenization Configuration</span>
</span><span id=__span-0-295><a id=__codelineno-0-295 name=__codelineno-0-295></a><span class=sd>        tokenizer_type: Tokenization strategy to use. Options: &quot;geneformer&quot;, &quot;scgpt&quot;.</span>
</span><span id=__span-0-296><a id=__codelineno-0-296 name=__codelineno-0-296></a><span class=sd>                      Geneformer uses ranked gene sequences, scGPT uses interleaved</span>
</span><span id=__span-0-297><a id=__codelineno-0-297 name=__codelineno-0-297></a><span class=sd>                      gene-expression pairs. Ignored when raw_mode=True.</span>
</span><span id=__span-0-298><a id=__codelineno-0-298 name=__codelineno-0-298></a><span class=sd>        max_genes: Maximum number of genes to include in each cell&#39;s tokenization.</span>
</span><span id=__span-0-299><a id=__codelineno-0-299 name=__codelineno-0-299></a><span class=sd>                 For Geneformer: same as sequence length. For scGPT: number of</span>
</span><span id=__span-0-300><a id=__codelineno-0-300 name=__codelineno-0-300></a><span class=sd>                 gene-expression pairs (sequence length = 2*max_genes+2).</span>
</span><span id=__span-0-301><a id=__codelineno-0-301 name=__codelineno-0-301></a><span class=sd>        vocab_size: Size of the tokenizer vocabulary. Higher values allow more</span>
</span><span id=__span-0-302><a id=__codelineno-0-302 name=__codelineno-0-302></a><span class=sd>                   genes but use more memory. Range: 1000-100000, default: 50000.</span>
</span><span id=__span-0-303><a id=__codelineno-0-303 name=__codelineno-0-303></a><span class=sd>        n_expression_bins: Number of expression level bins for scGPT discretization.</span>
</span><span id=__span-0-304><a id=__codelineno-0-304 name=__codelineno-0-304></a><span class=sd>                         Higher values provide finer expression resolution.</span>
</span><span id=__span-0-305><a id=__codelineno-0-305 name=__codelineno-0-305></a><span class=sd>                         Range: 1-1000, default: 10.</span>
</span><span id=__span-0-306><a id=__codelineno-0-306 name=__codelineno-0-306></a>
</span><span id=__span-0-307><a id=__codelineno-0-307 name=__codelineno-0-307></a><span class=sd>        # Training Configuration</span>
</span><span id=__span-0-308><a id=__codelineno-0-308 name=__codelineno-0-308></a><span class=sd>        batch_size: Number of cells per batch. Larger batches use more memory</span>
</span><span id=__span-0-309><a id=__codelineno-0-309 name=__codelineno-0-309></a><span class=sd>                   but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-310><a id=__codelineno-0-310 name=__codelineno-0-310></a><span class=sd>        n_epochs: Number of epochs to run. The generator will automatically reset</span>
</span><span id=__span-0-311><a id=__codelineno-0-311 name=__codelineno-0-311></a><span class=sd>                 after each epoch, enabling multi-epoch training on small datasets.</span>
</span><span id=__span-0-312><a id=__codelineno-0-312 name=__codelineno-0-312></a><span class=sd>                 Default: 1.</span>
</span><span id=__span-0-313><a id=__codelineno-0-313 name=__codelineno-0-313></a>
</span><span id=__span-0-314><a id=__codelineno-0-314 name=__codelineno-0-314></a><span class=sd>        # Output Mode Configuration</span>
</span><span id=__span-0-315><a id=__codelineno-0-315 name=__codelineno-0-315></a><span class=sd>        raw_mode: If True, return raw cell  gene data as Polars DataFrames</span>
</span><span id=__span-0-316><a id=__codelineno-0-316 name=__codelineno-0-316></a><span class=sd>                 instead of pre-tokenized sequences. This bypasses tokenization</span>
</span><span id=__span-0-317><a id=__codelineno-0-317 name=__codelineno-0-317></a><span class=sd>                 and windowing for maximum flexibility. Default: False.</span>
</span><span id=__span-0-318><a id=__codelineno-0-318 name=__codelineno-0-318></a>
</span><span id=__span-0-319><a id=__codelineno-0-319 name=__codelineno-0-319></a><span class=sd>        # Loading Strategy Configuration (MoS is now default)</span>
</span><span id=__span-0-320><a id=__codelineno-0-320 name=__codelineno-0-320></a><span class=sd>        batches_per_chunk: Number of Lance batches to load per chunk for sequential loading.</span>
</span><span id=__span-0-321><a id=__codelineno-0-321 name=__codelineno-0-321></a><span class=sd>                         Higher values use more memory but may improve throughput.</span>
</span><span id=__span-0-322><a id=__codelineno-0-322 name=__codelineno-0-322></a><span class=sd>                         Range: 1-200, default: 1 (optimized for MoS). Only used when by_fragment=False.</span>
</span><span id=__span-0-323><a id=__codelineno-0-323 name=__codelineno-0-323></a><span class=sd>        by_fragment: If True, use fragment-based loading instead of batch-based loading.</span>
</span><span id=__span-0-324><a id=__codelineno-0-324 name=__codelineno-0-324></a><span class=sd>                    Fragment-based loading provides higher entropy but may be slightly slower.</span>
</span><span id=__span-0-325><a id=__codelineno-0-325 name=__codelineno-0-325></a><span class=sd>                    Automatically enabled when use_mixture_of_scanners=True.</span>
</span><span id=__span-0-326><a id=__codelineno-0-326 name=__codelineno-0-326></a><span class=sd>                    Default: True (enabled for MoS).</span>
</span><span id=__span-0-327><a id=__codelineno-0-327 name=__codelineno-0-327></a><span class=sd>        use_mixture_of_scanners: If True, use mixture of scanners (MoS) approach for higher</span>
</span><span id=__span-0-328><a id=__codelineno-0-328 name=__codelineno-0-328></a><span class=sd>                               entropy by randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-329><a id=__codelineno-0-329 name=__codelineno-0-329></a><span class=sd>                               This provides the best randomization and is now the default</span>
</span><span id=__span-0-330><a id=__codelineno-0-330 name=__codelineno-0-330></a><span class=sd>                               for foundation model training. Default: True.</span>
</span><span id=__span-0-331><a id=__codelineno-0-331 name=__codelineno-0-331></a><span class=sd>        n_scanners: Number of fragment generators to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-332><a id=__codelineno-0-332 name=__codelineno-0-332></a><span class=sd>                   Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-333><a id=__codelineno-0-333 name=__codelineno-0-333></a><span class=sd>                   Range: 1-100, default: 16. Only used when use_mixture_of_scanners=True.</span>
</span><span id=__span-0-334><a id=__codelineno-0-334 name=__codelineno-0-334></a><span class=sd>        prefetch_batch_size: Target number of rows to load per prefetch batch when using MoS.</span>
</span><span id=__span-0-335><a id=__codelineno-0-335 name=__codelineno-0-335></a><span class=sd>                           Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-336><a id=__codelineno-0-336 name=__codelineno-0-336></a><span class=sd>                           Range: 1000-10000000, default: 4194304. Only used when</span>
</span><span id=__span-0-337><a id=__codelineno-0-337 name=__codelineno-0-337></a><span class=sd>                           use_mixture_of_scanners=True.</span>
</span><span id=__span-0-338><a id=__codelineno-0-338 name=__codelineno-0-338></a><span class=sd>        parallelize_fragment_reads: Whether to parallelize fragment reads in MoS mode.</span>
</span><span id=__span-0-339><a id=__codelineno-0-339 name=__codelineno-0-339></a><span class=sd>                                   Critical for cloud scenarios where network latency</span>
</span><span id=__span-0-340><a id=__codelineno-0-340 name=__codelineno-0-340></a><span class=sd>                                   dominates (can improve throughput 10-30x). For local</span>
</span><span id=__span-0-341><a id=__codelineno-0-341 name=__codelineno-0-341></a><span class=sd>                                   data, sequential reads are typically more efficient as</span>
</span><span id=__span-0-342><a id=__codelineno-0-342 name=__codelineno-0-342></a><span class=sd>                                   parallelization adds overhead without benefit.</span>
</span><span id=__span-0-343><a id=__codelineno-0-343 name=__codelineno-0-343></a><span class=sd>                                   Default: False. Only used when use_mixture_of_scanners=True.</span>
</span><span id=__span-0-344><a id=__codelineno-0-344 name=__codelineno-0-344></a>
</span><span id=__span-0-345><a id=__codelineno-0-345 name=__codelineno-0-345></a><span class=sd>        # System Configuration</span>
</span><span id=__span-0-346><a id=__codelineno-0-346 name=__codelineno-0-346></a><span class=sd>        verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-347><a id=__codelineno-0-347 name=__codelineno-0-347></a><span class=sd>                If False, suppress all SLAF internal prints for clean output.</span>
</span><span id=__span-0-348><a id=__codelineno-0-348 name=__codelineno-0-348></a><span class=sd>                Default: True.</span>
</span><span id=__span-0-349><a id=__codelineno-0-349 name=__codelineno-0-349></a>
</span><span id=__span-0-350><a id=__codelineno-0-350 name=__codelineno-0-350></a><span class=sd>    Raises:</span>
</span><span id=__span-0-351><a id=__codelineno-0-351 name=__codelineno-0-351></a><span class=sd>        ValueError: If tokenizer_type is not supported or parameters are invalid.</span>
</span><span id=__span-0-352><a id=__codelineno-0-352 name=__codelineno-0-352></a><span class=sd>        RuntimeError: If PyTorch is not available or datasets module is missing.</span>
</span><span id=__span-0-353><a id=__codelineno-0-353 name=__codelineno-0-353></a><span class=sd>        TypeError: If slaf_array is not a valid SLAFArray instance.</span>
</span><span id=__span-0-354><a id=__codelineno-0-354 name=__codelineno-0-354></a><span class=sd>        ImportError: If required dependencies are not available.</span>
</span><span id=__span-0-355><a id=__codelineno-0-355 name=__codelineno-0-355></a>
</span><span id=__span-0-356><a id=__codelineno-0-356 name=__codelineno-0-356></a><span class=sd>    Loading Strategy Selection Guide:</span>
</span><span id=__span-0-357><a id=__codelineno-0-357 name=__codelineno-0-357></a><span class=sd>        - For foundation model training: Use default settings (MoS provides 88% random entropy)</span>
</span><span id=__span-0-358><a id=__codelineno-0-358 name=__codelineno-0-358></a><span class=sd>        - For cloud data: Enable parallelize_fragment_reads=True for 10-30x throughput improvement</span>
</span><span id=__span-0-359><a id=__codelineno-0-359 name=__codelineno-0-359></a><span class=sd>        - For local data: Keep parallelize_fragment_reads=False (sequential reads are more efficient)</span>
</span><span id=__span-0-360><a id=__codelineno-0-360 name=__codelineno-0-360></a><span class=sd>        - For maximum throughput: Set use_mixture_of_scanners=False, by_fragment=False</span>
</span><span id=__span-0-361><a id=__codelineno-0-361 name=__codelineno-0-361></a><span class=sd>        - For external processing: Set raw_mode=True</span>
</span><span id=__span-0-362><a id=__codelineno-0-362 name=__codelineno-0-362></a>
</span><span id=__span-0-363><a id=__codelineno-0-363 name=__codelineno-0-363></a><span class=sd>    Examples:</span>
</span><span id=__span-0-364><a id=__codelineno-0-364 name=__codelineno-0-364></a><span class=sd>        &gt;&gt;&gt; # Basic initialization (MoS is now default)</span>
</span><span id=__span-0-365><a id=__codelineno-0-365 name=__codelineno-0-365></a><span class=sd>        &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-366><a id=__codelineno-0-366 name=__codelineno-0-366></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(slaf_array)</span>
</span><span id=__span-0-367><a id=__codelineno-0-367 name=__codelineno-0-367></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Batch size: {dataloader.batch_size}&quot;)</span>
</span><span id=__span-0-368><a id=__codelineno-0-368 name=__codelineno-0-368></a><span class=sd>        Batch size: 32</span>
</span><span id=__span-0-369><a id=__codelineno-0-369 name=__codelineno-0-369></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-370><a id=__codelineno-0-370 name=__codelineno-0-370></a><span class=sd>        MoS enabled: True</span>
</span><span id=__span-0-371><a id=__codelineno-0-371 name=__codelineno-0-371></a>
</span><span id=__span-0-372><a id=__codelineno-0-372 name=__codelineno-0-372></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-373><a id=__codelineno-0-373 name=__codelineno-0-373></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-374><a id=__codelineno-0-374 name=__codelineno-0-374></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-375><a id=__codelineno-0-375 name=__codelineno-0-375></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-376><a id=__codelineno-0-376 name=__codelineno-0-376></a><span class=sd>        ...     by_fragment=False</span>
</span><span id=__span-0-377><a id=__codelineno-0-377 name=__codelineno-0-377></a><span class=sd>        ... )</span>
</span><span id=__span-0-378><a id=__codelineno-0-378 name=__codelineno-0-378></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-379><a id=__codelineno-0-379 name=__codelineno-0-379></a><span class=sd>        Sequential loading: True</span>
</span><span id=__span-0-380><a id=__codelineno-0-380 name=__codelineno-0-380></a>
</span><span id=__span-0-381><a id=__codelineno-0-381 name=__codelineno-0-381></a><span class=sd>        &gt;&gt;&gt; # Fragment-based loading for higher entropy</span>
</span><span id=__span-0-382><a id=__codelineno-0-382 name=__codelineno-0-382></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-383><a id=__codelineno-0-383 name=__codelineno-0-383></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-384><a id=__codelineno-0-384 name=__codelineno-0-384></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-385><a id=__codelineno-0-385 name=__codelineno-0-385></a><span class=sd>        ...     by_fragment=True</span>
</span><span id=__span-0-386><a id=__codelineno-0-386 name=__codelineno-0-386></a><span class=sd>        ... )</span>
</span><span id=__span-0-387><a id=__codelineno-0-387 name=__codelineno-0-387></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Fragment-based loading: {dataloader.by_fragment}&quot;)</span>
</span><span id=__span-0-388><a id=__codelineno-0-388 name=__codelineno-0-388></a><span class=sd>        Fragment-based loading: True</span>
</span><span id=__span-0-389><a id=__codelineno-0-389 name=__codelineno-0-389></a>
</span><span id=__span-0-390><a id=__codelineno-0-390 name=__codelineno-0-390></a><span class=sd>        &gt;&gt;&gt; # Raw mode for external processing</span>
</span><span id=__span-0-391><a id=__codelineno-0-391 name=__codelineno-0-391></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-392><a id=__codelineno-0-392 name=__codelineno-0-392></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-393><a id=__codelineno-0-393 name=__codelineno-0-393></a><span class=sd>        ...     raw_mode=True</span>
</span><span id=__span-0-394><a id=__codelineno-0-394 name=__codelineno-0-394></a><span class=sd>        ... )</span>
</span><span id=__span-0-395><a id=__codelineno-0-395 name=__codelineno-0-395></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Raw mode: {dataloader.raw_mode}&quot;)</span>
</span><span id=__span-0-396><a id=__codelineno-0-396 name=__codelineno-0-396></a><span class=sd>        Raw mode: True</span>
</span><span id=__span-0-397><a id=__codelineno-0-397 name=__codelineno-0-397></a>
</span><span id=__span-0-398><a id=__codelineno-0-398 name=__codelineno-0-398></a><span class=sd>        &gt;&gt;&gt; # Cloud data optimization: parallelize fragment reads</span>
</span><span id=__span-0-399><a id=__codelineno-0-399 name=__codelineno-0-399></a><span class=sd>        &gt;&gt;&gt; dataloader = SLAFDataLoader(</span>
</span><span id=__span-0-400><a id=__codelineno-0-400 name=__codelineno-0-400></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-401><a id=__codelineno-0-401 name=__codelineno-0-401></a><span class=sd>        ...     parallelize_fragment_reads=True,  # Critical for accelerating cloud data loading</span>
</span><span id=__span-0-402><a id=__codelineno-0-402 name=__codelineno-0-402></a><span class=sd>        ...     batches_per_chunk=16,  # Combine with higher batches_per_chunk for best results</span>
</span><span id=__span-0-403><a id=__codelineno-0-403 name=__codelineno-0-403></a><span class=sd>        ... )</span>
</span><span id=__span-0-404><a id=__codelineno-0-404 name=__codelineno-0-404></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Parallel fragment reads: {dataloader.parallelize_fragment_reads}&quot;)</span>
</span><span id=__span-0-405><a id=__codelineno-0-405 name=__codelineno-0-405></a><span class=sd>        Parallel fragment reads: True</span>
</span><span id=__span-0-406><a id=__codelineno-0-406 name=__codelineno-0-406></a>
</span><span id=__span-0-407><a id=__codelineno-0-407 name=__codelineno-0-407></a><span class=sd>        &gt;&gt;&gt; # Error handling for invalid parameters</span>
</span><span id=__span-0-408><a id=__codelineno-0-408 name=__codelineno-0-408></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-409><a id=__codelineno-0-409 name=__codelineno-0-409></a><span class=sd>        ...     dataloader = SLAFDataLoader(slaf_array, n_scanners=0)</span>
</span><span id=__span-0-410><a id=__codelineno-0-410 name=__codelineno-0-410></a><span class=sd>        ... except ValueError as e:</span>
</span><span id=__span-0-411><a id=__codelineno-0-411 name=__codelineno-0-411></a><span class=sd>        ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-412><a id=__codelineno-0-412 name=__codelineno-0-412></a><span class=sd>        Error: n_scanners must be at least 1</span>
</span><span id=__span-0-413><a id=__codelineno-0-413 name=__codelineno-0-413></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-414><a id=__codelineno-0-414 name=__codelineno-0-414></a>    <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>slaf_array</span>
</span><span id=__span-0-415><a id=__codelineno-0-415 name=__codelineno-0-415></a>    <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>=</span> <span class=n>tokenizer_type</span>
</span><span id=__span-0-416><a id=__codelineno-0-416 name=__codelineno-0-416></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-417><a id=__codelineno-0-417 name=__codelineno-0-417></a>    <span class=bp>self</span><span class=o>.</span><span class=n>max_genes</span> <span class=o>=</span> <span class=n>max_genes</span>
</span><span id=__span-0-418><a id=__codelineno-0-418 name=__codelineno-0-418></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-419><a id=__codelineno-0-419 name=__codelineno-0-419></a>    <span class=bp>self</span><span class=o>.</span><span class=n>raw_mode</span> <span class=o>=</span> <span class=n>raw_mode</span>  <span class=c1># Add raw_mode attribute</span>
</span><span id=__span-0-420><a id=__codelineno-0-420 name=__codelineno-0-420></a>    <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>  <span class=c1># Add verbose attribute</span>
</span><span id=__span-0-421><a id=__codelineno-0-421 name=__codelineno-0-421></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batches_per_chunk</span> <span class=o>=</span> <span class=n>batches_per_chunk</span>  <span class=c1># Add batches_per_chunk attribute</span>
</span><span id=__span-0-422><a id=__codelineno-0-422 name=__codelineno-0-422></a>    <span class=bp>self</span><span class=o>.</span><span class=n>by_fragment</span> <span class=o>=</span> <span class=n>by_fragment</span>  <span class=c1># Add by_fragment attribute</span>
</span><span id=__span-0-423><a id=__codelineno-0-423 name=__codelineno-0-423></a>    <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>  <span class=c1># Add MoS attribute</span>
</span><span id=__span-0-424><a id=__codelineno-0-424 name=__codelineno-0-424></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>  <span class=c1># Add n_scanners attribute</span>
</span><span id=__span-0-425><a id=__codelineno-0-425 name=__codelineno-0-425></a>    <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-426><a id=__codelineno-0-426 name=__codelineno-0-426></a>        <span class=n>prefetch_batch_size</span>  <span class=c1># Add prefetch_batch_size attribute</span>
</span><span id=__span-0-427><a id=__codelineno-0-427 name=__codelineno-0-427></a>    <span class=p>)</span>
</span><span id=__span-0-428><a id=__codelineno-0-428 name=__codelineno-0-428></a>    <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>  <span class=c1># Add max_queue_size attribute</span>
</span><span id=__span-0-429><a id=__codelineno-0-429 name=__codelineno-0-429></a>    <span class=bp>self</span><span class=o>.</span><span class=n>parallelize_fragment_reads</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-430><a id=__codelineno-0-430 name=__codelineno-0-430></a>        <span class=n>parallelize_fragment_reads</span>  <span class=c1># Add parallelize_fragment_reads attribute</span>
</span><span id=__span-0-431><a id=__codelineno-0-431 name=__codelineno-0-431></a>    <span class=p>)</span>
</span><span id=__span-0-432><a id=__codelineno-0-432 name=__codelineno-0-432></a>
</span><span id=__span-0-433><a id=__codelineno-0-433 name=__codelineno-0-433></a>    <span class=c1># Validate MoS parameters</span>
</span><span id=__span-0-434><a id=__codelineno-0-434 name=__codelineno-0-434></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-435><a id=__codelineno-0-435 name=__codelineno-0-435></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-436><a id=__codelineno-0-436 name=__codelineno-0-436></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners must be at least 1&quot;</span><span class=p>)</span>
</span><span id=__span-0-437><a id=__codelineno-0-437 name=__codelineno-0-437></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&gt;</span> <span class=mi>100</span><span class=p>:</span>
</span><span id=__span-0-438><a id=__codelineno-0-438 name=__codelineno-0-438></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners cannot exceed 100&quot;</span><span class=p>)</span>
</span><span id=__span-0-439><a id=__codelineno-0-439 name=__codelineno-0-439></a>        <span class=k>if</span> <span class=p>(</span>
</span><span id=__span-0-440><a id=__codelineno-0-440 name=__codelineno-0-440></a>            <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>&lt;</span> <span class=mi>1000</span>
</span><span id=__span-0-441><a id=__codelineno-0-441 name=__codelineno-0-441></a>        <span class=p>):</span>  <span class=c1># Allow smaller values for warm-up strategy</span>
</span><span id=__span-0-442><a id=__codelineno-0-442 name=__codelineno-0-442></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;prefetch_batch_size must be at least 1,000&quot;</span><span class=p>)</span>
</span><span id=__span-0-443><a id=__codelineno-0-443 name=__codelineno-0-443></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>&gt;</span> <span class=mi>10000000</span><span class=p>:</span>
</span><span id=__span-0-444><a id=__codelineno-0-444 name=__codelineno-0-444></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;prefetch_batch_size cannot exceed 10,000,000&quot;</span><span class=p>)</span>
</span><span id=__span-0-445><a id=__codelineno-0-445 name=__codelineno-0-445></a>
</span><span id=__span-0-446><a id=__codelineno-0-446 name=__codelineno-0-446></a>    <span class=c1># Device-agnostic: always return CPU tensors</span>
</span><span id=__span-0-447><a id=__codelineno-0-447 name=__codelineno-0-447></a>    <span class=bp>self</span><span class=o>.</span><span class=n>device</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-448><a id=__codelineno-0-448 name=__codelineno-0-448></a>
</span><span id=__span-0-449><a id=__codelineno-0-449 name=__codelineno-0-449></a>    <span class=c1># Check that required modules are available</span>
</span><span id=__span-0-450><a id=__codelineno-0-450 name=__codelineno-0-450></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>DATASETS_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-451><a id=__codelineno-0-451 name=__codelineno-0-451></a>        <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span>
</span><span id=__span-0-452><a id=__codelineno-0-452 name=__codelineno-0-452></a>            <span class=s2>&quot;SLAFIterableDataset is required but not available. Please install required dependencies.&quot;</span>
</span><span id=__span-0-453><a id=__codelineno-0-453 name=__codelineno-0-453></a>        <span class=p>)</span>
</span><span id=__span-0-454><a id=__codelineno-0-454 name=__codelineno-0-454></a>
</span><span id=__span-0-455><a id=__codelineno-0-455 name=__codelineno-0-455></a>    <span class=c1># Initialize tokenizer (only needed for non-raw mode)</span>
</span><span id=__span-0-456><a id=__codelineno-0-456 name=__codelineno-0-456></a>    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>raw_mode</span><span class=p>:</span>
</span><span id=__span-0-457><a id=__codelineno-0-457 name=__codelineno-0-457></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span>
</span><span id=__span-0-458><a id=__codelineno-0-458 name=__codelineno-0-458></a>            <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-459><a id=__codelineno-0-459 name=__codelineno-0-459></a>            <span class=n>tokenizer_type</span><span class=o>=</span><span class=n>tokenizer_type</span><span class=p>,</span>
</span><span id=__span-0-460><a id=__codelineno-0-460 name=__codelineno-0-460></a>            <span class=n>vocab_size</span><span class=o>=</span><span class=n>vocab_size</span><span class=p>,</span>
</span><span id=__span-0-461><a id=__codelineno-0-461 name=__codelineno-0-461></a>            <span class=n>n_expression_bins</span><span class=o>=</span><span class=n>n_expression_bins</span><span class=p>,</span>
</span><span id=__span-0-462><a id=__codelineno-0-462 name=__codelineno-0-462></a>        <span class=p>)</span>
</span><span id=__span-0-463><a id=__codelineno-0-463 name=__codelineno-0-463></a>
</span><span id=__span-0-464><a id=__codelineno-0-464 name=__codelineno-0-464></a>        <span class=c1># Get special tokens from tokenizer</span>
</span><span id=__span-0-465><a id=__codelineno-0-465 name=__codelineno-0-465></a>        <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>special_tokens</span>
</span><span id=__span-0-466><a id=__codelineno-0-466 name=__codelineno-0-466></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-467><a id=__codelineno-0-467 name=__codelineno-0-467></a>        <span class=c1># For raw mode, we don&#39;t need a tokenizer</span>
</span><span id=__span-0-468><a id=__codelineno-0-468 name=__codelineno-0-468></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-469><a id=__codelineno-0-469 name=__codelineno-0-469></a>        <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-470><a id=__codelineno-0-470 name=__codelineno-0-470></a>
</span><span id=__span-0-471><a id=__codelineno-0-471 name=__codelineno-0-471></a>    <span class=c1># Use IterableDataset</span>
</span><span id=__span-0-472><a id=__codelineno-0-472 name=__codelineno-0-472></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_dataset</span> <span class=o>=</span> <span class=n>SLAFIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-473><a id=__codelineno-0-473 name=__codelineno-0-473></a>        <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-474><a id=__codelineno-0-474 name=__codelineno-0-474></a>        <span class=n>tokenizer</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>tokenizer</span><span class=p>,</span>
</span><span id=__span-0-475><a id=__codelineno-0-475 name=__codelineno-0-475></a>        <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-476><a id=__codelineno-0-476 name=__codelineno-0-476></a>        <span class=n>seed</span><span class=o>=</span><span class=mi>42</span><span class=p>,</span>  <span class=c1># TODO: make configurable</span>
</span><span id=__span-0-477><a id=__codelineno-0-477 name=__codelineno-0-477></a>        <span class=n>max_queue_size</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>,</span>  <span class=c1># Pass max_queue_size to dataset</span>
</span><span id=__span-0-478><a id=__codelineno-0-478 name=__codelineno-0-478></a>        <span class=n>tokenizer_type</span><span class=o>=</span><span class=n>tokenizer_type</span><span class=p>,</span>
</span><span id=__span-0-479><a id=__codelineno-0-479 name=__codelineno-0-479></a>        <span class=n>n_epochs</span><span class=o>=</span><span class=n>n_epochs</span><span class=p>,</span>  <span class=c1># Pass n_epochs to dataset</span>
</span><span id=__span-0-480><a id=__codelineno-0-480 name=__codelineno-0-480></a>        <span class=n>raw_mode</span><span class=o>=</span><span class=n>raw_mode</span><span class=p>,</span>  <span class=c1># Pass raw_mode to dataset</span>
</span><span id=__span-0-481><a id=__codelineno-0-481 name=__codelineno-0-481></a>        <span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>,</span>  <span class=c1># Pass verbose to dataset</span>
</span><span id=__span-0-482><a id=__codelineno-0-482 name=__codelineno-0-482></a>        <span class=n>batches_per_chunk</span><span class=o>=</span><span class=n>batches_per_chunk</span><span class=p>,</span>  <span class=c1># Pass batches_per_chunk to dataset</span>
</span><span id=__span-0-483><a id=__codelineno-0-483 name=__codelineno-0-483></a>        <span class=n>by_fragment</span><span class=o>=</span><span class=n>by_fragment</span><span class=p>,</span>  <span class=c1># Pass by_fragment to dataset</span>
</span><span id=__span-0-484><a id=__codelineno-0-484 name=__codelineno-0-484></a>        <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=n>use_mixture_of_scanners</span><span class=p>,</span>  <span class=c1># Pass MoS to dataset</span>
</span><span id=__span-0-485><a id=__codelineno-0-485 name=__codelineno-0-485></a>        <span class=n>n_scanners</span><span class=o>=</span><span class=n>n_scanners</span><span class=p>,</span>  <span class=c1># Pass n_scanners to dataset</span>
</span><span id=__span-0-486><a id=__codelineno-0-486 name=__codelineno-0-486></a>        <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=n>prefetch_batch_size</span><span class=p>,</span>  <span class=c1># Pass prefetch_batch_size to dataset</span>
</span><span id=__span-0-487><a id=__codelineno-0-487 name=__codelineno-0-487></a>        <span class=n>parallelize_fragment_reads</span><span class=o>=</span><span class=n>parallelize_fragment_reads</span><span class=p>,</span>  <span class=c1># Pass parallelize_fragment_reads</span>
</span><span id=__span-0-488><a id=__codelineno-0-488 name=__codelineno-0-488></a>    <span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> <h3 id=slaf.ml.dataloaders-functions>Functions<a href=#slaf.ml.dataloaders-functions class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-object doc-function"> <h4 id=slaf.ml.dataloaders.get_optimal_device class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_optimal_device</span><span class=p>()</span></code> <a href=#slaf.ml.dataloaders.get_optimal_device class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Get the optimal device for PyTorch operations (CUDA &gt; MPS &gt; CPU).</p> <p>This function determines the best available device for PyTorch operations by checking for CUDA first, then MPS (Apple Silicon), and falling back to CPU if neither is available.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> </td> <td> <div class=doc-md-description> <p>torch.device | None: The optimal device, or None if PyTorch is not available.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check optimal device</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>device</span> <span class=o>=</span> <span class=n>get_optimal_device</span><span class=p>()</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Optimal device: </span><span class=si>{</span><span class=n>device</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=go>Optimal device: cuda</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Device priority (CUDA &gt; MPS &gt; CPU)</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># If CUDA is available: cuda</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># If MPS is available but not CUDA: mps</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># If neither: cpu</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>device</span> <span class=o>=</span> <span class=n>get_optimal_device</span><span class=p>()</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>device</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&quot;cuda&quot;</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Using CUDA GPU&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span><span class=k>elif</span> <span class=n>device</span><span class=o>.</span><span class=n>type</span> <span class=o>==</span> <span class=s2>&quot;mps&quot;</span><span class=p>:</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Using Apple Silicon GPU&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Using CPU&quot;</span><span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>Using CUDA GPU</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Handle PyTorch not available</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># This would return None if PyTorch is not installed</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>device</span> <span class=o>=</span> <span class=n>get_optimal_device</span><span class=p>()</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>device</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;PyTorch not available&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Device available: </span><span class=si>{</span><span class=n>device</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Device available: cuda</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-31>31</a></span>
<span class=normal><a href=#__codelineno-0-32>32</a></span>
<span class=normal><a href=#__codelineno-0-33>33</a></span>
<span class=normal><a href=#__codelineno-0-34>34</a></span>
<span class=normal><a href=#__codelineno-0-35>35</a></span>
<span class=normal><a href=#__codelineno-0-36>36</a></span>
<span class=normal><a href=#__codelineno-0-37>37</a></span>
<span class=normal><a href=#__codelineno-0-38>38</a></span>
<span class=normal><a href=#__codelineno-0-39>39</a></span>
<span class=normal><a href=#__codelineno-0-40>40</a></span>
<span class=normal><a href=#__codelineno-0-41>41</a></span>
<span class=normal><a href=#__codelineno-0-42>42</a></span>
<span class=normal><a href=#__codelineno-0-43>43</a></span>
<span class=normal><a href=#__codelineno-0-44>44</a></span>
<span class=normal><a href=#__codelineno-0-45>45</a></span>
<span class=normal><a href=#__codelineno-0-46>46</a></span>
<span class=normal><a href=#__codelineno-0-47>47</a></span>
<span class=normal><a href=#__codelineno-0-48>48</a></span>
<span class=normal><a href=#__codelineno-0-49>49</a></span>
<span class=normal><a href=#__codelineno-0-50>50</a></span>
<span class=normal><a href=#__codelineno-0-51>51</a></span>
<span class=normal><a href=#__codelineno-0-52>52</a></span>
<span class=normal><a href=#__codelineno-0-53>53</a></span>
<span class=normal><a href=#__codelineno-0-54>54</a></span>
<span class=normal><a href=#__codelineno-0-55>55</a></span>
<span class=normal><a href=#__codelineno-0-56>56</a></span>
<span class=normal><a href=#__codelineno-0-57>57</a></span>
<span class=normal><a href=#__codelineno-0-58>58</a></span>
<span class=normal><a href=#__codelineno-0-59>59</a></span>
<span class=normal><a href=#__codelineno-0-60>60</a></span>
<span class=normal><a href=#__codelineno-0-61>61</a></span>
<span class=normal><a href=#__codelineno-0-62>62</a></span>
<span class=normal><a href=#__codelineno-0-63>63</a></span>
<span class=normal><a href=#__codelineno-0-64>64</a></span>
<span class=normal><a href=#__codelineno-0-65>65</a></span>
<span class=normal><a href=#__codelineno-0-66>66</a></span>
<span class=normal><a href=#__codelineno-0-67>67</a></span>
<span class=normal><a href=#__codelineno-0-68>68</a></span>
<span class=normal><a href=#__codelineno-0-69>69</a></span>
<span class=normal><a href=#__codelineno-0-70>70</a></span>
<span class=normal><a href=#__codelineno-0-71>71</a></span>
<span class=normal><a href=#__codelineno-0-72>72</a></span>
<span class=normal><a href=#__codelineno-0-73>73</a></span>
<span class=normal><a href=#__codelineno-0-74>74</a></span>
<span class=normal><a href=#__codelineno-0-75>75</a></span>
<span class=normal><a href=#__codelineno-0-76>76</a></span>
<span class=normal><a href=#__codelineno-0-77>77</a></span>
<span class=normal><a href=#__codelineno-0-78>78</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31></a><span class=k>def</span><span class=w> </span><span class=nf>get_optimal_device</span><span class=p>():</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33></a><span class=sd>    Get the optimal device for PyTorch operations (CUDA &gt; MPS &gt; CPU).</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34></a>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35></a><span class=sd>    This function determines the best available device for PyTorch operations</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36></a><span class=sd>    by checking for CUDA first, then MPS (Apple Silicon), and falling back</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37></a><span class=sd>    to CPU if neither is available.</span>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38></a>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39></a><span class=sd>    Returns:</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40></a><span class=sd>        torch.device | None: The optimal device, or None if PyTorch is not available.</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41></a>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42></a><span class=sd>    Examples:</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43></a><span class=sd>        &gt;&gt;&gt; # Check optimal device</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44></a><span class=sd>        &gt;&gt;&gt; device = get_optimal_device()</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Optimal device: {device}&quot;)</span>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46></a><span class=sd>        Optimal device: cuda</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47></a>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48></a><span class=sd>        &gt;&gt;&gt; # Device priority (CUDA &gt; MPS &gt; CPU)</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49></a><span class=sd>        &gt;&gt;&gt; # If CUDA is available: cuda</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50></a><span class=sd>        &gt;&gt;&gt; # If MPS is available but not CUDA: mps</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51></a><span class=sd>        &gt;&gt;&gt; # If neither: cpu</span>
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52></a><span class=sd>        &gt;&gt;&gt; device = get_optimal_device()</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53></a><span class=sd>        &gt;&gt;&gt; if device.type == &quot;cuda&quot;:</span>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54></a><span class=sd>        ...     print(&quot;Using CUDA GPU&quot;)</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55></a><span class=sd>        ... elif device.type == &quot;mps&quot;:</span>
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56></a><span class=sd>        ...     print(&quot;Using Apple Silicon GPU&quot;)</span>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57></a><span class=sd>        ... else:</span>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58></a><span class=sd>        ...     print(&quot;Using CPU&quot;)</span>
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59></a><span class=sd>        Using CUDA GPU</span>
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60></a>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61></a><span class=sd>        &gt;&gt;&gt; # Handle PyTorch not available</span>
</span><span id=__span-0-62><a id=__codelineno-0-62 name=__codelineno-0-62></a><span class=sd>        &gt;&gt;&gt; # This would return None if PyTorch is not installed</span>
</span><span id=__span-0-63><a id=__codelineno-0-63 name=__codelineno-0-63></a><span class=sd>        &gt;&gt;&gt; device = get_optimal_device()</span>
</span><span id=__span-0-64><a id=__codelineno-0-64 name=__codelineno-0-64></a><span class=sd>        &gt;&gt;&gt; if device is None:</span>
</span><span id=__span-0-65><a id=__codelineno-0-65 name=__codelineno-0-65></a><span class=sd>        ...     print(&quot;PyTorch not available&quot;)</span>
</span><span id=__span-0-66><a id=__codelineno-0-66 name=__codelineno-0-66></a><span class=sd>        ... else:</span>
</span><span id=__span-0-67><a id=__codelineno-0-67 name=__codelineno-0-67></a><span class=sd>        ...     print(f&quot;Device available: {device}&quot;)</span>
</span><span id=__span-0-68><a id=__codelineno-0-68 name=__codelineno-0-68></a><span class=sd>        Device available: cuda</span>
</span><span id=__span-0-69><a id=__codelineno-0-69 name=__codelineno-0-69></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-70><a id=__codelineno-0-70 name=__codelineno-0-70></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>TORCH_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-71><a id=__codelineno-0-71 name=__codelineno-0-71></a>        <span class=k>return</span> <span class=kc>None</span>
</span><span id=__span-0-72><a id=__codelineno-0-72 name=__codelineno-0-72></a>
</span><span id=__span-0-73><a id=__codelineno-0-73 name=__codelineno-0-73></a>    <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>():</span>
</span><span id=__span-0-74><a id=__codelineno-0-74 name=__codelineno-0-74></a>        <span class=k>return</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&quot;cuda&quot;</span><span class=p>)</span>
</span><span id=__span-0-75><a id=__codelineno-0-75 name=__codelineno-0-75></a>    <span class=k>elif</span> <span class=n>torch</span><span class=o>.</span><span class=n>backends</span><span class=o>.</span><span class=n>mps</span><span class=o>.</span><span class=n>is_available</span><span class=p>():</span>
</span><span id=__span-0-76><a id=__codelineno-0-76 name=__codelineno-0-76></a>        <span class=k>return</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&quot;mps&quot;</span><span class=p>)</span>
</span><span id=__span-0-77><a id=__codelineno-0-77 name=__codelineno-0-77></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-78><a id=__codelineno-0-78 name=__codelineno-0-78></a>        <span class=k>return</span> <span class=n>torch</span><span class=o>.</span><span class=n>device</span><span class=p>(</span><span class=s2>&quot;cpu&quot;</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=slaf.ml.dataloaders.get_device_info class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_device_info</span><span class=p>()</span></code> <a href=#slaf.ml.dataloaders.get_device_info class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Get comprehensive device information for debugging.</p> <p>This function returns detailed information about the available PyTorch devices, including CUDA and MPS availability, device counts, and capabilities. Useful for debugging device-related issues and understanding the system configuration.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>dict</code></td> <td> </td> <td> <div class=doc-md-description> <p>Device information dictionary containing: - torch_available: Whether PyTorch is available - cuda_available: Whether CUDA is available - mps_available: Whether MPS (Apple Silicon) is available - optimal_device: String representation of the optimal device - cuda_device_count: Number of CUDA devices (if CUDA available) - cuda_device_name: Name of the first CUDA device (if available) - cuda_device_capability: Compute capability of first CUDA device</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Get device information</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>info</span> <span class=o>=</span> <span class=n>get_device_info</span><span class=p>()</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;PyTorch available: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;torch_available&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=go>PyTorch available: True</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;CUDA available: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;cuda_available&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>CUDA available: True</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Optimal device: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;optimal_device&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Optimal device: cuda</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check CUDA details</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>info</span><span class=p>[</span><span class=s1>&#39;cuda_available&#39;</span><span class=p>]:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;CUDA devices: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;cuda_device_count&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Device name: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;cuda_device_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Capability: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;cuda_device_capability&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>CUDA devices: 1</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Device name: NVIDIA GeForce RTX 3080</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Capability: (8, 6)</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check MPS availability</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MPS available: </span><span class=si>{</span><span class=n>info</span><span class=p>[</span><span class=s1>&#39;mps_available&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=go>MPS available: False</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Handle PyTorch not available</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># This would show torch_available: False if PyTorch is not installed</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>info</span> <span class=o>=</span> <span class=n>get_device_info</span><span class=p>()</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=ow>not</span> <span class=n>info</span><span class=p>[</span><span class=s1>&#39;torch_available&#39;</span><span class=p>]:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;PyTorch not available&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;PyTorch is available&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>PyTorch is available</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-81> 81</a></span>
<span class=normal><a href=#__codelineno-0-82> 82</a></span>
<span class=normal><a href=#__codelineno-0-83> 83</a></span>
<span class=normal><a href=#__codelineno-0-84> 84</a></span>
<span class=normal><a href=#__codelineno-0-85> 85</a></span>
<span class=normal><a href=#__codelineno-0-86> 86</a></span>
<span class=normal><a href=#__codelineno-0-87> 87</a></span>
<span class=normal><a href=#__codelineno-0-88> 88</a></span>
<span class=normal><a href=#__codelineno-0-89> 89</a></span>
<span class=normal><a href=#__codelineno-0-90> 90</a></span>
<span class=normal><a href=#__codelineno-0-91> 91</a></span>
<span class=normal><a href=#__codelineno-0-92> 92</a></span>
<span class=normal><a href=#__codelineno-0-93> 93</a></span>
<span class=normal><a href=#__codelineno-0-94> 94</a></span>
<span class=normal><a href=#__codelineno-0-95> 95</a></span>
<span class=normal><a href=#__codelineno-0-96> 96</a></span>
<span class=normal><a href=#__codelineno-0-97> 97</a></span>
<span class=normal><a href=#__codelineno-0-98> 98</a></span>
<span class=normal><a href=#__codelineno-0-99> 99</a></span>
<span class=normal><a href=#__codelineno-0-100>100</a></span>
<span class=normal><a href=#__codelineno-0-101>101</a></span>
<span class=normal><a href=#__codelineno-0-102>102</a></span>
<span class=normal><a href=#__codelineno-0-103>103</a></span>
<span class=normal><a href=#__codelineno-0-104>104</a></span>
<span class=normal><a href=#__codelineno-0-105>105</a></span>
<span class=normal><a href=#__codelineno-0-106>106</a></span>
<span class=normal><a href=#__codelineno-0-107>107</a></span>
<span class=normal><a href=#__codelineno-0-108>108</a></span>
<span class=normal><a href=#__codelineno-0-109>109</a></span>
<span class=normal><a href=#__codelineno-0-110>110</a></span>
<span class=normal><a href=#__codelineno-0-111>111</a></span>
<span class=normal><a href=#__codelineno-0-112>112</a></span>
<span class=normal><a href=#__codelineno-0-113>113</a></span>
<span class=normal><a href=#__codelineno-0-114>114</a></span>
<span class=normal><a href=#__codelineno-0-115>115</a></span>
<span class=normal><a href=#__codelineno-0-116>116</a></span>
<span class=normal><a href=#__codelineno-0-117>117</a></span>
<span class=normal><a href=#__codelineno-0-118>118</a></span>
<span class=normal><a href=#__codelineno-0-119>119</a></span>
<span class=normal><a href=#__codelineno-0-120>120</a></span>
<span class=normal><a href=#__codelineno-0-121>121</a></span>
<span class=normal><a href=#__codelineno-0-122>122</a></span>
<span class=normal><a href=#__codelineno-0-123>123</a></span>
<span class=normal><a href=#__codelineno-0-124>124</a></span>
<span class=normal><a href=#__codelineno-0-125>125</a></span>
<span class=normal><a href=#__codelineno-0-126>126</a></span>
<span class=normal><a href=#__codelineno-0-127>127</a></span>
<span class=normal><a href=#__codelineno-0-128>128</a></span>
<span class=normal><a href=#__codelineno-0-129>129</a></span>
<span class=normal><a href=#__codelineno-0-130>130</a></span>
<span class=normal><a href=#__codelineno-0-131>131</a></span>
<span class=normal><a href=#__codelineno-0-132>132</a></span>
<span class=normal><a href=#__codelineno-0-133>133</a></span>
<span class=normal><a href=#__codelineno-0-134>134</a></span>
<span class=normal><a href=#__codelineno-0-135>135</a></span>
<span class=normal><a href=#__codelineno-0-136>136</a></span>
<span class=normal><a href=#__codelineno-0-137>137</a></span>
<span class=normal><a href=#__codelineno-0-138>138</a></span>
<span class=normal><a href=#__codelineno-0-139>139</a></span>
<span class=normal><a href=#__codelineno-0-140>140</a></span>
<span class=normal><a href=#__codelineno-0-141>141</a></span>
<span class=normal><a href=#__codelineno-0-142>142</a></span>
<span class=normal><a href=#__codelineno-0-143>143</a></span>
<span class=normal><a href=#__codelineno-0-144>144</a></span>
<span class=normal><a href=#__codelineno-0-145>145</a></span>
<span class=normal><a href=#__codelineno-0-146>146</a></span>
<span class=normal><a href=#__codelineno-0-147>147</a></span>
<span class=normal><a href=#__codelineno-0-148>148</a></span>
<span class=normal><a href=#__codelineno-0-149>149</a></span>
<span class=normal><a href=#__codelineno-0-150>150</a></span>
<span class=normal><a href=#__codelineno-0-151>151</a></span>
<span class=normal><a href=#__codelineno-0-152>152</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-81><a id=__codelineno-0-81 name=__codelineno-0-81></a><span class=k>def</span><span class=w> </span><span class=nf>get_device_info</span><span class=p>():</span>
</span><span id=__span-0-82><a id=__codelineno-0-82 name=__codelineno-0-82></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-83><a id=__codelineno-0-83 name=__codelineno-0-83></a><span class=sd>    Get comprehensive device information for debugging.</span>
</span><span id=__span-0-84><a id=__codelineno-0-84 name=__codelineno-0-84></a>
</span><span id=__span-0-85><a id=__codelineno-0-85 name=__codelineno-0-85></a><span class=sd>    This function returns detailed information about the available PyTorch devices,</span>
</span><span id=__span-0-86><a id=__codelineno-0-86 name=__codelineno-0-86></a><span class=sd>    including CUDA and MPS availability, device counts, and capabilities.</span>
</span><span id=__span-0-87><a id=__codelineno-0-87 name=__codelineno-0-87></a><span class=sd>    Useful for debugging device-related issues and understanding the system</span>
</span><span id=__span-0-88><a id=__codelineno-0-88 name=__codelineno-0-88></a><span class=sd>    configuration.</span>
</span><span id=__span-0-89><a id=__codelineno-0-89 name=__codelineno-0-89></a>
</span><span id=__span-0-90><a id=__codelineno-0-90 name=__codelineno-0-90></a><span class=sd>    Returns:</span>
</span><span id=__span-0-91><a id=__codelineno-0-91 name=__codelineno-0-91></a><span class=sd>        dict: Device information dictionary containing:</span>
</span><span id=__span-0-92><a id=__codelineno-0-92 name=__codelineno-0-92></a><span class=sd>            - torch_available: Whether PyTorch is available</span>
</span><span id=__span-0-93><a id=__codelineno-0-93 name=__codelineno-0-93></a><span class=sd>            - cuda_available: Whether CUDA is available</span>
</span><span id=__span-0-94><a id=__codelineno-0-94 name=__codelineno-0-94></a><span class=sd>            - mps_available: Whether MPS (Apple Silicon) is available</span>
</span><span id=__span-0-95><a id=__codelineno-0-95 name=__codelineno-0-95></a><span class=sd>            - optimal_device: String representation of the optimal device</span>
</span><span id=__span-0-96><a id=__codelineno-0-96 name=__codelineno-0-96></a><span class=sd>            - cuda_device_count: Number of CUDA devices (if CUDA available)</span>
</span><span id=__span-0-97><a id=__codelineno-0-97 name=__codelineno-0-97></a><span class=sd>            - cuda_device_name: Name of the first CUDA device (if available)</span>
</span><span id=__span-0-98><a id=__codelineno-0-98 name=__codelineno-0-98></a><span class=sd>            - cuda_device_capability: Compute capability of first CUDA device</span>
</span><span id=__span-0-99><a id=__codelineno-0-99 name=__codelineno-0-99></a>
</span><span id=__span-0-100><a id=__codelineno-0-100 name=__codelineno-0-100></a><span class=sd>    Examples:</span>
</span><span id=__span-0-101><a id=__codelineno-0-101 name=__codelineno-0-101></a><span class=sd>        &gt;&gt;&gt; # Get device information</span>
</span><span id=__span-0-102><a id=__codelineno-0-102 name=__codelineno-0-102></a><span class=sd>        &gt;&gt;&gt; info = get_device_info()</span>
</span><span id=__span-0-103><a id=__codelineno-0-103 name=__codelineno-0-103></a><span class=sd>        &gt;&gt;&gt; print(f&quot;PyTorch available: {info[&#39;torch_available&#39;]}&quot;)</span>
</span><span id=__span-0-104><a id=__codelineno-0-104 name=__codelineno-0-104></a><span class=sd>        PyTorch available: True</span>
</span><span id=__span-0-105><a id=__codelineno-0-105 name=__codelineno-0-105></a><span class=sd>        &gt;&gt;&gt; print(f&quot;CUDA available: {info[&#39;cuda_available&#39;]}&quot;)</span>
</span><span id=__span-0-106><a id=__codelineno-0-106 name=__codelineno-0-106></a><span class=sd>        CUDA available: True</span>
</span><span id=__span-0-107><a id=__codelineno-0-107 name=__codelineno-0-107></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Optimal device: {info[&#39;optimal_device&#39;]}&quot;)</span>
</span><span id=__span-0-108><a id=__codelineno-0-108 name=__codelineno-0-108></a><span class=sd>        Optimal device: cuda</span>
</span><span id=__span-0-109><a id=__codelineno-0-109 name=__codelineno-0-109></a>
</span><span id=__span-0-110><a id=__codelineno-0-110 name=__codelineno-0-110></a><span class=sd>        &gt;&gt;&gt; # Check CUDA details</span>
</span><span id=__span-0-111><a id=__codelineno-0-111 name=__codelineno-0-111></a><span class=sd>        &gt;&gt;&gt; if info[&#39;cuda_available&#39;]:</span>
</span><span id=__span-0-112><a id=__codelineno-0-112 name=__codelineno-0-112></a><span class=sd>        ...     print(f&quot;CUDA devices: {info[&#39;cuda_device_count&#39;]}&quot;)</span>
</span><span id=__span-0-113><a id=__codelineno-0-113 name=__codelineno-0-113></a><span class=sd>        ...     print(f&quot;Device name: {info[&#39;cuda_device_name&#39;]}&quot;)</span>
</span><span id=__span-0-114><a id=__codelineno-0-114 name=__codelineno-0-114></a><span class=sd>        ...     print(f&quot;Capability: {info[&#39;cuda_device_capability&#39;]}&quot;)</span>
</span><span id=__span-0-115><a id=__codelineno-0-115 name=__codelineno-0-115></a><span class=sd>        CUDA devices: 1</span>
</span><span id=__span-0-116><a id=__codelineno-0-116 name=__codelineno-0-116></a><span class=sd>        Device name: NVIDIA GeForce RTX 3080</span>
</span><span id=__span-0-117><a id=__codelineno-0-117 name=__codelineno-0-117></a><span class=sd>        Capability: (8, 6)</span>
</span><span id=__span-0-118><a id=__codelineno-0-118 name=__codelineno-0-118></a>
</span><span id=__span-0-119><a id=__codelineno-0-119 name=__codelineno-0-119></a><span class=sd>        &gt;&gt;&gt; # Check MPS availability</span>
</span><span id=__span-0-120><a id=__codelineno-0-120 name=__codelineno-0-120></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MPS available: {info[&#39;mps_available&#39;]}&quot;)</span>
</span><span id=__span-0-121><a id=__codelineno-0-121 name=__codelineno-0-121></a><span class=sd>        MPS available: False</span>
</span><span id=__span-0-122><a id=__codelineno-0-122 name=__codelineno-0-122></a>
</span><span id=__span-0-123><a id=__codelineno-0-123 name=__codelineno-0-123></a><span class=sd>        &gt;&gt;&gt; # Handle PyTorch not available</span>
</span><span id=__span-0-124><a id=__codelineno-0-124 name=__codelineno-0-124></a><span class=sd>        &gt;&gt;&gt; # This would show torch_available: False if PyTorch is not installed</span>
</span><span id=__span-0-125><a id=__codelineno-0-125 name=__codelineno-0-125></a><span class=sd>        &gt;&gt;&gt; info = get_device_info()</span>
</span><span id=__span-0-126><a id=__codelineno-0-126 name=__codelineno-0-126></a><span class=sd>        &gt;&gt;&gt; if not info[&#39;torch_available&#39;]:</span>
</span><span id=__span-0-127><a id=__codelineno-0-127 name=__codelineno-0-127></a><span class=sd>        ...     print(&quot;PyTorch not available&quot;)</span>
</span><span id=__span-0-128><a id=__codelineno-0-128 name=__codelineno-0-128></a><span class=sd>        ... else:</span>
</span><span id=__span-0-129><a id=__codelineno-0-129 name=__codelineno-0-129></a><span class=sd>        ...     print(&quot;PyTorch is available&quot;)</span>
</span><span id=__span-0-130><a id=__codelineno-0-130 name=__codelineno-0-130></a><span class=sd>        PyTorch is available</span>
</span><span id=__span-0-131><a id=__codelineno-0-131 name=__codelineno-0-131></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-132><a id=__codelineno-0-132 name=__codelineno-0-132></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>TORCH_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-133><a id=__codelineno-0-133 name=__codelineno-0-133></a>        <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-134><a id=__codelineno-0-134 name=__codelineno-0-134></a>            <span class=s2>&quot;torch_available&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-135><a id=__codelineno-0-135 name=__codelineno-0-135></a>            <span class=s2>&quot;cuda_available&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-136><a id=__codelineno-0-136 name=__codelineno-0-136></a>            <span class=s2>&quot;mps_available&quot;</span><span class=p>:</span> <span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-137><a id=__codelineno-0-137 name=__codelineno-0-137></a>            <span class=s2>&quot;optimal_device&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-0-138><a id=__codelineno-0-138 name=__codelineno-0-138></a>        <span class=p>}</span>
</span><span id=__span-0-139><a id=__codelineno-0-139 name=__codelineno-0-139></a>
</span><span id=__span-0-140><a id=__codelineno-0-140 name=__codelineno-0-140></a>    <span class=n>info</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-141><a id=__codelineno-0-141 name=__codelineno-0-141></a>        <span class=s2>&quot;torch_available&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-142><a id=__codelineno-0-142 name=__codelineno-0-142></a>        <span class=s2>&quot;cuda_available&quot;</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>(),</span>
</span><span id=__span-0-143><a id=__codelineno-0-143 name=__codelineno-0-143></a>        <span class=s2>&quot;mps_available&quot;</span><span class=p>:</span> <span class=n>torch</span><span class=o>.</span><span class=n>backends</span><span class=o>.</span><span class=n>mps</span><span class=o>.</span><span class=n>is_available</span><span class=p>(),</span>
</span><span id=__span-0-144><a id=__codelineno-0-144 name=__codelineno-0-144></a>        <span class=s2>&quot;optimal_device&quot;</span><span class=p>:</span> <span class=nb>str</span><span class=p>(</span><span class=n>get_optimal_device</span><span class=p>()),</span>
</span><span id=__span-0-145><a id=__codelineno-0-145 name=__codelineno-0-145></a>    <span class=p>}</span>
</span><span id=__span-0-146><a id=__codelineno-0-146 name=__codelineno-0-146></a>
</span><span id=__span-0-147><a id=__codelineno-0-147 name=__codelineno-0-147></a>    <span class=k>if</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>is_available</span><span class=p>():</span>
</span><span id=__span-0-148><a id=__codelineno-0-148 name=__codelineno-0-148></a>        <span class=n>info</span><span class=p>[</span><span class=s2>&quot;cuda_device_count&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>device_count</span><span class=p>()</span>
</span><span id=__span-0-149><a id=__codelineno-0-149 name=__codelineno-0-149></a>        <span class=n>info</span><span class=p>[</span><span class=s2>&quot;cuda_device_name&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>get_device_name</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-150><a id=__codelineno-0-150 name=__codelineno-0-150></a>        <span class=n>info</span><span class=p>[</span><span class=s2>&quot;cuda_device_capability&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>cuda</span><span class=o>.</span><span class=n>get_device_capability</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-151><a id=__codelineno-0-151 name=__codelineno-0-151></a>
</span><span id=__span-0-152><a id=__codelineno-0-152 name=__codelineno-0-152></a>    <span class=k>return</span> <span class=n>info</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-module"> <h2 id=slaf.ml.tiledb_dataloaders class="doc doc-heading"> <code>slaf.ml.tiledb_dataloaders</code> <a href=#slaf.ml.tiledb_dataloaders class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents first"> <p>TileDB Dataloader for Single-Cell Data</p> <p>This module provides efficient streaming of single-cell data from TileDB SOMA format using PyTorch IterableDataset and DataLoader. It follows a similar pattern to SLAF's dataloader implementation for consistency and performance comparison.</p> <div class="doc doc-children"> <h3 id=slaf.ml.tiledb_dataloaders-classes>Classes<a href=#slaf.ml.tiledb_dataloaders-classes class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch class="doc doc-heading"> <code>TileDBPrefetchBatch</code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small> </span> <a href=#slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Container for a batch of TileDB data with metadata.</p> <p>This dataclass holds a processed batch of TileDB SOMA data along with associated metadata for tracking performance and debugging. It serves as the primary data structure passed between the batch processor and the async prefetcher.</p> <p><span class=doc-section-title>Attributes:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code><span title=slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch.batch_id>batch_id</span></code></td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Unique identifier for this batch within the current epoch.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><span title=slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch.batch_df>batch_df</span></code></td> <td> <code><span title=polars.DataFrame>DataFrame</span></code> </td> <td> <div class=doc-md-description> <p>Polars DataFrame containing the cell-gene expression data with columns: cell_integer_id, gene_integer_id, value.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><span title=slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch.cell_integer_ids>cell_integer_ids</span></code></td> <td> <code><span title=list>list</span>[<span title=int>int</span>]</code> </td> <td> <div class=doc-md-description> <p>List of unique cell IDs present in this batch.</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><span title=slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch.process_time>process_time</span></code></td> <td> <code><span title=float>float</span></code> </td> <td> <div class=doc-md-description> <p>Time taken to process this batch (in seconds).</p> </div> </td> </tr> <tr class=doc-section-item> <td><code><span title=slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch.memory_mb>memory_mb</span></code></td> <td> <code><span title=float>float</span></code> </td> <td> <div class=doc-md-description> <p>Memory usage at the time of batch creation (in MB).</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Create a batch container</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>TileDBPrefetchBatch</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>batch_id</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_df</span><span class=o>=</span><span class=n>df</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>cell_integer_ids</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>process_time</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=n>memory_mb</span><span class=o>=</span><span class=mf>128.5</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2> has </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>cell_integer_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> cells&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=go>Batch 0 has 4 cells</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-96> 96</a></span>
<span class=normal><a href=#__codelineno-0-97> 97</a></span>
<span class=normal><a href=#__codelineno-0-98> 98</a></span>
<span class=normal><a href=#__codelineno-0-99> 99</a></span>
<span class=normal><a href=#__codelineno-0-100>100</a></span>
<span class=normal><a href=#__codelineno-0-101>101</a></span>
<span class=normal><a href=#__codelineno-0-102>102</a></span>
<span class=normal><a href=#__codelineno-0-103>103</a></span>
<span class=normal><a href=#__codelineno-0-104>104</a></span>
<span class=normal><a href=#__codelineno-0-105>105</a></span>
<span class=normal><a href=#__codelineno-0-106>106</a></span>
<span class=normal><a href=#__codelineno-0-107>107</a></span>
<span class=normal><a href=#__codelineno-0-108>108</a></span>
<span class=normal><a href=#__codelineno-0-109>109</a></span>
<span class=normal><a href=#__codelineno-0-110>110</a></span>
<span class=normal><a href=#__codelineno-0-111>111</a></span>
<span class=normal><a href=#__codelineno-0-112>112</a></span>
<span class=normal><a href=#__codelineno-0-113>113</a></span>
<span class=normal><a href=#__codelineno-0-114>114</a></span>
<span class=normal><a href=#__codelineno-0-115>115</a></span>
<span class=normal><a href=#__codelineno-0-116>116</a></span>
<span class=normal><a href=#__codelineno-0-117>117</a></span>
<span class=normal><a href=#__codelineno-0-118>118</a></span>
<span class=normal><a href=#__codelineno-0-119>119</a></span>
<span class=normal><a href=#__codelineno-0-120>120</a></span>
<span class=normal><a href=#__codelineno-0-121>121</a></span>
<span class=normal><a href=#__codelineno-0-122>122</a></span>
<span class=normal><a href=#__codelineno-0-123>123</a></span>
<span class=normal><a href=#__codelineno-0-124>124</a></span>
<span class=normal><a href=#__codelineno-0-125>125</a></span>
<span class=normal><a href=#__codelineno-0-126>126</a></span>
<span class=normal><a href=#__codelineno-0-127>127</a></span>
<span class=normal><a href=#__codelineno-0-128>128</a></span>
<span class=normal><a href=#__codelineno-0-129>129</a></span>
<span class=normal><a href=#__codelineno-0-130>130</a></span>
<span class=normal><a href=#__codelineno-0-131>131</a></span>
<span class=normal><a href=#__codelineno-0-132>132</a></span>
<span class=normal><a href=#__codelineno-0-133>133</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-96><a id=__codelineno-0-96 name=__codelineno-0-96></a><span class=nd>@dataclass</span>
</span><span id=__span-0-97><a id=__codelineno-0-97 name=__codelineno-0-97></a><span class=k>class</span><span class=w> </span><span class=nc>TileDBPrefetchBatch</span><span class=p>:</span>
</span><span id=__span-0-98><a id=__codelineno-0-98 name=__codelineno-0-98></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-99><a id=__codelineno-0-99 name=__codelineno-0-99></a><span class=sd>    Container for a batch of TileDB data with metadata.</span>
</span><span id=__span-0-100><a id=__codelineno-0-100 name=__codelineno-0-100></a>
</span><span id=__span-0-101><a id=__codelineno-0-101 name=__codelineno-0-101></a><span class=sd>    This dataclass holds a processed batch of TileDB SOMA data along with</span>
</span><span id=__span-0-102><a id=__codelineno-0-102 name=__codelineno-0-102></a><span class=sd>    associated metadata for tracking performance and debugging. It serves as</span>
</span><span id=__span-0-103><a id=__codelineno-0-103 name=__codelineno-0-103></a><span class=sd>    the primary data structure passed between the batch processor and the</span>
</span><span id=__span-0-104><a id=__codelineno-0-104 name=__codelineno-0-104></a><span class=sd>    async prefetcher.</span>
</span><span id=__span-0-105><a id=__codelineno-0-105 name=__codelineno-0-105></a>
</span><span id=__span-0-106><a id=__codelineno-0-106 name=__codelineno-0-106></a><span class=sd>    Attributes:</span>
</span><span id=__span-0-107><a id=__codelineno-0-107 name=__codelineno-0-107></a><span class=sd>        batch_id: Unique identifier for this batch within the current epoch.</span>
</span><span id=__span-0-108><a id=__codelineno-0-108 name=__codelineno-0-108></a><span class=sd>        batch_df: Polars DataFrame containing the cell-gene expression data</span>
</span><span id=__span-0-109><a id=__codelineno-0-109 name=__codelineno-0-109></a><span class=sd>                 with columns: cell_integer_id, gene_integer_id, value.</span>
</span><span id=__span-0-110><a id=__codelineno-0-110 name=__codelineno-0-110></a><span class=sd>        cell_integer_ids: List of unique cell IDs present in this batch.</span>
</span><span id=__span-0-111><a id=__codelineno-0-111 name=__codelineno-0-111></a><span class=sd>        process_time: Time taken to process this batch (in seconds).</span>
</span><span id=__span-0-112><a id=__codelineno-0-112 name=__codelineno-0-112></a><span class=sd>        memory_mb: Memory usage at the time of batch creation (in MB).</span>
</span><span id=__span-0-113><a id=__codelineno-0-113 name=__codelineno-0-113></a>
</span><span id=__span-0-114><a id=__codelineno-0-114 name=__codelineno-0-114></a><span class=sd>    Examples:</span>
</span><span id=__span-0-115><a id=__codelineno-0-115 name=__codelineno-0-115></a><span class=sd>        &gt;&gt;&gt; # Create a batch container</span>
</span><span id=__span-0-116><a id=__codelineno-0-116 name=__codelineno-0-116></a><span class=sd>        &gt;&gt;&gt; batch = TileDBPrefetchBatch(</span>
</span><span id=__span-0-117><a id=__codelineno-0-117 name=__codelineno-0-117></a><span class=sd>        ...     batch_id=0,</span>
</span><span id=__span-0-118><a id=__codelineno-0-118 name=__codelineno-0-118></a><span class=sd>        ...     batch_df=df,</span>
</span><span id=__span-0-119><a id=__codelineno-0-119 name=__codelineno-0-119></a><span class=sd>        ...     cell_integer_ids=[0, 1, 2, 3],</span>
</span><span id=__span-0-120><a id=__codelineno-0-120 name=__codelineno-0-120></a><span class=sd>        ...     process_time=0.1,</span>
</span><span id=__span-0-121><a id=__codelineno-0-121 name=__codelineno-0-121></a><span class=sd>        ...     memory_mb=128.5</span>
</span><span id=__span-0-122><a id=__codelineno-0-122 name=__codelineno-0-122></a><span class=sd>        ... )</span>
</span><span id=__span-0-123><a id=__codelineno-0-123 name=__codelineno-0-123></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Batch {batch.batch_id} has {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-124><a id=__codelineno-0-124 name=__codelineno-0-124></a><span class=sd>        Batch 0 has 4 cells</span>
</span><span id=__span-0-125><a id=__codelineno-0-125 name=__codelineno-0-125></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-126><a id=__codelineno-0-126 name=__codelineno-0-126></a>
</span><span id=__span-0-127><a id=__codelineno-0-127 name=__codelineno-0-127></a>    <span class=n>batch_id</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-128><a id=__codelineno-0-128 name=__codelineno-0-128></a>    <span class=n>batch_df</span><span class=p>:</span> <span class=p>(</span>
</span><span id=__span-0-129><a id=__codelineno-0-129 name=__codelineno-0-129></a>        <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span>
</span><span id=__span-0-130><a id=__codelineno-0-130 name=__codelineno-0-130></a>    <span class=p>)</span>  <span class=c1># Polars DataFrame with cell_integer_id, gene_integer_id, value</span>
</span><span id=__span-0-131><a id=__codelineno-0-131 name=__codelineno-0-131></a>    <span class=n>cell_integer_ids</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>  <span class=c1># List of cell IDs in this batch</span>
</span><span id=__span-0-132><a id=__codelineno-0-132 name=__codelineno-0-132></a>    <span class=n>process_time</span><span class=p>:</span> <span class=nb>float</span>
</span><span id=__span-0-133><a id=__codelineno-0-133 name=__codelineno-0-133></a>    <span class=n>memory_mb</span><span class=p>:</span> <span class=nb>float</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> </div> </div> </div> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tiledb_dataloaders.TileDBBatchProcessor class="doc doc-heading"> <code>TileDBBatchProcessor</code> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>High-performance batch processor for TileDB SOMA data with multiple loading strategies.</p> <p>TileDBBatchProcessor provides efficient streaming and processing of single-cell data from TileDB SOMA format. It supports multiple loading strategies including Mixture of Scanners (MoS) for maximum entropy and sequential loading for maximum throughput.</p> <details class=key-features open> <summary>Key Features</summary> <ul> <li>Multiple loading strategies:<ul> <li>Mixture of Scanners (MoS): Random sampling from multiple generators for maximum entropy and randomization (default)</li> <li>Sequential loading: Contiguous data loading for maximum throughput</li> </ul> </li> <li>Streaming data processing with configurable batch sizes</li> <li>Built-in shuffling strategies for data randomization</li> <li>Multi-epoch training support with automatic epoch transitions</li> <li>Comprehensive timing and memory monitoring</li> <li>Error handling and recovery mechanisms</li> <li>Configurable prefetch batch sizes for different dataset sizes</li> </ul> </details> <details class=loading-strategies open> <summary>Loading Strategies</summary> <ol> <li>Mixture of Scanners (default): Randomly samples from multiple fragment generators for maximum entropy and randomization</li> <li>Sequential: Loads contiguous data chunks for maximum throughput</li> </ol> </details> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic usage with default MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>load_prefetch_batch</span><span class=p>()</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Loaded batch with </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>cell_integer_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> cells&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>Loaded batch with 100 cells</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS enabled: False</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Multi-epoch training</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_epochs</span><span class=o>=</span><span class=mi>3</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Number of epochs: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>n_epochs</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Number of epochs: 3</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-136>136</a></span>
<span class=normal><a href=#__codelineno-0-137>137</a></span>
<span class=normal><a href=#__codelineno-0-138>138</a></span>
<span class=normal><a href=#__codelineno-0-139>139</a></span>
<span class=normal><a href=#__codelineno-0-140>140</a></span>
<span class=normal><a href=#__codelineno-0-141>141</a></span>
<span class=normal><a href=#__codelineno-0-142>142</a></span>
<span class=normal><a href=#__codelineno-0-143>143</a></span>
<span class=normal><a href=#__codelineno-0-144>144</a></span>
<span class=normal><a href=#__codelineno-0-145>145</a></span>
<span class=normal><a href=#__codelineno-0-146>146</a></span>
<span class=normal><a href=#__codelineno-0-147>147</a></span>
<span class=normal><a href=#__codelineno-0-148>148</a></span>
<span class=normal><a href=#__codelineno-0-149>149</a></span>
<span class=normal><a href=#__codelineno-0-150>150</a></span>
<span class=normal><a href=#__codelineno-0-151>151</a></span>
<span class=normal><a href=#__codelineno-0-152>152</a></span>
<span class=normal><a href=#__codelineno-0-153>153</a></span>
<span class=normal><a href=#__codelineno-0-154>154</a></span>
<span class=normal><a href=#__codelineno-0-155>155</a></span>
<span class=normal><a href=#__codelineno-0-156>156</a></span>
<span class=normal><a href=#__codelineno-0-157>157</a></span>
<span class=normal><a href=#__codelineno-0-158>158</a></span>
<span class=normal><a href=#__codelineno-0-159>159</a></span>
<span class=normal><a href=#__codelineno-0-160>160</a></span>
<span class=normal><a href=#__codelineno-0-161>161</a></span>
<span class=normal><a href=#__codelineno-0-162>162</a></span>
<span class=normal><a href=#__codelineno-0-163>163</a></span>
<span class=normal><a href=#__codelineno-0-164>164</a></span>
<span class=normal><a href=#__codelineno-0-165>165</a></span>
<span class=normal><a href=#__codelineno-0-166>166</a></span>
<span class=normal><a href=#__codelineno-0-167>167</a></span>
<span class=normal><a href=#__codelineno-0-168>168</a></span>
<span class=normal><a href=#__codelineno-0-169>169</a></span>
<span class=normal><a href=#__codelineno-0-170>170</a></span>
<span class=normal><a href=#__codelineno-0-171>171</a></span>
<span class=normal><a href=#__codelineno-0-172>172</a></span>
<span class=normal><a href=#__codelineno-0-173>173</a></span>
<span class=normal><a href=#__codelineno-0-174>174</a></span>
<span class=normal><a href=#__codelineno-0-175>175</a></span>
<span class=normal><a href=#__codelineno-0-176>176</a></span>
<span class=normal><a href=#__codelineno-0-177>177</a></span>
<span class=normal><a href=#__codelineno-0-178>178</a></span>
<span class=normal><a href=#__codelineno-0-179>179</a></span>
<span class=normal><a href=#__codelineno-0-180>180</a></span>
<span class=normal><a href=#__codelineno-0-181>181</a></span>
<span class=normal><a href=#__codelineno-0-182>182</a></span>
<span class=normal><a href=#__codelineno-0-183>183</a></span>
<span class=normal><a href=#__codelineno-0-184>184</a></span>
<span class=normal><a href=#__codelineno-0-185>185</a></span>
<span class=normal><a href=#__codelineno-0-186>186</a></span>
<span class=normal><a href=#__codelineno-0-187>187</a></span>
<span class=normal><a href=#__codelineno-0-188>188</a></span>
<span class=normal><a href=#__codelineno-0-189>189</a></span>
<span class=normal><a href=#__codelineno-0-190>190</a></span>
<span class=normal><a href=#__codelineno-0-191>191</a></span>
<span class=normal><a href=#__codelineno-0-192>192</a></span>
<span class=normal><a href=#__codelineno-0-193>193</a></span>
<span class=normal><a href=#__codelineno-0-194>194</a></span>
<span class=normal><a href=#__codelineno-0-195>195</a></span>
<span class=normal><a href=#__codelineno-0-196>196</a></span>
<span class=normal><a href=#__codelineno-0-197>197</a></span>
<span class=normal><a href=#__codelineno-0-198>198</a></span>
<span class=normal><a href=#__codelineno-0-199>199</a></span>
<span class=normal><a href=#__codelineno-0-200>200</a></span>
<span class=normal><a href=#__codelineno-0-201>201</a></span>
<span class=normal><a href=#__codelineno-0-202>202</a></span>
<span class=normal><a href=#__codelineno-0-203>203</a></span>
<span class=normal><a href=#__codelineno-0-204>204</a></span>
<span class=normal><a href=#__codelineno-0-205>205</a></span>
<span class=normal><a href=#__codelineno-0-206>206</a></span>
<span class=normal><a href=#__codelineno-0-207>207</a></span>
<span class=normal><a href=#__codelineno-0-208>208</a></span>
<span class=normal><a href=#__codelineno-0-209>209</a></span>
<span class=normal><a href=#__codelineno-0-210>210</a></span>
<span class=normal><a href=#__codelineno-0-211>211</a></span>
<span class=normal><a href=#__codelineno-0-212>212</a></span>
<span class=normal><a href=#__codelineno-0-213>213</a></span>
<span class=normal><a href=#__codelineno-0-214>214</a></span>
<span class=normal><a href=#__codelineno-0-215>215</a></span>
<span class=normal><a href=#__codelineno-0-216>216</a></span>
<span class=normal><a href=#__codelineno-0-217>217</a></span>
<span class=normal><a href=#__codelineno-0-218>218</a></span>
<span class=normal><a href=#__codelineno-0-219>219</a></span>
<span class=normal><a href=#__codelineno-0-220>220</a></span>
<span class=normal><a href=#__codelineno-0-221>221</a></span>
<span class=normal><a href=#__codelineno-0-222>222</a></span>
<span class=normal><a href=#__codelineno-0-223>223</a></span>
<span class=normal><a href=#__codelineno-0-224>224</a></span>
<span class=normal><a href=#__codelineno-0-225>225</a></span>
<span class=normal><a href=#__codelineno-0-226>226</a></span>
<span class=normal><a href=#__codelineno-0-227>227</a></span>
<span class=normal><a href=#__codelineno-0-228>228</a></span>
<span class=normal><a href=#__codelineno-0-229>229</a></span>
<span class=normal><a href=#__codelineno-0-230>230</a></span>
<span class=normal><a href=#__codelineno-0-231>231</a></span>
<span class=normal><a href=#__codelineno-0-232>232</a></span>
<span class=normal><a href=#__codelineno-0-233>233</a></span>
<span class=normal><a href=#__codelineno-0-234>234</a></span>
<span class=normal><a href=#__codelineno-0-235>235</a></span>
<span class=normal><a href=#__codelineno-0-236>236</a></span>
<span class=normal><a href=#__codelineno-0-237>237</a></span>
<span class=normal><a href=#__codelineno-0-238>238</a></span>
<span class=normal><a href=#__codelineno-0-239>239</a></span>
<span class=normal><a href=#__codelineno-0-240>240</a></span>
<span class=normal><a href=#__codelineno-0-241>241</a></span>
<span class=normal><a href=#__codelineno-0-242>242</a></span>
<span class=normal><a href=#__codelineno-0-243>243</a></span>
<span class=normal><a href=#__codelineno-0-244>244</a></span>
<span class=normal><a href=#__codelineno-0-245>245</a></span>
<span class=normal><a href=#__codelineno-0-246>246</a></span>
<span class=normal><a href=#__codelineno-0-247>247</a></span>
<span class=normal><a href=#__codelineno-0-248>248</a></span>
<span class=normal><a href=#__codelineno-0-249>249</a></span>
<span class=normal><a href=#__codelineno-0-250>250</a></span>
<span class=normal><a href=#__codelineno-0-251>251</a></span>
<span class=normal><a href=#__codelineno-0-252>252</a></span>
<span class=normal><a href=#__codelineno-0-253>253</a></span>
<span class=normal><a href=#__codelineno-0-254>254</a></span>
<span class=normal><a href=#__codelineno-0-255>255</a></span>
<span class=normal><a href=#__codelineno-0-256>256</a></span>
<span class=normal><a href=#__codelineno-0-257>257</a></span>
<span class=normal><a href=#__codelineno-0-258>258</a></span>
<span class=normal><a href=#__codelineno-0-259>259</a></span>
<span class=normal><a href=#__codelineno-0-260>260</a></span>
<span class=normal><a href=#__codelineno-0-261>261</a></span>
<span class=normal><a href=#__codelineno-0-262>262</a></span>
<span class=normal><a href=#__codelineno-0-263>263</a></span>
<span class=normal><a href=#__codelineno-0-264>264</a></span>
<span class=normal><a href=#__codelineno-0-265>265</a></span>
<span class=normal><a href=#__codelineno-0-266>266</a></span>
<span class=normal><a href=#__codelineno-0-267>267</a></span>
<span class=normal><a href=#__codelineno-0-268>268</a></span>
<span class=normal><a href=#__codelineno-0-269>269</a></span>
<span class=normal><a href=#__codelineno-0-270>270</a></span>
<span class=normal><a href=#__codelineno-0-271>271</a></span>
<span class=normal><a href=#__codelineno-0-272>272</a></span>
<span class=normal><a href=#__codelineno-0-273>273</a></span>
<span class=normal><a href=#__codelineno-0-274>274</a></span>
<span class=normal><a href=#__codelineno-0-275>275</a></span>
<span class=normal><a href=#__codelineno-0-276>276</a></span>
<span class=normal><a href=#__codelineno-0-277>277</a></span>
<span class=normal><a href=#__codelineno-0-278>278</a></span>
<span class=normal><a href=#__codelineno-0-279>279</a></span>
<span class=normal><a href=#__codelineno-0-280>280</a></span>
<span class=normal><a href=#__codelineno-0-281>281</a></span>
<span class=normal><a href=#__codelineno-0-282>282</a></span>
<span class=normal><a href=#__codelineno-0-283>283</a></span>
<span class=normal><a href=#__codelineno-0-284>284</a></span>
<span class=normal><a href=#__codelineno-0-285>285</a></span>
<span class=normal><a href=#__codelineno-0-286>286</a></span>
<span class=normal><a href=#__codelineno-0-287>287</a></span>
<span class=normal><a href=#__codelineno-0-288>288</a></span>
<span class=normal><a href=#__codelineno-0-289>289</a></span>
<span class=normal><a href=#__codelineno-0-290>290</a></span>
<span class=normal><a href=#__codelineno-0-291>291</a></span>
<span class=normal><a href=#__codelineno-0-292>292</a></span>
<span class=normal><a href=#__codelineno-0-293>293</a></span>
<span class=normal><a href=#__codelineno-0-294>294</a></span>
<span class=normal><a href=#__codelineno-0-295>295</a></span>
<span class=normal><a href=#__codelineno-0-296>296</a></span>
<span class=normal><a href=#__codelineno-0-297>297</a></span>
<span class=normal><a href=#__codelineno-0-298>298</a></span>
<span class=normal><a href=#__codelineno-0-299>299</a></span>
<span class=normal><a href=#__codelineno-0-300>300</a></span>
<span class=normal><a href=#__codelineno-0-301>301</a></span>
<span class=normal><a href=#__codelineno-0-302>302</a></span>
<span class=normal><a href=#__codelineno-0-303>303</a></span>
<span class=normal><a href=#__codelineno-0-304>304</a></span>
<span class=normal><a href=#__codelineno-0-305>305</a></span>
<span class=normal><a href=#__codelineno-0-306>306</a></span>
<span class=normal><a href=#__codelineno-0-307>307</a></span>
<span class=normal><a href=#__codelineno-0-308>308</a></span>
<span class=normal><a href=#__codelineno-0-309>309</a></span>
<span class=normal><a href=#__codelineno-0-310>310</a></span>
<span class=normal><a href=#__codelineno-0-311>311</a></span>
<span class=normal><a href=#__codelineno-0-312>312</a></span>
<span class=normal><a href=#__codelineno-0-313>313</a></span>
<span class=normal><a href=#__codelineno-0-314>314</a></span>
<span class=normal><a href=#__codelineno-0-315>315</a></span>
<span class=normal><a href=#__codelineno-0-316>316</a></span>
<span class=normal><a href=#__codelineno-0-317>317</a></span>
<span class=normal><a href=#__codelineno-0-318>318</a></span>
<span class=normal><a href=#__codelineno-0-319>319</a></span>
<span class=normal><a href=#__codelineno-0-320>320</a></span>
<span class=normal><a href=#__codelineno-0-321>321</a></span>
<span class=normal><a href=#__codelineno-0-322>322</a></span>
<span class=normal><a href=#__codelineno-0-323>323</a></span>
<span class=normal><a href=#__codelineno-0-324>324</a></span>
<span class=normal><a href=#__codelineno-0-325>325</a></span>
<span class=normal><a href=#__codelineno-0-326>326</a></span>
<span class=normal><a href=#__codelineno-0-327>327</a></span>
<span class=normal><a href=#__codelineno-0-328>328</a></span>
<span class=normal><a href=#__codelineno-0-329>329</a></span>
<span class=normal><a href=#__codelineno-0-330>330</a></span>
<span class=normal><a href=#__codelineno-0-331>331</a></span>
<span class=normal><a href=#__codelineno-0-332>332</a></span>
<span class=normal><a href=#__codelineno-0-333>333</a></span>
<span class=normal><a href=#__codelineno-0-334>334</a></span>
<span class=normal><a href=#__codelineno-0-335>335</a></span>
<span class=normal><a href=#__codelineno-0-336>336</a></span>
<span class=normal><a href=#__codelineno-0-337>337</a></span>
<span class=normal><a href=#__codelineno-0-338>338</a></span>
<span class=normal><a href=#__codelineno-0-339>339</a></span>
<span class=normal><a href=#__codelineno-0-340>340</a></span>
<span class=normal><a href=#__codelineno-0-341>341</a></span>
<span class=normal><a href=#__codelineno-0-342>342</a></span>
<span class=normal><a href=#__codelineno-0-343>343</a></span>
<span class=normal><a href=#__codelineno-0-344>344</a></span>
<span class=normal><a href=#__codelineno-0-345>345</a></span>
<span class=normal><a href=#__codelineno-0-346>346</a></span>
<span class=normal><a href=#__codelineno-0-347>347</a></span>
<span class=normal><a href=#__codelineno-0-348>348</a></span>
<span class=normal><a href=#__codelineno-0-349>349</a></span>
<span class=normal><a href=#__codelineno-0-350>350</a></span>
<span class=normal><a href=#__codelineno-0-351>351</a></span>
<span class=normal><a href=#__codelineno-0-352>352</a></span>
<span class=normal><a href=#__codelineno-0-353>353</a></span>
<span class=normal><a href=#__codelineno-0-354>354</a></span>
<span class=normal><a href=#__codelineno-0-355>355</a></span>
<span class=normal><a href=#__codelineno-0-356>356</a></span>
<span class=normal><a href=#__codelineno-0-357>357</a></span>
<span class=normal><a href=#__codelineno-0-358>358</a></span>
<span class=normal><a href=#__codelineno-0-359>359</a></span>
<span class=normal><a href=#__codelineno-0-360>360</a></span>
<span class=normal><a href=#__codelineno-0-361>361</a></span>
<span class=normal><a href=#__codelineno-0-362>362</a></span>
<span class=normal><a href=#__codelineno-0-363>363</a></span>
<span class=normal><a href=#__codelineno-0-364>364</a></span>
<span class=normal><a href=#__codelineno-0-365>365</a></span>
<span class=normal><a href=#__codelineno-0-366>366</a></span>
<span class=normal><a href=#__codelineno-0-367>367</a></span>
<span class=normal><a href=#__codelineno-0-368>368</a></span>
<span class=normal><a href=#__codelineno-0-369>369</a></span>
<span class=normal><a href=#__codelineno-0-370>370</a></span>
<span class=normal><a href=#__codelineno-0-371>371</a></span>
<span class=normal><a href=#__codelineno-0-372>372</a></span>
<span class=normal><a href=#__codelineno-0-373>373</a></span>
<span class=normal><a href=#__codelineno-0-374>374</a></span>
<span class=normal><a href=#__codelineno-0-375>375</a></span>
<span class=normal><a href=#__codelineno-0-376>376</a></span>
<span class=normal><a href=#__codelineno-0-377>377</a></span>
<span class=normal><a href=#__codelineno-0-378>378</a></span>
<span class=normal><a href=#__codelineno-0-379>379</a></span>
<span class=normal><a href=#__codelineno-0-380>380</a></span>
<span class=normal><a href=#__codelineno-0-381>381</a></span>
<span class=normal><a href=#__codelineno-0-382>382</a></span>
<span class=normal><a href=#__codelineno-0-383>383</a></span>
<span class=normal><a href=#__codelineno-0-384>384</a></span>
<span class=normal><a href=#__codelineno-0-385>385</a></span>
<span class=normal><a href=#__codelineno-0-386>386</a></span>
<span class=normal><a href=#__codelineno-0-387>387</a></span>
<span class=normal><a href=#__codelineno-0-388>388</a></span>
<span class=normal><a href=#__codelineno-0-389>389</a></span>
<span class=normal><a href=#__codelineno-0-390>390</a></span>
<span class=normal><a href=#__codelineno-0-391>391</a></span>
<span class=normal><a href=#__codelineno-0-392>392</a></span>
<span class=normal><a href=#__codelineno-0-393>393</a></span>
<span class=normal><a href=#__codelineno-0-394>394</a></span>
<span class=normal><a href=#__codelineno-0-395>395</a></span>
<span class=normal><a href=#__codelineno-0-396>396</a></span>
<span class=normal><a href=#__codelineno-0-397>397</a></span>
<span class=normal><a href=#__codelineno-0-398>398</a></span>
<span class=normal><a href=#__codelineno-0-399>399</a></span>
<span class=normal><a href=#__codelineno-0-400>400</a></span>
<span class=normal><a href=#__codelineno-0-401>401</a></span>
<span class=normal><a href=#__codelineno-0-402>402</a></span>
<span class=normal><a href=#__codelineno-0-403>403</a></span>
<span class=normal><a href=#__codelineno-0-404>404</a></span>
<span class=normal><a href=#__codelineno-0-405>405</a></span>
<span class=normal><a href=#__codelineno-0-406>406</a></span>
<span class=normal><a href=#__codelineno-0-407>407</a></span>
<span class=normal><a href=#__codelineno-0-408>408</a></span>
<span class=normal><a href=#__codelineno-0-409>409</a></span>
<span class=normal><a href=#__codelineno-0-410>410</a></span>
<span class=normal><a href=#__codelineno-0-411>411</a></span>
<span class=normal><a href=#__codelineno-0-412>412</a></span>
<span class=normal><a href=#__codelineno-0-413>413</a></span>
<span class=normal><a href=#__codelineno-0-414>414</a></span>
<span class=normal><a href=#__codelineno-0-415>415</a></span>
<span class=normal><a href=#__codelineno-0-416>416</a></span>
<span class=normal><a href=#__codelineno-0-417>417</a></span>
<span class=normal><a href=#__codelineno-0-418>418</a></span>
<span class=normal><a href=#__codelineno-0-419>419</a></span>
<span class=normal><a href=#__codelineno-0-420>420</a></span>
<span class=normal><a href=#__codelineno-0-421>421</a></span>
<span class=normal><a href=#__codelineno-0-422>422</a></span>
<span class=normal><a href=#__codelineno-0-423>423</a></span>
<span class=normal><a href=#__codelineno-0-424>424</a></span>
<span class=normal><a href=#__codelineno-0-425>425</a></span>
<span class=normal><a href=#__codelineno-0-426>426</a></span>
<span class=normal><a href=#__codelineno-0-427>427</a></span>
<span class=normal><a href=#__codelineno-0-428>428</a></span>
<span class=normal><a href=#__codelineno-0-429>429</a></span>
<span class=normal><a href=#__codelineno-0-430>430</a></span>
<span class=normal><a href=#__codelineno-0-431>431</a></span>
<span class=normal><a href=#__codelineno-0-432>432</a></span>
<span class=normal><a href=#__codelineno-0-433>433</a></span>
<span class=normal><a href=#__codelineno-0-434>434</a></span>
<span class=normal><a href=#__codelineno-0-435>435</a></span>
<span class=normal><a href=#__codelineno-0-436>436</a></span>
<span class=normal><a href=#__codelineno-0-437>437</a></span>
<span class=normal><a href=#__codelineno-0-438>438</a></span>
<span class=normal><a href=#__codelineno-0-439>439</a></span>
<span class=normal><a href=#__codelineno-0-440>440</a></span>
<span class=normal><a href=#__codelineno-0-441>441</a></span>
<span class=normal><a href=#__codelineno-0-442>442</a></span>
<span class=normal><a href=#__codelineno-0-443>443</a></span>
<span class=normal><a href=#__codelineno-0-444>444</a></span>
<span class=normal><a href=#__codelineno-0-445>445</a></span>
<span class=normal><a href=#__codelineno-0-446>446</a></span>
<span class=normal><a href=#__codelineno-0-447>447</a></span>
<span class=normal><a href=#__codelineno-0-448>448</a></span>
<span class=normal><a href=#__codelineno-0-449>449</a></span>
<span class=normal><a href=#__codelineno-0-450>450</a></span>
<span class=normal><a href=#__codelineno-0-451>451</a></span>
<span class=normal><a href=#__codelineno-0-452>452</a></span>
<span class=normal><a href=#__codelineno-0-453>453</a></span>
<span class=normal><a href=#__codelineno-0-454>454</a></span>
<span class=normal><a href=#__codelineno-0-455>455</a></span>
<span class=normal><a href=#__codelineno-0-456>456</a></span>
<span class=normal><a href=#__codelineno-0-457>457</a></span>
<span class=normal><a href=#__codelineno-0-458>458</a></span>
<span class=normal><a href=#__codelineno-0-459>459</a></span>
<span class=normal><a href=#__codelineno-0-460>460</a></span>
<span class=normal><a href=#__codelineno-0-461>461</a></span>
<span class=normal><a href=#__codelineno-0-462>462</a></span>
<span class=normal><a href=#__codelineno-0-463>463</a></span>
<span class=normal><a href=#__codelineno-0-464>464</a></span>
<span class=normal><a href=#__codelineno-0-465>465</a></span>
<span class=normal><a href=#__codelineno-0-466>466</a></span>
<span class=normal><a href=#__codelineno-0-467>467</a></span>
<span class=normal><a href=#__codelineno-0-468>468</a></span>
<span class=normal><a href=#__codelineno-0-469>469</a></span>
<span class=normal><a href=#__codelineno-0-470>470</a></span>
<span class=normal><a href=#__codelineno-0-471>471</a></span>
<span class=normal><a href=#__codelineno-0-472>472</a></span>
<span class=normal><a href=#__codelineno-0-473>473</a></span>
<span class=normal><a href=#__codelineno-0-474>474</a></span>
<span class=normal><a href=#__codelineno-0-475>475</a></span>
<span class=normal><a href=#__codelineno-0-476>476</a></span>
<span class=normal><a href=#__codelineno-0-477>477</a></span>
<span class=normal><a href=#__codelineno-0-478>478</a></span>
<span class=normal><a href=#__codelineno-0-479>479</a></span>
<span class=normal><a href=#__codelineno-0-480>480</a></span>
<span class=normal><a href=#__codelineno-0-481>481</a></span>
<span class=normal><a href=#__codelineno-0-482>482</a></span>
<span class=normal><a href=#__codelineno-0-483>483</a></span>
<span class=normal><a href=#__codelineno-0-484>484</a></span>
<span class=normal><a href=#__codelineno-0-485>485</a></span>
<span class=normal><a href=#__codelineno-0-486>486</a></span>
<span class=normal><a href=#__codelineno-0-487>487</a></span>
<span class=normal><a href=#__codelineno-0-488>488</a></span>
<span class=normal><a href=#__codelineno-0-489>489</a></span>
<span class=normal><a href=#__codelineno-0-490>490</a></span>
<span class=normal><a href=#__codelineno-0-491>491</a></span>
<span class=normal><a href=#__codelineno-0-492>492</a></span>
<span class=normal><a href=#__codelineno-0-493>493</a></span>
<span class=normal><a href=#__codelineno-0-494>494</a></span>
<span class=normal><a href=#__codelineno-0-495>495</a></span>
<span class=normal><a href=#__codelineno-0-496>496</a></span>
<span class=normal><a href=#__codelineno-0-497>497</a></span>
<span class=normal><a href=#__codelineno-0-498>498</a></span>
<span class=normal><a href=#__codelineno-0-499>499</a></span>
<span class=normal><a href=#__codelineno-0-500>500</a></span>
<span class=normal><a href=#__codelineno-0-501>501</a></span>
<span class=normal><a href=#__codelineno-0-502>502</a></span>
<span class=normal><a href=#__codelineno-0-503>503</a></span>
<span class=normal><a href=#__codelineno-0-504>504</a></span>
<span class=normal><a href=#__codelineno-0-505>505</a></span>
<span class=normal><a href=#__codelineno-0-506>506</a></span>
<span class=normal><a href=#__codelineno-0-507>507</a></span>
<span class=normal><a href=#__codelineno-0-508>508</a></span>
<span class=normal><a href=#__codelineno-0-509>509</a></span>
<span class=normal><a href=#__codelineno-0-510>510</a></span>
<span class=normal><a href=#__codelineno-0-511>511</a></span>
<span class=normal><a href=#__codelineno-0-512>512</a></span>
<span class=normal><a href=#__codelineno-0-513>513</a></span>
<span class=normal><a href=#__codelineno-0-514>514</a></span>
<span class=normal><a href=#__codelineno-0-515>515</a></span>
<span class=normal><a href=#__codelineno-0-516>516</a></span>
<span class=normal><a href=#__codelineno-0-517>517</a></span>
<span class=normal><a href=#__codelineno-0-518>518</a></span>
<span class=normal><a href=#__codelineno-0-519>519</a></span>
<span class=normal><a href=#__codelineno-0-520>520</a></span>
<span class=normal><a href=#__codelineno-0-521>521</a></span>
<span class=normal><a href=#__codelineno-0-522>522</a></span>
<span class=normal><a href=#__codelineno-0-523>523</a></span>
<span class=normal><a href=#__codelineno-0-524>524</a></span>
<span class=normal><a href=#__codelineno-0-525>525</a></span>
<span class=normal><a href=#__codelineno-0-526>526</a></span>
<span class=normal><a href=#__codelineno-0-527>527</a></span>
<span class=normal><a href=#__codelineno-0-528>528</a></span>
<span class=normal><a href=#__codelineno-0-529>529</a></span>
<span class=normal><a href=#__codelineno-0-530>530</a></span>
<span class=normal><a href=#__codelineno-0-531>531</a></span>
<span class=normal><a href=#__codelineno-0-532>532</a></span>
<span class=normal><a href=#__codelineno-0-533>533</a></span>
<span class=normal><a href=#__codelineno-0-534>534</a></span>
<span class=normal><a href=#__codelineno-0-535>535</a></span>
<span class=normal><a href=#__codelineno-0-536>536</a></span>
<span class=normal><a href=#__codelineno-0-537>537</a></span>
<span class=normal><a href=#__codelineno-0-538>538</a></span>
<span class=normal><a href=#__codelineno-0-539>539</a></span>
<span class=normal><a href=#__codelineno-0-540>540</a></span>
<span class=normal><a href=#__codelineno-0-541>541</a></span>
<span class=normal><a href=#__codelineno-0-542>542</a></span>
<span class=normal><a href=#__codelineno-0-543>543</a></span>
<span class=normal><a href=#__codelineno-0-544>544</a></span>
<span class=normal><a href=#__codelineno-0-545>545</a></span>
<span class=normal><a href=#__codelineno-0-546>546</a></span>
<span class=normal><a href=#__codelineno-0-547>547</a></span>
<span class=normal><a href=#__codelineno-0-548>548</a></span>
<span class=normal><a href=#__codelineno-0-549>549</a></span>
<span class=normal><a href=#__codelineno-0-550>550</a></span>
<span class=normal><a href=#__codelineno-0-551>551</a></span>
<span class=normal><a href=#__codelineno-0-552>552</a></span>
<span class=normal><a href=#__codelineno-0-553>553</a></span>
<span class=normal><a href=#__codelineno-0-554>554</a></span>
<span class=normal><a href=#__codelineno-0-555>555</a></span>
<span class=normal><a href=#__codelineno-0-556>556</a></span>
<span class=normal><a href=#__codelineno-0-557>557</a></span>
<span class=normal><a href=#__codelineno-0-558>558</a></span>
<span class=normal><a href=#__codelineno-0-559>559</a></span>
<span class=normal><a href=#__codelineno-0-560>560</a></span>
<span class=normal><a href=#__codelineno-0-561>561</a></span>
<span class=normal><a href=#__codelineno-0-562>562</a></span>
<span class=normal><a href=#__codelineno-0-563>563</a></span>
<span class=normal><a href=#__codelineno-0-564>564</a></span>
<span class=normal><a href=#__codelineno-0-565>565</a></span>
<span class=normal><a href=#__codelineno-0-566>566</a></span>
<span class=normal><a href=#__codelineno-0-567>567</a></span>
<span class=normal><a href=#__codelineno-0-568>568</a></span>
<span class=normal><a href=#__codelineno-0-569>569</a></span>
<span class=normal><a href=#__codelineno-0-570>570</a></span>
<span class=normal><a href=#__codelineno-0-571>571</a></span>
<span class=normal><a href=#__codelineno-0-572>572</a></span>
<span class=normal><a href=#__codelineno-0-573>573</a></span>
<span class=normal><a href=#__codelineno-0-574>574</a></span>
<span class=normal><a href=#__codelineno-0-575>575</a></span>
<span class=normal><a href=#__codelineno-0-576>576</a></span>
<span class=normal><a href=#__codelineno-0-577>577</a></span>
<span class=normal><a href=#__codelineno-0-578>578</a></span>
<span class=normal><a href=#__codelineno-0-579>579</a></span>
<span class=normal><a href=#__codelineno-0-580>580</a></span>
<span class=normal><a href=#__codelineno-0-581>581</a></span>
<span class=normal><a href=#__codelineno-0-582>582</a></span>
<span class=normal><a href=#__codelineno-0-583>583</a></span>
<span class=normal><a href=#__codelineno-0-584>584</a></span>
<span class=normal><a href=#__codelineno-0-585>585</a></span>
<span class=normal><a href=#__codelineno-0-586>586</a></span>
<span class=normal><a href=#__codelineno-0-587>587</a></span>
<span class=normal><a href=#__codelineno-0-588>588</a></span>
<span class=normal><a href=#__codelineno-0-589>589</a></span>
<span class=normal><a href=#__codelineno-0-590>590</a></span>
<span class=normal><a href=#__codelineno-0-591>591</a></span>
<span class=normal><a href=#__codelineno-0-592>592</a></span>
<span class=normal><a href=#__codelineno-0-593>593</a></span>
<span class=normal><a href=#__codelineno-0-594>594</a></span>
<span class=normal><a href=#__codelineno-0-595>595</a></span>
<span class=normal><a href=#__codelineno-0-596>596</a></span>
<span class=normal><a href=#__codelineno-0-597>597</a></span>
<span class=normal><a href=#__codelineno-0-598>598</a></span>
<span class=normal><a href=#__codelineno-0-599>599</a></span>
<span class=normal><a href=#__codelineno-0-600>600</a></span>
<span class=normal><a href=#__codelineno-0-601>601</a></span>
<span class=normal><a href=#__codelineno-0-602>602</a></span>
<span class=normal><a href=#__codelineno-0-603>603</a></span>
<span class=normal><a href=#__codelineno-0-604>604</a></span>
<span class=normal><a href=#__codelineno-0-605>605</a></span>
<span class=normal><a href=#__codelineno-0-606>606</a></span>
<span class=normal><a href=#__codelineno-0-607>607</a></span>
<span class=normal><a href=#__codelineno-0-608>608</a></span>
<span class=normal><a href=#__codelineno-0-609>609</a></span>
<span class=normal><a href=#__codelineno-0-610>610</a></span>
<span class=normal><a href=#__codelineno-0-611>611</a></span>
<span class=normal><a href=#__codelineno-0-612>612</a></span>
<span class=normal><a href=#__codelineno-0-613>613</a></span>
<span class=normal><a href=#__codelineno-0-614>614</a></span>
<span class=normal><a href=#__codelineno-0-615>615</a></span>
<span class=normal><a href=#__codelineno-0-616>616</a></span>
<span class=normal><a href=#__codelineno-0-617>617</a></span>
<span class=normal><a href=#__codelineno-0-618>618</a></span>
<span class=normal><a href=#__codelineno-0-619>619</a></span>
<span class=normal><a href=#__codelineno-0-620>620</a></span>
<span class=normal><a href=#__codelineno-0-621>621</a></span>
<span class=normal><a href=#__codelineno-0-622>622</a></span>
<span class=normal><a href=#__codelineno-0-623>623</a></span>
<span class=normal><a href=#__codelineno-0-624>624</a></span>
<span class=normal><a href=#__codelineno-0-625>625</a></span>
<span class=normal><a href=#__codelineno-0-626>626</a></span>
<span class=normal><a href=#__codelineno-0-627>627</a></span>
<span class=normal><a href=#__codelineno-0-628>628</a></span>
<span class=normal><a href=#__codelineno-0-629>629</a></span>
<span class=normal><a href=#__codelineno-0-630>630</a></span>
<span class=normal><a href=#__codelineno-0-631>631</a></span>
<span class=normal><a href=#__codelineno-0-632>632</a></span>
<span class=normal><a href=#__codelineno-0-633>633</a></span>
<span class=normal><a href=#__codelineno-0-634>634</a></span>
<span class=normal><a href=#__codelineno-0-635>635</a></span>
<span class=normal><a href=#__codelineno-0-636>636</a></span>
<span class=normal><a href=#__codelineno-0-637>637</a></span>
<span class=normal><a href=#__codelineno-0-638>638</a></span>
<span class=normal><a href=#__codelineno-0-639>639</a></span>
<span class=normal><a href=#__codelineno-0-640>640</a></span>
<span class=normal><a href=#__codelineno-0-641>641</a></span>
<span class=normal><a href=#__codelineno-0-642>642</a></span>
<span class=normal><a href=#__codelineno-0-643>643</a></span>
<span class=normal><a href=#__codelineno-0-644>644</a></span>
<span class=normal><a href=#__codelineno-0-645>645</a></span>
<span class=normal><a href=#__codelineno-0-646>646</a></span>
<span class=normal><a href=#__codelineno-0-647>647</a></span>
<span class=normal><a href=#__codelineno-0-648>648</a></span>
<span class=normal><a href=#__codelineno-0-649>649</a></span>
<span class=normal><a href=#__codelineno-0-650>650</a></span>
<span class=normal><a href=#__codelineno-0-651>651</a></span>
<span class=normal><a href=#__codelineno-0-652>652</a></span>
<span class=normal><a href=#__codelineno-0-653>653</a></span>
<span class=normal><a href=#__codelineno-0-654>654</a></span>
<span class=normal><a href=#__codelineno-0-655>655</a></span>
<span class=normal><a href=#__codelineno-0-656>656</a></span>
<span class=normal><a href=#__codelineno-0-657>657</a></span>
<span class=normal><a href=#__codelineno-0-658>658</a></span>
<span class=normal><a href=#__codelineno-0-659>659</a></span>
<span class=normal><a href=#__codelineno-0-660>660</a></span>
<span class=normal><a href=#__codelineno-0-661>661</a></span>
<span class=normal><a href=#__codelineno-0-662>662</a></span>
<span class=normal><a href=#__codelineno-0-663>663</a></span>
<span class=normal><a href=#__codelineno-0-664>664</a></span>
<span class=normal><a href=#__codelineno-0-665>665</a></span>
<span class=normal><a href=#__codelineno-0-666>666</a></span>
<span class=normal><a href=#__codelineno-0-667>667</a></span>
<span class=normal><a href=#__codelineno-0-668>668</a></span>
<span class=normal><a href=#__codelineno-0-669>669</a></span>
<span class=normal><a href=#__codelineno-0-670>670</a></span>
<span class=normal><a href=#__codelineno-0-671>671</a></span>
<span class=normal><a href=#__codelineno-0-672>672</a></span>
<span class=normal><a href=#__codelineno-0-673>673</a></span>
<span class=normal><a href=#__codelineno-0-674>674</a></span>
<span class=normal><a href=#__codelineno-0-675>675</a></span>
<span class=normal><a href=#__codelineno-0-676>676</a></span>
<span class=normal><a href=#__codelineno-0-677>677</a></span>
<span class=normal><a href=#__codelineno-0-678>678</a></span>
<span class=normal><a href=#__codelineno-0-679>679</a></span>
<span class=normal><a href=#__codelineno-0-680>680</a></span>
<span class=normal><a href=#__codelineno-0-681>681</a></span>
<span class=normal><a href=#__codelineno-0-682>682</a></span>
<span class=normal><a href=#__codelineno-0-683>683</a></span>
<span class=normal><a href=#__codelineno-0-684>684</a></span>
<span class=normal><a href=#__codelineno-0-685>685</a></span>
<span class=normal><a href=#__codelineno-0-686>686</a></span>
<span class=normal><a href=#__codelineno-0-687>687</a></span>
<span class=normal><a href=#__codelineno-0-688>688</a></span>
<span class=normal><a href=#__codelineno-0-689>689</a></span>
<span class=normal><a href=#__codelineno-0-690>690</a></span>
<span class=normal><a href=#__codelineno-0-691>691</a></span>
<span class=normal><a href=#__codelineno-0-692>692</a></span>
<span class=normal><a href=#__codelineno-0-693>693</a></span>
<span class=normal><a href=#__codelineno-0-694>694</a></span>
<span class=normal><a href=#__codelineno-0-695>695</a></span>
<span class=normal><a href=#__codelineno-0-696>696</a></span>
<span class=normal><a href=#__codelineno-0-697>697</a></span>
<span class=normal><a href=#__codelineno-0-698>698</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-136><a id=__codelineno-0-136 name=__codelineno-0-136></a><span class=k>class</span><span class=w> </span><span class=nc>TileDBBatchProcessor</span><span class=p>:</span>
</span><span id=__span-0-137><a id=__codelineno-0-137 name=__codelineno-0-137></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-138><a id=__codelineno-0-138 name=__codelineno-0-138></a><span class=sd>    High-performance batch processor for TileDB SOMA data with multiple loading strategies.</span>
</span><span id=__span-0-139><a id=__codelineno-0-139 name=__codelineno-0-139></a>
</span><span id=__span-0-140><a id=__codelineno-0-140 name=__codelineno-0-140></a><span class=sd>    TileDBBatchProcessor provides efficient streaming and processing of single-cell data</span>
</span><span id=__span-0-141><a id=__codelineno-0-141 name=__codelineno-0-141></a><span class=sd>    from TileDB SOMA format. It supports multiple loading strategies including Mixture</span>
</span><span id=__span-0-142><a id=__codelineno-0-142 name=__codelineno-0-142></a><span class=sd>    of Scanners (MoS) for maximum entropy and sequential loading for maximum throughput.</span>
</span><span id=__span-0-143><a id=__codelineno-0-143 name=__codelineno-0-143></a>
</span><span id=__span-0-144><a id=__codelineno-0-144 name=__codelineno-0-144></a><span class=sd>    Key Features:</span>
</span><span id=__span-0-145><a id=__codelineno-0-145 name=__codelineno-0-145></a><span class=sd>        - Multiple loading strategies:</span>
</span><span id=__span-0-146><a id=__codelineno-0-146 name=__codelineno-0-146></a><span class=sd>            * Mixture of Scanners (MoS): Random sampling from multiple generators for</span>
</span><span id=__span-0-147><a id=__codelineno-0-147 name=__codelineno-0-147></a><span class=sd>              maximum entropy and randomization (default)</span>
</span><span id=__span-0-148><a id=__codelineno-0-148 name=__codelineno-0-148></a><span class=sd>            * Sequential loading: Contiguous data loading for maximum throughput</span>
</span><span id=__span-0-149><a id=__codelineno-0-149 name=__codelineno-0-149></a><span class=sd>        - Streaming data processing with configurable batch sizes</span>
</span><span id=__span-0-150><a id=__codelineno-0-150 name=__codelineno-0-150></a><span class=sd>        - Built-in shuffling strategies for data randomization</span>
</span><span id=__span-0-151><a id=__codelineno-0-151 name=__codelineno-0-151></a><span class=sd>        - Multi-epoch training support with automatic epoch transitions</span>
</span><span id=__span-0-152><a id=__codelineno-0-152 name=__codelineno-0-152></a><span class=sd>        - Comprehensive timing and memory monitoring</span>
</span><span id=__span-0-153><a id=__codelineno-0-153 name=__codelineno-0-153></a><span class=sd>        - Error handling and recovery mechanisms</span>
</span><span id=__span-0-154><a id=__codelineno-0-154 name=__codelineno-0-154></a><span class=sd>        - Configurable prefetch batch sizes for different dataset sizes</span>
</span><span id=__span-0-155><a id=__codelineno-0-155 name=__codelineno-0-155></a>
</span><span id=__span-0-156><a id=__codelineno-0-156 name=__codelineno-0-156></a><span class=sd>    Loading Strategies:</span>
</span><span id=__span-0-157><a id=__codelineno-0-157 name=__codelineno-0-157></a><span class=sd>        1. Mixture of Scanners (default): Randomly samples from multiple fragment</span>
</span><span id=__span-0-158><a id=__codelineno-0-158 name=__codelineno-0-158></a><span class=sd>           generators for maximum entropy and randomization</span>
</span><span id=__span-0-159><a id=__codelineno-0-159 name=__codelineno-0-159></a><span class=sd>        2. Sequential: Loads contiguous data chunks for maximum throughput</span>
</span><span id=__span-0-160><a id=__codelineno-0-160 name=__codelineno-0-160></a>
</span><span id=__span-0-161><a id=__codelineno-0-161 name=__codelineno-0-161></a><span class=sd>    Examples:</span>
</span><span id=__span-0-162><a id=__codelineno-0-162 name=__codelineno-0-162></a><span class=sd>        &gt;&gt;&gt; # Basic usage with default MoS strategy</span>
</span><span id=__span-0-163><a id=__codelineno-0-163 name=__codelineno-0-163></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-164><a id=__codelineno-0-164 name=__codelineno-0-164></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-165><a id=__codelineno-0-165 name=__codelineno-0-165></a><span class=sd>        ...     batch_size=32,</span>
</span><span id=__span-0-166><a id=__codelineno-0-166 name=__codelineno-0-166></a><span class=sd>        ...     prefetch_batch_size=100</span>
</span><span id=__span-0-167><a id=__codelineno-0-167 name=__codelineno-0-167></a><span class=sd>        ... )</span>
</span><span id=__span-0-168><a id=__codelineno-0-168 name=__codelineno-0-168></a><span class=sd>        &gt;&gt;&gt; batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-169><a id=__codelineno-0-169 name=__codelineno-0-169></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Loaded batch with {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-170><a id=__codelineno-0-170 name=__codelineno-0-170></a><span class=sd>        Loaded batch with 100 cells</span>
</span><span id=__span-0-171><a id=__codelineno-0-171 name=__codelineno-0-171></a>
</span><span id=__span-0-172><a id=__codelineno-0-172 name=__codelineno-0-172></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-173><a id=__codelineno-0-173 name=__codelineno-0-173></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-174><a id=__codelineno-0-174 name=__codelineno-0-174></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-175><a id=__codelineno-0-175 name=__codelineno-0-175></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-176><a id=__codelineno-0-176 name=__codelineno-0-176></a><span class=sd>        ...     batch_size=64</span>
</span><span id=__span-0-177><a id=__codelineno-0-177 name=__codelineno-0-177></a><span class=sd>        ... )</span>
</span><span id=__span-0-178><a id=__codelineno-0-178 name=__codelineno-0-178></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {processor.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-179><a id=__codelineno-0-179 name=__codelineno-0-179></a><span class=sd>        MoS enabled: False</span>
</span><span id=__span-0-180><a id=__codelineno-0-180 name=__codelineno-0-180></a>
</span><span id=__span-0-181><a id=__codelineno-0-181 name=__codelineno-0-181></a><span class=sd>        &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-182><a id=__codelineno-0-182 name=__codelineno-0-182></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-183><a id=__codelineno-0-183 name=__codelineno-0-183></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-184><a id=__codelineno-0-184 name=__codelineno-0-184></a><span class=sd>        ...     n_epochs=3</span>
</span><span id=__span-0-185><a id=__codelineno-0-185 name=__codelineno-0-185></a><span class=sd>        ... )</span>
</span><span id=__span-0-186><a id=__codelineno-0-186 name=__codelineno-0-186></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Number of epochs: {processor.n_epochs}&quot;)</span>
</span><span id=__span-0-187><a id=__codelineno-0-187 name=__codelineno-0-187></a><span class=sd>        Number of epochs: 3</span>
</span><span id=__span-0-188><a id=__codelineno-0-188 name=__codelineno-0-188></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-189><a id=__codelineno-0-189 name=__codelineno-0-189></a>
</span><span id=__span-0-190><a id=__codelineno-0-190 name=__codelineno-0-190></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-191><a id=__codelineno-0-191 name=__codelineno-0-191></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-192><a id=__codelineno-0-192 name=__codelineno-0-192></a>        <span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-193><a id=__codelineno-0-193 name=__codelineno-0-193></a>        <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-194><a id=__codelineno-0-194 name=__codelineno-0-194></a>        <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-195><a id=__codelineno-0-195 name=__codelineno-0-195></a>        <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span>
</span><span id=__span-0-196><a id=__codelineno-0-196 name=__codelineno-0-196></a>        <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-197><a id=__codelineno-0-197 name=__codelineno-0-197></a>        <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-198><a id=__codelineno-0-198 name=__codelineno-0-198></a>        <span class=n>log_metrics</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-199><a id=__codelineno-0-199 name=__codelineno-0-199></a>        <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-200><a id=__codelineno-0-200 name=__codelineno-0-200></a>        <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span><span id=__span-0-201><a id=__codelineno-0-201 name=__codelineno-0-201></a>        <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-0-202><a id=__codelineno-0-202 name=__codelineno-0-202></a>    <span class=p>):</span>
</span><span id=__span-0-203><a id=__codelineno-0-203 name=__codelineno-0-203></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-204><a id=__codelineno-0-204 name=__codelineno-0-204></a><span class=sd>        Initialize the TileDB batch processor with training configuration.</span>
</span><span id=__span-0-205><a id=__codelineno-0-205 name=__codelineno-0-205></a>
</span><span id=__span-0-206><a id=__codelineno-0-206 name=__codelineno-0-206></a><span class=sd>        Args:</span>
</span><span id=__span-0-207><a id=__codelineno-0-207 name=__codelineno-0-207></a><span class=sd>            tiledb_path: Path to the TileDB SOMA experiment directory.</span>
</span><span id=__span-0-208><a id=__codelineno-0-208 name=__codelineno-0-208></a><span class=sd>                         Must contain a valid SOMA experiment with RNA measurement data.</span>
</span><span id=__span-0-209><a id=__codelineno-0-209 name=__codelineno-0-209></a><span class=sd>            batch_size: Number of cells per training batch. Larger batches use more</span>
</span><span id=__span-0-210><a id=__codelineno-0-210 name=__codelineno-0-210></a><span class=sd>                       memory but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-211><a id=__codelineno-0-211 name=__codelineno-0-211></a><span class=sd>            prefetch_batch_size: Number of cells to load per prefetch batch from TileDB.</span>
</span><span id=__span-0-212><a id=__codelineno-0-212 name=__codelineno-0-212></a><span class=sd>                               Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-213><a id=__codelineno-0-213 name=__codelineno-0-213></a><span class=sd>                               Range: 10-10000, default: 100.</span>
</span><span id=__span-0-214><a id=__codelineno-0-214 name=__codelineno-0-214></a><span class=sd>            seed: Random seed for reproducible shuffling and MoS sampling.</span>
</span><span id=__span-0-215><a id=__codelineno-0-215 name=__codelineno-0-215></a><span class=sd>                  Used for consistent data ordering across runs. Default: 42.</span>
</span><span id=__span-0-216><a id=__codelineno-0-216 name=__codelineno-0-216></a><span class=sd>            n_epochs: Number of epochs to run. The processor will automatically reset</span>
</span><span id=__span-0-217><a id=__codelineno-0-217 name=__codelineno-0-217></a><span class=sd>                     after each epoch, enabling multi-epoch training. Default: 1.</span>
</span><span id=__span-0-218><a id=__codelineno-0-218 name=__codelineno-0-218></a><span class=sd>            verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-219><a id=__codelineno-0-219 name=__codelineno-0-219></a><span class=sd>                    If False, suppress all internal prints for clean output. Default: True.</span>
</span><span id=__span-0-220><a id=__codelineno-0-220 name=__codelineno-0-220></a><span class=sd>            log_metrics: If True, collect detailed timing metrics for performance analysis.</span>
</span><span id=__span-0-221><a id=__codelineno-0-221 name=__codelineno-0-221></a><span class=sd>                        Metrics include loading time, shuffle time, and memory usage.</span>
</span><span id=__span-0-222><a id=__codelineno-0-222 name=__codelineno-0-222></a><span class=sd>                        Default: False.</span>
</span><span id=__span-0-223><a id=__codelineno-0-223 name=__codelineno-0-223></a><span class=sd>            use_mixture_of_scanners: If True, use MoS strategy for higher entropy by</span>
</span><span id=__span-0-224><a id=__codelineno-0-224 name=__codelineno-0-224></a><span class=sd>                                   randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-225><a id=__codelineno-0-225 name=__codelineno-0-225></a><span class=sd>                                   Provides better randomization for foundation model training.</span>
</span><span id=__span-0-226><a id=__codelineno-0-226 name=__codelineno-0-226></a><span class=sd>                                   Default: True.</span>
</span><span id=__span-0-227><a id=__codelineno-0-227 name=__codelineno-0-227></a><span class=sd>            n_readers: Total number of fragment generators to create when using MoS.</span>
</span><span id=__span-0-228><a id=__codelineno-0-228 name=__codelineno-0-228></a><span class=sd>                      Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-229><a id=__codelineno-0-229 name=__codelineno-0-229></a><span class=sd>                      Range: 1-1000, default: 50.</span>
</span><span id=__span-0-230><a id=__codelineno-0-230 name=__codelineno-0-230></a><span class=sd>            n_scanners: Number of active scanners to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-231><a id=__codelineno-0-231 name=__codelineno-0-231></a><span class=sd>                       Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-232><a id=__codelineno-0-232 name=__codelineno-0-232></a><span class=sd>                       Range: 1-100, default: 8.</span>
</span><span id=__span-0-233><a id=__codelineno-0-233 name=__codelineno-0-233></a>
</span><span id=__span-0-234><a id=__codelineno-0-234 name=__codelineno-0-234></a><span class=sd>        Raises:</span>
</span><span id=__span-0-235><a id=__codelineno-0-235 name=__codelineno-0-235></a><span class=sd>            ImportError: If TileDB SOMA is not available.</span>
</span><span id=__span-0-236><a id=__codelineno-0-236 name=__codelineno-0-236></a><span class=sd>            ValueError: If MoS parameters are invalid (n_readers &lt; 1, n_scanners &lt; 1,</span>
</span><span id=__span-0-237><a id=__codelineno-0-237 name=__codelineno-0-237></a><span class=sd>                       or n_scanners &gt; n_readers).</span>
</span><span id=__span-0-238><a id=__codelineno-0-238 name=__codelineno-0-238></a><span class=sd>            RuntimeError: If the TileDB experiment cannot be opened or is invalid.</span>
</span><span id=__span-0-239><a id=__codelineno-0-239 name=__codelineno-0-239></a>
</span><span id=__span-0-240><a id=__codelineno-0-240 name=__codelineno-0-240></a><span class=sd>        Examples:</span>
</span><span id=__span-0-241><a id=__codelineno-0-241 name=__codelineno-0-241></a><span class=sd>            &gt;&gt;&gt; # Basic initialization with default MoS strategy</span>
</span><span id=__span-0-242><a id=__codelineno-0-242 name=__codelineno-0-242></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-243><a id=__codelineno-0-243 name=__codelineno-0-243></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-244><a id=__codelineno-0-244 name=__codelineno-0-244></a><span class=sd>            ...     batch_size=32,</span>
</span><span id=__span-0-245><a id=__codelineno-0-245 name=__codelineno-0-245></a><span class=sd>            ...     prefetch_batch_size=100</span>
</span><span id=__span-0-246><a id=__codelineno-0-246 name=__codelineno-0-246></a><span class=sd>            ... )</span>
</span><span id=__span-0-247><a id=__codelineno-0-247 name=__codelineno-0-247></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Total cells: {processor.total_cells}&quot;)</span>
</span><span id=__span-0-248><a id=__codelineno-0-248 name=__codelineno-0-248></a><span class=sd>            Total cells: 50000</span>
</span><span id=__span-0-249><a id=__codelineno-0-249 name=__codelineno-0-249></a>
</span><span id=__span-0-250><a id=__codelineno-0-250 name=__codelineno-0-250></a><span class=sd>            &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-251><a id=__codelineno-0-251 name=__codelineno-0-251></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-252><a id=__codelineno-0-252 name=__codelineno-0-252></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-253><a id=__codelineno-0-253 name=__codelineno-0-253></a><span class=sd>            ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-254><a id=__codelineno-0-254 name=__codelineno-0-254></a><span class=sd>            ...     batch_size=64</span>
</span><span id=__span-0-255><a id=__codelineno-0-255 name=__codelineno-0-255></a><span class=sd>            ... )</span>
</span><span id=__span-0-256><a id=__codelineno-0-256 name=__codelineno-0-256></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS enabled: {processor.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-257><a id=__codelineno-0-257 name=__codelineno-0-257></a><span class=sd>            MoS enabled: False</span>
</span><span id=__span-0-258><a id=__codelineno-0-258 name=__codelineno-0-258></a>
</span><span id=__span-0-259><a id=__codelineno-0-259 name=__codelineno-0-259></a><span class=sd>            &gt;&gt;&gt; # High-entropy MoS configuration</span>
</span><span id=__span-0-260><a id=__codelineno-0-260 name=__codelineno-0-260></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-261><a id=__codelineno-0-261 name=__codelineno-0-261></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-262><a id=__codelineno-0-262 name=__codelineno-0-262></a><span class=sd>            ...     n_readers=100,</span>
</span><span id=__span-0-263><a id=__codelineno-0-263 name=__codelineno-0-263></a><span class=sd>            ...     n_scanners=16</span>
</span><span id=__span-0-264><a id=__codelineno-0-264 name=__codelineno-0-264></a><span class=sd>            ... )</span>
</span><span id=__span-0-265><a id=__codelineno-0-265 name=__codelineno-0-265></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS readers: {processor.n_readers}, scanners: {processor.n_scanners}&quot;)</span>
</span><span id=__span-0-266><a id=__codelineno-0-266 name=__codelineno-0-266></a><span class=sd>            MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-267><a id=__codelineno-0-267 name=__codelineno-0-267></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-268><a id=__codelineno-0-268 name=__codelineno-0-268></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>TILEDB_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-269><a id=__codelineno-0-269 name=__codelineno-0-269></a>            <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span><span class=s2>&quot;TileDB SOMA is required but not available&quot;</span><span class=p>)</span>
</span><span id=__span-0-270><a id=__codelineno-0-270 name=__codelineno-0-270></a>
</span><span id=__span-0-271><a id=__codelineno-0-271 name=__codelineno-0-271></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tiledb_path</span> <span class=o>=</span> <span class=n>tiledb_path</span>
</span><span id=__span-0-272><a id=__codelineno-0-272 name=__codelineno-0-272></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-273><a id=__codelineno-0-273 name=__codelineno-0-273></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=n>prefetch_batch_size</span>
</span><span id=__span-0-274><a id=__codelineno-0-274 name=__codelineno-0-274></a>        <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>=</span> <span class=n>seed</span>
</span><span id=__span-0-275><a id=__codelineno-0-275 name=__codelineno-0-275></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-276><a id=__codelineno-0-276 name=__codelineno-0-276></a>        <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span><span id=__span-0-277><a id=__codelineno-0-277 name=__codelineno-0-277></a>        <span class=bp>self</span><span class=o>.</span><span class=n>log_metrics</span> <span class=o>=</span> <span class=n>log_metrics</span>
</span><span id=__span-0-278><a id=__codelineno-0-278 name=__codelineno-0-278></a>        <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>
</span><span id=__span-0-279><a id=__codelineno-0-279 name=__codelineno-0-279></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>=</span> <span class=n>n_readers</span>
</span><span id=__span-0-280><a id=__codelineno-0-280 name=__codelineno-0-280></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>
</span><span id=__span-0-281><a id=__codelineno-0-281 name=__codelineno-0-281></a>
</span><span id=__span-0-282><a id=__codelineno-0-282 name=__codelineno-0-282></a>        <span class=c1># Validate MoS parameters</span>
</span><span id=__span-0-283><a id=__codelineno-0-283 name=__codelineno-0-283></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-284><a id=__codelineno-0-284 name=__codelineno-0-284></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-285><a id=__codelineno-0-285 name=__codelineno-0-285></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_readers must be at least 1&quot;</span><span class=p>)</span>
</span><span id=__span-0-286><a id=__codelineno-0-286 name=__codelineno-0-286></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-287><a id=__codelineno-0-287 name=__codelineno-0-287></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners must be at least 1&quot;</span><span class=p>)</span>
</span><span id=__span-0-288><a id=__codelineno-0-288 name=__codelineno-0-288></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span><span class=p>:</span>
</span><span id=__span-0-289><a id=__codelineno-0-289 name=__codelineno-0-289></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners cannot exceed n_readers&quot;</span><span class=p>)</span>
</span><span id=__span-0-290><a id=__codelineno-0-290 name=__codelineno-0-290></a>
</span><span id=__span-0-291><a id=__codelineno-0-291 name=__codelineno-0-291></a>        <span class=c1># Initialize state</span>
</span><span id=__span-0-292><a id=__codelineno-0-292 name=__codelineno-0-292></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-293><a id=__codelineno-0-293 name=__codelineno-0-293></a>        <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-294><a id=__codelineno-0-294 name=__codelineno-0-294></a>        <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-295><a id=__codelineno-0-295 name=__codelineno-0-295></a>
</span><span id=__span-0-296><a id=__codelineno-0-296 name=__codelineno-0-296></a>        <span class=c1># Open TileDB experiment</span>
</span><span id=__span-0-297><a id=__codelineno-0-297 name=__codelineno-0-297></a>        <span class=bp>self</span><span class=o>.</span><span class=n>experiment</span> <span class=o>=</span> <span class=n>tiledbsoma</span><span class=o>.</span><span class=n>Experiment</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>tiledb_path</span><span class=p>)</span>
</span><span id=__span-0-298><a id=__codelineno-0-298 name=__codelineno-0-298></a>        <span class=bp>self</span><span class=o>.</span><span class=n>X</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>experiment</span><span class=o>.</span><span class=n>ms</span><span class=p>[</span><span class=s2>&quot;RNA&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>X</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span>
</span><span id=__span-0-299><a id=__codelineno-0-299 name=__codelineno-0-299></a>
</span><span id=__span-0-300><a id=__codelineno-0-300 name=__codelineno-0-300></a>        <span class=c1># Get total number of cells</span>
</span><span id=__span-0-301><a id=__codelineno-0-301 name=__codelineno-0-301></a>        <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-0-302><a id=__codelineno-0-302 name=__codelineno-0-302></a>
</span><span id=__span-0-303><a id=__codelineno-0-303 name=__codelineno-0-303></a>        <span class=c1># Initialize shuffling strategy (similar to SLAF)</span>
</span><span id=__span-0-304><a id=__codelineno-0-304 name=__codelineno-0-304></a>        <span class=kn>from</span><span class=w> </span><span class=nn>slaf.ml.samplers</span><span class=w> </span><span class=kn>import</span> <span class=n>ShuffleType</span><span class=p>,</span> <span class=n>create_shuffle</span>
</span><span id=__span-0-305><a id=__codelineno-0-305 name=__codelineno-0-305></a>
</span><span id=__span-0-306><a id=__codelineno-0-306 name=__codelineno-0-306></a>        <span class=bp>self</span><span class=o>.</span><span class=n>shuffle</span> <span class=o>=</span> <span class=n>create_shuffle</span><span class=p>(</span><span class=n>ShuffleType</span><span class=o>.</span><span class=n>RANDOM</span><span class=p>)</span>
</span><span id=__span-0-307><a id=__codelineno-0-307 name=__codelineno-0-307></a>
</span><span id=__span-0-308><a id=__codelineno-0-308 name=__codelineno-0-308></a>        <span class=c1># Initialize MoS generators if enabled</span>
</span><span id=__span-0-309><a id=__codelineno-0-309 name=__codelineno-0-309></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-310><a id=__codelineno-0-310 name=__codelineno-0-310></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_initialize_mos_generators</span><span class=p>()</span>
</span><span id=__span-0-311><a id=__codelineno-0-311 name=__codelineno-0-311></a>
</span><span id=__span-0-312><a id=__codelineno-0-312 name=__codelineno-0-312></a>        <span class=c1># Initialize timing metrics for benchmarking</span>
</span><span id=__span-0-313><a id=__codelineno-0-313 name=__codelineno-0-313></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span>
</span><span id=__span-0-314><a id=__codelineno-0-314 name=__codelineno-0-314></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_metrics</span><span class=p>:</span>
</span><span id=__span-0-315><a id=__codelineno-0-315 name=__codelineno-0-315></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-316><a id=__codelineno-0-316 name=__codelineno-0-316></a>                <span class=s2>&quot;tiledb_loading&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-317><a id=__codelineno-0-317 name=__codelineno-0-317></a>                <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-318><a id=__codelineno-0-318 name=__codelineno-0-318></a>                <span class=s2>&quot;total&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-319><a id=__codelineno-0-319 name=__codelineno-0-319></a>                <span class=s2>&quot;cells_processed&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-320><a id=__codelineno-0-320 name=__codelineno-0-320></a>            <span class=p>}</span>
</span><span id=__span-0-321><a id=__codelineno-0-321 name=__codelineno-0-321></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-322><a id=__codelineno-0-322 name=__codelineno-0-322></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-323><a id=__codelineno-0-323 name=__codelineno-0-323></a>
</span><span id=__span-0-324><a id=__codelineno-0-324 name=__codelineno-0-324></a>        <span class=c1># Initialize timing variables for consolidated reporting</span>
</span><span id=__span-0-325><a id=__codelineno-0-325 name=__codelineno-0-325></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_last_load_time</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-0-326><a id=__codelineno-0-326 name=__codelineno-0-326></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-0-327><a id=__codelineno-0-327 name=__codelineno-0-327></a>
</span><span id=__span-0-328><a id=__codelineno-0-328 name=__codelineno-0-328></a>    <span class=k>def</span><span class=w> </span><span class=nf>_initialize_mos_generators</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-329><a id=__codelineno-0-329 name=__codelineno-0-329></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Initialize MoS generators with evenly distributed scan ranges.&quot;&quot;&quot;</span>
</span><span id=__span-0-330><a id=__codelineno-0-330 name=__codelineno-0-330></a>        <span class=c1># Calculate scan ranges for each generator</span>
</span><span id=__span-0-331><a id=__codelineno-0-331 name=__codelineno-0-331></a>        <span class=n>cells_per_reader</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span> <span class=o>//</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span>
</span><span id=__span-0-332><a id=__codelineno-0-332 name=__codelineno-0-332></a>        <span class=n>remainder</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span>
</span><span id=__span-0-333><a id=__codelineno-0-333 name=__codelineno-0-333></a>
</span><span id=__span-0-334><a id=__codelineno-0-334 name=__codelineno-0-334></a>        <span class=bp>self</span><span class=o>.</span><span class=n>generators</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-335><a id=__codelineno-0-335 name=__codelineno-0-335></a>        <span class=n>current_position</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-336><a id=__codelineno-0-336 name=__codelineno-0-336></a>
</span><span id=__span-0-337><a id=__codelineno-0-337 name=__codelineno-0-337></a>        <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span><span class=p>):</span>
</span><span id=__span-0-338><a id=__codelineno-0-338 name=__codelineno-0-338></a>            <span class=c1># Distribute remainder cells among first few readers</span>
</span><span id=__span-0-339><a id=__codelineno-0-339 name=__codelineno-0-339></a>            <span class=n>reader_cell_count</span> <span class=o>=</span> <span class=n>cells_per_reader</span> <span class=o>+</span> <span class=p>(</span><span class=mi>1</span> <span class=k>if</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>remainder</span> <span class=k>else</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-340><a id=__codelineno-0-340 name=__codelineno-0-340></a>
</span><span id=__span-0-341><a id=__codelineno-0-341 name=__codelineno-0-341></a>            <span class=n>generator</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-342><a id=__codelineno-0-342 name=__codelineno-0-342></a>                <span class=s2>&quot;generator_id&quot;</span><span class=p>:</span> <span class=n>i</span><span class=p>,</span>
</span><span id=__span-0-343><a id=__codelineno-0-343 name=__codelineno-0-343></a>                <span class=s2>&quot;start_position&quot;</span><span class=p>:</span> <span class=n>current_position</span><span class=p>,</span>
</span><span id=__span-0-344><a id=__codelineno-0-344 name=__codelineno-0-344></a>                <span class=s2>&quot;current_position&quot;</span><span class=p>:</span> <span class=n>current_position</span><span class=p>,</span>
</span><span id=__span-0-345><a id=__codelineno-0-345 name=__codelineno-0-345></a>                <span class=s2>&quot;end_position&quot;</span><span class=p>:</span> <span class=n>current_position</span> <span class=o>+</span> <span class=n>reader_cell_count</span><span class=p>,</span>
</span><span id=__span-0-346><a id=__codelineno-0-346 name=__codelineno-0-346></a>                <span class=s2>&quot;is_active&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-347><a id=__codelineno-0-347 name=__codelineno-0-347></a>            <span class=p>}</span>
</span><span id=__span-0-348><a id=__codelineno-0-348 name=__codelineno-0-348></a>
</span><span id=__span-0-349><a id=__codelineno-0-349 name=__codelineno-0-349></a>            <span class=bp>self</span><span class=o>.</span><span class=n>generators</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>generator</span><span class=p>)</span>
</span><span id=__span-0-350><a id=__codelineno-0-350 name=__codelineno-0-350></a>            <span class=n>current_position</span> <span class=o>+=</span> <span class=n>reader_cell_count</span>
</span><span id=__span-0-351><a id=__codelineno-0-351 name=__codelineno-0-351></a>
</span><span id=__span-0-352><a id=__codelineno-0-352 name=__codelineno-0-352></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-353><a id=__codelineno-0-353 name=__codelineno-0-353></a>            <span class=n>print_prefetch</span><span class=p>(</span>
</span><span id=__span-0-354><a id=__codelineno-0-354 name=__codelineno-0-354></a>                <span class=sa>f</span><span class=s2>&quot;TileDB MoS initialized: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span><span class=si>}</span><span class=s2> generators, &quot;</span>
</span><span id=__span-0-355><a id=__codelineno-0-355 name=__codelineno-0-355></a>                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span><span class=si>}</span><span class=s2> active scanners, &quot;</span>
</span><span id=__span-0-356><a id=__codelineno-0-356 name=__codelineno-0-356></a>                <span class=sa>f</span><span class=s2>&quot;prefetch_batch_size=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-0-357><a id=__codelineno-0-357 name=__codelineno-0-357></a>                <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-358><a id=__codelineno-0-358 name=__codelineno-0-358></a>            <span class=p>)</span>
</span><span id=__span-0-359><a id=__codelineno-0-359 name=__codelineno-0-359></a>
</span><span id=__span-0-360><a id=__codelineno-0-360 name=__codelineno-0-360></a>    <span class=k>def</span><span class=w> </span><span class=nf>reset_for_epoch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>epoch</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-361><a id=__codelineno-0-361 name=__codelineno-0-361></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-362><a id=__codelineno-0-362 name=__codelineno-0-362></a><span class=sd>        Reset the processor for a new epoch.</span>
</span><span id=__span-0-363><a id=__codelineno-0-363 name=__codelineno-0-363></a>
</span><span id=__span-0-364><a id=__codelineno-0-364 name=__codelineno-0-364></a><span class=sd>        This method resets the batch processor state to start a new epoch,</span>
</span><span id=__span-0-365><a id=__codelineno-0-365 name=__codelineno-0-365></a><span class=sd>        including resetting batch counters, MoS generator positions, and</span>
</span><span id=__span-0-366><a id=__codelineno-0-366 name=__codelineno-0-366></a><span class=sd>        shuffling seeds. It is called automatically during multi-epoch training.</span>
</span><span id=__span-0-367><a id=__codelineno-0-367 name=__codelineno-0-367></a>
</span><span id=__span-0-368><a id=__codelineno-0-368 name=__codelineno-0-368></a><span class=sd>        Args:</span>
</span><span id=__span-0-369><a id=__codelineno-0-369 name=__codelineno-0-369></a><span class=sd>            epoch: The epoch number to start (0-based indexing).</span>
</span><span id=__span-0-370><a id=__codelineno-0-370 name=__codelineno-0-370></a><span class=sd>                  Must be 0 &lt;= epoch &lt; n_epochs.</span>
</span><span id=__span-0-371><a id=__codelineno-0-371 name=__codelineno-0-371></a>
</span><span id=__span-0-372><a id=__codelineno-0-372 name=__codelineno-0-372></a><span class=sd>        Raises:</span>
</span><span id=__span-0-373><a id=__codelineno-0-373 name=__codelineno-0-373></a><span class=sd>            ValueError: If epoch is invalid (negative or &gt;= n_epochs).</span>
</span><span id=__span-0-374><a id=__codelineno-0-374 name=__codelineno-0-374></a>
</span><span id=__span-0-375><a id=__codelineno-0-375 name=__codelineno-0-375></a><span class=sd>        Examples:</span>
</span><span id=__span-0-376><a id=__codelineno-0-376 name=__codelineno-0-376></a><span class=sd>            &gt;&gt;&gt; # Reset for epoch 1</span>
</span><span id=__span-0-377><a id=__codelineno-0-377 name=__codelineno-0-377></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;, n_epochs=3)</span>
</span><span id=__span-0-378><a id=__codelineno-0-378 name=__codelineno-0-378></a><span class=sd>            &gt;&gt;&gt; processor.reset_for_epoch(1)</span>
</span><span id=__span-0-379><a id=__codelineno-0-379 name=__codelineno-0-379></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Current epoch: {processor.current_epoch}&quot;)</span>
</span><span id=__span-0-380><a id=__codelineno-0-380 name=__codelineno-0-380></a><span class=sd>            Current epoch: 1</span>
</span><span id=__span-0-381><a id=__codelineno-0-381 name=__codelineno-0-381></a>
</span><span id=__span-0-382><a id=__codelineno-0-382 name=__codelineno-0-382></a><span class=sd>            &gt;&gt;&gt; # Invalid epoch raises error</span>
</span><span id=__span-0-383><a id=__codelineno-0-383 name=__codelineno-0-383></a><span class=sd>            &gt;&gt;&gt; try:</span>
</span><span id=__span-0-384><a id=__codelineno-0-384 name=__codelineno-0-384></a><span class=sd>            ...     processor.reset_for_epoch(5)  # n_epochs=3</span>
</span><span id=__span-0-385><a id=__codelineno-0-385 name=__codelineno-0-385></a><span class=sd>            ... except ValueError as e:</span>
</span><span id=__span-0-386><a id=__codelineno-0-386 name=__codelineno-0-386></a><span class=sd>            ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-387><a id=__codelineno-0-387 name=__codelineno-0-387></a><span class=sd>            Error: Invalid epoch 5. Must be 0 &lt;= epoch &lt; 3</span>
</span><span id=__span-0-388><a id=__codelineno-0-388 name=__codelineno-0-388></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-389><a id=__codelineno-0-389 name=__codelineno-0-389></a>        <span class=k>if</span> <span class=n>epoch</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>epoch</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>:</span>
</span><span id=__span-0-390><a id=__codelineno-0-390 name=__codelineno-0-390></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-0-391><a id=__codelineno-0-391 name=__codelineno-0-391></a>                <span class=sa>f</span><span class=s2>&quot;Invalid epoch </span><span class=si>{</span><span class=n>epoch</span><span class=si>}</span><span class=s2>. Must be 0 &lt;= epoch &lt; </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-392><a id=__codelineno-0-392 name=__codelineno-0-392></a>            <span class=p>)</span>
</span><span id=__span-0-393><a id=__codelineno-0-393 name=__codelineno-0-393></a>
</span><span id=__span-0-394><a id=__codelineno-0-394 name=__codelineno-0-394></a>        <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=n>epoch</span>
</span><span id=__span-0-395><a id=__codelineno-0-395 name=__codelineno-0-395></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-396><a id=__codelineno-0-396 name=__codelineno-0-396></a>
</span><span id=__span-0-397><a id=__codelineno-0-397 name=__codelineno-0-397></a>        <span class=c1># Reset MoS generators if enabled</span>
</span><span id=__span-0-398><a id=__codelineno-0-398 name=__codelineno-0-398></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-399><a id=__codelineno-0-399 name=__codelineno-0-399></a>            <span class=k>for</span> <span class=n>generator</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>generators</span><span class=p>:</span>
</span><span id=__span-0-400><a id=__codelineno-0-400 name=__codelineno-0-400></a>                <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;start_position&quot;</span><span class=p>]</span>
</span><span id=__span-0-401><a id=__codelineno-0-401 name=__codelineno-0-401></a>                <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-402><a id=__codelineno-0-402 name=__codelineno-0-402></a>
</span><span id=__span-0-403><a id=__codelineno-0-403 name=__codelineno-0-403></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-404><a id=__codelineno-0-404 name=__codelineno-0-404></a>            <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot; Reset TileDB processor for epoch </span><span class=si>{</span><span class=n>epoch</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-405><a id=__codelineno-0-405 name=__codelineno-0-405></a>
</span><span id=__span-0-406><a id=__codelineno-0-406 name=__codelineno-0-406></a>    <span class=k>def</span><span class=w> </span><span class=nf>_record_timing</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>step</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>duration</span><span class=p>:</span> <span class=nb>float</span><span class=p>,</span> <span class=n>cells_processed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>0</span><span class=p>):</span>
</span><span id=__span-0-407><a id=__codelineno-0-407 name=__codelineno-0-407></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Record timing for a processing step.&quot;&quot;&quot;</span>
</span><span id=__span-0-408><a id=__codelineno-0-408 name=__codelineno-0-408></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_metrics</span> <span class=ow>or</span> <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-409><a id=__codelineno-0-409 name=__codelineno-0-409></a>            <span class=k>return</span>
</span><span id=__span-0-410><a id=__codelineno-0-410 name=__codelineno-0-410></a>
</span><span id=__span-0-411><a id=__codelineno-0-411 name=__codelineno-0-411></a>        <span class=k>if</span> <span class=n>step</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span><span class=p>:</span>
</span><span id=__span-0-412><a id=__codelineno-0-412 name=__codelineno-0-412></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span><span class=p>[</span><span class=n>step</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>duration</span><span class=p>)</span>
</span><span id=__span-0-413><a id=__codelineno-0-413 name=__codelineno-0-413></a>
</span><span id=__span-0-414><a id=__codelineno-0-414 name=__codelineno-0-414></a>        <span class=k>if</span> <span class=n>cells_processed</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-415><a id=__codelineno-0-415 name=__codelineno-0-415></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span><span class=p>[</span><span class=s2>&quot;cells_processed&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>cells_processed</span><span class=p>)</span>
</span><span id=__span-0-416><a id=__codelineno-0-416 name=__codelineno-0-416></a>
</span><span id=__span-0-417><a id=__codelineno-0-417 name=__codelineno-0-417></a>    <span class=k>def</span><span class=w> </span><span class=nf>load_prefetch_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>TileDBPrefetchBatch</span><span class=p>:</span>
</span><span id=__span-0-418><a id=__codelineno-0-418 name=__codelineno-0-418></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-419><a id=__codelineno-0-419 name=__codelineno-0-419></a><span class=sd>        Load and process a chunk of TileDB data into batches using configured strategy.</span>
</span><span id=__span-0-420><a id=__codelineno-0-420 name=__codelineno-0-420></a>
</span><span id=__span-0-421><a id=__codelineno-0-421 name=__codelineno-0-421></a><span class=sd>        This method loads a batch of data from TileDB SOMA format, applies shuffling,</span>
</span><span id=__span-0-422><a id=__codelineno-0-422 name=__codelineno-0-422></a><span class=sd>        and returns a processed batch ready for training. It supports both MoS and</span>
</span><span id=__span-0-423><a id=__codelineno-0-423 name=__codelineno-0-423></a><span class=sd>        sequential loading strategies and handles epoch transitions automatically.</span>
</span><span id=__span-0-424><a id=__codelineno-0-424 name=__codelineno-0-424></a>
</span><span id=__span-0-425><a id=__codelineno-0-425 name=__codelineno-0-425></a><span class=sd>        The method performs the following steps:</span>
</span><span id=__span-0-426><a id=__codelineno-0-426 name=__codelineno-0-426></a><span class=sd>        1. Load data from TileDB using the configured strategy (MoS or sequential)</span>
</span><span id=__span-0-427><a id=__codelineno-0-427 name=__codelineno-0-427></a><span class=sd>        2. Convert Arrow data to Polars DataFrame</span>
</span><span id=__span-0-428><a id=__codelineno-0-428 name=__codelineno-0-428></a><span class=sd>        3. Apply shuffling strategy for data randomization</span>
</span><span id=__span-0-429><a id=__codelineno-0-429 name=__codelineno-0-429></a><span class=sd>        4. Return processed batch with metadata</span>
</span><span id=__span-0-430><a id=__codelineno-0-430 name=__codelineno-0-430></a>
</span><span id=__span-0-431><a id=__codelineno-0-431 name=__codelineno-0-431></a><span class=sd>        Returns:</span>
</span><span id=__span-0-432><a id=__codelineno-0-432 name=__codelineno-0-432></a><span class=sd>            TileDBPrefetchBatch: Processed batch containing:</span>
</span><span id=__span-0-433><a id=__codelineno-0-433 name=__codelineno-0-433></a><span class=sd>                - batch_df: Polars DataFrame with cell-gene expression data</span>
</span><span id=__span-0-434><a id=__codelineno-0-434 name=__codelineno-0-434></a><span class=sd>                - cell_integer_ids: List of unique cell IDs in the batch</span>
</span><span id=__span-0-435><a id=__codelineno-0-435 name=__codelineno-0-435></a><span class=sd>                - process_time: Time taken to process the batch</span>
</span><span id=__span-0-436><a id=__codelineno-0-436 name=__codelineno-0-436></a><span class=sd>                - memory_mb: Memory usage at batch creation time</span>
</span><span id=__span-0-437><a id=__codelineno-0-437 name=__codelineno-0-437></a>
</span><span id=__span-0-438><a id=__codelineno-0-438 name=__codelineno-0-438></a><span class=sd>        Raises:</span>
</span><span id=__span-0-439><a id=__codelineno-0-439 name=__codelineno-0-439></a><span class=sd>            StopIteration: When all epochs are completed and no more data is available.</span>
</span><span id=__span-0-440><a id=__codelineno-0-440 name=__codelineno-0-440></a><span class=sd>            RuntimeError: If TileDB data loading fails.</span>
</span><span id=__span-0-441><a id=__codelineno-0-441 name=__codelineno-0-441></a>
</span><span id=__span-0-442><a id=__codelineno-0-442 name=__codelineno-0-442></a><span class=sd>        Examples:</span>
</span><span id=__span-0-443><a id=__codelineno-0-443 name=__codelineno-0-443></a><span class=sd>            &gt;&gt;&gt; # Load a batch with MoS strategy</span>
</span><span id=__span-0-444><a id=__codelineno-0-444 name=__codelineno-0-444></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-445><a id=__codelineno-0-445 name=__codelineno-0-445></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-446><a id=__codelineno-0-446 name=__codelineno-0-446></a><span class=sd>            ...     use_mixture_of_scanners=True</span>
</span><span id=__span-0-447><a id=__codelineno-0-447 name=__codelineno-0-447></a><span class=sd>            ... )</span>
</span><span id=__span-0-448><a id=__codelineno-0-448 name=__codelineno-0-448></a><span class=sd>            &gt;&gt;&gt; batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-449><a id=__codelineno-0-449 name=__codelineno-0-449></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Batch {batch.batch_id} has {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-450><a id=__codelineno-0-450 name=__codelineno-0-450></a><span class=sd>            Batch 0 has 100 cells</span>
</span><span id=__span-0-451><a id=__codelineno-0-451 name=__codelineno-0-451></a>
</span><span id=__span-0-452><a id=__codelineno-0-452 name=__codelineno-0-452></a><span class=sd>            &gt;&gt;&gt; # Load a batch with sequential strategy</span>
</span><span id=__span-0-453><a id=__codelineno-0-453 name=__codelineno-0-453></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-454><a id=__codelineno-0-454 name=__codelineno-0-454></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-455><a id=__codelineno-0-455 name=__codelineno-0-455></a><span class=sd>            ...     use_mixture_of_scanners=False</span>
</span><span id=__span-0-456><a id=__codelineno-0-456 name=__codelineno-0-456></a><span class=sd>            ... )</span>
</span><span id=__span-0-457><a id=__codelineno-0-457 name=__codelineno-0-457></a><span class=sd>            &gt;&gt;&gt; batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-458><a id=__codelineno-0-458 name=__codelineno-0-458></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Sequential batch shape: {batch.batch_df.shape}&quot;)</span>
</span><span id=__span-0-459><a id=__codelineno-0-459 name=__codelineno-0-459></a><span class=sd>            Sequential batch shape: (100, 3)</span>
</span><span id=__span-0-460><a id=__codelineno-0-460 name=__codelineno-0-460></a>
</span><span id=__span-0-461><a id=__codelineno-0-461 name=__codelineno-0-461></a><span class=sd>            &gt;&gt;&gt; # Handle epoch completion</span>
</span><span id=__span-0-462><a id=__codelineno-0-462 name=__codelineno-0-462></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;, n_epochs=1)</span>
</span><span id=__span-0-463><a id=__codelineno-0-463 name=__codelineno-0-463></a><span class=sd>            &gt;&gt;&gt; try:</span>
</span><span id=__span-0-464><a id=__codelineno-0-464 name=__codelineno-0-464></a><span class=sd>            ...     while True:</span>
</span><span id=__span-0-465><a id=__codelineno-0-465 name=__codelineno-0-465></a><span class=sd>            ...         batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-466><a id=__codelineno-0-466 name=__codelineno-0-466></a><span class=sd>            ...         print(f&quot;Processed batch {batch.batch_id}&quot;)</span>
</span><span id=__span-0-467><a id=__codelineno-0-467 name=__codelineno-0-467></a><span class=sd>            ... except StopIteration:</span>
</span><span id=__span-0-468><a id=__codelineno-0-468 name=__codelineno-0-468></a><span class=sd>            ...     print(&quot;All epochs completed&quot;)</span>
</span><span id=__span-0-469><a id=__codelineno-0-469 name=__codelineno-0-469></a><span class=sd>            All epochs completed</span>
</span><span id=__span-0-470><a id=__codelineno-0-470 name=__codelineno-0-470></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-471><a id=__codelineno-0-471 name=__codelineno-0-471></a>        <span class=c1># Iterative approach to handle epoch transitions</span>
</span><span id=__span-0-472><a id=__codelineno-0-472 name=__codelineno-0-472></a>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-0-473><a id=__codelineno-0-473 name=__codelineno-0-473></a>            <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-474><a id=__codelineno-0-474 name=__codelineno-0-474></a>
</span><span id=__span-0-475><a id=__codelineno-0-475 name=__codelineno-0-475></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-476><a id=__codelineno-0-476 name=__codelineno-0-476></a>                <span class=c1># MoS approach: randomly sample from active generators</span>
</span><span id=__span-0-477><a id=__codelineno-0-477 name=__codelineno-0-477></a>                <span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-0-478><a id=__codelineno-0-478 name=__codelineno-0-478></a>
</span><span id=__span-0-479><a id=__codelineno-0-479 name=__codelineno-0-479></a>                <span class=c1># Get indices of currently active generators</span>
</span><span id=__span-0-480><a id=__codelineno-0-480 name=__codelineno-0-480></a>                <span class=n>active_generators</span> <span class=o>=</span> <span class=p>[</span><span class=n>g</span> <span class=k>for</span> <span class=n>g</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>generators</span> <span class=k>if</span> <span class=n>g</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]]</span>
</span><span id=__span-0-481><a id=__codelineno-0-481 name=__codelineno-0-481></a>
</span><span id=__span-0-482><a id=__codelineno-0-482 name=__codelineno-0-482></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>active_generators</span><span class=p>:</span>
</span><span id=__span-0-483><a id=__codelineno-0-483 name=__codelineno-0-483></a>                    <span class=c1># Check if we should start a new epoch</span>
</span><span id=__span-0-484><a id=__codelineno-0-484 name=__codelineno-0-484></a>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>:</span>
</span><span id=__span-0-485><a id=__codelineno-0-485 name=__codelineno-0-485></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-486><a id=__codelineno-0-486 name=__codelineno-0-486></a>                            <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-487><a id=__codelineno-0-487 name=__codelineno-0-487></a>                                <span class=sa>f</span><span class=s2>&quot; Epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2> complete, starting epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-488><a id=__codelineno-0-488 name=__codelineno-0-488></a>                            <span class=p>)</span>
</span><span id=__span-0-489><a id=__codelineno-0-489 name=__codelineno-0-489></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>reset_for_epoch</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-490><a id=__codelineno-0-490 name=__codelineno-0-490></a>                        <span class=k>continue</span>
</span><span id=__span-0-491><a id=__codelineno-0-491 name=__codelineno-0-491></a>                    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-492><a id=__codelineno-0-492 name=__codelineno-0-492></a>                        <span class=k>raise</span> <span class=ne>StopIteration</span><span class=p>(</span><span class=s2>&quot;No more epochs available&quot;</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=kc>None</span>
</span><span id=__span-0-493><a id=__codelineno-0-493 name=__codelineno-0-493></a>
</span><span id=__span-0-494><a id=__codelineno-0-494 name=__codelineno-0-494></a>                <span class=c1># Randomly sample from active generators</span>
</span><span id=__span-0-495><a id=__codelineno-0-495 name=__codelineno-0-495></a>                <span class=n>n_to_sample</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>active_generators</span><span class=p>))</span>
</span><span id=__span-0-496><a id=__codelineno-0-496 name=__codelineno-0-496></a>                <span class=n>selected_generators</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span>
</span><span id=__span-0-497><a id=__codelineno-0-497 name=__codelineno-0-497></a>                    <span class=n>active_generators</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_to_sample</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-0-498><a id=__codelineno-0-498 name=__codelineno-0-498></a>                <span class=p>)</span>
</span><span id=__span-0-499><a id=__codelineno-0-499 name=__codelineno-0-499></a>
</span><span id=__span-0-500><a id=__codelineno-0-500 name=__codelineno-0-500></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-501><a id=__codelineno-0-501 name=__codelineno-0-501></a>                    <span class=n>print_prefetch</span><span class=p>(</span>
</span><span id=__span-0-502><a id=__codelineno-0-502 name=__codelineno-0-502></a>                        <span class=sa>f</span><span class=s2>&quot;TileDB MoS sampling: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>active_generators</span><span class=p>)</span><span class=si>}</span><span class=s2> active generators, &quot;</span>
</span><span id=__span-0-503><a id=__codelineno-0-503 name=__codelineno-0-503></a>                        <span class=sa>f</span><span class=s2>&quot;sampling from </span><span class=si>{</span><span class=n>n_to_sample</span><span class=si>}</span><span class=s2> generators&quot;</span><span class=p>,</span>
</span><span id=__span-0-504><a id=__codelineno-0-504 name=__codelineno-0-504></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-505><a id=__codelineno-0-505 name=__codelineno-0-505></a>                    <span class=p>)</span>
</span><span id=__span-0-506><a id=__codelineno-0-506 name=__codelineno-0-506></a>
</span><span id=__span-0-507><a id=__codelineno-0-507 name=__codelineno-0-507></a>                <span class=c1># Load data from selected generators</span>
</span><span id=__span-0-508><a id=__codelineno-0-508 name=__codelineno-0-508></a>                <span class=n>load_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-509><a id=__codelineno-0-509 name=__codelineno-0-509></a>                <span class=n>batch_dfs</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-510><a id=__codelineno-0-510 name=__codelineno-0-510></a>
</span><span id=__span-0-511><a id=__codelineno-0-511 name=__codelineno-0-511></a>                <span class=k>for</span> <span class=n>generator</span> <span class=ow>in</span> <span class=n>selected_generators</span><span class=p>:</span>
</span><span id=__span-0-512><a id=__codelineno-0-512 name=__codelineno-0-512></a>                    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-513><a id=__codelineno-0-513 name=__codelineno-0-513></a>                        <span class=n>start_cell</span> <span class=o>=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span>
</span><span id=__span-0-514><a id=__codelineno-0-514 name=__codelineno-0-514></a>                        <span class=n>end_cell</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span>
</span><span id=__span-0-515><a id=__codelineno-0-515 name=__codelineno-0-515></a>                            <span class=n>start_cell</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-516><a id=__codelineno-0-516 name=__codelineno-0-516></a>                            <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;end_position&quot;</span><span class=p>],</span>
</span><span id=__span-0-517><a id=__codelineno-0-517 name=__codelineno-0-517></a>                        <span class=p>)</span>
</span><span id=__span-0-518><a id=__codelineno-0-518 name=__codelineno-0-518></a>
</span><span id=__span-0-519><a id=__codelineno-0-519 name=__codelineno-0-519></a>                        <span class=k>if</span> <span class=n>start_cell</span> <span class=o>&gt;=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;end_position&quot;</span><span class=p>]:</span>
</span><span id=__span-0-520><a id=__codelineno-0-520 name=__codelineno-0-520></a>                            <span class=c1># Generator exhausted</span>
</span><span id=__span-0-521><a id=__codelineno-0-521 name=__codelineno-0-521></a>                            <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-522><a id=__codelineno-0-522 name=__codelineno-0-522></a>                            <span class=k>continue</span>
</span><span id=__span-0-523><a id=__codelineno-0-523 name=__codelineno-0-523></a>
</span><span id=__span-0-524><a id=__codelineno-0-524 name=__codelineno-0-524></a>                        <span class=c1># Read slice from TileDB</span>
</span><span id=__span-0-525><a id=__codelineno-0-525 name=__codelineno-0-525></a>                        <span class=n>arrow_data</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-526><a id=__codelineno-0-526 name=__codelineno-0-526></a>                            <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>read</span><span class=p>((</span><span class=nb>slice</span><span class=p>(</span><span class=n>start_cell</span><span class=p>,</span> <span class=n>end_cell</span><span class=p>),))</span>
</span><span id=__span-0-527><a id=__codelineno-0-527 name=__codelineno-0-527></a>                            <span class=o>.</span><span class=n>tables</span><span class=p>()</span>
</span><span id=__span-0-528><a id=__codelineno-0-528 name=__codelineno-0-528></a>                            <span class=o>.</span><span class=n>concat</span><span class=p>()</span>
</span><span id=__span-0-529><a id=__codelineno-0-529 name=__codelineno-0-529></a>                        <span class=p>)</span>
</span><span id=__span-0-530><a id=__codelineno-0-530 name=__codelineno-0-530></a>
</span><span id=__span-0-531><a id=__codelineno-0-531 name=__codelineno-0-531></a>                        <span class=c1># Convert Arrow table to Polars DataFrame</span>
</span><span id=__span-0-532><a id=__codelineno-0-532 name=__codelineno-0-532></a>                        <span class=n>df</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>from_arrow</span><span class=p>(</span><span class=n>arrow_data</span><span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-533><a id=__codelineno-0-533 name=__codelineno-0-533></a>                        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span><span id=__span-0-534><a id=__codelineno-0-534 name=__codelineno-0-534></a>                            <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=s2>&quot;Expected DataFrame from Arrow table&quot;</span><span class=p>)</span>
</span><span id=__span-0-535><a id=__codelineno-0-535 name=__codelineno-0-535></a>
</span><span id=__span-0-536><a id=__codelineno-0-536 name=__codelineno-0-536></a>                        <span class=c1># Rename SOMA columns to expected names</span>
</span><span id=__span-0-537><a id=__codelineno-0-537 name=__codelineno-0-537></a>                        <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span>
</span><span id=__span-0-538><a id=__codelineno-0-538 name=__codelineno-0-538></a>                            <span class=p>{</span>
</span><span id=__span-0-539><a id=__codelineno-0-539 name=__codelineno-0-539></a>                                <span class=s2>&quot;soma_dim_0&quot;</span><span class=p>:</span> <span class=s2>&quot;cell_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-540><a id=__codelineno-0-540 name=__codelineno-0-540></a>                                <span class=s2>&quot;soma_dim_1&quot;</span><span class=p>:</span> <span class=s2>&quot;gene_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-541><a id=__codelineno-0-541 name=__codelineno-0-541></a>                                <span class=s2>&quot;soma_data&quot;</span><span class=p>:</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-0-542><a id=__codelineno-0-542 name=__codelineno-0-542></a>                            <span class=p>}</span>
</span><span id=__span-0-543><a id=__codelineno-0-543 name=__codelineno-0-543></a>                        <span class=p>)</span>
</span><span id=__span-0-544><a id=__codelineno-0-544 name=__codelineno-0-544></a>
</span><span id=__span-0-545><a id=__codelineno-0-545 name=__codelineno-0-545></a>                        <span class=n>batch_dfs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span><span id=__span-0-546><a id=__codelineno-0-546 name=__codelineno-0-546></a>
</span><span id=__span-0-547><a id=__codelineno-0-547 name=__codelineno-0-547></a>                        <span class=c1># Update generator position</span>
</span><span id=__span-0-548><a id=__codelineno-0-548 name=__codelineno-0-548></a>                        <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>end_cell</span>
</span><span id=__span-0-549><a id=__codelineno-0-549 name=__codelineno-0-549></a>
</span><span id=__span-0-550><a id=__codelineno-0-550 name=__codelineno-0-550></a>                        <span class=c1># Mark as inactive if exhausted</span>
</span><span id=__span-0-551><a id=__codelineno-0-551 name=__codelineno-0-551></a>                        <span class=k>if</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;end_position&quot;</span><span class=p>]:</span>
</span><span id=__span-0-552><a id=__codelineno-0-552 name=__codelineno-0-552></a>                            <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-553><a id=__codelineno-0-553 name=__codelineno-0-553></a>
</span><span id=__span-0-554><a id=__codelineno-0-554 name=__codelineno-0-554></a>                    <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-555><a id=__codelineno-0-555 name=__codelineno-0-555></a>                        <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
</span><span id=__span-0-556><a id=__codelineno-0-556 name=__codelineno-0-556></a>                            <span class=sa>f</span><span class=s2>&quot;Error loading TileDB data from generator </span><span class=si>{</span><span class=n>generator</span><span class=p>[</span><span class=s1>&#39;generator_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-557><a id=__codelineno-0-557 name=__codelineno-0-557></a>                        <span class=p>)</span>
</span><span id=__span-0-558><a id=__codelineno-0-558 name=__codelineno-0-558></a>                        <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-559><a id=__codelineno-0-559 name=__codelineno-0-559></a>                        <span class=k>continue</span>
</span><span id=__span-0-560><a id=__codelineno-0-560 name=__codelineno-0-560></a>
</span><span id=__span-0-561><a id=__codelineno-0-561 name=__codelineno-0-561></a>                <span class=k>if</span> <span class=ow>not</span> <span class=n>batch_dfs</span><span class=p>:</span>
</span><span id=__span-0-562><a id=__codelineno-0-562 name=__codelineno-0-562></a>                    <span class=c1># All selected generators are exhausted, continue to next iteration</span>
</span><span id=__span-0-563><a id=__codelineno-0-563 name=__codelineno-0-563></a>                    <span class=k>continue</span>
</span><span id=__span-0-564><a id=__codelineno-0-564 name=__codelineno-0-564></a>
</span><span id=__span-0-565><a id=__codelineno-0-565 name=__codelineno-0-565></a>                <span class=c1># Combine all batches</span>
</span><span id=__span-0-566><a id=__codelineno-0-566 name=__codelineno-0-566></a>                <span class=n>combined_df_mos</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>batch_dfs</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s2>&quot;vertical&quot;</span><span class=p>)</span>
</span><span id=__span-0-567><a id=__codelineno-0-567 name=__codelineno-0-567></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-568><a id=__codelineno-0-568 name=__codelineno-0-568></a>                <span class=c1># Sequential approach (original implementation)</span>
</span><span id=__span-0-569><a id=__codelineno-0-569 name=__codelineno-0-569></a>                <span class=n>current_position</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-570><a id=__codelineno-0-570 name=__codelineno-0-570></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span>
</span><span id=__span-0-571><a id=__codelineno-0-571 name=__codelineno-0-571></a>                <span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span>
</span><span id=__span-0-572><a id=__codelineno-0-572 name=__codelineno-0-572></a>
</span><span id=__span-0-573><a id=__codelineno-0-573 name=__codelineno-0-573></a>                <span class=c1># Only check for epoch transitions when we actually wrap around</span>
</span><span id=__span-0-574><a id=__codelineno-0-574 name=__codelineno-0-574></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-575><a id=__codelineno-0-575 name=__codelineno-0-575></a>                    <span class=n>prev_position</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-576><a id=__codelineno-0-576 name=__codelineno-0-576></a>                        <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span>
</span><span id=__span-0-577><a id=__codelineno-0-577 name=__codelineno-0-577></a>                    <span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span>
</span><span id=__span-0-578><a id=__codelineno-0-578 name=__codelineno-0-578></a>                    <span class=k>if</span> <span class=n>current_position</span> <span class=o>&lt;</span> <span class=n>prev_position</span><span class=p>:</span>  <span class=c1># We wrapped around</span>
</span><span id=__span-0-579><a id=__codelineno-0-579 name=__codelineno-0-579></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>:</span>
</span><span id=__span-0-580><a id=__codelineno-0-580 name=__codelineno-0-580></a>                            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-581><a id=__codelineno-0-581 name=__codelineno-0-581></a>                                <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-582><a id=__codelineno-0-582 name=__codelineno-0-582></a>                                    <span class=sa>f</span><span class=s2>&quot; Epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2> complete, starting epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-583><a id=__codelineno-0-583 name=__codelineno-0-583></a>                                <span class=p>)</span>
</span><span id=__span-0-584><a id=__codelineno-0-584 name=__codelineno-0-584></a>                            <span class=bp>self</span><span class=o>.</span><span class=n>reset_for_epoch</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-585><a id=__codelineno-0-585 name=__codelineno-0-585></a>                            <span class=k>continue</span>
</span><span id=__span-0-586><a id=__codelineno-0-586 name=__codelineno-0-586></a>                        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-587><a id=__codelineno-0-587 name=__codelineno-0-587></a>                            <span class=k>raise</span> <span class=ne>StopIteration</span><span class=p>(</span><span class=s2>&quot;No more epochs available&quot;</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=kc>None</span>
</span><span id=__span-0-588><a id=__codelineno-0-588 name=__codelineno-0-588></a>
</span><span id=__span-0-589><a id=__codelineno-0-589 name=__codelineno-0-589></a>                <span class=c1># Load data from TileDB</span>
</span><span id=__span-0-590><a id=__codelineno-0-590 name=__codelineno-0-590></a>                <span class=n>load_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-591><a id=__codelineno-0-591 name=__codelineno-0-591></a>                <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-592><a id=__codelineno-0-592 name=__codelineno-0-592></a>                    <span class=c1># Read slice from TileDB as Arrow table</span>
</span><span id=__span-0-593><a id=__codelineno-0-593 name=__codelineno-0-593></a>                    <span class=n>arrow_data</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-594><a id=__codelineno-0-594 name=__codelineno-0-594></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>read</span><span class=p>(</span>
</span><span id=__span-0-595><a id=__codelineno-0-595 name=__codelineno-0-595></a>                            <span class=p>(</span>
</span><span id=__span-0-596><a id=__codelineno-0-596 name=__codelineno-0-596></a>                                <span class=nb>slice</span><span class=p>(</span>
</span><span id=__span-0-597><a id=__codelineno-0-597 name=__codelineno-0-597></a>                                    <span class=n>current_position</span><span class=p>,</span>
</span><span id=__span-0-598><a id=__codelineno-0-598 name=__codelineno-0-598></a>                                    <span class=n>current_position</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-599><a id=__codelineno-0-599 name=__codelineno-0-599></a>                                <span class=p>),</span>
</span><span id=__span-0-600><a id=__codelineno-0-600 name=__codelineno-0-600></a>                            <span class=p>)</span>
</span><span id=__span-0-601><a id=__codelineno-0-601 name=__codelineno-0-601></a>                        <span class=p>)</span>
</span><span id=__span-0-602><a id=__codelineno-0-602 name=__codelineno-0-602></a>                        <span class=o>.</span><span class=n>tables</span><span class=p>()</span>
</span><span id=__span-0-603><a id=__codelineno-0-603 name=__codelineno-0-603></a>                        <span class=o>.</span><span class=n>concat</span><span class=p>()</span>
</span><span id=__span-0-604><a id=__codelineno-0-604 name=__codelineno-0-604></a>                    <span class=p>)</span>
</span><span id=__span-0-605><a id=__codelineno-0-605 name=__codelineno-0-605></a>
</span><span id=__span-0-606><a id=__codelineno-0-606 name=__codelineno-0-606></a>                    <span class=c1># Convert Arrow table to Polars DataFrame</span>
</span><span id=__span-0-607><a id=__codelineno-0-607 name=__codelineno-0-607></a>                    <span class=n>combined_df</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>from_arrow</span><span class=p>(</span><span class=n>arrow_data</span><span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-608><a id=__codelineno-0-608 name=__codelineno-0-608></a>                    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>combined_df</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span><span id=__span-0-609><a id=__codelineno-0-609 name=__codelineno-0-609></a>                        <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=s2>&quot;Expected DataFrame from Arrow table&quot;</span><span class=p>)</span>
</span><span id=__span-0-610><a id=__codelineno-0-610 name=__codelineno-0-610></a>
</span><span id=__span-0-611><a id=__codelineno-0-611 name=__codelineno-0-611></a>                    <span class=c1># Rename SOMA columns to expected names</span>
</span><span id=__span-0-612><a id=__codelineno-0-612 name=__codelineno-0-612></a>                    <span class=n>combined_df</span> <span class=o>=</span> <span class=n>combined_df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span>
</span><span id=__span-0-613><a id=__codelineno-0-613 name=__codelineno-0-613></a>                        <span class=p>{</span>
</span><span id=__span-0-614><a id=__codelineno-0-614 name=__codelineno-0-614></a>                            <span class=s2>&quot;soma_dim_0&quot;</span><span class=p>:</span> <span class=s2>&quot;cell_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-615><a id=__codelineno-0-615 name=__codelineno-0-615></a>                            <span class=s2>&quot;soma_dim_1&quot;</span><span class=p>:</span> <span class=s2>&quot;gene_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-616><a id=__codelineno-0-616 name=__codelineno-0-616></a>                            <span class=s2>&quot;soma_data&quot;</span><span class=p>:</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-0-617><a id=__codelineno-0-617 name=__codelineno-0-617></a>                        <span class=p>}</span>
</span><span id=__span-0-618><a id=__codelineno-0-618 name=__codelineno-0-618></a>                    <span class=p>)</span>
</span><span id=__span-0-619><a id=__codelineno-0-619 name=__codelineno-0-619></a>
</span><span id=__span-0-620><a id=__codelineno-0-620 name=__codelineno-0-620></a>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-621><a id=__codelineno-0-621 name=__codelineno-0-621></a>                    <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error loading TileDB data: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-622><a id=__codelineno-0-622 name=__codelineno-0-622></a>                    <span class=k>raise</span> <span class=ne>StopIteration</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Failed to load TileDB data: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=nn>e</span>
</span><span id=__span-0-623><a id=__codelineno-0-623 name=__codelineno-0-623></a>
</span><span id=__span-0-624><a id=__codelineno-0-624 name=__codelineno-0-624></a>            <span class=n>load_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>load_start</span>
</span><span id=__span-0-625><a id=__codelineno-0-625 name=__codelineno-0-625></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;tiledb_loading&quot;</span><span class=p>,</span> <span class=n>load_time</span><span class=p>)</span>
</span><span id=__span-0-626><a id=__codelineno-0-626 name=__codelineno-0-626></a>
</span><span id=__span-0-627><a id=__codelineno-0-627 name=__codelineno-0-627></a>            <span class=c1># Print detailed loading breakdown every 10 batches</span>
</span><span id=__span-0-628><a id=__codelineno-0-628 name=__codelineno-0-628></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-629><a id=__codelineno-0-629 name=__codelineno-0-629></a>                <span class=kn>import</span><span class=w> </span><span class=nn>psutil</span>
</span><span id=__span-0-630><a id=__codelineno-0-630 name=__codelineno-0-630></a>
</span><span id=__span-0-631><a id=__codelineno-0-631 name=__codelineno-0-631></a>                <span class=n>process</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>Process</span><span class=p>()</span>
</span><span id=__span-0-632><a id=__codelineno-0-632 name=__codelineno-0-632></a>                <span class=n>memory_mb</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>memory_info</span><span class=p>()</span><span class=o>.</span><span class=n>rss</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span>
</span><span id=__span-0-633><a id=__codelineno-0-633 name=__codelineno-0-633></a>
</span><span id=__span-0-634><a id=__codelineno-0-634 name=__codelineno-0-634></a>                <span class=c1># Store timing info for consolidated report</span>
</span><span id=__span-0-635><a id=__codelineno-0-635 name=__codelineno-0-635></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_last_load_time</span> <span class=o>=</span> <span class=n>load_time</span>
</span><span id=__span-0-636><a id=__codelineno-0-636 name=__codelineno-0-636></a>                <span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span> <span class=o>=</span> <span class=n>memory_mb</span>
</span><span id=__span-0-637><a id=__codelineno-0-637 name=__codelineno-0-637></a>
</span><span id=__span-0-638><a id=__codelineno-0-638 name=__codelineno-0-638></a>            <span class=c1># Apply shuffling strategy</span>
</span><span id=__span-0-639><a id=__codelineno-0-639 name=__codelineno-0-639></a>            <span class=n>shuffle_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-640><a id=__codelineno-0-640 name=__codelineno-0-640></a>
</span><span id=__span-0-641><a id=__codelineno-0-641 name=__codelineno-0-641></a>            <span class=c1># Apply shuffling with chunking</span>
</span><span id=__span-0-642><a id=__codelineno-0-642 name=__codelineno-0-642></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-643><a id=__codelineno-0-643 name=__codelineno-0-643></a>                <span class=n>shuffled_chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>shuffle</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
</span><span id=__span-0-644><a id=__codelineno-0-644 name=__codelineno-0-644></a>                    <span class=n>combined_df_mos</span><span class=p>,</span>  <span class=c1># type: ignore[arg-type]</span>
</span><span id=__span-0-645><a id=__codelineno-0-645 name=__codelineno-0-645></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>*</span> <span class=mi>10000</span><span class=p>,</span>
</span><span id=__span-0-646><a id=__codelineno-0-646 name=__codelineno-0-646></a>                    <span class=n>batch_size</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-647><a id=__codelineno-0-647 name=__codelineno-0-647></a>                <span class=p>)</span>
</span><span id=__span-0-648><a id=__codelineno-0-648 name=__codelineno-0-648></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-649><a id=__codelineno-0-649 name=__codelineno-0-649></a>                <span class=n>shuffled_chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>shuffle</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
</span><span id=__span-0-650><a id=__codelineno-0-650 name=__codelineno-0-650></a>                    <span class=n>combined_df</span><span class=p>,</span>  <span class=c1># type: ignore[arg-type]</span>
</span><span id=__span-0-651><a id=__codelineno-0-651 name=__codelineno-0-651></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>*</span> <span class=mi>10000</span><span class=p>,</span>
</span><span id=__span-0-652><a id=__codelineno-0-652 name=__codelineno-0-652></a>                    <span class=n>batch_size</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-653><a id=__codelineno-0-653 name=__codelineno-0-653></a>                <span class=p>)</span>
</span><span id=__span-0-654><a id=__codelineno-0-654 name=__codelineno-0-654></a>
</span><span id=__span-0-655><a id=__codelineno-0-655 name=__codelineno-0-655></a>            <span class=n>shuffle_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>shuffle_start</span>
</span><span id=__span-0-656><a id=__codelineno-0-656 name=__codelineno-0-656></a>            <span class=n>total_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span><span id=__span-0-657><a id=__codelineno-0-657 name=__codelineno-0-657></a>
</span><span id=__span-0-658><a id=__codelineno-0-658 name=__codelineno-0-658></a>            <span class=c1># Record timing metrics</span>
</span><span id=__span-0-659><a id=__codelineno-0-659 name=__codelineno-0-659></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;shuffle&quot;</span><span class=p>,</span> <span class=n>shuffle_time</span><span class=p>)</span>
</span><span id=__span-0-660><a id=__codelineno-0-660 name=__codelineno-0-660></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;total&quot;</span><span class=p>,</span> <span class=n>total_time</span><span class=p>)</span>
</span><span id=__span-0-661><a id=__codelineno-0-661 name=__codelineno-0-661></a>
</span><span id=__span-0-662><a id=__codelineno-0-662 name=__codelineno-0-662></a>            <span class=c1># Count total cells across all chunks</span>
</span><span id=__span-0-663><a id=__codelineno-0-663 name=__codelineno-0-663></a>            <span class=n>total_cells_in_chunks</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
</span><span id=__span-0-664><a id=__codelineno-0-664 name=__codelineno-0-664></a>                <span class=nb>len</span><span class=p>(</span><span class=n>chunk</span><span class=o>.</span><span class=n>get_column</span><span class=p>(</span><span class=s2>&quot;cell_integer_id&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>unique</span><span class=p>())</span>
</span><span id=__span-0-665><a id=__codelineno-0-665 name=__codelineno-0-665></a>                <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>shuffled_chunks</span>
</span><span id=__span-0-666><a id=__codelineno-0-666 name=__codelineno-0-666></a>                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span>
</span><span id=__span-0-667><a id=__codelineno-0-667 name=__codelineno-0-667></a>            <span class=p>)</span>
</span><span id=__span-0-668><a id=__codelineno-0-668 name=__codelineno-0-668></a>
</span><span id=__span-0-669><a id=__codelineno-0-669 name=__codelineno-0-669></a>            <span class=c1># Record cells processed</span>
</span><span id=__span-0-670><a id=__codelineno-0-670 name=__codelineno-0-670></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;cells_processed&quot;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>total_cells_in_chunks</span><span class=p>)</span>
</span><span id=__span-0-671><a id=__codelineno-0-671 name=__codelineno-0-671></a>
</span><span id=__span-0-672><a id=__codelineno-0-672 name=__codelineno-0-672></a>            <span class=c1># Print consolidated prefetch batch reporting</span>
</span><span id=__span-0-673><a id=__codelineno-0-673 name=__codelineno-0-673></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-674><a id=__codelineno-0-674 name=__codelineno-0-674></a>                <span class=n>strategy_name</span> <span class=o>=</span> <span class=s2>&quot;MoS&quot;</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=k>else</span> <span class=s2>&quot;sequential&quot;</span>
</span><span id=__span-0-675><a id=__codelineno-0-675 name=__codelineno-0-675></a>                <span class=n>prefetch_report</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;TileDB </span><span class=si>{</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2> prefetch batch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2> (epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2>):</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-676><a id=__codelineno-0-676 name=__codelineno-0-676></a>                <span class=n>prefetch_report</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;   TileDB loading: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_last_load_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms (</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=si>}</span><span class=s2> cells)</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-677><a id=__codelineno-0-677 name=__codelineno-0-677></a>                <span class=n>prefetch_report</span> <span class=o>+=</span> <span class=p>(</span>
</span><span id=__span-0-678><a id=__codelineno-0-678 name=__codelineno-0-678></a>                    <span class=sa>f</span><span class=s2>&quot;   Processing: </span><span class=si>{</span><span class=n>shuffle_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms shuffle</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-679><a id=__codelineno-0-679 name=__codelineno-0-679></a>                <span class=p>)</span>
</span><span id=__span-0-680><a id=__codelineno-0-680 name=__codelineno-0-680></a>                <span class=n>prefetch_report</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;   Total: </span><span class=si>{</span><span class=n>total_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms, </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>shuffled_chunks</span><span class=p>)</span><span class=si>}</span><span class=s2> chunks, </span><span class=si>{</span><span class=n>total_cells_in_chunks</span><span class=si>}</span><span class=s2> cells, </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> MB&quot;</span>
</span><span id=__span-0-681><a id=__codelineno-0-681 name=__codelineno-0-681></a>
</span><span id=__span-0-682><a id=__codelineno-0-682 name=__codelineno-0-682></a>                <span class=n>print_prefetch</span><span class=p>(</span><span class=n>prefetch_report</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span>
</span><span id=__span-0-683><a id=__codelineno-0-683 name=__codelineno-0-683></a>
</span><span id=__span-0-684><a id=__codelineno-0-684 name=__codelineno-0-684></a>            <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-685><a id=__codelineno-0-685 name=__codelineno-0-685></a>
</span><span id=__span-0-686><a id=__codelineno-0-686 name=__codelineno-0-686></a>            <span class=c1># Return the first chunk as a batch (we&#39;ll handle multiple chunks in the dataloader)</span>
</span><span id=__span-0-687><a id=__codelineno-0-687 name=__codelineno-0-687></a>            <span class=k>if</span> <span class=n>shuffled_chunks</span><span class=p>:</span>
</span><span id=__span-0-688><a id=__codelineno-0-688 name=__codelineno-0-688></a>                <span class=n>first_chunk</span> <span class=o>=</span> <span class=n>shuffled_chunks</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-0-689><a id=__codelineno-0-689 name=__codelineno-0-689></a>                <span class=k>return</span> <span class=n>TileDBPrefetchBatch</span><span class=p>(</span>
</span><span id=__span-0-690><a id=__codelineno-0-690 name=__codelineno-0-690></a>                    <span class=n>batch_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-691><a id=__codelineno-0-691 name=__codelineno-0-691></a>                    <span class=n>batch_df</span><span class=o>=</span><span class=n>first_chunk</span><span class=p>,</span>
</span><span id=__span-0-692><a id=__codelineno-0-692 name=__codelineno-0-692></a>                    <span class=n>cell_integer_ids</span><span class=o>=</span><span class=n>first_chunk</span><span class=p>[</span><span class=s2>&quot;cell_integer_id&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span><span class=o>.</span><span class=n>to_list</span><span class=p>(),</span>
</span><span id=__span-0-693><a id=__codelineno-0-693 name=__codelineno-0-693></a>                    <span class=n>process_time</span><span class=o>=</span><span class=n>shuffle_time</span><span class=p>,</span>
</span><span id=__span-0-694><a id=__codelineno-0-694 name=__codelineno-0-694></a>                    <span class=n>memory_mb</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span><span class=p>,</span>
</span><span id=__span-0-695><a id=__codelineno-0-695 name=__codelineno-0-695></a>                <span class=p>)</span>
</span><span id=__span-0-696><a id=__codelineno-0-696 name=__codelineno-0-696></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-697><a id=__codelineno-0-697 name=__codelineno-0-697></a>                <span class=c1># No data in this chunk, continue to next iteration</span>
</span><span id=__span-0-698><a id=__codelineno-0-698 name=__codelineno-0-698></a>                <span class=k>continue</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <h5 id=slaf.ml.tiledb_dataloaders.TileDBBatchProcessor-functions>Functions<a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor-functions class=headerlink title="Permanent link">&para;</a></h5> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span> <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span> <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>log_metrics</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span> <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span> <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>)</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.__init__ class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Initialize the TileDB batch processor with training configuration.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tiledb_path</code> </td> <td> <code><span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>Path to the TileDB SOMA experiment directory. Must contain a valid SOMA experiment with RNA measurement data.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells per training batch. Larger batches use more memory but may improve training efficiency. Range: 1-512, default: 32.</p> </div> </td> <td> <code>32</code> </td> </tr> <tr class=doc-section-item> <td> <code>prefetch_batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells to load per prefetch batch from TileDB. Higher values improve throughput but use more memory. Range: 10-10000, default: 100.</p> </div> </td> <td> <code>100</code> </td> </tr> <tr class=doc-section-item> <td> <code>seed</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Random seed for reproducible shuffling and MoS sampling. Used for consistent data ordering across runs. Default: 42.</p> </div> </td> <td> <code>42</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_epochs</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of epochs to run. The processor will automatically reset after each epoch, enabling multi-epoch training. Default: 1.</p> </div> </td> <td> <code>1</code> </td> </tr> <tr class=doc-section-item> <td> <code>verbose</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, print detailed timing and progress information. If False, suppress all internal prints for clean output. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>log_metrics</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, collect detailed timing metrics for performance analysis. Metrics include loading time, shuffle time, and memory usage. Default: False.</p> </div> </td> <td> <code>False</code> </td> </tr> <tr class=doc-section-item> <td> <code>use_mixture_of_scanners</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, use MoS strategy for higher entropy by randomly sampling from multiple fragment generators. Provides better randomization for foundation model training. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_readers</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Total number of fragment generators to create when using MoS. Higher values provide better entropy but use more memory. Range: 1-1000, default: 50.</p> </div> </td> <td> <code>50</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_scanners</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of active scanners to sample from simultaneously when using MoS. Higher values provide better entropy but use more memory. Range: 1-100, default: 8.</p> </div> </td> <td> <code>8</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ImportError>ImportError</span></code> </td> <td> <div class=doc-md-description> <p>If TileDB SOMA is not available.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If MoS parameters are invalid (n_readers &lt; 1, n_scanners &lt; 1, or n_scanners &gt; n_readers).</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=RuntimeError>RuntimeError</span></code> </td> <td> <div class=doc-md-description> <p>If the TileDB experiment cannot be opened or is invalid.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic initialization with default MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Total cells: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>total_cells</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Total cells: 50000</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS enabled: False</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># High-entropy MoS configuration</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_readers</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>n_scanners</span><span class=o>=</span><span class=mi>16</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS readers: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>n_readers</span><span class=si>}</span><span class=s2>, scanners: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>n_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS readers: 100, scanners: 16</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-190>190</a></span>
<span class=normal><a href=#__codelineno-0-191>191</a></span>
<span class=normal><a href=#__codelineno-0-192>192</a></span>
<span class=normal><a href=#__codelineno-0-193>193</a></span>
<span class=normal><a href=#__codelineno-0-194>194</a></span>
<span class=normal><a href=#__codelineno-0-195>195</a></span>
<span class=normal><a href=#__codelineno-0-196>196</a></span>
<span class=normal><a href=#__codelineno-0-197>197</a></span>
<span class=normal><a href=#__codelineno-0-198>198</a></span>
<span class=normal><a href=#__codelineno-0-199>199</a></span>
<span class=normal><a href=#__codelineno-0-200>200</a></span>
<span class=normal><a href=#__codelineno-0-201>201</a></span>
<span class=normal><a href=#__codelineno-0-202>202</a></span>
<span class=normal><a href=#__codelineno-0-203>203</a></span>
<span class=normal><a href=#__codelineno-0-204>204</a></span>
<span class=normal><a href=#__codelineno-0-205>205</a></span>
<span class=normal><a href=#__codelineno-0-206>206</a></span>
<span class=normal><a href=#__codelineno-0-207>207</a></span>
<span class=normal><a href=#__codelineno-0-208>208</a></span>
<span class=normal><a href=#__codelineno-0-209>209</a></span>
<span class=normal><a href=#__codelineno-0-210>210</a></span>
<span class=normal><a href=#__codelineno-0-211>211</a></span>
<span class=normal><a href=#__codelineno-0-212>212</a></span>
<span class=normal><a href=#__codelineno-0-213>213</a></span>
<span class=normal><a href=#__codelineno-0-214>214</a></span>
<span class=normal><a href=#__codelineno-0-215>215</a></span>
<span class=normal><a href=#__codelineno-0-216>216</a></span>
<span class=normal><a href=#__codelineno-0-217>217</a></span>
<span class=normal><a href=#__codelineno-0-218>218</a></span>
<span class=normal><a href=#__codelineno-0-219>219</a></span>
<span class=normal><a href=#__codelineno-0-220>220</a></span>
<span class=normal><a href=#__codelineno-0-221>221</a></span>
<span class=normal><a href=#__codelineno-0-222>222</a></span>
<span class=normal><a href=#__codelineno-0-223>223</a></span>
<span class=normal><a href=#__codelineno-0-224>224</a></span>
<span class=normal><a href=#__codelineno-0-225>225</a></span>
<span class=normal><a href=#__codelineno-0-226>226</a></span>
<span class=normal><a href=#__codelineno-0-227>227</a></span>
<span class=normal><a href=#__codelineno-0-228>228</a></span>
<span class=normal><a href=#__codelineno-0-229>229</a></span>
<span class=normal><a href=#__codelineno-0-230>230</a></span>
<span class=normal><a href=#__codelineno-0-231>231</a></span>
<span class=normal><a href=#__codelineno-0-232>232</a></span>
<span class=normal><a href=#__codelineno-0-233>233</a></span>
<span class=normal><a href=#__codelineno-0-234>234</a></span>
<span class=normal><a href=#__codelineno-0-235>235</a></span>
<span class=normal><a href=#__codelineno-0-236>236</a></span>
<span class=normal><a href=#__codelineno-0-237>237</a></span>
<span class=normal><a href=#__codelineno-0-238>238</a></span>
<span class=normal><a href=#__codelineno-0-239>239</a></span>
<span class=normal><a href=#__codelineno-0-240>240</a></span>
<span class=normal><a href=#__codelineno-0-241>241</a></span>
<span class=normal><a href=#__codelineno-0-242>242</a></span>
<span class=normal><a href=#__codelineno-0-243>243</a></span>
<span class=normal><a href=#__codelineno-0-244>244</a></span>
<span class=normal><a href=#__codelineno-0-245>245</a></span>
<span class=normal><a href=#__codelineno-0-246>246</a></span>
<span class=normal><a href=#__codelineno-0-247>247</a></span>
<span class=normal><a href=#__codelineno-0-248>248</a></span>
<span class=normal><a href=#__codelineno-0-249>249</a></span>
<span class=normal><a href=#__codelineno-0-250>250</a></span>
<span class=normal><a href=#__codelineno-0-251>251</a></span>
<span class=normal><a href=#__codelineno-0-252>252</a></span>
<span class=normal><a href=#__codelineno-0-253>253</a></span>
<span class=normal><a href=#__codelineno-0-254>254</a></span>
<span class=normal><a href=#__codelineno-0-255>255</a></span>
<span class=normal><a href=#__codelineno-0-256>256</a></span>
<span class=normal><a href=#__codelineno-0-257>257</a></span>
<span class=normal><a href=#__codelineno-0-258>258</a></span>
<span class=normal><a href=#__codelineno-0-259>259</a></span>
<span class=normal><a href=#__codelineno-0-260>260</a></span>
<span class=normal><a href=#__codelineno-0-261>261</a></span>
<span class=normal><a href=#__codelineno-0-262>262</a></span>
<span class=normal><a href=#__codelineno-0-263>263</a></span>
<span class=normal><a href=#__codelineno-0-264>264</a></span>
<span class=normal><a href=#__codelineno-0-265>265</a></span>
<span class=normal><a href=#__codelineno-0-266>266</a></span>
<span class=normal><a href=#__codelineno-0-267>267</a></span>
<span class=normal><a href=#__codelineno-0-268>268</a></span>
<span class=normal><a href=#__codelineno-0-269>269</a></span>
<span class=normal><a href=#__codelineno-0-270>270</a></span>
<span class=normal><a href=#__codelineno-0-271>271</a></span>
<span class=normal><a href=#__codelineno-0-272>272</a></span>
<span class=normal><a href=#__codelineno-0-273>273</a></span>
<span class=normal><a href=#__codelineno-0-274>274</a></span>
<span class=normal><a href=#__codelineno-0-275>275</a></span>
<span class=normal><a href=#__codelineno-0-276>276</a></span>
<span class=normal><a href=#__codelineno-0-277>277</a></span>
<span class=normal><a href=#__codelineno-0-278>278</a></span>
<span class=normal><a href=#__codelineno-0-279>279</a></span>
<span class=normal><a href=#__codelineno-0-280>280</a></span>
<span class=normal><a href=#__codelineno-0-281>281</a></span>
<span class=normal><a href=#__codelineno-0-282>282</a></span>
<span class=normal><a href=#__codelineno-0-283>283</a></span>
<span class=normal><a href=#__codelineno-0-284>284</a></span>
<span class=normal><a href=#__codelineno-0-285>285</a></span>
<span class=normal><a href=#__codelineno-0-286>286</a></span>
<span class=normal><a href=#__codelineno-0-287>287</a></span>
<span class=normal><a href=#__codelineno-0-288>288</a></span>
<span class=normal><a href=#__codelineno-0-289>289</a></span>
<span class=normal><a href=#__codelineno-0-290>290</a></span>
<span class=normal><a href=#__codelineno-0-291>291</a></span>
<span class=normal><a href=#__codelineno-0-292>292</a></span>
<span class=normal><a href=#__codelineno-0-293>293</a></span>
<span class=normal><a href=#__codelineno-0-294>294</a></span>
<span class=normal><a href=#__codelineno-0-295>295</a></span>
<span class=normal><a href=#__codelineno-0-296>296</a></span>
<span class=normal><a href=#__codelineno-0-297>297</a></span>
<span class=normal><a href=#__codelineno-0-298>298</a></span>
<span class=normal><a href=#__codelineno-0-299>299</a></span>
<span class=normal><a href=#__codelineno-0-300>300</a></span>
<span class=normal><a href=#__codelineno-0-301>301</a></span>
<span class=normal><a href=#__codelineno-0-302>302</a></span>
<span class=normal><a href=#__codelineno-0-303>303</a></span>
<span class=normal><a href=#__codelineno-0-304>304</a></span>
<span class=normal><a href=#__codelineno-0-305>305</a></span>
<span class=normal><a href=#__codelineno-0-306>306</a></span>
<span class=normal><a href=#__codelineno-0-307>307</a></span>
<span class=normal><a href=#__codelineno-0-308>308</a></span>
<span class=normal><a href=#__codelineno-0-309>309</a></span>
<span class=normal><a href=#__codelineno-0-310>310</a></span>
<span class=normal><a href=#__codelineno-0-311>311</a></span>
<span class=normal><a href=#__codelineno-0-312>312</a></span>
<span class=normal><a href=#__codelineno-0-313>313</a></span>
<span class=normal><a href=#__codelineno-0-314>314</a></span>
<span class=normal><a href=#__codelineno-0-315>315</a></span>
<span class=normal><a href=#__codelineno-0-316>316</a></span>
<span class=normal><a href=#__codelineno-0-317>317</a></span>
<span class=normal><a href=#__codelineno-0-318>318</a></span>
<span class=normal><a href=#__codelineno-0-319>319</a></span>
<span class=normal><a href=#__codelineno-0-320>320</a></span>
<span class=normal><a href=#__codelineno-0-321>321</a></span>
<span class=normal><a href=#__codelineno-0-322>322</a></span>
<span class=normal><a href=#__codelineno-0-323>323</a></span>
<span class=normal><a href=#__codelineno-0-324>324</a></span>
<span class=normal><a href=#__codelineno-0-325>325</a></span>
<span class=normal><a href=#__codelineno-0-326>326</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-190><a id=__codelineno-0-190 name=__codelineno-0-190></a><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-191><a id=__codelineno-0-191 name=__codelineno-0-191></a>    <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-192><a id=__codelineno-0-192 name=__codelineno-0-192></a>    <span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-193><a id=__codelineno-0-193 name=__codelineno-0-193></a>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-194><a id=__codelineno-0-194 name=__codelineno-0-194></a>    <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-195><a id=__codelineno-0-195 name=__codelineno-0-195></a>    <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span>
</span><span id=__span-0-196><a id=__codelineno-0-196 name=__codelineno-0-196></a>    <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-197><a id=__codelineno-0-197 name=__codelineno-0-197></a>    <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-198><a id=__codelineno-0-198 name=__codelineno-0-198></a>    <span class=n>log_metrics</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-199><a id=__codelineno-0-199 name=__codelineno-0-199></a>    <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-200><a id=__codelineno-0-200 name=__codelineno-0-200></a>    <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span><span id=__span-0-201><a id=__codelineno-0-201 name=__codelineno-0-201></a>    <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-0-202><a id=__codelineno-0-202 name=__codelineno-0-202></a><span class=p>):</span>
</span><span id=__span-0-203><a id=__codelineno-0-203 name=__codelineno-0-203></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-204><a id=__codelineno-0-204 name=__codelineno-0-204></a><span class=sd>    Initialize the TileDB batch processor with training configuration.</span>
</span><span id=__span-0-205><a id=__codelineno-0-205 name=__codelineno-0-205></a>
</span><span id=__span-0-206><a id=__codelineno-0-206 name=__codelineno-0-206></a><span class=sd>    Args:</span>
</span><span id=__span-0-207><a id=__codelineno-0-207 name=__codelineno-0-207></a><span class=sd>        tiledb_path: Path to the TileDB SOMA experiment directory.</span>
</span><span id=__span-0-208><a id=__codelineno-0-208 name=__codelineno-0-208></a><span class=sd>                     Must contain a valid SOMA experiment with RNA measurement data.</span>
</span><span id=__span-0-209><a id=__codelineno-0-209 name=__codelineno-0-209></a><span class=sd>        batch_size: Number of cells per training batch. Larger batches use more</span>
</span><span id=__span-0-210><a id=__codelineno-0-210 name=__codelineno-0-210></a><span class=sd>                   memory but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-211><a id=__codelineno-0-211 name=__codelineno-0-211></a><span class=sd>        prefetch_batch_size: Number of cells to load per prefetch batch from TileDB.</span>
</span><span id=__span-0-212><a id=__codelineno-0-212 name=__codelineno-0-212></a><span class=sd>                           Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-213><a id=__codelineno-0-213 name=__codelineno-0-213></a><span class=sd>                           Range: 10-10000, default: 100.</span>
</span><span id=__span-0-214><a id=__codelineno-0-214 name=__codelineno-0-214></a><span class=sd>        seed: Random seed for reproducible shuffling and MoS sampling.</span>
</span><span id=__span-0-215><a id=__codelineno-0-215 name=__codelineno-0-215></a><span class=sd>              Used for consistent data ordering across runs. Default: 42.</span>
</span><span id=__span-0-216><a id=__codelineno-0-216 name=__codelineno-0-216></a><span class=sd>        n_epochs: Number of epochs to run. The processor will automatically reset</span>
</span><span id=__span-0-217><a id=__codelineno-0-217 name=__codelineno-0-217></a><span class=sd>                 after each epoch, enabling multi-epoch training. Default: 1.</span>
</span><span id=__span-0-218><a id=__codelineno-0-218 name=__codelineno-0-218></a><span class=sd>        verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-219><a id=__codelineno-0-219 name=__codelineno-0-219></a><span class=sd>                If False, suppress all internal prints for clean output. Default: True.</span>
</span><span id=__span-0-220><a id=__codelineno-0-220 name=__codelineno-0-220></a><span class=sd>        log_metrics: If True, collect detailed timing metrics for performance analysis.</span>
</span><span id=__span-0-221><a id=__codelineno-0-221 name=__codelineno-0-221></a><span class=sd>                    Metrics include loading time, shuffle time, and memory usage.</span>
</span><span id=__span-0-222><a id=__codelineno-0-222 name=__codelineno-0-222></a><span class=sd>                    Default: False.</span>
</span><span id=__span-0-223><a id=__codelineno-0-223 name=__codelineno-0-223></a><span class=sd>        use_mixture_of_scanners: If True, use MoS strategy for higher entropy by</span>
</span><span id=__span-0-224><a id=__codelineno-0-224 name=__codelineno-0-224></a><span class=sd>                               randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-225><a id=__codelineno-0-225 name=__codelineno-0-225></a><span class=sd>                               Provides better randomization for foundation model training.</span>
</span><span id=__span-0-226><a id=__codelineno-0-226 name=__codelineno-0-226></a><span class=sd>                               Default: True.</span>
</span><span id=__span-0-227><a id=__codelineno-0-227 name=__codelineno-0-227></a><span class=sd>        n_readers: Total number of fragment generators to create when using MoS.</span>
</span><span id=__span-0-228><a id=__codelineno-0-228 name=__codelineno-0-228></a><span class=sd>                  Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-229><a id=__codelineno-0-229 name=__codelineno-0-229></a><span class=sd>                  Range: 1-1000, default: 50.</span>
</span><span id=__span-0-230><a id=__codelineno-0-230 name=__codelineno-0-230></a><span class=sd>        n_scanners: Number of active scanners to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-231><a id=__codelineno-0-231 name=__codelineno-0-231></a><span class=sd>                   Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-232><a id=__codelineno-0-232 name=__codelineno-0-232></a><span class=sd>                   Range: 1-100, default: 8.</span>
</span><span id=__span-0-233><a id=__codelineno-0-233 name=__codelineno-0-233></a>
</span><span id=__span-0-234><a id=__codelineno-0-234 name=__codelineno-0-234></a><span class=sd>    Raises:</span>
</span><span id=__span-0-235><a id=__codelineno-0-235 name=__codelineno-0-235></a><span class=sd>        ImportError: If TileDB SOMA is not available.</span>
</span><span id=__span-0-236><a id=__codelineno-0-236 name=__codelineno-0-236></a><span class=sd>        ValueError: If MoS parameters are invalid (n_readers &lt; 1, n_scanners &lt; 1,</span>
</span><span id=__span-0-237><a id=__codelineno-0-237 name=__codelineno-0-237></a><span class=sd>                   or n_scanners &gt; n_readers).</span>
</span><span id=__span-0-238><a id=__codelineno-0-238 name=__codelineno-0-238></a><span class=sd>        RuntimeError: If the TileDB experiment cannot be opened or is invalid.</span>
</span><span id=__span-0-239><a id=__codelineno-0-239 name=__codelineno-0-239></a>
</span><span id=__span-0-240><a id=__codelineno-0-240 name=__codelineno-0-240></a><span class=sd>    Examples:</span>
</span><span id=__span-0-241><a id=__codelineno-0-241 name=__codelineno-0-241></a><span class=sd>        &gt;&gt;&gt; # Basic initialization with default MoS strategy</span>
</span><span id=__span-0-242><a id=__codelineno-0-242 name=__codelineno-0-242></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-243><a id=__codelineno-0-243 name=__codelineno-0-243></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-244><a id=__codelineno-0-244 name=__codelineno-0-244></a><span class=sd>        ...     batch_size=32,</span>
</span><span id=__span-0-245><a id=__codelineno-0-245 name=__codelineno-0-245></a><span class=sd>        ...     prefetch_batch_size=100</span>
</span><span id=__span-0-246><a id=__codelineno-0-246 name=__codelineno-0-246></a><span class=sd>        ... )</span>
</span><span id=__span-0-247><a id=__codelineno-0-247 name=__codelineno-0-247></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Total cells: {processor.total_cells}&quot;)</span>
</span><span id=__span-0-248><a id=__codelineno-0-248 name=__codelineno-0-248></a><span class=sd>        Total cells: 50000</span>
</span><span id=__span-0-249><a id=__codelineno-0-249 name=__codelineno-0-249></a>
</span><span id=__span-0-250><a id=__codelineno-0-250 name=__codelineno-0-250></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-251><a id=__codelineno-0-251 name=__codelineno-0-251></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-252><a id=__codelineno-0-252 name=__codelineno-0-252></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-253><a id=__codelineno-0-253 name=__codelineno-0-253></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-254><a id=__codelineno-0-254 name=__codelineno-0-254></a><span class=sd>        ...     batch_size=64</span>
</span><span id=__span-0-255><a id=__codelineno-0-255 name=__codelineno-0-255></a><span class=sd>        ... )</span>
</span><span id=__span-0-256><a id=__codelineno-0-256 name=__codelineno-0-256></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {processor.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-257><a id=__codelineno-0-257 name=__codelineno-0-257></a><span class=sd>        MoS enabled: False</span>
</span><span id=__span-0-258><a id=__codelineno-0-258 name=__codelineno-0-258></a>
</span><span id=__span-0-259><a id=__codelineno-0-259 name=__codelineno-0-259></a><span class=sd>        &gt;&gt;&gt; # High-entropy MoS configuration</span>
</span><span id=__span-0-260><a id=__codelineno-0-260 name=__codelineno-0-260></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-261><a id=__codelineno-0-261 name=__codelineno-0-261></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-262><a id=__codelineno-0-262 name=__codelineno-0-262></a><span class=sd>        ...     n_readers=100,</span>
</span><span id=__span-0-263><a id=__codelineno-0-263 name=__codelineno-0-263></a><span class=sd>        ...     n_scanners=16</span>
</span><span id=__span-0-264><a id=__codelineno-0-264 name=__codelineno-0-264></a><span class=sd>        ... )</span>
</span><span id=__span-0-265><a id=__codelineno-0-265 name=__codelineno-0-265></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS readers: {processor.n_readers}, scanners: {processor.n_scanners}&quot;)</span>
</span><span id=__span-0-266><a id=__codelineno-0-266 name=__codelineno-0-266></a><span class=sd>        MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-267><a id=__codelineno-0-267 name=__codelineno-0-267></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-268><a id=__codelineno-0-268 name=__codelineno-0-268></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>TILEDB_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-269><a id=__codelineno-0-269 name=__codelineno-0-269></a>        <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span><span class=s2>&quot;TileDB SOMA is required but not available&quot;</span><span class=p>)</span>
</span><span id=__span-0-270><a id=__codelineno-0-270 name=__codelineno-0-270></a>
</span><span id=__span-0-271><a id=__codelineno-0-271 name=__codelineno-0-271></a>    <span class=bp>self</span><span class=o>.</span><span class=n>tiledb_path</span> <span class=o>=</span> <span class=n>tiledb_path</span>
</span><span id=__span-0-272><a id=__codelineno-0-272 name=__codelineno-0-272></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-273><a id=__codelineno-0-273 name=__codelineno-0-273></a>    <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=n>prefetch_batch_size</span>
</span><span id=__span-0-274><a id=__codelineno-0-274 name=__codelineno-0-274></a>    <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>=</span> <span class=n>seed</span>
</span><span id=__span-0-275><a id=__codelineno-0-275 name=__codelineno-0-275></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-276><a id=__codelineno-0-276 name=__codelineno-0-276></a>    <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span><span id=__span-0-277><a id=__codelineno-0-277 name=__codelineno-0-277></a>    <span class=bp>self</span><span class=o>.</span><span class=n>log_metrics</span> <span class=o>=</span> <span class=n>log_metrics</span>
</span><span id=__span-0-278><a id=__codelineno-0-278 name=__codelineno-0-278></a>    <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>
</span><span id=__span-0-279><a id=__codelineno-0-279 name=__codelineno-0-279></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>=</span> <span class=n>n_readers</span>
</span><span id=__span-0-280><a id=__codelineno-0-280 name=__codelineno-0-280></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>
</span><span id=__span-0-281><a id=__codelineno-0-281 name=__codelineno-0-281></a>
</span><span id=__span-0-282><a id=__codelineno-0-282 name=__codelineno-0-282></a>    <span class=c1># Validate MoS parameters</span>
</span><span id=__span-0-283><a id=__codelineno-0-283 name=__codelineno-0-283></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-284><a id=__codelineno-0-284 name=__codelineno-0-284></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-285><a id=__codelineno-0-285 name=__codelineno-0-285></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_readers must be at least 1&quot;</span><span class=p>)</span>
</span><span id=__span-0-286><a id=__codelineno-0-286 name=__codelineno-0-286></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-287><a id=__codelineno-0-287 name=__codelineno-0-287></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners must be at least 1&quot;</span><span class=p>)</span>
</span><span id=__span-0-288><a id=__codelineno-0-288 name=__codelineno-0-288></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span><span class=p>:</span>
</span><span id=__span-0-289><a id=__codelineno-0-289 name=__codelineno-0-289></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;n_scanners cannot exceed n_readers&quot;</span><span class=p>)</span>
</span><span id=__span-0-290><a id=__codelineno-0-290 name=__codelineno-0-290></a>
</span><span id=__span-0-291><a id=__codelineno-0-291 name=__codelineno-0-291></a>    <span class=c1># Initialize state</span>
</span><span id=__span-0-292><a id=__codelineno-0-292 name=__codelineno-0-292></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-293><a id=__codelineno-0-293 name=__codelineno-0-293></a>    <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-294><a id=__codelineno-0-294 name=__codelineno-0-294></a>    <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-295><a id=__codelineno-0-295 name=__codelineno-0-295></a>
</span><span id=__span-0-296><a id=__codelineno-0-296 name=__codelineno-0-296></a>    <span class=c1># Open TileDB experiment</span>
</span><span id=__span-0-297><a id=__codelineno-0-297 name=__codelineno-0-297></a>    <span class=bp>self</span><span class=o>.</span><span class=n>experiment</span> <span class=o>=</span> <span class=n>tiledbsoma</span><span class=o>.</span><span class=n>Experiment</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>tiledb_path</span><span class=p>)</span>
</span><span id=__span-0-298><a id=__codelineno-0-298 name=__codelineno-0-298></a>    <span class=bp>self</span><span class=o>.</span><span class=n>X</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>experiment</span><span class=o>.</span><span class=n>ms</span><span class=p>[</span><span class=s2>&quot;RNA&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>X</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span>
</span><span id=__span-0-299><a id=__codelineno-0-299 name=__codelineno-0-299></a>
</span><span id=__span-0-300><a id=__codelineno-0-300 name=__codelineno-0-300></a>    <span class=c1># Get total number of cells</span>
</span><span id=__span-0-301><a id=__codelineno-0-301 name=__codelineno-0-301></a>    <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-0-302><a id=__codelineno-0-302 name=__codelineno-0-302></a>
</span><span id=__span-0-303><a id=__codelineno-0-303 name=__codelineno-0-303></a>    <span class=c1># Initialize shuffling strategy (similar to SLAF)</span>
</span><span id=__span-0-304><a id=__codelineno-0-304 name=__codelineno-0-304></a>    <span class=kn>from</span><span class=w> </span><span class=nn>slaf.ml.samplers</span><span class=w> </span><span class=kn>import</span> <span class=n>ShuffleType</span><span class=p>,</span> <span class=n>create_shuffle</span>
</span><span id=__span-0-305><a id=__codelineno-0-305 name=__codelineno-0-305></a>
</span><span id=__span-0-306><a id=__codelineno-0-306 name=__codelineno-0-306></a>    <span class=bp>self</span><span class=o>.</span><span class=n>shuffle</span> <span class=o>=</span> <span class=n>create_shuffle</span><span class=p>(</span><span class=n>ShuffleType</span><span class=o>.</span><span class=n>RANDOM</span><span class=p>)</span>
</span><span id=__span-0-307><a id=__codelineno-0-307 name=__codelineno-0-307></a>
</span><span id=__span-0-308><a id=__codelineno-0-308 name=__codelineno-0-308></a>    <span class=c1># Initialize MoS generators if enabled</span>
</span><span id=__span-0-309><a id=__codelineno-0-309 name=__codelineno-0-309></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-310><a id=__codelineno-0-310 name=__codelineno-0-310></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_initialize_mos_generators</span><span class=p>()</span>
</span><span id=__span-0-311><a id=__codelineno-0-311 name=__codelineno-0-311></a>
</span><span id=__span-0-312><a id=__codelineno-0-312 name=__codelineno-0-312></a>    <span class=c1># Initialize timing metrics for benchmarking</span>
</span><span id=__span-0-313><a id=__codelineno-0-313 name=__codelineno-0-313></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span>
</span><span id=__span-0-314><a id=__codelineno-0-314 name=__codelineno-0-314></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>log_metrics</span><span class=p>:</span>
</span><span id=__span-0-315><a id=__codelineno-0-315 name=__codelineno-0-315></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-316><a id=__codelineno-0-316 name=__codelineno-0-316></a>            <span class=s2>&quot;tiledb_loading&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-317><a id=__codelineno-0-317 name=__codelineno-0-317></a>            <span class=s2>&quot;shuffle&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-318><a id=__codelineno-0-318 name=__codelineno-0-318></a>            <span class=s2>&quot;total&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-319><a id=__codelineno-0-319 name=__codelineno-0-319></a>            <span class=s2>&quot;cells_processed&quot;</span><span class=p>:</span> <span class=p>[],</span>
</span><span id=__span-0-320><a id=__codelineno-0-320 name=__codelineno-0-320></a>        <span class=p>}</span>
</span><span id=__span-0-321><a id=__codelineno-0-321 name=__codelineno-0-321></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-322><a id=__codelineno-0-322 name=__codelineno-0-322></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_timing_metrics</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-323><a id=__codelineno-0-323 name=__codelineno-0-323></a>
</span><span id=__span-0-324><a id=__codelineno-0-324 name=__codelineno-0-324></a>    <span class=c1># Initialize timing variables for consolidated reporting</span>
</span><span id=__span-0-325><a id=__codelineno-0-325 name=__codelineno-0-325></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_last_load_time</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-0-326><a id=__codelineno-0-326 name=__codelineno-0-326></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span> <span class=o>=</span> <span class=mf>0.0</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.reset_for_epoch class="doc doc-heading"> <code class="highlight language-python"><span class=n>reset_for_epoch</span><span class=p>(</span><span class=n>epoch</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.reset_for_epoch class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Reset the processor for a new epoch.</p> <p>This method resets the batch processor state to start a new epoch, including resetting batch counters, MoS generator positions, and shuffling seeds. It is called automatically during multi-epoch training.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>epoch</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>The epoch number to start (0-based indexing). Must be 0 &lt;= epoch &lt; n_epochs.</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If epoch is invalid (negative or &gt;= n_epochs).</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Reset for epoch 1</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span> <span class=n>n_epochs</span><span class=o>=</span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span><span class=o>.</span><span class=n>reset_for_epoch</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Current epoch: </span><span class=si>{</span><span class=n>processor</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=go>Current epoch: 1</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Invalid epoch raises error</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>processor</span><span class=o>.</span><span class=n>reset_for_epoch</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>  <span class=c1># n_epochs=3</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span><span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Error: Invalid epoch 5. Must be 0 &lt;= epoch &lt; 3</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-360>360</a></span>
<span class=normal><a href=#__codelineno-0-361>361</a></span>
<span class=normal><a href=#__codelineno-0-362>362</a></span>
<span class=normal><a href=#__codelineno-0-363>363</a></span>
<span class=normal><a href=#__codelineno-0-364>364</a></span>
<span class=normal><a href=#__codelineno-0-365>365</a></span>
<span class=normal><a href=#__codelineno-0-366>366</a></span>
<span class=normal><a href=#__codelineno-0-367>367</a></span>
<span class=normal><a href=#__codelineno-0-368>368</a></span>
<span class=normal><a href=#__codelineno-0-369>369</a></span>
<span class=normal><a href=#__codelineno-0-370>370</a></span>
<span class=normal><a href=#__codelineno-0-371>371</a></span>
<span class=normal><a href=#__codelineno-0-372>372</a></span>
<span class=normal><a href=#__codelineno-0-373>373</a></span>
<span class=normal><a href=#__codelineno-0-374>374</a></span>
<span class=normal><a href=#__codelineno-0-375>375</a></span>
<span class=normal><a href=#__codelineno-0-376>376</a></span>
<span class=normal><a href=#__codelineno-0-377>377</a></span>
<span class=normal><a href=#__codelineno-0-378>378</a></span>
<span class=normal><a href=#__codelineno-0-379>379</a></span>
<span class=normal><a href=#__codelineno-0-380>380</a></span>
<span class=normal><a href=#__codelineno-0-381>381</a></span>
<span class=normal><a href=#__codelineno-0-382>382</a></span>
<span class=normal><a href=#__codelineno-0-383>383</a></span>
<span class=normal><a href=#__codelineno-0-384>384</a></span>
<span class=normal><a href=#__codelineno-0-385>385</a></span>
<span class=normal><a href=#__codelineno-0-386>386</a></span>
<span class=normal><a href=#__codelineno-0-387>387</a></span>
<span class=normal><a href=#__codelineno-0-388>388</a></span>
<span class=normal><a href=#__codelineno-0-389>389</a></span>
<span class=normal><a href=#__codelineno-0-390>390</a></span>
<span class=normal><a href=#__codelineno-0-391>391</a></span>
<span class=normal><a href=#__codelineno-0-392>392</a></span>
<span class=normal><a href=#__codelineno-0-393>393</a></span>
<span class=normal><a href=#__codelineno-0-394>394</a></span>
<span class=normal><a href=#__codelineno-0-395>395</a></span>
<span class=normal><a href=#__codelineno-0-396>396</a></span>
<span class=normal><a href=#__codelineno-0-397>397</a></span>
<span class=normal><a href=#__codelineno-0-398>398</a></span>
<span class=normal><a href=#__codelineno-0-399>399</a></span>
<span class=normal><a href=#__codelineno-0-400>400</a></span>
<span class=normal><a href=#__codelineno-0-401>401</a></span>
<span class=normal><a href=#__codelineno-0-402>402</a></span>
<span class=normal><a href=#__codelineno-0-403>403</a></span>
<span class=normal><a href=#__codelineno-0-404>404</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-360><a id=__codelineno-0-360 name=__codelineno-0-360></a><span class=k>def</span><span class=w> </span><span class=nf>reset_for_epoch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>epoch</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-361><a id=__codelineno-0-361 name=__codelineno-0-361></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-362><a id=__codelineno-0-362 name=__codelineno-0-362></a><span class=sd>    Reset the processor for a new epoch.</span>
</span><span id=__span-0-363><a id=__codelineno-0-363 name=__codelineno-0-363></a>
</span><span id=__span-0-364><a id=__codelineno-0-364 name=__codelineno-0-364></a><span class=sd>    This method resets the batch processor state to start a new epoch,</span>
</span><span id=__span-0-365><a id=__codelineno-0-365 name=__codelineno-0-365></a><span class=sd>    including resetting batch counters, MoS generator positions, and</span>
</span><span id=__span-0-366><a id=__codelineno-0-366 name=__codelineno-0-366></a><span class=sd>    shuffling seeds. It is called automatically during multi-epoch training.</span>
</span><span id=__span-0-367><a id=__codelineno-0-367 name=__codelineno-0-367></a>
</span><span id=__span-0-368><a id=__codelineno-0-368 name=__codelineno-0-368></a><span class=sd>    Args:</span>
</span><span id=__span-0-369><a id=__codelineno-0-369 name=__codelineno-0-369></a><span class=sd>        epoch: The epoch number to start (0-based indexing).</span>
</span><span id=__span-0-370><a id=__codelineno-0-370 name=__codelineno-0-370></a><span class=sd>              Must be 0 &lt;= epoch &lt; n_epochs.</span>
</span><span id=__span-0-371><a id=__codelineno-0-371 name=__codelineno-0-371></a>
</span><span id=__span-0-372><a id=__codelineno-0-372 name=__codelineno-0-372></a><span class=sd>    Raises:</span>
</span><span id=__span-0-373><a id=__codelineno-0-373 name=__codelineno-0-373></a><span class=sd>        ValueError: If epoch is invalid (negative or &gt;= n_epochs).</span>
</span><span id=__span-0-374><a id=__codelineno-0-374 name=__codelineno-0-374></a>
</span><span id=__span-0-375><a id=__codelineno-0-375 name=__codelineno-0-375></a><span class=sd>    Examples:</span>
</span><span id=__span-0-376><a id=__codelineno-0-376 name=__codelineno-0-376></a><span class=sd>        &gt;&gt;&gt; # Reset for epoch 1</span>
</span><span id=__span-0-377><a id=__codelineno-0-377 name=__codelineno-0-377></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;, n_epochs=3)</span>
</span><span id=__span-0-378><a id=__codelineno-0-378 name=__codelineno-0-378></a><span class=sd>        &gt;&gt;&gt; processor.reset_for_epoch(1)</span>
</span><span id=__span-0-379><a id=__codelineno-0-379 name=__codelineno-0-379></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Current epoch: {processor.current_epoch}&quot;)</span>
</span><span id=__span-0-380><a id=__codelineno-0-380 name=__codelineno-0-380></a><span class=sd>        Current epoch: 1</span>
</span><span id=__span-0-381><a id=__codelineno-0-381 name=__codelineno-0-381></a>
</span><span id=__span-0-382><a id=__codelineno-0-382 name=__codelineno-0-382></a><span class=sd>        &gt;&gt;&gt; # Invalid epoch raises error</span>
</span><span id=__span-0-383><a id=__codelineno-0-383 name=__codelineno-0-383></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-384><a id=__codelineno-0-384 name=__codelineno-0-384></a><span class=sd>        ...     processor.reset_for_epoch(5)  # n_epochs=3</span>
</span><span id=__span-0-385><a id=__codelineno-0-385 name=__codelineno-0-385></a><span class=sd>        ... except ValueError as e:</span>
</span><span id=__span-0-386><a id=__codelineno-0-386 name=__codelineno-0-386></a><span class=sd>        ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-387><a id=__codelineno-0-387 name=__codelineno-0-387></a><span class=sd>        Error: Invalid epoch 5. Must be 0 &lt;= epoch &lt; 3</span>
</span><span id=__span-0-388><a id=__codelineno-0-388 name=__codelineno-0-388></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-389><a id=__codelineno-0-389 name=__codelineno-0-389></a>    <span class=k>if</span> <span class=n>epoch</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=ow>or</span> <span class=n>epoch</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>:</span>
</span><span id=__span-0-390><a id=__codelineno-0-390 name=__codelineno-0-390></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-0-391><a id=__codelineno-0-391 name=__codelineno-0-391></a>            <span class=sa>f</span><span class=s2>&quot;Invalid epoch </span><span class=si>{</span><span class=n>epoch</span><span class=si>}</span><span class=s2>. Must be 0 &lt;= epoch &lt; </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-392><a id=__codelineno-0-392 name=__codelineno-0-392></a>        <span class=p>)</span>
</span><span id=__span-0-393><a id=__codelineno-0-393 name=__codelineno-0-393></a>
</span><span id=__span-0-394><a id=__codelineno-0-394 name=__codelineno-0-394></a>    <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=n>epoch</span>
</span><span id=__span-0-395><a id=__codelineno-0-395 name=__codelineno-0-395></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-396><a id=__codelineno-0-396 name=__codelineno-0-396></a>
</span><span id=__span-0-397><a id=__codelineno-0-397 name=__codelineno-0-397></a>    <span class=c1># Reset MoS generators if enabled</span>
</span><span id=__span-0-398><a id=__codelineno-0-398 name=__codelineno-0-398></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-399><a id=__codelineno-0-399 name=__codelineno-0-399></a>        <span class=k>for</span> <span class=n>generator</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>generators</span><span class=p>:</span>
</span><span id=__span-0-400><a id=__codelineno-0-400 name=__codelineno-0-400></a>            <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;start_position&quot;</span><span class=p>]</span>
</span><span id=__span-0-401><a id=__codelineno-0-401 name=__codelineno-0-401></a>            <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-402><a id=__codelineno-0-402 name=__codelineno-0-402></a>
</span><span id=__span-0-403><a id=__codelineno-0-403 name=__codelineno-0-403></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-404><a id=__codelineno-0-404 name=__codelineno-0-404></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot; Reset TileDB processor for epoch </span><span class=si>{</span><span class=n>epoch</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.load_prefetch_batch class="doc doc-heading"> <code class="highlight language-python"><span class=n>load_prefetch_batch</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>TileDBPrefetchBatch</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor.load_prefetch_batch class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Load and process a chunk of TileDB data into batches using configured strategy.</p> <p>This method loads a batch of data from TileDB SOMA format, applies shuffling, and returns a processed batch ready for training. It supports both MoS and sequential loading strategies and handles epoch transitions automatically.</p> <p>The method performs the following steps: 1. Load data from TileDB using the configured strategy (MoS or sequential) 2. Convert Arrow data to Polars DataFrame 3. Apply shuffling strategy for data randomization 4. Return processed batch with metadata</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>TileDBPrefetchBatch</code></td> <td> <code><a class="autorefs autorefs-internal" title="TileDBPrefetchBatch


  
      dataclass
   (slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch)" href=#slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch>TileDBPrefetchBatch</a></code> </td> <td> <div class=doc-md-description> <p>Processed batch containing: - batch_df: Polars DataFrame with cell-gene expression data - cell_integer_ids: List of unique cell IDs in the batch - process_time: Time taken to process the batch - memory_mb: Memory usage at batch creation time</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=StopIteration>StopIteration</span></code> </td> <td> <div class=doc-md-description> <p>When all epochs are completed and no more data is available.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=RuntimeError>RuntimeError</span></code> </td> <td> <div class=doc-md-description> <p>If TileDB data loading fails.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Load a batch with MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>load_prefetch_batch</span><span class=p>()</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2> has </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>cell_integer_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> cells&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Batch 0 has 100 cells</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Load a batch with sequential strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>load_prefetch_batch</span><span class=p>()</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sequential batch shape: </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_df</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Sequential batch shape: (100, 3)</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Handle epoch completion</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span> <span class=n>n_epochs</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>        <span class=n>batch</span> <span class=o>=</span> <span class=n>processor</span><span class=o>.</span><span class=n>load_prefetch_batch</span><span class=p>()</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Processed batch </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span><span class=k>except</span> <span class=ne>StopIteration</span><span class=p>:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;All epochs completed&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>All epochs completed</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-417>417</a></span>
<span class=normal><a href=#__codelineno-0-418>418</a></span>
<span class=normal><a href=#__codelineno-0-419>419</a></span>
<span class=normal><a href=#__codelineno-0-420>420</a></span>
<span class=normal><a href=#__codelineno-0-421>421</a></span>
<span class=normal><a href=#__codelineno-0-422>422</a></span>
<span class=normal><a href=#__codelineno-0-423>423</a></span>
<span class=normal><a href=#__codelineno-0-424>424</a></span>
<span class=normal><a href=#__codelineno-0-425>425</a></span>
<span class=normal><a href=#__codelineno-0-426>426</a></span>
<span class=normal><a href=#__codelineno-0-427>427</a></span>
<span class=normal><a href=#__codelineno-0-428>428</a></span>
<span class=normal><a href=#__codelineno-0-429>429</a></span>
<span class=normal><a href=#__codelineno-0-430>430</a></span>
<span class=normal><a href=#__codelineno-0-431>431</a></span>
<span class=normal><a href=#__codelineno-0-432>432</a></span>
<span class=normal><a href=#__codelineno-0-433>433</a></span>
<span class=normal><a href=#__codelineno-0-434>434</a></span>
<span class=normal><a href=#__codelineno-0-435>435</a></span>
<span class=normal><a href=#__codelineno-0-436>436</a></span>
<span class=normal><a href=#__codelineno-0-437>437</a></span>
<span class=normal><a href=#__codelineno-0-438>438</a></span>
<span class=normal><a href=#__codelineno-0-439>439</a></span>
<span class=normal><a href=#__codelineno-0-440>440</a></span>
<span class=normal><a href=#__codelineno-0-441>441</a></span>
<span class=normal><a href=#__codelineno-0-442>442</a></span>
<span class=normal><a href=#__codelineno-0-443>443</a></span>
<span class=normal><a href=#__codelineno-0-444>444</a></span>
<span class=normal><a href=#__codelineno-0-445>445</a></span>
<span class=normal><a href=#__codelineno-0-446>446</a></span>
<span class=normal><a href=#__codelineno-0-447>447</a></span>
<span class=normal><a href=#__codelineno-0-448>448</a></span>
<span class=normal><a href=#__codelineno-0-449>449</a></span>
<span class=normal><a href=#__codelineno-0-450>450</a></span>
<span class=normal><a href=#__codelineno-0-451>451</a></span>
<span class=normal><a href=#__codelineno-0-452>452</a></span>
<span class=normal><a href=#__codelineno-0-453>453</a></span>
<span class=normal><a href=#__codelineno-0-454>454</a></span>
<span class=normal><a href=#__codelineno-0-455>455</a></span>
<span class=normal><a href=#__codelineno-0-456>456</a></span>
<span class=normal><a href=#__codelineno-0-457>457</a></span>
<span class=normal><a href=#__codelineno-0-458>458</a></span>
<span class=normal><a href=#__codelineno-0-459>459</a></span>
<span class=normal><a href=#__codelineno-0-460>460</a></span>
<span class=normal><a href=#__codelineno-0-461>461</a></span>
<span class=normal><a href=#__codelineno-0-462>462</a></span>
<span class=normal><a href=#__codelineno-0-463>463</a></span>
<span class=normal><a href=#__codelineno-0-464>464</a></span>
<span class=normal><a href=#__codelineno-0-465>465</a></span>
<span class=normal><a href=#__codelineno-0-466>466</a></span>
<span class=normal><a href=#__codelineno-0-467>467</a></span>
<span class=normal><a href=#__codelineno-0-468>468</a></span>
<span class=normal><a href=#__codelineno-0-469>469</a></span>
<span class=normal><a href=#__codelineno-0-470>470</a></span>
<span class=normal><a href=#__codelineno-0-471>471</a></span>
<span class=normal><a href=#__codelineno-0-472>472</a></span>
<span class=normal><a href=#__codelineno-0-473>473</a></span>
<span class=normal><a href=#__codelineno-0-474>474</a></span>
<span class=normal><a href=#__codelineno-0-475>475</a></span>
<span class=normal><a href=#__codelineno-0-476>476</a></span>
<span class=normal><a href=#__codelineno-0-477>477</a></span>
<span class=normal><a href=#__codelineno-0-478>478</a></span>
<span class=normal><a href=#__codelineno-0-479>479</a></span>
<span class=normal><a href=#__codelineno-0-480>480</a></span>
<span class=normal><a href=#__codelineno-0-481>481</a></span>
<span class=normal><a href=#__codelineno-0-482>482</a></span>
<span class=normal><a href=#__codelineno-0-483>483</a></span>
<span class=normal><a href=#__codelineno-0-484>484</a></span>
<span class=normal><a href=#__codelineno-0-485>485</a></span>
<span class=normal><a href=#__codelineno-0-486>486</a></span>
<span class=normal><a href=#__codelineno-0-487>487</a></span>
<span class=normal><a href=#__codelineno-0-488>488</a></span>
<span class=normal><a href=#__codelineno-0-489>489</a></span>
<span class=normal><a href=#__codelineno-0-490>490</a></span>
<span class=normal><a href=#__codelineno-0-491>491</a></span>
<span class=normal><a href=#__codelineno-0-492>492</a></span>
<span class=normal><a href=#__codelineno-0-493>493</a></span>
<span class=normal><a href=#__codelineno-0-494>494</a></span>
<span class=normal><a href=#__codelineno-0-495>495</a></span>
<span class=normal><a href=#__codelineno-0-496>496</a></span>
<span class=normal><a href=#__codelineno-0-497>497</a></span>
<span class=normal><a href=#__codelineno-0-498>498</a></span>
<span class=normal><a href=#__codelineno-0-499>499</a></span>
<span class=normal><a href=#__codelineno-0-500>500</a></span>
<span class=normal><a href=#__codelineno-0-501>501</a></span>
<span class=normal><a href=#__codelineno-0-502>502</a></span>
<span class=normal><a href=#__codelineno-0-503>503</a></span>
<span class=normal><a href=#__codelineno-0-504>504</a></span>
<span class=normal><a href=#__codelineno-0-505>505</a></span>
<span class=normal><a href=#__codelineno-0-506>506</a></span>
<span class=normal><a href=#__codelineno-0-507>507</a></span>
<span class=normal><a href=#__codelineno-0-508>508</a></span>
<span class=normal><a href=#__codelineno-0-509>509</a></span>
<span class=normal><a href=#__codelineno-0-510>510</a></span>
<span class=normal><a href=#__codelineno-0-511>511</a></span>
<span class=normal><a href=#__codelineno-0-512>512</a></span>
<span class=normal><a href=#__codelineno-0-513>513</a></span>
<span class=normal><a href=#__codelineno-0-514>514</a></span>
<span class=normal><a href=#__codelineno-0-515>515</a></span>
<span class=normal><a href=#__codelineno-0-516>516</a></span>
<span class=normal><a href=#__codelineno-0-517>517</a></span>
<span class=normal><a href=#__codelineno-0-518>518</a></span>
<span class=normal><a href=#__codelineno-0-519>519</a></span>
<span class=normal><a href=#__codelineno-0-520>520</a></span>
<span class=normal><a href=#__codelineno-0-521>521</a></span>
<span class=normal><a href=#__codelineno-0-522>522</a></span>
<span class=normal><a href=#__codelineno-0-523>523</a></span>
<span class=normal><a href=#__codelineno-0-524>524</a></span>
<span class=normal><a href=#__codelineno-0-525>525</a></span>
<span class=normal><a href=#__codelineno-0-526>526</a></span>
<span class=normal><a href=#__codelineno-0-527>527</a></span>
<span class=normal><a href=#__codelineno-0-528>528</a></span>
<span class=normal><a href=#__codelineno-0-529>529</a></span>
<span class=normal><a href=#__codelineno-0-530>530</a></span>
<span class=normal><a href=#__codelineno-0-531>531</a></span>
<span class=normal><a href=#__codelineno-0-532>532</a></span>
<span class=normal><a href=#__codelineno-0-533>533</a></span>
<span class=normal><a href=#__codelineno-0-534>534</a></span>
<span class=normal><a href=#__codelineno-0-535>535</a></span>
<span class=normal><a href=#__codelineno-0-536>536</a></span>
<span class=normal><a href=#__codelineno-0-537>537</a></span>
<span class=normal><a href=#__codelineno-0-538>538</a></span>
<span class=normal><a href=#__codelineno-0-539>539</a></span>
<span class=normal><a href=#__codelineno-0-540>540</a></span>
<span class=normal><a href=#__codelineno-0-541>541</a></span>
<span class=normal><a href=#__codelineno-0-542>542</a></span>
<span class=normal><a href=#__codelineno-0-543>543</a></span>
<span class=normal><a href=#__codelineno-0-544>544</a></span>
<span class=normal><a href=#__codelineno-0-545>545</a></span>
<span class=normal><a href=#__codelineno-0-546>546</a></span>
<span class=normal><a href=#__codelineno-0-547>547</a></span>
<span class=normal><a href=#__codelineno-0-548>548</a></span>
<span class=normal><a href=#__codelineno-0-549>549</a></span>
<span class=normal><a href=#__codelineno-0-550>550</a></span>
<span class=normal><a href=#__codelineno-0-551>551</a></span>
<span class=normal><a href=#__codelineno-0-552>552</a></span>
<span class=normal><a href=#__codelineno-0-553>553</a></span>
<span class=normal><a href=#__codelineno-0-554>554</a></span>
<span class=normal><a href=#__codelineno-0-555>555</a></span>
<span class=normal><a href=#__codelineno-0-556>556</a></span>
<span class=normal><a href=#__codelineno-0-557>557</a></span>
<span class=normal><a href=#__codelineno-0-558>558</a></span>
<span class=normal><a href=#__codelineno-0-559>559</a></span>
<span class=normal><a href=#__codelineno-0-560>560</a></span>
<span class=normal><a href=#__codelineno-0-561>561</a></span>
<span class=normal><a href=#__codelineno-0-562>562</a></span>
<span class=normal><a href=#__codelineno-0-563>563</a></span>
<span class=normal><a href=#__codelineno-0-564>564</a></span>
<span class=normal><a href=#__codelineno-0-565>565</a></span>
<span class=normal><a href=#__codelineno-0-566>566</a></span>
<span class=normal><a href=#__codelineno-0-567>567</a></span>
<span class=normal><a href=#__codelineno-0-568>568</a></span>
<span class=normal><a href=#__codelineno-0-569>569</a></span>
<span class=normal><a href=#__codelineno-0-570>570</a></span>
<span class=normal><a href=#__codelineno-0-571>571</a></span>
<span class=normal><a href=#__codelineno-0-572>572</a></span>
<span class=normal><a href=#__codelineno-0-573>573</a></span>
<span class=normal><a href=#__codelineno-0-574>574</a></span>
<span class=normal><a href=#__codelineno-0-575>575</a></span>
<span class=normal><a href=#__codelineno-0-576>576</a></span>
<span class=normal><a href=#__codelineno-0-577>577</a></span>
<span class=normal><a href=#__codelineno-0-578>578</a></span>
<span class=normal><a href=#__codelineno-0-579>579</a></span>
<span class=normal><a href=#__codelineno-0-580>580</a></span>
<span class=normal><a href=#__codelineno-0-581>581</a></span>
<span class=normal><a href=#__codelineno-0-582>582</a></span>
<span class=normal><a href=#__codelineno-0-583>583</a></span>
<span class=normal><a href=#__codelineno-0-584>584</a></span>
<span class=normal><a href=#__codelineno-0-585>585</a></span>
<span class=normal><a href=#__codelineno-0-586>586</a></span>
<span class=normal><a href=#__codelineno-0-587>587</a></span>
<span class=normal><a href=#__codelineno-0-588>588</a></span>
<span class=normal><a href=#__codelineno-0-589>589</a></span>
<span class=normal><a href=#__codelineno-0-590>590</a></span>
<span class=normal><a href=#__codelineno-0-591>591</a></span>
<span class=normal><a href=#__codelineno-0-592>592</a></span>
<span class=normal><a href=#__codelineno-0-593>593</a></span>
<span class=normal><a href=#__codelineno-0-594>594</a></span>
<span class=normal><a href=#__codelineno-0-595>595</a></span>
<span class=normal><a href=#__codelineno-0-596>596</a></span>
<span class=normal><a href=#__codelineno-0-597>597</a></span>
<span class=normal><a href=#__codelineno-0-598>598</a></span>
<span class=normal><a href=#__codelineno-0-599>599</a></span>
<span class=normal><a href=#__codelineno-0-600>600</a></span>
<span class=normal><a href=#__codelineno-0-601>601</a></span>
<span class=normal><a href=#__codelineno-0-602>602</a></span>
<span class=normal><a href=#__codelineno-0-603>603</a></span>
<span class=normal><a href=#__codelineno-0-604>604</a></span>
<span class=normal><a href=#__codelineno-0-605>605</a></span>
<span class=normal><a href=#__codelineno-0-606>606</a></span>
<span class=normal><a href=#__codelineno-0-607>607</a></span>
<span class=normal><a href=#__codelineno-0-608>608</a></span>
<span class=normal><a href=#__codelineno-0-609>609</a></span>
<span class=normal><a href=#__codelineno-0-610>610</a></span>
<span class=normal><a href=#__codelineno-0-611>611</a></span>
<span class=normal><a href=#__codelineno-0-612>612</a></span>
<span class=normal><a href=#__codelineno-0-613>613</a></span>
<span class=normal><a href=#__codelineno-0-614>614</a></span>
<span class=normal><a href=#__codelineno-0-615>615</a></span>
<span class=normal><a href=#__codelineno-0-616>616</a></span>
<span class=normal><a href=#__codelineno-0-617>617</a></span>
<span class=normal><a href=#__codelineno-0-618>618</a></span>
<span class=normal><a href=#__codelineno-0-619>619</a></span>
<span class=normal><a href=#__codelineno-0-620>620</a></span>
<span class=normal><a href=#__codelineno-0-621>621</a></span>
<span class=normal><a href=#__codelineno-0-622>622</a></span>
<span class=normal><a href=#__codelineno-0-623>623</a></span>
<span class=normal><a href=#__codelineno-0-624>624</a></span>
<span class=normal><a href=#__codelineno-0-625>625</a></span>
<span class=normal><a href=#__codelineno-0-626>626</a></span>
<span class=normal><a href=#__codelineno-0-627>627</a></span>
<span class=normal><a href=#__codelineno-0-628>628</a></span>
<span class=normal><a href=#__codelineno-0-629>629</a></span>
<span class=normal><a href=#__codelineno-0-630>630</a></span>
<span class=normal><a href=#__codelineno-0-631>631</a></span>
<span class=normal><a href=#__codelineno-0-632>632</a></span>
<span class=normal><a href=#__codelineno-0-633>633</a></span>
<span class=normal><a href=#__codelineno-0-634>634</a></span>
<span class=normal><a href=#__codelineno-0-635>635</a></span>
<span class=normal><a href=#__codelineno-0-636>636</a></span>
<span class=normal><a href=#__codelineno-0-637>637</a></span>
<span class=normal><a href=#__codelineno-0-638>638</a></span>
<span class=normal><a href=#__codelineno-0-639>639</a></span>
<span class=normal><a href=#__codelineno-0-640>640</a></span>
<span class=normal><a href=#__codelineno-0-641>641</a></span>
<span class=normal><a href=#__codelineno-0-642>642</a></span>
<span class=normal><a href=#__codelineno-0-643>643</a></span>
<span class=normal><a href=#__codelineno-0-644>644</a></span>
<span class=normal><a href=#__codelineno-0-645>645</a></span>
<span class=normal><a href=#__codelineno-0-646>646</a></span>
<span class=normal><a href=#__codelineno-0-647>647</a></span>
<span class=normal><a href=#__codelineno-0-648>648</a></span>
<span class=normal><a href=#__codelineno-0-649>649</a></span>
<span class=normal><a href=#__codelineno-0-650>650</a></span>
<span class=normal><a href=#__codelineno-0-651>651</a></span>
<span class=normal><a href=#__codelineno-0-652>652</a></span>
<span class=normal><a href=#__codelineno-0-653>653</a></span>
<span class=normal><a href=#__codelineno-0-654>654</a></span>
<span class=normal><a href=#__codelineno-0-655>655</a></span>
<span class=normal><a href=#__codelineno-0-656>656</a></span>
<span class=normal><a href=#__codelineno-0-657>657</a></span>
<span class=normal><a href=#__codelineno-0-658>658</a></span>
<span class=normal><a href=#__codelineno-0-659>659</a></span>
<span class=normal><a href=#__codelineno-0-660>660</a></span>
<span class=normal><a href=#__codelineno-0-661>661</a></span>
<span class=normal><a href=#__codelineno-0-662>662</a></span>
<span class=normal><a href=#__codelineno-0-663>663</a></span>
<span class=normal><a href=#__codelineno-0-664>664</a></span>
<span class=normal><a href=#__codelineno-0-665>665</a></span>
<span class=normal><a href=#__codelineno-0-666>666</a></span>
<span class=normal><a href=#__codelineno-0-667>667</a></span>
<span class=normal><a href=#__codelineno-0-668>668</a></span>
<span class=normal><a href=#__codelineno-0-669>669</a></span>
<span class=normal><a href=#__codelineno-0-670>670</a></span>
<span class=normal><a href=#__codelineno-0-671>671</a></span>
<span class=normal><a href=#__codelineno-0-672>672</a></span>
<span class=normal><a href=#__codelineno-0-673>673</a></span>
<span class=normal><a href=#__codelineno-0-674>674</a></span>
<span class=normal><a href=#__codelineno-0-675>675</a></span>
<span class=normal><a href=#__codelineno-0-676>676</a></span>
<span class=normal><a href=#__codelineno-0-677>677</a></span>
<span class=normal><a href=#__codelineno-0-678>678</a></span>
<span class=normal><a href=#__codelineno-0-679>679</a></span>
<span class=normal><a href=#__codelineno-0-680>680</a></span>
<span class=normal><a href=#__codelineno-0-681>681</a></span>
<span class=normal><a href=#__codelineno-0-682>682</a></span>
<span class=normal><a href=#__codelineno-0-683>683</a></span>
<span class=normal><a href=#__codelineno-0-684>684</a></span>
<span class=normal><a href=#__codelineno-0-685>685</a></span>
<span class=normal><a href=#__codelineno-0-686>686</a></span>
<span class=normal><a href=#__codelineno-0-687>687</a></span>
<span class=normal><a href=#__codelineno-0-688>688</a></span>
<span class=normal><a href=#__codelineno-0-689>689</a></span>
<span class=normal><a href=#__codelineno-0-690>690</a></span>
<span class=normal><a href=#__codelineno-0-691>691</a></span>
<span class=normal><a href=#__codelineno-0-692>692</a></span>
<span class=normal><a href=#__codelineno-0-693>693</a></span>
<span class=normal><a href=#__codelineno-0-694>694</a></span>
<span class=normal><a href=#__codelineno-0-695>695</a></span>
<span class=normal><a href=#__codelineno-0-696>696</a></span>
<span class=normal><a href=#__codelineno-0-697>697</a></span>
<span class=normal><a href=#__codelineno-0-698>698</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-417><a id=__codelineno-0-417 name=__codelineno-0-417></a><span class=k>def</span><span class=w> </span><span class=nf>load_prefetch_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>TileDBPrefetchBatch</span><span class=p>:</span>
</span><span id=__span-0-418><a id=__codelineno-0-418 name=__codelineno-0-418></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-419><a id=__codelineno-0-419 name=__codelineno-0-419></a><span class=sd>    Load and process a chunk of TileDB data into batches using configured strategy.</span>
</span><span id=__span-0-420><a id=__codelineno-0-420 name=__codelineno-0-420></a>
</span><span id=__span-0-421><a id=__codelineno-0-421 name=__codelineno-0-421></a><span class=sd>    This method loads a batch of data from TileDB SOMA format, applies shuffling,</span>
</span><span id=__span-0-422><a id=__codelineno-0-422 name=__codelineno-0-422></a><span class=sd>    and returns a processed batch ready for training. It supports both MoS and</span>
</span><span id=__span-0-423><a id=__codelineno-0-423 name=__codelineno-0-423></a><span class=sd>    sequential loading strategies and handles epoch transitions automatically.</span>
</span><span id=__span-0-424><a id=__codelineno-0-424 name=__codelineno-0-424></a>
</span><span id=__span-0-425><a id=__codelineno-0-425 name=__codelineno-0-425></a><span class=sd>    The method performs the following steps:</span>
</span><span id=__span-0-426><a id=__codelineno-0-426 name=__codelineno-0-426></a><span class=sd>    1. Load data from TileDB using the configured strategy (MoS or sequential)</span>
</span><span id=__span-0-427><a id=__codelineno-0-427 name=__codelineno-0-427></a><span class=sd>    2. Convert Arrow data to Polars DataFrame</span>
</span><span id=__span-0-428><a id=__codelineno-0-428 name=__codelineno-0-428></a><span class=sd>    3. Apply shuffling strategy for data randomization</span>
</span><span id=__span-0-429><a id=__codelineno-0-429 name=__codelineno-0-429></a><span class=sd>    4. Return processed batch with metadata</span>
</span><span id=__span-0-430><a id=__codelineno-0-430 name=__codelineno-0-430></a>
</span><span id=__span-0-431><a id=__codelineno-0-431 name=__codelineno-0-431></a><span class=sd>    Returns:</span>
</span><span id=__span-0-432><a id=__codelineno-0-432 name=__codelineno-0-432></a><span class=sd>        TileDBPrefetchBatch: Processed batch containing:</span>
</span><span id=__span-0-433><a id=__codelineno-0-433 name=__codelineno-0-433></a><span class=sd>            - batch_df: Polars DataFrame with cell-gene expression data</span>
</span><span id=__span-0-434><a id=__codelineno-0-434 name=__codelineno-0-434></a><span class=sd>            - cell_integer_ids: List of unique cell IDs in the batch</span>
</span><span id=__span-0-435><a id=__codelineno-0-435 name=__codelineno-0-435></a><span class=sd>            - process_time: Time taken to process the batch</span>
</span><span id=__span-0-436><a id=__codelineno-0-436 name=__codelineno-0-436></a><span class=sd>            - memory_mb: Memory usage at batch creation time</span>
</span><span id=__span-0-437><a id=__codelineno-0-437 name=__codelineno-0-437></a>
</span><span id=__span-0-438><a id=__codelineno-0-438 name=__codelineno-0-438></a><span class=sd>    Raises:</span>
</span><span id=__span-0-439><a id=__codelineno-0-439 name=__codelineno-0-439></a><span class=sd>        StopIteration: When all epochs are completed and no more data is available.</span>
</span><span id=__span-0-440><a id=__codelineno-0-440 name=__codelineno-0-440></a><span class=sd>        RuntimeError: If TileDB data loading fails.</span>
</span><span id=__span-0-441><a id=__codelineno-0-441 name=__codelineno-0-441></a>
</span><span id=__span-0-442><a id=__codelineno-0-442 name=__codelineno-0-442></a><span class=sd>    Examples:</span>
</span><span id=__span-0-443><a id=__codelineno-0-443 name=__codelineno-0-443></a><span class=sd>        &gt;&gt;&gt; # Load a batch with MoS strategy</span>
</span><span id=__span-0-444><a id=__codelineno-0-444 name=__codelineno-0-444></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-445><a id=__codelineno-0-445 name=__codelineno-0-445></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-446><a id=__codelineno-0-446 name=__codelineno-0-446></a><span class=sd>        ...     use_mixture_of_scanners=True</span>
</span><span id=__span-0-447><a id=__codelineno-0-447 name=__codelineno-0-447></a><span class=sd>        ... )</span>
</span><span id=__span-0-448><a id=__codelineno-0-448 name=__codelineno-0-448></a><span class=sd>        &gt;&gt;&gt; batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-449><a id=__codelineno-0-449 name=__codelineno-0-449></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Batch {batch.batch_id} has {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-450><a id=__codelineno-0-450 name=__codelineno-0-450></a><span class=sd>        Batch 0 has 100 cells</span>
</span><span id=__span-0-451><a id=__codelineno-0-451 name=__codelineno-0-451></a>
</span><span id=__span-0-452><a id=__codelineno-0-452 name=__codelineno-0-452></a><span class=sd>        &gt;&gt;&gt; # Load a batch with sequential strategy</span>
</span><span id=__span-0-453><a id=__codelineno-0-453 name=__codelineno-0-453></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(</span>
</span><span id=__span-0-454><a id=__codelineno-0-454 name=__codelineno-0-454></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-455><a id=__codelineno-0-455 name=__codelineno-0-455></a><span class=sd>        ...     use_mixture_of_scanners=False</span>
</span><span id=__span-0-456><a id=__codelineno-0-456 name=__codelineno-0-456></a><span class=sd>        ... )</span>
</span><span id=__span-0-457><a id=__codelineno-0-457 name=__codelineno-0-457></a><span class=sd>        &gt;&gt;&gt; batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-458><a id=__codelineno-0-458 name=__codelineno-0-458></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Sequential batch shape: {batch.batch_df.shape}&quot;)</span>
</span><span id=__span-0-459><a id=__codelineno-0-459 name=__codelineno-0-459></a><span class=sd>        Sequential batch shape: (100, 3)</span>
</span><span id=__span-0-460><a id=__codelineno-0-460 name=__codelineno-0-460></a>
</span><span id=__span-0-461><a id=__codelineno-0-461 name=__codelineno-0-461></a><span class=sd>        &gt;&gt;&gt; # Handle epoch completion</span>
</span><span id=__span-0-462><a id=__codelineno-0-462 name=__codelineno-0-462></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;, n_epochs=1)</span>
</span><span id=__span-0-463><a id=__codelineno-0-463 name=__codelineno-0-463></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-464><a id=__codelineno-0-464 name=__codelineno-0-464></a><span class=sd>        ...     while True:</span>
</span><span id=__span-0-465><a id=__codelineno-0-465 name=__codelineno-0-465></a><span class=sd>        ...         batch = processor.load_prefetch_batch()</span>
</span><span id=__span-0-466><a id=__codelineno-0-466 name=__codelineno-0-466></a><span class=sd>        ...         print(f&quot;Processed batch {batch.batch_id}&quot;)</span>
</span><span id=__span-0-467><a id=__codelineno-0-467 name=__codelineno-0-467></a><span class=sd>        ... except StopIteration:</span>
</span><span id=__span-0-468><a id=__codelineno-0-468 name=__codelineno-0-468></a><span class=sd>        ...     print(&quot;All epochs completed&quot;)</span>
</span><span id=__span-0-469><a id=__codelineno-0-469 name=__codelineno-0-469></a><span class=sd>        All epochs completed</span>
</span><span id=__span-0-470><a id=__codelineno-0-470 name=__codelineno-0-470></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-471><a id=__codelineno-0-471 name=__codelineno-0-471></a>    <span class=c1># Iterative approach to handle epoch transitions</span>
</span><span id=__span-0-472><a id=__codelineno-0-472 name=__codelineno-0-472></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-0-473><a id=__codelineno-0-473 name=__codelineno-0-473></a>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-474><a id=__codelineno-0-474 name=__codelineno-0-474></a>
</span><span id=__span-0-475><a id=__codelineno-0-475 name=__codelineno-0-475></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-476><a id=__codelineno-0-476 name=__codelineno-0-476></a>            <span class=c1># MoS approach: randomly sample from active generators</span>
</span><span id=__span-0-477><a id=__codelineno-0-477 name=__codelineno-0-477></a>            <span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-0-478><a id=__codelineno-0-478 name=__codelineno-0-478></a>
</span><span id=__span-0-479><a id=__codelineno-0-479 name=__codelineno-0-479></a>            <span class=c1># Get indices of currently active generators</span>
</span><span id=__span-0-480><a id=__codelineno-0-480 name=__codelineno-0-480></a>            <span class=n>active_generators</span> <span class=o>=</span> <span class=p>[</span><span class=n>g</span> <span class=k>for</span> <span class=n>g</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>generators</span> <span class=k>if</span> <span class=n>g</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]]</span>
</span><span id=__span-0-481><a id=__codelineno-0-481 name=__codelineno-0-481></a>
</span><span id=__span-0-482><a id=__codelineno-0-482 name=__codelineno-0-482></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>active_generators</span><span class=p>:</span>
</span><span id=__span-0-483><a id=__codelineno-0-483 name=__codelineno-0-483></a>                <span class=c1># Check if we should start a new epoch</span>
</span><span id=__span-0-484><a id=__codelineno-0-484 name=__codelineno-0-484></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>:</span>
</span><span id=__span-0-485><a id=__codelineno-0-485 name=__codelineno-0-485></a>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-486><a id=__codelineno-0-486 name=__codelineno-0-486></a>                        <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-487><a id=__codelineno-0-487 name=__codelineno-0-487></a>                            <span class=sa>f</span><span class=s2>&quot; Epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2> complete, starting epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-488><a id=__codelineno-0-488 name=__codelineno-0-488></a>                        <span class=p>)</span>
</span><span id=__span-0-489><a id=__codelineno-0-489 name=__codelineno-0-489></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>reset_for_epoch</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-490><a id=__codelineno-0-490 name=__codelineno-0-490></a>                    <span class=k>continue</span>
</span><span id=__span-0-491><a id=__codelineno-0-491 name=__codelineno-0-491></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-492><a id=__codelineno-0-492 name=__codelineno-0-492></a>                    <span class=k>raise</span> <span class=ne>StopIteration</span><span class=p>(</span><span class=s2>&quot;No more epochs available&quot;</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=kc>None</span>
</span><span id=__span-0-493><a id=__codelineno-0-493 name=__codelineno-0-493></a>
</span><span id=__span-0-494><a id=__codelineno-0-494 name=__codelineno-0-494></a>            <span class=c1># Randomly sample from active generators</span>
</span><span id=__span-0-495><a id=__codelineno-0-495 name=__codelineno-0-495></a>            <span class=n>n_to_sample</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>active_generators</span><span class=p>))</span>
</span><span id=__span-0-496><a id=__codelineno-0-496 name=__codelineno-0-496></a>            <span class=n>selected_generators</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>choice</span><span class=p>(</span>
</span><span id=__span-0-497><a id=__codelineno-0-497 name=__codelineno-0-497></a>                <span class=n>active_generators</span><span class=p>,</span> <span class=n>size</span><span class=o>=</span><span class=n>n_to_sample</span><span class=p>,</span> <span class=n>replace</span><span class=o>=</span><span class=kc>False</span>
</span><span id=__span-0-498><a id=__codelineno-0-498 name=__codelineno-0-498></a>            <span class=p>)</span>
</span><span id=__span-0-499><a id=__codelineno-0-499 name=__codelineno-0-499></a>
</span><span id=__span-0-500><a id=__codelineno-0-500 name=__codelineno-0-500></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-501><a id=__codelineno-0-501 name=__codelineno-0-501></a>                <span class=n>print_prefetch</span><span class=p>(</span>
</span><span id=__span-0-502><a id=__codelineno-0-502 name=__codelineno-0-502></a>                    <span class=sa>f</span><span class=s2>&quot;TileDB MoS sampling: </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>active_generators</span><span class=p>)</span><span class=si>}</span><span class=s2> active generators, &quot;</span>
</span><span id=__span-0-503><a id=__codelineno-0-503 name=__codelineno-0-503></a>                    <span class=sa>f</span><span class=s2>&quot;sampling from </span><span class=si>{</span><span class=n>n_to_sample</span><span class=si>}</span><span class=s2> generators&quot;</span><span class=p>,</span>
</span><span id=__span-0-504><a id=__codelineno-0-504 name=__codelineno-0-504></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-505><a id=__codelineno-0-505 name=__codelineno-0-505></a>                <span class=p>)</span>
</span><span id=__span-0-506><a id=__codelineno-0-506 name=__codelineno-0-506></a>
</span><span id=__span-0-507><a id=__codelineno-0-507 name=__codelineno-0-507></a>            <span class=c1># Load data from selected generators</span>
</span><span id=__span-0-508><a id=__codelineno-0-508 name=__codelineno-0-508></a>            <span class=n>load_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-509><a id=__codelineno-0-509 name=__codelineno-0-509></a>            <span class=n>batch_dfs</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-510><a id=__codelineno-0-510 name=__codelineno-0-510></a>
</span><span id=__span-0-511><a id=__codelineno-0-511 name=__codelineno-0-511></a>            <span class=k>for</span> <span class=n>generator</span> <span class=ow>in</span> <span class=n>selected_generators</span><span class=p>:</span>
</span><span id=__span-0-512><a id=__codelineno-0-512 name=__codelineno-0-512></a>                <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-513><a id=__codelineno-0-513 name=__codelineno-0-513></a>                    <span class=n>start_cell</span> <span class=o>=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span>
</span><span id=__span-0-514><a id=__codelineno-0-514 name=__codelineno-0-514></a>                    <span class=n>end_cell</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span>
</span><span id=__span-0-515><a id=__codelineno-0-515 name=__codelineno-0-515></a>                        <span class=n>start_cell</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-516><a id=__codelineno-0-516 name=__codelineno-0-516></a>                        <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;end_position&quot;</span><span class=p>],</span>
</span><span id=__span-0-517><a id=__codelineno-0-517 name=__codelineno-0-517></a>                    <span class=p>)</span>
</span><span id=__span-0-518><a id=__codelineno-0-518 name=__codelineno-0-518></a>
</span><span id=__span-0-519><a id=__codelineno-0-519 name=__codelineno-0-519></a>                    <span class=k>if</span> <span class=n>start_cell</span> <span class=o>&gt;=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;end_position&quot;</span><span class=p>]:</span>
</span><span id=__span-0-520><a id=__codelineno-0-520 name=__codelineno-0-520></a>                        <span class=c1># Generator exhausted</span>
</span><span id=__span-0-521><a id=__codelineno-0-521 name=__codelineno-0-521></a>                        <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-522><a id=__codelineno-0-522 name=__codelineno-0-522></a>                        <span class=k>continue</span>
</span><span id=__span-0-523><a id=__codelineno-0-523 name=__codelineno-0-523></a>
</span><span id=__span-0-524><a id=__codelineno-0-524 name=__codelineno-0-524></a>                    <span class=c1># Read slice from TileDB</span>
</span><span id=__span-0-525><a id=__codelineno-0-525 name=__codelineno-0-525></a>                    <span class=n>arrow_data</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-526><a id=__codelineno-0-526 name=__codelineno-0-526></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>read</span><span class=p>((</span><span class=nb>slice</span><span class=p>(</span><span class=n>start_cell</span><span class=p>,</span> <span class=n>end_cell</span><span class=p>),))</span>
</span><span id=__span-0-527><a id=__codelineno-0-527 name=__codelineno-0-527></a>                        <span class=o>.</span><span class=n>tables</span><span class=p>()</span>
</span><span id=__span-0-528><a id=__codelineno-0-528 name=__codelineno-0-528></a>                        <span class=o>.</span><span class=n>concat</span><span class=p>()</span>
</span><span id=__span-0-529><a id=__codelineno-0-529 name=__codelineno-0-529></a>                    <span class=p>)</span>
</span><span id=__span-0-530><a id=__codelineno-0-530 name=__codelineno-0-530></a>
</span><span id=__span-0-531><a id=__codelineno-0-531 name=__codelineno-0-531></a>                    <span class=c1># Convert Arrow table to Polars DataFrame</span>
</span><span id=__span-0-532><a id=__codelineno-0-532 name=__codelineno-0-532></a>                    <span class=n>df</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>from_arrow</span><span class=p>(</span><span class=n>arrow_data</span><span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-533><a id=__codelineno-0-533 name=__codelineno-0-533></a>                    <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>df</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span><span id=__span-0-534><a id=__codelineno-0-534 name=__codelineno-0-534></a>                        <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=s2>&quot;Expected DataFrame from Arrow table&quot;</span><span class=p>)</span>
</span><span id=__span-0-535><a id=__codelineno-0-535 name=__codelineno-0-535></a>
</span><span id=__span-0-536><a id=__codelineno-0-536 name=__codelineno-0-536></a>                    <span class=c1># Rename SOMA columns to expected names</span>
</span><span id=__span-0-537><a id=__codelineno-0-537 name=__codelineno-0-537></a>                    <span class=n>df</span> <span class=o>=</span> <span class=n>df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span>
</span><span id=__span-0-538><a id=__codelineno-0-538 name=__codelineno-0-538></a>                        <span class=p>{</span>
</span><span id=__span-0-539><a id=__codelineno-0-539 name=__codelineno-0-539></a>                            <span class=s2>&quot;soma_dim_0&quot;</span><span class=p>:</span> <span class=s2>&quot;cell_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-540><a id=__codelineno-0-540 name=__codelineno-0-540></a>                            <span class=s2>&quot;soma_dim_1&quot;</span><span class=p>:</span> <span class=s2>&quot;gene_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-541><a id=__codelineno-0-541 name=__codelineno-0-541></a>                            <span class=s2>&quot;soma_data&quot;</span><span class=p>:</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-0-542><a id=__codelineno-0-542 name=__codelineno-0-542></a>                        <span class=p>}</span>
</span><span id=__span-0-543><a id=__codelineno-0-543 name=__codelineno-0-543></a>                    <span class=p>)</span>
</span><span id=__span-0-544><a id=__codelineno-0-544 name=__codelineno-0-544></a>
</span><span id=__span-0-545><a id=__codelineno-0-545 name=__codelineno-0-545></a>                    <span class=n>batch_dfs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>df</span><span class=p>)</span>
</span><span id=__span-0-546><a id=__codelineno-0-546 name=__codelineno-0-546></a>
</span><span id=__span-0-547><a id=__codelineno-0-547 name=__codelineno-0-547></a>                    <span class=c1># Update generator position</span>
</span><span id=__span-0-548><a id=__codelineno-0-548 name=__codelineno-0-548></a>                    <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>end_cell</span>
</span><span id=__span-0-549><a id=__codelineno-0-549 name=__codelineno-0-549></a>
</span><span id=__span-0-550><a id=__codelineno-0-550 name=__codelineno-0-550></a>                    <span class=c1># Mark as inactive if exhausted</span>
</span><span id=__span-0-551><a id=__codelineno-0-551 name=__codelineno-0-551></a>                    <span class=k>if</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;current_position&quot;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;end_position&quot;</span><span class=p>]:</span>
</span><span id=__span-0-552><a id=__codelineno-0-552 name=__codelineno-0-552></a>                        <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-553><a id=__codelineno-0-553 name=__codelineno-0-553></a>
</span><span id=__span-0-554><a id=__codelineno-0-554 name=__codelineno-0-554></a>                <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-555><a id=__codelineno-0-555 name=__codelineno-0-555></a>                    <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
</span><span id=__span-0-556><a id=__codelineno-0-556 name=__codelineno-0-556></a>                        <span class=sa>f</span><span class=s2>&quot;Error loading TileDB data from generator </span><span class=si>{</span><span class=n>generator</span><span class=p>[</span><span class=s1>&#39;generator_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-557><a id=__codelineno-0-557 name=__codelineno-0-557></a>                    <span class=p>)</span>
</span><span id=__span-0-558><a id=__codelineno-0-558 name=__codelineno-0-558></a>                    <span class=n>generator</span><span class=p>[</span><span class=s2>&quot;is_active&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-559><a id=__codelineno-0-559 name=__codelineno-0-559></a>                    <span class=k>continue</span>
</span><span id=__span-0-560><a id=__codelineno-0-560 name=__codelineno-0-560></a>
</span><span id=__span-0-561><a id=__codelineno-0-561 name=__codelineno-0-561></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>batch_dfs</span><span class=p>:</span>
</span><span id=__span-0-562><a id=__codelineno-0-562 name=__codelineno-0-562></a>                <span class=c1># All selected generators are exhausted, continue to next iteration</span>
</span><span id=__span-0-563><a id=__codelineno-0-563 name=__codelineno-0-563></a>                <span class=k>continue</span>
</span><span id=__span-0-564><a id=__codelineno-0-564 name=__codelineno-0-564></a>
</span><span id=__span-0-565><a id=__codelineno-0-565 name=__codelineno-0-565></a>            <span class=c1># Combine all batches</span>
</span><span id=__span-0-566><a id=__codelineno-0-566 name=__codelineno-0-566></a>            <span class=n>combined_df_mos</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>concat</span><span class=p>(</span><span class=n>batch_dfs</span><span class=p>,</span> <span class=n>how</span><span class=o>=</span><span class=s2>&quot;vertical&quot;</span><span class=p>)</span>
</span><span id=__span-0-567><a id=__codelineno-0-567 name=__codelineno-0-567></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-568><a id=__codelineno-0-568 name=__codelineno-0-568></a>            <span class=c1># Sequential approach (original implementation)</span>
</span><span id=__span-0-569><a id=__codelineno-0-569 name=__codelineno-0-569></a>            <span class=n>current_position</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-570><a id=__codelineno-0-570 name=__codelineno-0-570></a>                <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span>
</span><span id=__span-0-571><a id=__codelineno-0-571 name=__codelineno-0-571></a>            <span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span>
</span><span id=__span-0-572><a id=__codelineno-0-572 name=__codelineno-0-572></a>
</span><span id=__span-0-573><a id=__codelineno-0-573 name=__codelineno-0-573></a>            <span class=c1># Only check for epoch transitions when we actually wrap around</span>
</span><span id=__span-0-574><a id=__codelineno-0-574 name=__codelineno-0-574></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-575><a id=__codelineno-0-575 name=__codelineno-0-575></a>                <span class=n>prev_position</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-576><a id=__codelineno-0-576 name=__codelineno-0-576></a>                    <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span>
</span><span id=__span-0-577><a id=__codelineno-0-577 name=__codelineno-0-577></a>                <span class=p>)</span> <span class=o>%</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells</span>
</span><span id=__span-0-578><a id=__codelineno-0-578 name=__codelineno-0-578></a>                <span class=k>if</span> <span class=n>current_position</span> <span class=o>&lt;</span> <span class=n>prev_position</span><span class=p>:</span>  <span class=c1># We wrapped around</span>
</span><span id=__span-0-579><a id=__codelineno-0-579 name=__codelineno-0-579></a>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>:</span>
</span><span id=__span-0-580><a id=__codelineno-0-580 name=__codelineno-0-580></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-581><a id=__codelineno-0-581 name=__codelineno-0-581></a>                            <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-582><a id=__codelineno-0-582 name=__codelineno-0-582></a>                                <span class=sa>f</span><span class=s2>&quot; Epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2> complete, starting epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-583><a id=__codelineno-0-583 name=__codelineno-0-583></a>                            <span class=p>)</span>
</span><span id=__span-0-584><a id=__codelineno-0-584 name=__codelineno-0-584></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>reset_for_epoch</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span>
</span><span id=__span-0-585><a id=__codelineno-0-585 name=__codelineno-0-585></a>                        <span class=k>continue</span>
</span><span id=__span-0-586><a id=__codelineno-0-586 name=__codelineno-0-586></a>                    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-587><a id=__codelineno-0-587 name=__codelineno-0-587></a>                        <span class=k>raise</span> <span class=ne>StopIteration</span><span class=p>(</span><span class=s2>&quot;No more epochs available&quot;</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=kc>None</span>
</span><span id=__span-0-588><a id=__codelineno-0-588 name=__codelineno-0-588></a>
</span><span id=__span-0-589><a id=__codelineno-0-589 name=__codelineno-0-589></a>            <span class=c1># Load data from TileDB</span>
</span><span id=__span-0-590><a id=__codelineno-0-590 name=__codelineno-0-590></a>            <span class=n>load_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-591><a id=__codelineno-0-591 name=__codelineno-0-591></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-592><a id=__codelineno-0-592 name=__codelineno-0-592></a>                <span class=c1># Read slice from TileDB as Arrow table</span>
</span><span id=__span-0-593><a id=__codelineno-0-593 name=__codelineno-0-593></a>                <span class=n>arrow_data</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-594><a id=__codelineno-0-594 name=__codelineno-0-594></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>X</span><span class=o>.</span><span class=n>read</span><span class=p>(</span>
</span><span id=__span-0-595><a id=__codelineno-0-595 name=__codelineno-0-595></a>                        <span class=p>(</span>
</span><span id=__span-0-596><a id=__codelineno-0-596 name=__codelineno-0-596></a>                            <span class=nb>slice</span><span class=p>(</span>
</span><span id=__span-0-597><a id=__codelineno-0-597 name=__codelineno-0-597></a>                                <span class=n>current_position</span><span class=p>,</span>
</span><span id=__span-0-598><a id=__codelineno-0-598 name=__codelineno-0-598></a>                                <span class=n>current_position</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-599><a id=__codelineno-0-599 name=__codelineno-0-599></a>                            <span class=p>),</span>
</span><span id=__span-0-600><a id=__codelineno-0-600 name=__codelineno-0-600></a>                        <span class=p>)</span>
</span><span id=__span-0-601><a id=__codelineno-0-601 name=__codelineno-0-601></a>                    <span class=p>)</span>
</span><span id=__span-0-602><a id=__codelineno-0-602 name=__codelineno-0-602></a>                    <span class=o>.</span><span class=n>tables</span><span class=p>()</span>
</span><span id=__span-0-603><a id=__codelineno-0-603 name=__codelineno-0-603></a>                    <span class=o>.</span><span class=n>concat</span><span class=p>()</span>
</span><span id=__span-0-604><a id=__codelineno-0-604 name=__codelineno-0-604></a>                <span class=p>)</span>
</span><span id=__span-0-605><a id=__codelineno-0-605 name=__codelineno-0-605></a>
</span><span id=__span-0-606><a id=__codelineno-0-606 name=__codelineno-0-606></a>                <span class=c1># Convert Arrow table to Polars DataFrame</span>
</span><span id=__span-0-607><a id=__codelineno-0-607 name=__codelineno-0-607></a>                <span class=n>combined_df</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>from_arrow</span><span class=p>(</span><span class=n>arrow_data</span><span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-608><a id=__codelineno-0-608 name=__codelineno-0-608></a>                <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>combined_df</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>):</span>
</span><span id=__span-0-609><a id=__codelineno-0-609 name=__codelineno-0-609></a>                    <span class=k>raise</span> <span class=ne>TypeError</span><span class=p>(</span><span class=s2>&quot;Expected DataFrame from Arrow table&quot;</span><span class=p>)</span>
</span><span id=__span-0-610><a id=__codelineno-0-610 name=__codelineno-0-610></a>
</span><span id=__span-0-611><a id=__codelineno-0-611 name=__codelineno-0-611></a>                <span class=c1># Rename SOMA columns to expected names</span>
</span><span id=__span-0-612><a id=__codelineno-0-612 name=__codelineno-0-612></a>                <span class=n>combined_df</span> <span class=o>=</span> <span class=n>combined_df</span><span class=o>.</span><span class=n>rename</span><span class=p>(</span>
</span><span id=__span-0-613><a id=__codelineno-0-613 name=__codelineno-0-613></a>                    <span class=p>{</span>
</span><span id=__span-0-614><a id=__codelineno-0-614 name=__codelineno-0-614></a>                        <span class=s2>&quot;soma_dim_0&quot;</span><span class=p>:</span> <span class=s2>&quot;cell_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-615><a id=__codelineno-0-615 name=__codelineno-0-615></a>                        <span class=s2>&quot;soma_dim_1&quot;</span><span class=p>:</span> <span class=s2>&quot;gene_integer_id&quot;</span><span class=p>,</span>
</span><span id=__span-0-616><a id=__codelineno-0-616 name=__codelineno-0-616></a>                        <span class=s2>&quot;soma_data&quot;</span><span class=p>:</span> <span class=s2>&quot;value&quot;</span><span class=p>,</span>
</span><span id=__span-0-617><a id=__codelineno-0-617 name=__codelineno-0-617></a>                    <span class=p>}</span>
</span><span id=__span-0-618><a id=__codelineno-0-618 name=__codelineno-0-618></a>                <span class=p>)</span>
</span><span id=__span-0-619><a id=__codelineno-0-619 name=__codelineno-0-619></a>
</span><span id=__span-0-620><a id=__codelineno-0-620 name=__codelineno-0-620></a>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-621><a id=__codelineno-0-621 name=__codelineno-0-621></a>                <span class=n>logger</span><span class=o>.</span><span class=n>error</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error loading TileDB data: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-622><a id=__codelineno-0-622 name=__codelineno-0-622></a>                <span class=k>raise</span> <span class=ne>StopIteration</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Failed to load TileDB data: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=nn>e</span>
</span><span id=__span-0-623><a id=__codelineno-0-623 name=__codelineno-0-623></a>
</span><span id=__span-0-624><a id=__codelineno-0-624 name=__codelineno-0-624></a>        <span class=n>load_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>load_start</span>
</span><span id=__span-0-625><a id=__codelineno-0-625 name=__codelineno-0-625></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;tiledb_loading&quot;</span><span class=p>,</span> <span class=n>load_time</span><span class=p>)</span>
</span><span id=__span-0-626><a id=__codelineno-0-626 name=__codelineno-0-626></a>
</span><span id=__span-0-627><a id=__codelineno-0-627 name=__codelineno-0-627></a>        <span class=c1># Print detailed loading breakdown every 10 batches</span>
</span><span id=__span-0-628><a id=__codelineno-0-628 name=__codelineno-0-628></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-629><a id=__codelineno-0-629 name=__codelineno-0-629></a>            <span class=kn>import</span><span class=w> </span><span class=nn>psutil</span>
</span><span id=__span-0-630><a id=__codelineno-0-630 name=__codelineno-0-630></a>
</span><span id=__span-0-631><a id=__codelineno-0-631 name=__codelineno-0-631></a>            <span class=n>process</span> <span class=o>=</span> <span class=n>psutil</span><span class=o>.</span><span class=n>Process</span><span class=p>()</span>
</span><span id=__span-0-632><a id=__codelineno-0-632 name=__codelineno-0-632></a>            <span class=n>memory_mb</span> <span class=o>=</span> <span class=n>process</span><span class=o>.</span><span class=n>memory_info</span><span class=p>()</span><span class=o>.</span><span class=n>rss</span> <span class=o>/</span> <span class=mi>1024</span> <span class=o>/</span> <span class=mi>1024</span>
</span><span id=__span-0-633><a id=__codelineno-0-633 name=__codelineno-0-633></a>
</span><span id=__span-0-634><a id=__codelineno-0-634 name=__codelineno-0-634></a>            <span class=c1># Store timing info for consolidated report</span>
</span><span id=__span-0-635><a id=__codelineno-0-635 name=__codelineno-0-635></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_last_load_time</span> <span class=o>=</span> <span class=n>load_time</span>
</span><span id=__span-0-636><a id=__codelineno-0-636 name=__codelineno-0-636></a>            <span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span> <span class=o>=</span> <span class=n>memory_mb</span>
</span><span id=__span-0-637><a id=__codelineno-0-637 name=__codelineno-0-637></a>
</span><span id=__span-0-638><a id=__codelineno-0-638 name=__codelineno-0-638></a>        <span class=c1># Apply shuffling strategy</span>
</span><span id=__span-0-639><a id=__codelineno-0-639 name=__codelineno-0-639></a>        <span class=n>shuffle_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-640><a id=__codelineno-0-640 name=__codelineno-0-640></a>
</span><span id=__span-0-641><a id=__codelineno-0-641 name=__codelineno-0-641></a>        <span class=c1># Apply shuffling with chunking</span>
</span><span id=__span-0-642><a id=__codelineno-0-642 name=__codelineno-0-642></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=p>:</span>
</span><span id=__span-0-643><a id=__codelineno-0-643 name=__codelineno-0-643></a>            <span class=n>shuffled_chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>shuffle</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
</span><span id=__span-0-644><a id=__codelineno-0-644 name=__codelineno-0-644></a>                <span class=n>combined_df_mos</span><span class=p>,</span>  <span class=c1># type: ignore[arg-type]</span>
</span><span id=__span-0-645><a id=__codelineno-0-645 name=__codelineno-0-645></a>                <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>*</span> <span class=mi>10000</span><span class=p>,</span>
</span><span id=__span-0-646><a id=__codelineno-0-646 name=__codelineno-0-646></a>                <span class=n>batch_size</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-647><a id=__codelineno-0-647 name=__codelineno-0-647></a>            <span class=p>)</span>
</span><span id=__span-0-648><a id=__codelineno-0-648 name=__codelineno-0-648></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-649><a id=__codelineno-0-649 name=__codelineno-0-649></a>            <span class=n>shuffled_chunks</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>shuffle</span><span class=o>.</span><span class=n>apply</span><span class=p>(</span>
</span><span id=__span-0-650><a id=__codelineno-0-650 name=__codelineno-0-650></a>                <span class=n>combined_df</span><span class=p>,</span>  <span class=c1># type: ignore[arg-type]</span>
</span><span id=__span-0-651><a id=__codelineno-0-651 name=__codelineno-0-651></a>                <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>*</span> <span class=mi>10000</span><span class=p>,</span>
</span><span id=__span-0-652><a id=__codelineno-0-652 name=__codelineno-0-652></a>                <span class=n>batch_size</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-653><a id=__codelineno-0-653 name=__codelineno-0-653></a>            <span class=p>)</span>
</span><span id=__span-0-654><a id=__codelineno-0-654 name=__codelineno-0-654></a>
</span><span id=__span-0-655><a id=__codelineno-0-655 name=__codelineno-0-655></a>        <span class=n>shuffle_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>shuffle_start</span>
</span><span id=__span-0-656><a id=__codelineno-0-656 name=__codelineno-0-656></a>        <span class=n>total_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span>
</span><span id=__span-0-657><a id=__codelineno-0-657 name=__codelineno-0-657></a>
</span><span id=__span-0-658><a id=__codelineno-0-658 name=__codelineno-0-658></a>        <span class=c1># Record timing metrics</span>
</span><span id=__span-0-659><a id=__codelineno-0-659 name=__codelineno-0-659></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;shuffle&quot;</span><span class=p>,</span> <span class=n>shuffle_time</span><span class=p>)</span>
</span><span id=__span-0-660><a id=__codelineno-0-660 name=__codelineno-0-660></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;total&quot;</span><span class=p>,</span> <span class=n>total_time</span><span class=p>)</span>
</span><span id=__span-0-661><a id=__codelineno-0-661 name=__codelineno-0-661></a>
</span><span id=__span-0-662><a id=__codelineno-0-662 name=__codelineno-0-662></a>        <span class=c1># Count total cells across all chunks</span>
</span><span id=__span-0-663><a id=__codelineno-0-663 name=__codelineno-0-663></a>        <span class=n>total_cells_in_chunks</span> <span class=o>=</span> <span class=nb>sum</span><span class=p>(</span>
</span><span id=__span-0-664><a id=__codelineno-0-664 name=__codelineno-0-664></a>            <span class=nb>len</span><span class=p>(</span><span class=n>chunk</span><span class=o>.</span><span class=n>get_column</span><span class=p>(</span><span class=s2>&quot;cell_integer_id&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>unique</span><span class=p>())</span>
</span><span id=__span-0-665><a id=__codelineno-0-665 name=__codelineno-0-665></a>            <span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>shuffled_chunks</span>
</span><span id=__span-0-666><a id=__codelineno-0-666 name=__codelineno-0-666></a>            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>chunk</span><span class=p>,</span> <span class=n>pl</span><span class=o>.</span><span class=n>DataFrame</span><span class=p>)</span>
</span><span id=__span-0-667><a id=__codelineno-0-667 name=__codelineno-0-667></a>        <span class=p>)</span>
</span><span id=__span-0-668><a id=__codelineno-0-668 name=__codelineno-0-668></a>
</span><span id=__span-0-669><a id=__codelineno-0-669 name=__codelineno-0-669></a>        <span class=c1># Record cells processed</span>
</span><span id=__span-0-670><a id=__codelineno-0-670 name=__codelineno-0-670></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_record_timing</span><span class=p>(</span><span class=s2>&quot;cells_processed&quot;</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>total_cells_in_chunks</span><span class=p>)</span>
</span><span id=__span-0-671><a id=__codelineno-0-671 name=__codelineno-0-671></a>
</span><span id=__span-0-672><a id=__codelineno-0-672 name=__codelineno-0-672></a>        <span class=c1># Print consolidated prefetch batch reporting</span>
</span><span id=__span-0-673><a id=__codelineno-0-673 name=__codelineno-0-673></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-674><a id=__codelineno-0-674 name=__codelineno-0-674></a>            <span class=n>strategy_name</span> <span class=o>=</span> <span class=s2>&quot;MoS&quot;</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=k>else</span> <span class=s2>&quot;sequential&quot;</span>
</span><span id=__span-0-675><a id=__codelineno-0-675 name=__codelineno-0-675></a>            <span class=n>prefetch_report</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;TileDB </span><span class=si>{</span><span class=n>strategy_name</span><span class=si>}</span><span class=s2> prefetch batch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2> (epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2>):</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-676><a id=__codelineno-0-676 name=__codelineno-0-676></a>            <span class=n>prefetch_report</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;   TileDB loading: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_last_load_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms (</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span><span class=si>}</span><span class=s2> cells)</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-677><a id=__codelineno-0-677 name=__codelineno-0-677></a>            <span class=n>prefetch_report</span> <span class=o>+=</span> <span class=p>(</span>
</span><span id=__span-0-678><a id=__codelineno-0-678 name=__codelineno-0-678></a>                <span class=sa>f</span><span class=s2>&quot;   Processing: </span><span class=si>{</span><span class=n>shuffle_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms shuffle</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-679><a id=__codelineno-0-679 name=__codelineno-0-679></a>            <span class=p>)</span>
</span><span id=__span-0-680><a id=__codelineno-0-680 name=__codelineno-0-680></a>            <span class=n>prefetch_report</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;   Total: </span><span class=si>{</span><span class=n>total_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms, </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>shuffled_chunks</span><span class=p>)</span><span class=si>}</span><span class=s2> chunks, </span><span class=si>{</span><span class=n>total_cells_in_chunks</span><span class=si>}</span><span class=s2> cells, </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> MB&quot;</span>
</span><span id=__span-0-681><a id=__codelineno-0-681 name=__codelineno-0-681></a>
</span><span id=__span-0-682><a id=__codelineno-0-682 name=__codelineno-0-682></a>            <span class=n>print_prefetch</span><span class=p>(</span><span class=n>prefetch_report</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span>
</span><span id=__span-0-683><a id=__codelineno-0-683 name=__codelineno-0-683></a>
</span><span id=__span-0-684><a id=__codelineno-0-684 name=__codelineno-0-684></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-685><a id=__codelineno-0-685 name=__codelineno-0-685></a>
</span><span id=__span-0-686><a id=__codelineno-0-686 name=__codelineno-0-686></a>        <span class=c1># Return the first chunk as a batch (we&#39;ll handle multiple chunks in the dataloader)</span>
</span><span id=__span-0-687><a id=__codelineno-0-687 name=__codelineno-0-687></a>        <span class=k>if</span> <span class=n>shuffled_chunks</span><span class=p>:</span>
</span><span id=__span-0-688><a id=__codelineno-0-688 name=__codelineno-0-688></a>            <span class=n>first_chunk</span> <span class=o>=</span> <span class=n>shuffled_chunks</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-0-689><a id=__codelineno-0-689 name=__codelineno-0-689></a>            <span class=k>return</span> <span class=n>TileDBPrefetchBatch</span><span class=p>(</span>
</span><span id=__span-0-690><a id=__codelineno-0-690 name=__codelineno-0-690></a>                <span class=n>batch_id</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-691><a id=__codelineno-0-691 name=__codelineno-0-691></a>                <span class=n>batch_df</span><span class=o>=</span><span class=n>first_chunk</span><span class=p>,</span>
</span><span id=__span-0-692><a id=__codelineno-0-692 name=__codelineno-0-692></a>                <span class=n>cell_integer_ids</span><span class=o>=</span><span class=n>first_chunk</span><span class=p>[</span><span class=s2>&quot;cell_integer_id&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span><span class=o>.</span><span class=n>to_list</span><span class=p>(),</span>
</span><span id=__span-0-693><a id=__codelineno-0-693 name=__codelineno-0-693></a>                <span class=n>process_time</span><span class=o>=</span><span class=n>shuffle_time</span><span class=p>,</span>
</span><span id=__span-0-694><a id=__codelineno-0-694 name=__codelineno-0-694></a>                <span class=n>memory_mb</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_last_memory_mb</span><span class=p>,</span>
</span><span id=__span-0-695><a id=__codelineno-0-695 name=__codelineno-0-695></a>            <span class=p>)</span>
</span><span id=__span-0-696><a id=__codelineno-0-696 name=__codelineno-0-696></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-697><a id=__codelineno-0-697 name=__codelineno-0-697></a>            <span class=c1># No data in this chunk, continue to next iteration</span>
</span><span id=__span-0-698><a id=__codelineno-0-698 name=__codelineno-0-698></a>            <span class=k>continue</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher class="doc doc-heading"> <code>TileDBAsyncPrefetcher</code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Asynchronous prefetcher for TileDB batch processing with background loading.</p> <p>TileDBAsyncPrefetcher provides background batch processing and prefetching for TileDB data to improve training throughput. It runs a separate worker thread that continuously loads and processes batches while the main training loop consumes pre-processed data.</p> <details class=key-features open> <summary>Key Features</summary> <ul> <li>Background batch processing in separate worker thread</li> <li>Configurable queue size for memory management</li> <li>Comprehensive performance monitoring and statistics</li> <li>Automatic epoch transition handling</li> <li>Graceful shutdown and cleanup</li> <li>Real-time rate monitoring and reporting</li> <li>Error handling and recovery</li> </ul> </details> <p>The prefetcher maintains a queue of pre-processed batches and provides statistics about loading rates, memory usage, and processing times.</p> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Create prefetcher with a batch processor</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=o>=</span><span class=mi>100</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Start background processing</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Get pre-processed batches</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Got batch </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2> with </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>cell_integer_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> cells&quot;</span><span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check performance statistics</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stats</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_stats</span><span class=p>()</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Loading rate: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;cells_per_sec&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> cells/sec&quot;</span><span class=p>)</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Stop background processing</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-701> 701</a></span>
<span class=normal><a href=#__codelineno-0-702> 702</a></span>
<span class=normal><a href=#__codelineno-0-703> 703</a></span>
<span class=normal><a href=#__codelineno-0-704> 704</a></span>
<span class=normal><a href=#__codelineno-0-705> 705</a></span>
<span class=normal><a href=#__codelineno-0-706> 706</a></span>
<span class=normal><a href=#__codelineno-0-707> 707</a></span>
<span class=normal><a href=#__codelineno-0-708> 708</a></span>
<span class=normal><a href=#__codelineno-0-709> 709</a></span>
<span class=normal><a href=#__codelineno-0-710> 710</a></span>
<span class=normal><a href=#__codelineno-0-711> 711</a></span>
<span class=normal><a href=#__codelineno-0-712> 712</a></span>
<span class=normal><a href=#__codelineno-0-713> 713</a></span>
<span class=normal><a href=#__codelineno-0-714> 714</a></span>
<span class=normal><a href=#__codelineno-0-715> 715</a></span>
<span class=normal><a href=#__codelineno-0-716> 716</a></span>
<span class=normal><a href=#__codelineno-0-717> 717</a></span>
<span class=normal><a href=#__codelineno-0-718> 718</a></span>
<span class=normal><a href=#__codelineno-0-719> 719</a></span>
<span class=normal><a href=#__codelineno-0-720> 720</a></span>
<span class=normal><a href=#__codelineno-0-721> 721</a></span>
<span class=normal><a href=#__codelineno-0-722> 722</a></span>
<span class=normal><a href=#__codelineno-0-723> 723</a></span>
<span class=normal><a href=#__codelineno-0-724> 724</a></span>
<span class=normal><a href=#__codelineno-0-725> 725</a></span>
<span class=normal><a href=#__codelineno-0-726> 726</a></span>
<span class=normal><a href=#__codelineno-0-727> 727</a></span>
<span class=normal><a href=#__codelineno-0-728> 728</a></span>
<span class=normal><a href=#__codelineno-0-729> 729</a></span>
<span class=normal><a href=#__codelineno-0-730> 730</a></span>
<span class=normal><a href=#__codelineno-0-731> 731</a></span>
<span class=normal><a href=#__codelineno-0-732> 732</a></span>
<span class=normal><a href=#__codelineno-0-733> 733</a></span>
<span class=normal><a href=#__codelineno-0-734> 734</a></span>
<span class=normal><a href=#__codelineno-0-735> 735</a></span>
<span class=normal><a href=#__codelineno-0-736> 736</a></span>
<span class=normal><a href=#__codelineno-0-737> 737</a></span>
<span class=normal><a href=#__codelineno-0-738> 738</a></span>
<span class=normal><a href=#__codelineno-0-739> 739</a></span>
<span class=normal><a href=#__codelineno-0-740> 740</a></span>
<span class=normal><a href=#__codelineno-0-741> 741</a></span>
<span class=normal><a href=#__codelineno-0-742> 742</a></span>
<span class=normal><a href=#__codelineno-0-743> 743</a></span>
<span class=normal><a href=#__codelineno-0-744> 744</a></span>
<span class=normal><a href=#__codelineno-0-745> 745</a></span>
<span class=normal><a href=#__codelineno-0-746> 746</a></span>
<span class=normal><a href=#__codelineno-0-747> 747</a></span>
<span class=normal><a href=#__codelineno-0-748> 748</a></span>
<span class=normal><a href=#__codelineno-0-749> 749</a></span>
<span class=normal><a href=#__codelineno-0-750> 750</a></span>
<span class=normal><a href=#__codelineno-0-751> 751</a></span>
<span class=normal><a href=#__codelineno-0-752> 752</a></span>
<span class=normal><a href=#__codelineno-0-753> 753</a></span>
<span class=normal><a href=#__codelineno-0-754> 754</a></span>
<span class=normal><a href=#__codelineno-0-755> 755</a></span>
<span class=normal><a href=#__codelineno-0-756> 756</a></span>
<span class=normal><a href=#__codelineno-0-757> 757</a></span>
<span class=normal><a href=#__codelineno-0-758> 758</a></span>
<span class=normal><a href=#__codelineno-0-759> 759</a></span>
<span class=normal><a href=#__codelineno-0-760> 760</a></span>
<span class=normal><a href=#__codelineno-0-761> 761</a></span>
<span class=normal><a href=#__codelineno-0-762> 762</a></span>
<span class=normal><a href=#__codelineno-0-763> 763</a></span>
<span class=normal><a href=#__codelineno-0-764> 764</a></span>
<span class=normal><a href=#__codelineno-0-765> 765</a></span>
<span class=normal><a href=#__codelineno-0-766> 766</a></span>
<span class=normal><a href=#__codelineno-0-767> 767</a></span>
<span class=normal><a href=#__codelineno-0-768> 768</a></span>
<span class=normal><a href=#__codelineno-0-769> 769</a></span>
<span class=normal><a href=#__codelineno-0-770> 770</a></span>
<span class=normal><a href=#__codelineno-0-771> 771</a></span>
<span class=normal><a href=#__codelineno-0-772> 772</a></span>
<span class=normal><a href=#__codelineno-0-773> 773</a></span>
<span class=normal><a href=#__codelineno-0-774> 774</a></span>
<span class=normal><a href=#__codelineno-0-775> 775</a></span>
<span class=normal><a href=#__codelineno-0-776> 776</a></span>
<span class=normal><a href=#__codelineno-0-777> 777</a></span>
<span class=normal><a href=#__codelineno-0-778> 778</a></span>
<span class=normal><a href=#__codelineno-0-779> 779</a></span>
<span class=normal><a href=#__codelineno-0-780> 780</a></span>
<span class=normal><a href=#__codelineno-0-781> 781</a></span>
<span class=normal><a href=#__codelineno-0-782> 782</a></span>
<span class=normal><a href=#__codelineno-0-783> 783</a></span>
<span class=normal><a href=#__codelineno-0-784> 784</a></span>
<span class=normal><a href=#__codelineno-0-785> 785</a></span>
<span class=normal><a href=#__codelineno-0-786> 786</a></span>
<span class=normal><a href=#__codelineno-0-787> 787</a></span>
<span class=normal><a href=#__codelineno-0-788> 788</a></span>
<span class=normal><a href=#__codelineno-0-789> 789</a></span>
<span class=normal><a href=#__codelineno-0-790> 790</a></span>
<span class=normal><a href=#__codelineno-0-791> 791</a></span>
<span class=normal><a href=#__codelineno-0-792> 792</a></span>
<span class=normal><a href=#__codelineno-0-793> 793</a></span>
<span class=normal><a href=#__codelineno-0-794> 794</a></span>
<span class=normal><a href=#__codelineno-0-795> 795</a></span>
<span class=normal><a href=#__codelineno-0-796> 796</a></span>
<span class=normal><a href=#__codelineno-0-797> 797</a></span>
<span class=normal><a href=#__codelineno-0-798> 798</a></span>
<span class=normal><a href=#__codelineno-0-799> 799</a></span>
<span class=normal><a href=#__codelineno-0-800> 800</a></span>
<span class=normal><a href=#__codelineno-0-801> 801</a></span>
<span class=normal><a href=#__codelineno-0-802> 802</a></span>
<span class=normal><a href=#__codelineno-0-803> 803</a></span>
<span class=normal><a href=#__codelineno-0-804> 804</a></span>
<span class=normal><a href=#__codelineno-0-805> 805</a></span>
<span class=normal><a href=#__codelineno-0-806> 806</a></span>
<span class=normal><a href=#__codelineno-0-807> 807</a></span>
<span class=normal><a href=#__codelineno-0-808> 808</a></span>
<span class=normal><a href=#__codelineno-0-809> 809</a></span>
<span class=normal><a href=#__codelineno-0-810> 810</a></span>
<span class=normal><a href=#__codelineno-0-811> 811</a></span>
<span class=normal><a href=#__codelineno-0-812> 812</a></span>
<span class=normal><a href=#__codelineno-0-813> 813</a></span>
<span class=normal><a href=#__codelineno-0-814> 814</a></span>
<span class=normal><a href=#__codelineno-0-815> 815</a></span>
<span class=normal><a href=#__codelineno-0-816> 816</a></span>
<span class=normal><a href=#__codelineno-0-817> 817</a></span>
<span class=normal><a href=#__codelineno-0-818> 818</a></span>
<span class=normal><a href=#__codelineno-0-819> 819</a></span>
<span class=normal><a href=#__codelineno-0-820> 820</a></span>
<span class=normal><a href=#__codelineno-0-821> 821</a></span>
<span class=normal><a href=#__codelineno-0-822> 822</a></span>
<span class=normal><a href=#__codelineno-0-823> 823</a></span>
<span class=normal><a href=#__codelineno-0-824> 824</a></span>
<span class=normal><a href=#__codelineno-0-825> 825</a></span>
<span class=normal><a href=#__codelineno-0-826> 826</a></span>
<span class=normal><a href=#__codelineno-0-827> 827</a></span>
<span class=normal><a href=#__codelineno-0-828> 828</a></span>
<span class=normal><a href=#__codelineno-0-829> 829</a></span>
<span class=normal><a href=#__codelineno-0-830> 830</a></span>
<span class=normal><a href=#__codelineno-0-831> 831</a></span>
<span class=normal><a href=#__codelineno-0-832> 832</a></span>
<span class=normal><a href=#__codelineno-0-833> 833</a></span>
<span class=normal><a href=#__codelineno-0-834> 834</a></span>
<span class=normal><a href=#__codelineno-0-835> 835</a></span>
<span class=normal><a href=#__codelineno-0-836> 836</a></span>
<span class=normal><a href=#__codelineno-0-837> 837</a></span>
<span class=normal><a href=#__codelineno-0-838> 838</a></span>
<span class=normal><a href=#__codelineno-0-839> 839</a></span>
<span class=normal><a href=#__codelineno-0-840> 840</a></span>
<span class=normal><a href=#__codelineno-0-841> 841</a></span>
<span class=normal><a href=#__codelineno-0-842> 842</a></span>
<span class=normal><a href=#__codelineno-0-843> 843</a></span>
<span class=normal><a href=#__codelineno-0-844> 844</a></span>
<span class=normal><a href=#__codelineno-0-845> 845</a></span>
<span class=normal><a href=#__codelineno-0-846> 846</a></span>
<span class=normal><a href=#__codelineno-0-847> 847</a></span>
<span class=normal><a href=#__codelineno-0-848> 848</a></span>
<span class=normal><a href=#__codelineno-0-849> 849</a></span>
<span class=normal><a href=#__codelineno-0-850> 850</a></span>
<span class=normal><a href=#__codelineno-0-851> 851</a></span>
<span class=normal><a href=#__codelineno-0-852> 852</a></span>
<span class=normal><a href=#__codelineno-0-853> 853</a></span>
<span class=normal><a href=#__codelineno-0-854> 854</a></span>
<span class=normal><a href=#__codelineno-0-855> 855</a></span>
<span class=normal><a href=#__codelineno-0-856> 856</a></span>
<span class=normal><a href=#__codelineno-0-857> 857</a></span>
<span class=normal><a href=#__codelineno-0-858> 858</a></span>
<span class=normal><a href=#__codelineno-0-859> 859</a></span>
<span class=normal><a href=#__codelineno-0-860> 860</a></span>
<span class=normal><a href=#__codelineno-0-861> 861</a></span>
<span class=normal><a href=#__codelineno-0-862> 862</a></span>
<span class=normal><a href=#__codelineno-0-863> 863</a></span>
<span class=normal><a href=#__codelineno-0-864> 864</a></span>
<span class=normal><a href=#__codelineno-0-865> 865</a></span>
<span class=normal><a href=#__codelineno-0-866> 866</a></span>
<span class=normal><a href=#__codelineno-0-867> 867</a></span>
<span class=normal><a href=#__codelineno-0-868> 868</a></span>
<span class=normal><a href=#__codelineno-0-869> 869</a></span>
<span class=normal><a href=#__codelineno-0-870> 870</a></span>
<span class=normal><a href=#__codelineno-0-871> 871</a></span>
<span class=normal><a href=#__codelineno-0-872> 872</a></span>
<span class=normal><a href=#__codelineno-0-873> 873</a></span>
<span class=normal><a href=#__codelineno-0-874> 874</a></span>
<span class=normal><a href=#__codelineno-0-875> 875</a></span>
<span class=normal><a href=#__codelineno-0-876> 876</a></span>
<span class=normal><a href=#__codelineno-0-877> 877</a></span>
<span class=normal><a href=#__codelineno-0-878> 878</a></span>
<span class=normal><a href=#__codelineno-0-879> 879</a></span>
<span class=normal><a href=#__codelineno-0-880> 880</a></span>
<span class=normal><a href=#__codelineno-0-881> 881</a></span>
<span class=normal><a href=#__codelineno-0-882> 882</a></span>
<span class=normal><a href=#__codelineno-0-883> 883</a></span>
<span class=normal><a href=#__codelineno-0-884> 884</a></span>
<span class=normal><a href=#__codelineno-0-885> 885</a></span>
<span class=normal><a href=#__codelineno-0-886> 886</a></span>
<span class=normal><a href=#__codelineno-0-887> 887</a></span>
<span class=normal><a href=#__codelineno-0-888> 888</a></span>
<span class=normal><a href=#__codelineno-0-889> 889</a></span>
<span class=normal><a href=#__codelineno-0-890> 890</a></span>
<span class=normal><a href=#__codelineno-0-891> 891</a></span>
<span class=normal><a href=#__codelineno-0-892> 892</a></span>
<span class=normal><a href=#__codelineno-0-893> 893</a></span>
<span class=normal><a href=#__codelineno-0-894> 894</a></span>
<span class=normal><a href=#__codelineno-0-895> 895</a></span>
<span class=normal><a href=#__codelineno-0-896> 896</a></span>
<span class=normal><a href=#__codelineno-0-897> 897</a></span>
<span class=normal><a href=#__codelineno-0-898> 898</a></span>
<span class=normal><a href=#__codelineno-0-899> 899</a></span>
<span class=normal><a href=#__codelineno-0-900> 900</a></span>
<span class=normal><a href=#__codelineno-0-901> 901</a></span>
<span class=normal><a href=#__codelineno-0-902> 902</a></span>
<span class=normal><a href=#__codelineno-0-903> 903</a></span>
<span class=normal><a href=#__codelineno-0-904> 904</a></span>
<span class=normal><a href=#__codelineno-0-905> 905</a></span>
<span class=normal><a href=#__codelineno-0-906> 906</a></span>
<span class=normal><a href=#__codelineno-0-907> 907</a></span>
<span class=normal><a href=#__codelineno-0-908> 908</a></span>
<span class=normal><a href=#__codelineno-0-909> 909</a></span>
<span class=normal><a href=#__codelineno-0-910> 910</a></span>
<span class=normal><a href=#__codelineno-0-911> 911</a></span>
<span class=normal><a href=#__codelineno-0-912> 912</a></span>
<span class=normal><a href=#__codelineno-0-913> 913</a></span>
<span class=normal><a href=#__codelineno-0-914> 914</a></span>
<span class=normal><a href=#__codelineno-0-915> 915</a></span>
<span class=normal><a href=#__codelineno-0-916> 916</a></span>
<span class=normal><a href=#__codelineno-0-917> 917</a></span>
<span class=normal><a href=#__codelineno-0-918> 918</a></span>
<span class=normal><a href=#__codelineno-0-919> 919</a></span>
<span class=normal><a href=#__codelineno-0-920> 920</a></span>
<span class=normal><a href=#__codelineno-0-921> 921</a></span>
<span class=normal><a href=#__codelineno-0-922> 922</a></span>
<span class=normal><a href=#__codelineno-0-923> 923</a></span>
<span class=normal><a href=#__codelineno-0-924> 924</a></span>
<span class=normal><a href=#__codelineno-0-925> 925</a></span>
<span class=normal><a href=#__codelineno-0-926> 926</a></span>
<span class=normal><a href=#__codelineno-0-927> 927</a></span>
<span class=normal><a href=#__codelineno-0-928> 928</a></span>
<span class=normal><a href=#__codelineno-0-929> 929</a></span>
<span class=normal><a href=#__codelineno-0-930> 930</a></span>
<span class=normal><a href=#__codelineno-0-931> 931</a></span>
<span class=normal><a href=#__codelineno-0-932> 932</a></span>
<span class=normal><a href=#__codelineno-0-933> 933</a></span>
<span class=normal><a href=#__codelineno-0-934> 934</a></span>
<span class=normal><a href=#__codelineno-0-935> 935</a></span>
<span class=normal><a href=#__codelineno-0-936> 936</a></span>
<span class=normal><a href=#__codelineno-0-937> 937</a></span>
<span class=normal><a href=#__codelineno-0-938> 938</a></span>
<span class=normal><a href=#__codelineno-0-939> 939</a></span>
<span class=normal><a href=#__codelineno-0-940> 940</a></span>
<span class=normal><a href=#__codelineno-0-941> 941</a></span>
<span class=normal><a href=#__codelineno-0-942> 942</a></span>
<span class=normal><a href=#__codelineno-0-943> 943</a></span>
<span class=normal><a href=#__codelineno-0-944> 944</a></span>
<span class=normal><a href=#__codelineno-0-945> 945</a></span>
<span class=normal><a href=#__codelineno-0-946> 946</a></span>
<span class=normal><a href=#__codelineno-0-947> 947</a></span>
<span class=normal><a href=#__codelineno-0-948> 948</a></span>
<span class=normal><a href=#__codelineno-0-949> 949</a></span>
<span class=normal><a href=#__codelineno-0-950> 950</a></span>
<span class=normal><a href=#__codelineno-0-951> 951</a></span>
<span class=normal><a href=#__codelineno-0-952> 952</a></span>
<span class=normal><a href=#__codelineno-0-953> 953</a></span>
<span class=normal><a href=#__codelineno-0-954> 954</a></span>
<span class=normal><a href=#__codelineno-0-955> 955</a></span>
<span class=normal><a href=#__codelineno-0-956> 956</a></span>
<span class=normal><a href=#__codelineno-0-957> 957</a></span>
<span class=normal><a href=#__codelineno-0-958> 958</a></span>
<span class=normal><a href=#__codelineno-0-959> 959</a></span>
<span class=normal><a href=#__codelineno-0-960> 960</a></span>
<span class=normal><a href=#__codelineno-0-961> 961</a></span>
<span class=normal><a href=#__codelineno-0-962> 962</a></span>
<span class=normal><a href=#__codelineno-0-963> 963</a></span>
<span class=normal><a href=#__codelineno-0-964> 964</a></span>
<span class=normal><a href=#__codelineno-0-965> 965</a></span>
<span class=normal><a href=#__codelineno-0-966> 966</a></span>
<span class=normal><a href=#__codelineno-0-967> 967</a></span>
<span class=normal><a href=#__codelineno-0-968> 968</a></span>
<span class=normal><a href=#__codelineno-0-969> 969</a></span>
<span class=normal><a href=#__codelineno-0-970> 970</a></span>
<span class=normal><a href=#__codelineno-0-971> 971</a></span>
<span class=normal><a href=#__codelineno-0-972> 972</a></span>
<span class=normal><a href=#__codelineno-0-973> 973</a></span>
<span class=normal><a href=#__codelineno-0-974> 974</a></span>
<span class=normal><a href=#__codelineno-0-975> 975</a></span>
<span class=normal><a href=#__codelineno-0-976> 976</a></span>
<span class=normal><a href=#__codelineno-0-977> 977</a></span>
<span class=normal><a href=#__codelineno-0-978> 978</a></span>
<span class=normal><a href=#__codelineno-0-979> 979</a></span>
<span class=normal><a href=#__codelineno-0-980> 980</a></span>
<span class=normal><a href=#__codelineno-0-981> 981</a></span>
<span class=normal><a href=#__codelineno-0-982> 982</a></span>
<span class=normal><a href=#__codelineno-0-983> 983</a></span>
<span class=normal><a href=#__codelineno-0-984> 984</a></span>
<span class=normal><a href=#__codelineno-0-985> 985</a></span>
<span class=normal><a href=#__codelineno-0-986> 986</a></span>
<span class=normal><a href=#__codelineno-0-987> 987</a></span>
<span class=normal><a href=#__codelineno-0-988> 988</a></span>
<span class=normal><a href=#__codelineno-0-989> 989</a></span>
<span class=normal><a href=#__codelineno-0-990> 990</a></span>
<span class=normal><a href=#__codelineno-0-991> 991</a></span>
<span class=normal><a href=#__codelineno-0-992> 992</a></span>
<span class=normal><a href=#__codelineno-0-993> 993</a></span>
<span class=normal><a href=#__codelineno-0-994> 994</a></span>
<span class=normal><a href=#__codelineno-0-995> 995</a></span>
<span class=normal><a href=#__codelineno-0-996> 996</a></span>
<span class=normal><a href=#__codelineno-0-997> 997</a></span>
<span class=normal><a href=#__codelineno-0-998> 998</a></span>
<span class=normal><a href=#__codelineno-0-999> 999</a></span>
<span class=normal><a href=#__codelineno-0-1000>1000</a></span>
<span class=normal><a href=#__codelineno-0-1001>1001</a></span>
<span class=normal><a href=#__codelineno-0-1002>1002</a></span>
<span class=normal><a href=#__codelineno-0-1003>1003</a></span>
<span class=normal><a href=#__codelineno-0-1004>1004</a></span>
<span class=normal><a href=#__codelineno-0-1005>1005</a></span>
<span class=normal><a href=#__codelineno-0-1006>1006</a></span>
<span class=normal><a href=#__codelineno-0-1007>1007</a></span>
<span class=normal><a href=#__codelineno-0-1008>1008</a></span>
<span class=normal><a href=#__codelineno-0-1009>1009</a></span>
<span class=normal><a href=#__codelineno-0-1010>1010</a></span>
<span class=normal><a href=#__codelineno-0-1011>1011</a></span>
<span class=normal><a href=#__codelineno-0-1012>1012</a></span>
<span class=normal><a href=#__codelineno-0-1013>1013</a></span>
<span class=normal><a href=#__codelineno-0-1014>1014</a></span>
<span class=normal><a href=#__codelineno-0-1015>1015</a></span>
<span class=normal><a href=#__codelineno-0-1016>1016</a></span>
<span class=normal><a href=#__codelineno-0-1017>1017</a></span>
<span class=normal><a href=#__codelineno-0-1018>1018</a></span>
<span class=normal><a href=#__codelineno-0-1019>1019</a></span>
<span class=normal><a href=#__codelineno-0-1020>1020</a></span>
<span class=normal><a href=#__codelineno-0-1021>1021</a></span>
<span class=normal><a href=#__codelineno-0-1022>1022</a></span>
<span class=normal><a href=#__codelineno-0-1023>1023</a></span>
<span class=normal><a href=#__codelineno-0-1024>1024</a></span>
<span class=normal><a href=#__codelineno-0-1025>1025</a></span>
<span class=normal><a href=#__codelineno-0-1026>1026</a></span>
<span class=normal><a href=#__codelineno-0-1027>1027</a></span>
<span class=normal><a href=#__codelineno-0-1028>1028</a></span>
<span class=normal><a href=#__codelineno-0-1029>1029</a></span>
<span class=normal><a href=#__codelineno-0-1030>1030</a></span>
<span class=normal><a href=#__codelineno-0-1031>1031</a></span>
<span class=normal><a href=#__codelineno-0-1032>1032</a></span>
<span class=normal><a href=#__codelineno-0-1033>1033</a></span>
<span class=normal><a href=#__codelineno-0-1034>1034</a></span>
<span class=normal><a href=#__codelineno-0-1035>1035</a></span>
<span class=normal><a href=#__codelineno-0-1036>1036</a></span>
<span class=normal><a href=#__codelineno-0-1037>1037</a></span>
<span class=normal><a href=#__codelineno-0-1038>1038</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-701><a id=__codelineno-0-701 name=__codelineno-0-701></a><span class=k>class</span><span class=w> </span><span class=nc>TileDBAsyncPrefetcher</span><span class=p>:</span>
</span><span id=__span-0-702><a id=__codelineno-0-702 name=__codelineno-0-702></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-703><a id=__codelineno-0-703 name=__codelineno-0-703></a><span class=sd>    Asynchronous prefetcher for TileDB batch processing with background loading.</span>
</span><span id=__span-0-704><a id=__codelineno-0-704 name=__codelineno-0-704></a>
</span><span id=__span-0-705><a id=__codelineno-0-705 name=__codelineno-0-705></a><span class=sd>    TileDBAsyncPrefetcher provides background batch processing and prefetching</span>
</span><span id=__span-0-706><a id=__codelineno-0-706 name=__codelineno-0-706></a><span class=sd>    for TileDB data to improve training throughput. It runs a separate worker</span>
</span><span id=__span-0-707><a id=__codelineno-0-707 name=__codelineno-0-707></a><span class=sd>    thread that continuously loads and processes batches while the main training</span>
</span><span id=__span-0-708><a id=__codelineno-0-708 name=__codelineno-0-708></a><span class=sd>    loop consumes pre-processed data.</span>
</span><span id=__span-0-709><a id=__codelineno-0-709 name=__codelineno-0-709></a>
</span><span id=__span-0-710><a id=__codelineno-0-710 name=__codelineno-0-710></a><span class=sd>    Key Features:</span>
</span><span id=__span-0-711><a id=__codelineno-0-711 name=__codelineno-0-711></a><span class=sd>        - Background batch processing in separate worker thread</span>
</span><span id=__span-0-712><a id=__codelineno-0-712 name=__codelineno-0-712></a><span class=sd>        - Configurable queue size for memory management</span>
</span><span id=__span-0-713><a id=__codelineno-0-713 name=__codelineno-0-713></a><span class=sd>        - Comprehensive performance monitoring and statistics</span>
</span><span id=__span-0-714><a id=__codelineno-0-714 name=__codelineno-0-714></a><span class=sd>        - Automatic epoch transition handling</span>
</span><span id=__span-0-715><a id=__codelineno-0-715 name=__codelineno-0-715></a><span class=sd>        - Graceful shutdown and cleanup</span>
</span><span id=__span-0-716><a id=__codelineno-0-716 name=__codelineno-0-716></a><span class=sd>        - Real-time rate monitoring and reporting</span>
</span><span id=__span-0-717><a id=__codelineno-0-717 name=__codelineno-0-717></a><span class=sd>        - Error handling and recovery</span>
</span><span id=__span-0-718><a id=__codelineno-0-718 name=__codelineno-0-718></a>
</span><span id=__span-0-719><a id=__codelineno-0-719 name=__codelineno-0-719></a><span class=sd>    The prefetcher maintains a queue of pre-processed batches and provides</span>
</span><span id=__span-0-720><a id=__codelineno-0-720 name=__codelineno-0-720></a><span class=sd>    statistics about loading rates, memory usage, and processing times.</span>
</span><span id=__span-0-721><a id=__codelineno-0-721 name=__codelineno-0-721></a>
</span><span id=__span-0-722><a id=__codelineno-0-722 name=__codelineno-0-722></a><span class=sd>    Examples:</span>
</span><span id=__span-0-723><a id=__codelineno-0-723 name=__codelineno-0-723></a><span class=sd>            &gt;&gt;&gt; # Create prefetcher with a batch processor</span>
</span><span id=__span-0-724><a id=__codelineno-0-724 name=__codelineno-0-724></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-725><a id=__codelineno-0-725 name=__codelineno-0-725></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor, max_queue_size=100)</span>
</span><span id=__span-0-726><a id=__codelineno-0-726 name=__codelineno-0-726></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-727><a id=__codelineno-0-727 name=__codelineno-0-727></a><span class=sd>            &gt;&gt;&gt; # Start background processing</span>
</span><span id=__span-0-728><a id=__codelineno-0-728 name=__codelineno-0-728></a><span class=sd>            &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-729><a id=__codelineno-0-729 name=__codelineno-0-729></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-730><a id=__codelineno-0-730 name=__codelineno-0-730></a><span class=sd>            &gt;&gt;&gt; # Get pre-processed batches</span>
</span><span id=__span-0-731><a id=__codelineno-0-731 name=__codelineno-0-731></a><span class=sd>            &gt;&gt;&gt; batch = prefetcher.get_batch()</span>
</span><span id=__span-0-732><a id=__codelineno-0-732 name=__codelineno-0-732></a><span class=sd>            &gt;&gt;&gt; if batch:</span>
</span><span id=__span-0-733><a id=__codelineno-0-733 name=__codelineno-0-733></a><span class=sd>            ...     print(f&quot;Got batch {batch.batch_id} with {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-734><a id=__codelineno-0-734 name=__codelineno-0-734></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-735><a id=__codelineno-0-735 name=__codelineno-0-735></a><span class=sd>            &gt;&gt;&gt; # Check performance statistics</span>
</span><span id=__span-0-736><a id=__codelineno-0-736 name=__codelineno-0-736></a><span class=sd>            &gt;&gt;&gt; stats = prefetcher.get_stats()</span>
</span><span id=__span-0-737><a id=__codelineno-0-737 name=__codelineno-0-737></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Loading rate: {stats[&#39;cells_per_sec&#39;]:.1f} cells/sec&quot;)</span>
</span><span id=__span-0-738><a id=__codelineno-0-738 name=__codelineno-0-738></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-739><a id=__codelineno-0-739 name=__codelineno-0-739></a><span class=sd>            &gt;&gt;&gt; # Stop background processing</span>
</span><span id=__span-0-740><a id=__codelineno-0-740 name=__codelineno-0-740></a><span class=sd>            &gt;&gt;&gt; prefetcher.stop()</span>
</span><span id=__span-0-741><a id=__codelineno-0-741 name=__codelineno-0-741></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-742><a id=__codelineno-0-742 name=__codelineno-0-742></a>
</span><span id=__span-0-743><a id=__codelineno-0-743 name=__codelineno-0-743></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-744><a id=__codelineno-0-744 name=__codelineno-0-744></a>        <span class=bp>self</span><span class=p>,</span> <span class=n>batch_processor</span><span class=p>:</span> <span class=n>TileDBBatchProcessor</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span>
</span><span id=__span-0-745><a id=__codelineno-0-745 name=__codelineno-0-745></a>    <span class=p>):</span>
</span><span id=__span-0-746><a id=__codelineno-0-746 name=__codelineno-0-746></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-747><a id=__codelineno-0-747 name=__codelineno-0-747></a><span class=sd>        Initialize the TileDB async prefetcher with background processing.</span>
</span><span id=__span-0-748><a id=__codelineno-0-748 name=__codelineno-0-748></a>
</span><span id=__span-0-749><a id=__codelineno-0-749 name=__codelineno-0-749></a><span class=sd>        Args:</span>
</span><span id=__span-0-750><a id=__codelineno-0-750 name=__codelineno-0-750></a><span class=sd>            batch_processor: TileDBBatchProcessor instance to use for loading batches.</span>
</span><span id=__span-0-751><a id=__codelineno-0-751 name=__codelineno-0-751></a><span class=sd>                           Must be properly initialized with TileDB path and configuration.</span>
</span><span id=__span-0-752><a id=__codelineno-0-752 name=__codelineno-0-752></a><span class=sd>            max_queue_size: Maximum number of pre-processed batches to keep in queue.</span>
</span><span id=__span-0-753><a id=__codelineno-0-753 name=__codelineno-0-753></a><span class=sd>                          Higher values use more memory but provide better buffering.</span>
</span><span id=__span-0-754><a id=__codelineno-0-754 name=__codelineno-0-754></a><span class=sd>                          Range: 10-10000, default: 500.</span>
</span><span id=__span-0-755><a id=__codelineno-0-755 name=__codelineno-0-755></a>
</span><span id=__span-0-756><a id=__codelineno-0-756 name=__codelineno-0-756></a><span class=sd>        Examples:</span>
</span><span id=__span-0-757><a id=__codelineno-0-757 name=__codelineno-0-757></a><span class=sd>            &gt;&gt;&gt; # Create prefetcher with default queue size</span>
</span><span id=__span-0-758><a id=__codelineno-0-758 name=__codelineno-0-758></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-759><a id=__codelineno-0-759 name=__codelineno-0-759></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-760><a id=__codelineno-0-760 name=__codelineno-0-760></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Max queue size: {prefetcher.max_queue_size}&quot;)</span>
</span><span id=__span-0-761><a id=__codelineno-0-761 name=__codelineno-0-761></a><span class=sd>            Max queue size: 500</span>
</span><span id=__span-0-762><a id=__codelineno-0-762 name=__codelineno-0-762></a>
</span><span id=__span-0-763><a id=__codelineno-0-763 name=__codelineno-0-763></a><span class=sd>            &gt;&gt;&gt; # Create prefetcher with custom queue size</span>
</span><span id=__span-0-764><a id=__codelineno-0-764 name=__codelineno-0-764></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor, max_queue_size=1000)</span>
</span><span id=__span-0-765><a id=__codelineno-0-765 name=__codelineno-0-765></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Custom queue size: {prefetcher.max_queue_size}&quot;)</span>
</span><span id=__span-0-766><a id=__codelineno-0-766 name=__codelineno-0-766></a><span class=sd>            Custom queue size: 1000</span>
</span><span id=__span-0-767><a id=__codelineno-0-767 name=__codelineno-0-767></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-768><a id=__codelineno-0-768 name=__codelineno-0-768></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span> <span class=o>=</span> <span class=n>batch_processor</span>
</span><span id=__span-0-769><a id=__codelineno-0-769 name=__codelineno-0-769></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>
</span><span id=__span-0-770><a id=__codelineno-0-770 name=__codelineno-0-770></a>        <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=p>:</span> <span class=n>Queue</span><span class=p>[</span><span class=n>TileDBPrefetchBatch</span><span class=p>]</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>)</span>
</span><span id=__span-0-771><a id=__codelineno-0-771 name=__codelineno-0-771></a>        <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-772><a id=__codelineno-0-772 name=__codelineno-0-772></a>        <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-773><a id=__codelineno-0-773 name=__codelineno-0-773></a>
</span><span id=__span-0-774><a id=__codelineno-0-774 name=__codelineno-0-774></a>        <span class=c1># Monitoring stats</span>
</span><span id=__span-0-775><a id=__codelineno-0-775 name=__codelineno-0-775></a>        <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-776><a id=__codelineno-0-776 name=__codelineno-0-776></a>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-777><a id=__codelineno-0-777 name=__codelineno-0-777></a>        <span class=bp>self</span><span class=o>.</span><span class=n>last_rate_print</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-778><a id=__codelineno-0-778 name=__codelineno-0-778></a>        <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-0-779><a id=__codelineno-0-779 name=__codelineno-0-779></a>        <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-780><a id=__codelineno-0-780 name=__codelineno-0-780></a>        <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-781><a id=__codelineno-0-781 name=__codelineno-0-781></a>
</span><span id=__span-0-782><a id=__codelineno-0-782 name=__codelineno-0-782></a>    <span class=k>def</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-783><a id=__codelineno-0-783 name=__codelineno-0-783></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-784><a id=__codelineno-0-784 name=__codelineno-0-784></a><span class=sd>        Start the prefetching worker thread for background batch processing.</span>
</span><span id=__span-0-785><a id=__codelineno-0-785 name=__codelineno-0-785></a>
</span><span id=__span-0-786><a id=__codelineno-0-786 name=__codelineno-0-786></a><span class=sd>        This method starts a background worker thread that continuously loads</span>
</span><span id=__span-0-787><a id=__codelineno-0-787 name=__codelineno-0-787></a><span class=sd>        and processes batches from the TileDB batch processor. The worker thread</span>
</span><span id=__span-0-788><a id=__codelineno-0-788 name=__codelineno-0-788></a><span class=sd>        runs as a daemon thread and will automatically stop when the main</span>
</span><span id=__span-0-789><a id=__codelineno-0-789 name=__codelineno-0-789></a><span class=sd>        process exits.</span>
</span><span id=__span-0-790><a id=__codelineno-0-790 name=__codelineno-0-790></a>
</span><span id=__span-0-791><a id=__codelineno-0-791 name=__codelineno-0-791></a><span class=sd>        The prefetcher will begin loading batches immediately after starting.</span>
</span><span id=__span-0-792><a id=__codelineno-0-792 name=__codelineno-0-792></a><span class=sd>        Use get_batch() to retrieve pre-processed batches from the queue.</span>
</span><span id=__span-0-793><a id=__codelineno-0-793 name=__codelineno-0-793></a>
</span><span id=__span-0-794><a id=__codelineno-0-794 name=__codelineno-0-794></a><span class=sd>        Examples:</span>
</span><span id=__span-0-795><a id=__codelineno-0-795 name=__codelineno-0-795></a><span class=sd>            &gt;&gt;&gt; # Start background prefetching</span>
</span><span id=__span-0-796><a id=__codelineno-0-796 name=__codelineno-0-796></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-797><a id=__codelineno-0-797 name=__codelineno-0-797></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-798><a id=__codelineno-0-798 name=__codelineno-0-798></a><span class=sd>            &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-799><a id=__codelineno-0-799 name=__codelineno-0-799></a><span class=sd>            &gt;&gt;&gt; print(&quot;Prefetcher started&quot;)</span>
</span><span id=__span-0-800><a id=__codelineno-0-800 name=__codelineno-0-800></a><span class=sd>            Prefetcher started</span>
</span><span id=__span-0-801><a id=__codelineno-0-801 name=__codelineno-0-801></a>
</span><span id=__span-0-802><a id=__codelineno-0-802 name=__codelineno-0-802></a><span class=sd>            &gt;&gt;&gt; # Check if prefetcher is ready</span>
</span><span id=__span-0-803><a id=__codelineno-0-803 name=__codelineno-0-803></a><span class=sd>            &gt;&gt;&gt; import time</span>
</span><span id=__span-0-804><a id=__codelineno-0-804 name=__codelineno-0-804></a><span class=sd>            &gt;&gt;&gt; time.sleep(1)  # Wait for first batch</span>
</span><span id=__span-0-805><a id=__codelineno-0-805 name=__codelineno-0-805></a><span class=sd>            &gt;&gt;&gt; if prefetcher.has_batch():</span>
</span><span id=__span-0-806><a id=__codelineno-0-806 name=__codelineno-0-806></a><span class=sd>            ...     print(&quot;Prefetcher is ready with data&quot;)</span>
</span><span id=__span-0-807><a id=__codelineno-0-807 name=__codelineno-0-807></a><span class=sd>            ... else:</span>
</span><span id=__span-0-808><a id=__codelineno-0-808 name=__codelineno-0-808></a><span class=sd>            ...     print(&quot;Prefetcher not ready yet&quot;)</span>
</span><span id=__span-0-809><a id=__codelineno-0-809 name=__codelineno-0-809></a><span class=sd>            Prefetcher is ready with data</span>
</span><span id=__span-0-810><a id=__codelineno-0-810 name=__codelineno-0-810></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-811><a id=__codelineno-0-811 name=__codelineno-0-811></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span><span id=__span-0-812><a id=__codelineno-0-812 name=__codelineno-0-812></a>            <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-813><a id=__codelineno-0-813 name=__codelineno-0-813></a>            <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-814><a id=__codelineno-0-814 name=__codelineno-0-814></a>            <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span><span id=__span-0-815><a id=__codelineno-0-815 name=__codelineno-0-815></a>                <span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_prefetch_worker</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-816><a id=__codelineno-0-816 name=__codelineno-0-816></a>            <span class=p>)</span>
</span><span id=__span-0-817><a id=__codelineno-0-817 name=__codelineno-0-817></a>            <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-818><a id=__codelineno-0-818 name=__codelineno-0-818></a>
</span><span id=__span-0-819><a id=__codelineno-0-819 name=__codelineno-0-819></a>    <span class=k>def</span><span class=w> </span><span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-820><a id=__codelineno-0-820 name=__codelineno-0-820></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-821><a id=__codelineno-0-821 name=__codelineno-0-821></a><span class=sd>        Stop the prefetching worker thread and clean up resources.</span>
</span><span id=__span-0-822><a id=__codelineno-0-822 name=__codelineno-0-822></a>
</span><span id=__span-0-823><a id=__codelineno-0-823 name=__codelineno-0-823></a><span class=sd>        This method gracefully stops the background worker thread and waits</span>
</span><span id=__span-0-824><a id=__codelineno-0-824 name=__codelineno-0-824></a><span class=sd>        for it to finish processing the current batch. It sets the stop flag</span>
</span><span id=__span-0-825><a id=__codelineno-0-825 name=__codelineno-0-825></a><span class=sd>        and joins the thread with a timeout to prevent hanging.</span>
</span><span id=__span-0-826><a id=__codelineno-0-826 name=__codelineno-0-826></a>
</span><span id=__span-0-827><a id=__codelineno-0-827 name=__codelineno-0-827></a><span class=sd>        After calling stop(), the prefetcher will no longer load new batches.</span>
</span><span id=__span-0-828><a id=__codelineno-0-828 name=__codelineno-0-828></a><span class=sd>        Any remaining batches in the queue can still be retrieved with get_batch().</span>
</span><span id=__span-0-829><a id=__codelineno-0-829 name=__codelineno-0-829></a>
</span><span id=__span-0-830><a id=__codelineno-0-830 name=__codelineno-0-830></a><span class=sd>        Examples:</span>
</span><span id=__span-0-831><a id=__codelineno-0-831 name=__codelineno-0-831></a><span class=sd>            &gt;&gt;&gt; # Stop the prefetcher</span>
</span><span id=__span-0-832><a id=__codelineno-0-832 name=__codelineno-0-832></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-833><a id=__codelineno-0-833 name=__codelineno-0-833></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-834><a id=__codelineno-0-834 name=__codelineno-0-834></a><span class=sd>            &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-835><a id=__codelineno-0-835 name=__codelineno-0-835></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-836><a id=__codelineno-0-836 name=__codelineno-0-836></a><span class=sd>            &gt;&gt;&gt; # Do some work...</span>
</span><span id=__span-0-837><a id=__codelineno-0-837 name=__codelineno-0-837></a><span class=sd>            &gt;&gt;&gt; batch = prefetcher.get_batch()</span>
</span><span id=__span-0-838><a id=__codelineno-0-838 name=__codelineno-0-838></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-839><a id=__codelineno-0-839 name=__codelineno-0-839></a><span class=sd>            &gt;&gt;&gt; # Stop when done</span>
</span><span id=__span-0-840><a id=__codelineno-0-840 name=__codelineno-0-840></a><span class=sd>            &gt;&gt;&gt; prefetcher.stop()</span>
</span><span id=__span-0-841><a id=__codelineno-0-841 name=__codelineno-0-841></a><span class=sd>            &gt;&gt;&gt; print(&quot;Prefetcher stopped&quot;)</span>
</span><span id=__span-0-842><a id=__codelineno-0-842 name=__codelineno-0-842></a><span class=sd>            Prefetcher stopped</span>
</span><span id=__span-0-843><a id=__codelineno-0-843 name=__codelineno-0-843></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-844><a id=__codelineno-0-844 name=__codelineno-0-844></a>        <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-845><a id=__codelineno-0-845 name=__codelineno-0-845></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span><span id=__span-0-846><a id=__codelineno-0-846 name=__codelineno-0-846></a>            <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span><span id=__span-0-847><a id=__codelineno-0-847 name=__codelineno-0-847></a>
</span><span id=__span-0-848><a id=__codelineno-0-848 name=__codelineno-0-848></a>    <span class=k>def</span><span class=w> </span><span class=nf>_prefetch_worker</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-849><a id=__codelineno-0-849 name=__codelineno-0-849></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Worker thread that loads batches in background&quot;&quot;&quot;</span>
</span><span id=__span-0-850><a id=__codelineno-0-850 name=__codelineno-0-850></a>        <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span><span class=p>:</span>
</span><span id=__span-0-851><a id=__codelineno-0-851 name=__codelineno-0-851></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-852><a id=__codelineno-0-852 name=__codelineno-0-852></a>                <span class=c1># Load batch chunk</span>
</span><span id=__span-0-853><a id=__codelineno-0-853 name=__codelineno-0-853></a>                <span class=n>batch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>load_prefetch_batch</span><span class=p>()</span>
</span><span id=__span-0-854><a id=__codelineno-0-854 name=__codelineno-0-854></a>
</span><span id=__span-0-855><a id=__codelineno-0-855 name=__codelineno-0-855></a>                <span class=c1># Update monitoring stats</span>
</span><span id=__span-0-856><a id=__codelineno-0-856 name=__codelineno-0-856></a>                <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>cell_integer_ids</span><span class=p>)</span>
</span><span id=__span-0-857><a id=__codelineno-0-857 name=__codelineno-0-857></a>                <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span> <span class=o>+=</span> <span class=n>batch</span><span class=o>.</span><span class=n>process_time</span>
</span><span id=__span-0-858><a id=__codelineno-0-858 name=__codelineno-0-858></a>                <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-859><a id=__codelineno-0-859 name=__codelineno-0-859></a>                <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>current_epoch</span>
</span><span id=__span-0-860><a id=__codelineno-0-860 name=__codelineno-0-860></a>
</span><span id=__span-0-861><a id=__codelineno-0-861 name=__codelineno-0-861></a>                <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-862><a id=__codelineno-0-862 name=__codelineno-0-862></a>                <span class=n>rate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span> <span class=o>/</span> <span class=n>elapsed</span> <span class=k>if</span> <span class=n>elapsed</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-863><a id=__codelineno-0-863 name=__codelineno-0-863></a>
</span><span id=__span-0-864><a id=__codelineno-0-864 name=__codelineno-0-864></a>                <span class=c1># Print rate every 10 batches</span>
</span><span id=__span-0-865><a id=__codelineno-0-865 name=__codelineno-0-865></a>                <span class=k>if</span> <span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>%</span> <span class=mi>10</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span> <span class=o>&gt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>last_rate_print</span><span class=p>:</span>
</span><span id=__span-0-866><a id=__codelineno-0-866 name=__codelineno-0-866></a>                    <span class=n>avg_process_ms</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-867><a id=__codelineno-0-867 name=__codelineno-0-867></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span>
</span><span id=__span-0-868><a id=__codelineno-0-868 name=__codelineno-0-868></a>                    <span class=p>)</span> <span class=o>*</span> <span class=mi>1000</span>
</span><span id=__span-0-869><a id=__codelineno-0-869 name=__codelineno-0-869></a>                    <span class=n>rate_report</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;TileDB prefetch rate: </span><span class=si>{</span><span class=n>rate</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> cells/sec (epoch </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2>, total: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span><span class=si>}</span><span class=s2> cells, avg process: </span><span class=si>{</span><span class=n>avg_process_ms</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms)&quot;</span>
</span><span id=__span-0-870><a id=__codelineno-0-870 name=__codelineno-0-870></a>                    <span class=n>print_prefetch</span><span class=p>(</span><span class=n>rate_report</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span>
</span><span id=__span-0-871><a id=__codelineno-0-871 name=__codelineno-0-871></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>last_rate_print</span> <span class=o>=</span> <span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span>
</span><span id=__span-0-872><a id=__codelineno-0-872 name=__codelineno-0-872></a>
</span><span id=__span-0-873><a id=__codelineno-0-873 name=__codelineno-0-873></a>                <span class=c1># Put in queue</span>
</span><span id=__span-0-874><a id=__codelineno-0-874 name=__codelineno-0-874></a>                <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-875><a id=__codelineno-0-875 name=__codelineno-0-875></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>put_nowait</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-0-876><a id=__codelineno-0-876 name=__codelineno-0-876></a>                <span class=k>except</span> <span class=n>queue</span><span class=o>.</span><span class=n>Full</span><span class=p>:</span>
</span><span id=__span-0-877><a id=__codelineno-0-877 name=__codelineno-0-877></a>                    <span class=c1># Queue is full, wait a bit</span>
</span><span id=__span-0-878><a id=__codelineno-0-878 name=__codelineno-0-878></a>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span><span id=__span-0-879><a id=__codelineno-0-879 name=__codelineno-0-879></a>
</span><span id=__span-0-880><a id=__codelineno-0-880 name=__codelineno-0-880></a>            <span class=k>except</span> <span class=ne>StopIteration</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-881><a id=__codelineno-0-881 name=__codelineno-0-881></a>                <span class=k>if</span> <span class=s2>&quot;No more epochs available&quot;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>e</span><span class=p>):</span>
</span><span id=__span-0-882><a id=__codelineno-0-882 name=__codelineno-0-882></a>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-883><a id=__codelineno-0-883 name=__codelineno-0-883></a>                        <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-884><a id=__codelineno-0-884 name=__codelineno-0-884></a>                            <span class=sa>f</span><span class=s2>&quot; All </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>n_epochs</span><span class=si>}</span><span class=s2> epochs completed&quot;</span>
</span><span id=__span-0-885><a id=__codelineno-0-885 name=__codelineno-0-885></a>                        <span class=p>)</span>
</span><span id=__span-0-886><a id=__codelineno-0-886 name=__codelineno-0-886></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-887><a id=__codelineno-0-887 name=__codelineno-0-887></a>                    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Reached end of batches&quot;</span><span class=p>)</span>
</span><span id=__span-0-888><a id=__codelineno-0-888 name=__codelineno-0-888></a>                <span class=k>break</span>
</span><span id=__span-0-889><a id=__codelineno-0-889 name=__codelineno-0-889></a>            <span class=k>except</span> <span class=ne>Exception</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-890><a id=__codelineno-0-890 name=__codelineno-0-890></a>                <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error loading TileDB batch: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-891><a id=__codelineno-0-891 name=__codelineno-0-891></a>                <span class=k>break</span>
</span><span id=__span-0-892><a id=__codelineno-0-892 name=__codelineno-0-892></a>
</span><span id=__span-0-893><a id=__codelineno-0-893 name=__codelineno-0-893></a>    <span class=k>def</span><span class=w> </span><span class=nf>get_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>TileDBPrefetchBatch</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-894><a id=__codelineno-0-894 name=__codelineno-0-894></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-895><a id=__codelineno-0-895 name=__codelineno-0-895></a><span class=sd>        Get the next pre-processed batch from the queue.</span>
</span><span id=__span-0-896><a id=__codelineno-0-896 name=__codelineno-0-896></a>
</span><span id=__span-0-897><a id=__codelineno-0-897 name=__codelineno-0-897></a><span class=sd>        This method retrieves a pre-processed batch from the internal queue.</span>
</span><span id=__span-0-898><a id=__codelineno-0-898 name=__codelineno-0-898></a><span class=sd>        If no batch is available, it returns None. The method has a timeout</span>
</span><span id=__span-0-899><a id=__codelineno-0-899 name=__codelineno-0-899></a><span class=sd>        to prevent blocking indefinitely.</span>
</span><span id=__span-0-900><a id=__codelineno-0-900 name=__codelineno-0-900></a>
</span><span id=__span-0-901><a id=__codelineno-0-901 name=__codelineno-0-901></a><span class=sd>        Returns:</span>
</span><span id=__span-0-902><a id=__codelineno-0-902 name=__codelineno-0-902></a><span class=sd>            TileDBPrefetchBatch | None: The next available batch, or None if</span>
</span><span id=__span-0-903><a id=__codelineno-0-903 name=__codelineno-0-903></a><span class=sd>                                       no batch is available within the timeout.</span>
</span><span id=__span-0-904><a id=__codelineno-0-904 name=__codelineno-0-904></a>
</span><span id=__span-0-905><a id=__codelineno-0-905 name=__codelineno-0-905></a><span class=sd>        Examples:</span>
</span><span id=__span-0-906><a id=__codelineno-0-906 name=__codelineno-0-906></a><span class=sd>            &gt;&gt;&gt; # Get a batch from the prefetcher</span>
</span><span id=__span-0-907><a id=__codelineno-0-907 name=__codelineno-0-907></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-908><a id=__codelineno-0-908 name=__codelineno-0-908></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-909><a id=__codelineno-0-909 name=__codelineno-0-909></a><span class=sd>            &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-910><a id=__codelineno-0-910 name=__codelineno-0-910></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-911><a id=__codelineno-0-911 name=__codelineno-0-911></a><span class=sd>            &gt;&gt;&gt; # Wait for a batch</span>
</span><span id=__span-0-912><a id=__codelineno-0-912 name=__codelineno-0-912></a><span class=sd>            &gt;&gt;&gt; batch = prefetcher.get_batch()</span>
</span><span id=__span-0-913><a id=__codelineno-0-913 name=__codelineno-0-913></a><span class=sd>            &gt;&gt;&gt; if batch:</span>
</span><span id=__span-0-914><a id=__codelineno-0-914 name=__codelineno-0-914></a><span class=sd>            ...     print(f&quot;Got batch {batch.batch_id} with {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-915><a id=__codelineno-0-915 name=__codelineno-0-915></a><span class=sd>            ... else:</span>
</span><span id=__span-0-916><a id=__codelineno-0-916 name=__codelineno-0-916></a><span class=sd>            ...     print(&quot;No batch available&quot;)</span>
</span><span id=__span-0-917><a id=__codelineno-0-917 name=__codelineno-0-917></a><span class=sd>            Got batch 0 with 100 cells</span>
</span><span id=__span-0-918><a id=__codelineno-0-918 name=__codelineno-0-918></a>
</span><span id=__span-0-919><a id=__codelineno-0-919 name=__codelineno-0-919></a><span class=sd>            &gt;&gt;&gt; # Check for multiple batches</span>
</span><span id=__span-0-920><a id=__codelineno-0-920 name=__codelineno-0-920></a><span class=sd>            &gt;&gt;&gt; batches = []</span>
</span><span id=__span-0-921><a id=__codelineno-0-921 name=__codelineno-0-921></a><span class=sd>            &gt;&gt;&gt; for _ in range(3):</span>
</span><span id=__span-0-922><a id=__codelineno-0-922 name=__codelineno-0-922></a><span class=sd>            ...     batch = prefetcher.get_batch()</span>
</span><span id=__span-0-923><a id=__codelineno-0-923 name=__codelineno-0-923></a><span class=sd>            ...     if batch:</span>
</span><span id=__span-0-924><a id=__codelineno-0-924 name=__codelineno-0-924></a><span class=sd>            ...         batches.append(batch)</span>
</span><span id=__span-0-925><a id=__codelineno-0-925 name=__codelineno-0-925></a><span class=sd>            ...     else:</span>
</span><span id=__span-0-926><a id=__codelineno-0-926 name=__codelineno-0-926></a><span class=sd>            ...         break</span>
</span><span id=__span-0-927><a id=__codelineno-0-927 name=__codelineno-0-927></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Retrieved {len(batches)} batches&quot;)</span>
</span><span id=__span-0-928><a id=__codelineno-0-928 name=__codelineno-0-928></a><span class=sd>            Retrieved 3 batches</span>
</span><span id=__span-0-929><a id=__codelineno-0-929 name=__codelineno-0-929></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-930><a id=__codelineno-0-930 name=__codelineno-0-930></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-931><a id=__codelineno-0-931 name=__codelineno-0-931></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span><span id=__span-0-932><a id=__codelineno-0-932 name=__codelineno-0-932></a>        <span class=k>except</span> <span class=n>queue</span><span class=o>.</span><span class=n>Empty</span><span class=p>:</span>
</span><span id=__span-0-933><a id=__codelineno-0-933 name=__codelineno-0-933></a>            <span class=k>return</span> <span class=kc>None</span>
</span><span id=__span-0-934><a id=__codelineno-0-934 name=__codelineno-0-934></a>
</span><span id=__span-0-935><a id=__codelineno-0-935 name=__codelineno-0-935></a>    <span class=k>def</span><span class=w> </span><span class=nf>has_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-0-936><a id=__codelineno-0-936 name=__codelineno-0-936></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-937><a id=__codelineno-0-937 name=__codelineno-0-937></a><span class=sd>        Check if a pre-processed batch is available in the queue.</span>
</span><span id=__span-0-938><a id=__codelineno-0-938 name=__codelineno-0-938></a>
</span><span id=__span-0-939><a id=__codelineno-0-939 name=__codelineno-0-939></a><span class=sd>        This method provides a non-blocking way to check if batches are</span>
</span><span id=__span-0-940><a id=__codelineno-0-940 name=__codelineno-0-940></a><span class=sd>        available for immediate retrieval. It returns True if the queue</span>
</span><span id=__span-0-941><a id=__codelineno-0-941 name=__codelineno-0-941></a><span class=sd>        contains at least one batch, False otherwise.</span>
</span><span id=__span-0-942><a id=__codelineno-0-942 name=__codelineno-0-942></a>
</span><span id=__span-0-943><a id=__codelineno-0-943 name=__codelineno-0-943></a><span class=sd>        Returns:</span>
</span><span id=__span-0-944><a id=__codelineno-0-944 name=__codelineno-0-944></a><span class=sd>            bool: True if at least one batch is available, False otherwise.</span>
</span><span id=__span-0-945><a id=__codelineno-0-945 name=__codelineno-0-945></a>
</span><span id=__span-0-946><a id=__codelineno-0-946 name=__codelineno-0-946></a><span class=sd>        Examples:</span>
</span><span id=__span-0-947><a id=__codelineno-0-947 name=__codelineno-0-947></a><span class=sd>            &gt;&gt;&gt; # Check for available batches</span>
</span><span id=__span-0-948><a id=__codelineno-0-948 name=__codelineno-0-948></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-949><a id=__codelineno-0-949 name=__codelineno-0-949></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-950><a id=__codelineno-0-950 name=__codelineno-0-950></a><span class=sd>            &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-951><a id=__codelineno-0-951 name=__codelineno-0-951></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-952><a id=__codelineno-0-952 name=__codelineno-0-952></a><span class=sd>            &gt;&gt;&gt; # Check if batches are ready</span>
</span><span id=__span-0-953><a id=__codelineno-0-953 name=__codelineno-0-953></a><span class=sd>            &gt;&gt;&gt; if prefetcher.has_batch():</span>
</span><span id=__span-0-954><a id=__codelineno-0-954 name=__codelineno-0-954></a><span class=sd>            ...     batch = prefetcher.get_batch()</span>
</span><span id=__span-0-955><a id=__codelineno-0-955 name=__codelineno-0-955></a><span class=sd>            ...     print(f&quot;Processing batch {batch.batch_id}&quot;)</span>
</span><span id=__span-0-956><a id=__codelineno-0-956 name=__codelineno-0-956></a><span class=sd>            ... else:</span>
</span><span id=__span-0-957><a id=__codelineno-0-957 name=__codelineno-0-957></a><span class=sd>            ...     print(&quot;No batches ready yet&quot;)</span>
</span><span id=__span-0-958><a id=__codelineno-0-958 name=__codelineno-0-958></a><span class=sd>            No batches ready yet</span>
</span><span id=__span-0-959><a id=__codelineno-0-959 name=__codelineno-0-959></a>
</span><span id=__span-0-960><a id=__codelineno-0-960 name=__codelineno-0-960></a><span class=sd>            &gt;&gt;&gt; # Wait and check again</span>
</span><span id=__span-0-961><a id=__codelineno-0-961 name=__codelineno-0-961></a><span class=sd>            &gt;&gt;&gt; import time</span>
</span><span id=__span-0-962><a id=__codelineno-0-962 name=__codelineno-0-962></a><span class=sd>            &gt;&gt;&gt; time.sleep(2)</span>
</span><span id=__span-0-963><a id=__codelineno-0-963 name=__codelineno-0-963></a><span class=sd>            &gt;&gt;&gt; if prefetcher.has_batch():</span>
</span><span id=__span-0-964><a id=__codelineno-0-964 name=__codelineno-0-964></a><span class=sd>            ...     print(&quot;Batches are now available&quot;)</span>
</span><span id=__span-0-965><a id=__codelineno-0-965 name=__codelineno-0-965></a><span class=sd>            ... else:</span>
</span><span id=__span-0-966><a id=__codelineno-0-966 name=__codelineno-0-966></a><span class=sd>            ...     print(&quot;Still waiting for batches&quot;)</span>
</span><span id=__span-0-967><a id=__codelineno-0-967 name=__codelineno-0-967></a><span class=sd>            Batches are now available</span>
</span><span id=__span-0-968><a id=__codelineno-0-968 name=__codelineno-0-968></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-969><a id=__codelineno-0-969 name=__codelineno-0-969></a>        <span class=k>return</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>empty</span><span class=p>()</span>
</span><span id=__span-0-970><a id=__codelineno-0-970 name=__codelineno-0-970></a>
</span><span id=__span-0-971><a id=__codelineno-0-971 name=__codelineno-0-971></a>    <span class=k>def</span><span class=w> </span><span class=nf>get_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span><span id=__span-0-972><a id=__codelineno-0-972 name=__codelineno-0-972></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-973><a id=__codelineno-0-973 name=__codelineno-0-973></a><span class=sd>        Get comprehensive statistics about the prefetcher&#39;s performance.</span>
</span><span id=__span-0-974><a id=__codelineno-0-974 name=__codelineno-0-974></a>
</span><span id=__span-0-975><a id=__codelineno-0-975 name=__codelineno-0-975></a><span class=sd>        This method returns detailed performance statistics including loading</span>
</span><span id=__span-0-976><a id=__codelineno-0-976 name=__codelineno-0-976></a><span class=sd>        rates, memory usage, queue status, and processing times. Useful for</span>
</span><span id=__span-0-977><a id=__codelineno-0-977 name=__codelineno-0-977></a><span class=sd>        monitoring and debugging the prefetcher&#39;s performance.</span>
</span><span id=__span-0-978><a id=__codelineno-0-978 name=__codelineno-0-978></a>
</span><span id=__span-0-979><a id=__codelineno-0-979 name=__codelineno-0-979></a><span class=sd>        Returns:</span>
</span><span id=__span-0-980><a id=__codelineno-0-980 name=__codelineno-0-980></a><span class=sd>            dict: Performance statistics dictionary containing:</span>
</span><span id=__span-0-981><a id=__codelineno-0-981 name=__codelineno-0-981></a><span class=sd>                - total_cells: Total number of cells processed</span>
</span><span id=__span-0-982><a id=__codelineno-0-982 name=__codelineno-0-982></a><span class=sd>                - elapsed_time: Total time since prefetcher started (seconds)</span>
</span><span id=__span-0-983><a id=__codelineno-0-983 name=__codelineno-0-983></a><span class=sd>                - cells_per_sec: Average loading rate (cells per second)</span>
</span><span id=__span-0-984><a id=__codelineno-0-984 name=__codelineno-0-984></a><span class=sd>                - queue_size: Current number of batches in queue</span>
</span><span id=__span-0-985><a id=__codelineno-0-985 name=__codelineno-0-985></a><span class=sd>                - queue_full: Whether the queue is at maximum capacity</span>
</span><span id=__span-0-986><a id=__codelineno-0-986 name=__codelineno-0-986></a><span class=sd>                - total_process_time: Total time spent processing batches</span>
</span><span id=__span-0-987><a id=__codelineno-0-987 name=__codelineno-0-987></a><span class=sd>                - process_count: Number of batches processed</span>
</span><span id=__span-0-988><a id=__codelineno-0-988 name=__codelineno-0-988></a><span class=sd>                - avg_process_time_ms: Average processing time per batch (ms)</span>
</span><span id=__span-0-989><a id=__codelineno-0-989 name=__codelineno-0-989></a><span class=sd>                - current_epoch: Current epoch number</span>
</span><span id=__span-0-990><a id=__codelineno-0-990 name=__codelineno-0-990></a><span class=sd>                - n_epochs: Total number of epochs configured</span>
</span><span id=__span-0-991><a id=__codelineno-0-991 name=__codelineno-0-991></a>
</span><span id=__span-0-992><a id=__codelineno-0-992 name=__codelineno-0-992></a><span class=sd>        Examples:</span>
</span><span id=__span-0-993><a id=__codelineno-0-993 name=__codelineno-0-993></a><span class=sd>            &gt;&gt;&gt; # Get performance statistics</span>
</span><span id=__span-0-994><a id=__codelineno-0-994 name=__codelineno-0-994></a><span class=sd>            &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-995><a id=__codelineno-0-995 name=__codelineno-0-995></a><span class=sd>            &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-996><a id=__codelineno-0-996 name=__codelineno-0-996></a><span class=sd>            &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-997><a id=__codelineno-0-997 name=__codelineno-0-997></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-998><a id=__codelineno-0-998 name=__codelineno-0-998></a><span class=sd>            &gt;&gt;&gt; # Wait for some processing</span>
</span><span id=__span-0-999><a id=__codelineno-0-999 name=__codelineno-0-999></a><span class=sd>            &gt;&gt;&gt; import time</span>
</span><span id=__span-0-1000><a id=__codelineno-0-1000 name=__codelineno-0-1000></a><span class=sd>            &gt;&gt;&gt; time.sleep(5)</span>
</span><span id=__span-0-1001><a id=__codelineno-0-1001 name=__codelineno-0-1001></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-1002><a id=__codelineno-0-1002 name=__codelineno-0-1002></a><span class=sd>            &gt;&gt;&gt; # Get and display stats</span>
</span><span id=__span-0-1003><a id=__codelineno-0-1003 name=__codelineno-0-1003></a><span class=sd>            &gt;&gt;&gt; stats = prefetcher.get_stats()</span>
</span><span id=__span-0-1004><a id=__codelineno-0-1004 name=__codelineno-0-1004></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Loading rate: {stats[&#39;cells_per_sec&#39;]:.1f} cells/sec&quot;)</span>
</span><span id=__span-0-1005><a id=__codelineno-0-1005 name=__codelineno-0-1005></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Queue size: {stats[&#39;queue_size&#39;]}/{prefetcher.max_queue_size}&quot;)</span>
</span><span id=__span-0-1006><a id=__codelineno-0-1006 name=__codelineno-0-1006></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Current epoch: {stats[&#39;current_epoch&#39;]}/{stats[&#39;n_epochs&#39;]}&quot;)</span>
</span><span id=__span-0-1007><a id=__codelineno-0-1007 name=__codelineno-0-1007></a><span class=sd>            Loading rate: 1250.5 cells/sec</span>
</span><span id=__span-0-1008><a id=__codelineno-0-1008 name=__codelineno-0-1008></a><span class=sd>            Queue size: 45/500</span>
</span><span id=__span-0-1009><a id=__codelineno-0-1009 name=__codelineno-0-1009></a><span class=sd>            Current epoch: 0/1</span>
</span><span id=__span-0-1010><a id=__codelineno-0-1010 name=__codelineno-0-1010></a>
</span><span id=__span-0-1011><a id=__codelineno-0-1011 name=__codelineno-0-1011></a><span class=sd>            &gt;&gt;&gt; # Monitor performance over time</span>
</span><span id=__span-0-1012><a id=__codelineno-0-1012 name=__codelineno-0-1012></a><span class=sd>            &gt;&gt;&gt; for i in range(3):</span>
</span><span id=__span-0-1013><a id=__codelineno-0-1013 name=__codelineno-0-1013></a><span class=sd>            ...     stats = prefetcher.get_stats()</span>
</span><span id=__span-0-1014><a id=__codelineno-0-1014 name=__codelineno-0-1014></a><span class=sd>            ...     print(f&quot;Check {i+1}: {stats[&#39;cells_per_sec&#39;]:.1f} cells/sec&quot;)</span>
</span><span id=__span-0-1015><a id=__codelineno-0-1015 name=__codelineno-0-1015></a><span class=sd>            ...     time.sleep(2)</span>
</span><span id=__span-0-1016><a id=__codelineno-0-1016 name=__codelineno-0-1016></a><span class=sd>            Check 1: 1200.3 cells/sec</span>
</span><span id=__span-0-1017><a id=__codelineno-0-1017 name=__codelineno-0-1017></a><span class=sd>            Check 2: 1250.5 cells/sec</span>
</span><span id=__span-0-1018><a id=__codelineno-0-1018 name=__codelineno-0-1018></a><span class=sd>            Check 3: 1180.7 cells/sec</span>
</span><span id=__span-0-1019><a id=__codelineno-0-1019 name=__codelineno-0-1019></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1020><a id=__codelineno-0-1020 name=__codelineno-0-1020></a>        <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-1021><a id=__codelineno-0-1021 name=__codelineno-0-1021></a>        <span class=n>rate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span> <span class=o>/</span> <span class=n>elapsed</span> <span class=k>if</span> <span class=n>elapsed</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-1022><a id=__codelineno-0-1022 name=__codelineno-0-1022></a>        <span class=n>avg_process_time</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-1023><a id=__codelineno-0-1023 name=__codelineno-0-1023></a>            <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span>
</span><span id=__span-0-1024><a id=__codelineno-0-1024 name=__codelineno-0-1024></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span><span id=__span-0-1025><a id=__codelineno-0-1025 name=__codelineno-0-1025></a>            <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-1026><a id=__codelineno-0-1026 name=__codelineno-0-1026></a>        <span class=p>)</span>
</span><span id=__span-0-1027><a id=__codelineno-0-1027 name=__codelineno-0-1027></a>        <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-1028><a id=__codelineno-0-1028 name=__codelineno-0-1028></a>            <span class=s2>&quot;total_cells&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span><span class=p>,</span>
</span><span id=__span-0-1029><a id=__codelineno-0-1029 name=__codelineno-0-1029></a>            <span class=s2>&quot;elapsed_time&quot;</span><span class=p>:</span> <span class=n>elapsed</span><span class=p>,</span>
</span><span id=__span-0-1030><a id=__codelineno-0-1030 name=__codelineno-0-1030></a>            <span class=s2>&quot;cells_per_sec&quot;</span><span class=p>:</span> <span class=n>rate</span><span class=p>,</span>
</span><span id=__span-0-1031><a id=__codelineno-0-1031 name=__codelineno-0-1031></a>            <span class=s2>&quot;queue_size&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>qsize</span><span class=p>(),</span>
</span><span id=__span-0-1032><a id=__codelineno-0-1032 name=__codelineno-0-1032></a>            <span class=s2>&quot;queue_full&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>full</span><span class=p>(),</span>
</span><span id=__span-0-1033><a id=__codelineno-0-1033 name=__codelineno-0-1033></a>            <span class=s2>&quot;total_process_time&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span><span class=p>,</span>
</span><span id=__span-0-1034><a id=__codelineno-0-1034 name=__codelineno-0-1034></a>            <span class=s2>&quot;process_count&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span><span class=p>,</span>
</span><span id=__span-0-1035><a id=__codelineno-0-1035 name=__codelineno-0-1035></a>            <span class=s2>&quot;avg_process_time_ms&quot;</span><span class=p>:</span> <span class=n>avg_process_time</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-0-1036><a id=__codelineno-0-1036 name=__codelineno-0-1036></a>            <span class=s2>&quot;current_epoch&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=p>,</span>
</span><span id=__span-0-1037><a id=__codelineno-0-1037 name=__codelineno-0-1037></a>            <span class=s2>&quot;n_epochs&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>,</span>
</span><span id=__span-0-1038><a id=__codelineno-0-1038 name=__codelineno-0-1038></a>        <span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <h5 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher-functions>Functions<a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher-functions class=headerlink title="Permanent link">&para;</a></h5> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>batch_processor</span><span class=p>:</span> <span class=n>TileDBBatchProcessor</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>)</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.__init__ class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Initialize the TileDB async prefetcher with background processing.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>batch_processor</code> </td> <td> <code><a class="autorefs autorefs-internal" title="TileDBBatchProcessor (slaf.ml.tiledb_dataloaders.TileDBBatchProcessor)" href=#slaf.ml.tiledb_dataloaders.TileDBBatchProcessor>TileDBBatchProcessor</a></code> </td> <td> <div class=doc-md-description> <p>TileDBBatchProcessor instance to use for loading batches. Must be properly initialized with TileDB path and configuration.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>max_queue_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Maximum number of pre-processed batches to keep in queue. Higher values use more memory but provide better buffering. Range: 10-10000, default: 500.</p> </div> </td> <td> <code>500</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Create prefetcher with default queue size</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Max queue size: </span><span class=si>{</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>max_queue_size</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=go>Max queue size: 500</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Create prefetcher with custom queue size</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=o>=</span><span class=mi>1000</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Custom queue size: </span><span class=si>{</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>max_queue_size</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=go>Custom queue size: 1000</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-743>743</a></span>
<span class=normal><a href=#__codelineno-0-744>744</a></span>
<span class=normal><a href=#__codelineno-0-745>745</a></span>
<span class=normal><a href=#__codelineno-0-746>746</a></span>
<span class=normal><a href=#__codelineno-0-747>747</a></span>
<span class=normal><a href=#__codelineno-0-748>748</a></span>
<span class=normal><a href=#__codelineno-0-749>749</a></span>
<span class=normal><a href=#__codelineno-0-750>750</a></span>
<span class=normal><a href=#__codelineno-0-751>751</a></span>
<span class=normal><a href=#__codelineno-0-752>752</a></span>
<span class=normal><a href=#__codelineno-0-753>753</a></span>
<span class=normal><a href=#__codelineno-0-754>754</a></span>
<span class=normal><a href=#__codelineno-0-755>755</a></span>
<span class=normal><a href=#__codelineno-0-756>756</a></span>
<span class=normal><a href=#__codelineno-0-757>757</a></span>
<span class=normal><a href=#__codelineno-0-758>758</a></span>
<span class=normal><a href=#__codelineno-0-759>759</a></span>
<span class=normal><a href=#__codelineno-0-760>760</a></span>
<span class=normal><a href=#__codelineno-0-761>761</a></span>
<span class=normal><a href=#__codelineno-0-762>762</a></span>
<span class=normal><a href=#__codelineno-0-763>763</a></span>
<span class=normal><a href=#__codelineno-0-764>764</a></span>
<span class=normal><a href=#__codelineno-0-765>765</a></span>
<span class=normal><a href=#__codelineno-0-766>766</a></span>
<span class=normal><a href=#__codelineno-0-767>767</a></span>
<span class=normal><a href=#__codelineno-0-768>768</a></span>
<span class=normal><a href=#__codelineno-0-769>769</a></span>
<span class=normal><a href=#__codelineno-0-770>770</a></span>
<span class=normal><a href=#__codelineno-0-771>771</a></span>
<span class=normal><a href=#__codelineno-0-772>772</a></span>
<span class=normal><a href=#__codelineno-0-773>773</a></span>
<span class=normal><a href=#__codelineno-0-774>774</a></span>
<span class=normal><a href=#__codelineno-0-775>775</a></span>
<span class=normal><a href=#__codelineno-0-776>776</a></span>
<span class=normal><a href=#__codelineno-0-777>777</a></span>
<span class=normal><a href=#__codelineno-0-778>778</a></span>
<span class=normal><a href=#__codelineno-0-779>779</a></span>
<span class=normal><a href=#__codelineno-0-780>780</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-743><a id=__codelineno-0-743 name=__codelineno-0-743></a><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-744><a id=__codelineno-0-744 name=__codelineno-0-744></a>    <span class=bp>self</span><span class=p>,</span> <span class=n>batch_processor</span><span class=p>:</span> <span class=n>TileDBBatchProcessor</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span>
</span><span id=__span-0-745><a id=__codelineno-0-745 name=__codelineno-0-745></a><span class=p>):</span>
</span><span id=__span-0-746><a id=__codelineno-0-746 name=__codelineno-0-746></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-747><a id=__codelineno-0-747 name=__codelineno-0-747></a><span class=sd>    Initialize the TileDB async prefetcher with background processing.</span>
</span><span id=__span-0-748><a id=__codelineno-0-748 name=__codelineno-0-748></a>
</span><span id=__span-0-749><a id=__codelineno-0-749 name=__codelineno-0-749></a><span class=sd>    Args:</span>
</span><span id=__span-0-750><a id=__codelineno-0-750 name=__codelineno-0-750></a><span class=sd>        batch_processor: TileDBBatchProcessor instance to use for loading batches.</span>
</span><span id=__span-0-751><a id=__codelineno-0-751 name=__codelineno-0-751></a><span class=sd>                       Must be properly initialized with TileDB path and configuration.</span>
</span><span id=__span-0-752><a id=__codelineno-0-752 name=__codelineno-0-752></a><span class=sd>        max_queue_size: Maximum number of pre-processed batches to keep in queue.</span>
</span><span id=__span-0-753><a id=__codelineno-0-753 name=__codelineno-0-753></a><span class=sd>                      Higher values use more memory but provide better buffering.</span>
</span><span id=__span-0-754><a id=__codelineno-0-754 name=__codelineno-0-754></a><span class=sd>                      Range: 10-10000, default: 500.</span>
</span><span id=__span-0-755><a id=__codelineno-0-755 name=__codelineno-0-755></a>
</span><span id=__span-0-756><a id=__codelineno-0-756 name=__codelineno-0-756></a><span class=sd>    Examples:</span>
</span><span id=__span-0-757><a id=__codelineno-0-757 name=__codelineno-0-757></a><span class=sd>        &gt;&gt;&gt; # Create prefetcher with default queue size</span>
</span><span id=__span-0-758><a id=__codelineno-0-758 name=__codelineno-0-758></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-759><a id=__codelineno-0-759 name=__codelineno-0-759></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-760><a id=__codelineno-0-760 name=__codelineno-0-760></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Max queue size: {prefetcher.max_queue_size}&quot;)</span>
</span><span id=__span-0-761><a id=__codelineno-0-761 name=__codelineno-0-761></a><span class=sd>        Max queue size: 500</span>
</span><span id=__span-0-762><a id=__codelineno-0-762 name=__codelineno-0-762></a>
</span><span id=__span-0-763><a id=__codelineno-0-763 name=__codelineno-0-763></a><span class=sd>        &gt;&gt;&gt; # Create prefetcher with custom queue size</span>
</span><span id=__span-0-764><a id=__codelineno-0-764 name=__codelineno-0-764></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor, max_queue_size=1000)</span>
</span><span id=__span-0-765><a id=__codelineno-0-765 name=__codelineno-0-765></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Custom queue size: {prefetcher.max_queue_size}&quot;)</span>
</span><span id=__span-0-766><a id=__codelineno-0-766 name=__codelineno-0-766></a><span class=sd>        Custom queue size: 1000</span>
</span><span id=__span-0-767><a id=__codelineno-0-767 name=__codelineno-0-767></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-768><a id=__codelineno-0-768 name=__codelineno-0-768></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span> <span class=o>=</span> <span class=n>batch_processor</span>
</span><span id=__span-0-769><a id=__codelineno-0-769 name=__codelineno-0-769></a>    <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>
</span><span id=__span-0-770><a id=__codelineno-0-770 name=__codelineno-0-770></a>    <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=p>:</span> <span class=n>Queue</span><span class=p>[</span><span class=n>TileDBPrefetchBatch</span><span class=p>]</span> <span class=o>=</span> <span class=n>Queue</span><span class=p>(</span><span class=n>maxsize</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>)</span>
</span><span id=__span-0-771><a id=__codelineno-0-771 name=__codelineno-0-771></a>    <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-772><a id=__codelineno-0-772 name=__codelineno-0-772></a>    <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-773><a id=__codelineno-0-773 name=__codelineno-0-773></a>
</span><span id=__span-0-774><a id=__codelineno-0-774 name=__codelineno-0-774></a>    <span class=c1># Monitoring stats</span>
</span><span id=__span-0-775><a id=__codelineno-0-775 name=__codelineno-0-775></a>    <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-776><a id=__codelineno-0-776 name=__codelineno-0-776></a>    <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-0-777><a id=__codelineno-0-777 name=__codelineno-0-777></a>    <span class=bp>self</span><span class=o>.</span><span class=n>last_rate_print</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-778><a id=__codelineno-0-778 name=__codelineno-0-778></a>    <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-0-779><a id=__codelineno-0-779 name=__codelineno-0-779></a>    <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-780><a id=__codelineno-0-780 name=__codelineno-0-780></a>    <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span> <span class=o>=</span> <span class=mi>0</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.start class="doc doc-heading"> <code class="highlight language-python"><span class=n>start</span><span class=p>()</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.start class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Start the prefetching worker thread for background batch processing.</p> <p>This method starts a background worker thread that continuously loads and processes batches from the TileDB batch processor. The worker thread runs as a daemon thread and will automatically stop when the main process exits.</p> <p>The prefetcher will begin loading batches immediately after starting. Use get_batch() to retrieve pre-processed batches from the queue.</p> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Start background prefetching</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Prefetcher started&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Prefetcher started</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check if prefetcher is ready</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>  <span class=c1># Wait for first batch</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>has_batch</span><span class=p>():</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Prefetcher is ready with data&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Prefetcher not ready yet&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Prefetcher is ready with data</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-782>782</a></span>
<span class=normal><a href=#__codelineno-0-783>783</a></span>
<span class=normal><a href=#__codelineno-0-784>784</a></span>
<span class=normal><a href=#__codelineno-0-785>785</a></span>
<span class=normal><a href=#__codelineno-0-786>786</a></span>
<span class=normal><a href=#__codelineno-0-787>787</a></span>
<span class=normal><a href=#__codelineno-0-788>788</a></span>
<span class=normal><a href=#__codelineno-0-789>789</a></span>
<span class=normal><a href=#__codelineno-0-790>790</a></span>
<span class=normal><a href=#__codelineno-0-791>791</a></span>
<span class=normal><a href=#__codelineno-0-792>792</a></span>
<span class=normal><a href=#__codelineno-0-793>793</a></span>
<span class=normal><a href=#__codelineno-0-794>794</a></span>
<span class=normal><a href=#__codelineno-0-795>795</a></span>
<span class=normal><a href=#__codelineno-0-796>796</a></span>
<span class=normal><a href=#__codelineno-0-797>797</a></span>
<span class=normal><a href=#__codelineno-0-798>798</a></span>
<span class=normal><a href=#__codelineno-0-799>799</a></span>
<span class=normal><a href=#__codelineno-0-800>800</a></span>
<span class=normal><a href=#__codelineno-0-801>801</a></span>
<span class=normal><a href=#__codelineno-0-802>802</a></span>
<span class=normal><a href=#__codelineno-0-803>803</a></span>
<span class=normal><a href=#__codelineno-0-804>804</a></span>
<span class=normal><a href=#__codelineno-0-805>805</a></span>
<span class=normal><a href=#__codelineno-0-806>806</a></span>
<span class=normal><a href=#__codelineno-0-807>807</a></span>
<span class=normal><a href=#__codelineno-0-808>808</a></span>
<span class=normal><a href=#__codelineno-0-809>809</a></span>
<span class=normal><a href=#__codelineno-0-810>810</a></span>
<span class=normal><a href=#__codelineno-0-811>811</a></span>
<span class=normal><a href=#__codelineno-0-812>812</a></span>
<span class=normal><a href=#__codelineno-0-813>813</a></span>
<span class=normal><a href=#__codelineno-0-814>814</a></span>
<span class=normal><a href=#__codelineno-0-815>815</a></span>
<span class=normal><a href=#__codelineno-0-816>816</a></span>
<span class=normal><a href=#__codelineno-0-817>817</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-782><a id=__codelineno-0-782 name=__codelineno-0-782></a><span class=k>def</span><span class=w> </span><span class=nf>start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-783><a id=__codelineno-0-783 name=__codelineno-0-783></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-784><a id=__codelineno-0-784 name=__codelineno-0-784></a><span class=sd>    Start the prefetching worker thread for background batch processing.</span>
</span><span id=__span-0-785><a id=__codelineno-0-785 name=__codelineno-0-785></a>
</span><span id=__span-0-786><a id=__codelineno-0-786 name=__codelineno-0-786></a><span class=sd>    This method starts a background worker thread that continuously loads</span>
</span><span id=__span-0-787><a id=__codelineno-0-787 name=__codelineno-0-787></a><span class=sd>    and processes batches from the TileDB batch processor. The worker thread</span>
</span><span id=__span-0-788><a id=__codelineno-0-788 name=__codelineno-0-788></a><span class=sd>    runs as a daemon thread and will automatically stop when the main</span>
</span><span id=__span-0-789><a id=__codelineno-0-789 name=__codelineno-0-789></a><span class=sd>    process exits.</span>
</span><span id=__span-0-790><a id=__codelineno-0-790 name=__codelineno-0-790></a>
</span><span id=__span-0-791><a id=__codelineno-0-791 name=__codelineno-0-791></a><span class=sd>    The prefetcher will begin loading batches immediately after starting.</span>
</span><span id=__span-0-792><a id=__codelineno-0-792 name=__codelineno-0-792></a><span class=sd>    Use get_batch() to retrieve pre-processed batches from the queue.</span>
</span><span id=__span-0-793><a id=__codelineno-0-793 name=__codelineno-0-793></a>
</span><span id=__span-0-794><a id=__codelineno-0-794 name=__codelineno-0-794></a><span class=sd>    Examples:</span>
</span><span id=__span-0-795><a id=__codelineno-0-795 name=__codelineno-0-795></a><span class=sd>        &gt;&gt;&gt; # Start background prefetching</span>
</span><span id=__span-0-796><a id=__codelineno-0-796 name=__codelineno-0-796></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-797><a id=__codelineno-0-797 name=__codelineno-0-797></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-798><a id=__codelineno-0-798 name=__codelineno-0-798></a><span class=sd>        &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-799><a id=__codelineno-0-799 name=__codelineno-0-799></a><span class=sd>        &gt;&gt;&gt; print(&quot;Prefetcher started&quot;)</span>
</span><span id=__span-0-800><a id=__codelineno-0-800 name=__codelineno-0-800></a><span class=sd>        Prefetcher started</span>
</span><span id=__span-0-801><a id=__codelineno-0-801 name=__codelineno-0-801></a>
</span><span id=__span-0-802><a id=__codelineno-0-802 name=__codelineno-0-802></a><span class=sd>        &gt;&gt;&gt; # Check if prefetcher is ready</span>
</span><span id=__span-0-803><a id=__codelineno-0-803 name=__codelineno-0-803></a><span class=sd>        &gt;&gt;&gt; import time</span>
</span><span id=__span-0-804><a id=__codelineno-0-804 name=__codelineno-0-804></a><span class=sd>        &gt;&gt;&gt; time.sleep(1)  # Wait for first batch</span>
</span><span id=__span-0-805><a id=__codelineno-0-805 name=__codelineno-0-805></a><span class=sd>        &gt;&gt;&gt; if prefetcher.has_batch():</span>
</span><span id=__span-0-806><a id=__codelineno-0-806 name=__codelineno-0-806></a><span class=sd>        ...     print(&quot;Prefetcher is ready with data&quot;)</span>
</span><span id=__span-0-807><a id=__codelineno-0-807 name=__codelineno-0-807></a><span class=sd>        ... else:</span>
</span><span id=__span-0-808><a id=__codelineno-0-808 name=__codelineno-0-808></a><span class=sd>        ...     print(&quot;Prefetcher not ready yet&quot;)</span>
</span><span id=__span-0-809><a id=__codelineno-0-809 name=__codelineno-0-809></a><span class=sd>        Prefetcher is ready with data</span>
</span><span id=__span-0-810><a id=__codelineno-0-810 name=__codelineno-0-810></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-811><a id=__codelineno-0-811 name=__codelineno-0-811></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=ow>is</span> <span class=kc>None</span> <span class=ow>or</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span><span id=__span-0-812><a id=__codelineno-0-812 name=__codelineno-0-812></a>        <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span> <span class=o>=</span> <span class=kc>False</span>
</span><span id=__span-0-813><a id=__codelineno-0-813 name=__codelineno-0-813></a>        <span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-814><a id=__codelineno-0-814 name=__codelineno-0-814></a>        <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=o>=</span> <span class=n>threading</span><span class=o>.</span><span class=n>Thread</span><span class=p>(</span>
</span><span id=__span-0-815><a id=__codelineno-0-815 name=__codelineno-0-815></a>            <span class=n>target</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_prefetch_worker</span><span class=p>,</span> <span class=n>daemon</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-0-816><a id=__codelineno-0-816 name=__codelineno-0-816></a>        <span class=p>)</span>
</span><span id=__span-0-817><a id=__codelineno-0-817 name=__codelineno-0-817></a>        <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.stop class="doc doc-heading"> <code class="highlight language-python"><span class=n>stop</span><span class=p>()</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.stop class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Stop the prefetching worker thread and clean up resources.</p> <p>This method gracefully stops the background worker thread and waits for it to finish processing the current batch. It sets the stop flag and joins the thread with a timeout to prevent hanging.</p> <p>After calling stop(), the prefetcher will no longer load new batches. Any remaining batches in the queue can still be retrieved with get_batch().</p> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Stop the prefetcher</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Do some work...</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Stop when done</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Prefetcher stopped&quot;</span><span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>Prefetcher stopped</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-819>819</a></span>
<span class=normal><a href=#__codelineno-0-820>820</a></span>
<span class=normal><a href=#__codelineno-0-821>821</a></span>
<span class=normal><a href=#__codelineno-0-822>822</a></span>
<span class=normal><a href=#__codelineno-0-823>823</a></span>
<span class=normal><a href=#__codelineno-0-824>824</a></span>
<span class=normal><a href=#__codelineno-0-825>825</a></span>
<span class=normal><a href=#__codelineno-0-826>826</a></span>
<span class=normal><a href=#__codelineno-0-827>827</a></span>
<span class=normal><a href=#__codelineno-0-828>828</a></span>
<span class=normal><a href=#__codelineno-0-829>829</a></span>
<span class=normal><a href=#__codelineno-0-830>830</a></span>
<span class=normal><a href=#__codelineno-0-831>831</a></span>
<span class=normal><a href=#__codelineno-0-832>832</a></span>
<span class=normal><a href=#__codelineno-0-833>833</a></span>
<span class=normal><a href=#__codelineno-0-834>834</a></span>
<span class=normal><a href=#__codelineno-0-835>835</a></span>
<span class=normal><a href=#__codelineno-0-836>836</a></span>
<span class=normal><a href=#__codelineno-0-837>837</a></span>
<span class=normal><a href=#__codelineno-0-838>838</a></span>
<span class=normal><a href=#__codelineno-0-839>839</a></span>
<span class=normal><a href=#__codelineno-0-840>840</a></span>
<span class=normal><a href=#__codelineno-0-841>841</a></span>
<span class=normal><a href=#__codelineno-0-842>842</a></span>
<span class=normal><a href=#__codelineno-0-843>843</a></span>
<span class=normal><a href=#__codelineno-0-844>844</a></span>
<span class=normal><a href=#__codelineno-0-845>845</a></span>
<span class=normal><a href=#__codelineno-0-846>846</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-819><a id=__codelineno-0-819 name=__codelineno-0-819></a><span class=k>def</span><span class=w> </span><span class=nf>stop</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-820><a id=__codelineno-0-820 name=__codelineno-0-820></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-821><a id=__codelineno-0-821 name=__codelineno-0-821></a><span class=sd>    Stop the prefetching worker thread and clean up resources.</span>
</span><span id=__span-0-822><a id=__codelineno-0-822 name=__codelineno-0-822></a>
</span><span id=__span-0-823><a id=__codelineno-0-823 name=__codelineno-0-823></a><span class=sd>    This method gracefully stops the background worker thread and waits</span>
</span><span id=__span-0-824><a id=__codelineno-0-824 name=__codelineno-0-824></a><span class=sd>    for it to finish processing the current batch. It sets the stop flag</span>
</span><span id=__span-0-825><a id=__codelineno-0-825 name=__codelineno-0-825></a><span class=sd>    and joins the thread with a timeout to prevent hanging.</span>
</span><span id=__span-0-826><a id=__codelineno-0-826 name=__codelineno-0-826></a>
</span><span id=__span-0-827><a id=__codelineno-0-827 name=__codelineno-0-827></a><span class=sd>    After calling stop(), the prefetcher will no longer load new batches.</span>
</span><span id=__span-0-828><a id=__codelineno-0-828 name=__codelineno-0-828></a><span class=sd>    Any remaining batches in the queue can still be retrieved with get_batch().</span>
</span><span id=__span-0-829><a id=__codelineno-0-829 name=__codelineno-0-829></a>
</span><span id=__span-0-830><a id=__codelineno-0-830 name=__codelineno-0-830></a><span class=sd>    Examples:</span>
</span><span id=__span-0-831><a id=__codelineno-0-831 name=__codelineno-0-831></a><span class=sd>        &gt;&gt;&gt; # Stop the prefetcher</span>
</span><span id=__span-0-832><a id=__codelineno-0-832 name=__codelineno-0-832></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-833><a id=__codelineno-0-833 name=__codelineno-0-833></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-834><a id=__codelineno-0-834 name=__codelineno-0-834></a><span class=sd>        &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-835><a id=__codelineno-0-835 name=__codelineno-0-835></a><span class=sd>        &gt;&gt;&gt;</span>
</span><span id=__span-0-836><a id=__codelineno-0-836 name=__codelineno-0-836></a><span class=sd>        &gt;&gt;&gt; # Do some work...</span>
</span><span id=__span-0-837><a id=__codelineno-0-837 name=__codelineno-0-837></a><span class=sd>        &gt;&gt;&gt; batch = prefetcher.get_batch()</span>
</span><span id=__span-0-838><a id=__codelineno-0-838 name=__codelineno-0-838></a><span class=sd>        &gt;&gt;&gt;</span>
</span><span id=__span-0-839><a id=__codelineno-0-839 name=__codelineno-0-839></a><span class=sd>        &gt;&gt;&gt; # Stop when done</span>
</span><span id=__span-0-840><a id=__codelineno-0-840 name=__codelineno-0-840></a><span class=sd>        &gt;&gt;&gt; prefetcher.stop()</span>
</span><span id=__span-0-841><a id=__codelineno-0-841 name=__codelineno-0-841></a><span class=sd>        &gt;&gt;&gt; print(&quot;Prefetcher stopped&quot;)</span>
</span><span id=__span-0-842><a id=__codelineno-0-842 name=__codelineno-0-842></a><span class=sd>        Prefetcher stopped</span>
</span><span id=__span-0-843><a id=__codelineno-0-843 name=__codelineno-0-843></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-844><a id=__codelineno-0-844 name=__codelineno-0-844></a>    <span class=bp>self</span><span class=o>.</span><span class=n>should_stop</span> <span class=o>=</span> <span class=kc>True</span>
</span><span id=__span-0-845><a id=__codelineno-0-845 name=__codelineno-0-845></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>is_alive</span><span class=p>():</span>
</span><span id=__span-0-846><a id=__codelineno-0-846 name=__codelineno-0-846></a>        <span class=bp>self</span><span class=o>.</span><span class=n>worker_thread</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_batch class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_batch</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=n>TileDBPrefetchBatch</span> <span class=o>|</span> <span class=kc>None</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_batch class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Get the next pre-processed batch from the queue.</p> <p>This method retrieves a pre-processed batch from the internal queue. If no batch is available, it returns None. The method has a timeout to prevent blocking indefinitely.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><a class="autorefs autorefs-internal" title="TileDBPrefetchBatch


  
      dataclass
   (slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch)" href=#slaf.ml.tiledb_dataloaders.TileDBPrefetchBatch>TileDBPrefetchBatch</a> | None</code> </td> <td> <div class=doc-md-description> <p>TileDBPrefetchBatch | None: The next available batch, or None if no batch is available within the timeout.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Get a batch from the prefetcher</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Wait for a batch</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batch</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Got batch </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2> with </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>cell_integer_ids</span><span class=p>)</span><span class=si>}</span><span class=s2> cells&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;No batch available&quot;</span><span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>Got batch 0 with 100 cells</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check for multiple batches</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>batches</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=k>if</span> <span class=n>batch</span><span class=p>:</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>        <span class=n>batches</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>batch</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>        <span class=k>break</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Retrieved </span><span class=si>{</span><span class=nb>len</span><span class=p>(</span><span class=n>batches</span><span class=p>)</span><span class=si>}</span><span class=s2> batches&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=go>Retrieved 3 batches</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-893>893</a></span>
<span class=normal><a href=#__codelineno-0-894>894</a></span>
<span class=normal><a href=#__codelineno-0-895>895</a></span>
<span class=normal><a href=#__codelineno-0-896>896</a></span>
<span class=normal><a href=#__codelineno-0-897>897</a></span>
<span class=normal><a href=#__codelineno-0-898>898</a></span>
<span class=normal><a href=#__codelineno-0-899>899</a></span>
<span class=normal><a href=#__codelineno-0-900>900</a></span>
<span class=normal><a href=#__codelineno-0-901>901</a></span>
<span class=normal><a href=#__codelineno-0-902>902</a></span>
<span class=normal><a href=#__codelineno-0-903>903</a></span>
<span class=normal><a href=#__codelineno-0-904>904</a></span>
<span class=normal><a href=#__codelineno-0-905>905</a></span>
<span class=normal><a href=#__codelineno-0-906>906</a></span>
<span class=normal><a href=#__codelineno-0-907>907</a></span>
<span class=normal><a href=#__codelineno-0-908>908</a></span>
<span class=normal><a href=#__codelineno-0-909>909</a></span>
<span class=normal><a href=#__codelineno-0-910>910</a></span>
<span class=normal><a href=#__codelineno-0-911>911</a></span>
<span class=normal><a href=#__codelineno-0-912>912</a></span>
<span class=normal><a href=#__codelineno-0-913>913</a></span>
<span class=normal><a href=#__codelineno-0-914>914</a></span>
<span class=normal><a href=#__codelineno-0-915>915</a></span>
<span class=normal><a href=#__codelineno-0-916>916</a></span>
<span class=normal><a href=#__codelineno-0-917>917</a></span>
<span class=normal><a href=#__codelineno-0-918>918</a></span>
<span class=normal><a href=#__codelineno-0-919>919</a></span>
<span class=normal><a href=#__codelineno-0-920>920</a></span>
<span class=normal><a href=#__codelineno-0-921>921</a></span>
<span class=normal><a href=#__codelineno-0-922>922</a></span>
<span class=normal><a href=#__codelineno-0-923>923</a></span>
<span class=normal><a href=#__codelineno-0-924>924</a></span>
<span class=normal><a href=#__codelineno-0-925>925</a></span>
<span class=normal><a href=#__codelineno-0-926>926</a></span>
<span class=normal><a href=#__codelineno-0-927>927</a></span>
<span class=normal><a href=#__codelineno-0-928>928</a></span>
<span class=normal><a href=#__codelineno-0-929>929</a></span>
<span class=normal><a href=#__codelineno-0-930>930</a></span>
<span class=normal><a href=#__codelineno-0-931>931</a></span>
<span class=normal><a href=#__codelineno-0-932>932</a></span>
<span class=normal><a href=#__codelineno-0-933>933</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-893><a id=__codelineno-0-893 name=__codelineno-0-893></a><span class=k>def</span><span class=w> </span><span class=nf>get_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>TileDBPrefetchBatch</span> <span class=o>|</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-894><a id=__codelineno-0-894 name=__codelineno-0-894></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-895><a id=__codelineno-0-895 name=__codelineno-0-895></a><span class=sd>    Get the next pre-processed batch from the queue.</span>
</span><span id=__span-0-896><a id=__codelineno-0-896 name=__codelineno-0-896></a>
</span><span id=__span-0-897><a id=__codelineno-0-897 name=__codelineno-0-897></a><span class=sd>    This method retrieves a pre-processed batch from the internal queue.</span>
</span><span id=__span-0-898><a id=__codelineno-0-898 name=__codelineno-0-898></a><span class=sd>    If no batch is available, it returns None. The method has a timeout</span>
</span><span id=__span-0-899><a id=__codelineno-0-899 name=__codelineno-0-899></a><span class=sd>    to prevent blocking indefinitely.</span>
</span><span id=__span-0-900><a id=__codelineno-0-900 name=__codelineno-0-900></a>
</span><span id=__span-0-901><a id=__codelineno-0-901 name=__codelineno-0-901></a><span class=sd>    Returns:</span>
</span><span id=__span-0-902><a id=__codelineno-0-902 name=__codelineno-0-902></a><span class=sd>        TileDBPrefetchBatch | None: The next available batch, or None if</span>
</span><span id=__span-0-903><a id=__codelineno-0-903 name=__codelineno-0-903></a><span class=sd>                                   no batch is available within the timeout.</span>
</span><span id=__span-0-904><a id=__codelineno-0-904 name=__codelineno-0-904></a>
</span><span id=__span-0-905><a id=__codelineno-0-905 name=__codelineno-0-905></a><span class=sd>    Examples:</span>
</span><span id=__span-0-906><a id=__codelineno-0-906 name=__codelineno-0-906></a><span class=sd>        &gt;&gt;&gt; # Get a batch from the prefetcher</span>
</span><span id=__span-0-907><a id=__codelineno-0-907 name=__codelineno-0-907></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-908><a id=__codelineno-0-908 name=__codelineno-0-908></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-909><a id=__codelineno-0-909 name=__codelineno-0-909></a><span class=sd>        &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-910><a id=__codelineno-0-910 name=__codelineno-0-910></a><span class=sd>        &gt;&gt;&gt;</span>
</span><span id=__span-0-911><a id=__codelineno-0-911 name=__codelineno-0-911></a><span class=sd>        &gt;&gt;&gt; # Wait for a batch</span>
</span><span id=__span-0-912><a id=__codelineno-0-912 name=__codelineno-0-912></a><span class=sd>        &gt;&gt;&gt; batch = prefetcher.get_batch()</span>
</span><span id=__span-0-913><a id=__codelineno-0-913 name=__codelineno-0-913></a><span class=sd>        &gt;&gt;&gt; if batch:</span>
</span><span id=__span-0-914><a id=__codelineno-0-914 name=__codelineno-0-914></a><span class=sd>        ...     print(f&quot;Got batch {batch.batch_id} with {len(batch.cell_integer_ids)} cells&quot;)</span>
</span><span id=__span-0-915><a id=__codelineno-0-915 name=__codelineno-0-915></a><span class=sd>        ... else:</span>
</span><span id=__span-0-916><a id=__codelineno-0-916 name=__codelineno-0-916></a><span class=sd>        ...     print(&quot;No batch available&quot;)</span>
</span><span id=__span-0-917><a id=__codelineno-0-917 name=__codelineno-0-917></a><span class=sd>        Got batch 0 with 100 cells</span>
</span><span id=__span-0-918><a id=__codelineno-0-918 name=__codelineno-0-918></a>
</span><span id=__span-0-919><a id=__codelineno-0-919 name=__codelineno-0-919></a><span class=sd>        &gt;&gt;&gt; # Check for multiple batches</span>
</span><span id=__span-0-920><a id=__codelineno-0-920 name=__codelineno-0-920></a><span class=sd>        &gt;&gt;&gt; batches = []</span>
</span><span id=__span-0-921><a id=__codelineno-0-921 name=__codelineno-0-921></a><span class=sd>        &gt;&gt;&gt; for _ in range(3):</span>
</span><span id=__span-0-922><a id=__codelineno-0-922 name=__codelineno-0-922></a><span class=sd>        ...     batch = prefetcher.get_batch()</span>
</span><span id=__span-0-923><a id=__codelineno-0-923 name=__codelineno-0-923></a><span class=sd>        ...     if batch:</span>
</span><span id=__span-0-924><a id=__codelineno-0-924 name=__codelineno-0-924></a><span class=sd>        ...         batches.append(batch)</span>
</span><span id=__span-0-925><a id=__codelineno-0-925 name=__codelineno-0-925></a><span class=sd>        ...     else:</span>
</span><span id=__span-0-926><a id=__codelineno-0-926 name=__codelineno-0-926></a><span class=sd>        ...         break</span>
</span><span id=__span-0-927><a id=__codelineno-0-927 name=__codelineno-0-927></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Retrieved {len(batches)} batches&quot;)</span>
</span><span id=__span-0-928><a id=__codelineno-0-928 name=__codelineno-0-928></a><span class=sd>        Retrieved 3 batches</span>
</span><span id=__span-0-929><a id=__codelineno-0-929 name=__codelineno-0-929></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-930><a id=__codelineno-0-930 name=__codelineno-0-930></a>    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-931><a id=__codelineno-0-931 name=__codelineno-0-931></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>timeout</span><span class=o>=</span><span class=mf>1.0</span><span class=p>)</span>
</span><span id=__span-0-932><a id=__codelineno-0-932 name=__codelineno-0-932></a>    <span class=k>except</span> <span class=n>queue</span><span class=o>.</span><span class=n>Empty</span><span class=p>:</span>
</span><span id=__span-0-933><a id=__codelineno-0-933 name=__codelineno-0-933></a>        <span class=k>return</span> <span class=kc>None</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.has_batch class="doc doc-heading"> <code class="highlight language-python"><span class=n>has_batch</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>bool</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.has_batch class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Check if a pre-processed batch is available in the queue.</p> <p>This method provides a non-blocking way to check if batches are available for immediate retrieval. It returns True if the queue contains at least one batch, False otherwise.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>bool</code></td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>True if at least one batch is available, False otherwise.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check for available batches</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Check if batches are ready</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>has_batch</span><span class=p>():</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>    <span class=n>batch</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Processing batch </span><span class=si>{</span><span class=n>batch</span><span class=o>.</span><span class=n>batch_id</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;No batches ready yet&quot;</span><span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>No batches ready yet</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Wait and check again</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=k>if</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>has_batch</span><span class=p>():</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Batches are now available&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Still waiting for batches&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Batches are now available</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-935>935</a></span>
<span class=normal><a href=#__codelineno-0-936>936</a></span>
<span class=normal><a href=#__codelineno-0-937>937</a></span>
<span class=normal><a href=#__codelineno-0-938>938</a></span>
<span class=normal><a href=#__codelineno-0-939>939</a></span>
<span class=normal><a href=#__codelineno-0-940>940</a></span>
<span class=normal><a href=#__codelineno-0-941>941</a></span>
<span class=normal><a href=#__codelineno-0-942>942</a></span>
<span class=normal><a href=#__codelineno-0-943>943</a></span>
<span class=normal><a href=#__codelineno-0-944>944</a></span>
<span class=normal><a href=#__codelineno-0-945>945</a></span>
<span class=normal><a href=#__codelineno-0-946>946</a></span>
<span class=normal><a href=#__codelineno-0-947>947</a></span>
<span class=normal><a href=#__codelineno-0-948>948</a></span>
<span class=normal><a href=#__codelineno-0-949>949</a></span>
<span class=normal><a href=#__codelineno-0-950>950</a></span>
<span class=normal><a href=#__codelineno-0-951>951</a></span>
<span class=normal><a href=#__codelineno-0-952>952</a></span>
<span class=normal><a href=#__codelineno-0-953>953</a></span>
<span class=normal><a href=#__codelineno-0-954>954</a></span>
<span class=normal><a href=#__codelineno-0-955>955</a></span>
<span class=normal><a href=#__codelineno-0-956>956</a></span>
<span class=normal><a href=#__codelineno-0-957>957</a></span>
<span class=normal><a href=#__codelineno-0-958>958</a></span>
<span class=normal><a href=#__codelineno-0-959>959</a></span>
<span class=normal><a href=#__codelineno-0-960>960</a></span>
<span class=normal><a href=#__codelineno-0-961>961</a></span>
<span class=normal><a href=#__codelineno-0-962>962</a></span>
<span class=normal><a href=#__codelineno-0-963>963</a></span>
<span class=normal><a href=#__codelineno-0-964>964</a></span>
<span class=normal><a href=#__codelineno-0-965>965</a></span>
<span class=normal><a href=#__codelineno-0-966>966</a></span>
<span class=normal><a href=#__codelineno-0-967>967</a></span>
<span class=normal><a href=#__codelineno-0-968>968</a></span>
<span class=normal><a href=#__codelineno-0-969>969</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-935><a id=__codelineno-0-935 name=__codelineno-0-935></a><span class=k>def</span><span class=w> </span><span class=nf>has_batch</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
</span><span id=__span-0-936><a id=__codelineno-0-936 name=__codelineno-0-936></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-937><a id=__codelineno-0-937 name=__codelineno-0-937></a><span class=sd>    Check if a pre-processed batch is available in the queue.</span>
</span><span id=__span-0-938><a id=__codelineno-0-938 name=__codelineno-0-938></a>
</span><span id=__span-0-939><a id=__codelineno-0-939 name=__codelineno-0-939></a><span class=sd>    This method provides a non-blocking way to check if batches are</span>
</span><span id=__span-0-940><a id=__codelineno-0-940 name=__codelineno-0-940></a><span class=sd>    available for immediate retrieval. It returns True if the queue</span>
</span><span id=__span-0-941><a id=__codelineno-0-941 name=__codelineno-0-941></a><span class=sd>    contains at least one batch, False otherwise.</span>
</span><span id=__span-0-942><a id=__codelineno-0-942 name=__codelineno-0-942></a>
</span><span id=__span-0-943><a id=__codelineno-0-943 name=__codelineno-0-943></a><span class=sd>    Returns:</span>
</span><span id=__span-0-944><a id=__codelineno-0-944 name=__codelineno-0-944></a><span class=sd>        bool: True if at least one batch is available, False otherwise.</span>
</span><span id=__span-0-945><a id=__codelineno-0-945 name=__codelineno-0-945></a>
</span><span id=__span-0-946><a id=__codelineno-0-946 name=__codelineno-0-946></a><span class=sd>    Examples:</span>
</span><span id=__span-0-947><a id=__codelineno-0-947 name=__codelineno-0-947></a><span class=sd>        &gt;&gt;&gt; # Check for available batches</span>
</span><span id=__span-0-948><a id=__codelineno-0-948 name=__codelineno-0-948></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-949><a id=__codelineno-0-949 name=__codelineno-0-949></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-950><a id=__codelineno-0-950 name=__codelineno-0-950></a><span class=sd>        &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-951><a id=__codelineno-0-951 name=__codelineno-0-951></a><span class=sd>        &gt;&gt;&gt;</span>
</span><span id=__span-0-952><a id=__codelineno-0-952 name=__codelineno-0-952></a><span class=sd>        &gt;&gt;&gt; # Check if batches are ready</span>
</span><span id=__span-0-953><a id=__codelineno-0-953 name=__codelineno-0-953></a><span class=sd>        &gt;&gt;&gt; if prefetcher.has_batch():</span>
</span><span id=__span-0-954><a id=__codelineno-0-954 name=__codelineno-0-954></a><span class=sd>        ...     batch = prefetcher.get_batch()</span>
</span><span id=__span-0-955><a id=__codelineno-0-955 name=__codelineno-0-955></a><span class=sd>        ...     print(f&quot;Processing batch {batch.batch_id}&quot;)</span>
</span><span id=__span-0-956><a id=__codelineno-0-956 name=__codelineno-0-956></a><span class=sd>        ... else:</span>
</span><span id=__span-0-957><a id=__codelineno-0-957 name=__codelineno-0-957></a><span class=sd>        ...     print(&quot;No batches ready yet&quot;)</span>
</span><span id=__span-0-958><a id=__codelineno-0-958 name=__codelineno-0-958></a><span class=sd>        No batches ready yet</span>
</span><span id=__span-0-959><a id=__codelineno-0-959 name=__codelineno-0-959></a>
</span><span id=__span-0-960><a id=__codelineno-0-960 name=__codelineno-0-960></a><span class=sd>        &gt;&gt;&gt; # Wait and check again</span>
</span><span id=__span-0-961><a id=__codelineno-0-961 name=__codelineno-0-961></a><span class=sd>        &gt;&gt;&gt; import time</span>
</span><span id=__span-0-962><a id=__codelineno-0-962 name=__codelineno-0-962></a><span class=sd>        &gt;&gt;&gt; time.sleep(2)</span>
</span><span id=__span-0-963><a id=__codelineno-0-963 name=__codelineno-0-963></a><span class=sd>        &gt;&gt;&gt; if prefetcher.has_batch():</span>
</span><span id=__span-0-964><a id=__codelineno-0-964 name=__codelineno-0-964></a><span class=sd>        ...     print(&quot;Batches are now available&quot;)</span>
</span><span id=__span-0-965><a id=__codelineno-0-965 name=__codelineno-0-965></a><span class=sd>        ... else:</span>
</span><span id=__span-0-966><a id=__codelineno-0-966 name=__codelineno-0-966></a><span class=sd>        ...     print(&quot;Still waiting for batches&quot;)</span>
</span><span id=__span-0-967><a id=__codelineno-0-967 name=__codelineno-0-967></a><span class=sd>        Batches are now available</span>
</span><span id=__span-0-968><a id=__codelineno-0-968 name=__codelineno-0-968></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-969><a id=__codelineno-0-969 name=__codelineno-0-969></a>    <span class=k>return</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>empty</span><span class=p>()</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_stats class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_stats</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>dict</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBAsyncPrefetcher.get_stats class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Get comprehensive statistics about the prefetcher's performance.</p> <p>This method returns detailed performance statistics including loading rates, memory usage, queue status, and processing times. Useful for monitoring and debugging the prefetcher's performance.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>dict</code></td> <td> <code><span title=dict>dict</span></code> </td> <td> <div class=doc-md-description> <p>Performance statistics dictionary containing: - total_cells: Total number of cells processed - elapsed_time: Total time since prefetcher started (seconds) - cells_per_sec: Average loading rate (cells per second) - queue_size: Current number of batches in queue - queue_full: Whether the queue is at maximum capacity - total_process_time: Total time spent processing batches - process_count: Number of batches processed - avg_process_time_ms: Average processing time per batch (ms) - current_epoch: Current epoch number - n_epochs: Total number of epochs configured</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Get performance statistics</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span><span class=n>processor</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Wait for some processing</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=kn>import</span><span class=w> </span><span class=nn>time</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Get and display stats</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>&gt;&gt;&gt; </span><span class=n>stats</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_stats</span><span class=p>()</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Loading rate: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;cells_per_sec&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> cells/sec&quot;</span><span class=p>)</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Queue size: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;queue_size&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>max_queue_size</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Current epoch: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;current_epoch&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;n_epochs&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=go>Loading rate: 1250.5 cells/sec</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=go>Queue size: 45/500</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=go>Current epoch: 0/1</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Monitor performance over time</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>3</span><span class=p>):</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>stats</span> <span class=o>=</span> <span class=n>prefetcher</span><span class=o>.</span><span class=n>get_stats</span><span class=p>()</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Check </span><span class=si>{</span><span class=n>i</span><span class=o>+</span><span class=mi>1</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;cells_per_sec&#39;</span><span class=p>]</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2> cells/sec&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Check 1: 1200.3 cells/sec</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Check 2: 1250.5 cells/sec</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Check 3: 1180.7 cells/sec</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-971> 971</a></span>
<span class=normal><a href=#__codelineno-0-972> 972</a></span>
<span class=normal><a href=#__codelineno-0-973> 973</a></span>
<span class=normal><a href=#__codelineno-0-974> 974</a></span>
<span class=normal><a href=#__codelineno-0-975> 975</a></span>
<span class=normal><a href=#__codelineno-0-976> 976</a></span>
<span class=normal><a href=#__codelineno-0-977> 977</a></span>
<span class=normal><a href=#__codelineno-0-978> 978</a></span>
<span class=normal><a href=#__codelineno-0-979> 979</a></span>
<span class=normal><a href=#__codelineno-0-980> 980</a></span>
<span class=normal><a href=#__codelineno-0-981> 981</a></span>
<span class=normal><a href=#__codelineno-0-982> 982</a></span>
<span class=normal><a href=#__codelineno-0-983> 983</a></span>
<span class=normal><a href=#__codelineno-0-984> 984</a></span>
<span class=normal><a href=#__codelineno-0-985> 985</a></span>
<span class=normal><a href=#__codelineno-0-986> 986</a></span>
<span class=normal><a href=#__codelineno-0-987> 987</a></span>
<span class=normal><a href=#__codelineno-0-988> 988</a></span>
<span class=normal><a href=#__codelineno-0-989> 989</a></span>
<span class=normal><a href=#__codelineno-0-990> 990</a></span>
<span class=normal><a href=#__codelineno-0-991> 991</a></span>
<span class=normal><a href=#__codelineno-0-992> 992</a></span>
<span class=normal><a href=#__codelineno-0-993> 993</a></span>
<span class=normal><a href=#__codelineno-0-994> 994</a></span>
<span class=normal><a href=#__codelineno-0-995> 995</a></span>
<span class=normal><a href=#__codelineno-0-996> 996</a></span>
<span class=normal><a href=#__codelineno-0-997> 997</a></span>
<span class=normal><a href=#__codelineno-0-998> 998</a></span>
<span class=normal><a href=#__codelineno-0-999> 999</a></span>
<span class=normal><a href=#__codelineno-0-1000>1000</a></span>
<span class=normal><a href=#__codelineno-0-1001>1001</a></span>
<span class=normal><a href=#__codelineno-0-1002>1002</a></span>
<span class=normal><a href=#__codelineno-0-1003>1003</a></span>
<span class=normal><a href=#__codelineno-0-1004>1004</a></span>
<span class=normal><a href=#__codelineno-0-1005>1005</a></span>
<span class=normal><a href=#__codelineno-0-1006>1006</a></span>
<span class=normal><a href=#__codelineno-0-1007>1007</a></span>
<span class=normal><a href=#__codelineno-0-1008>1008</a></span>
<span class=normal><a href=#__codelineno-0-1009>1009</a></span>
<span class=normal><a href=#__codelineno-0-1010>1010</a></span>
<span class=normal><a href=#__codelineno-0-1011>1011</a></span>
<span class=normal><a href=#__codelineno-0-1012>1012</a></span>
<span class=normal><a href=#__codelineno-0-1013>1013</a></span>
<span class=normal><a href=#__codelineno-0-1014>1014</a></span>
<span class=normal><a href=#__codelineno-0-1015>1015</a></span>
<span class=normal><a href=#__codelineno-0-1016>1016</a></span>
<span class=normal><a href=#__codelineno-0-1017>1017</a></span>
<span class=normal><a href=#__codelineno-0-1018>1018</a></span>
<span class=normal><a href=#__codelineno-0-1019>1019</a></span>
<span class=normal><a href=#__codelineno-0-1020>1020</a></span>
<span class=normal><a href=#__codelineno-0-1021>1021</a></span>
<span class=normal><a href=#__codelineno-0-1022>1022</a></span>
<span class=normal><a href=#__codelineno-0-1023>1023</a></span>
<span class=normal><a href=#__codelineno-0-1024>1024</a></span>
<span class=normal><a href=#__codelineno-0-1025>1025</a></span>
<span class=normal><a href=#__codelineno-0-1026>1026</a></span>
<span class=normal><a href=#__codelineno-0-1027>1027</a></span>
<span class=normal><a href=#__codelineno-0-1028>1028</a></span>
<span class=normal><a href=#__codelineno-0-1029>1029</a></span>
<span class=normal><a href=#__codelineno-0-1030>1030</a></span>
<span class=normal><a href=#__codelineno-0-1031>1031</a></span>
<span class=normal><a href=#__codelineno-0-1032>1032</a></span>
<span class=normal><a href=#__codelineno-0-1033>1033</a></span>
<span class=normal><a href=#__codelineno-0-1034>1034</a></span>
<span class=normal><a href=#__codelineno-0-1035>1035</a></span>
<span class=normal><a href=#__codelineno-0-1036>1036</a></span>
<span class=normal><a href=#__codelineno-0-1037>1037</a></span>
<span class=normal><a href=#__codelineno-0-1038>1038</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-971><a id=__codelineno-0-971 name=__codelineno-0-971></a><span class=k>def</span><span class=w> </span><span class=nf>get_stats</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span><span id=__span-0-972><a id=__codelineno-0-972 name=__codelineno-0-972></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-973><a id=__codelineno-0-973 name=__codelineno-0-973></a><span class=sd>    Get comprehensive statistics about the prefetcher&#39;s performance.</span>
</span><span id=__span-0-974><a id=__codelineno-0-974 name=__codelineno-0-974></a>
</span><span id=__span-0-975><a id=__codelineno-0-975 name=__codelineno-0-975></a><span class=sd>    This method returns detailed performance statistics including loading</span>
</span><span id=__span-0-976><a id=__codelineno-0-976 name=__codelineno-0-976></a><span class=sd>    rates, memory usage, queue status, and processing times. Useful for</span>
</span><span id=__span-0-977><a id=__codelineno-0-977 name=__codelineno-0-977></a><span class=sd>    monitoring and debugging the prefetcher&#39;s performance.</span>
</span><span id=__span-0-978><a id=__codelineno-0-978 name=__codelineno-0-978></a>
</span><span id=__span-0-979><a id=__codelineno-0-979 name=__codelineno-0-979></a><span class=sd>    Returns:</span>
</span><span id=__span-0-980><a id=__codelineno-0-980 name=__codelineno-0-980></a><span class=sd>        dict: Performance statistics dictionary containing:</span>
</span><span id=__span-0-981><a id=__codelineno-0-981 name=__codelineno-0-981></a><span class=sd>            - total_cells: Total number of cells processed</span>
</span><span id=__span-0-982><a id=__codelineno-0-982 name=__codelineno-0-982></a><span class=sd>            - elapsed_time: Total time since prefetcher started (seconds)</span>
</span><span id=__span-0-983><a id=__codelineno-0-983 name=__codelineno-0-983></a><span class=sd>            - cells_per_sec: Average loading rate (cells per second)</span>
</span><span id=__span-0-984><a id=__codelineno-0-984 name=__codelineno-0-984></a><span class=sd>            - queue_size: Current number of batches in queue</span>
</span><span id=__span-0-985><a id=__codelineno-0-985 name=__codelineno-0-985></a><span class=sd>            - queue_full: Whether the queue is at maximum capacity</span>
</span><span id=__span-0-986><a id=__codelineno-0-986 name=__codelineno-0-986></a><span class=sd>            - total_process_time: Total time spent processing batches</span>
</span><span id=__span-0-987><a id=__codelineno-0-987 name=__codelineno-0-987></a><span class=sd>            - process_count: Number of batches processed</span>
</span><span id=__span-0-988><a id=__codelineno-0-988 name=__codelineno-0-988></a><span class=sd>            - avg_process_time_ms: Average processing time per batch (ms)</span>
</span><span id=__span-0-989><a id=__codelineno-0-989 name=__codelineno-0-989></a><span class=sd>            - current_epoch: Current epoch number</span>
</span><span id=__span-0-990><a id=__codelineno-0-990 name=__codelineno-0-990></a><span class=sd>            - n_epochs: Total number of epochs configured</span>
</span><span id=__span-0-991><a id=__codelineno-0-991 name=__codelineno-0-991></a>
</span><span id=__span-0-992><a id=__codelineno-0-992 name=__codelineno-0-992></a><span class=sd>    Examples:</span>
</span><span id=__span-0-993><a id=__codelineno-0-993 name=__codelineno-0-993></a><span class=sd>        &gt;&gt;&gt; # Get performance statistics</span>
</span><span id=__span-0-994><a id=__codelineno-0-994 name=__codelineno-0-994></a><span class=sd>        &gt;&gt;&gt; processor = TileDBBatchProcessor(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-995><a id=__codelineno-0-995 name=__codelineno-0-995></a><span class=sd>        &gt;&gt;&gt; prefetcher = TileDBAsyncPrefetcher(processor)</span>
</span><span id=__span-0-996><a id=__codelineno-0-996 name=__codelineno-0-996></a><span class=sd>        &gt;&gt;&gt; prefetcher.start()</span>
</span><span id=__span-0-997><a id=__codelineno-0-997 name=__codelineno-0-997></a><span class=sd>        &gt;&gt;&gt;</span>
</span><span id=__span-0-998><a id=__codelineno-0-998 name=__codelineno-0-998></a><span class=sd>        &gt;&gt;&gt; # Wait for some processing</span>
</span><span id=__span-0-999><a id=__codelineno-0-999 name=__codelineno-0-999></a><span class=sd>        &gt;&gt;&gt; import time</span>
</span><span id=__span-0-1000><a id=__codelineno-0-1000 name=__codelineno-0-1000></a><span class=sd>        &gt;&gt;&gt; time.sleep(5)</span>
</span><span id=__span-0-1001><a id=__codelineno-0-1001 name=__codelineno-0-1001></a><span class=sd>        &gt;&gt;&gt;</span>
</span><span id=__span-0-1002><a id=__codelineno-0-1002 name=__codelineno-0-1002></a><span class=sd>        &gt;&gt;&gt; # Get and display stats</span>
</span><span id=__span-0-1003><a id=__codelineno-0-1003 name=__codelineno-0-1003></a><span class=sd>        &gt;&gt;&gt; stats = prefetcher.get_stats()</span>
</span><span id=__span-0-1004><a id=__codelineno-0-1004 name=__codelineno-0-1004></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Loading rate: {stats[&#39;cells_per_sec&#39;]:.1f} cells/sec&quot;)</span>
</span><span id=__span-0-1005><a id=__codelineno-0-1005 name=__codelineno-0-1005></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Queue size: {stats[&#39;queue_size&#39;]}/{prefetcher.max_queue_size}&quot;)</span>
</span><span id=__span-0-1006><a id=__codelineno-0-1006 name=__codelineno-0-1006></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Current epoch: {stats[&#39;current_epoch&#39;]}/{stats[&#39;n_epochs&#39;]}&quot;)</span>
</span><span id=__span-0-1007><a id=__codelineno-0-1007 name=__codelineno-0-1007></a><span class=sd>        Loading rate: 1250.5 cells/sec</span>
</span><span id=__span-0-1008><a id=__codelineno-0-1008 name=__codelineno-0-1008></a><span class=sd>        Queue size: 45/500</span>
</span><span id=__span-0-1009><a id=__codelineno-0-1009 name=__codelineno-0-1009></a><span class=sd>        Current epoch: 0/1</span>
</span><span id=__span-0-1010><a id=__codelineno-0-1010 name=__codelineno-0-1010></a>
</span><span id=__span-0-1011><a id=__codelineno-0-1011 name=__codelineno-0-1011></a><span class=sd>        &gt;&gt;&gt; # Monitor performance over time</span>
</span><span id=__span-0-1012><a id=__codelineno-0-1012 name=__codelineno-0-1012></a><span class=sd>        &gt;&gt;&gt; for i in range(3):</span>
</span><span id=__span-0-1013><a id=__codelineno-0-1013 name=__codelineno-0-1013></a><span class=sd>        ...     stats = prefetcher.get_stats()</span>
</span><span id=__span-0-1014><a id=__codelineno-0-1014 name=__codelineno-0-1014></a><span class=sd>        ...     print(f&quot;Check {i+1}: {stats[&#39;cells_per_sec&#39;]:.1f} cells/sec&quot;)</span>
</span><span id=__span-0-1015><a id=__codelineno-0-1015 name=__codelineno-0-1015></a><span class=sd>        ...     time.sleep(2)</span>
</span><span id=__span-0-1016><a id=__codelineno-0-1016 name=__codelineno-0-1016></a><span class=sd>        Check 1: 1200.3 cells/sec</span>
</span><span id=__span-0-1017><a id=__codelineno-0-1017 name=__codelineno-0-1017></a><span class=sd>        Check 2: 1250.5 cells/sec</span>
</span><span id=__span-0-1018><a id=__codelineno-0-1018 name=__codelineno-0-1018></a><span class=sd>        Check 3: 1180.7 cells/sec</span>
</span><span id=__span-0-1019><a id=__codelineno-0-1019 name=__codelineno-0-1019></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-1020><a id=__codelineno-0-1020 name=__codelineno-0-1020></a>    <span class=n>elapsed</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>start_time</span> <span class=ow>or</span> <span class=mi>0</span><span class=p>)</span>
</span><span id=__span-0-1021><a id=__codelineno-0-1021 name=__codelineno-0-1021></a>    <span class=n>rate</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span> <span class=o>/</span> <span class=n>elapsed</span> <span class=k>if</span> <span class=n>elapsed</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-1022><a id=__codelineno-0-1022 name=__codelineno-0-1022></a>    <span class=n>avg_process_time</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-1023><a id=__codelineno-0-1023 name=__codelineno-0-1023></a>        <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span>
</span><span id=__span-0-1024><a id=__codelineno-0-1024 name=__codelineno-0-1024></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span><span id=__span-0-1025><a id=__codelineno-0-1025 name=__codelineno-0-1025></a>        <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-1026><a id=__codelineno-0-1026 name=__codelineno-0-1026></a>    <span class=p>)</span>
</span><span id=__span-0-1027><a id=__codelineno-0-1027 name=__codelineno-0-1027></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-1028><a id=__codelineno-0-1028 name=__codelineno-0-1028></a>        <span class=s2>&quot;total_cells&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_cells_added</span><span class=p>,</span>
</span><span id=__span-0-1029><a id=__codelineno-0-1029 name=__codelineno-0-1029></a>        <span class=s2>&quot;elapsed_time&quot;</span><span class=p>:</span> <span class=n>elapsed</span><span class=p>,</span>
</span><span id=__span-0-1030><a id=__codelineno-0-1030 name=__codelineno-0-1030></a>        <span class=s2>&quot;cells_per_sec&quot;</span><span class=p>:</span> <span class=n>rate</span><span class=p>,</span>
</span><span id=__span-0-1031><a id=__codelineno-0-1031 name=__codelineno-0-1031></a>        <span class=s2>&quot;queue_size&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>qsize</span><span class=p>(),</span>
</span><span id=__span-0-1032><a id=__codelineno-0-1032 name=__codelineno-0-1032></a>        <span class=s2>&quot;queue_full&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>queue</span><span class=o>.</span><span class=n>full</span><span class=p>(),</span>
</span><span id=__span-0-1033><a id=__codelineno-0-1033 name=__codelineno-0-1033></a>        <span class=s2>&quot;total_process_time&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>total_process_time</span><span class=p>,</span>
</span><span id=__span-0-1034><a id=__codelineno-0-1034 name=__codelineno-0-1034></a>        <span class=s2>&quot;process_count&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_count</span><span class=p>,</span>
</span><span id=__span-0-1035><a id=__codelineno-0-1035 name=__codelineno-0-1035></a>        <span class=s2>&quot;avg_process_time_ms&quot;</span><span class=p>:</span> <span class=n>avg_process_time</span> <span class=o>*</span> <span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-0-1036><a id=__codelineno-0-1036 name=__codelineno-0-1036></a>        <span class=s2>&quot;current_epoch&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_epoch</span><span class=p>,</span>
</span><span id=__span-0-1037><a id=__codelineno-0-1037 name=__codelineno-0-1037></a>        <span class=s2>&quot;n_epochs&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>n_epochs</span><span class=p>,</span>
</span><span id=__span-0-1038><a id=__codelineno-0-1038 name=__codelineno-0-1038></a>    <span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tiledb_dataloaders.TileDBIterableDataset class="doc doc-heading"> <code>TileDBIterableDataset</code> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p class="doc doc-class-bases"> Bases: <code><span title=torch.utils.data.IterableDataset>IterableDataset</span></code></p> <p>PyTorch IterableDataset for streaming TileDB SOMA data with async prefetching.</p> <p>TileDBIterableDataset provides a PyTorch-compatible interface for streaming single-cell data from TileDB SOMA format. It combines the TileDBBatchProcessor and TileDBAsyncPrefetcher to provide efficient, asynchronous data loading for machine learning training.</p> <details class=key-features open> <summary>Key Features</summary> <ul> <li>PyTorch IterableDataset compatibility</li> <li>Asynchronous background prefetching for improved throughput</li> <li>Multiple loading strategies (MoS and sequential)</li> <li>Multi-epoch training support</li> <li>Automatic epoch transition handling</li> <li>Memory-efficient streaming</li> <li>Comprehensive error handling</li> <li>Configurable batch and prefetch sizes</li> </ul> </details> <p>The dataset automatically manages background prefetching and provides seamless iteration over batches of TileDB data. It handles epoch transitions and provides detailed timing information for performance monitoring.</p> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Create dataset with default MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataset</span> <span class=o>=</span> <span class=n>TileDBIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt;</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Iterate through batches</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>:</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch keys: </span><span class=si>{</span><span class=nb>list</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cell IDs: </span><span class=si>{</span><span class=n>batch</span><span class=p>[</span><span class=s1>&#39;cell_ids&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=gp>... </span>    <span class=k>break</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code>Batch keys: [&#39;X&#39;, &#39;cell_ids&#39;]
Cell IDs: [0, 1, 2, ..., 29, 30, 31]

&gt;&gt;&gt; # Sequential loading for maximum throughput
&gt;&gt;&gt; dataset = TileDBIterableDataset(
...     tiledb_path=&quot;path/to/experiment&quot;,
...     use_mixture_of_scanners=False,
...     batch_size=64
... )
&gt;&gt;&gt; print(f&quot;MoS enabled: {dataset.use_mixture_of_scanners}&quot;)
MoS enabled: False

&gt;&gt;&gt; # Multi-epoch training
&gt;&gt;&gt; dataset = TileDBIterableDataset(
...     tiledb_path=&quot;path/to/experiment&quot;,
...     n_epochs=3
... )
&gt;&gt;&gt; epochs_seen = set()
&gt;&gt;&gt; for batch in dataset:
...     if &#39;epoch&#39; in batch:
...         epochs_seen.add(batch[&#39;epoch&#39;])
...     if len(epochs_seen) &gt;= 3:
...         break
&gt;&gt;&gt; print(f&quot;Epochs completed: {sorted(epochs_seen)}&quot;)
Epochs completed: [0, 1, 2]
</code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1041>1041</a></span>
<span class=normal><a href=#__codelineno-0-1042>1042</a></span>
<span class=normal><a href=#__codelineno-0-1043>1043</a></span>
<span class=normal><a href=#__codelineno-0-1044>1044</a></span>
<span class=normal><a href=#__codelineno-0-1045>1045</a></span>
<span class=normal><a href=#__codelineno-0-1046>1046</a></span>
<span class=normal><a href=#__codelineno-0-1047>1047</a></span>
<span class=normal><a href=#__codelineno-0-1048>1048</a></span>
<span class=normal><a href=#__codelineno-0-1049>1049</a></span>
<span class=normal><a href=#__codelineno-0-1050>1050</a></span>
<span class=normal><a href=#__codelineno-0-1051>1051</a></span>
<span class=normal><a href=#__codelineno-0-1052>1052</a></span>
<span class=normal><a href=#__codelineno-0-1053>1053</a></span>
<span class=normal><a href=#__codelineno-0-1054>1054</a></span>
<span class=normal><a href=#__codelineno-0-1055>1055</a></span>
<span class=normal><a href=#__codelineno-0-1056>1056</a></span>
<span class=normal><a href=#__codelineno-0-1057>1057</a></span>
<span class=normal><a href=#__codelineno-0-1058>1058</a></span>
<span class=normal><a href=#__codelineno-0-1059>1059</a></span>
<span class=normal><a href=#__codelineno-0-1060>1060</a></span>
<span class=normal><a href=#__codelineno-0-1061>1061</a></span>
<span class=normal><a href=#__codelineno-0-1062>1062</a></span>
<span class=normal><a href=#__codelineno-0-1063>1063</a></span>
<span class=normal><a href=#__codelineno-0-1064>1064</a></span>
<span class=normal><a href=#__codelineno-0-1065>1065</a></span>
<span class=normal><a href=#__codelineno-0-1066>1066</a></span>
<span class=normal><a href=#__codelineno-0-1067>1067</a></span>
<span class=normal><a href=#__codelineno-0-1068>1068</a></span>
<span class=normal><a href=#__codelineno-0-1069>1069</a></span>
<span class=normal><a href=#__codelineno-0-1070>1070</a></span>
<span class=normal><a href=#__codelineno-0-1071>1071</a></span>
<span class=normal><a href=#__codelineno-0-1072>1072</a></span>
<span class=normal><a href=#__codelineno-0-1073>1073</a></span>
<span class=normal><a href=#__codelineno-0-1074>1074</a></span>
<span class=normal><a href=#__codelineno-0-1075>1075</a></span>
<span class=normal><a href=#__codelineno-0-1076>1076</a></span>
<span class=normal><a href=#__codelineno-0-1077>1077</a></span>
<span class=normal><a href=#__codelineno-0-1078>1078</a></span>
<span class=normal><a href=#__codelineno-0-1079>1079</a></span>
<span class=normal><a href=#__codelineno-0-1080>1080</a></span>
<span class=normal><a href=#__codelineno-0-1081>1081</a></span>
<span class=normal><a href=#__codelineno-0-1082>1082</a></span>
<span class=normal><a href=#__codelineno-0-1083>1083</a></span>
<span class=normal><a href=#__codelineno-0-1084>1084</a></span>
<span class=normal><a href=#__codelineno-0-1085>1085</a></span>
<span class=normal><a href=#__codelineno-0-1086>1086</a></span>
<span class=normal><a href=#__codelineno-0-1087>1087</a></span>
<span class=normal><a href=#__codelineno-0-1088>1088</a></span>
<span class=normal><a href=#__codelineno-0-1089>1089</a></span>
<span class=normal><a href=#__codelineno-0-1090>1090</a></span>
<span class=normal><a href=#__codelineno-0-1091>1091</a></span>
<span class=normal><a href=#__codelineno-0-1092>1092</a></span>
<span class=normal><a href=#__codelineno-0-1093>1093</a></span>
<span class=normal><a href=#__codelineno-0-1094>1094</a></span>
<span class=normal><a href=#__codelineno-0-1095>1095</a></span>
<span class=normal><a href=#__codelineno-0-1096>1096</a></span>
<span class=normal><a href=#__codelineno-0-1097>1097</a></span>
<span class=normal><a href=#__codelineno-0-1098>1098</a></span>
<span class=normal><a href=#__codelineno-0-1099>1099</a></span>
<span class=normal><a href=#__codelineno-0-1100>1100</a></span>
<span class=normal><a href=#__codelineno-0-1101>1101</a></span>
<span class=normal><a href=#__codelineno-0-1102>1102</a></span>
<span class=normal><a href=#__codelineno-0-1103>1103</a></span>
<span class=normal><a href=#__codelineno-0-1104>1104</a></span>
<span class=normal><a href=#__codelineno-0-1105>1105</a></span>
<span class=normal><a href=#__codelineno-0-1106>1106</a></span>
<span class=normal><a href=#__codelineno-0-1107>1107</a></span>
<span class=normal><a href=#__codelineno-0-1108>1108</a></span>
<span class=normal><a href=#__codelineno-0-1109>1109</a></span>
<span class=normal><a href=#__codelineno-0-1110>1110</a></span>
<span class=normal><a href=#__codelineno-0-1111>1111</a></span>
<span class=normal><a href=#__codelineno-0-1112>1112</a></span>
<span class=normal><a href=#__codelineno-0-1113>1113</a></span>
<span class=normal><a href=#__codelineno-0-1114>1114</a></span>
<span class=normal><a href=#__codelineno-0-1115>1115</a></span>
<span class=normal><a href=#__codelineno-0-1116>1116</a></span>
<span class=normal><a href=#__codelineno-0-1117>1117</a></span>
<span class=normal><a href=#__codelineno-0-1118>1118</a></span>
<span class=normal><a href=#__codelineno-0-1119>1119</a></span>
<span class=normal><a href=#__codelineno-0-1120>1120</a></span>
<span class=normal><a href=#__codelineno-0-1121>1121</a></span>
<span class=normal><a href=#__codelineno-0-1122>1122</a></span>
<span class=normal><a href=#__codelineno-0-1123>1123</a></span>
<span class=normal><a href=#__codelineno-0-1124>1124</a></span>
<span class=normal><a href=#__codelineno-0-1125>1125</a></span>
<span class=normal><a href=#__codelineno-0-1126>1126</a></span>
<span class=normal><a href=#__codelineno-0-1127>1127</a></span>
<span class=normal><a href=#__codelineno-0-1128>1128</a></span>
<span class=normal><a href=#__codelineno-0-1129>1129</a></span>
<span class=normal><a href=#__codelineno-0-1130>1130</a></span>
<span class=normal><a href=#__codelineno-0-1131>1131</a></span>
<span class=normal><a href=#__codelineno-0-1132>1132</a></span>
<span class=normal><a href=#__codelineno-0-1133>1133</a></span>
<span class=normal><a href=#__codelineno-0-1134>1134</a></span>
<span class=normal><a href=#__codelineno-0-1135>1135</a></span>
<span class=normal><a href=#__codelineno-0-1136>1136</a></span>
<span class=normal><a href=#__codelineno-0-1137>1137</a></span>
<span class=normal><a href=#__codelineno-0-1138>1138</a></span>
<span class=normal><a href=#__codelineno-0-1139>1139</a></span>
<span class=normal><a href=#__codelineno-0-1140>1140</a></span>
<span class=normal><a href=#__codelineno-0-1141>1141</a></span>
<span class=normal><a href=#__codelineno-0-1142>1142</a></span>
<span class=normal><a href=#__codelineno-0-1143>1143</a></span>
<span class=normal><a href=#__codelineno-0-1144>1144</a></span>
<span class=normal><a href=#__codelineno-0-1145>1145</a></span>
<span class=normal><a href=#__codelineno-0-1146>1146</a></span>
<span class=normal><a href=#__codelineno-0-1147>1147</a></span>
<span class=normal><a href=#__codelineno-0-1148>1148</a></span>
<span class=normal><a href=#__codelineno-0-1149>1149</a></span>
<span class=normal><a href=#__codelineno-0-1150>1150</a></span>
<span class=normal><a href=#__codelineno-0-1151>1151</a></span>
<span class=normal><a href=#__codelineno-0-1152>1152</a></span>
<span class=normal><a href=#__codelineno-0-1153>1153</a></span>
<span class=normal><a href=#__codelineno-0-1154>1154</a></span>
<span class=normal><a href=#__codelineno-0-1155>1155</a></span>
<span class=normal><a href=#__codelineno-0-1156>1156</a></span>
<span class=normal><a href=#__codelineno-0-1157>1157</a></span>
<span class=normal><a href=#__codelineno-0-1158>1158</a></span>
<span class=normal><a href=#__codelineno-0-1159>1159</a></span>
<span class=normal><a href=#__codelineno-0-1160>1160</a></span>
<span class=normal><a href=#__codelineno-0-1161>1161</a></span>
<span class=normal><a href=#__codelineno-0-1162>1162</a></span>
<span class=normal><a href=#__codelineno-0-1163>1163</a></span>
<span class=normal><a href=#__codelineno-0-1164>1164</a></span>
<span class=normal><a href=#__codelineno-0-1165>1165</a></span>
<span class=normal><a href=#__codelineno-0-1166>1166</a></span>
<span class=normal><a href=#__codelineno-0-1167>1167</a></span>
<span class=normal><a href=#__codelineno-0-1168>1168</a></span>
<span class=normal><a href=#__codelineno-0-1169>1169</a></span>
<span class=normal><a href=#__codelineno-0-1170>1170</a></span>
<span class=normal><a href=#__codelineno-0-1171>1171</a></span>
<span class=normal><a href=#__codelineno-0-1172>1172</a></span>
<span class=normal><a href=#__codelineno-0-1173>1173</a></span>
<span class=normal><a href=#__codelineno-0-1174>1174</a></span>
<span class=normal><a href=#__codelineno-0-1175>1175</a></span>
<span class=normal><a href=#__codelineno-0-1176>1176</a></span>
<span class=normal><a href=#__codelineno-0-1177>1177</a></span>
<span class=normal><a href=#__codelineno-0-1178>1178</a></span>
<span class=normal><a href=#__codelineno-0-1179>1179</a></span>
<span class=normal><a href=#__codelineno-0-1180>1180</a></span>
<span class=normal><a href=#__codelineno-0-1181>1181</a></span>
<span class=normal><a href=#__codelineno-0-1182>1182</a></span>
<span class=normal><a href=#__codelineno-0-1183>1183</a></span>
<span class=normal><a href=#__codelineno-0-1184>1184</a></span>
<span class=normal><a href=#__codelineno-0-1185>1185</a></span>
<span class=normal><a href=#__codelineno-0-1186>1186</a></span>
<span class=normal><a href=#__codelineno-0-1187>1187</a></span>
<span class=normal><a href=#__codelineno-0-1188>1188</a></span>
<span class=normal><a href=#__codelineno-0-1189>1189</a></span>
<span class=normal><a href=#__codelineno-0-1190>1190</a></span>
<span class=normal><a href=#__codelineno-0-1191>1191</a></span>
<span class=normal><a href=#__codelineno-0-1192>1192</a></span>
<span class=normal><a href=#__codelineno-0-1193>1193</a></span>
<span class=normal><a href=#__codelineno-0-1194>1194</a></span>
<span class=normal><a href=#__codelineno-0-1195>1195</a></span>
<span class=normal><a href=#__codelineno-0-1196>1196</a></span>
<span class=normal><a href=#__codelineno-0-1197>1197</a></span>
<span class=normal><a href=#__codelineno-0-1198>1198</a></span>
<span class=normal><a href=#__codelineno-0-1199>1199</a></span>
<span class=normal><a href=#__codelineno-0-1200>1200</a></span>
<span class=normal><a href=#__codelineno-0-1201>1201</a></span>
<span class=normal><a href=#__codelineno-0-1202>1202</a></span>
<span class=normal><a href=#__codelineno-0-1203>1203</a></span>
<span class=normal><a href=#__codelineno-0-1204>1204</a></span>
<span class=normal><a href=#__codelineno-0-1205>1205</a></span>
<span class=normal><a href=#__codelineno-0-1206>1206</a></span>
<span class=normal><a href=#__codelineno-0-1207>1207</a></span>
<span class=normal><a href=#__codelineno-0-1208>1208</a></span>
<span class=normal><a href=#__codelineno-0-1209>1209</a></span>
<span class=normal><a href=#__codelineno-0-1210>1210</a></span>
<span class=normal><a href=#__codelineno-0-1211>1211</a></span>
<span class=normal><a href=#__codelineno-0-1212>1212</a></span>
<span class=normal><a href=#__codelineno-0-1213>1213</a></span>
<span class=normal><a href=#__codelineno-0-1214>1214</a></span>
<span class=normal><a href=#__codelineno-0-1215>1215</a></span>
<span class=normal><a href=#__codelineno-0-1216>1216</a></span>
<span class=normal><a href=#__codelineno-0-1217>1217</a></span>
<span class=normal><a href=#__codelineno-0-1218>1218</a></span>
<span class=normal><a href=#__codelineno-0-1219>1219</a></span>
<span class=normal><a href=#__codelineno-0-1220>1220</a></span>
<span class=normal><a href=#__codelineno-0-1221>1221</a></span>
<span class=normal><a href=#__codelineno-0-1222>1222</a></span>
<span class=normal><a href=#__codelineno-0-1223>1223</a></span>
<span class=normal><a href=#__codelineno-0-1224>1224</a></span>
<span class=normal><a href=#__codelineno-0-1225>1225</a></span>
<span class=normal><a href=#__codelineno-0-1226>1226</a></span>
<span class=normal><a href=#__codelineno-0-1227>1227</a></span>
<span class=normal><a href=#__codelineno-0-1228>1228</a></span>
<span class=normal><a href=#__codelineno-0-1229>1229</a></span>
<span class=normal><a href=#__codelineno-0-1230>1230</a></span>
<span class=normal><a href=#__codelineno-0-1231>1231</a></span>
<span class=normal><a href=#__codelineno-0-1232>1232</a></span>
<span class=normal><a href=#__codelineno-0-1233>1233</a></span>
<span class=normal><a href=#__codelineno-0-1234>1234</a></span>
<span class=normal><a href=#__codelineno-0-1235>1235</a></span>
<span class=normal><a href=#__codelineno-0-1236>1236</a></span>
<span class=normal><a href=#__codelineno-0-1237>1237</a></span>
<span class=normal><a href=#__codelineno-0-1238>1238</a></span>
<span class=normal><a href=#__codelineno-0-1239>1239</a></span>
<span class=normal><a href=#__codelineno-0-1240>1240</a></span>
<span class=normal><a href=#__codelineno-0-1241>1241</a></span>
<span class=normal><a href=#__codelineno-0-1242>1242</a></span>
<span class=normal><a href=#__codelineno-0-1243>1243</a></span>
<span class=normal><a href=#__codelineno-0-1244>1244</a></span>
<span class=normal><a href=#__codelineno-0-1245>1245</a></span>
<span class=normal><a href=#__codelineno-0-1246>1246</a></span>
<span class=normal><a href=#__codelineno-0-1247>1247</a></span>
<span class=normal><a href=#__codelineno-0-1248>1248</a></span>
<span class=normal><a href=#__codelineno-0-1249>1249</a></span>
<span class=normal><a href=#__codelineno-0-1250>1250</a></span>
<span class=normal><a href=#__codelineno-0-1251>1251</a></span>
<span class=normal><a href=#__codelineno-0-1252>1252</a></span>
<span class=normal><a href=#__codelineno-0-1253>1253</a></span>
<span class=normal><a href=#__codelineno-0-1254>1254</a></span>
<span class=normal><a href=#__codelineno-0-1255>1255</a></span>
<span class=normal><a href=#__codelineno-0-1256>1256</a></span>
<span class=normal><a href=#__codelineno-0-1257>1257</a></span>
<span class=normal><a href=#__codelineno-0-1258>1258</a></span>
<span class=normal><a href=#__codelineno-0-1259>1259</a></span>
<span class=normal><a href=#__codelineno-0-1260>1260</a></span>
<span class=normal><a href=#__codelineno-0-1261>1261</a></span>
<span class=normal><a href=#__codelineno-0-1262>1262</a></span>
<span class=normal><a href=#__codelineno-0-1263>1263</a></span>
<span class=normal><a href=#__codelineno-0-1264>1264</a></span>
<span class=normal><a href=#__codelineno-0-1265>1265</a></span>
<span class=normal><a href=#__codelineno-0-1266>1266</a></span>
<span class=normal><a href=#__codelineno-0-1267>1267</a></span>
<span class=normal><a href=#__codelineno-0-1268>1268</a></span>
<span class=normal><a href=#__codelineno-0-1269>1269</a></span>
<span class=normal><a href=#__codelineno-0-1270>1270</a></span>
<span class=normal><a href=#__codelineno-0-1271>1271</a></span>
<span class=normal><a href=#__codelineno-0-1272>1272</a></span>
<span class=normal><a href=#__codelineno-0-1273>1273</a></span>
<span class=normal><a href=#__codelineno-0-1274>1274</a></span>
<span class=normal><a href=#__codelineno-0-1275>1275</a></span>
<span class=normal><a href=#__codelineno-0-1276>1276</a></span>
<span class=normal><a href=#__codelineno-0-1277>1277</a></span>
<span class=normal><a href=#__codelineno-0-1278>1278</a></span>
<span class=normal><a href=#__codelineno-0-1279>1279</a></span>
<span class=normal><a href=#__codelineno-0-1280>1280</a></span>
<span class=normal><a href=#__codelineno-0-1281>1281</a></span>
<span class=normal><a href=#__codelineno-0-1282>1282</a></span>
<span class=normal><a href=#__codelineno-0-1283>1283</a></span>
<span class=normal><a href=#__codelineno-0-1284>1284</a></span>
<span class=normal><a href=#__codelineno-0-1285>1285</a></span>
<span class=normal><a href=#__codelineno-0-1286>1286</a></span>
<span class=normal><a href=#__codelineno-0-1287>1287</a></span>
<span class=normal><a href=#__codelineno-0-1288>1288</a></span>
<span class=normal><a href=#__codelineno-0-1289>1289</a></span>
<span class=normal><a href=#__codelineno-0-1290>1290</a></span>
<span class=normal><a href=#__codelineno-0-1291>1291</a></span>
<span class=normal><a href=#__codelineno-0-1292>1292</a></span>
<span class=normal><a href=#__codelineno-0-1293>1293</a></span>
<span class=normal><a href=#__codelineno-0-1294>1294</a></span>
<span class=normal><a href=#__codelineno-0-1295>1295</a></span>
<span class=normal><a href=#__codelineno-0-1296>1296</a></span>
<span class=normal><a href=#__codelineno-0-1297>1297</a></span>
<span class=normal><a href=#__codelineno-0-1298>1298</a></span>
<span class=normal><a href=#__codelineno-0-1299>1299</a></span>
<span class=normal><a href=#__codelineno-0-1300>1300</a></span>
<span class=normal><a href=#__codelineno-0-1301>1301</a></span>
<span class=normal><a href=#__codelineno-0-1302>1302</a></span>
<span class=normal><a href=#__codelineno-0-1303>1303</a></span>
<span class=normal><a href=#__codelineno-0-1304>1304</a></span>
<span class=normal><a href=#__codelineno-0-1305>1305</a></span>
<span class=normal><a href=#__codelineno-0-1306>1306</a></span>
<span class=normal><a href=#__codelineno-0-1307>1307</a></span>
<span class=normal><a href=#__codelineno-0-1308>1308</a></span>
<span class=normal><a href=#__codelineno-0-1309>1309</a></span>
<span class=normal><a href=#__codelineno-0-1310>1310</a></span>
<span class=normal><a href=#__codelineno-0-1311>1311</a></span>
<span class=normal><a href=#__codelineno-0-1312>1312</a></span>
<span class=normal><a href=#__codelineno-0-1313>1313</a></span>
<span class=normal><a href=#__codelineno-0-1314>1314</a></span>
<span class=normal><a href=#__codelineno-0-1315>1315</a></span>
<span class=normal><a href=#__codelineno-0-1316>1316</a></span>
<span class=normal><a href=#__codelineno-0-1317>1317</a></span>
<span class=normal><a href=#__codelineno-0-1318>1318</a></span>
<span class=normal><a href=#__codelineno-0-1319>1319</a></span>
<span class=normal><a href=#__codelineno-0-1320>1320</a></span>
<span class=normal><a href=#__codelineno-0-1321>1321</a></span>
<span class=normal><a href=#__codelineno-0-1322>1322</a></span>
<span class=normal><a href=#__codelineno-0-1323>1323</a></span>
<span class=normal><a href=#__codelineno-0-1324>1324</a></span>
<span class=normal><a href=#__codelineno-0-1325>1325</a></span>
<span class=normal><a href=#__codelineno-0-1326>1326</a></span>
<span class=normal><a href=#__codelineno-0-1327>1327</a></span>
<span class=normal><a href=#__codelineno-0-1328>1328</a></span>
<span class=normal><a href=#__codelineno-0-1329>1329</a></span>
<span class=normal><a href=#__codelineno-0-1330>1330</a></span>
<span class=normal><a href=#__codelineno-0-1331>1331</a></span>
<span class=normal><a href=#__codelineno-0-1332>1332</a></span>
<span class=normal><a href=#__codelineno-0-1333>1333</a></span>
<span class=normal><a href=#__codelineno-0-1334>1334</a></span>
<span class=normal><a href=#__codelineno-0-1335>1335</a></span>
<span class=normal><a href=#__codelineno-0-1336>1336</a></span>
<span class=normal><a href=#__codelineno-0-1337>1337</a></span>
<span class=normal><a href=#__codelineno-0-1338>1338</a></span>
<span class=normal><a href=#__codelineno-0-1339>1339</a></span>
<span class=normal><a href=#__codelineno-0-1340>1340</a></span>
<span class=normal><a href=#__codelineno-0-1341>1341</a></span>
<span class=normal><a href=#__codelineno-0-1342>1342</a></span>
<span class=normal><a href=#__codelineno-0-1343>1343</a></span>
<span class=normal><a href=#__codelineno-0-1344>1344</a></span>
<span class=normal><a href=#__codelineno-0-1345>1345</a></span>
<span class=normal><a href=#__codelineno-0-1346>1346</a></span>
<span class=normal><a href=#__codelineno-0-1347>1347</a></span>
<span class=normal><a href=#__codelineno-0-1348>1348</a></span>
<span class=normal><a href=#__codelineno-0-1349>1349</a></span>
<span class=normal><a href=#__codelineno-0-1350>1350</a></span>
<span class=normal><a href=#__codelineno-0-1351>1351</a></span>
<span class=normal><a href=#__codelineno-0-1352>1352</a></span>
<span class=normal><a href=#__codelineno-0-1353>1353</a></span>
<span class=normal><a href=#__codelineno-0-1354>1354</a></span>
<span class=normal><a href=#__codelineno-0-1355>1355</a></span>
<span class=normal><a href=#__codelineno-0-1356>1356</a></span>
<span class=normal><a href=#__codelineno-0-1357>1357</a></span>
<span class=normal><a href=#__codelineno-0-1358>1358</a></span>
<span class=normal><a href=#__codelineno-0-1359>1359</a></span>
<span class=normal><a href=#__codelineno-0-1360>1360</a></span>
<span class=normal><a href=#__codelineno-0-1361>1361</a></span>
<span class=normal><a href=#__codelineno-0-1362>1362</a></span>
<span class=normal><a href=#__codelineno-0-1363>1363</a></span>
<span class=normal><a href=#__codelineno-0-1364>1364</a></span>
<span class=normal><a href=#__codelineno-0-1365>1365</a></span>
<span class=normal><a href=#__codelineno-0-1366>1366</a></span>
<span class=normal><a href=#__codelineno-0-1367>1367</a></span>
<span class=normal><a href=#__codelineno-0-1368>1368</a></span>
<span class=normal><a href=#__codelineno-0-1369>1369</a></span>
<span class=normal><a href=#__codelineno-0-1370>1370</a></span>
<span class=normal><a href=#__codelineno-0-1371>1371</a></span>
<span class=normal><a href=#__codelineno-0-1372>1372</a></span>
<span class=normal><a href=#__codelineno-0-1373>1373</a></span>
<span class=normal><a href=#__codelineno-0-1374>1374</a></span>
<span class=normal><a href=#__codelineno-0-1375>1375</a></span>
<span class=normal><a href=#__codelineno-0-1376>1376</a></span>
<span class=normal><a href=#__codelineno-0-1377>1377</a></span>
<span class=normal><a href=#__codelineno-0-1378>1378</a></span>
<span class=normal><a href=#__codelineno-0-1379>1379</a></span>
<span class=normal><a href=#__codelineno-0-1380>1380</a></span>
<span class=normal><a href=#__codelineno-0-1381>1381</a></span>
<span class=normal><a href=#__codelineno-0-1382>1382</a></span>
<span class=normal><a href=#__codelineno-0-1383>1383</a></span>
<span class=normal><a href=#__codelineno-0-1384>1384</a></span>
<span class=normal><a href=#__codelineno-0-1385>1385</a></span>
<span class=normal><a href=#__codelineno-0-1386>1386</a></span>
<span class=normal><a href=#__codelineno-0-1387>1387</a></span>
<span class=normal><a href=#__codelineno-0-1388>1388</a></span>
<span class=normal><a href=#__codelineno-0-1389>1389</a></span>
<span class=normal><a href=#__codelineno-0-1390>1390</a></span>
<span class=normal><a href=#__codelineno-0-1391>1391</a></span>
<span class=normal><a href=#__codelineno-0-1392>1392</a></span>
<span class=normal><a href=#__codelineno-0-1393>1393</a></span>
<span class=normal><a href=#__codelineno-0-1394>1394</a></span>
<span class=normal><a href=#__codelineno-0-1395>1395</a></span>
<span class=normal><a href=#__codelineno-0-1396>1396</a></span>
<span class=normal><a href=#__codelineno-0-1397>1397</a></span>
<span class=normal><a href=#__codelineno-0-1398>1398</a></span>
<span class=normal><a href=#__codelineno-0-1399>1399</a></span>
<span class=normal><a href=#__codelineno-0-1400>1400</a></span>
<span class=normal><a href=#__codelineno-0-1401>1401</a></span>
<span class=normal><a href=#__codelineno-0-1402>1402</a></span>
<span class=normal><a href=#__codelineno-0-1403>1403</a></span>
<span class=normal><a href=#__codelineno-0-1404>1404</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1041><a id=__codelineno-0-1041 name=__codelineno-0-1041></a><span class=k>class</span><span class=w> </span><span class=nc>TileDBIterableDataset</span><span class=p>(</span><span class=n>IterableDataset</span><span class=p>):</span>
</span><span id=__span-0-1042><a id=__codelineno-0-1042 name=__codelineno-0-1042></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1043><a id=__codelineno-0-1043 name=__codelineno-0-1043></a><span class=sd>    PyTorch IterableDataset for streaming TileDB SOMA data with async prefetching.</span>
</span><span id=__span-0-1044><a id=__codelineno-0-1044 name=__codelineno-0-1044></a>
</span><span id=__span-0-1045><a id=__codelineno-0-1045 name=__codelineno-0-1045></a><span class=sd>    TileDBIterableDataset provides a PyTorch-compatible interface for streaming</span>
</span><span id=__span-0-1046><a id=__codelineno-0-1046 name=__codelineno-0-1046></a><span class=sd>    single-cell data from TileDB SOMA format. It combines the TileDBBatchProcessor</span>
</span><span id=__span-0-1047><a id=__codelineno-0-1047 name=__codelineno-0-1047></a><span class=sd>    and TileDBAsyncPrefetcher to provide efficient, asynchronous data loading</span>
</span><span id=__span-0-1048><a id=__codelineno-0-1048 name=__codelineno-0-1048></a><span class=sd>    for machine learning training.</span>
</span><span id=__span-0-1049><a id=__codelineno-0-1049 name=__codelineno-0-1049></a>
</span><span id=__span-0-1050><a id=__codelineno-0-1050 name=__codelineno-0-1050></a><span class=sd>    Key Features:</span>
</span><span id=__span-0-1051><a id=__codelineno-0-1051 name=__codelineno-0-1051></a><span class=sd>        - PyTorch IterableDataset compatibility</span>
</span><span id=__span-0-1052><a id=__codelineno-0-1052 name=__codelineno-0-1052></a><span class=sd>        - Asynchronous background prefetching for improved throughput</span>
</span><span id=__span-0-1053><a id=__codelineno-0-1053 name=__codelineno-0-1053></a><span class=sd>        - Multiple loading strategies (MoS and sequential)</span>
</span><span id=__span-0-1054><a id=__codelineno-0-1054 name=__codelineno-0-1054></a><span class=sd>        - Multi-epoch training support</span>
</span><span id=__span-0-1055><a id=__codelineno-0-1055 name=__codelineno-0-1055></a><span class=sd>        - Automatic epoch transition handling</span>
</span><span id=__span-0-1056><a id=__codelineno-0-1056 name=__codelineno-0-1056></a><span class=sd>        - Memory-efficient streaming</span>
</span><span id=__span-0-1057><a id=__codelineno-0-1057 name=__codelineno-0-1057></a><span class=sd>        - Comprehensive error handling</span>
</span><span id=__span-0-1058><a id=__codelineno-0-1058 name=__codelineno-0-1058></a><span class=sd>        - Configurable batch and prefetch sizes</span>
</span><span id=__span-0-1059><a id=__codelineno-0-1059 name=__codelineno-0-1059></a>
</span><span id=__span-0-1060><a id=__codelineno-0-1060 name=__codelineno-0-1060></a><span class=sd>    The dataset automatically manages background prefetching and provides</span>
</span><span id=__span-0-1061><a id=__codelineno-0-1061 name=__codelineno-0-1061></a><span class=sd>    seamless iteration over batches of TileDB data. It handles epoch</span>
</span><span id=__span-0-1062><a id=__codelineno-0-1062 name=__codelineno-0-1062></a><span class=sd>    transitions and provides detailed timing information for performance</span>
</span><span id=__span-0-1063><a id=__codelineno-0-1063 name=__codelineno-0-1063></a><span class=sd>    monitoring.</span>
</span><span id=__span-0-1064><a id=__codelineno-0-1064 name=__codelineno-0-1064></a>
</span><span id=__span-0-1065><a id=__codelineno-0-1065 name=__codelineno-0-1065></a><span class=sd>    Examples:</span>
</span><span id=__span-0-1066><a id=__codelineno-0-1066 name=__codelineno-0-1066></a><span class=sd>            &gt;&gt;&gt; # Create dataset with default MoS strategy</span>
</span><span id=__span-0-1067><a id=__codelineno-0-1067 name=__codelineno-0-1067></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1068><a id=__codelineno-0-1068 name=__codelineno-0-1068></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1069><a id=__codelineno-0-1069 name=__codelineno-0-1069></a><span class=sd>            ...     batch_size=32,</span>
</span><span id=__span-0-1070><a id=__codelineno-0-1070 name=__codelineno-0-1070></a><span class=sd>            ...     prefetch_batch_size=100</span>
</span><span id=__span-0-1071><a id=__codelineno-0-1071 name=__codelineno-0-1071></a><span class=sd>            ... )</span>
</span><span id=__span-0-1072><a id=__codelineno-0-1072 name=__codelineno-0-1072></a><span class=sd>            &gt;&gt;&gt;</span>
</span><span id=__span-0-1073><a id=__codelineno-0-1073 name=__codelineno-0-1073></a><span class=sd>            &gt;&gt;&gt; # Iterate through batches</span>
</span><span id=__span-0-1074><a id=__codelineno-0-1074 name=__codelineno-0-1074></a><span class=sd>            &gt;&gt;&gt; for batch in dataset:</span>
</span><span id=__span-0-1075><a id=__codelineno-0-1075 name=__codelineno-0-1075></a><span class=sd>            ...     print(f&quot;Batch keys: {list(batch.keys())}&quot;)</span>
</span><span id=__span-0-1076><a id=__codelineno-0-1076 name=__codelineno-0-1076></a><span class=sd>            ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-1077><a id=__codelineno-0-1077 name=__codelineno-0-1077></a><span class=sd>            ...     break</span>
</span><span id=__span-0-1078><a id=__codelineno-0-1078 name=__codelineno-0-1078></a><span class=sd>        Batch keys: [&#39;X&#39;, &#39;cell_ids&#39;]</span>
</span><span id=__span-0-1079><a id=__codelineno-0-1079 name=__codelineno-0-1079></a><span class=sd>        Cell IDs: [0, 1, 2, ..., 29, 30, 31]</span>
</span><span id=__span-0-1080><a id=__codelineno-0-1080 name=__codelineno-0-1080></a>
</span><span id=__span-0-1081><a id=__codelineno-0-1081 name=__codelineno-0-1081></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-1082><a id=__codelineno-0-1082 name=__codelineno-0-1082></a><span class=sd>        &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1083><a id=__codelineno-0-1083 name=__codelineno-0-1083></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1084><a id=__codelineno-0-1084 name=__codelineno-0-1084></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-1085><a id=__codelineno-0-1085 name=__codelineno-0-1085></a><span class=sd>        ...     batch_size=64</span>
</span><span id=__span-0-1086><a id=__codelineno-0-1086 name=__codelineno-0-1086></a><span class=sd>        ... )</span>
</span><span id=__span-0-1087><a id=__codelineno-0-1087 name=__codelineno-0-1087></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {dataset.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1088><a id=__codelineno-0-1088 name=__codelineno-0-1088></a><span class=sd>        MoS enabled: False</span>
</span><span id=__span-0-1089><a id=__codelineno-0-1089 name=__codelineno-0-1089></a>
</span><span id=__span-0-1090><a id=__codelineno-0-1090 name=__codelineno-0-1090></a><span class=sd>        &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-1091><a id=__codelineno-0-1091 name=__codelineno-0-1091></a><span class=sd>        &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1092><a id=__codelineno-0-1092 name=__codelineno-0-1092></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1093><a id=__codelineno-0-1093 name=__codelineno-0-1093></a><span class=sd>        ...     n_epochs=3</span>
</span><span id=__span-0-1094><a id=__codelineno-0-1094 name=__codelineno-0-1094></a><span class=sd>        ... )</span>
</span><span id=__span-0-1095><a id=__codelineno-0-1095 name=__codelineno-0-1095></a><span class=sd>        &gt;&gt;&gt; epochs_seen = set()</span>
</span><span id=__span-0-1096><a id=__codelineno-0-1096 name=__codelineno-0-1096></a><span class=sd>        &gt;&gt;&gt; for batch in dataset:</span>
</span><span id=__span-0-1097><a id=__codelineno-0-1097 name=__codelineno-0-1097></a><span class=sd>        ...     if &#39;epoch&#39; in batch:</span>
</span><span id=__span-0-1098><a id=__codelineno-0-1098 name=__codelineno-0-1098></a><span class=sd>        ...         epochs_seen.add(batch[&#39;epoch&#39;])</span>
</span><span id=__span-0-1099><a id=__codelineno-0-1099 name=__codelineno-0-1099></a><span class=sd>        ...     if len(epochs_seen) &gt;= 3:</span>
</span><span id=__span-0-1100><a id=__codelineno-0-1100 name=__codelineno-0-1100></a><span class=sd>        ...         break</span>
</span><span id=__span-0-1101><a id=__codelineno-0-1101 name=__codelineno-0-1101></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Epochs completed: {sorted(epochs_seen)}&quot;)</span>
</span><span id=__span-0-1102><a id=__codelineno-0-1102 name=__codelineno-0-1102></a><span class=sd>        Epochs completed: [0, 1, 2]</span>
</span><span id=__span-0-1103><a id=__codelineno-0-1103 name=__codelineno-0-1103></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-1104><a id=__codelineno-0-1104 name=__codelineno-0-1104></a>
</span><span id=__span-0-1105><a id=__codelineno-0-1105 name=__codelineno-0-1105></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-1106><a id=__codelineno-0-1106 name=__codelineno-0-1106></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-1107><a id=__codelineno-0-1107 name=__codelineno-0-1107></a>        <span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-1108><a id=__codelineno-0-1108 name=__codelineno-0-1108></a>        <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-1109><a id=__codelineno-0-1109 name=__codelineno-0-1109></a>        <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-1110><a id=__codelineno-0-1110 name=__codelineno-0-1110></a>        <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span>
</span><span id=__span-0-1111><a id=__codelineno-0-1111 name=__codelineno-0-1111></a>        <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>,</span>
</span><span id=__span-0-1112><a id=__codelineno-0-1112 name=__codelineno-0-1112></a>        <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-1113><a id=__codelineno-0-1113 name=__codelineno-0-1113></a>        <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1114><a id=__codelineno-0-1114 name=__codelineno-0-1114></a>        <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1115><a id=__codelineno-0-1115 name=__codelineno-0-1115></a>        <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span><span id=__span-0-1116><a id=__codelineno-0-1116 name=__codelineno-0-1116></a>        <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-0-1117><a id=__codelineno-0-1117 name=__codelineno-0-1117></a>    <span class=p>):</span>
</span><span id=__span-0-1118><a id=__codelineno-0-1118 name=__codelineno-0-1118></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1119><a id=__codelineno-0-1119 name=__codelineno-0-1119></a><span class=sd>        Initialize the TileDB IterableDataset with async prefetching.</span>
</span><span id=__span-0-1120><a id=__codelineno-0-1120 name=__codelineno-0-1120></a>
</span><span id=__span-0-1121><a id=__codelineno-0-1121 name=__codelineno-0-1121></a><span class=sd>        Args:</span>
</span><span id=__span-0-1122><a id=__codelineno-0-1122 name=__codelineno-0-1122></a><span class=sd>            tiledb_path: Path to the TileDB SOMA experiment directory.</span>
</span><span id=__span-0-1123><a id=__codelineno-0-1123 name=__codelineno-0-1123></a><span class=sd>                         Must contain a valid SOMA experiment with RNA measurement data.</span>
</span><span id=__span-0-1124><a id=__codelineno-0-1124 name=__codelineno-0-1124></a><span class=sd>            batch_size: Number of cells per training batch. Larger batches use more</span>
</span><span id=__span-0-1125><a id=__codelineno-0-1125 name=__codelineno-0-1125></a><span class=sd>                       memory but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-1126><a id=__codelineno-0-1126 name=__codelineno-0-1126></a><span class=sd>            prefetch_batch_size: Number of cells to load per prefetch batch from TileDB.</span>
</span><span id=__span-0-1127><a id=__codelineno-0-1127 name=__codelineno-0-1127></a><span class=sd>                               Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-1128><a id=__codelineno-0-1128 name=__codelineno-0-1128></a><span class=sd>                               Range: 10-10000, default: 100.</span>
</span><span id=__span-0-1129><a id=__codelineno-0-1129 name=__codelineno-0-1129></a><span class=sd>            seed: Random seed for reproducible shuffling and MoS sampling.</span>
</span><span id=__span-0-1130><a id=__codelineno-0-1130 name=__codelineno-0-1130></a><span class=sd>                  Used for consistent data ordering across runs. Default: 42.</span>
</span><span id=__span-0-1131><a id=__codelineno-0-1131 name=__codelineno-0-1131></a><span class=sd>            max_queue_size: Maximum number of pre-processed batches to keep in queue.</span>
</span><span id=__span-0-1132><a id=__codelineno-0-1132 name=__codelineno-0-1132></a><span class=sd>                          Higher values use more memory but provide better buffering.</span>
</span><span id=__span-0-1133><a id=__codelineno-0-1133 name=__codelineno-0-1133></a><span class=sd>                          Range: 10-10000, default: 500.</span>
</span><span id=__span-0-1134><a id=__codelineno-0-1134 name=__codelineno-0-1134></a><span class=sd>            n_epochs: Number of epochs to run. The dataset will automatically reset</span>
</span><span id=__span-0-1135><a id=__codelineno-0-1135 name=__codelineno-0-1135></a><span class=sd>                     after each epoch, enabling multi-epoch training. Default: 1.</span>
</span><span id=__span-0-1136><a id=__codelineno-0-1136 name=__codelineno-0-1136></a><span class=sd>            verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-1137><a id=__codelineno-0-1137 name=__codelineno-0-1137></a><span class=sd>                    If False, suppress all internal prints for clean output. Default: True.</span>
</span><span id=__span-0-1138><a id=__codelineno-0-1138 name=__codelineno-0-1138></a><span class=sd>            use_mixture_of_scanners: If True, use MoS strategy for higher entropy by</span>
</span><span id=__span-0-1139><a id=__codelineno-0-1139 name=__codelineno-0-1139></a><span class=sd>                                   randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-1140><a id=__codelineno-0-1140 name=__codelineno-0-1140></a><span class=sd>                                   Provides better randomization for foundation model training.</span>
</span><span id=__span-0-1141><a id=__codelineno-0-1141 name=__codelineno-0-1141></a><span class=sd>                                   Default: True.</span>
</span><span id=__span-0-1142><a id=__codelineno-0-1142 name=__codelineno-0-1142></a><span class=sd>            n_readers: Total number of fragment generators to create when using MoS.</span>
</span><span id=__span-0-1143><a id=__codelineno-0-1143 name=__codelineno-0-1143></a><span class=sd>                      Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1144><a id=__codelineno-0-1144 name=__codelineno-0-1144></a><span class=sd>                      Range: 1-1000, default: 50.</span>
</span><span id=__span-0-1145><a id=__codelineno-0-1145 name=__codelineno-0-1145></a><span class=sd>            n_scanners: Number of active scanners to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-1146><a id=__codelineno-0-1146 name=__codelineno-0-1146></a><span class=sd>                       Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1147><a id=__codelineno-0-1147 name=__codelineno-0-1147></a><span class=sd>                       Range: 1-100, default: 8.</span>
</span><span id=__span-0-1148><a id=__codelineno-0-1148 name=__codelineno-0-1148></a>
</span><span id=__span-0-1149><a id=__codelineno-0-1149 name=__codelineno-0-1149></a><span class=sd>        Raises:</span>
</span><span id=__span-0-1150><a id=__codelineno-0-1150 name=__codelineno-0-1150></a><span class=sd>            ImportError: If TileDB SOMA is not available.</span>
</span><span id=__span-0-1151><a id=__codelineno-0-1151 name=__codelineno-0-1151></a><span class=sd>            ValueError: If MoS parameters are invalid.</span>
</span><span id=__span-0-1152><a id=__codelineno-0-1152 name=__codelineno-0-1152></a><span class=sd>            RuntimeError: If the TileDB experiment cannot be opened or is invalid.</span>
</span><span id=__span-0-1153><a id=__codelineno-0-1153 name=__codelineno-0-1153></a>
</span><span id=__span-0-1154><a id=__codelineno-0-1154 name=__codelineno-0-1154></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1155><a id=__codelineno-0-1155 name=__codelineno-0-1155></a><span class=sd>            &gt;&gt;&gt; # Basic initialization with default MoS strategy</span>
</span><span id=__span-0-1156><a id=__codelineno-0-1156 name=__codelineno-0-1156></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1157><a id=__codelineno-0-1157 name=__codelineno-0-1157></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1158><a id=__codelineno-0-1158 name=__codelineno-0-1158></a><span class=sd>            ...     batch_size=32,</span>
</span><span id=__span-0-1159><a id=__codelineno-0-1159 name=__codelineno-0-1159></a><span class=sd>            ...     prefetch_batch_size=100</span>
</span><span id=__span-0-1160><a id=__codelineno-0-1160 name=__codelineno-0-1160></a><span class=sd>            ... )</span>
</span><span id=__span-0-1161><a id=__codelineno-0-1161 name=__codelineno-0-1161></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS enabled: {dataset.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1162><a id=__codelineno-0-1162 name=__codelineno-0-1162></a><span class=sd>            MoS enabled: True</span>
</span><span id=__span-0-1163><a id=__codelineno-0-1163 name=__codelineno-0-1163></a>
</span><span id=__span-0-1164><a id=__codelineno-0-1164 name=__codelineno-0-1164></a><span class=sd>            &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-1165><a id=__codelineno-0-1165 name=__codelineno-0-1165></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1166><a id=__codelineno-0-1166 name=__codelineno-0-1166></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1167><a id=__codelineno-0-1167 name=__codelineno-0-1167></a><span class=sd>            ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-1168><a id=__codelineno-0-1168 name=__codelineno-0-1168></a><span class=sd>            ...     batch_size=64</span>
</span><span id=__span-0-1169><a id=__codelineno-0-1169 name=__codelineno-0-1169></a><span class=sd>            ... )</span>
</span><span id=__span-0-1170><a id=__codelineno-0-1170 name=__codelineno-0-1170></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataset.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1171><a id=__codelineno-0-1171 name=__codelineno-0-1171></a><span class=sd>            Sequential loading: True</span>
</span><span id=__span-0-1172><a id=__codelineno-0-1172 name=__codelineno-0-1172></a>
</span><span id=__span-0-1173><a id=__codelineno-0-1173 name=__codelineno-0-1173></a><span class=sd>            &gt;&gt;&gt; # High-entropy MoS configuration</span>
</span><span id=__span-0-1174><a id=__codelineno-0-1174 name=__codelineno-0-1174></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1175><a id=__codelineno-0-1175 name=__codelineno-0-1175></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1176><a id=__codelineno-0-1176 name=__codelineno-0-1176></a><span class=sd>            ...     n_readers=100,</span>
</span><span id=__span-0-1177><a id=__codelineno-0-1177 name=__codelineno-0-1177></a><span class=sd>            ...     n_scanners=16</span>
</span><span id=__span-0-1178><a id=__codelineno-0-1178 name=__codelineno-0-1178></a><span class=sd>            ... )</span>
</span><span id=__span-0-1179><a id=__codelineno-0-1179 name=__codelineno-0-1179></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS readers: {dataset.n_readers}, scanners: {dataset.n_scanners}&quot;)</span>
</span><span id=__span-0-1180><a id=__codelineno-0-1180 name=__codelineno-0-1180></a><span class=sd>            MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-1181><a id=__codelineno-0-1181 name=__codelineno-0-1181></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1182><a id=__codelineno-0-1182 name=__codelineno-0-1182></a>        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span><span id=__span-0-1183><a id=__codelineno-0-1183 name=__codelineno-0-1183></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tiledb_path</span> <span class=o>=</span> <span class=n>tiledb_path</span>
</span><span id=__span-0-1184><a id=__codelineno-0-1184 name=__codelineno-0-1184></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-1185><a id=__codelineno-0-1185 name=__codelineno-0-1185></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=n>prefetch_batch_size</span>
</span><span id=__span-0-1186><a id=__codelineno-0-1186 name=__codelineno-0-1186></a>        <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>=</span> <span class=n>seed</span>
</span><span id=__span-0-1187><a id=__codelineno-0-1187 name=__codelineno-0-1187></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>
</span><span id=__span-0-1188><a id=__codelineno-0-1188 name=__codelineno-0-1188></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-1189><a id=__codelineno-0-1189 name=__codelineno-0-1189></a>        <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span><span id=__span-0-1190><a id=__codelineno-0-1190 name=__codelineno-0-1190></a>        <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>
</span><span id=__span-0-1191><a id=__codelineno-0-1191 name=__codelineno-0-1191></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>=</span> <span class=n>n_readers</span>
</span><span id=__span-0-1192><a id=__codelineno-0-1192 name=__codelineno-0-1192></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>
</span><span id=__span-0-1193><a id=__codelineno-0-1193 name=__codelineno-0-1193></a>
</span><span id=__span-0-1194><a id=__codelineno-0-1194 name=__codelineno-0-1194></a>        <span class=c1># Initialize batch processor</span>
</span><span id=__span-0-1195><a id=__codelineno-0-1195 name=__codelineno-0-1195></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-1196><a id=__codelineno-0-1196 name=__codelineno-0-1196></a>            <span class=n>tiledb_path</span><span class=o>=</span><span class=n>tiledb_path</span><span class=p>,</span>
</span><span id=__span-0-1197><a id=__codelineno-0-1197 name=__codelineno-0-1197></a>            <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-1198><a id=__codelineno-0-1198 name=__codelineno-0-1198></a>            <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-1199><a id=__codelineno-0-1199 name=__codelineno-0-1199></a>            <span class=n>seed</span><span class=o>=</span><span class=n>seed</span><span class=p>,</span>
</span><span id=__span-0-1200><a id=__codelineno-0-1200 name=__codelineno-0-1200></a>            <span class=n>n_epochs</span><span class=o>=</span><span class=n>n_epochs</span><span class=p>,</span>
</span><span id=__span-0-1201><a id=__codelineno-0-1201 name=__codelineno-0-1201></a>            <span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-1202><a id=__codelineno-0-1202 name=__codelineno-0-1202></a>            <span class=n>log_metrics</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-1203><a id=__codelineno-0-1203 name=__codelineno-0-1203></a>            <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=n>use_mixture_of_scanners</span><span class=p>,</span>
</span><span id=__span-0-1204><a id=__codelineno-0-1204 name=__codelineno-0-1204></a>            <span class=n>n_readers</span><span class=o>=</span><span class=n>n_readers</span><span class=p>,</span>
</span><span id=__span-0-1205><a id=__codelineno-0-1205 name=__codelineno-0-1205></a>            <span class=n>n_scanners</span><span class=o>=</span><span class=n>n_scanners</span><span class=p>,</span>
</span><span id=__span-0-1206><a id=__codelineno-0-1206 name=__codelineno-0-1206></a>        <span class=p>)</span>
</span><span id=__span-0-1207><a id=__codelineno-0-1207 name=__codelineno-0-1207></a>
</span><span id=__span-0-1208><a id=__codelineno-0-1208 name=__codelineno-0-1208></a>        <span class=c1># Initialize async prefetcher</span>
</span><span id=__span-0-1209><a id=__codelineno-0-1209 name=__codelineno-0-1209></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span>
</span><span id=__span-0-1210><a id=__codelineno-0-1210 name=__codelineno-0-1210></a>            <span class=n>batch_processor</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=p>,</span>
</span><span id=__span-0-1211><a id=__codelineno-0-1211 name=__codelineno-0-1211></a>            <span class=n>max_queue_size</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>,</span>
</span><span id=__span-0-1212><a id=__codelineno-0-1212 name=__codelineno-0-1212></a>        <span class=p>)</span>
</span><span id=__span-0-1213><a id=__codelineno-0-1213 name=__codelineno-0-1213></a>
</span><span id=__span-0-1214><a id=__codelineno-0-1214 name=__codelineno-0-1214></a>        <span class=c1># Start async prefetching</span>
</span><span id=__span-0-1215><a id=__codelineno-0-1215 name=__codelineno-0-1215></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-1216><a id=__codelineno-0-1216 name=__codelineno-0-1216></a>
</span><span id=__span-0-1217><a id=__codelineno-0-1217 name=__codelineno-0-1217></a>        <span class=c1># Wait for prefetcher to initialize</span>
</span><span id=__span-0-1218><a id=__codelineno-0-1218 name=__codelineno-0-1218></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_wait_for_prefetcher_ready</span><span class=p>()</span>
</span><span id=__span-0-1219><a id=__codelineno-0-1219 name=__codelineno-0-1219></a>
</span><span id=__span-0-1220><a id=__codelineno-0-1220 name=__codelineno-0-1220></a>    <span class=k>def</span><span class=w> </span><span class=nf>_wait_for_prefetcher_ready</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>10.0</span><span class=p>):</span>
</span><span id=__span-0-1221><a id=__codelineno-0-1221 name=__codelineno-0-1221></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Wait for the prefetcher to be ready with data.&quot;&quot;&quot;</span>
</span><span id=__span-0-1222><a id=__codelineno-0-1222 name=__codelineno-0-1222></a>        <span class=n>start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-1223><a id=__codelineno-0-1223 name=__codelineno-0-1223></a>        <span class=k>while</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>start_time</span> <span class=o>&lt;</span> <span class=n>timeout</span><span class=p>:</span>
</span><span id=__span-0-1224><a id=__codelineno-0-1224 name=__codelineno-0-1224></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>has_batch</span><span class=p>():</span>
</span><span id=__span-0-1225><a id=__codelineno-0-1225 name=__codelineno-0-1225></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1226><a id=__codelineno-0-1226 name=__codelineno-0-1226></a>                    <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-1227><a id=__codelineno-0-1227 name=__codelineno-0-1227></a>                        <span class=sa>f</span><span class=s2>&quot; TileDB prefetcher ready after </span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start_time</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2>s&quot;</span>
</span><span id=__span-0-1228><a id=__codelineno-0-1228 name=__codelineno-0-1228></a>                    <span class=p>)</span>
</span><span id=__span-0-1229><a id=__codelineno-0-1229 name=__codelineno-0-1229></a>                <span class=k>return</span>
</span><span id=__span-0-1230><a id=__codelineno-0-1230 name=__codelineno-0-1230></a>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span><span id=__span-0-1231><a id=__codelineno-0-1231 name=__codelineno-0-1231></a>
</span><span id=__span-0-1232><a id=__codelineno-0-1232 name=__codelineno-0-1232></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1233><a id=__codelineno-0-1233 name=__codelineno-0-1233></a>            <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-1234><a id=__codelineno-0-1234 name=__codelineno-0-1234></a>                <span class=sa>f</span><span class=s2>&quot; TileDB prefetcher not ready after </span><span class=si>{</span><span class=n>timeout</span><span class=si>}</span><span class=s2>s, proceeding anyway...&quot;</span>
</span><span id=__span-0-1235><a id=__codelineno-0-1235 name=__codelineno-0-1235></a>            <span class=p>)</span>
</span><span id=__span-0-1236><a id=__codelineno-0-1236 name=__codelineno-0-1236></a>
</span><span id=__span-0-1237><a id=__codelineno-0-1237 name=__codelineno-0-1237></a>    <span class=k>def</span><span class=w> </span><span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Iterator</span><span class=p>[</span><span class=nb>dict</span><span class=p>]:</span>
</span><span id=__span-0-1238><a id=__codelineno-0-1238 name=__codelineno-0-1238></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1239><a id=__codelineno-0-1239 name=__codelineno-0-1239></a><span class=sd>        Iterate through batches of TileDB data with async prefetching.</span>
</span><span id=__span-0-1240><a id=__codelineno-0-1240 name=__codelineno-0-1240></a>
</span><span id=__span-0-1241><a id=__codelineno-0-1241 name=__codelineno-0-1241></a><span class=sd>        This method provides an iterator over batches of TileDB data, automatically</span>
</span><span id=__span-0-1242><a id=__codelineno-0-1242 name=__codelineno-0-1242></a><span class=sd>        handling background prefetching, epoch transitions, and error recovery.</span>
</span><span id=__span-0-1243><a id=__codelineno-0-1243 name=__codelineno-0-1243></a><span class=sd>        It yields dictionaries containing the batch data and metadata.</span>
</span><span id=__span-0-1244><a id=__codelineno-0-1244 name=__codelineno-0-1244></a>
</span><span id=__span-0-1245><a id=__codelineno-0-1245 name=__codelineno-0-1245></a><span class=sd>        The iterator automatically manages:</span>
</span><span id=__span-0-1246><a id=__codelineno-0-1246 name=__codelineno-0-1246></a><span class=sd>        - Background prefetching for improved throughput</span>
</span><span id=__span-0-1247><a id=__codelineno-0-1247 name=__codelineno-0-1247></a><span class=sd>        - Epoch transitions for multi-epoch training</span>
</span><span id=__span-0-1248><a id=__codelineno-0-1248 name=__codelineno-0-1248></a><span class=sd>        - Error handling and recovery</span>
</span><span id=__span-0-1249><a id=__codelineno-0-1249 name=__codelineno-0-1249></a><span class=sd>        - Performance monitoring and reporting</span>
</span><span id=__span-0-1250><a id=__codelineno-0-1250 name=__codelineno-0-1250></a>
</span><span id=__span-0-1251><a id=__codelineno-0-1251 name=__codelineno-0-1251></a><span class=sd>        Yields:</span>
</span><span id=__span-0-1252><a id=__codelineno-0-1252 name=__codelineno-0-1252></a><span class=sd>            dict: Batch dictionary containing:</span>
</span><span id=__span-0-1253><a id=__codelineno-0-1253 name=__codelineno-0-1253></a><span class=sd>                - X: Polars DataFrame with cell-gene expression data</span>
</span><span id=__span-0-1254><a id=__codelineno-0-1254 name=__codelineno-0-1254></a><span class=sd>                - cell_ids: List of unique cell IDs in the batch</span>
</span><span id=__span-0-1255><a id=__codelineno-0-1255 name=__codelineno-0-1255></a><span class=sd>                - epoch: Current epoch number (when n_epochs &gt; 1)</span>
</span><span id=__span-0-1256><a id=__codelineno-0-1256 name=__codelineno-0-1256></a>
</span><span id=__span-0-1257><a id=__codelineno-0-1257 name=__codelineno-0-1257></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1258><a id=__codelineno-0-1258 name=__codelineno-0-1258></a><span class=sd>            &gt;&gt;&gt; # Basic iteration</span>
</span><span id=__span-0-1259><a id=__codelineno-0-1259 name=__codelineno-0-1259></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1260><a id=__codelineno-0-1260 name=__codelineno-0-1260></a><span class=sd>            &gt;&gt;&gt; for batch in dataset:</span>
</span><span id=__span-0-1261><a id=__codelineno-0-1261 name=__codelineno-0-1261></a><span class=sd>            ...     print(f&quot;Batch keys: {list(batch.keys())}&quot;)</span>
</span><span id=__span-0-1262><a id=__codelineno-0-1262 name=__codelineno-0-1262></a><span class=sd>            ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-1263><a id=__codelineno-0-1263 name=__codelineno-0-1263></a><span class=sd>            ...     break</span>
</span><span id=__span-0-1264><a id=__codelineno-0-1264 name=__codelineno-0-1264></a><span class=sd>            Batch keys: [&#39;X&#39;, &#39;cell_ids&#39;]</span>
</span><span id=__span-0-1265><a id=__codelineno-0-1265 name=__codelineno-0-1265></a><span class=sd>            Cell IDs: [0, 1, 2, ..., 29, 30, 31]</span>
</span><span id=__span-0-1266><a id=__codelineno-0-1266 name=__codelineno-0-1266></a>
</span><span id=__span-0-1267><a id=__codelineno-0-1267 name=__codelineno-0-1267></a><span class=sd>            &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-1268><a id=__codelineno-0-1268 name=__codelineno-0-1268></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(&quot;path/to/experiment&quot;, n_epochs=3)</span>
</span><span id=__span-0-1269><a id=__codelineno-0-1269 name=__codelineno-0-1269></a><span class=sd>            &gt;&gt;&gt; epochs_seen = set()</span>
</span><span id=__span-0-1270><a id=__codelineno-0-1270 name=__codelineno-0-1270></a><span class=sd>            &gt;&gt;&gt; for batch in dataset:</span>
</span><span id=__span-0-1271><a id=__codelineno-0-1271 name=__codelineno-0-1271></a><span class=sd>            ...     if &#39;epoch&#39; in batch:</span>
</span><span id=__span-0-1272><a id=__codelineno-0-1272 name=__codelineno-0-1272></a><span class=sd>            ...         epochs_seen.add(batch[&#39;epoch&#39;])</span>
</span><span id=__span-0-1273><a id=__codelineno-0-1273 name=__codelineno-0-1273></a><span class=sd>            ...     if len(epochs_seen) &gt;= 3:</span>
</span><span id=__span-0-1274><a id=__codelineno-0-1274 name=__codelineno-0-1274></a><span class=sd>            ...         break</span>
</span><span id=__span-0-1275><a id=__codelineno-0-1275 name=__codelineno-0-1275></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Epochs completed: {sorted(epochs_seen)}&quot;)</span>
</span><span id=__span-0-1276><a id=__codelineno-0-1276 name=__codelineno-0-1276></a><span class=sd>            Epochs completed: [0, 1, 2]</span>
</span><span id=__span-0-1277><a id=__codelineno-0-1277 name=__codelineno-0-1277></a>
</span><span id=__span-0-1278><a id=__codelineno-0-1278 name=__codelineno-0-1278></a><span class=sd>            &gt;&gt;&gt; # Training loop with error handling</span>
</span><span id=__span-0-1279><a id=__codelineno-0-1279 name=__codelineno-0-1279></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1280><a id=__codelineno-0-1280 name=__codelineno-0-1280></a><span class=sd>            &gt;&gt;&gt; for batch_idx, batch in enumerate(dataset):</span>
</span><span id=__span-0-1281><a id=__codelineno-0-1281 name=__codelineno-0-1281></a><span class=sd>            ...     try:</span>
</span><span id=__span-0-1282><a id=__codelineno-0-1282 name=__codelineno-0-1282></a><span class=sd>            ...         x = batch[&quot;X&quot;]</span>
</span><span id=__span-0-1283><a id=__codelineno-0-1283 name=__codelineno-0-1283></a><span class=sd>            ...         cell_ids = batch[&quot;cell_ids&quot;]</span>
</span><span id=__span-0-1284><a id=__codelineno-0-1284 name=__codelineno-0-1284></a><span class=sd>            ...         print(f&quot;Processed batch {batch_idx} with {len(cell_ids)} cells&quot;)</span>
</span><span id=__span-0-1285><a id=__codelineno-0-1285 name=__codelineno-0-1285></a><span class=sd>            ...     except Exception as e:</span>
</span><span id=__span-0-1286><a id=__codelineno-0-1286 name=__codelineno-0-1286></a><span class=sd>            ...         print(f&quot;Error in batch {batch_idx}: {e}&quot;)</span>
</span><span id=__span-0-1287><a id=__codelineno-0-1287 name=__codelineno-0-1287></a><span class=sd>            ...         continue</span>
</span><span id=__span-0-1288><a id=__codelineno-0-1288 name=__codelineno-0-1288></a><span class=sd>            ...     if batch_idx &gt;= 2:  # Just first few batches</span>
</span><span id=__span-0-1289><a id=__codelineno-0-1289 name=__codelineno-0-1289></a><span class=sd>            ...         break</span>
</span><span id=__span-0-1290><a id=__codelineno-0-1290 name=__codelineno-0-1290></a><span class=sd>            Processed batch 0 with 32 cells</span>
</span><span id=__span-0-1291><a id=__codelineno-0-1291 name=__codelineno-0-1291></a><span class=sd>            Processed batch 1 with 32 cells</span>
</span><span id=__span-0-1292><a id=__codelineno-0-1292 name=__codelineno-0-1292></a><span class=sd>            Processed batch 2 with 32 cells</span>
</span><span id=__span-0-1293><a id=__codelineno-0-1293 name=__codelineno-0-1293></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1294><a id=__codelineno-0-1294 name=__codelineno-0-1294></a>        <span class=n>batches_yielded</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-1295><a id=__codelineno-0-1295 name=__codelineno-0-1295></a>        <span class=n>current_epoch</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-1296><a id=__codelineno-0-1296 name=__codelineno-0-1296></a>        <span class=n>last_epoch</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-0-1297><a id=__codelineno-0-1297 name=__codelineno-0-1297></a>
</span><span id=__span-0-1298><a id=__codelineno-0-1298 name=__codelineno-0-1298></a>        <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-0-1299><a id=__codelineno-0-1299 name=__codelineno-0-1299></a>            <span class=c1># Get data from prefetcher</span>
</span><span id=__span-0-1300><a id=__codelineno-0-1300 name=__codelineno-0-1300></a>            <span class=n>data_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-1301><a id=__codelineno-0-1301 name=__codelineno-0-1301></a>            <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-1302><a id=__codelineno-0-1302 name=__codelineno-0-1302></a>            <span class=n>data_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>data_start</span>
</span><span id=__span-0-1303><a id=__codelineno-0-1303 name=__codelineno-0-1303></a>
</span><span id=__span-0-1304><a id=__codelineno-0-1304 name=__codelineno-0-1304></a>            <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-1305><a id=__codelineno-0-1305 name=__codelineno-0-1305></a>                <span class=c1># Check if prefetcher has finished all epochs</span>
</span><span id=__span-0-1306><a id=__codelineno-0-1306 name=__codelineno-0-1306></a>                <span class=n>stats</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>get_stats</span><span class=p>()</span>
</span><span id=__span-0-1307><a id=__codelineno-0-1307 name=__codelineno-0-1307></a>                <span class=k>if</span> <span class=n>stats</span><span class=p>[</span><span class=s2>&quot;current_epoch&quot;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>stats</span><span class=p>[</span><span class=s2>&quot;n_epochs&quot;</span><span class=p>]:</span>
</span><span id=__span-0-1308><a id=__codelineno-0-1308 name=__codelineno-0-1308></a>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1309><a id=__codelineno-0-1309 name=__codelineno-0-1309></a>                        <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-1310><a id=__codelineno-0-1310 name=__codelineno-0-1310></a>                            <span class=sa>f</span><span class=s2>&quot; Dataset iteration complete: all </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;n_epochs&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> epochs finished&quot;</span>
</span><span id=__span-0-1311><a id=__codelineno-0-1311 name=__codelineno-0-1311></a>                        <span class=p>)</span>
</span><span id=__span-0-1312><a id=__codelineno-0-1312 name=__codelineno-0-1312></a>                    <span class=k>break</span>
</span><span id=__span-0-1313><a id=__codelineno-0-1313 name=__codelineno-0-1313></a>
</span><span id=__span-0-1314><a id=__codelineno-0-1314 name=__codelineno-0-1314></a>                <span class=c1># Wait for more data with timeout</span>
</span><span id=__span-0-1315><a id=__codelineno-0-1315 name=__codelineno-0-1315></a>                <span class=n>wait_start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-1316><a id=__codelineno-0-1316 name=__codelineno-0-1316></a>                <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>has_batch</span><span class=p>():</span>
</span><span id=__span-0-1317><a id=__codelineno-0-1317 name=__codelineno-0-1317></a>                    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span><span id=__span-0-1318><a id=__codelineno-0-1318 name=__codelineno-0-1318></a>                    <span class=c1># Timeout after 5 seconds to avoid infinite wait</span>
</span><span id=__span-0-1319><a id=__codelineno-0-1319 name=__codelineno-0-1319></a>                    <span class=k>if</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>wait_start</span> <span class=o>&gt;</span> <span class=mf>5.0</span><span class=p>:</span>
</span><span id=__span-0-1320><a id=__codelineno-0-1320 name=__codelineno-0-1320></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1321><a id=__codelineno-0-1321 name=__codelineno-0-1321></a>                            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot; Timeout waiting for prefetcher data&quot;</span><span class=p>)</span>
</span><span id=__span-0-1322><a id=__codelineno-0-1322 name=__codelineno-0-1322></a>                        <span class=k>break</span>
</span><span id=__span-0-1323><a id=__codelineno-0-1323 name=__codelineno-0-1323></a>
</span><span id=__span-0-1324><a id=__codelineno-0-1324 name=__codelineno-0-1324></a>                <span class=n>data</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>get_batch</span><span class=p>()</span>
</span><span id=__span-0-1325><a id=__codelineno-0-1325 name=__codelineno-0-1325></a>                <span class=k>if</span> <span class=n>data</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-1326><a id=__codelineno-0-1326 name=__codelineno-0-1326></a>                    <span class=c1># Double-check if prefetcher is done</span>
</span><span id=__span-0-1327><a id=__codelineno-0-1327 name=__codelineno-0-1327></a>                    <span class=n>stats</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>get_stats</span><span class=p>()</span>
</span><span id=__span-0-1328><a id=__codelineno-0-1328 name=__codelineno-0-1328></a>                    <span class=k>if</span> <span class=n>stats</span><span class=p>[</span><span class=s2>&quot;current_epoch&quot;</span><span class=p>]</span> <span class=o>&gt;=</span> <span class=n>stats</span><span class=p>[</span><span class=s2>&quot;n_epochs&quot;</span><span class=p>]:</span>
</span><span id=__span-0-1329><a id=__codelineno-0-1329 name=__codelineno-0-1329></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1330><a id=__codelineno-0-1330 name=__codelineno-0-1330></a>                            <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-1331><a id=__codelineno-0-1331 name=__codelineno-0-1331></a>                                <span class=sa>f</span><span class=s2>&quot; Dataset iteration complete: all </span><span class=si>{</span><span class=n>stats</span><span class=p>[</span><span class=s1>&#39;n_epochs&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> epochs finished&quot;</span>
</span><span id=__span-0-1332><a id=__codelineno-0-1332 name=__codelineno-0-1332></a>                            <span class=p>)</span>
</span><span id=__span-0-1333><a id=__codelineno-0-1333 name=__codelineno-0-1333></a>                        <span class=k>break</span>
</span><span id=__span-0-1334><a id=__codelineno-0-1334 name=__codelineno-0-1334></a>                    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-1335><a id=__codelineno-0-1335 name=__codelineno-0-1335></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1336><a id=__codelineno-0-1336 name=__codelineno-0-1336></a>                            <span class=nb>print</span><span class=p>(</span><span class=s2>&quot; No data available from prefetcher&quot;</span><span class=p>)</span>
</span><span id=__span-0-1337><a id=__codelineno-0-1337 name=__codelineno-0-1337></a>                        <span class=k>break</span>
</span><span id=__span-0-1338><a id=__codelineno-0-1338 name=__codelineno-0-1338></a>
</span><span id=__span-0-1339><a id=__codelineno-0-1339 name=__codelineno-0-1339></a>            <span class=c1># Track epoch transitions</span>
</span><span id=__span-0-1340><a id=__codelineno-0-1340 name=__codelineno-0-1340></a>            <span class=n>current_epoch</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=o>.</span><span class=n>current_epoch</span>
</span><span id=__span-0-1341><a id=__codelineno-0-1341 name=__codelineno-0-1341></a>            <span class=k>if</span> <span class=n>current_epoch</span> <span class=o>!=</span> <span class=n>last_epoch</span><span class=p>:</span>
</span><span id=__span-0-1342><a id=__codelineno-0-1342 name=__codelineno-0-1342></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-1343><a id=__codelineno-0-1343 name=__codelineno-0-1343></a>                    <span class=nb>print</span><span class=p>(</span>
</span><span id=__span-0-1344><a id=__codelineno-0-1344 name=__codelineno-0-1344></a>                        <span class=sa>f</span><span class=s2>&quot; Epoch transition detected: </span><span class=si>{</span><span class=n>last_epoch</span><span class=si>}</span><span class=s2> -&gt; </span><span class=si>{</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-1345><a id=__codelineno-0-1345 name=__codelineno-0-1345></a>                    <span class=p>)</span>
</span><span id=__span-0-1346><a id=__codelineno-0-1346 name=__codelineno-0-1346></a>                <span class=n>last_epoch</span> <span class=o>=</span> <span class=n>current_epoch</span>
</span><span id=__span-0-1347><a id=__codelineno-0-1347 name=__codelineno-0-1347></a>
</span><span id=__span-0-1348><a id=__codelineno-0-1348 name=__codelineno-0-1348></a>            <span class=c1># Process batch data</span>
</span><span id=__span-0-1349><a id=__codelineno-0-1349 name=__codelineno-0-1349></a>            <span class=n>batch_df</span> <span class=o>=</span> <span class=n>data</span><span class=o>.</span><span class=n>batch_df</span>
</span><span id=__span-0-1350><a id=__codelineno-0-1350 name=__codelineno-0-1350></a>
</span><span id=__span-0-1351><a id=__codelineno-0-1351 name=__codelineno-0-1351></a>            <span class=c1># Time the overall batch processing</span>
</span><span id=__span-0-1352><a id=__codelineno-0-1352 name=__codelineno-0-1352></a>            <span class=n>batch_start_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span><span id=__span-0-1353><a id=__codelineno-0-1353 name=__codelineno-0-1353></a>
</span><span id=__span-0-1354><a id=__codelineno-0-1354 name=__codelineno-0-1354></a>            <span class=c1># Get unique cell IDs in this batch</span>
</span><span id=__span-0-1355><a id=__codelineno-0-1355 name=__codelineno-0-1355></a>            <span class=n>batch_cell_ids</span> <span class=o>=</span> <span class=n>batch_df</span><span class=p>[</span><span class=s2>&quot;cell_integer_id&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>unique</span><span class=p>()</span><span class=o>.</span><span class=n>to_list</span><span class=p>()</span>
</span><span id=__span-0-1356><a id=__codelineno-0-1356 name=__codelineno-0-1356></a>
</span><span id=__span-0-1357><a id=__codelineno-0-1357 name=__codelineno-0-1357></a>            <span class=c1># Calculate total batch processing time</span>
</span><span id=__span-0-1358><a id=__codelineno-0-1358 name=__codelineno-0-1358></a>            <span class=n>total_batch_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span> <span class=o>-</span> <span class=n>batch_start_time</span>
</span><span id=__span-0-1359><a id=__codelineno-0-1359 name=__codelineno-0-1359></a>
</span><span id=__span-0-1360><a id=__codelineno-0-1360 name=__codelineno-0-1360></a>            <span class=c1># Create batch dictionary</span>
</span><span id=__span-0-1361><a id=__codelineno-0-1361 name=__codelineno-0-1361></a>            <span class=n>batch_dict</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-1362><a id=__codelineno-0-1362 name=__codelineno-0-1362></a>                <span class=s2>&quot;X&quot;</span><span class=p>:</span> <span class=n>batch_df</span><span class=p>,</span>  <span class=c1># Polars DataFrame with CSR-like structure</span>
</span><span id=__span-0-1363><a id=__codelineno-0-1363 name=__codelineno-0-1363></a>                <span class=s2>&quot;cell_ids&quot;</span><span class=p>:</span> <span class=n>batch_cell_ids</span><span class=p>,</span>
</span><span id=__span-0-1364><a id=__codelineno-0-1364 name=__codelineno-0-1364></a>            <span class=p>}</span>
</span><span id=__span-0-1365><a id=__codelineno-0-1365 name=__codelineno-0-1365></a>
</span><span id=__span-0-1366><a id=__codelineno-0-1366 name=__codelineno-0-1366></a>            <span class=c1># Add epoch info if multi-epoch training</span>
</span><span id=__span-0-1367><a id=__codelineno-0-1367 name=__codelineno-0-1367></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
</span><span id=__span-0-1368><a id=__codelineno-0-1368 name=__codelineno-0-1368></a>                <span class=n>batch_dict</span><span class=p>[</span><span class=s2>&quot;epoch&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>current_epoch</span>
</span><span id=__span-0-1369><a id=__codelineno-0-1369 name=__codelineno-0-1369></a>
</span><span id=__span-0-1370><a id=__codelineno-0-1370 name=__codelineno-0-1370></a>            <span class=n>batches_yielded</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-1371><a id=__codelineno-0-1371 name=__codelineno-0-1371></a>
</span><span id=__span-0-1372><a id=__codelineno-0-1372 name=__codelineno-0-1372></a>            <span class=c1># Print detailed timing every 100 batches</span>
</span><span id=__span-0-1373><a id=__codelineno-0-1373 name=__codelineno-0-1373></a>            <span class=k>if</span> <span class=n>batches_yielded</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-1374><a id=__codelineno-0-1374 name=__codelineno-0-1374></a>                <span class=c1># Consolidate training batch reporting</span>
</span><span id=__span-0-1375><a id=__codelineno-0-1375 name=__codelineno-0-1375></a>                <span class=n>training_report</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;  TileDB training batch </span><span class=si>{</span><span class=n>batches_yielded</span><span class=si>}</span><span class=s2> (epoch </span><span class=si>{</span><span class=n>current_epoch</span><span class=si>}</span><span class=s2>) processing:</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-1376><a id=__codelineno-0-1376 name=__codelineno-0-1376></a>                <span class=n>training_report</span> <span class=o>+=</span> <span class=sa>f</span><span class=s2>&quot;     Data retrieval: </span><span class=si>{</span><span class=n>data_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-1377><a id=__codelineno-0-1377 name=__codelineno-0-1377></a>                <span class=n>training_report</span> <span class=o>+=</span> <span class=p>(</span>
</span><span id=__span-0-1378><a id=__codelineno-0-1378 name=__codelineno-0-1378></a>                    <span class=sa>f</span><span class=s2>&quot;     Total batch time: </span><span class=si>{</span><span class=n>total_batch_time</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>1000</span><span class=si>:</span><span class=s2>.1f</span><span class=si>}</span><span class=s2>ms</span><span class=se>\n</span><span class=s2>&quot;</span>
</span><span id=__span-0-1379><a id=__codelineno-0-1379 name=__codelineno-0-1379></a>                <span class=p>)</span>
</span><span id=__span-0-1380><a id=__codelineno-0-1380 name=__codelineno-0-1380></a>                <span class=n>training_report</span> <span class=o>+=</span> <span class=s2>&quot;     Raw data (polars DataFrame)&quot;</span>
</span><span id=__span-0-1381><a id=__codelineno-0-1381 name=__codelineno-0-1381></a>
</span><span id=__span-0-1382><a id=__codelineno-0-1382 name=__codelineno-0-1382></a>                <span class=n>print_training</span><span class=p>(</span><span class=n>training_report</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span><span class=p>)</span>
</span><span id=__span-0-1383><a id=__codelineno-0-1383 name=__codelineno-0-1383></a>
</span><span id=__span-0-1384><a id=__codelineno-0-1384 name=__codelineno-0-1384></a>            <span class=k>yield</span> <span class=n>batch_dict</span>
</span><span id=__span-0-1385><a id=__codelineno-0-1385 name=__codelineno-0-1385></a>
</span><span id=__span-0-1386><a id=__codelineno-0-1386 name=__codelineno-0-1386></a>    <span class=k>def</span><span class=w> </span><span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-1387><a id=__codelineno-0-1387 name=__codelineno-0-1387></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1388><a id=__codelineno-0-1388 name=__codelineno-0-1388></a><span class=sd>        Cleanup when dataset is destroyed.</span>
</span><span id=__span-0-1389><a id=__codelineno-0-1389 name=__codelineno-0-1389></a>
</span><span id=__span-0-1390><a id=__codelineno-0-1390 name=__codelineno-0-1390></a><span class=sd>        This method is called when the dataset object is garbage collected.</span>
</span><span id=__span-0-1391><a id=__codelineno-0-1391 name=__codelineno-0-1391></a><span class=sd>        It ensures that the underlying prefetcher is properly stopped to</span>
</span><span id=__span-0-1392><a id=__codelineno-0-1392 name=__codelineno-0-1392></a><span class=sd>        prevent resource leaks and background thread issues.</span>
</span><span id=__span-0-1393><a id=__codelineno-0-1393 name=__codelineno-0-1393></a>
</span><span id=__span-0-1394><a id=__codelineno-0-1394 name=__codelineno-0-1394></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1395><a id=__codelineno-0-1395 name=__codelineno-0-1395></a><span class=sd>            &gt;&gt;&gt; # Dataset cleanup happens automatically</span>
</span><span id=__span-0-1396><a id=__codelineno-0-1396 name=__codelineno-0-1396></a><span class=sd>            &gt;&gt;&gt; dataset = TileDBIterableDataset(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1397><a id=__codelineno-0-1397 name=__codelineno-0-1397></a><span class=sd>            &gt;&gt;&gt; print(&quot;Dataset created&quot;)</span>
</span><span id=__span-0-1398><a id=__codelineno-0-1398 name=__codelineno-0-1398></a><span class=sd>            Dataset created</span>
</span><span id=__span-0-1399><a id=__codelineno-0-1399 name=__codelineno-0-1399></a><span class=sd>            &gt;&gt;&gt; # When dataset goes out of scope, __del__ is called automatically</span>
</span><span id=__span-0-1400><a id=__codelineno-0-1400 name=__codelineno-0-1400></a><span class=sd>            &gt;&gt;&gt; del dataset</span>
</span><span id=__span-0-1401><a id=__codelineno-0-1401 name=__codelineno-0-1401></a><span class=sd>            &gt;&gt;&gt; print(&quot;Dataset destroyed and cleaned up&quot;)</span>
</span><span id=__span-0-1402><a id=__codelineno-0-1402 name=__codelineno-0-1402></a><span class=sd>            Dataset destroyed and cleaned up</span>
</span><span id=__span-0-1403><a id=__codelineno-0-1403 name=__codelineno-0-1403></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1404><a id=__codelineno-0-1404 name=__codelineno-0-1404></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <h5 id=slaf.ml.tiledb_dataloaders.TileDBIterableDataset-functions>Functions<a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset-functions class=headerlink title="Permanent link">&para;</a></h5> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBIterableDataset.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span> <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>,</span> <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span> <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>)</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBIterableDataset.__init__ class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Initialize the TileDB IterableDataset with async prefetching.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tiledb_path</code> </td> <td> <code><span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>Path to the TileDB SOMA experiment directory. Must contain a valid SOMA experiment with RNA measurement data.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells per training batch. Larger batches use more memory but may improve training efficiency. Range: 1-512, default: 32.</p> </div> </td> <td> <code>32</code> </td> </tr> <tr class=doc-section-item> <td> <code>prefetch_batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells to load per prefetch batch from TileDB. Higher values improve throughput but use more memory. Range: 10-10000, default: 100.</p> </div> </td> <td> <code>100</code> </td> </tr> <tr class=doc-section-item> <td> <code>seed</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Random seed for reproducible shuffling and MoS sampling. Used for consistent data ordering across runs. Default: 42.</p> </div> </td> <td> <code>42</code> </td> </tr> <tr class=doc-section-item> <td> <code>max_queue_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Maximum number of pre-processed batches to keep in queue. Higher values use more memory but provide better buffering. Range: 10-10000, default: 500.</p> </div> </td> <td> <code>500</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_epochs</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of epochs to run. The dataset will automatically reset after each epoch, enabling multi-epoch training. Default: 1.</p> </div> </td> <td> <code>1</code> </td> </tr> <tr class=doc-section-item> <td> <code>verbose</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, print detailed timing and progress information. If False, suppress all internal prints for clean output. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>use_mixture_of_scanners</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, use MoS strategy for higher entropy by randomly sampling from multiple fragment generators. Provides better randomization for foundation model training. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_readers</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Total number of fragment generators to create when using MoS. Higher values provide better entropy but use more memory. Range: 1-1000, default: 50.</p> </div> </td> <td> <code>50</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_scanners</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of active scanners to sample from simultaneously when using MoS. Higher values provide better entropy but use more memory. Range: 1-100, default: 8.</p> </div> </td> <td> <code>8</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ImportError>ImportError</span></code> </td> <td> <div class=doc-md-description> <p>If TileDB SOMA is not available.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If MoS parameters are invalid.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=RuntimeError>RuntimeError</span></code> </td> <td> <div class=doc-md-description> <p>If the TileDB experiment cannot be opened or is invalid.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic initialization with default MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataset</span> <span class=o>=</span> <span class=n>TileDBIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS enabled: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataset</span> <span class=o>=</span> <span class=n>TileDBIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sequential loading: </span><span class=si>{</span><span class=ow>not</span><span class=w> </span><span class=n>dataset</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Sequential loading: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># High-entropy MoS configuration</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataset</span> <span class=o>=</span> <span class=n>TileDBIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_readers</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>n_scanners</span><span class=o>=</span><span class=mi>16</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS readers: </span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>n_readers</span><span class=si>}</span><span class=s2>, scanners: </span><span class=si>{</span><span class=n>dataset</span><span class=o>.</span><span class=n>n_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS readers: 100, scanners: 16</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1105>1105</a></span>
<span class=normal><a href=#__codelineno-0-1106>1106</a></span>
<span class=normal><a href=#__codelineno-0-1107>1107</a></span>
<span class=normal><a href=#__codelineno-0-1108>1108</a></span>
<span class=normal><a href=#__codelineno-0-1109>1109</a></span>
<span class=normal><a href=#__codelineno-0-1110>1110</a></span>
<span class=normal><a href=#__codelineno-0-1111>1111</a></span>
<span class=normal><a href=#__codelineno-0-1112>1112</a></span>
<span class=normal><a href=#__codelineno-0-1113>1113</a></span>
<span class=normal><a href=#__codelineno-0-1114>1114</a></span>
<span class=normal><a href=#__codelineno-0-1115>1115</a></span>
<span class=normal><a href=#__codelineno-0-1116>1116</a></span>
<span class=normal><a href=#__codelineno-0-1117>1117</a></span>
<span class=normal><a href=#__codelineno-0-1118>1118</a></span>
<span class=normal><a href=#__codelineno-0-1119>1119</a></span>
<span class=normal><a href=#__codelineno-0-1120>1120</a></span>
<span class=normal><a href=#__codelineno-0-1121>1121</a></span>
<span class=normal><a href=#__codelineno-0-1122>1122</a></span>
<span class=normal><a href=#__codelineno-0-1123>1123</a></span>
<span class=normal><a href=#__codelineno-0-1124>1124</a></span>
<span class=normal><a href=#__codelineno-0-1125>1125</a></span>
<span class=normal><a href=#__codelineno-0-1126>1126</a></span>
<span class=normal><a href=#__codelineno-0-1127>1127</a></span>
<span class=normal><a href=#__codelineno-0-1128>1128</a></span>
<span class=normal><a href=#__codelineno-0-1129>1129</a></span>
<span class=normal><a href=#__codelineno-0-1130>1130</a></span>
<span class=normal><a href=#__codelineno-0-1131>1131</a></span>
<span class=normal><a href=#__codelineno-0-1132>1132</a></span>
<span class=normal><a href=#__codelineno-0-1133>1133</a></span>
<span class=normal><a href=#__codelineno-0-1134>1134</a></span>
<span class=normal><a href=#__codelineno-0-1135>1135</a></span>
<span class=normal><a href=#__codelineno-0-1136>1136</a></span>
<span class=normal><a href=#__codelineno-0-1137>1137</a></span>
<span class=normal><a href=#__codelineno-0-1138>1138</a></span>
<span class=normal><a href=#__codelineno-0-1139>1139</a></span>
<span class=normal><a href=#__codelineno-0-1140>1140</a></span>
<span class=normal><a href=#__codelineno-0-1141>1141</a></span>
<span class=normal><a href=#__codelineno-0-1142>1142</a></span>
<span class=normal><a href=#__codelineno-0-1143>1143</a></span>
<span class=normal><a href=#__codelineno-0-1144>1144</a></span>
<span class=normal><a href=#__codelineno-0-1145>1145</a></span>
<span class=normal><a href=#__codelineno-0-1146>1146</a></span>
<span class=normal><a href=#__codelineno-0-1147>1147</a></span>
<span class=normal><a href=#__codelineno-0-1148>1148</a></span>
<span class=normal><a href=#__codelineno-0-1149>1149</a></span>
<span class=normal><a href=#__codelineno-0-1150>1150</a></span>
<span class=normal><a href=#__codelineno-0-1151>1151</a></span>
<span class=normal><a href=#__codelineno-0-1152>1152</a></span>
<span class=normal><a href=#__codelineno-0-1153>1153</a></span>
<span class=normal><a href=#__codelineno-0-1154>1154</a></span>
<span class=normal><a href=#__codelineno-0-1155>1155</a></span>
<span class=normal><a href=#__codelineno-0-1156>1156</a></span>
<span class=normal><a href=#__codelineno-0-1157>1157</a></span>
<span class=normal><a href=#__codelineno-0-1158>1158</a></span>
<span class=normal><a href=#__codelineno-0-1159>1159</a></span>
<span class=normal><a href=#__codelineno-0-1160>1160</a></span>
<span class=normal><a href=#__codelineno-0-1161>1161</a></span>
<span class=normal><a href=#__codelineno-0-1162>1162</a></span>
<span class=normal><a href=#__codelineno-0-1163>1163</a></span>
<span class=normal><a href=#__codelineno-0-1164>1164</a></span>
<span class=normal><a href=#__codelineno-0-1165>1165</a></span>
<span class=normal><a href=#__codelineno-0-1166>1166</a></span>
<span class=normal><a href=#__codelineno-0-1167>1167</a></span>
<span class=normal><a href=#__codelineno-0-1168>1168</a></span>
<span class=normal><a href=#__codelineno-0-1169>1169</a></span>
<span class=normal><a href=#__codelineno-0-1170>1170</a></span>
<span class=normal><a href=#__codelineno-0-1171>1171</a></span>
<span class=normal><a href=#__codelineno-0-1172>1172</a></span>
<span class=normal><a href=#__codelineno-0-1173>1173</a></span>
<span class=normal><a href=#__codelineno-0-1174>1174</a></span>
<span class=normal><a href=#__codelineno-0-1175>1175</a></span>
<span class=normal><a href=#__codelineno-0-1176>1176</a></span>
<span class=normal><a href=#__codelineno-0-1177>1177</a></span>
<span class=normal><a href=#__codelineno-0-1178>1178</a></span>
<span class=normal><a href=#__codelineno-0-1179>1179</a></span>
<span class=normal><a href=#__codelineno-0-1180>1180</a></span>
<span class=normal><a href=#__codelineno-0-1181>1181</a></span>
<span class=normal><a href=#__codelineno-0-1182>1182</a></span>
<span class=normal><a href=#__codelineno-0-1183>1183</a></span>
<span class=normal><a href=#__codelineno-0-1184>1184</a></span>
<span class=normal><a href=#__codelineno-0-1185>1185</a></span>
<span class=normal><a href=#__codelineno-0-1186>1186</a></span>
<span class=normal><a href=#__codelineno-0-1187>1187</a></span>
<span class=normal><a href=#__codelineno-0-1188>1188</a></span>
<span class=normal><a href=#__codelineno-0-1189>1189</a></span>
<span class=normal><a href=#__codelineno-0-1190>1190</a></span>
<span class=normal><a href=#__codelineno-0-1191>1191</a></span>
<span class=normal><a href=#__codelineno-0-1192>1192</a></span>
<span class=normal><a href=#__codelineno-0-1193>1193</a></span>
<span class=normal><a href=#__codelineno-0-1194>1194</a></span>
<span class=normal><a href=#__codelineno-0-1195>1195</a></span>
<span class=normal><a href=#__codelineno-0-1196>1196</a></span>
<span class=normal><a href=#__codelineno-0-1197>1197</a></span>
<span class=normal><a href=#__codelineno-0-1198>1198</a></span>
<span class=normal><a href=#__codelineno-0-1199>1199</a></span>
<span class=normal><a href=#__codelineno-0-1200>1200</a></span>
<span class=normal><a href=#__codelineno-0-1201>1201</a></span>
<span class=normal><a href=#__codelineno-0-1202>1202</a></span>
<span class=normal><a href=#__codelineno-0-1203>1203</a></span>
<span class=normal><a href=#__codelineno-0-1204>1204</a></span>
<span class=normal><a href=#__codelineno-0-1205>1205</a></span>
<span class=normal><a href=#__codelineno-0-1206>1206</a></span>
<span class=normal><a href=#__codelineno-0-1207>1207</a></span>
<span class=normal><a href=#__codelineno-0-1208>1208</a></span>
<span class=normal><a href=#__codelineno-0-1209>1209</a></span>
<span class=normal><a href=#__codelineno-0-1210>1210</a></span>
<span class=normal><a href=#__codelineno-0-1211>1211</a></span>
<span class=normal><a href=#__codelineno-0-1212>1212</a></span>
<span class=normal><a href=#__codelineno-0-1213>1213</a></span>
<span class=normal><a href=#__codelineno-0-1214>1214</a></span>
<span class=normal><a href=#__codelineno-0-1215>1215</a></span>
<span class=normal><a href=#__codelineno-0-1216>1216</a></span>
<span class=normal><a href=#__codelineno-0-1217>1217</a></span>
<span class=normal><a href=#__codelineno-0-1218>1218</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1105><a id=__codelineno-0-1105 name=__codelineno-0-1105></a><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-1106><a id=__codelineno-0-1106 name=__codelineno-0-1106></a>    <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-1107><a id=__codelineno-0-1107 name=__codelineno-0-1107></a>    <span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-1108><a id=__codelineno-0-1108 name=__codelineno-0-1108></a>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-1109><a id=__codelineno-0-1109 name=__codelineno-0-1109></a>    <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-1110><a id=__codelineno-0-1110 name=__codelineno-0-1110></a>    <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span>
</span><span id=__span-0-1111><a id=__codelineno-0-1111 name=__codelineno-0-1111></a>    <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>,</span>
</span><span id=__span-0-1112><a id=__codelineno-0-1112 name=__codelineno-0-1112></a>    <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-1113><a id=__codelineno-0-1113 name=__codelineno-0-1113></a>    <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1114><a id=__codelineno-0-1114 name=__codelineno-0-1114></a>    <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1115><a id=__codelineno-0-1115 name=__codelineno-0-1115></a>    <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span><span id=__span-0-1116><a id=__codelineno-0-1116 name=__codelineno-0-1116></a>    <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-0-1117><a id=__codelineno-0-1117 name=__codelineno-0-1117></a><span class=p>):</span>
</span><span id=__span-0-1118><a id=__codelineno-0-1118 name=__codelineno-0-1118></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1119><a id=__codelineno-0-1119 name=__codelineno-0-1119></a><span class=sd>    Initialize the TileDB IterableDataset with async prefetching.</span>
</span><span id=__span-0-1120><a id=__codelineno-0-1120 name=__codelineno-0-1120></a>
</span><span id=__span-0-1121><a id=__codelineno-0-1121 name=__codelineno-0-1121></a><span class=sd>    Args:</span>
</span><span id=__span-0-1122><a id=__codelineno-0-1122 name=__codelineno-0-1122></a><span class=sd>        tiledb_path: Path to the TileDB SOMA experiment directory.</span>
</span><span id=__span-0-1123><a id=__codelineno-0-1123 name=__codelineno-0-1123></a><span class=sd>                     Must contain a valid SOMA experiment with RNA measurement data.</span>
</span><span id=__span-0-1124><a id=__codelineno-0-1124 name=__codelineno-0-1124></a><span class=sd>        batch_size: Number of cells per training batch. Larger batches use more</span>
</span><span id=__span-0-1125><a id=__codelineno-0-1125 name=__codelineno-0-1125></a><span class=sd>                   memory but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-1126><a id=__codelineno-0-1126 name=__codelineno-0-1126></a><span class=sd>        prefetch_batch_size: Number of cells to load per prefetch batch from TileDB.</span>
</span><span id=__span-0-1127><a id=__codelineno-0-1127 name=__codelineno-0-1127></a><span class=sd>                           Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-1128><a id=__codelineno-0-1128 name=__codelineno-0-1128></a><span class=sd>                           Range: 10-10000, default: 100.</span>
</span><span id=__span-0-1129><a id=__codelineno-0-1129 name=__codelineno-0-1129></a><span class=sd>        seed: Random seed for reproducible shuffling and MoS sampling.</span>
</span><span id=__span-0-1130><a id=__codelineno-0-1130 name=__codelineno-0-1130></a><span class=sd>              Used for consistent data ordering across runs. Default: 42.</span>
</span><span id=__span-0-1131><a id=__codelineno-0-1131 name=__codelineno-0-1131></a><span class=sd>        max_queue_size: Maximum number of pre-processed batches to keep in queue.</span>
</span><span id=__span-0-1132><a id=__codelineno-0-1132 name=__codelineno-0-1132></a><span class=sd>                      Higher values use more memory but provide better buffering.</span>
</span><span id=__span-0-1133><a id=__codelineno-0-1133 name=__codelineno-0-1133></a><span class=sd>                      Range: 10-10000, default: 500.</span>
</span><span id=__span-0-1134><a id=__codelineno-0-1134 name=__codelineno-0-1134></a><span class=sd>        n_epochs: Number of epochs to run. The dataset will automatically reset</span>
</span><span id=__span-0-1135><a id=__codelineno-0-1135 name=__codelineno-0-1135></a><span class=sd>                 after each epoch, enabling multi-epoch training. Default: 1.</span>
</span><span id=__span-0-1136><a id=__codelineno-0-1136 name=__codelineno-0-1136></a><span class=sd>        verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-1137><a id=__codelineno-0-1137 name=__codelineno-0-1137></a><span class=sd>                If False, suppress all internal prints for clean output. Default: True.</span>
</span><span id=__span-0-1138><a id=__codelineno-0-1138 name=__codelineno-0-1138></a><span class=sd>        use_mixture_of_scanners: If True, use MoS strategy for higher entropy by</span>
</span><span id=__span-0-1139><a id=__codelineno-0-1139 name=__codelineno-0-1139></a><span class=sd>                               randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-1140><a id=__codelineno-0-1140 name=__codelineno-0-1140></a><span class=sd>                               Provides better randomization for foundation model training.</span>
</span><span id=__span-0-1141><a id=__codelineno-0-1141 name=__codelineno-0-1141></a><span class=sd>                               Default: True.</span>
</span><span id=__span-0-1142><a id=__codelineno-0-1142 name=__codelineno-0-1142></a><span class=sd>        n_readers: Total number of fragment generators to create when using MoS.</span>
</span><span id=__span-0-1143><a id=__codelineno-0-1143 name=__codelineno-0-1143></a><span class=sd>                  Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1144><a id=__codelineno-0-1144 name=__codelineno-0-1144></a><span class=sd>                  Range: 1-1000, default: 50.</span>
</span><span id=__span-0-1145><a id=__codelineno-0-1145 name=__codelineno-0-1145></a><span class=sd>        n_scanners: Number of active scanners to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-1146><a id=__codelineno-0-1146 name=__codelineno-0-1146></a><span class=sd>                   Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1147><a id=__codelineno-0-1147 name=__codelineno-0-1147></a><span class=sd>                   Range: 1-100, default: 8.</span>
</span><span id=__span-0-1148><a id=__codelineno-0-1148 name=__codelineno-0-1148></a>
</span><span id=__span-0-1149><a id=__codelineno-0-1149 name=__codelineno-0-1149></a><span class=sd>    Raises:</span>
</span><span id=__span-0-1150><a id=__codelineno-0-1150 name=__codelineno-0-1150></a><span class=sd>        ImportError: If TileDB SOMA is not available.</span>
</span><span id=__span-0-1151><a id=__codelineno-0-1151 name=__codelineno-0-1151></a><span class=sd>        ValueError: If MoS parameters are invalid.</span>
</span><span id=__span-0-1152><a id=__codelineno-0-1152 name=__codelineno-0-1152></a><span class=sd>        RuntimeError: If the TileDB experiment cannot be opened or is invalid.</span>
</span><span id=__span-0-1153><a id=__codelineno-0-1153 name=__codelineno-0-1153></a>
</span><span id=__span-0-1154><a id=__codelineno-0-1154 name=__codelineno-0-1154></a><span class=sd>    Examples:</span>
</span><span id=__span-0-1155><a id=__codelineno-0-1155 name=__codelineno-0-1155></a><span class=sd>        &gt;&gt;&gt; # Basic initialization with default MoS strategy</span>
</span><span id=__span-0-1156><a id=__codelineno-0-1156 name=__codelineno-0-1156></a><span class=sd>        &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1157><a id=__codelineno-0-1157 name=__codelineno-0-1157></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1158><a id=__codelineno-0-1158 name=__codelineno-0-1158></a><span class=sd>        ...     batch_size=32,</span>
</span><span id=__span-0-1159><a id=__codelineno-0-1159 name=__codelineno-0-1159></a><span class=sd>        ...     prefetch_batch_size=100</span>
</span><span id=__span-0-1160><a id=__codelineno-0-1160 name=__codelineno-0-1160></a><span class=sd>        ... )</span>
</span><span id=__span-0-1161><a id=__codelineno-0-1161 name=__codelineno-0-1161></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {dataset.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1162><a id=__codelineno-0-1162 name=__codelineno-0-1162></a><span class=sd>        MoS enabled: True</span>
</span><span id=__span-0-1163><a id=__codelineno-0-1163 name=__codelineno-0-1163></a>
</span><span id=__span-0-1164><a id=__codelineno-0-1164 name=__codelineno-0-1164></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-1165><a id=__codelineno-0-1165 name=__codelineno-0-1165></a><span class=sd>        &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1166><a id=__codelineno-0-1166 name=__codelineno-0-1166></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1167><a id=__codelineno-0-1167 name=__codelineno-0-1167></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-1168><a id=__codelineno-0-1168 name=__codelineno-0-1168></a><span class=sd>        ...     batch_size=64</span>
</span><span id=__span-0-1169><a id=__codelineno-0-1169 name=__codelineno-0-1169></a><span class=sd>        ... )</span>
</span><span id=__span-0-1170><a id=__codelineno-0-1170 name=__codelineno-0-1170></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataset.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1171><a id=__codelineno-0-1171 name=__codelineno-0-1171></a><span class=sd>        Sequential loading: True</span>
</span><span id=__span-0-1172><a id=__codelineno-0-1172 name=__codelineno-0-1172></a>
</span><span id=__span-0-1173><a id=__codelineno-0-1173 name=__codelineno-0-1173></a><span class=sd>        &gt;&gt;&gt; # High-entropy MoS configuration</span>
</span><span id=__span-0-1174><a id=__codelineno-0-1174 name=__codelineno-0-1174></a><span class=sd>        &gt;&gt;&gt; dataset = TileDBIterableDataset(</span>
</span><span id=__span-0-1175><a id=__codelineno-0-1175 name=__codelineno-0-1175></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1176><a id=__codelineno-0-1176 name=__codelineno-0-1176></a><span class=sd>        ...     n_readers=100,</span>
</span><span id=__span-0-1177><a id=__codelineno-0-1177 name=__codelineno-0-1177></a><span class=sd>        ...     n_scanners=16</span>
</span><span id=__span-0-1178><a id=__codelineno-0-1178 name=__codelineno-0-1178></a><span class=sd>        ... )</span>
</span><span id=__span-0-1179><a id=__codelineno-0-1179 name=__codelineno-0-1179></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS readers: {dataset.n_readers}, scanners: {dataset.n_scanners}&quot;)</span>
</span><span id=__span-0-1180><a id=__codelineno-0-1180 name=__codelineno-0-1180></a><span class=sd>        MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-1181><a id=__codelineno-0-1181 name=__codelineno-0-1181></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-1182><a id=__codelineno-0-1182 name=__codelineno-0-1182></a>    <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>()</span>
</span><span id=__span-0-1183><a id=__codelineno-0-1183 name=__codelineno-0-1183></a>    <span class=bp>self</span><span class=o>.</span><span class=n>tiledb_path</span> <span class=o>=</span> <span class=n>tiledb_path</span>
</span><span id=__span-0-1184><a id=__codelineno-0-1184 name=__codelineno-0-1184></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-1185><a id=__codelineno-0-1185 name=__codelineno-0-1185></a>    <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=n>prefetch_batch_size</span>
</span><span id=__span-0-1186><a id=__codelineno-0-1186 name=__codelineno-0-1186></a>    <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>=</span> <span class=n>seed</span>
</span><span id=__span-0-1187><a id=__codelineno-0-1187 name=__codelineno-0-1187></a>    <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>
</span><span id=__span-0-1188><a id=__codelineno-0-1188 name=__codelineno-0-1188></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-1189><a id=__codelineno-0-1189 name=__codelineno-0-1189></a>    <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span><span id=__span-0-1190><a id=__codelineno-0-1190 name=__codelineno-0-1190></a>    <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>
</span><span id=__span-0-1191><a id=__codelineno-0-1191 name=__codelineno-0-1191></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>=</span> <span class=n>n_readers</span>
</span><span id=__span-0-1192><a id=__codelineno-0-1192 name=__codelineno-0-1192></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>
</span><span id=__span-0-1193><a id=__codelineno-0-1193 name=__codelineno-0-1193></a>
</span><span id=__span-0-1194><a id=__codelineno-0-1194 name=__codelineno-0-1194></a>    <span class=c1># Initialize batch processor</span>
</span><span id=__span-0-1195><a id=__codelineno-0-1195 name=__codelineno-0-1195></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span> <span class=o>=</span> <span class=n>TileDBBatchProcessor</span><span class=p>(</span>
</span><span id=__span-0-1196><a id=__codelineno-0-1196 name=__codelineno-0-1196></a>        <span class=n>tiledb_path</span><span class=o>=</span><span class=n>tiledb_path</span><span class=p>,</span>
</span><span id=__span-0-1197><a id=__codelineno-0-1197 name=__codelineno-0-1197></a>        <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-1198><a id=__codelineno-0-1198 name=__codelineno-0-1198></a>        <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-1199><a id=__codelineno-0-1199 name=__codelineno-0-1199></a>        <span class=n>seed</span><span class=o>=</span><span class=n>seed</span><span class=p>,</span>
</span><span id=__span-0-1200><a id=__codelineno-0-1200 name=__codelineno-0-1200></a>        <span class=n>n_epochs</span><span class=o>=</span><span class=n>n_epochs</span><span class=p>,</span>
</span><span id=__span-0-1201><a id=__codelineno-0-1201 name=__codelineno-0-1201></a>        <span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-1202><a id=__codelineno-0-1202 name=__codelineno-0-1202></a>        <span class=n>log_metrics</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-1203><a id=__codelineno-0-1203 name=__codelineno-0-1203></a>        <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=n>use_mixture_of_scanners</span><span class=p>,</span>
</span><span id=__span-0-1204><a id=__codelineno-0-1204 name=__codelineno-0-1204></a>        <span class=n>n_readers</span><span class=o>=</span><span class=n>n_readers</span><span class=p>,</span>
</span><span id=__span-0-1205><a id=__codelineno-0-1205 name=__codelineno-0-1205></a>        <span class=n>n_scanners</span><span class=o>=</span><span class=n>n_scanners</span><span class=p>,</span>
</span><span id=__span-0-1206><a id=__codelineno-0-1206 name=__codelineno-0-1206></a>    <span class=p>)</span>
</span><span id=__span-0-1207><a id=__codelineno-0-1207 name=__codelineno-0-1207></a>
</span><span id=__span-0-1208><a id=__codelineno-0-1208 name=__codelineno-0-1208></a>    <span class=c1># Initialize async prefetcher</span>
</span><span id=__span-0-1209><a id=__codelineno-0-1209 name=__codelineno-0-1209></a>    <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span> <span class=o>=</span> <span class=n>TileDBAsyncPrefetcher</span><span class=p>(</span>
</span><span id=__span-0-1210><a id=__codelineno-0-1210 name=__codelineno-0-1210></a>        <span class=n>batch_processor</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>batch_processor</span><span class=p>,</span>
</span><span id=__span-0-1211><a id=__codelineno-0-1211 name=__codelineno-0-1211></a>        <span class=n>max_queue_size</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>,</span>
</span><span id=__span-0-1212><a id=__codelineno-0-1212 name=__codelineno-0-1212></a>    <span class=p>)</span>
</span><span id=__span-0-1213><a id=__codelineno-0-1213 name=__codelineno-0-1213></a>
</span><span id=__span-0-1214><a id=__codelineno-0-1214 name=__codelineno-0-1214></a>    <span class=c1># Start async prefetching</span>
</span><span id=__span-0-1215><a id=__codelineno-0-1215 name=__codelineno-0-1215></a>    <span class=bp>self</span><span class=o>.</span><span class=n>prefetcher</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
</span><span id=__span-0-1216><a id=__codelineno-0-1216 name=__codelineno-0-1216></a>
</span><span id=__span-0-1217><a id=__codelineno-0-1217 name=__codelineno-0-1217></a>    <span class=c1># Wait for prefetcher to initialize</span>
</span><span id=__span-0-1218><a id=__codelineno-0-1218 name=__codelineno-0-1218></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_wait_for_prefetcher_ready</span><span class=p>()</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tiledb_dataloaders.TileDBDataLoader class="doc doc-heading"> <code>TileDBDataLoader</code> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>High-performance DataLoader for TileDB SOMA data optimized for ML training.</p> <p>TileDBDataLoader provides efficient streaming of single-cell data from TileDB SOMA format for machine learning applications. It uses async batch processing and provides multiple loading strategies for different use cases.</p> <details class=key-features open> <summary>Key Features</summary> <ul> <li>Multiple loading strategies for different entropy requirements:<ul> <li>Mixture of Scanners (MoS): Maximum entropy, best randomization (default)</li> <li>Sequential loading: Fastest, lowest entropy</li> </ul> </li> <li>Asynchronous background prefetching for improved throughput</li> <li>Multi-epoch training support with automatic epoch transitions</li> <li>Memory-efficient streaming with configurable batch sizes</li> <li>Comprehensive error handling and validation</li> <li>Performance monitoring and statistics</li> <li>PyTorch IterableDataset compatibility</li> </ul> </details> <details class=loading-strategies open> <summary>Loading Strategies</summary> <ol> <li>Mixture of Scanners (default): Randomly samples from multiple generators for maximum entropy and randomization</li> <li>Sequential: Loads contiguous data chunks for maximum throughput</li> </ol> </details> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic usage with default MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=k>for</span> <span class=n>batch</span> <span class=ow>in</span> <span class=n>dataloader</span><span class=p>:</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Batch keys: </span><span class=si>{</span><span class=nb>list</span><span class=p>(</span><span class=n>batch</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Cell IDs: </span><span class=si>{</span><span class=n>batch</span><span class=p>[</span><span class=s1>&#39;cell_ids&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=gp>... </span>    <span class=k>break</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=go>Batch keys: [&#39;X&#39;, &#39;cell_ids&#39;]</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=go>Cell IDs: [0, 1, 2, ..., 29, 30, 31]</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS enabled: False</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Multi-epoch training</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_epochs</span><span class=o>=</span><span class=mi>3</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Number of epochs: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>n_epochs</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Number of epochs: 3</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Custom MoS configuration</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_readers</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>n_scanners</span><span class=o>=</span><span class=mi>16</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS readers: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>n_readers</span><span class=si>}</span><span class=s2>, scanners: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>n_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS readers: 100, scanners: 16</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1407>1407</a></span>
<span class=normal><a href=#__codelineno-0-1408>1408</a></span>
<span class=normal><a href=#__codelineno-0-1409>1409</a></span>
<span class=normal><a href=#__codelineno-0-1410>1410</a></span>
<span class=normal><a href=#__codelineno-0-1411>1411</a></span>
<span class=normal><a href=#__codelineno-0-1412>1412</a></span>
<span class=normal><a href=#__codelineno-0-1413>1413</a></span>
<span class=normal><a href=#__codelineno-0-1414>1414</a></span>
<span class=normal><a href=#__codelineno-0-1415>1415</a></span>
<span class=normal><a href=#__codelineno-0-1416>1416</a></span>
<span class=normal><a href=#__codelineno-0-1417>1417</a></span>
<span class=normal><a href=#__codelineno-0-1418>1418</a></span>
<span class=normal><a href=#__codelineno-0-1419>1419</a></span>
<span class=normal><a href=#__codelineno-0-1420>1420</a></span>
<span class=normal><a href=#__codelineno-0-1421>1421</a></span>
<span class=normal><a href=#__codelineno-0-1422>1422</a></span>
<span class=normal><a href=#__codelineno-0-1423>1423</a></span>
<span class=normal><a href=#__codelineno-0-1424>1424</a></span>
<span class=normal><a href=#__codelineno-0-1425>1425</a></span>
<span class=normal><a href=#__codelineno-0-1426>1426</a></span>
<span class=normal><a href=#__codelineno-0-1427>1427</a></span>
<span class=normal><a href=#__codelineno-0-1428>1428</a></span>
<span class=normal><a href=#__codelineno-0-1429>1429</a></span>
<span class=normal><a href=#__codelineno-0-1430>1430</a></span>
<span class=normal><a href=#__codelineno-0-1431>1431</a></span>
<span class=normal><a href=#__codelineno-0-1432>1432</a></span>
<span class=normal><a href=#__codelineno-0-1433>1433</a></span>
<span class=normal><a href=#__codelineno-0-1434>1434</a></span>
<span class=normal><a href=#__codelineno-0-1435>1435</a></span>
<span class=normal><a href=#__codelineno-0-1436>1436</a></span>
<span class=normal><a href=#__codelineno-0-1437>1437</a></span>
<span class=normal><a href=#__codelineno-0-1438>1438</a></span>
<span class=normal><a href=#__codelineno-0-1439>1439</a></span>
<span class=normal><a href=#__codelineno-0-1440>1440</a></span>
<span class=normal><a href=#__codelineno-0-1441>1441</a></span>
<span class=normal><a href=#__codelineno-0-1442>1442</a></span>
<span class=normal><a href=#__codelineno-0-1443>1443</a></span>
<span class=normal><a href=#__codelineno-0-1444>1444</a></span>
<span class=normal><a href=#__codelineno-0-1445>1445</a></span>
<span class=normal><a href=#__codelineno-0-1446>1446</a></span>
<span class=normal><a href=#__codelineno-0-1447>1447</a></span>
<span class=normal><a href=#__codelineno-0-1448>1448</a></span>
<span class=normal><a href=#__codelineno-0-1449>1449</a></span>
<span class=normal><a href=#__codelineno-0-1450>1450</a></span>
<span class=normal><a href=#__codelineno-0-1451>1451</a></span>
<span class=normal><a href=#__codelineno-0-1452>1452</a></span>
<span class=normal><a href=#__codelineno-0-1453>1453</a></span>
<span class=normal><a href=#__codelineno-0-1454>1454</a></span>
<span class=normal><a href=#__codelineno-0-1455>1455</a></span>
<span class=normal><a href=#__codelineno-0-1456>1456</a></span>
<span class=normal><a href=#__codelineno-0-1457>1457</a></span>
<span class=normal><a href=#__codelineno-0-1458>1458</a></span>
<span class=normal><a href=#__codelineno-0-1459>1459</a></span>
<span class=normal><a href=#__codelineno-0-1460>1460</a></span>
<span class=normal><a href=#__codelineno-0-1461>1461</a></span>
<span class=normal><a href=#__codelineno-0-1462>1462</a></span>
<span class=normal><a href=#__codelineno-0-1463>1463</a></span>
<span class=normal><a href=#__codelineno-0-1464>1464</a></span>
<span class=normal><a href=#__codelineno-0-1465>1465</a></span>
<span class=normal><a href=#__codelineno-0-1466>1466</a></span>
<span class=normal><a href=#__codelineno-0-1467>1467</a></span>
<span class=normal><a href=#__codelineno-0-1468>1468</a></span>
<span class=normal><a href=#__codelineno-0-1469>1469</a></span>
<span class=normal><a href=#__codelineno-0-1470>1470</a></span>
<span class=normal><a href=#__codelineno-0-1471>1471</a></span>
<span class=normal><a href=#__codelineno-0-1472>1472</a></span>
<span class=normal><a href=#__codelineno-0-1473>1473</a></span>
<span class=normal><a href=#__codelineno-0-1474>1474</a></span>
<span class=normal><a href=#__codelineno-0-1475>1475</a></span>
<span class=normal><a href=#__codelineno-0-1476>1476</a></span>
<span class=normal><a href=#__codelineno-0-1477>1477</a></span>
<span class=normal><a href=#__codelineno-0-1478>1478</a></span>
<span class=normal><a href=#__codelineno-0-1479>1479</a></span>
<span class=normal><a href=#__codelineno-0-1480>1480</a></span>
<span class=normal><a href=#__codelineno-0-1481>1481</a></span>
<span class=normal><a href=#__codelineno-0-1482>1482</a></span>
<span class=normal><a href=#__codelineno-0-1483>1483</a></span>
<span class=normal><a href=#__codelineno-0-1484>1484</a></span>
<span class=normal><a href=#__codelineno-0-1485>1485</a></span>
<span class=normal><a href=#__codelineno-0-1486>1486</a></span>
<span class=normal><a href=#__codelineno-0-1487>1487</a></span>
<span class=normal><a href=#__codelineno-0-1488>1488</a></span>
<span class=normal><a href=#__codelineno-0-1489>1489</a></span>
<span class=normal><a href=#__codelineno-0-1490>1490</a></span>
<span class=normal><a href=#__codelineno-0-1491>1491</a></span>
<span class=normal><a href=#__codelineno-0-1492>1492</a></span>
<span class=normal><a href=#__codelineno-0-1493>1493</a></span>
<span class=normal><a href=#__codelineno-0-1494>1494</a></span>
<span class=normal><a href=#__codelineno-0-1495>1495</a></span>
<span class=normal><a href=#__codelineno-0-1496>1496</a></span>
<span class=normal><a href=#__codelineno-0-1497>1497</a></span>
<span class=normal><a href=#__codelineno-0-1498>1498</a></span>
<span class=normal><a href=#__codelineno-0-1499>1499</a></span>
<span class=normal><a href=#__codelineno-0-1500>1500</a></span>
<span class=normal><a href=#__codelineno-0-1501>1501</a></span>
<span class=normal><a href=#__codelineno-0-1502>1502</a></span>
<span class=normal><a href=#__codelineno-0-1503>1503</a></span>
<span class=normal><a href=#__codelineno-0-1504>1504</a></span>
<span class=normal><a href=#__codelineno-0-1505>1505</a></span>
<span class=normal><a href=#__codelineno-0-1506>1506</a></span>
<span class=normal><a href=#__codelineno-0-1507>1507</a></span>
<span class=normal><a href=#__codelineno-0-1508>1508</a></span>
<span class=normal><a href=#__codelineno-0-1509>1509</a></span>
<span class=normal><a href=#__codelineno-0-1510>1510</a></span>
<span class=normal><a href=#__codelineno-0-1511>1511</a></span>
<span class=normal><a href=#__codelineno-0-1512>1512</a></span>
<span class=normal><a href=#__codelineno-0-1513>1513</a></span>
<span class=normal><a href=#__codelineno-0-1514>1514</a></span>
<span class=normal><a href=#__codelineno-0-1515>1515</a></span>
<span class=normal><a href=#__codelineno-0-1516>1516</a></span>
<span class=normal><a href=#__codelineno-0-1517>1517</a></span>
<span class=normal><a href=#__codelineno-0-1518>1518</a></span>
<span class=normal><a href=#__codelineno-0-1519>1519</a></span>
<span class=normal><a href=#__codelineno-0-1520>1520</a></span>
<span class=normal><a href=#__codelineno-0-1521>1521</a></span>
<span class=normal><a href=#__codelineno-0-1522>1522</a></span>
<span class=normal><a href=#__codelineno-0-1523>1523</a></span>
<span class=normal><a href=#__codelineno-0-1524>1524</a></span>
<span class=normal><a href=#__codelineno-0-1525>1525</a></span>
<span class=normal><a href=#__codelineno-0-1526>1526</a></span>
<span class=normal><a href=#__codelineno-0-1527>1527</a></span>
<span class=normal><a href=#__codelineno-0-1528>1528</a></span>
<span class=normal><a href=#__codelineno-0-1529>1529</a></span>
<span class=normal><a href=#__codelineno-0-1530>1530</a></span>
<span class=normal><a href=#__codelineno-0-1531>1531</a></span>
<span class=normal><a href=#__codelineno-0-1532>1532</a></span>
<span class=normal><a href=#__codelineno-0-1533>1533</a></span>
<span class=normal><a href=#__codelineno-0-1534>1534</a></span>
<span class=normal><a href=#__codelineno-0-1535>1535</a></span>
<span class=normal><a href=#__codelineno-0-1536>1536</a></span>
<span class=normal><a href=#__codelineno-0-1537>1537</a></span>
<span class=normal><a href=#__codelineno-0-1538>1538</a></span>
<span class=normal><a href=#__codelineno-0-1539>1539</a></span>
<span class=normal><a href=#__codelineno-0-1540>1540</a></span>
<span class=normal><a href=#__codelineno-0-1541>1541</a></span>
<span class=normal><a href=#__codelineno-0-1542>1542</a></span>
<span class=normal><a href=#__codelineno-0-1543>1543</a></span>
<span class=normal><a href=#__codelineno-0-1544>1544</a></span>
<span class=normal><a href=#__codelineno-0-1545>1545</a></span>
<span class=normal><a href=#__codelineno-0-1546>1546</a></span>
<span class=normal><a href=#__codelineno-0-1547>1547</a></span>
<span class=normal><a href=#__codelineno-0-1548>1548</a></span>
<span class=normal><a href=#__codelineno-0-1549>1549</a></span>
<span class=normal><a href=#__codelineno-0-1550>1550</a></span>
<span class=normal><a href=#__codelineno-0-1551>1551</a></span>
<span class=normal><a href=#__codelineno-0-1552>1552</a></span>
<span class=normal><a href=#__codelineno-0-1553>1553</a></span>
<span class=normal><a href=#__codelineno-0-1554>1554</a></span>
<span class=normal><a href=#__codelineno-0-1555>1555</a></span>
<span class=normal><a href=#__codelineno-0-1556>1556</a></span>
<span class=normal><a href=#__codelineno-0-1557>1557</a></span>
<span class=normal><a href=#__codelineno-0-1558>1558</a></span>
<span class=normal><a href=#__codelineno-0-1559>1559</a></span>
<span class=normal><a href=#__codelineno-0-1560>1560</a></span>
<span class=normal><a href=#__codelineno-0-1561>1561</a></span>
<span class=normal><a href=#__codelineno-0-1562>1562</a></span>
<span class=normal><a href=#__codelineno-0-1563>1563</a></span>
<span class=normal><a href=#__codelineno-0-1564>1564</a></span>
<span class=normal><a href=#__codelineno-0-1565>1565</a></span>
<span class=normal><a href=#__codelineno-0-1566>1566</a></span>
<span class=normal><a href=#__codelineno-0-1567>1567</a></span>
<span class=normal><a href=#__codelineno-0-1568>1568</a></span>
<span class=normal><a href=#__codelineno-0-1569>1569</a></span>
<span class=normal><a href=#__codelineno-0-1570>1570</a></span>
<span class=normal><a href=#__codelineno-0-1571>1571</a></span>
<span class=normal><a href=#__codelineno-0-1572>1572</a></span>
<span class=normal><a href=#__codelineno-0-1573>1573</a></span>
<span class=normal><a href=#__codelineno-0-1574>1574</a></span>
<span class=normal><a href=#__codelineno-0-1575>1575</a></span>
<span class=normal><a href=#__codelineno-0-1576>1576</a></span>
<span class=normal><a href=#__codelineno-0-1577>1577</a></span>
<span class=normal><a href=#__codelineno-0-1578>1578</a></span>
<span class=normal><a href=#__codelineno-0-1579>1579</a></span>
<span class=normal><a href=#__codelineno-0-1580>1580</a></span>
<span class=normal><a href=#__codelineno-0-1581>1581</a></span>
<span class=normal><a href=#__codelineno-0-1582>1582</a></span>
<span class=normal><a href=#__codelineno-0-1583>1583</a></span>
<span class=normal><a href=#__codelineno-0-1584>1584</a></span>
<span class=normal><a href=#__codelineno-0-1585>1585</a></span>
<span class=normal><a href=#__codelineno-0-1586>1586</a></span>
<span class=normal><a href=#__codelineno-0-1587>1587</a></span>
<span class=normal><a href=#__codelineno-0-1588>1588</a></span>
<span class=normal><a href=#__codelineno-0-1589>1589</a></span>
<span class=normal><a href=#__codelineno-0-1590>1590</a></span>
<span class=normal><a href=#__codelineno-0-1591>1591</a></span>
<span class=normal><a href=#__codelineno-0-1592>1592</a></span>
<span class=normal><a href=#__codelineno-0-1593>1593</a></span>
<span class=normal><a href=#__codelineno-0-1594>1594</a></span>
<span class=normal><a href=#__codelineno-0-1595>1595</a></span>
<span class=normal><a href=#__codelineno-0-1596>1596</a></span>
<span class=normal><a href=#__codelineno-0-1597>1597</a></span>
<span class=normal><a href=#__codelineno-0-1598>1598</a></span>
<span class=normal><a href=#__codelineno-0-1599>1599</a></span>
<span class=normal><a href=#__codelineno-0-1600>1600</a></span>
<span class=normal><a href=#__codelineno-0-1601>1601</a></span>
<span class=normal><a href=#__codelineno-0-1602>1602</a></span>
<span class=normal><a href=#__codelineno-0-1603>1603</a></span>
<span class=normal><a href=#__codelineno-0-1604>1604</a></span>
<span class=normal><a href=#__codelineno-0-1605>1605</a></span>
<span class=normal><a href=#__codelineno-0-1606>1606</a></span>
<span class=normal><a href=#__codelineno-0-1607>1607</a></span>
<span class=normal><a href=#__codelineno-0-1608>1608</a></span>
<span class=normal><a href=#__codelineno-0-1609>1609</a></span>
<span class=normal><a href=#__codelineno-0-1610>1610</a></span>
<span class=normal><a href=#__codelineno-0-1611>1611</a></span>
<span class=normal><a href=#__codelineno-0-1612>1612</a></span>
<span class=normal><a href=#__codelineno-0-1613>1613</a></span>
<span class=normal><a href=#__codelineno-0-1614>1614</a></span>
<span class=normal><a href=#__codelineno-0-1615>1615</a></span>
<span class=normal><a href=#__codelineno-0-1616>1616</a></span>
<span class=normal><a href=#__codelineno-0-1617>1617</a></span>
<span class=normal><a href=#__codelineno-0-1618>1618</a></span>
<span class=normal><a href=#__codelineno-0-1619>1619</a></span>
<span class=normal><a href=#__codelineno-0-1620>1620</a></span>
<span class=normal><a href=#__codelineno-0-1621>1621</a></span>
<span class=normal><a href=#__codelineno-0-1622>1622</a></span>
<span class=normal><a href=#__codelineno-0-1623>1623</a></span>
<span class=normal><a href=#__codelineno-0-1624>1624</a></span>
<span class=normal><a href=#__codelineno-0-1625>1625</a></span>
<span class=normal><a href=#__codelineno-0-1626>1626</a></span>
<span class=normal><a href=#__codelineno-0-1627>1627</a></span>
<span class=normal><a href=#__codelineno-0-1628>1628</a></span>
<span class=normal><a href=#__codelineno-0-1629>1629</a></span>
<span class=normal><a href=#__codelineno-0-1630>1630</a></span>
<span class=normal><a href=#__codelineno-0-1631>1631</a></span>
<span class=normal><a href=#__codelineno-0-1632>1632</a></span>
<span class=normal><a href=#__codelineno-0-1633>1633</a></span>
<span class=normal><a href=#__codelineno-0-1634>1634</a></span>
<span class=normal><a href=#__codelineno-0-1635>1635</a></span>
<span class=normal><a href=#__codelineno-0-1636>1636</a></span>
<span class=normal><a href=#__codelineno-0-1637>1637</a></span>
<span class=normal><a href=#__codelineno-0-1638>1638</a></span>
<span class=normal><a href=#__codelineno-0-1639>1639</a></span>
<span class=normal><a href=#__codelineno-0-1640>1640</a></span>
<span class=normal><a href=#__codelineno-0-1641>1641</a></span>
<span class=normal><a href=#__codelineno-0-1642>1642</a></span>
<span class=normal><a href=#__codelineno-0-1643>1643</a></span>
<span class=normal><a href=#__codelineno-0-1644>1644</a></span>
<span class=normal><a href=#__codelineno-0-1645>1645</a></span>
<span class=normal><a href=#__codelineno-0-1646>1646</a></span>
<span class=normal><a href=#__codelineno-0-1647>1647</a></span>
<span class=normal><a href=#__codelineno-0-1648>1648</a></span>
<span class=normal><a href=#__codelineno-0-1649>1649</a></span>
<span class=normal><a href=#__codelineno-0-1650>1650</a></span>
<span class=normal><a href=#__codelineno-0-1651>1651</a></span>
<span class=normal><a href=#__codelineno-0-1652>1652</a></span>
<span class=normal><a href=#__codelineno-0-1653>1653</a></span>
<span class=normal><a href=#__codelineno-0-1654>1654</a></span>
<span class=normal><a href=#__codelineno-0-1655>1655</a></span>
<span class=normal><a href=#__codelineno-0-1656>1656</a></span>
<span class=normal><a href=#__codelineno-0-1657>1657</a></span>
<span class=normal><a href=#__codelineno-0-1658>1658</a></span>
<span class=normal><a href=#__codelineno-0-1659>1659</a></span>
<span class=normal><a href=#__codelineno-0-1660>1660</a></span>
<span class=normal><a href=#__codelineno-0-1661>1661</a></span>
<span class=normal><a href=#__codelineno-0-1662>1662</a></span>
<span class=normal><a href=#__codelineno-0-1663>1663</a></span>
<span class=normal><a href=#__codelineno-0-1664>1664</a></span>
<span class=normal><a href=#__codelineno-0-1665>1665</a></span>
<span class=normal><a href=#__codelineno-0-1666>1666</a></span>
<span class=normal><a href=#__codelineno-0-1667>1667</a></span>
<span class=normal><a href=#__codelineno-0-1668>1668</a></span>
<span class=normal><a href=#__codelineno-0-1669>1669</a></span>
<span class=normal><a href=#__codelineno-0-1670>1670</a></span>
<span class=normal><a href=#__codelineno-0-1671>1671</a></span>
<span class=normal><a href=#__codelineno-0-1672>1672</a></span>
<span class=normal><a href=#__codelineno-0-1673>1673</a></span>
<span class=normal><a href=#__codelineno-0-1674>1674</a></span>
<span class=normal><a href=#__codelineno-0-1675>1675</a></span>
<span class=normal><a href=#__codelineno-0-1676>1676</a></span>
<span class=normal><a href=#__codelineno-0-1677>1677</a></span>
<span class=normal><a href=#__codelineno-0-1678>1678</a></span>
<span class=normal><a href=#__codelineno-0-1679>1679</a></span>
<span class=normal><a href=#__codelineno-0-1680>1680</a></span>
<span class=normal><a href=#__codelineno-0-1681>1681</a></span>
<span class=normal><a href=#__codelineno-0-1682>1682</a></span>
<span class=normal><a href=#__codelineno-0-1683>1683</a></span>
<span class=normal><a href=#__codelineno-0-1684>1684</a></span>
<span class=normal><a href=#__codelineno-0-1685>1685</a></span>
<span class=normal><a href=#__codelineno-0-1686>1686</a></span>
<span class=normal><a href=#__codelineno-0-1687>1687</a></span>
<span class=normal><a href=#__codelineno-0-1688>1688</a></span>
<span class=normal><a href=#__codelineno-0-1689>1689</a></span>
<span class=normal><a href=#__codelineno-0-1690>1690</a></span>
<span class=normal><a href=#__codelineno-0-1691>1691</a></span>
<span class=normal><a href=#__codelineno-0-1692>1692</a></span>
<span class=normal><a href=#__codelineno-0-1693>1693</a></span>
<span class=normal><a href=#__codelineno-0-1694>1694</a></span>
<span class=normal><a href=#__codelineno-0-1695>1695</a></span>
<span class=normal><a href=#__codelineno-0-1696>1696</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1407><a id=__codelineno-0-1407 name=__codelineno-0-1407></a><span class=k>class</span><span class=w> </span><span class=nc>TileDBDataLoader</span><span class=p>:</span>
</span><span id=__span-0-1408><a id=__codelineno-0-1408 name=__codelineno-0-1408></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1409><a id=__codelineno-0-1409 name=__codelineno-0-1409></a><span class=sd>    High-performance DataLoader for TileDB SOMA data optimized for ML training.</span>
</span><span id=__span-0-1410><a id=__codelineno-0-1410 name=__codelineno-0-1410></a>
</span><span id=__span-0-1411><a id=__codelineno-0-1411 name=__codelineno-0-1411></a><span class=sd>    TileDBDataLoader provides efficient streaming of single-cell data from TileDB</span>
</span><span id=__span-0-1412><a id=__codelineno-0-1412 name=__codelineno-0-1412></a><span class=sd>    SOMA format for machine learning applications. It uses async batch processing</span>
</span><span id=__span-0-1413><a id=__codelineno-0-1413 name=__codelineno-0-1413></a><span class=sd>    and provides multiple loading strategies for different use cases.</span>
</span><span id=__span-0-1414><a id=__codelineno-0-1414 name=__codelineno-0-1414></a>
</span><span id=__span-0-1415><a id=__codelineno-0-1415 name=__codelineno-0-1415></a><span class=sd>    Key Features:</span>
</span><span id=__span-0-1416><a id=__codelineno-0-1416 name=__codelineno-0-1416></a><span class=sd>        - Multiple loading strategies for different entropy requirements:</span>
</span><span id=__span-0-1417><a id=__codelineno-0-1417 name=__codelineno-0-1417></a><span class=sd>            * Mixture of Scanners (MoS): Maximum entropy, best randomization (default)</span>
</span><span id=__span-0-1418><a id=__codelineno-0-1418 name=__codelineno-0-1418></a><span class=sd>            * Sequential loading: Fastest, lowest entropy</span>
</span><span id=__span-0-1419><a id=__codelineno-0-1419 name=__codelineno-0-1419></a><span class=sd>        - Asynchronous background prefetching for improved throughput</span>
</span><span id=__span-0-1420><a id=__codelineno-0-1420 name=__codelineno-0-1420></a><span class=sd>        - Multi-epoch training support with automatic epoch transitions</span>
</span><span id=__span-0-1421><a id=__codelineno-0-1421 name=__codelineno-0-1421></a><span class=sd>        - Memory-efficient streaming with configurable batch sizes</span>
</span><span id=__span-0-1422><a id=__codelineno-0-1422 name=__codelineno-0-1422></a><span class=sd>        - Comprehensive error handling and validation</span>
</span><span id=__span-0-1423><a id=__codelineno-0-1423 name=__codelineno-0-1423></a><span class=sd>        - Performance monitoring and statistics</span>
</span><span id=__span-0-1424><a id=__codelineno-0-1424 name=__codelineno-0-1424></a><span class=sd>        - PyTorch IterableDataset compatibility</span>
</span><span id=__span-0-1425><a id=__codelineno-0-1425 name=__codelineno-0-1425></a>
</span><span id=__span-0-1426><a id=__codelineno-0-1426 name=__codelineno-0-1426></a><span class=sd>    Loading Strategies:</span>
</span><span id=__span-0-1427><a id=__codelineno-0-1427 name=__codelineno-0-1427></a><span class=sd>        1. Mixture of Scanners (default): Randomly samples from multiple generators</span>
</span><span id=__span-0-1428><a id=__codelineno-0-1428 name=__codelineno-0-1428></a><span class=sd>           for maximum entropy and randomization</span>
</span><span id=__span-0-1429><a id=__codelineno-0-1429 name=__codelineno-0-1429></a><span class=sd>        2. Sequential: Loads contiguous data chunks for maximum throughput</span>
</span><span id=__span-0-1430><a id=__codelineno-0-1430 name=__codelineno-0-1430></a>
</span><span id=__span-0-1431><a id=__codelineno-0-1431 name=__codelineno-0-1431></a><span class=sd>    Examples:</span>
</span><span id=__span-0-1432><a id=__codelineno-0-1432 name=__codelineno-0-1432></a><span class=sd>        &gt;&gt;&gt; # Basic usage with default MoS strategy</span>
</span><span id=__span-0-1433><a id=__codelineno-0-1433 name=__codelineno-0-1433></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1434><a id=__codelineno-0-1434 name=__codelineno-0-1434></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1435><a id=__codelineno-0-1435 name=__codelineno-0-1435></a><span class=sd>        ...     batch_size=32,</span>
</span><span id=__span-0-1436><a id=__codelineno-0-1436 name=__codelineno-0-1436></a><span class=sd>        ...     prefetch_batch_size=100</span>
</span><span id=__span-0-1437><a id=__codelineno-0-1437 name=__codelineno-0-1437></a><span class=sd>        ... )</span>
</span><span id=__span-0-1438><a id=__codelineno-0-1438 name=__codelineno-0-1438></a><span class=sd>        &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-1439><a id=__codelineno-0-1439 name=__codelineno-0-1439></a><span class=sd>        ...     print(f&quot;Batch keys: {list(batch.keys())}&quot;)</span>
</span><span id=__span-0-1440><a id=__codelineno-0-1440 name=__codelineno-0-1440></a><span class=sd>        ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-1441><a id=__codelineno-0-1441 name=__codelineno-0-1441></a><span class=sd>        ...     break</span>
</span><span id=__span-0-1442><a id=__codelineno-0-1442 name=__codelineno-0-1442></a><span class=sd>        Batch keys: [&#39;X&#39;, &#39;cell_ids&#39;]</span>
</span><span id=__span-0-1443><a id=__codelineno-0-1443 name=__codelineno-0-1443></a><span class=sd>        Cell IDs: [0, 1, 2, ..., 29, 30, 31]</span>
</span><span id=__span-0-1444><a id=__codelineno-0-1444 name=__codelineno-0-1444></a>
</span><span id=__span-0-1445><a id=__codelineno-0-1445 name=__codelineno-0-1445></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-1446><a id=__codelineno-0-1446 name=__codelineno-0-1446></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1447><a id=__codelineno-0-1447 name=__codelineno-0-1447></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1448><a id=__codelineno-0-1448 name=__codelineno-0-1448></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-1449><a id=__codelineno-0-1449 name=__codelineno-0-1449></a><span class=sd>        ...     batch_size=64</span>
</span><span id=__span-0-1450><a id=__codelineno-0-1450 name=__codelineno-0-1450></a><span class=sd>        ... )</span>
</span><span id=__span-0-1451><a id=__codelineno-0-1451 name=__codelineno-0-1451></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1452><a id=__codelineno-0-1452 name=__codelineno-0-1452></a><span class=sd>        MoS enabled: False</span>
</span><span id=__span-0-1453><a id=__codelineno-0-1453 name=__codelineno-0-1453></a>
</span><span id=__span-0-1454><a id=__codelineno-0-1454 name=__codelineno-0-1454></a><span class=sd>        &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-1455><a id=__codelineno-0-1455 name=__codelineno-0-1455></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1456><a id=__codelineno-0-1456 name=__codelineno-0-1456></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1457><a id=__codelineno-0-1457 name=__codelineno-0-1457></a><span class=sd>        ...     n_epochs=3</span>
</span><span id=__span-0-1458><a id=__codelineno-0-1458 name=__codelineno-0-1458></a><span class=sd>        ... )</span>
</span><span id=__span-0-1459><a id=__codelineno-0-1459 name=__codelineno-0-1459></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Number of epochs: {dataloader.n_epochs}&quot;)</span>
</span><span id=__span-0-1460><a id=__codelineno-0-1460 name=__codelineno-0-1460></a><span class=sd>        Number of epochs: 3</span>
</span><span id=__span-0-1461><a id=__codelineno-0-1461 name=__codelineno-0-1461></a>
</span><span id=__span-0-1462><a id=__codelineno-0-1462 name=__codelineno-0-1462></a><span class=sd>        &gt;&gt;&gt; # Custom MoS configuration</span>
</span><span id=__span-0-1463><a id=__codelineno-0-1463 name=__codelineno-0-1463></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1464><a id=__codelineno-0-1464 name=__codelineno-0-1464></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1465><a id=__codelineno-0-1465 name=__codelineno-0-1465></a><span class=sd>        ...     n_readers=100,</span>
</span><span id=__span-0-1466><a id=__codelineno-0-1466 name=__codelineno-0-1466></a><span class=sd>        ...     n_scanners=16</span>
</span><span id=__span-0-1467><a id=__codelineno-0-1467 name=__codelineno-0-1467></a><span class=sd>        ... )</span>
</span><span id=__span-0-1468><a id=__codelineno-0-1468 name=__codelineno-0-1468></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS readers: {dataloader.n_readers}, scanners: {dataloader.n_scanners}&quot;)</span>
</span><span id=__span-0-1469><a id=__codelineno-0-1469 name=__codelineno-0-1469></a><span class=sd>        MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-1470><a id=__codelineno-0-1470 name=__codelineno-0-1470></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-1471><a id=__codelineno-0-1471 name=__codelineno-0-1471></a>
</span><span id=__span-0-1472><a id=__codelineno-0-1472 name=__codelineno-0-1472></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-1473><a id=__codelineno-0-1473 name=__codelineno-0-1473></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-1474><a id=__codelineno-0-1474 name=__codelineno-0-1474></a>        <span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-1475><a id=__codelineno-0-1475 name=__codelineno-0-1475></a>        <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-1476><a id=__codelineno-0-1476 name=__codelineno-0-1476></a>        <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-1477><a id=__codelineno-0-1477 name=__codelineno-0-1477></a>        <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span>
</span><span id=__span-0-1478><a id=__codelineno-0-1478 name=__codelineno-0-1478></a>        <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-1479><a id=__codelineno-0-1479 name=__codelineno-0-1479></a>        <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1480><a id=__codelineno-0-1480 name=__codelineno-0-1480></a>        <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>,</span>
</span><span id=__span-0-1481><a id=__codelineno-0-1481 name=__codelineno-0-1481></a>        <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1482><a id=__codelineno-0-1482 name=__codelineno-0-1482></a>        <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span><span id=__span-0-1483><a id=__codelineno-0-1483 name=__codelineno-0-1483></a>        <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-0-1484><a id=__codelineno-0-1484 name=__codelineno-0-1484></a>    <span class=p>):</span>
</span><span id=__span-0-1485><a id=__codelineno-0-1485 name=__codelineno-0-1485></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1486><a id=__codelineno-0-1486 name=__codelineno-0-1486></a><span class=sd>        Initialize the TileDB DataLoader with training configuration.</span>
</span><span id=__span-0-1487><a id=__codelineno-0-1487 name=__codelineno-0-1487></a>
</span><span id=__span-0-1488><a id=__codelineno-0-1488 name=__codelineno-0-1488></a><span class=sd>        Args:</span>
</span><span id=__span-0-1489><a id=__codelineno-0-1489 name=__codelineno-0-1489></a><span class=sd>            tiledb_path: Path to the TileDB SOMA experiment directory.</span>
</span><span id=__span-0-1490><a id=__codelineno-0-1490 name=__codelineno-0-1490></a><span class=sd>                         Must contain a valid SOMA experiment with RNA measurement data.</span>
</span><span id=__span-0-1491><a id=__codelineno-0-1491 name=__codelineno-0-1491></a><span class=sd>            batch_size: Number of cells per training batch. Larger batches use more</span>
</span><span id=__span-0-1492><a id=__codelineno-0-1492 name=__codelineno-0-1492></a><span class=sd>                       memory but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-1493><a id=__codelineno-0-1493 name=__codelineno-0-1493></a><span class=sd>            prefetch_batch_size: Number of cells to prefetch from TileDB per batch.</span>
</span><span id=__span-0-1494><a id=__codelineno-0-1494 name=__codelineno-0-1494></a><span class=sd>                               Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-1495><a id=__codelineno-0-1495 name=__codelineno-0-1495></a><span class=sd>                               Range: 10-10000, default: 100.</span>
</span><span id=__span-0-1496><a id=__codelineno-0-1496 name=__codelineno-0-1496></a><span class=sd>            seed: Random seed for reproducible shuffling and MoS sampling.</span>
</span><span id=__span-0-1497><a id=__codelineno-0-1497 name=__codelineno-0-1497></a><span class=sd>                  Used for consistent data ordering across runs. Default: 42.</span>
</span><span id=__span-0-1498><a id=__codelineno-0-1498 name=__codelineno-0-1498></a><span class=sd>            n_epochs: Number of epochs to run. The dataloader will automatically reset</span>
</span><span id=__span-0-1499><a id=__codelineno-0-1499 name=__codelineno-0-1499></a><span class=sd>                     after each epoch, enabling multi-epoch training. Default: 1.</span>
</span><span id=__span-0-1500><a id=__codelineno-0-1500 name=__codelineno-0-1500></a><span class=sd>            verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-1501><a id=__codelineno-0-1501 name=__codelineno-0-1501></a><span class=sd>                    If False, suppress all internal prints for clean output. Default: True.</span>
</span><span id=__span-0-1502><a id=__codelineno-0-1502 name=__codelineno-0-1502></a><span class=sd>            max_queue_size: Maximum number of pre-processed batches to keep in queue.</span>
</span><span id=__span-0-1503><a id=__codelineno-0-1503 name=__codelineno-0-1503></a><span class=sd>                          Higher values use more memory but provide better buffering.</span>
</span><span id=__span-0-1504><a id=__codelineno-0-1504 name=__codelineno-0-1504></a><span class=sd>                          Range: 10-10000, default: 500.</span>
</span><span id=__span-0-1505><a id=__codelineno-0-1505 name=__codelineno-0-1505></a><span class=sd>            use_mixture_of_scanners: If True, use MoS strategy for higher entropy by</span>
</span><span id=__span-0-1506><a id=__codelineno-0-1506 name=__codelineno-0-1506></a><span class=sd>                                   randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-1507><a id=__codelineno-0-1507 name=__codelineno-0-1507></a><span class=sd>                                   Provides better randomization for foundation model training.</span>
</span><span id=__span-0-1508><a id=__codelineno-0-1508 name=__codelineno-0-1508></a><span class=sd>                                   Default: True.</span>
</span><span id=__span-0-1509><a id=__codelineno-0-1509 name=__codelineno-0-1509></a><span class=sd>            n_readers: Total number of fragment generators to create when using MoS.</span>
</span><span id=__span-0-1510><a id=__codelineno-0-1510 name=__codelineno-0-1510></a><span class=sd>                      Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1511><a id=__codelineno-0-1511 name=__codelineno-0-1511></a><span class=sd>                      Range: 1-1000, default: 50.</span>
</span><span id=__span-0-1512><a id=__codelineno-0-1512 name=__codelineno-0-1512></a><span class=sd>            n_scanners: Number of active scanners to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-1513><a id=__codelineno-0-1513 name=__codelineno-0-1513></a><span class=sd>                       Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1514><a id=__codelineno-0-1514 name=__codelineno-0-1514></a><span class=sd>                       Range: 1-100, default: 8.</span>
</span><span id=__span-0-1515><a id=__codelineno-0-1515 name=__codelineno-0-1515></a>
</span><span id=__span-0-1516><a id=__codelineno-0-1516 name=__codelineno-0-1516></a><span class=sd>        Raises:</span>
</span><span id=__span-0-1517><a id=__codelineno-0-1517 name=__codelineno-0-1517></a><span class=sd>            ImportError: If TileDB SOMA is not available.</span>
</span><span id=__span-0-1518><a id=__codelineno-0-1518 name=__codelineno-0-1518></a><span class=sd>            ValueError: If MoS parameters are invalid.</span>
</span><span id=__span-0-1519><a id=__codelineno-0-1519 name=__codelineno-0-1519></a><span class=sd>            RuntimeError: If the TileDB experiment cannot be opened or is invalid.</span>
</span><span id=__span-0-1520><a id=__codelineno-0-1520 name=__codelineno-0-1520></a>
</span><span id=__span-0-1521><a id=__codelineno-0-1521 name=__codelineno-0-1521></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1522><a id=__codelineno-0-1522 name=__codelineno-0-1522></a><span class=sd>            &gt;&gt;&gt; # Basic initialization with default MoS strategy</span>
</span><span id=__span-0-1523><a id=__codelineno-0-1523 name=__codelineno-0-1523></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1524><a id=__codelineno-0-1524 name=__codelineno-0-1524></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1525><a id=__codelineno-0-1525 name=__codelineno-0-1525></a><span class=sd>            ...     batch_size=32,</span>
</span><span id=__span-0-1526><a id=__codelineno-0-1526 name=__codelineno-0-1526></a><span class=sd>            ...     prefetch_batch_size=100</span>
</span><span id=__span-0-1527><a id=__codelineno-0-1527 name=__codelineno-0-1527></a><span class=sd>            ... )</span>
</span><span id=__span-0-1528><a id=__codelineno-0-1528 name=__codelineno-0-1528></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS enabled: {dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1529><a id=__codelineno-0-1529 name=__codelineno-0-1529></a><span class=sd>            MoS enabled: True</span>
</span><span id=__span-0-1530><a id=__codelineno-0-1530 name=__codelineno-0-1530></a>
</span><span id=__span-0-1531><a id=__codelineno-0-1531 name=__codelineno-0-1531></a><span class=sd>            &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-1532><a id=__codelineno-0-1532 name=__codelineno-0-1532></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1533><a id=__codelineno-0-1533 name=__codelineno-0-1533></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1534><a id=__codelineno-0-1534 name=__codelineno-0-1534></a><span class=sd>            ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-1535><a id=__codelineno-0-1535 name=__codelineno-0-1535></a><span class=sd>            ...     batch_size=64</span>
</span><span id=__span-0-1536><a id=__codelineno-0-1536 name=__codelineno-0-1536></a><span class=sd>            ... )</span>
</span><span id=__span-0-1537><a id=__codelineno-0-1537 name=__codelineno-0-1537></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1538><a id=__codelineno-0-1538 name=__codelineno-0-1538></a><span class=sd>            Sequential loading: True</span>
</span><span id=__span-0-1539><a id=__codelineno-0-1539 name=__codelineno-0-1539></a>
</span><span id=__span-0-1540><a id=__codelineno-0-1540 name=__codelineno-0-1540></a><span class=sd>            &gt;&gt;&gt; # High-entropy MoS configuration</span>
</span><span id=__span-0-1541><a id=__codelineno-0-1541 name=__codelineno-0-1541></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1542><a id=__codelineno-0-1542 name=__codelineno-0-1542></a><span class=sd>            ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1543><a id=__codelineno-0-1543 name=__codelineno-0-1543></a><span class=sd>            ...     n_readers=100,</span>
</span><span id=__span-0-1544><a id=__codelineno-0-1544 name=__codelineno-0-1544></a><span class=sd>            ...     n_scanners=16</span>
</span><span id=__span-0-1545><a id=__codelineno-0-1545 name=__codelineno-0-1545></a><span class=sd>            ... )</span>
</span><span id=__span-0-1546><a id=__codelineno-0-1546 name=__codelineno-0-1546></a><span class=sd>            &gt;&gt;&gt; print(f&quot;MoS readers: {dataloader.n_readers}, scanners: {dataloader.n_scanners}&quot;)</span>
</span><span id=__span-0-1547><a id=__codelineno-0-1547 name=__codelineno-0-1547></a><span class=sd>            MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-1548><a id=__codelineno-0-1548 name=__codelineno-0-1548></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1549><a id=__codelineno-0-1549 name=__codelineno-0-1549></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tiledb_path</span> <span class=o>=</span> <span class=n>tiledb_path</span>
</span><span id=__span-0-1550><a id=__codelineno-0-1550 name=__codelineno-0-1550></a>        <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-1551><a id=__codelineno-0-1551 name=__codelineno-0-1551></a>        <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=n>prefetch_batch_size</span>
</span><span id=__span-0-1552><a id=__codelineno-0-1552 name=__codelineno-0-1552></a>        <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>=</span> <span class=n>seed</span>
</span><span id=__span-0-1553><a id=__codelineno-0-1553 name=__codelineno-0-1553></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-1554><a id=__codelineno-0-1554 name=__codelineno-0-1554></a>        <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span><span id=__span-0-1555><a id=__codelineno-0-1555 name=__codelineno-0-1555></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>
</span><span id=__span-0-1556><a id=__codelineno-0-1556 name=__codelineno-0-1556></a>        <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>
</span><span id=__span-0-1557><a id=__codelineno-0-1557 name=__codelineno-0-1557></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>=</span> <span class=n>n_readers</span>
</span><span id=__span-0-1558><a id=__codelineno-0-1558 name=__codelineno-0-1558></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>
</span><span id=__span-0-1559><a id=__codelineno-0-1559 name=__codelineno-0-1559></a>
</span><span id=__span-0-1560><a id=__codelineno-0-1560 name=__codelineno-0-1560></a>        <span class=c1># Check that required modules are available</span>
</span><span id=__span-0-1561><a id=__codelineno-0-1561 name=__codelineno-0-1561></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>TILEDB_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-1562><a id=__codelineno-0-1562 name=__codelineno-0-1562></a>            <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span><span class=s2>&quot;TileDB SOMA is required but not available&quot;</span><span class=p>)</span>
</span><span id=__span-0-1563><a id=__codelineno-0-1563 name=__codelineno-0-1563></a>
</span><span id=__span-0-1564><a id=__codelineno-0-1564 name=__codelineno-0-1564></a>        <span class=c1># Use IterableDataset</span>
</span><span id=__span-0-1565><a id=__codelineno-0-1565 name=__codelineno-0-1565></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_dataset</span> <span class=o>=</span> <span class=n>TileDBIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-1566><a id=__codelineno-0-1566 name=__codelineno-0-1566></a>            <span class=n>tiledb_path</span><span class=o>=</span><span class=n>tiledb_path</span><span class=p>,</span>
</span><span id=__span-0-1567><a id=__codelineno-0-1567 name=__codelineno-0-1567></a>            <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-1568><a id=__codelineno-0-1568 name=__codelineno-0-1568></a>            <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-1569><a id=__codelineno-0-1569 name=__codelineno-0-1569></a>            <span class=n>seed</span><span class=o>=</span><span class=n>seed</span><span class=p>,</span>
</span><span id=__span-0-1570><a id=__codelineno-0-1570 name=__codelineno-0-1570></a>            <span class=n>max_queue_size</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>,</span>
</span><span id=__span-0-1571><a id=__codelineno-0-1571 name=__codelineno-0-1571></a>            <span class=n>n_epochs</span><span class=o>=</span><span class=n>n_epochs</span><span class=p>,</span>
</span><span id=__span-0-1572><a id=__codelineno-0-1572 name=__codelineno-0-1572></a>            <span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-1573><a id=__codelineno-0-1573 name=__codelineno-0-1573></a>            <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=n>use_mixture_of_scanners</span><span class=p>,</span>
</span><span id=__span-0-1574><a id=__codelineno-0-1574 name=__codelineno-0-1574></a>            <span class=n>n_readers</span><span class=o>=</span><span class=n>n_readers</span><span class=p>,</span>
</span><span id=__span-0-1575><a id=__codelineno-0-1575 name=__codelineno-0-1575></a>            <span class=n>n_scanners</span><span class=o>=</span><span class=n>n_scanners</span><span class=p>,</span>
</span><span id=__span-0-1576><a id=__codelineno-0-1576 name=__codelineno-0-1576></a>        <span class=p>)</span>
</span><span id=__span-0-1577><a id=__codelineno-0-1577 name=__codelineno-0-1577></a>
</span><span id=__span-0-1578><a id=__codelineno-0-1578 name=__codelineno-0-1578></a>    <span class=k>def</span><span class=w> </span><span class=fm>__iter__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-1579><a id=__codelineno-0-1579 name=__codelineno-0-1579></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1580><a id=__codelineno-0-1580 name=__codelineno-0-1580></a><span class=sd>        Iterate through batches of TileDB data with async prefetching.</span>
</span><span id=__span-0-1581><a id=__codelineno-0-1581 name=__codelineno-0-1581></a>
</span><span id=__span-0-1582><a id=__codelineno-0-1582 name=__codelineno-0-1582></a><span class=sd>        This method provides an iterator over batches of TileDB data, automatically</span>
</span><span id=__span-0-1583><a id=__codelineno-0-1583 name=__codelineno-0-1583></a><span class=sd>        handling background prefetching, epoch transitions, and error recovery.</span>
</span><span id=__span-0-1584><a id=__codelineno-0-1584 name=__codelineno-0-1584></a><span class=sd>        It yields dictionaries containing the batch data and metadata.</span>
</span><span id=__span-0-1585><a id=__codelineno-0-1585 name=__codelineno-0-1585></a>
</span><span id=__span-0-1586><a id=__codelineno-0-1586 name=__codelineno-0-1586></a><span class=sd>        The iterator automatically manages:</span>
</span><span id=__span-0-1587><a id=__codelineno-0-1587 name=__codelineno-0-1587></a><span class=sd>        - Background prefetching for improved throughput</span>
</span><span id=__span-0-1588><a id=__codelineno-0-1588 name=__codelineno-0-1588></a><span class=sd>        - Epoch transitions for multi-epoch training</span>
</span><span id=__span-0-1589><a id=__codelineno-0-1589 name=__codelineno-0-1589></a><span class=sd>        - Error handling and recovery</span>
</span><span id=__span-0-1590><a id=__codelineno-0-1590 name=__codelineno-0-1590></a><span class=sd>        - Performance monitoring and reporting</span>
</span><span id=__span-0-1591><a id=__codelineno-0-1591 name=__codelineno-0-1591></a>
</span><span id=__span-0-1592><a id=__codelineno-0-1592 name=__codelineno-0-1592></a><span class=sd>        Yields:</span>
</span><span id=__span-0-1593><a id=__codelineno-0-1593 name=__codelineno-0-1593></a><span class=sd>            dict: Batch dictionary containing:</span>
</span><span id=__span-0-1594><a id=__codelineno-0-1594 name=__codelineno-0-1594></a><span class=sd>                - X: Polars DataFrame with cell-gene expression data</span>
</span><span id=__span-0-1595><a id=__codelineno-0-1595 name=__codelineno-0-1595></a><span class=sd>                - cell_ids: List of unique cell IDs in the batch</span>
</span><span id=__span-0-1596><a id=__codelineno-0-1596 name=__codelineno-0-1596></a><span class=sd>                - epoch: Current epoch number (when n_epochs &gt; 1)</span>
</span><span id=__span-0-1597><a id=__codelineno-0-1597 name=__codelineno-0-1597></a>
</span><span id=__span-0-1598><a id=__codelineno-0-1598 name=__codelineno-0-1598></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1599><a id=__codelineno-0-1599 name=__codelineno-0-1599></a><span class=sd>            &gt;&gt;&gt; # Basic iteration</span>
</span><span id=__span-0-1600><a id=__codelineno-0-1600 name=__codelineno-0-1600></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1601><a id=__codelineno-0-1601 name=__codelineno-0-1601></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-1602><a id=__codelineno-0-1602 name=__codelineno-0-1602></a><span class=sd>            ...     print(f&quot;Batch keys: {list(batch.keys())}&quot;)</span>
</span><span id=__span-0-1603><a id=__codelineno-0-1603 name=__codelineno-0-1603></a><span class=sd>            ...     print(f&quot;Cell IDs: {batch[&#39;cell_ids&#39;]}&quot;)</span>
</span><span id=__span-0-1604><a id=__codelineno-0-1604 name=__codelineno-0-1604></a><span class=sd>            ...     break</span>
</span><span id=__span-0-1605><a id=__codelineno-0-1605 name=__codelineno-0-1605></a><span class=sd>            Batch keys: [&#39;X&#39;, &#39;cell_ids&#39;]</span>
</span><span id=__span-0-1606><a id=__codelineno-0-1606 name=__codelineno-0-1606></a><span class=sd>            Cell IDs: [0, 1, 2, ..., 29, 30, 31]</span>
</span><span id=__span-0-1607><a id=__codelineno-0-1607 name=__codelineno-0-1607></a>
</span><span id=__span-0-1608><a id=__codelineno-0-1608 name=__codelineno-0-1608></a><span class=sd>            &gt;&gt;&gt; # Multi-epoch training</span>
</span><span id=__span-0-1609><a id=__codelineno-0-1609 name=__codelineno-0-1609></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(&quot;path/to/experiment&quot;, n_epochs=3)</span>
</span><span id=__span-0-1610><a id=__codelineno-0-1610 name=__codelineno-0-1610></a><span class=sd>            &gt;&gt;&gt; epochs_seen = set()</span>
</span><span id=__span-0-1611><a id=__codelineno-0-1611 name=__codelineno-0-1611></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-1612><a id=__codelineno-0-1612 name=__codelineno-0-1612></a><span class=sd>            ...     if &#39;epoch&#39; in batch:</span>
</span><span id=__span-0-1613><a id=__codelineno-0-1613 name=__codelineno-0-1613></a><span class=sd>            ...         epochs_seen.add(batch[&#39;epoch&#39;])</span>
</span><span id=__span-0-1614><a id=__codelineno-0-1614 name=__codelineno-0-1614></a><span class=sd>            ...     if len(epochs_seen) &gt;= 3:</span>
</span><span id=__span-0-1615><a id=__codelineno-0-1615 name=__codelineno-0-1615></a><span class=sd>            ...         break</span>
</span><span id=__span-0-1616><a id=__codelineno-0-1616 name=__codelineno-0-1616></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Epochs completed: {sorted(epochs_seen)}&quot;)</span>
</span><span id=__span-0-1617><a id=__codelineno-0-1617 name=__codelineno-0-1617></a><span class=sd>            Epochs completed: [0, 1, 2]</span>
</span><span id=__span-0-1618><a id=__codelineno-0-1618 name=__codelineno-0-1618></a>
</span><span id=__span-0-1619><a id=__codelineno-0-1619 name=__codelineno-0-1619></a><span class=sd>            &gt;&gt;&gt; # Training loop with error handling</span>
</span><span id=__span-0-1620><a id=__codelineno-0-1620 name=__codelineno-0-1620></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1621><a id=__codelineno-0-1621 name=__codelineno-0-1621></a><span class=sd>            &gt;&gt;&gt; for batch_idx, batch in enumerate(dataloader):</span>
</span><span id=__span-0-1622><a id=__codelineno-0-1622 name=__codelineno-0-1622></a><span class=sd>            ...     try:</span>
</span><span id=__span-0-1623><a id=__codelineno-0-1623 name=__codelineno-0-1623></a><span class=sd>            ...         x = batch[&quot;X&quot;]</span>
</span><span id=__span-0-1624><a id=__codelineno-0-1624 name=__codelineno-0-1624></a><span class=sd>            ...         cell_ids = batch[&quot;cell_ids&quot;]</span>
</span><span id=__span-0-1625><a id=__codelineno-0-1625 name=__codelineno-0-1625></a><span class=sd>            ...         print(f&quot;Processed batch {batch_idx} with {len(cell_ids)} cells&quot;)</span>
</span><span id=__span-0-1626><a id=__codelineno-0-1626 name=__codelineno-0-1626></a><span class=sd>            ...     except Exception as e:</span>
</span><span id=__span-0-1627><a id=__codelineno-0-1627 name=__codelineno-0-1627></a><span class=sd>            ...         print(f&quot;Error in batch {batch_idx}: {e}&quot;)</span>
</span><span id=__span-0-1628><a id=__codelineno-0-1628 name=__codelineno-0-1628></a><span class=sd>            ...         continue</span>
</span><span id=__span-0-1629><a id=__codelineno-0-1629 name=__codelineno-0-1629></a><span class=sd>            ...     if batch_idx &gt;= 2:  # Just first few batches</span>
</span><span id=__span-0-1630><a id=__codelineno-0-1630 name=__codelineno-0-1630></a><span class=sd>            ...         break</span>
</span><span id=__span-0-1631><a id=__codelineno-0-1631 name=__codelineno-0-1631></a><span class=sd>            Processed batch 0 with 32 cells</span>
</span><span id=__span-0-1632><a id=__codelineno-0-1632 name=__codelineno-0-1632></a><span class=sd>            Processed batch 1 with 32 cells</span>
</span><span id=__span-0-1633><a id=__codelineno-0-1633 name=__codelineno-0-1633></a><span class=sd>            Processed batch 2 with 32 cells</span>
</span><span id=__span-0-1634><a id=__codelineno-0-1634 name=__codelineno-0-1634></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1635><a id=__codelineno-0-1635 name=__codelineno-0-1635></a>        <span class=k>yield from</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dataset</span>
</span><span id=__span-0-1636><a id=__codelineno-0-1636 name=__codelineno-0-1636></a>
</span><span id=__span-0-1637><a id=__codelineno-0-1637 name=__codelineno-0-1637></a>    <span class=k>def</span><span class=w> </span><span class=fm>__len__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-1638><a id=__codelineno-0-1638 name=__codelineno-0-1638></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1639><a id=__codelineno-0-1639 name=__codelineno-0-1639></a><span class=sd>        Return the number of batches in the dataset.</span>
</span><span id=__span-0-1640><a id=__codelineno-0-1640 name=__codelineno-0-1640></a>
</span><span id=__span-0-1641><a id=__codelineno-0-1641 name=__codelineno-0-1641></a><span class=sd>        Note: Since TileDBDataLoader uses an IterableDataset that streams data,</span>
</span><span id=__span-0-1642><a id=__codelineno-0-1642 name=__codelineno-0-1642></a><span class=sd>        the exact number of batches is not known in advance. This method</span>
</span><span id=__span-0-1643><a id=__codelineno-0-1643 name=__codelineno-0-1643></a><span class=sd>        returns 0 to indicate an unknown length for streaming datasets.</span>
</span><span id=__span-0-1644><a id=__codelineno-0-1644 name=__codelineno-0-1644></a>
</span><span id=__span-0-1645><a id=__codelineno-0-1645 name=__codelineno-0-1645></a><span class=sd>        Returns:</span>
</span><span id=__span-0-1646><a id=__codelineno-0-1646 name=__codelineno-0-1646></a><span class=sd>            int: Always returns 0 to indicate unknown length for streaming datasets.</span>
</span><span id=__span-0-1647><a id=__codelineno-0-1647 name=__codelineno-0-1647></a>
</span><span id=__span-0-1648><a id=__codelineno-0-1648 name=__codelineno-0-1648></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1649><a id=__codelineno-0-1649 name=__codelineno-0-1649></a><span class=sd>            &gt;&gt;&gt; # Check dataset length</span>
</span><span id=__span-0-1650><a id=__codelineno-0-1650 name=__codelineno-0-1650></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1651><a id=__codelineno-0-1651 name=__codelineno-0-1651></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Dataset length: {len(dataloader)}&quot;)</span>
</span><span id=__span-0-1652><a id=__codelineno-0-1652 name=__codelineno-0-1652></a><span class=sd>            Dataset length: 0</span>
</span><span id=__span-0-1653><a id=__codelineno-0-1653 name=__codelineno-0-1653></a>
</span><span id=__span-0-1654><a id=__codelineno-0-1654 name=__codelineno-0-1654></a><span class=sd>            &gt;&gt;&gt; # IterableDataset behavior</span>
</span><span id=__span-0-1655><a id=__codelineno-0-1655 name=__codelineno-0-1655></a><span class=sd>            &gt;&gt;&gt; batch_count = 0</span>
</span><span id=__span-0-1656><a id=__codelineno-0-1656 name=__codelineno-0-1656></a><span class=sd>            &gt;&gt;&gt; for batch in dataloader:</span>
</span><span id=__span-0-1657><a id=__codelineno-0-1657 name=__codelineno-0-1657></a><span class=sd>            ...     batch_count += 1</span>
</span><span id=__span-0-1658><a id=__codelineno-0-1658 name=__codelineno-0-1658></a><span class=sd>            ...     if batch_count &gt;= 5:  # Just count first 5 batches</span>
</span><span id=__span-0-1659><a id=__codelineno-0-1659 name=__codelineno-0-1659></a><span class=sd>            ...         break</span>
</span><span id=__span-0-1660><a id=__codelineno-0-1660 name=__codelineno-0-1660></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Actually processed {batch_count} batches&quot;)</span>
</span><span id=__span-0-1661><a id=__codelineno-0-1661 name=__codelineno-0-1661></a><span class=sd>            Actually processed 5 batches</span>
</span><span id=__span-0-1662><a id=__codelineno-0-1662 name=__codelineno-0-1662></a>
</span><span id=__span-0-1663><a id=__codelineno-0-1663 name=__codelineno-0-1663></a><span class=sd>            &gt;&gt;&gt; # Length is consistent</span>
</span><span id=__span-0-1664><a id=__codelineno-0-1664 name=__codelineno-0-1664></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Length check: {len(dataloader)}&quot;)</span>
</span><span id=__span-0-1665><a id=__codelineno-0-1665 name=__codelineno-0-1665></a><span class=sd>            Length check: 0</span>
</span><span id=__span-0-1666><a id=__codelineno-0-1666 name=__codelineno-0-1666></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1667><a id=__codelineno-0-1667 name=__codelineno-0-1667></a>        <span class=k>return</span> <span class=mi>0</span>  <span class=c1># Indicates unknown length for streaming datasets</span>
</span><span id=__span-0-1668><a id=__codelineno-0-1668 name=__codelineno-0-1668></a>
</span><span id=__span-0-1669><a id=__codelineno-0-1669 name=__codelineno-0-1669></a>    <span class=k>def</span><span class=w> </span><span class=fm>__del__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-1670><a id=__codelineno-0-1670 name=__codelineno-0-1670></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1671><a id=__codelineno-0-1671 name=__codelineno-0-1671></a><span class=sd>        Cleanup method to stop async prefetching.</span>
</span><span id=__span-0-1672><a id=__codelineno-0-1672 name=__codelineno-0-1672></a>
</span><span id=__span-0-1673><a id=__codelineno-0-1673 name=__codelineno-0-1673></a><span class=sd>        This method is called when the DataLoader object is garbage collected.</span>
</span><span id=__span-0-1674><a id=__codelineno-0-1674 name=__codelineno-0-1674></a><span class=sd>        It ensures that the underlying dataset&#39;s prefetcher is properly cleaned up</span>
</span><span id=__span-0-1675><a id=__codelineno-0-1675 name=__codelineno-0-1675></a><span class=sd>        to prevent resource leaks.</span>
</span><span id=__span-0-1676><a id=__codelineno-0-1676 name=__codelineno-0-1676></a>
</span><span id=__span-0-1677><a id=__codelineno-0-1677 name=__codelineno-0-1677></a><span class=sd>        Examples:</span>
</span><span id=__span-0-1678><a id=__codelineno-0-1678 name=__codelineno-0-1678></a><span class=sd>            &gt;&gt;&gt; # DataLoader cleanup happens automatically</span>
</span><span id=__span-0-1679><a id=__codelineno-0-1679 name=__codelineno-0-1679></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1680><a id=__codelineno-0-1680 name=__codelineno-0-1680></a><span class=sd>            &gt;&gt;&gt; print(&quot;DataLoader created&quot;)</span>
</span><span id=__span-0-1681><a id=__codelineno-0-1681 name=__codelineno-0-1681></a><span class=sd>            DataLoader created</span>
</span><span id=__span-0-1682><a id=__codelineno-0-1682 name=__codelineno-0-1682></a><span class=sd>            &gt;&gt;&gt; # When dataloader goes out of scope, __del__ is called automatically</span>
</span><span id=__span-0-1683><a id=__codelineno-0-1683 name=__codelineno-0-1683></a><span class=sd>            &gt;&gt;&gt; del dataloader</span>
</span><span id=__span-0-1684><a id=__codelineno-0-1684 name=__codelineno-0-1684></a><span class=sd>            &gt;&gt;&gt; print(&quot;DataLoader destroyed and cleaned up&quot;)</span>
</span><span id=__span-0-1685><a id=__codelineno-0-1685 name=__codelineno-0-1685></a><span class=sd>            DataLoader destroyed and cleaned up</span>
</span><span id=__span-0-1686><a id=__codelineno-0-1686 name=__codelineno-0-1686></a>
</span><span id=__span-0-1687><a id=__codelineno-0-1687 name=__codelineno-0-1687></a><span class=sd>            &gt;&gt;&gt; # Manual cleanup (not usually needed)</span>
</span><span id=__span-0-1688><a id=__codelineno-0-1688 name=__codelineno-0-1688></a><span class=sd>            &gt;&gt;&gt; dataloader = TileDBDataLoader(&quot;path/to/experiment&quot;)</span>
</span><span id=__span-0-1689><a id=__codelineno-0-1689 name=__codelineno-0-1689></a><span class=sd>            &gt;&gt;&gt; dataloader.__del__()</span>
</span><span id=__span-0-1690><a id=__codelineno-0-1690 name=__codelineno-0-1690></a><span class=sd>            &gt;&gt;&gt; print(&quot;Manual cleanup completed&quot;)</span>
</span><span id=__span-0-1691><a id=__codelineno-0-1691 name=__codelineno-0-1691></a><span class=sd>            Manual cleanup completed</span>
</span><span id=__span-0-1692><a id=__codelineno-0-1692 name=__codelineno-0-1692></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-1693><a id=__codelineno-0-1693 name=__codelineno-0-1693></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=s2>&quot;_dataset&quot;</span><span class=p>):</span>
</span><span id=__span-0-1694><a id=__codelineno-0-1694 name=__codelineno-0-1694></a>            <span class=c1># The TileDBIterableDataset doesn&#39;t have a stop method,</span>
</span><span id=__span-0-1695><a id=__codelineno-0-1695 name=__codelineno-0-1695></a>            <span class=c1># so we just let it finish its current epoch.</span>
</span><span id=__span-0-1696><a id=__codelineno-0-1696 name=__codelineno-0-1696></a>            <span class=k>pass</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <h5 id=slaf.ml.tiledb_dataloaders.TileDBDataLoader-functions>Functions<a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader-functions class=headerlink title="Permanent link">&para;</a></h5> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tiledb_dataloaders.TileDBDataLoader.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span> <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span> <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span> <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>,</span> <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span> <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span> <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>)</span></code> <a href=#slaf.ml.tiledb_dataloaders.TileDBDataLoader.__init__ class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Initialize the TileDB DataLoader with training configuration.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tiledb_path</code> </td> <td> <code><span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>Path to the TileDB SOMA experiment directory. Must contain a valid SOMA experiment with RNA measurement data.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells per training batch. Larger batches use more memory but may improve training efficiency. Range: 1-512, default: 32.</p> </div> </td> <td> <code>32</code> </td> </tr> <tr class=doc-section-item> <td> <code>prefetch_batch_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of cells to prefetch from TileDB per batch. Higher values improve throughput but use more memory. Range: 10-10000, default: 100.</p> </div> </td> <td> <code>100</code> </td> </tr> <tr class=doc-section-item> <td> <code>seed</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Random seed for reproducible shuffling and MoS sampling. Used for consistent data ordering across runs. Default: 42.</p> </div> </td> <td> <code>42</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_epochs</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of epochs to run. The dataloader will automatically reset after each epoch, enabling multi-epoch training. Default: 1.</p> </div> </td> <td> <code>1</code> </td> </tr> <tr class=doc-section-item> <td> <code>verbose</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, print detailed timing and progress information. If False, suppress all internal prints for clean output. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>max_queue_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Maximum number of pre-processed batches to keep in queue. Higher values use more memory but provide better buffering. Range: 10-10000, default: 500.</p> </div> </td> <td> <code>500</code> </td> </tr> <tr class=doc-section-item> <td> <code>use_mixture_of_scanners</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, use MoS strategy for higher entropy by randomly sampling from multiple fragment generators. Provides better randomization for foundation model training. Default: True.</p> </div> </td> <td> <code>True</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_readers</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Total number of fragment generators to create when using MoS. Higher values provide better entropy but use more memory. Range: 1-1000, default: 50.</p> </div> </td> <td> <code>50</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_scanners</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of active scanners to sample from simultaneously when using MoS. Higher values provide better entropy but use more memory. Range: 1-100, default: 8.</p> </div> </td> <td> <code>8</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ImportError>ImportError</span></code> </td> <td> <div class=doc-md-description> <p>If TileDB SOMA is not available.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If MoS parameters are invalid.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=RuntimeError>RuntimeError</span></code> </td> <td> <div class=doc-md-description> <p>If the TileDB experiment cannot be opened or is invalid.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic initialization with default MoS strategy</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=mi>100</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS enabled: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS enabled: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Sequential loading for maximum throughput</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>batch_size</span><span class=o>=</span><span class=mi>64</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Sequential loading: </span><span class=si>{</span><span class=ow>not</span><span class=w> </span><span class=n>dataloader</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>Sequential loading: True</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># High-entropy MoS configuration</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>dataloader</span> <span class=o>=</span> <span class=n>TileDBDataLoader</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tiledb_path</span><span class=o>=</span><span class=s2>&quot;path/to/experiment&quot;</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>n_readers</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>n_scanners</span><span class=o>=</span><span class=mi>16</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;MoS readers: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>n_readers</span><span class=si>}</span><span class=s2>, scanners: </span><span class=si>{</span><span class=n>dataloader</span><span class=o>.</span><span class=n>n_scanners</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=go>MoS readers: 100, scanners: 16</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1472>1472</a></span>
<span class=normal><a href=#__codelineno-0-1473>1473</a></span>
<span class=normal><a href=#__codelineno-0-1474>1474</a></span>
<span class=normal><a href=#__codelineno-0-1475>1475</a></span>
<span class=normal><a href=#__codelineno-0-1476>1476</a></span>
<span class=normal><a href=#__codelineno-0-1477>1477</a></span>
<span class=normal><a href=#__codelineno-0-1478>1478</a></span>
<span class=normal><a href=#__codelineno-0-1479>1479</a></span>
<span class=normal><a href=#__codelineno-0-1480>1480</a></span>
<span class=normal><a href=#__codelineno-0-1481>1481</a></span>
<span class=normal><a href=#__codelineno-0-1482>1482</a></span>
<span class=normal><a href=#__codelineno-0-1483>1483</a></span>
<span class=normal><a href=#__codelineno-0-1484>1484</a></span>
<span class=normal><a href=#__codelineno-0-1485>1485</a></span>
<span class=normal><a href=#__codelineno-0-1486>1486</a></span>
<span class=normal><a href=#__codelineno-0-1487>1487</a></span>
<span class=normal><a href=#__codelineno-0-1488>1488</a></span>
<span class=normal><a href=#__codelineno-0-1489>1489</a></span>
<span class=normal><a href=#__codelineno-0-1490>1490</a></span>
<span class=normal><a href=#__codelineno-0-1491>1491</a></span>
<span class=normal><a href=#__codelineno-0-1492>1492</a></span>
<span class=normal><a href=#__codelineno-0-1493>1493</a></span>
<span class=normal><a href=#__codelineno-0-1494>1494</a></span>
<span class=normal><a href=#__codelineno-0-1495>1495</a></span>
<span class=normal><a href=#__codelineno-0-1496>1496</a></span>
<span class=normal><a href=#__codelineno-0-1497>1497</a></span>
<span class=normal><a href=#__codelineno-0-1498>1498</a></span>
<span class=normal><a href=#__codelineno-0-1499>1499</a></span>
<span class=normal><a href=#__codelineno-0-1500>1500</a></span>
<span class=normal><a href=#__codelineno-0-1501>1501</a></span>
<span class=normal><a href=#__codelineno-0-1502>1502</a></span>
<span class=normal><a href=#__codelineno-0-1503>1503</a></span>
<span class=normal><a href=#__codelineno-0-1504>1504</a></span>
<span class=normal><a href=#__codelineno-0-1505>1505</a></span>
<span class=normal><a href=#__codelineno-0-1506>1506</a></span>
<span class=normal><a href=#__codelineno-0-1507>1507</a></span>
<span class=normal><a href=#__codelineno-0-1508>1508</a></span>
<span class=normal><a href=#__codelineno-0-1509>1509</a></span>
<span class=normal><a href=#__codelineno-0-1510>1510</a></span>
<span class=normal><a href=#__codelineno-0-1511>1511</a></span>
<span class=normal><a href=#__codelineno-0-1512>1512</a></span>
<span class=normal><a href=#__codelineno-0-1513>1513</a></span>
<span class=normal><a href=#__codelineno-0-1514>1514</a></span>
<span class=normal><a href=#__codelineno-0-1515>1515</a></span>
<span class=normal><a href=#__codelineno-0-1516>1516</a></span>
<span class=normal><a href=#__codelineno-0-1517>1517</a></span>
<span class=normal><a href=#__codelineno-0-1518>1518</a></span>
<span class=normal><a href=#__codelineno-0-1519>1519</a></span>
<span class=normal><a href=#__codelineno-0-1520>1520</a></span>
<span class=normal><a href=#__codelineno-0-1521>1521</a></span>
<span class=normal><a href=#__codelineno-0-1522>1522</a></span>
<span class=normal><a href=#__codelineno-0-1523>1523</a></span>
<span class=normal><a href=#__codelineno-0-1524>1524</a></span>
<span class=normal><a href=#__codelineno-0-1525>1525</a></span>
<span class=normal><a href=#__codelineno-0-1526>1526</a></span>
<span class=normal><a href=#__codelineno-0-1527>1527</a></span>
<span class=normal><a href=#__codelineno-0-1528>1528</a></span>
<span class=normal><a href=#__codelineno-0-1529>1529</a></span>
<span class=normal><a href=#__codelineno-0-1530>1530</a></span>
<span class=normal><a href=#__codelineno-0-1531>1531</a></span>
<span class=normal><a href=#__codelineno-0-1532>1532</a></span>
<span class=normal><a href=#__codelineno-0-1533>1533</a></span>
<span class=normal><a href=#__codelineno-0-1534>1534</a></span>
<span class=normal><a href=#__codelineno-0-1535>1535</a></span>
<span class=normal><a href=#__codelineno-0-1536>1536</a></span>
<span class=normal><a href=#__codelineno-0-1537>1537</a></span>
<span class=normal><a href=#__codelineno-0-1538>1538</a></span>
<span class=normal><a href=#__codelineno-0-1539>1539</a></span>
<span class=normal><a href=#__codelineno-0-1540>1540</a></span>
<span class=normal><a href=#__codelineno-0-1541>1541</a></span>
<span class=normal><a href=#__codelineno-0-1542>1542</a></span>
<span class=normal><a href=#__codelineno-0-1543>1543</a></span>
<span class=normal><a href=#__codelineno-0-1544>1544</a></span>
<span class=normal><a href=#__codelineno-0-1545>1545</a></span>
<span class=normal><a href=#__codelineno-0-1546>1546</a></span>
<span class=normal><a href=#__codelineno-0-1547>1547</a></span>
<span class=normal><a href=#__codelineno-0-1548>1548</a></span>
<span class=normal><a href=#__codelineno-0-1549>1549</a></span>
<span class=normal><a href=#__codelineno-0-1550>1550</a></span>
<span class=normal><a href=#__codelineno-0-1551>1551</a></span>
<span class=normal><a href=#__codelineno-0-1552>1552</a></span>
<span class=normal><a href=#__codelineno-0-1553>1553</a></span>
<span class=normal><a href=#__codelineno-0-1554>1554</a></span>
<span class=normal><a href=#__codelineno-0-1555>1555</a></span>
<span class=normal><a href=#__codelineno-0-1556>1556</a></span>
<span class=normal><a href=#__codelineno-0-1557>1557</a></span>
<span class=normal><a href=#__codelineno-0-1558>1558</a></span>
<span class=normal><a href=#__codelineno-0-1559>1559</a></span>
<span class=normal><a href=#__codelineno-0-1560>1560</a></span>
<span class=normal><a href=#__codelineno-0-1561>1561</a></span>
<span class=normal><a href=#__codelineno-0-1562>1562</a></span>
<span class=normal><a href=#__codelineno-0-1563>1563</a></span>
<span class=normal><a href=#__codelineno-0-1564>1564</a></span>
<span class=normal><a href=#__codelineno-0-1565>1565</a></span>
<span class=normal><a href=#__codelineno-0-1566>1566</a></span>
<span class=normal><a href=#__codelineno-0-1567>1567</a></span>
<span class=normal><a href=#__codelineno-0-1568>1568</a></span>
<span class=normal><a href=#__codelineno-0-1569>1569</a></span>
<span class=normal><a href=#__codelineno-0-1570>1570</a></span>
<span class=normal><a href=#__codelineno-0-1571>1571</a></span>
<span class=normal><a href=#__codelineno-0-1572>1572</a></span>
<span class=normal><a href=#__codelineno-0-1573>1573</a></span>
<span class=normal><a href=#__codelineno-0-1574>1574</a></span>
<span class=normal><a href=#__codelineno-0-1575>1575</a></span>
<span class=normal><a href=#__codelineno-0-1576>1576</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-1472><a id=__codelineno-0-1472 name=__codelineno-0-1472></a><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-1473><a id=__codelineno-0-1473 name=__codelineno-0-1473></a>    <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-1474><a id=__codelineno-0-1474 name=__codelineno-0-1474></a>    <span class=n>tiledb_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-0-1475><a id=__codelineno-0-1475 name=__codelineno-0-1475></a>    <span class=n>batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>32</span><span class=p>,</span>
</span><span id=__span-0-1476><a id=__codelineno-0-1476 name=__codelineno-0-1476></a>    <span class=n>prefetch_batch_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>100</span><span class=p>,</span>
</span><span id=__span-0-1477><a id=__codelineno-0-1477 name=__codelineno-0-1477></a>    <span class=n>seed</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>42</span><span class=p>,</span>
</span><span id=__span-0-1478><a id=__codelineno-0-1478 name=__codelineno-0-1478></a>    <span class=n>n_epochs</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-1479><a id=__codelineno-0-1479 name=__codelineno-0-1479></a>    <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1480><a id=__codelineno-0-1480 name=__codelineno-0-1480></a>    <span class=n>max_queue_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>500</span><span class=p>,</span>
</span><span id=__span-0-1481><a id=__codelineno-0-1481 name=__codelineno-0-1481></a>    <span class=n>use_mixture_of_scanners</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-0-1482><a id=__codelineno-0-1482 name=__codelineno-0-1482></a>    <span class=n>n_readers</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50</span><span class=p>,</span>
</span><span id=__span-0-1483><a id=__codelineno-0-1483 name=__codelineno-0-1483></a>    <span class=n>n_scanners</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>8</span><span class=p>,</span>
</span><span id=__span-0-1484><a id=__codelineno-0-1484 name=__codelineno-0-1484></a><span class=p>):</span>
</span><span id=__span-0-1485><a id=__codelineno-0-1485 name=__codelineno-0-1485></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-1486><a id=__codelineno-0-1486 name=__codelineno-0-1486></a><span class=sd>    Initialize the TileDB DataLoader with training configuration.</span>
</span><span id=__span-0-1487><a id=__codelineno-0-1487 name=__codelineno-0-1487></a>
</span><span id=__span-0-1488><a id=__codelineno-0-1488 name=__codelineno-0-1488></a><span class=sd>    Args:</span>
</span><span id=__span-0-1489><a id=__codelineno-0-1489 name=__codelineno-0-1489></a><span class=sd>        tiledb_path: Path to the TileDB SOMA experiment directory.</span>
</span><span id=__span-0-1490><a id=__codelineno-0-1490 name=__codelineno-0-1490></a><span class=sd>                     Must contain a valid SOMA experiment with RNA measurement data.</span>
</span><span id=__span-0-1491><a id=__codelineno-0-1491 name=__codelineno-0-1491></a><span class=sd>        batch_size: Number of cells per training batch. Larger batches use more</span>
</span><span id=__span-0-1492><a id=__codelineno-0-1492 name=__codelineno-0-1492></a><span class=sd>                   memory but may improve training efficiency. Range: 1-512, default: 32.</span>
</span><span id=__span-0-1493><a id=__codelineno-0-1493 name=__codelineno-0-1493></a><span class=sd>        prefetch_batch_size: Number of cells to prefetch from TileDB per batch.</span>
</span><span id=__span-0-1494><a id=__codelineno-0-1494 name=__codelineno-0-1494></a><span class=sd>                           Higher values improve throughput but use more memory.</span>
</span><span id=__span-0-1495><a id=__codelineno-0-1495 name=__codelineno-0-1495></a><span class=sd>                           Range: 10-10000, default: 100.</span>
</span><span id=__span-0-1496><a id=__codelineno-0-1496 name=__codelineno-0-1496></a><span class=sd>        seed: Random seed for reproducible shuffling and MoS sampling.</span>
</span><span id=__span-0-1497><a id=__codelineno-0-1497 name=__codelineno-0-1497></a><span class=sd>              Used for consistent data ordering across runs. Default: 42.</span>
</span><span id=__span-0-1498><a id=__codelineno-0-1498 name=__codelineno-0-1498></a><span class=sd>        n_epochs: Number of epochs to run. The dataloader will automatically reset</span>
</span><span id=__span-0-1499><a id=__codelineno-0-1499 name=__codelineno-0-1499></a><span class=sd>                 after each epoch, enabling multi-epoch training. Default: 1.</span>
</span><span id=__span-0-1500><a id=__codelineno-0-1500 name=__codelineno-0-1500></a><span class=sd>        verbose: If True, print detailed timing and progress information.</span>
</span><span id=__span-0-1501><a id=__codelineno-0-1501 name=__codelineno-0-1501></a><span class=sd>                If False, suppress all internal prints for clean output. Default: True.</span>
</span><span id=__span-0-1502><a id=__codelineno-0-1502 name=__codelineno-0-1502></a><span class=sd>        max_queue_size: Maximum number of pre-processed batches to keep in queue.</span>
</span><span id=__span-0-1503><a id=__codelineno-0-1503 name=__codelineno-0-1503></a><span class=sd>                      Higher values use more memory but provide better buffering.</span>
</span><span id=__span-0-1504><a id=__codelineno-0-1504 name=__codelineno-0-1504></a><span class=sd>                      Range: 10-10000, default: 500.</span>
</span><span id=__span-0-1505><a id=__codelineno-0-1505 name=__codelineno-0-1505></a><span class=sd>        use_mixture_of_scanners: If True, use MoS strategy for higher entropy by</span>
</span><span id=__span-0-1506><a id=__codelineno-0-1506 name=__codelineno-0-1506></a><span class=sd>                               randomly sampling from multiple fragment generators.</span>
</span><span id=__span-0-1507><a id=__codelineno-0-1507 name=__codelineno-0-1507></a><span class=sd>                               Provides better randomization for foundation model training.</span>
</span><span id=__span-0-1508><a id=__codelineno-0-1508 name=__codelineno-0-1508></a><span class=sd>                               Default: True.</span>
</span><span id=__span-0-1509><a id=__codelineno-0-1509 name=__codelineno-0-1509></a><span class=sd>        n_readers: Total number of fragment generators to create when using MoS.</span>
</span><span id=__span-0-1510><a id=__codelineno-0-1510 name=__codelineno-0-1510></a><span class=sd>                  Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1511><a id=__codelineno-0-1511 name=__codelineno-0-1511></a><span class=sd>                  Range: 1-1000, default: 50.</span>
</span><span id=__span-0-1512><a id=__codelineno-0-1512 name=__codelineno-0-1512></a><span class=sd>        n_scanners: Number of active scanners to sample from simultaneously when using MoS.</span>
</span><span id=__span-0-1513><a id=__codelineno-0-1513 name=__codelineno-0-1513></a><span class=sd>                   Higher values provide better entropy but use more memory.</span>
</span><span id=__span-0-1514><a id=__codelineno-0-1514 name=__codelineno-0-1514></a><span class=sd>                   Range: 1-100, default: 8.</span>
</span><span id=__span-0-1515><a id=__codelineno-0-1515 name=__codelineno-0-1515></a>
</span><span id=__span-0-1516><a id=__codelineno-0-1516 name=__codelineno-0-1516></a><span class=sd>    Raises:</span>
</span><span id=__span-0-1517><a id=__codelineno-0-1517 name=__codelineno-0-1517></a><span class=sd>        ImportError: If TileDB SOMA is not available.</span>
</span><span id=__span-0-1518><a id=__codelineno-0-1518 name=__codelineno-0-1518></a><span class=sd>        ValueError: If MoS parameters are invalid.</span>
</span><span id=__span-0-1519><a id=__codelineno-0-1519 name=__codelineno-0-1519></a><span class=sd>        RuntimeError: If the TileDB experiment cannot be opened or is invalid.</span>
</span><span id=__span-0-1520><a id=__codelineno-0-1520 name=__codelineno-0-1520></a>
</span><span id=__span-0-1521><a id=__codelineno-0-1521 name=__codelineno-0-1521></a><span class=sd>    Examples:</span>
</span><span id=__span-0-1522><a id=__codelineno-0-1522 name=__codelineno-0-1522></a><span class=sd>        &gt;&gt;&gt; # Basic initialization with default MoS strategy</span>
</span><span id=__span-0-1523><a id=__codelineno-0-1523 name=__codelineno-0-1523></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1524><a id=__codelineno-0-1524 name=__codelineno-0-1524></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1525><a id=__codelineno-0-1525 name=__codelineno-0-1525></a><span class=sd>        ...     batch_size=32,</span>
</span><span id=__span-0-1526><a id=__codelineno-0-1526 name=__codelineno-0-1526></a><span class=sd>        ...     prefetch_batch_size=100</span>
</span><span id=__span-0-1527><a id=__codelineno-0-1527 name=__codelineno-0-1527></a><span class=sd>        ... )</span>
</span><span id=__span-0-1528><a id=__codelineno-0-1528 name=__codelineno-0-1528></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS enabled: {dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1529><a id=__codelineno-0-1529 name=__codelineno-0-1529></a><span class=sd>        MoS enabled: True</span>
</span><span id=__span-0-1530><a id=__codelineno-0-1530 name=__codelineno-0-1530></a>
</span><span id=__span-0-1531><a id=__codelineno-0-1531 name=__codelineno-0-1531></a><span class=sd>        &gt;&gt;&gt; # Sequential loading for maximum throughput</span>
</span><span id=__span-0-1532><a id=__codelineno-0-1532 name=__codelineno-0-1532></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1533><a id=__codelineno-0-1533 name=__codelineno-0-1533></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1534><a id=__codelineno-0-1534 name=__codelineno-0-1534></a><span class=sd>        ...     use_mixture_of_scanners=False,</span>
</span><span id=__span-0-1535><a id=__codelineno-0-1535 name=__codelineno-0-1535></a><span class=sd>        ...     batch_size=64</span>
</span><span id=__span-0-1536><a id=__codelineno-0-1536 name=__codelineno-0-1536></a><span class=sd>        ... )</span>
</span><span id=__span-0-1537><a id=__codelineno-0-1537 name=__codelineno-0-1537></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Sequential loading: {not dataloader.use_mixture_of_scanners}&quot;)</span>
</span><span id=__span-0-1538><a id=__codelineno-0-1538 name=__codelineno-0-1538></a><span class=sd>        Sequential loading: True</span>
</span><span id=__span-0-1539><a id=__codelineno-0-1539 name=__codelineno-0-1539></a>
</span><span id=__span-0-1540><a id=__codelineno-0-1540 name=__codelineno-0-1540></a><span class=sd>        &gt;&gt;&gt; # High-entropy MoS configuration</span>
</span><span id=__span-0-1541><a id=__codelineno-0-1541 name=__codelineno-0-1541></a><span class=sd>        &gt;&gt;&gt; dataloader = TileDBDataLoader(</span>
</span><span id=__span-0-1542><a id=__codelineno-0-1542 name=__codelineno-0-1542></a><span class=sd>        ...     tiledb_path=&quot;path/to/experiment&quot;,</span>
</span><span id=__span-0-1543><a id=__codelineno-0-1543 name=__codelineno-0-1543></a><span class=sd>        ...     n_readers=100,</span>
</span><span id=__span-0-1544><a id=__codelineno-0-1544 name=__codelineno-0-1544></a><span class=sd>        ...     n_scanners=16</span>
</span><span id=__span-0-1545><a id=__codelineno-0-1545 name=__codelineno-0-1545></a><span class=sd>        ... )</span>
</span><span id=__span-0-1546><a id=__codelineno-0-1546 name=__codelineno-0-1546></a><span class=sd>        &gt;&gt;&gt; print(f&quot;MoS readers: {dataloader.n_readers}, scanners: {dataloader.n_scanners}&quot;)</span>
</span><span id=__span-0-1547><a id=__codelineno-0-1547 name=__codelineno-0-1547></a><span class=sd>        MoS readers: 100, scanners: 16</span>
</span><span id=__span-0-1548><a id=__codelineno-0-1548 name=__codelineno-0-1548></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-1549><a id=__codelineno-0-1549 name=__codelineno-0-1549></a>    <span class=bp>self</span><span class=o>.</span><span class=n>tiledb_path</span> <span class=o>=</span> <span class=n>tiledb_path</span>
</span><span id=__span-0-1550><a id=__codelineno-0-1550 name=__codelineno-0-1550></a>    <span class=bp>self</span><span class=o>.</span><span class=n>batch_size</span> <span class=o>=</span> <span class=n>batch_size</span>
</span><span id=__span-0-1551><a id=__codelineno-0-1551 name=__codelineno-0-1551></a>    <span class=bp>self</span><span class=o>.</span><span class=n>prefetch_batch_size</span> <span class=o>=</span> <span class=n>prefetch_batch_size</span>
</span><span id=__span-0-1552><a id=__codelineno-0-1552 name=__codelineno-0-1552></a>    <span class=bp>self</span><span class=o>.</span><span class=n>seed</span> <span class=o>=</span> <span class=n>seed</span>
</span><span id=__span-0-1553><a id=__codelineno-0-1553 name=__codelineno-0-1553></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_epochs</span> <span class=o>=</span> <span class=n>n_epochs</span>
</span><span id=__span-0-1554><a id=__codelineno-0-1554 name=__codelineno-0-1554></a>    <span class=bp>self</span><span class=o>.</span><span class=n>verbose</span> <span class=o>=</span> <span class=n>verbose</span>
</span><span id=__span-0-1555><a id=__codelineno-0-1555 name=__codelineno-0-1555></a>    <span class=bp>self</span><span class=o>.</span><span class=n>max_queue_size</span> <span class=o>=</span> <span class=n>max_queue_size</span>
</span><span id=__span-0-1556><a id=__codelineno-0-1556 name=__codelineno-0-1556></a>    <span class=bp>self</span><span class=o>.</span><span class=n>use_mixture_of_scanners</span> <span class=o>=</span> <span class=n>use_mixture_of_scanners</span>
</span><span id=__span-0-1557><a id=__codelineno-0-1557 name=__codelineno-0-1557></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_readers</span> <span class=o>=</span> <span class=n>n_readers</span>
</span><span id=__span-0-1558><a id=__codelineno-0-1558 name=__codelineno-0-1558></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_scanners</span> <span class=o>=</span> <span class=n>n_scanners</span>
</span><span id=__span-0-1559><a id=__codelineno-0-1559 name=__codelineno-0-1559></a>
</span><span id=__span-0-1560><a id=__codelineno-0-1560 name=__codelineno-0-1560></a>    <span class=c1># Check that required modules are available</span>
</span><span id=__span-0-1561><a id=__codelineno-0-1561 name=__codelineno-0-1561></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>TILEDB_AVAILABLE</span><span class=p>:</span>
</span><span id=__span-0-1562><a id=__codelineno-0-1562 name=__codelineno-0-1562></a>        <span class=k>raise</span> <span class=ne>ImportError</span><span class=p>(</span><span class=s2>&quot;TileDB SOMA is required but not available&quot;</span><span class=p>)</span>
</span><span id=__span-0-1563><a id=__codelineno-0-1563 name=__codelineno-0-1563></a>
</span><span id=__span-0-1564><a id=__codelineno-0-1564 name=__codelineno-0-1564></a>    <span class=c1># Use IterableDataset</span>
</span><span id=__span-0-1565><a id=__codelineno-0-1565 name=__codelineno-0-1565></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_dataset</span> <span class=o>=</span> <span class=n>TileDBIterableDataset</span><span class=p>(</span>
</span><span id=__span-0-1566><a id=__codelineno-0-1566 name=__codelineno-0-1566></a>        <span class=n>tiledb_path</span><span class=o>=</span><span class=n>tiledb_path</span><span class=p>,</span>
</span><span id=__span-0-1567><a id=__codelineno-0-1567 name=__codelineno-0-1567></a>        <span class=n>batch_size</span><span class=o>=</span><span class=n>batch_size</span><span class=p>,</span>
</span><span id=__span-0-1568><a id=__codelineno-0-1568 name=__codelineno-0-1568></a>        <span class=n>prefetch_batch_size</span><span class=o>=</span><span class=n>prefetch_batch_size</span><span class=p>,</span>
</span><span id=__span-0-1569><a id=__codelineno-0-1569 name=__codelineno-0-1569></a>        <span class=n>seed</span><span class=o>=</span><span class=n>seed</span><span class=p>,</span>
</span><span id=__span-0-1570><a id=__codelineno-0-1570 name=__codelineno-0-1570></a>        <span class=n>max_queue_size</span><span class=o>=</span><span class=n>max_queue_size</span><span class=p>,</span>
</span><span id=__span-0-1571><a id=__codelineno-0-1571 name=__codelineno-0-1571></a>        <span class=n>n_epochs</span><span class=o>=</span><span class=n>n_epochs</span><span class=p>,</span>
</span><span id=__span-0-1572><a id=__codelineno-0-1572 name=__codelineno-0-1572></a>        <span class=n>verbose</span><span class=o>=</span><span class=n>verbose</span><span class=p>,</span>
</span><span id=__span-0-1573><a id=__codelineno-0-1573 name=__codelineno-0-1573></a>        <span class=n>use_mixture_of_scanners</span><span class=o>=</span><span class=n>use_mixture_of_scanners</span><span class=p>,</span>
</span><span id=__span-0-1574><a id=__codelineno-0-1574 name=__codelineno-0-1574></a>        <span class=n>n_readers</span><span class=o>=</span><span class=n>n_readers</span><span class=p>,</span>
</span><span id=__span-0-1575><a id=__codelineno-0-1575 name=__codelineno-0-1575></a>        <span class=n>n_scanners</span><span class=o>=</span><span class=n>n_scanners</span><span class=p>,</span>
</span><span id=__span-0-1576><a id=__codelineno-0-1576 name=__codelineno-0-1576></a>    <span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> <h3 id=slaf.ml.tiledb_dataloaders-functions>Functions<a href=#slaf.ml.tiledb_dataloaders-functions class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-object doc-function"> <h4 id=slaf.ml.tiledb_dataloaders.print_prefetch class="doc doc-heading"> <code class="highlight language-python"><span class=n>print_prefetch</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span></code> <a href=#slaf.ml.tiledb_dataloaders.print_prefetch class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Print prefetch-related messages with colored formatting.</p> <p>This function prints prefetch-related messages using rich console formatting when available, or falls back to loguru logging. Messages are displayed in cyan-colored panels for better visual distinction during training.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>message</code> </td> <td> <code><span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>The message to print.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>verbose</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, print the message. If False, suppress output.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Print a prefetch message</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>print_prefetch</span><span class=p>(</span><span class=s2>&quot;Loading batch 1 of 100&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Suppress output</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>print_prefetch</span><span class=p>(</span><span class=s2>&quot;Loading batch 1 of 100&quot;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-42>42</a></span>
<span class=normal><a href=#__codelineno-0-43>43</a></span>
<span class=normal><a href=#__codelineno-0-44>44</a></span>
<span class=normal><a href=#__codelineno-0-45>45</a></span>
<span class=normal><a href=#__codelineno-0-46>46</a></span>
<span class=normal><a href=#__codelineno-0-47>47</a></span>
<span class=normal><a href=#__codelineno-0-48>48</a></span>
<span class=normal><a href=#__codelineno-0-49>49</a></span>
<span class=normal><a href=#__codelineno-0-50>50</a></span>
<span class=normal><a href=#__codelineno-0-51>51</a></span>
<span class=normal><a href=#__codelineno-0-52>52</a></span>
<span class=normal><a href=#__codelineno-0-53>53</a></span>
<span class=normal><a href=#__codelineno-0-54>54</a></span>
<span class=normal><a href=#__codelineno-0-55>55</a></span>
<span class=normal><a href=#__codelineno-0-56>56</a></span>
<span class=normal><a href=#__codelineno-0-57>57</a></span>
<span class=normal><a href=#__codelineno-0-58>58</a></span>
<span class=normal><a href=#__codelineno-0-59>59</a></span>
<span class=normal><a href=#__codelineno-0-60>60</a></span>
<span class=normal><a href=#__codelineno-0-61>61</a></span>
<span class=normal><a href=#__codelineno-0-62>62</a></span>
<span class=normal><a href=#__codelineno-0-63>63</a></span>
<span class=normal><a href=#__codelineno-0-64>64</a></span>
<span class=normal><a href=#__codelineno-0-65>65</a></span>
<span class=normal><a href=#__codelineno-0-66>66</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42></a><span class=k>def</span><span class=w> </span><span class=nf>print_prefetch</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44></a><span class=sd>    Print prefetch-related messages with colored formatting.</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45></a>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46></a><span class=sd>    This function prints prefetch-related messages using rich console formatting</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47></a><span class=sd>    when available, or falls back to loguru logging. Messages are displayed in</span>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48></a><span class=sd>    cyan-colored panels for better visual distinction during training.</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49></a>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50></a><span class=sd>    Args:</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51></a><span class=sd>        message: The message to print.</span>
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52></a><span class=sd>        verbose: If True, print the message. If False, suppress output.</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53></a>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54></a><span class=sd>    Examples:</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55></a><span class=sd>        &gt;&gt;&gt; # Print a prefetch message</span>
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56></a><span class=sd>        &gt;&gt;&gt; print_prefetch(&quot;Loading batch 1 of 100&quot;)</span>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57></a><span class=sd>        &gt;&gt;&gt; # Suppress output</span>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58></a><span class=sd>        &gt;&gt;&gt; print_prefetch(&quot;Loading batch 1 of 100&quot;, verbose=False)</span>
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61></a>        <span class=k>return</span>
</span><span id=__span-0-62><a id=__codelineno-0-62 name=__codelineno-0-62></a>
</span><span id=__span-0-63><a id=__codelineno-0-63 name=__codelineno-0-63></a>    <span class=k>if</span> <span class=n>RICH_AVAILABLE</span> <span class=ow>and</span> <span class=n>console</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-64><a id=__codelineno-0-64 name=__codelineno-0-64></a>        <span class=n>console</span><span class=o>.</span><span class=n>print</span><span class=p>(</span><span class=n>Panel</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>border_style</span><span class=o>=</span><span class=s2>&quot;cyan&quot;</span><span class=p>))</span>
</span><span id=__span-0-65><a id=__codelineno-0-65 name=__codelineno-0-65></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-66><a id=__codelineno-0-66 name=__codelineno-0-66></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot; </span><span class=si>{</span><span class=n>message</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h4 id=slaf.ml.tiledb_dataloaders.print_training class="doc doc-heading"> <code class="highlight language-python"><span class=n>print_training</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>)</span></code> <a href=#slaf.ml.tiledb_dataloaders.print_training class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Print training-related messages with colored formatting.</p> <p>This function prints training-related messages using rich console formatting when available, or falls back to loguru logging. Messages are displayed in green-colored panels for better visual distinction during training.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>message</code> </td> <td> <code><span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>The message to print.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>verbose</code> </td> <td> <code><span title=bool>bool</span></code> </td> <td> <div class=doc-md-description> <p>If True, print the message. If False, suppress output.</p> </div> </td> <td> <code>True</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Print a training message</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>print_training</span><span class=p>(</span><span class=s2>&quot;Processing batch with 32 cells&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Suppress output</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>print_training</span><span class=p>(</span><span class=s2>&quot;Processing batch with 32 cells&quot;</span><span class=p>,</span> <span class=n>verbose</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tiledb_dataloaders.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-69>69</a></span>
<span class=normal><a href=#__codelineno-0-70>70</a></span>
<span class=normal><a href=#__codelineno-0-71>71</a></span>
<span class=normal><a href=#__codelineno-0-72>72</a></span>
<span class=normal><a href=#__codelineno-0-73>73</a></span>
<span class=normal><a href=#__codelineno-0-74>74</a></span>
<span class=normal><a href=#__codelineno-0-75>75</a></span>
<span class=normal><a href=#__codelineno-0-76>76</a></span>
<span class=normal><a href=#__codelineno-0-77>77</a></span>
<span class=normal><a href=#__codelineno-0-78>78</a></span>
<span class=normal><a href=#__codelineno-0-79>79</a></span>
<span class=normal><a href=#__codelineno-0-80>80</a></span>
<span class=normal><a href=#__codelineno-0-81>81</a></span>
<span class=normal><a href=#__codelineno-0-82>82</a></span>
<span class=normal><a href=#__codelineno-0-83>83</a></span>
<span class=normal><a href=#__codelineno-0-84>84</a></span>
<span class=normal><a href=#__codelineno-0-85>85</a></span>
<span class=normal><a href=#__codelineno-0-86>86</a></span>
<span class=normal><a href=#__codelineno-0-87>87</a></span>
<span class=normal><a href=#__codelineno-0-88>88</a></span>
<span class=normal><a href=#__codelineno-0-89>89</a></span>
<span class=normal><a href=#__codelineno-0-90>90</a></span>
<span class=normal><a href=#__codelineno-0-91>91</a></span>
<span class=normal><a href=#__codelineno-0-92>92</a></span>
<span class=normal><a href=#__codelineno-0-93>93</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-69><a id=__codelineno-0-69 name=__codelineno-0-69></a><span class=k>def</span><span class=w> </span><span class=nf>print_training</span><span class=p>(</span><span class=n>message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>verbose</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span><span class=p>):</span>
</span><span id=__span-0-70><a id=__codelineno-0-70 name=__codelineno-0-70></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-71><a id=__codelineno-0-71 name=__codelineno-0-71></a><span class=sd>    Print training-related messages with colored formatting.</span>
</span><span id=__span-0-72><a id=__codelineno-0-72 name=__codelineno-0-72></a>
</span><span id=__span-0-73><a id=__codelineno-0-73 name=__codelineno-0-73></a><span class=sd>    This function prints training-related messages using rich console formatting</span>
</span><span id=__span-0-74><a id=__codelineno-0-74 name=__codelineno-0-74></a><span class=sd>    when available, or falls back to loguru logging. Messages are displayed in</span>
</span><span id=__span-0-75><a id=__codelineno-0-75 name=__codelineno-0-75></a><span class=sd>    green-colored panels for better visual distinction during training.</span>
</span><span id=__span-0-76><a id=__codelineno-0-76 name=__codelineno-0-76></a>
</span><span id=__span-0-77><a id=__codelineno-0-77 name=__codelineno-0-77></a><span class=sd>    Args:</span>
</span><span id=__span-0-78><a id=__codelineno-0-78 name=__codelineno-0-78></a><span class=sd>        message: The message to print.</span>
</span><span id=__span-0-79><a id=__codelineno-0-79 name=__codelineno-0-79></a><span class=sd>        verbose: If True, print the message. If False, suppress output.</span>
</span><span id=__span-0-80><a id=__codelineno-0-80 name=__codelineno-0-80></a>
</span><span id=__span-0-81><a id=__codelineno-0-81 name=__codelineno-0-81></a><span class=sd>    Examples:</span>
</span><span id=__span-0-82><a id=__codelineno-0-82 name=__codelineno-0-82></a><span class=sd>        &gt;&gt;&gt; # Print a training message</span>
</span><span id=__span-0-83><a id=__codelineno-0-83 name=__codelineno-0-83></a><span class=sd>        &gt;&gt;&gt; print_training(&quot;Processing batch with 32 cells&quot;)</span>
</span><span id=__span-0-84><a id=__codelineno-0-84 name=__codelineno-0-84></a><span class=sd>        &gt;&gt;&gt; # Suppress output</span>
</span><span id=__span-0-85><a id=__codelineno-0-85 name=__codelineno-0-85></a><span class=sd>        &gt;&gt;&gt; print_training(&quot;Processing batch with 32 cells&quot;, verbose=False)</span>
</span><span id=__span-0-86><a id=__codelineno-0-86 name=__codelineno-0-86></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-87><a id=__codelineno-0-87 name=__codelineno-0-87></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>verbose</span><span class=p>:</span>
</span><span id=__span-0-88><a id=__codelineno-0-88 name=__codelineno-0-88></a>        <span class=k>return</span>
</span><span id=__span-0-89><a id=__codelineno-0-89 name=__codelineno-0-89></a>
</span><span id=__span-0-90><a id=__codelineno-0-90 name=__codelineno-0-90></a>    <span class=k>if</span> <span class=n>RICH_AVAILABLE</span> <span class=ow>and</span> <span class=n>console</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-91><a id=__codelineno-0-91 name=__codelineno-0-91></a>        <span class=n>console</span><span class=o>.</span><span class=n>print</span><span class=p>(</span><span class=n>Panel</span><span class=p>(</span><span class=n>message</span><span class=p>,</span> <span class=n>border_style</span><span class=o>=</span><span class=s2>&quot;green&quot;</span><span class=p>))</span>
</span><span id=__span-0-92><a id=__codelineno-0-92 name=__codelineno-0-92></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-93><a id=__codelineno-0-93 name=__codelineno-0-93></a>        <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot; </span><span class=si>{</span><span class=n>message</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div><h2 id=tokenizers>Tokenizers<a class=headerlink href=#tokenizers title="Permanent link">&para;</a></h2> <div class="doc doc-object doc-module"> <h2 id=slaf.ml.tokenizers class="doc doc-heading"> <code>slaf.ml.tokenizers</code> <a href=#slaf.ml.tokenizers class=headerlink title="Permanent link">&para;</a></h2> <div class="doc doc-contents first"> <div class="doc doc-children"> <h3 id=slaf.ml.tokenizers-classes>Classes<a href=#slaf.ml.tokenizers-classes class=headerlink title="Permanent link">&para;</a></h3> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tokenizers.TokenizerType class="doc doc-heading"> <code>TokenizerType</code> <a href=#slaf.ml.tokenizers.TokenizerType class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p class="doc doc-class-bases"> Bases: <code><span title=str>str</span></code>, <code><span title=enum.Enum>Enum</span></code></p> <p>Tokenizer types</p> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tokenizers.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-16>16</a></span>
<span class=normal><a href=#__codelineno-0-17>17</a></span>
<span class=normal><a href=#__codelineno-0-18>18</a></span>
<span class=normal><a href=#__codelineno-0-19>19</a></span>
<span class=normal><a href=#__codelineno-0-20>20</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16></a><span class=k>class</span><span class=w> </span><span class=nc>TokenizerType</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>Enum</span><span class=p>):</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Tokenizer types&quot;&quot;&quot;</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18></a>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19></a>    <span class=n>GENEFORMER</span> <span class=o>=</span> <span class=s2>&quot;geneformer&quot;</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20></a>    <span class=n>SCPGPT</span> <span class=o>=</span> <span class=s2>&quot;scgpt&quot;</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> </div> </div> </div> <div class="doc doc-object doc-class"> <h4 id=slaf.ml.tokenizers.SLAFTokenizer class="doc doc-heading"> <code>SLAFTokenizer</code> <a href=#slaf.ml.tokenizers.SLAFTokenizer class=headerlink title="Permanent link">&para;</a></h4> <div class="doc doc-contents "> <p>Tokenizer for single-cell RNA-seq data in SLAF format.</p> <p>SLAFTokenizer converts single-cell gene expression data into token sequences suitable for machine learning models. It supports multiple tokenization strategies including GeneFormer and scGPT formats with optimized vectorized operations.</p> <details class=key-features open> <summary>Key Features</summary> <ul> <li>Multiple tokenization strategies (GeneFormer, scGPT)</li> <li>Vectorized tokenization for high performance</li> <li>Expression binning for scGPT format</li> <li>Device-agnostic CPU tensor output</li> <li>Memory-efficient processing</li> <li>Comprehensive vocabulary management</li> </ul> </details> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic usage with GeneFormer</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>SLAFArray</span><span class=p>(</span><span class=s2>&quot;path/to/data.slaf&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;geneformer&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>gene_sequences</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>]]</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>tokenize</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Input shape: </span><span class=si>{</span><span class=n>input_ids</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Input shape: torch.Size([2, 2048])</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># scGPT with expression sequences</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;scgpt&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>gene_sequences</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>]]</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>expr_sequences</span> <span class=o>=</span> <span class=p>[[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.8</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span> <span class=p>[</span><span class=mf>0.9</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>]]</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>tokenize</span><span class=p>(</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>gene_sequences</span><span class=p>,</span> <span class=n>expr_sequences</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Input shape: </span><span class=si>{</span><span class=n>input_ids</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>Input shape: torch.Size([2, 2050])</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Error handling for invalid tokenizer type</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;invalid&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span><span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Error: Unsupported tokenizer type: invalid. Supported types: [&#39;geneformer&#39;, &#39;scgpt&#39;]</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Vocabulary information</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vocab_info</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>get_vocab_info</span><span class=p>()</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Vocabulary size: </span><span class=si>{</span><span class=n>vocab_info</span><span class=p>[</span><span class=s1>&#39;vocab_size&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=go>Vocabulary size: 50000</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tokenizers.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-23> 23</a></span>
<span class=normal><a href=#__codelineno-0-24> 24</a></span>
<span class=normal><a href=#__codelineno-0-25> 25</a></span>
<span class=normal><a href=#__codelineno-0-26> 26</a></span>
<span class=normal><a href=#__codelineno-0-27> 27</a></span>
<span class=normal><a href=#__codelineno-0-28> 28</a></span>
<span class=normal><a href=#__codelineno-0-29> 29</a></span>
<span class=normal><a href=#__codelineno-0-30> 30</a></span>
<span class=normal><a href=#__codelineno-0-31> 31</a></span>
<span class=normal><a href=#__codelineno-0-32> 32</a></span>
<span class=normal><a href=#__codelineno-0-33> 33</a></span>
<span class=normal><a href=#__codelineno-0-34> 34</a></span>
<span class=normal><a href=#__codelineno-0-35> 35</a></span>
<span class=normal><a href=#__codelineno-0-36> 36</a></span>
<span class=normal><a href=#__codelineno-0-37> 37</a></span>
<span class=normal><a href=#__codelineno-0-38> 38</a></span>
<span class=normal><a href=#__codelineno-0-39> 39</a></span>
<span class=normal><a href=#__codelineno-0-40> 40</a></span>
<span class=normal><a href=#__codelineno-0-41> 41</a></span>
<span class=normal><a href=#__codelineno-0-42> 42</a></span>
<span class=normal><a href=#__codelineno-0-43> 43</a></span>
<span class=normal><a href=#__codelineno-0-44> 44</a></span>
<span class=normal><a href=#__codelineno-0-45> 45</a></span>
<span class=normal><a href=#__codelineno-0-46> 46</a></span>
<span class=normal><a href=#__codelineno-0-47> 47</a></span>
<span class=normal><a href=#__codelineno-0-48> 48</a></span>
<span class=normal><a href=#__codelineno-0-49> 49</a></span>
<span class=normal><a href=#__codelineno-0-50> 50</a></span>
<span class=normal><a href=#__codelineno-0-51> 51</a></span>
<span class=normal><a href=#__codelineno-0-52> 52</a></span>
<span class=normal><a href=#__codelineno-0-53> 53</a></span>
<span class=normal><a href=#__codelineno-0-54> 54</a></span>
<span class=normal><a href=#__codelineno-0-55> 55</a></span>
<span class=normal><a href=#__codelineno-0-56> 56</a></span>
<span class=normal><a href=#__codelineno-0-57> 57</a></span>
<span class=normal><a href=#__codelineno-0-58> 58</a></span>
<span class=normal><a href=#__codelineno-0-59> 59</a></span>
<span class=normal><a href=#__codelineno-0-60> 60</a></span>
<span class=normal><a href=#__codelineno-0-61> 61</a></span>
<span class=normal><a href=#__codelineno-0-62> 62</a></span>
<span class=normal><a href=#__codelineno-0-63> 63</a></span>
<span class=normal><a href=#__codelineno-0-64> 64</a></span>
<span class=normal><a href=#__codelineno-0-65> 65</a></span>
<span class=normal><a href=#__codelineno-0-66> 66</a></span>
<span class=normal><a href=#__codelineno-0-67> 67</a></span>
<span class=normal><a href=#__codelineno-0-68> 68</a></span>
<span class=normal><a href=#__codelineno-0-69> 69</a></span>
<span class=normal><a href=#__codelineno-0-70> 70</a></span>
<span class=normal><a href=#__codelineno-0-71> 71</a></span>
<span class=normal><a href=#__codelineno-0-72> 72</a></span>
<span class=normal><a href=#__codelineno-0-73> 73</a></span>
<span class=normal><a href=#__codelineno-0-74> 74</a></span>
<span class=normal><a href=#__codelineno-0-75> 75</a></span>
<span class=normal><a href=#__codelineno-0-76> 76</a></span>
<span class=normal><a href=#__codelineno-0-77> 77</a></span>
<span class=normal><a href=#__codelineno-0-78> 78</a></span>
<span class=normal><a href=#__codelineno-0-79> 79</a></span>
<span class=normal><a href=#__codelineno-0-80> 80</a></span>
<span class=normal><a href=#__codelineno-0-81> 81</a></span>
<span class=normal><a href=#__codelineno-0-82> 82</a></span>
<span class=normal><a href=#__codelineno-0-83> 83</a></span>
<span class=normal><a href=#__codelineno-0-84> 84</a></span>
<span class=normal><a href=#__codelineno-0-85> 85</a></span>
<span class=normal><a href=#__codelineno-0-86> 86</a></span>
<span class=normal><a href=#__codelineno-0-87> 87</a></span>
<span class=normal><a href=#__codelineno-0-88> 88</a></span>
<span class=normal><a href=#__codelineno-0-89> 89</a></span>
<span class=normal><a href=#__codelineno-0-90> 90</a></span>
<span class=normal><a href=#__codelineno-0-91> 91</a></span>
<span class=normal><a href=#__codelineno-0-92> 92</a></span>
<span class=normal><a href=#__codelineno-0-93> 93</a></span>
<span class=normal><a href=#__codelineno-0-94> 94</a></span>
<span class=normal><a href=#__codelineno-0-95> 95</a></span>
<span class=normal><a href=#__codelineno-0-96> 96</a></span>
<span class=normal><a href=#__codelineno-0-97> 97</a></span>
<span class=normal><a href=#__codelineno-0-98> 98</a></span>
<span class=normal><a href=#__codelineno-0-99> 99</a></span>
<span class=normal><a href=#__codelineno-0-100>100</a></span>
<span class=normal><a href=#__codelineno-0-101>101</a></span>
<span class=normal><a href=#__codelineno-0-102>102</a></span>
<span class=normal><a href=#__codelineno-0-103>103</a></span>
<span class=normal><a href=#__codelineno-0-104>104</a></span>
<span class=normal><a href=#__codelineno-0-105>105</a></span>
<span class=normal><a href=#__codelineno-0-106>106</a></span>
<span class=normal><a href=#__codelineno-0-107>107</a></span>
<span class=normal><a href=#__codelineno-0-108>108</a></span>
<span class=normal><a href=#__codelineno-0-109>109</a></span>
<span class=normal><a href=#__codelineno-0-110>110</a></span>
<span class=normal><a href=#__codelineno-0-111>111</a></span>
<span class=normal><a href=#__codelineno-0-112>112</a></span>
<span class=normal><a href=#__codelineno-0-113>113</a></span>
<span class=normal><a href=#__codelineno-0-114>114</a></span>
<span class=normal><a href=#__codelineno-0-115>115</a></span>
<span class=normal><a href=#__codelineno-0-116>116</a></span>
<span class=normal><a href=#__codelineno-0-117>117</a></span>
<span class=normal><a href=#__codelineno-0-118>118</a></span>
<span class=normal><a href=#__codelineno-0-119>119</a></span>
<span class=normal><a href=#__codelineno-0-120>120</a></span>
<span class=normal><a href=#__codelineno-0-121>121</a></span>
<span class=normal><a href=#__codelineno-0-122>122</a></span>
<span class=normal><a href=#__codelineno-0-123>123</a></span>
<span class=normal><a href=#__codelineno-0-124>124</a></span>
<span class=normal><a href=#__codelineno-0-125>125</a></span>
<span class=normal><a href=#__codelineno-0-126>126</a></span>
<span class=normal><a href=#__codelineno-0-127>127</a></span>
<span class=normal><a href=#__codelineno-0-128>128</a></span>
<span class=normal><a href=#__codelineno-0-129>129</a></span>
<span class=normal><a href=#__codelineno-0-130>130</a></span>
<span class=normal><a href=#__codelineno-0-131>131</a></span>
<span class=normal><a href=#__codelineno-0-132>132</a></span>
<span class=normal><a href=#__codelineno-0-133>133</a></span>
<span class=normal><a href=#__codelineno-0-134>134</a></span>
<span class=normal><a href=#__codelineno-0-135>135</a></span>
<span class=normal><a href=#__codelineno-0-136>136</a></span>
<span class=normal><a href=#__codelineno-0-137>137</a></span>
<span class=normal><a href=#__codelineno-0-138>138</a></span>
<span class=normal><a href=#__codelineno-0-139>139</a></span>
<span class=normal><a href=#__codelineno-0-140>140</a></span>
<span class=normal><a href=#__codelineno-0-141>141</a></span>
<span class=normal><a href=#__codelineno-0-142>142</a></span>
<span class=normal><a href=#__codelineno-0-143>143</a></span>
<span class=normal><a href=#__codelineno-0-144>144</a></span>
<span class=normal><a href=#__codelineno-0-145>145</a></span>
<span class=normal><a href=#__codelineno-0-146>146</a></span>
<span class=normal><a href=#__codelineno-0-147>147</a></span>
<span class=normal><a href=#__codelineno-0-148>148</a></span>
<span class=normal><a href=#__codelineno-0-149>149</a></span>
<span class=normal><a href=#__codelineno-0-150>150</a></span>
<span class=normal><a href=#__codelineno-0-151>151</a></span>
<span class=normal><a href=#__codelineno-0-152>152</a></span>
<span class=normal><a href=#__codelineno-0-153>153</a></span>
<span class=normal><a href=#__codelineno-0-154>154</a></span>
<span class=normal><a href=#__codelineno-0-155>155</a></span>
<span class=normal><a href=#__codelineno-0-156>156</a></span>
<span class=normal><a href=#__codelineno-0-157>157</a></span>
<span class=normal><a href=#__codelineno-0-158>158</a></span>
<span class=normal><a href=#__codelineno-0-159>159</a></span>
<span class=normal><a href=#__codelineno-0-160>160</a></span>
<span class=normal><a href=#__codelineno-0-161>161</a></span>
<span class=normal><a href=#__codelineno-0-162>162</a></span>
<span class=normal><a href=#__codelineno-0-163>163</a></span>
<span class=normal><a href=#__codelineno-0-164>164</a></span>
<span class=normal><a href=#__codelineno-0-165>165</a></span>
<span class=normal><a href=#__codelineno-0-166>166</a></span>
<span class=normal><a href=#__codelineno-0-167>167</a></span>
<span class=normal><a href=#__codelineno-0-168>168</a></span>
<span class=normal><a href=#__codelineno-0-169>169</a></span>
<span class=normal><a href=#__codelineno-0-170>170</a></span>
<span class=normal><a href=#__codelineno-0-171>171</a></span>
<span class=normal><a href=#__codelineno-0-172>172</a></span>
<span class=normal><a href=#__codelineno-0-173>173</a></span>
<span class=normal><a href=#__codelineno-0-174>174</a></span>
<span class=normal><a href=#__codelineno-0-175>175</a></span>
<span class=normal><a href=#__codelineno-0-176>176</a></span>
<span class=normal><a href=#__codelineno-0-177>177</a></span>
<span class=normal><a href=#__codelineno-0-178>178</a></span>
<span class=normal><a href=#__codelineno-0-179>179</a></span>
<span class=normal><a href=#__codelineno-0-180>180</a></span>
<span class=normal><a href=#__codelineno-0-181>181</a></span>
<span class=normal><a href=#__codelineno-0-182>182</a></span>
<span class=normal><a href=#__codelineno-0-183>183</a></span>
<span class=normal><a href=#__codelineno-0-184>184</a></span>
<span class=normal><a href=#__codelineno-0-185>185</a></span>
<span class=normal><a href=#__codelineno-0-186>186</a></span>
<span class=normal><a href=#__codelineno-0-187>187</a></span>
<span class=normal><a href=#__codelineno-0-188>188</a></span>
<span class=normal><a href=#__codelineno-0-189>189</a></span>
<span class=normal><a href=#__codelineno-0-190>190</a></span>
<span class=normal><a href=#__codelineno-0-191>191</a></span>
<span class=normal><a href=#__codelineno-0-192>192</a></span>
<span class=normal><a href=#__codelineno-0-193>193</a></span>
<span class=normal><a href=#__codelineno-0-194>194</a></span>
<span class=normal><a href=#__codelineno-0-195>195</a></span>
<span class=normal><a href=#__codelineno-0-196>196</a></span>
<span class=normal><a href=#__codelineno-0-197>197</a></span>
<span class=normal><a href=#__codelineno-0-198>198</a></span>
<span class=normal><a href=#__codelineno-0-199>199</a></span>
<span class=normal><a href=#__codelineno-0-200>200</a></span>
<span class=normal><a href=#__codelineno-0-201>201</a></span>
<span class=normal><a href=#__codelineno-0-202>202</a></span>
<span class=normal><a href=#__codelineno-0-203>203</a></span>
<span class=normal><a href=#__codelineno-0-204>204</a></span>
<span class=normal><a href=#__codelineno-0-205>205</a></span>
<span class=normal><a href=#__codelineno-0-206>206</a></span>
<span class=normal><a href=#__codelineno-0-207>207</a></span>
<span class=normal><a href=#__codelineno-0-208>208</a></span>
<span class=normal><a href=#__codelineno-0-209>209</a></span>
<span class=normal><a href=#__codelineno-0-210>210</a></span>
<span class=normal><a href=#__codelineno-0-211>211</a></span>
<span class=normal><a href=#__codelineno-0-212>212</a></span>
<span class=normal><a href=#__codelineno-0-213>213</a></span>
<span class=normal><a href=#__codelineno-0-214>214</a></span>
<span class=normal><a href=#__codelineno-0-215>215</a></span>
<span class=normal><a href=#__codelineno-0-216>216</a></span>
<span class=normal><a href=#__codelineno-0-217>217</a></span>
<span class=normal><a href=#__codelineno-0-218>218</a></span>
<span class=normal><a href=#__codelineno-0-219>219</a></span>
<span class=normal><a href=#__codelineno-0-220>220</a></span>
<span class=normal><a href=#__codelineno-0-221>221</a></span>
<span class=normal><a href=#__codelineno-0-222>222</a></span>
<span class=normal><a href=#__codelineno-0-223>223</a></span>
<span class=normal><a href=#__codelineno-0-224>224</a></span>
<span class=normal><a href=#__codelineno-0-225>225</a></span>
<span class=normal><a href=#__codelineno-0-226>226</a></span>
<span class=normal><a href=#__codelineno-0-227>227</a></span>
<span class=normal><a href=#__codelineno-0-228>228</a></span>
<span class=normal><a href=#__codelineno-0-229>229</a></span>
<span class=normal><a href=#__codelineno-0-230>230</a></span>
<span class=normal><a href=#__codelineno-0-231>231</a></span>
<span class=normal><a href=#__codelineno-0-232>232</a></span>
<span class=normal><a href=#__codelineno-0-233>233</a></span>
<span class=normal><a href=#__codelineno-0-234>234</a></span>
<span class=normal><a href=#__codelineno-0-235>235</a></span>
<span class=normal><a href=#__codelineno-0-236>236</a></span>
<span class=normal><a href=#__codelineno-0-237>237</a></span>
<span class=normal><a href=#__codelineno-0-238>238</a></span>
<span class=normal><a href=#__codelineno-0-239>239</a></span>
<span class=normal><a href=#__codelineno-0-240>240</a></span>
<span class=normal><a href=#__codelineno-0-241>241</a></span>
<span class=normal><a href=#__codelineno-0-242>242</a></span>
<span class=normal><a href=#__codelineno-0-243>243</a></span>
<span class=normal><a href=#__codelineno-0-244>244</a></span>
<span class=normal><a href=#__codelineno-0-245>245</a></span>
<span class=normal><a href=#__codelineno-0-246>246</a></span>
<span class=normal><a href=#__codelineno-0-247>247</a></span>
<span class=normal><a href=#__codelineno-0-248>248</a></span>
<span class=normal><a href=#__codelineno-0-249>249</a></span>
<span class=normal><a href=#__codelineno-0-250>250</a></span>
<span class=normal><a href=#__codelineno-0-251>251</a></span>
<span class=normal><a href=#__codelineno-0-252>252</a></span>
<span class=normal><a href=#__codelineno-0-253>253</a></span>
<span class=normal><a href=#__codelineno-0-254>254</a></span>
<span class=normal><a href=#__codelineno-0-255>255</a></span>
<span class=normal><a href=#__codelineno-0-256>256</a></span>
<span class=normal><a href=#__codelineno-0-257>257</a></span>
<span class=normal><a href=#__codelineno-0-258>258</a></span>
<span class=normal><a href=#__codelineno-0-259>259</a></span>
<span class=normal><a href=#__codelineno-0-260>260</a></span>
<span class=normal><a href=#__codelineno-0-261>261</a></span>
<span class=normal><a href=#__codelineno-0-262>262</a></span>
<span class=normal><a href=#__codelineno-0-263>263</a></span>
<span class=normal><a href=#__codelineno-0-264>264</a></span>
<span class=normal><a href=#__codelineno-0-265>265</a></span>
<span class=normal><a href=#__codelineno-0-266>266</a></span>
<span class=normal><a href=#__codelineno-0-267>267</a></span>
<span class=normal><a href=#__codelineno-0-268>268</a></span>
<span class=normal><a href=#__codelineno-0-269>269</a></span>
<span class=normal><a href=#__codelineno-0-270>270</a></span>
<span class=normal><a href=#__codelineno-0-271>271</a></span>
<span class=normal><a href=#__codelineno-0-272>272</a></span>
<span class=normal><a href=#__codelineno-0-273>273</a></span>
<span class=normal><a href=#__codelineno-0-274>274</a></span>
<span class=normal><a href=#__codelineno-0-275>275</a></span>
<span class=normal><a href=#__codelineno-0-276>276</a></span>
<span class=normal><a href=#__codelineno-0-277>277</a></span>
<span class=normal><a href=#__codelineno-0-278>278</a></span>
<span class=normal><a href=#__codelineno-0-279>279</a></span>
<span class=normal><a href=#__codelineno-0-280>280</a></span>
<span class=normal><a href=#__codelineno-0-281>281</a></span>
<span class=normal><a href=#__codelineno-0-282>282</a></span>
<span class=normal><a href=#__codelineno-0-283>283</a></span>
<span class=normal><a href=#__codelineno-0-284>284</a></span>
<span class=normal><a href=#__codelineno-0-285>285</a></span>
<span class=normal><a href=#__codelineno-0-286>286</a></span>
<span class=normal><a href=#__codelineno-0-287>287</a></span>
<span class=normal><a href=#__codelineno-0-288>288</a></span>
<span class=normal><a href=#__codelineno-0-289>289</a></span>
<span class=normal><a href=#__codelineno-0-290>290</a></span>
<span class=normal><a href=#__codelineno-0-291>291</a></span>
<span class=normal><a href=#__codelineno-0-292>292</a></span>
<span class=normal><a href=#__codelineno-0-293>293</a></span>
<span class=normal><a href=#__codelineno-0-294>294</a></span>
<span class=normal><a href=#__codelineno-0-295>295</a></span>
<span class=normal><a href=#__codelineno-0-296>296</a></span>
<span class=normal><a href=#__codelineno-0-297>297</a></span>
<span class=normal><a href=#__codelineno-0-298>298</a></span>
<span class=normal><a href=#__codelineno-0-299>299</a></span>
<span class=normal><a href=#__codelineno-0-300>300</a></span>
<span class=normal><a href=#__codelineno-0-301>301</a></span>
<span class=normal><a href=#__codelineno-0-302>302</a></span>
<span class=normal><a href=#__codelineno-0-303>303</a></span>
<span class=normal><a href=#__codelineno-0-304>304</a></span>
<span class=normal><a href=#__codelineno-0-305>305</a></span>
<span class=normal><a href=#__codelineno-0-306>306</a></span>
<span class=normal><a href=#__codelineno-0-307>307</a></span>
<span class=normal><a href=#__codelineno-0-308>308</a></span>
<span class=normal><a href=#__codelineno-0-309>309</a></span>
<span class=normal><a href=#__codelineno-0-310>310</a></span>
<span class=normal><a href=#__codelineno-0-311>311</a></span>
<span class=normal><a href=#__codelineno-0-312>312</a></span>
<span class=normal><a href=#__codelineno-0-313>313</a></span>
<span class=normal><a href=#__codelineno-0-314>314</a></span>
<span class=normal><a href=#__codelineno-0-315>315</a></span>
<span class=normal><a href=#__codelineno-0-316>316</a></span>
<span class=normal><a href=#__codelineno-0-317>317</a></span>
<span class=normal><a href=#__codelineno-0-318>318</a></span>
<span class=normal><a href=#__codelineno-0-319>319</a></span>
<span class=normal><a href=#__codelineno-0-320>320</a></span>
<span class=normal><a href=#__codelineno-0-321>321</a></span>
<span class=normal><a href=#__codelineno-0-322>322</a></span>
<span class=normal><a href=#__codelineno-0-323>323</a></span>
<span class=normal><a href=#__codelineno-0-324>324</a></span>
<span class=normal><a href=#__codelineno-0-325>325</a></span>
<span class=normal><a href=#__codelineno-0-326>326</a></span>
<span class=normal><a href=#__codelineno-0-327>327</a></span>
<span class=normal><a href=#__codelineno-0-328>328</a></span>
<span class=normal><a href=#__codelineno-0-329>329</a></span>
<span class=normal><a href=#__codelineno-0-330>330</a></span>
<span class=normal><a href=#__codelineno-0-331>331</a></span>
<span class=normal><a href=#__codelineno-0-332>332</a></span>
<span class=normal><a href=#__codelineno-0-333>333</a></span>
<span class=normal><a href=#__codelineno-0-334>334</a></span>
<span class=normal><a href=#__codelineno-0-335>335</a></span>
<span class=normal><a href=#__codelineno-0-336>336</a></span>
<span class=normal><a href=#__codelineno-0-337>337</a></span>
<span class=normal><a href=#__codelineno-0-338>338</a></span>
<span class=normal><a href=#__codelineno-0-339>339</a></span>
<span class=normal><a href=#__codelineno-0-340>340</a></span>
<span class=normal><a href=#__codelineno-0-341>341</a></span>
<span class=normal><a href=#__codelineno-0-342>342</a></span>
<span class=normal><a href=#__codelineno-0-343>343</a></span>
<span class=normal><a href=#__codelineno-0-344>344</a></span>
<span class=normal><a href=#__codelineno-0-345>345</a></span>
<span class=normal><a href=#__codelineno-0-346>346</a></span>
<span class=normal><a href=#__codelineno-0-347>347</a></span>
<span class=normal><a href=#__codelineno-0-348>348</a></span>
<span class=normal><a href=#__codelineno-0-349>349</a></span>
<span class=normal><a href=#__codelineno-0-350>350</a></span>
<span class=normal><a href=#__codelineno-0-351>351</a></span>
<span class=normal><a href=#__codelineno-0-352>352</a></span>
<span class=normal><a href=#__codelineno-0-353>353</a></span>
<span class=normal><a href=#__codelineno-0-354>354</a></span>
<span class=normal><a href=#__codelineno-0-355>355</a></span>
<span class=normal><a href=#__codelineno-0-356>356</a></span>
<span class=normal><a href=#__codelineno-0-357>357</a></span>
<span class=normal><a href=#__codelineno-0-358>358</a></span>
<span class=normal><a href=#__codelineno-0-359>359</a></span>
<span class=normal><a href=#__codelineno-0-360>360</a></span>
<span class=normal><a href=#__codelineno-0-361>361</a></span>
<span class=normal><a href=#__codelineno-0-362>362</a></span>
<span class=normal><a href=#__codelineno-0-363>363</a></span>
<span class=normal><a href=#__codelineno-0-364>364</a></span>
<span class=normal><a href=#__codelineno-0-365>365</a></span>
<span class=normal><a href=#__codelineno-0-366>366</a></span>
<span class=normal><a href=#__codelineno-0-367>367</a></span>
<span class=normal><a href=#__codelineno-0-368>368</a></span>
<span class=normal><a href=#__codelineno-0-369>369</a></span>
<span class=normal><a href=#__codelineno-0-370>370</a></span>
<span class=normal><a href=#__codelineno-0-371>371</a></span>
<span class=normal><a href=#__codelineno-0-372>372</a></span>
<span class=normal><a href=#__codelineno-0-373>373</a></span>
<span class=normal><a href=#__codelineno-0-374>374</a></span>
<span class=normal><a href=#__codelineno-0-375>375</a></span>
<span class=normal><a href=#__codelineno-0-376>376</a></span>
<span class=normal><a href=#__codelineno-0-377>377</a></span>
<span class=normal><a href=#__codelineno-0-378>378</a></span>
<span class=normal><a href=#__codelineno-0-379>379</a></span>
<span class=normal><a href=#__codelineno-0-380>380</a></span>
<span class=normal><a href=#__codelineno-0-381>381</a></span>
<span class=normal><a href=#__codelineno-0-382>382</a></span>
<span class=normal><a href=#__codelineno-0-383>383</a></span>
<span class=normal><a href=#__codelineno-0-384>384</a></span>
<span class=normal><a href=#__codelineno-0-385>385</a></span>
<span class=normal><a href=#__codelineno-0-386>386</a></span>
<span class=normal><a href=#__codelineno-0-387>387</a></span>
<span class=normal><a href=#__codelineno-0-388>388</a></span>
<span class=normal><a href=#__codelineno-0-389>389</a></span>
<span class=normal><a href=#__codelineno-0-390>390</a></span>
<span class=normal><a href=#__codelineno-0-391>391</a></span>
<span class=normal><a href=#__codelineno-0-392>392</a></span>
<span class=normal><a href=#__codelineno-0-393>393</a></span>
<span class=normal><a href=#__codelineno-0-394>394</a></span>
<span class=normal><a href=#__codelineno-0-395>395</a></span>
<span class=normal><a href=#__codelineno-0-396>396</a></span>
<span class=normal><a href=#__codelineno-0-397>397</a></span>
<span class=normal><a href=#__codelineno-0-398>398</a></span>
<span class=normal><a href=#__codelineno-0-399>399</a></span>
<span class=normal><a href=#__codelineno-0-400>400</a></span>
<span class=normal><a href=#__codelineno-0-401>401</a></span>
<span class=normal><a href=#__codelineno-0-402>402</a></span>
<span class=normal><a href=#__codelineno-0-403>403</a></span>
<span class=normal><a href=#__codelineno-0-404>404</a></span>
<span class=normal><a href=#__codelineno-0-405>405</a></span>
<span class=normal><a href=#__codelineno-0-406>406</a></span>
<span class=normal><a href=#__codelineno-0-407>407</a></span>
<span class=normal><a href=#__codelineno-0-408>408</a></span>
<span class=normal><a href=#__codelineno-0-409>409</a></span>
<span class=normal><a href=#__codelineno-0-410>410</a></span>
<span class=normal><a href=#__codelineno-0-411>411</a></span>
<span class=normal><a href=#__codelineno-0-412>412</a></span>
<span class=normal><a href=#__codelineno-0-413>413</a></span>
<span class=normal><a href=#__codelineno-0-414>414</a></span>
<span class=normal><a href=#__codelineno-0-415>415</a></span>
<span class=normal><a href=#__codelineno-0-416>416</a></span>
<span class=normal><a href=#__codelineno-0-417>417</a></span>
<span class=normal><a href=#__codelineno-0-418>418</a></span>
<span class=normal><a href=#__codelineno-0-419>419</a></span>
<span class=normal><a href=#__codelineno-0-420>420</a></span>
<span class=normal><a href=#__codelineno-0-421>421</a></span>
<span class=normal><a href=#__codelineno-0-422>422</a></span>
<span class=normal><a href=#__codelineno-0-423>423</a></span>
<span class=normal><a href=#__codelineno-0-424>424</a></span>
<span class=normal><a href=#__codelineno-0-425>425</a></span>
<span class=normal><a href=#__codelineno-0-426>426</a></span>
<span class=normal><a href=#__codelineno-0-427>427</a></span>
<span class=normal><a href=#__codelineno-0-428>428</a></span>
<span class=normal><a href=#__codelineno-0-429>429</a></span>
<span class=normal><a href=#__codelineno-0-430>430</a></span>
<span class=normal><a href=#__codelineno-0-431>431</a></span>
<span class=normal><a href=#__codelineno-0-432>432</a></span>
<span class=normal><a href=#__codelineno-0-433>433</a></span>
<span class=normal><a href=#__codelineno-0-434>434</a></span>
<span class=normal><a href=#__codelineno-0-435>435</a></span>
<span class=normal><a href=#__codelineno-0-436>436</a></span>
<span class=normal><a href=#__codelineno-0-437>437</a></span>
<span class=normal><a href=#__codelineno-0-438>438</a></span>
<span class=normal><a href=#__codelineno-0-439>439</a></span>
<span class=normal><a href=#__codelineno-0-440>440</a></span>
<span class=normal><a href=#__codelineno-0-441>441</a></span>
<span class=normal><a href=#__codelineno-0-442>442</a></span>
<span class=normal><a href=#__codelineno-0-443>443</a></span>
<span class=normal><a href=#__codelineno-0-444>444</a></span>
<span class=normal><a href=#__codelineno-0-445>445</a></span>
<span class=normal><a href=#__codelineno-0-446>446</a></span>
<span class=normal><a href=#__codelineno-0-447>447</a></span>
<span class=normal><a href=#__codelineno-0-448>448</a></span>
<span class=normal><a href=#__codelineno-0-449>449</a></span>
<span class=normal><a href=#__codelineno-0-450>450</a></span>
<span class=normal><a href=#__codelineno-0-451>451</a></span>
<span class=normal><a href=#__codelineno-0-452>452</a></span>
<span class=normal><a href=#__codelineno-0-453>453</a></span>
<span class=normal><a href=#__codelineno-0-454>454</a></span>
<span class=normal><a href=#__codelineno-0-455>455</a></span>
<span class=normal><a href=#__codelineno-0-456>456</a></span>
<span class=normal><a href=#__codelineno-0-457>457</a></span>
<span class=normal><a href=#__codelineno-0-458>458</a></span>
<span class=normal><a href=#__codelineno-0-459>459</a></span>
<span class=normal><a href=#__codelineno-0-460>460</a></span>
<span class=normal><a href=#__codelineno-0-461>461</a></span>
<span class=normal><a href=#__codelineno-0-462>462</a></span>
<span class=normal><a href=#__codelineno-0-463>463</a></span>
<span class=normal><a href=#__codelineno-0-464>464</a></span>
<span class=normal><a href=#__codelineno-0-465>465</a></span>
<span class=normal><a href=#__codelineno-0-466>466</a></span>
<span class=normal><a href=#__codelineno-0-467>467</a></span>
<span class=normal><a href=#__codelineno-0-468>468</a></span>
<span class=normal><a href=#__codelineno-0-469>469</a></span>
<span class=normal><a href=#__codelineno-0-470>470</a></span>
<span class=normal><a href=#__codelineno-0-471>471</a></span>
<span class=normal><a href=#__codelineno-0-472>472</a></span>
<span class=normal><a href=#__codelineno-0-473>473</a></span>
<span class=normal><a href=#__codelineno-0-474>474</a></span>
<span class=normal><a href=#__codelineno-0-475>475</a></span>
<span class=normal><a href=#__codelineno-0-476>476</a></span>
<span class=normal><a href=#__codelineno-0-477>477</a></span>
<span class=normal><a href=#__codelineno-0-478>478</a></span>
<span class=normal><a href=#__codelineno-0-479>479</a></span>
<span class=normal><a href=#__codelineno-0-480>480</a></span>
<span class=normal><a href=#__codelineno-0-481>481</a></span>
<span class=normal><a href=#__codelineno-0-482>482</a></span>
<span class=normal><a href=#__codelineno-0-483>483</a></span>
<span class=normal><a href=#__codelineno-0-484>484</a></span>
<span class=normal><a href=#__codelineno-0-485>485</a></span>
<span class=normal><a href=#__codelineno-0-486>486</a></span>
<span class=normal><a href=#__codelineno-0-487>487</a></span>
<span class=normal><a href=#__codelineno-0-488>488</a></span>
<span class=normal><a href=#__codelineno-0-489>489</a></span>
<span class=normal><a href=#__codelineno-0-490>490</a></span>
<span class=normal><a href=#__codelineno-0-491>491</a></span>
<span class=normal><a href=#__codelineno-0-492>492</a></span>
<span class=normal><a href=#__codelineno-0-493>493</a></span>
<span class=normal><a href=#__codelineno-0-494>494</a></span>
<span class=normal><a href=#__codelineno-0-495>495</a></span>
<span class=normal><a href=#__codelineno-0-496>496</a></span>
<span class=normal><a href=#__codelineno-0-497>497</a></span>
<span class=normal><a href=#__codelineno-0-498>498</a></span>
<span class=normal><a href=#__codelineno-0-499>499</a></span>
<span class=normal><a href=#__codelineno-0-500>500</a></span>
<span class=normal><a href=#__codelineno-0-501>501</a></span>
<span class=normal><a href=#__codelineno-0-502>502</a></span>
<span class=normal><a href=#__codelineno-0-503>503</a></span>
<span class=normal><a href=#__codelineno-0-504>504</a></span>
<span class=normal><a href=#__codelineno-0-505>505</a></span>
<span class=normal><a href=#__codelineno-0-506>506</a></span>
<span class=normal><a href=#__codelineno-0-507>507</a></span>
<span class=normal><a href=#__codelineno-0-508>508</a></span>
<span class=normal><a href=#__codelineno-0-509>509</a></span>
<span class=normal><a href=#__codelineno-0-510>510</a></span>
<span class=normal><a href=#__codelineno-0-511>511</a></span>
<span class=normal><a href=#__codelineno-0-512>512</a></span>
<span class=normal><a href=#__codelineno-0-513>513</a></span>
<span class=normal><a href=#__codelineno-0-514>514</a></span>
<span class=normal><a href=#__codelineno-0-515>515</a></span>
<span class=normal><a href=#__codelineno-0-516>516</a></span>
<span class=normal><a href=#__codelineno-0-517>517</a></span>
<span class=normal><a href=#__codelineno-0-518>518</a></span>
<span class=normal><a href=#__codelineno-0-519>519</a></span>
<span class=normal><a href=#__codelineno-0-520>520</a></span>
<span class=normal><a href=#__codelineno-0-521>521</a></span>
<span class=normal><a href=#__codelineno-0-522>522</a></span>
<span class=normal><a href=#__codelineno-0-523>523</a></span>
<span class=normal><a href=#__codelineno-0-524>524</a></span>
<span class=normal><a href=#__codelineno-0-525>525</a></span>
<span class=normal><a href=#__codelineno-0-526>526</a></span>
<span class=normal><a href=#__codelineno-0-527>527</a></span>
<span class=normal><a href=#__codelineno-0-528>528</a></span>
<span class=normal><a href=#__codelineno-0-529>529</a></span>
<span class=normal><a href=#__codelineno-0-530>530</a></span>
<span class=normal><a href=#__codelineno-0-531>531</a></span>
<span class=normal><a href=#__codelineno-0-532>532</a></span>
<span class=normal><a href=#__codelineno-0-533>533</a></span>
<span class=normal><a href=#__codelineno-0-534>534</a></span>
<span class=normal><a href=#__codelineno-0-535>535</a></span>
<span class=normal><a href=#__codelineno-0-536>536</a></span>
<span class=normal><a href=#__codelineno-0-537>537</a></span>
<span class=normal><a href=#__codelineno-0-538>538</a></span>
<span class=normal><a href=#__codelineno-0-539>539</a></span>
<span class=normal><a href=#__codelineno-0-540>540</a></span>
<span class=normal><a href=#__codelineno-0-541>541</a></span>
<span class=normal><a href=#__codelineno-0-542>542</a></span>
<span class=normal><a href=#__codelineno-0-543>543</a></span>
<span class=normal><a href=#__codelineno-0-544>544</a></span>
<span class=normal><a href=#__codelineno-0-545>545</a></span>
<span class=normal><a href=#__codelineno-0-546>546</a></span>
<span class=normal><a href=#__codelineno-0-547>547</a></span>
<span class=normal><a href=#__codelineno-0-548>548</a></span>
<span class=normal><a href=#__codelineno-0-549>549</a></span>
<span class=normal><a href=#__codelineno-0-550>550</a></span>
<span class=normal><a href=#__codelineno-0-551>551</a></span>
<span class=normal><a href=#__codelineno-0-552>552</a></span>
<span class=normal><a href=#__codelineno-0-553>553</a></span>
<span class=normal><a href=#__codelineno-0-554>554</a></span>
<span class=normal><a href=#__codelineno-0-555>555</a></span>
<span class=normal><a href=#__codelineno-0-556>556</a></span>
<span class=normal><a href=#__codelineno-0-557>557</a></span>
<span class=normal><a href=#__codelineno-0-558>558</a></span>
<span class=normal><a href=#__codelineno-0-559>559</a></span>
<span class=normal><a href=#__codelineno-0-560>560</a></span>
<span class=normal><a href=#__codelineno-0-561>561</a></span>
<span class=normal><a href=#__codelineno-0-562>562</a></span>
<span class=normal><a href=#__codelineno-0-563>563</a></span>
<span class=normal><a href=#__codelineno-0-564>564</a></span>
<span class=normal><a href=#__codelineno-0-565>565</a></span>
<span class=normal><a href=#__codelineno-0-566>566</a></span>
<span class=normal><a href=#__codelineno-0-567>567</a></span>
<span class=normal><a href=#__codelineno-0-568>568</a></span>
<span class=normal><a href=#__codelineno-0-569>569</a></span>
<span class=normal><a href=#__codelineno-0-570>570</a></span>
<span class=normal><a href=#__codelineno-0-571>571</a></span>
<span class=normal><a href=#__codelineno-0-572>572</a></span>
<span class=normal><a href=#__codelineno-0-573>573</a></span>
<span class=normal><a href=#__codelineno-0-574>574</a></span>
<span class=normal><a href=#__codelineno-0-575>575</a></span>
<span class=normal><a href=#__codelineno-0-576>576</a></span>
<span class=normal><a href=#__codelineno-0-577>577</a></span>
<span class=normal><a href=#__codelineno-0-578>578</a></span>
<span class=normal><a href=#__codelineno-0-579>579</a></span>
<span class=normal><a href=#__codelineno-0-580>580</a></span>
<span class=normal><a href=#__codelineno-0-581>581</a></span>
<span class=normal><a href=#__codelineno-0-582>582</a></span>
<span class=normal><a href=#__codelineno-0-583>583</a></span>
<span class=normal><a href=#__codelineno-0-584>584</a></span>
<span class=normal><a href=#__codelineno-0-585>585</a></span>
<span class=normal><a href=#__codelineno-0-586>586</a></span>
<span class=normal><a href=#__codelineno-0-587>587</a></span>
<span class=normal><a href=#__codelineno-0-588>588</a></span>
<span class=normal><a href=#__codelineno-0-589>589</a></span>
<span class=normal><a href=#__codelineno-0-590>590</a></span>
<span class=normal><a href=#__codelineno-0-591>591</a></span>
<span class=normal><a href=#__codelineno-0-592>592</a></span>
<span class=normal><a href=#__codelineno-0-593>593</a></span>
<span class=normal><a href=#__codelineno-0-594>594</a></span>
<span class=normal><a href=#__codelineno-0-595>595</a></span>
<span class=normal><a href=#__codelineno-0-596>596</a></span>
<span class=normal><a href=#__codelineno-0-597>597</a></span>
<span class=normal><a href=#__codelineno-0-598>598</a></span>
<span class=normal><a href=#__codelineno-0-599>599</a></span>
<span class=normal><a href=#__codelineno-0-600>600</a></span>
<span class=normal><a href=#__codelineno-0-601>601</a></span>
<span class=normal><a href=#__codelineno-0-602>602</a></span>
<span class=normal><a href=#__codelineno-0-603>603</a></span>
<span class=normal><a href=#__codelineno-0-604>604</a></span>
<span class=normal><a href=#__codelineno-0-605>605</a></span>
<span class=normal><a href=#__codelineno-0-606>606</a></span>
<span class=normal><a href=#__codelineno-0-607>607</a></span>
<span class=normal><a href=#__codelineno-0-608>608</a></span>
<span class=normal><a href=#__codelineno-0-609>609</a></span>
<span class=normal><a href=#__codelineno-0-610>610</a></span>
<span class=normal><a href=#__codelineno-0-611>611</a></span>
<span class=normal><a href=#__codelineno-0-612>612</a></span>
<span class=normal><a href=#__codelineno-0-613>613</a></span>
<span class=normal><a href=#__codelineno-0-614>614</a></span>
<span class=normal><a href=#__codelineno-0-615>615</a></span>
<span class=normal><a href=#__codelineno-0-616>616</a></span>
<span class=normal><a href=#__codelineno-0-617>617</a></span>
<span class=normal><a href=#__codelineno-0-618>618</a></span>
<span class=normal><a href=#__codelineno-0-619>619</a></span>
<span class=normal><a href=#__codelineno-0-620>620</a></span>
<span class=normal><a href=#__codelineno-0-621>621</a></span>
<span class=normal><a href=#__codelineno-0-622>622</a></span>
<span class=normal><a href=#__codelineno-0-623>623</a></span>
<span class=normal><a href=#__codelineno-0-624>624</a></span>
<span class=normal><a href=#__codelineno-0-625>625</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23></a><span class=k>class</span><span class=w> </span><span class=nc>SLAFTokenizer</span><span class=p>:</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25></a><span class=sd>    Tokenizer for single-cell RNA-seq data in SLAF format.</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26></a>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27></a><span class=sd>    SLAFTokenizer converts single-cell gene expression data into token sequences</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28></a><span class=sd>    suitable for machine learning models. It supports multiple tokenization strategies</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29></a><span class=sd>    including GeneFormer and scGPT formats with optimized vectorized operations.</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30></a>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31></a><span class=sd>    Key Features:</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32></a><span class=sd>        - Multiple tokenization strategies (GeneFormer, scGPT)</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33></a><span class=sd>        - Vectorized tokenization for high performance</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34></a><span class=sd>        - Expression binning for scGPT format</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35></a><span class=sd>        - Device-agnostic CPU tensor output</span>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36></a><span class=sd>        - Memory-efficient processing</span>
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37></a><span class=sd>        - Comprehensive vocabulary management</span>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38></a>
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39></a><span class=sd>    Examples:</span>
</span><span id=__span-0-40><a id=__codelineno-0-40 name=__codelineno-0-40></a><span class=sd>        &gt;&gt;&gt; # Basic usage with GeneFormer</span>
</span><span id=__span-0-41><a id=__codelineno-0-41 name=__codelineno-0-41></a><span class=sd>        &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-42><a id=__codelineno-0-42 name=__codelineno-0-42></a><span class=sd>        &gt;&gt;&gt; tokenizer = SLAFTokenizer(slaf_array, tokenizer_type=&quot;geneformer&quot;)</span>
</span><span id=__span-0-43><a id=__codelineno-0-43 name=__codelineno-0-43></a><span class=sd>        &gt;&gt;&gt; gene_sequences = [[1, 2, 3], [4, 5, 6]]</span>
</span><span id=__span-0-44><a id=__codelineno-0-44 name=__codelineno-0-44></a><span class=sd>        &gt;&gt;&gt; input_ids, attention_mask = tokenizer.tokenize(gene_sequences)</span>
</span><span id=__span-0-45><a id=__codelineno-0-45 name=__codelineno-0-45></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Input shape: {input_ids.shape}&quot;)</span>
</span><span id=__span-0-46><a id=__codelineno-0-46 name=__codelineno-0-46></a><span class=sd>        Input shape: torch.Size([2, 2048])</span>
</span><span id=__span-0-47><a id=__codelineno-0-47 name=__codelineno-0-47></a>
</span><span id=__span-0-48><a id=__codelineno-0-48 name=__codelineno-0-48></a><span class=sd>        &gt;&gt;&gt; # scGPT with expression sequences</span>
</span><span id=__span-0-49><a id=__codelineno-0-49 name=__codelineno-0-49></a><span class=sd>        &gt;&gt;&gt; tokenizer = SLAFTokenizer(slaf_array, tokenizer_type=&quot;scgpt&quot;)</span>
</span><span id=__span-0-50><a id=__codelineno-0-50 name=__codelineno-0-50></a><span class=sd>        &gt;&gt;&gt; gene_sequences = [[1, 2, 3], [4, 5, 6]]</span>
</span><span id=__span-0-51><a id=__codelineno-0-51 name=__codelineno-0-51></a><span class=sd>        &gt;&gt;&gt; expr_sequences = [[0.5, 0.8, 0.2], [0.9, 0.1, 0.7]]</span>
</span><span id=__span-0-52><a id=__codelineno-0-52 name=__codelineno-0-52></a><span class=sd>        &gt;&gt;&gt; input_ids, attention_mask = tokenizer.tokenize(</span>
</span><span id=__span-0-53><a id=__codelineno-0-53 name=__codelineno-0-53></a><span class=sd>        ...     gene_sequences, expr_sequences</span>
</span><span id=__span-0-54><a id=__codelineno-0-54 name=__codelineno-0-54></a><span class=sd>        ... )</span>
</span><span id=__span-0-55><a id=__codelineno-0-55 name=__codelineno-0-55></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Input shape: {input_ids.shape}&quot;)</span>
</span><span id=__span-0-56><a id=__codelineno-0-56 name=__codelineno-0-56></a><span class=sd>        Input shape: torch.Size([2, 2050])</span>
</span><span id=__span-0-57><a id=__codelineno-0-57 name=__codelineno-0-57></a>
</span><span id=__span-0-58><a id=__codelineno-0-58 name=__codelineno-0-58></a><span class=sd>        &gt;&gt;&gt; # Error handling for invalid tokenizer type</span>
</span><span id=__span-0-59><a id=__codelineno-0-59 name=__codelineno-0-59></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-60><a id=__codelineno-0-60 name=__codelineno-0-60></a><span class=sd>        ...     tokenizer = SLAFTokenizer(slaf_array, tokenizer_type=&quot;invalid&quot;)</span>
</span><span id=__span-0-61><a id=__codelineno-0-61 name=__codelineno-0-61></a><span class=sd>        ... except ValueError as e:</span>
</span><span id=__span-0-62><a id=__codelineno-0-62 name=__codelineno-0-62></a><span class=sd>        ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-63><a id=__codelineno-0-63 name=__codelineno-0-63></a><span class=sd>        Error: Unsupported tokenizer type: invalid. Supported types: [&#39;geneformer&#39;, &#39;scgpt&#39;]</span>
</span><span id=__span-0-64><a id=__codelineno-0-64 name=__codelineno-0-64></a>
</span><span id=__span-0-65><a id=__codelineno-0-65 name=__codelineno-0-65></a><span class=sd>        &gt;&gt;&gt; # Vocabulary information</span>
</span><span id=__span-0-66><a id=__codelineno-0-66 name=__codelineno-0-66></a><span class=sd>        &gt;&gt;&gt; vocab_info = tokenizer.get_vocab_info()</span>
</span><span id=__span-0-67><a id=__codelineno-0-67 name=__codelineno-0-67></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Vocabulary size: {vocab_info[&#39;vocab_size&#39;]}&quot;)</span>
</span><span id=__span-0-68><a id=__codelineno-0-68 name=__codelineno-0-68></a><span class=sd>        Vocabulary size: 50000</span>
</span><span id=__span-0-69><a id=__codelineno-0-69 name=__codelineno-0-69></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-70><a id=__codelineno-0-70 name=__codelineno-0-70></a>
</span><span id=__span-0-71><a id=__codelineno-0-71 name=__codelineno-0-71></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-72><a id=__codelineno-0-72 name=__codelineno-0-72></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-73><a id=__codelineno-0-73 name=__codelineno-0-73></a>        <span class=n>slaf_array</span><span class=p>:</span> <span class=n>SLAFArray</span><span class=p>,</span>
</span><span id=__span-0-74><a id=__codelineno-0-74 name=__codelineno-0-74></a>        <span class=n>tokenizer_type</span><span class=p>:</span> <span class=n>TokenizerType</span> <span class=o>|</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>,</span>
</span><span id=__span-0-75><a id=__codelineno-0-75 name=__codelineno-0-75></a>        <span class=n>vocab_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span>
</span><span id=__span-0-76><a id=__codelineno-0-76 name=__codelineno-0-76></a>        <span class=n>n_expression_bins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-0-77><a id=__codelineno-0-77 name=__codelineno-0-77></a>    <span class=p>):</span>
</span><span id=__span-0-78><a id=__codelineno-0-78 name=__codelineno-0-78></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-79><a id=__codelineno-0-79 name=__codelineno-0-79></a><span class=sd>        Initialize SLAFTokenizer with SLAF array and vocabulary settings.</span>
</span><span id=__span-0-80><a id=__codelineno-0-80 name=__codelineno-0-80></a>
</span><span id=__span-0-81><a id=__codelineno-0-81 name=__codelineno-0-81></a><span class=sd>        Args:</span>
</span><span id=__span-0-82><a id=__codelineno-0-82 name=__codelineno-0-82></a><span class=sd>            slaf_array: Initialized SLAFArray instance containing the single-cell data.</span>
</span><span id=__span-0-83><a id=__codelineno-0-83 name=__codelineno-0-83></a><span class=sd>                       Used to build the gene vocabulary and access expression data.</span>
</span><span id=__span-0-84><a id=__codelineno-0-84 name=__codelineno-0-84></a><span class=sd>                       Must be a valid SLAFArray with proper var DataFrame.</span>
</span><span id=__span-0-85><a id=__codelineno-0-85 name=__codelineno-0-85></a><span class=sd>            tokenizer_type: Type of tokenizer to use. Options: &quot;geneformer&quot;, &quot;scgpt&quot;.</span>
</span><span id=__span-0-86><a id=__codelineno-0-86 name=__codelineno-0-86></a><span class=sd>                          Can be passed as string or TokenizerType enum.</span>
</span><span id=__span-0-87><a id=__codelineno-0-87 name=__codelineno-0-87></a><span class=sd>            vocab_size: Maximum size of gene vocabulary. Genes beyond this limit</span>
</span><span id=__span-0-88><a id=__codelineno-0-88 name=__codelineno-0-88></a><span class=sd>                       are excluded from tokenization. Higher values use more memory.</span>
</span><span id=__span-0-89><a id=__codelineno-0-89 name=__codelineno-0-89></a><span class=sd>            n_expression_bins: Number of expression bins for scGPT tokenization.</span>
</span><span id=__span-0-90><a id=__codelineno-0-90 name=__codelineno-0-90></a><span class=sd>                             Higher values provide finer expression resolution.</span>
</span><span id=__span-0-91><a id=__codelineno-0-91 name=__codelineno-0-91></a><span class=sd>                             Range: 1-1000, default: 10.</span>
</span><span id=__span-0-92><a id=__codelineno-0-92 name=__codelineno-0-92></a>
</span><span id=__span-0-93><a id=__codelineno-0-93 name=__codelineno-0-93></a><span class=sd>        Raises:</span>
</span><span id=__span-0-94><a id=__codelineno-0-94 name=__codelineno-0-94></a><span class=sd>            ValueError: If tokenizer_type is not supported or vocab_size is invalid.</span>
</span><span id=__span-0-95><a id=__codelineno-0-95 name=__codelineno-0-95></a><span class=sd>            RuntimeError: If SLAF array is not properly initialized.</span>
</span><span id=__span-0-96><a id=__codelineno-0-96 name=__codelineno-0-96></a><span class=sd>            TypeError: If slaf_array is not a valid SLAFArray instance.</span>
</span><span id=__span-0-97><a id=__codelineno-0-97 name=__codelineno-0-97></a>
</span><span id=__span-0-98><a id=__codelineno-0-98 name=__codelineno-0-98></a><span class=sd>        Examples:</span>
</span><span id=__span-0-99><a id=__codelineno-0-99 name=__codelineno-0-99></a><span class=sd>            &gt;&gt;&gt; # Basic initialization</span>
</span><span id=__span-0-100><a id=__codelineno-0-100 name=__codelineno-0-100></a><span class=sd>            &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-101><a id=__codelineno-0-101 name=__codelineno-0-101></a><span class=sd>            &gt;&gt;&gt; tokenizer = SLAFTokenizer(slaf_array)</span>
</span><span id=__span-0-102><a id=__codelineno-0-102 name=__codelineno-0-102></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Tokenizer type: {tokenizer.tokenizer_type}&quot;)</span>
</span><span id=__span-0-103><a id=__codelineno-0-103 name=__codelineno-0-103></a><span class=sd>            Tokenizer type: TokenizerType.GENEFORMER</span>
</span><span id=__span-0-104><a id=__codelineno-0-104 name=__codelineno-0-104></a>
</span><span id=__span-0-105><a id=__codelineno-0-105 name=__codelineno-0-105></a><span class=sd>            &gt;&gt;&gt; # scGPT with custom settings</span>
</span><span id=__span-0-106><a id=__codelineno-0-106 name=__codelineno-0-106></a><span class=sd>            &gt;&gt;&gt; tokenizer = SLAFTokenizer(</span>
</span><span id=__span-0-107><a id=__codelineno-0-107 name=__codelineno-0-107></a><span class=sd>            ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-108><a id=__codelineno-0-108 name=__codelineno-0-108></a><span class=sd>            ...     tokenizer_type=&quot;scgpt&quot;,</span>
</span><span id=__span-0-109><a id=__codelineno-0-109 name=__codelineno-0-109></a><span class=sd>            ...     vocab_size=30000,</span>
</span><span id=__span-0-110><a id=__codelineno-0-110 name=__codelineno-0-110></a><span class=sd>            ...     n_expression_bins=20</span>
</span><span id=__span-0-111><a id=__codelineno-0-111 name=__codelineno-0-111></a><span class=sd>            ... )</span>
</span><span id=__span-0-112><a id=__codelineno-0-112 name=__codelineno-0-112></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Expression bins: {tokenizer.n_expression_bins}&quot;)</span>
</span><span id=__span-0-113><a id=__codelineno-0-113 name=__codelineno-0-113></a><span class=sd>            Expression bins: 20</span>
</span><span id=__span-0-114><a id=__codelineno-0-114 name=__codelineno-0-114></a>
</span><span id=__span-0-115><a id=__codelineno-0-115 name=__codelineno-0-115></a><span class=sd>            &gt;&gt;&gt; # Error handling for invalid tokenizer type</span>
</span><span id=__span-0-116><a id=__codelineno-0-116 name=__codelineno-0-116></a><span class=sd>            &gt;&gt;&gt; try:</span>
</span><span id=__span-0-117><a id=__codelineno-0-117 name=__codelineno-0-117></a><span class=sd>            ...     tokenizer = SLAFTokenizer(slaf_array, tokenizer_type=&quot;invalid&quot;)</span>
</span><span id=__span-0-118><a id=__codelineno-0-118 name=__codelineno-0-118></a><span class=sd>            ... except ValueError as e:</span>
</span><span id=__span-0-119><a id=__codelineno-0-119 name=__codelineno-0-119></a><span class=sd>            ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-120><a id=__codelineno-0-120 name=__codelineno-0-120></a><span class=sd>            Error: Unsupported tokenizer type: invalid. Supported types: [&#39;geneformer&#39;, &#39;scgpt&#39;]</span>
</span><span id=__span-0-121><a id=__codelineno-0-121 name=__codelineno-0-121></a>
</span><span id=__span-0-122><a id=__codelineno-0-122 name=__codelineno-0-122></a><span class=sd>            &gt;&gt;&gt; # Error handling for invalid SLAF array</span>
</span><span id=__span-0-123><a id=__codelineno-0-123 name=__codelineno-0-123></a><span class=sd>            &gt;&gt;&gt; try:</span>
</span><span id=__span-0-124><a id=__codelineno-0-124 name=__codelineno-0-124></a><span class=sd>            ...     tokenizer = SLAFTokenizer(None)</span>
</span><span id=__span-0-125><a id=__codelineno-0-125 name=__codelineno-0-125></a><span class=sd>            ... except TypeError as e:</span>
</span><span id=__span-0-126><a id=__codelineno-0-126 name=__codelineno-0-126></a><span class=sd>            ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-127><a id=__codelineno-0-127 name=__codelineno-0-127></a><span class=sd>            Error: slaf_array must be a valid SLAFArray instance</span>
</span><span id=__span-0-128><a id=__codelineno-0-128 name=__codelineno-0-128></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-129><a id=__codelineno-0-129 name=__codelineno-0-129></a>        <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>slaf_array</span>
</span><span id=__span-0-130><a id=__codelineno-0-130 name=__codelineno-0-130></a>        <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span> <span class=o>=</span> <span class=n>vocab_size</span>
</span><span id=__span-0-131><a id=__codelineno-0-131 name=__codelineno-0-131></a>        <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span> <span class=o>=</span> <span class=n>n_expression_bins</span>
</span><span id=__span-0-132><a id=__codelineno-0-132 name=__codelineno-0-132></a>
</span><span id=__span-0-133><a id=__codelineno-0-133 name=__codelineno-0-133></a>        <span class=c1># Convert string to enum if needed</span>
</span><span id=__span-0-134><a id=__codelineno-0-134 name=__codelineno-0-134></a>        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tokenizer_type</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-0-135><a id=__codelineno-0-135 name=__codelineno-0-135></a>            <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-136><a id=__codelineno-0-136 name=__codelineno-0-136></a>                <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>=</span> <span class=n>TokenizerType</span><span class=p>(</span><span class=n>tokenizer_type</span><span class=o>.</span><span class=n>lower</span><span class=p>())</span>
</span><span id=__span-0-137><a id=__codelineno-0-137 name=__codelineno-0-137></a>            <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
</span><span id=__span-0-138><a id=__codelineno-0-138 name=__codelineno-0-138></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-0-139><a id=__codelineno-0-139 name=__codelineno-0-139></a>                    <span class=sa>f</span><span class=s2>&quot;Unsupported tokenizer type: </span><span class=si>{</span><span class=n>tokenizer_type</span><span class=si>}</span><span class=s2>. &quot;</span>
</span><span id=__span-0-140><a id=__codelineno-0-140 name=__codelineno-0-140></a>                    <span class=sa>f</span><span class=s2>&quot;Supported types: </span><span class=si>{</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>value</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=n>TokenizerType</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-141><a id=__codelineno-0-141 name=__codelineno-0-141></a>                <span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=nn>err</span>
</span><span id=__span-0-142><a id=__codelineno-0-142 name=__codelineno-0-142></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-143><a id=__codelineno-0-143 name=__codelineno-0-143></a>            <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>=</span> <span class=n>tokenizer_type</span>
</span><span id=__span-0-144><a id=__codelineno-0-144 name=__codelineno-0-144></a>
</span><span id=__span-0-145><a id=__codelineno-0-145 name=__codelineno-0-145></a>        <span class=c1># Build vocabulary and special tokens</span>
</span><span id=__span-0-146><a id=__codelineno-0-146 name=__codelineno-0-146></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_build_gene_vocabulary</span><span class=p>()</span>
</span><span id=__span-0-147><a id=__codelineno-0-147 name=__codelineno-0-147></a>        <span class=bp>self</span><span class=o>.</span><span class=n>_setup_special_tokens</span><span class=p>()</span>
</span><span id=__span-0-148><a id=__codelineno-0-148 name=__codelineno-0-148></a>
</span><span id=__span-0-149><a id=__codelineno-0-149 name=__codelineno-0-149></a>    <span class=k>def</span><span class=w> </span><span class=nf>_build_gene_vocabulary</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-150><a id=__codelineno-0-150 name=__codelineno-0-150></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Build gene vocabulary from SLAF var DataFrame or genes Lance table.&quot;&quot;&quot;</span>
</span><span id=__span-0-151><a id=__codelineno-0-151 name=__codelineno-0-151></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-152><a id=__codelineno-0-152 name=__codelineno-0-152></a>            <span class=c1># Try to use metadata if available</span>
</span><span id=__span-0-153><a id=__codelineno-0-153 name=__codelineno-0-153></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span><span class=o>.</span><span class=n>is_metadata_ready</span><span class=p>():</span>
</span><span id=__span-0-154><a id=__codelineno-0-154 name=__codelineno-0-154></a>                <span class=n>var_df</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span><span class=o>.</span><span class=n>var</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
</span><span id=__span-0-155><a id=__codelineno-0-155 name=__codelineno-0-155></a>
</span><span id=__span-0-156><a id=__codelineno-0-156 name=__codelineno-0-156></a>                <span class=c1># Check if we have a real SLAF array or a Mock object</span>
</span><span id=__span-0-157><a id=__codelineno-0-157 name=__codelineno-0-157></a>                <span class=k>if</span> <span class=p>(</span>
</span><span id=__span-0-158><a id=__codelineno-0-158 name=__codelineno-0-158></a>                    <span class=nb>hasattr</span><span class=p>(</span><span class=n>var_df</span><span class=p>,</span> <span class=s2>&quot;columns&quot;</span><span class=p>)</span>
</span><span id=__span-0-159><a id=__codelineno-0-159 name=__codelineno-0-159></a>                    <span class=ow>and</span> <span class=s2>&quot;gene_integer_id&quot;</span> <span class=ow>in</span> <span class=n>var_df</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-0-160><a id=__codelineno-0-160 name=__codelineno-0-160></a>                    <span class=ow>and</span> <span class=s2>&quot;gene_id&quot;</span> <span class=ow>in</span> <span class=n>var_df</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-0-161><a id=__codelineno-0-161 name=__codelineno-0-161></a>                <span class=p>):</span>
</span><span id=__span-0-162><a id=__codelineno-0-162 name=__codelineno-0-162></a>                    <span class=c1># Real SLAF array - build vocabulary from gene data</span>
</span><span id=__span-0-163><a id=__codelineno-0-163 name=__codelineno-0-163></a>                    <span class=n>gene_vocab</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-0-164><a id=__codelineno-0-164 name=__codelineno-0-164></a>
</span><span id=__span-0-165><a id=__codelineno-0-165 name=__codelineno-0-165></a>                    <span class=c1># Use Polars native iteration</span>
</span><span id=__span-0-166><a id=__codelineno-0-166 name=__codelineno-0-166></a>                    <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>var_df</span><span class=o>.</span><span class=n>iter_rows</span><span class=p>(</span><span class=n>named</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span><span id=__span-0-167><a id=__codelineno-0-167 name=__codelineno-0-167></a>                        <span class=n>gene_id</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;gene_id&quot;</span><span class=p>]</span>
</span><span id=__span-0-168><a id=__codelineno-0-168 name=__codelineno-0-168></a>                        <span class=n>gene_integer_id</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;gene_integer_id&quot;</span><span class=p>]</span>
</span><span id=__span-0-169><a id=__codelineno-0-169 name=__codelineno-0-169></a>
</span><span id=__span-0-170><a id=__codelineno-0-170 name=__codelineno-0-170></a>                        <span class=c1># Only include genes within vocab size limit</span>
</span><span id=__span-0-171><a id=__codelineno-0-171 name=__codelineno-0-171></a>                        <span class=k>if</span> <span class=n>gene_integer_id</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span><span class=p>:</span>
</span><span id=__span-0-172><a id=__codelineno-0-172 name=__codelineno-0-172></a>                            <span class=n>gene_vocab</span><span class=p>[</span><span class=n>gene_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>gene_integer_id</span>
</span><span id=__span-0-173><a id=__codelineno-0-173 name=__codelineno-0-173></a>
</span><span id=__span-0-174><a id=__codelineno-0-174 name=__codelineno-0-174></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span> <span class=o>=</span> <span class=n>gene_vocab</span>
</span><span id=__span-0-175><a id=__codelineno-0-175 name=__codelineno-0-175></a>                    <span class=c1># Account for the +4 offset used in tokenization</span>
</span><span id=__span-0-176><a id=__codelineno-0-176 name=__codelineno-0-176></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span> <span class=o>+</span> <span class=mi>4</span><span class=p>:</span> <span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span><span id=__span-0-177><a id=__codelineno-0-177 name=__codelineno-0-177></a>
</span><span id=__span-0-178><a id=__codelineno-0-178 name=__codelineno-0-178></a>                    <span class=c1># Pre-build vectorized mapping array for fast lookup</span>
</span><span id=__span-0-179><a id=__codelineno-0-179 name=__codelineno-0-179></a>                    <span class=n>max_gene_id</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-180><a id=__codelineno-0-180 name=__codelineno-0-180></a>                        <span class=nb>max</span><span class=p>(</span>
</span><span id=__span-0-181><a id=__codelineno-0-181 name=__codelineno-0-181></a>                            <span class=nb>int</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=n>k</span>
</span><span id=__span-0-182><a id=__codelineno-0-182 name=__codelineno-0-182></a>                            <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
</span><span id=__span-0-183><a id=__codelineno-0-183 name=__codelineno-0-183></a>                        <span class=p>)</span>
</span><span id=__span-0-184><a id=__codelineno-0-184 name=__codelineno-0-184></a>                        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span>
</span><span id=__span-0-185><a id=__codelineno-0-185 name=__codelineno-0-185></a>                        <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-186><a id=__codelineno-0-186 name=__codelineno-0-186></a>                    <span class=p>)</span>
</span><span id=__span-0-187><a id=__codelineno-0-187 name=__codelineno-0-187></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>vocab_mapping</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>max_gene_id</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-188><a id=__codelineno-0-188 name=__codelineno-0-188></a>
</span><span id=__span-0-189><a id=__codelineno-0-189 name=__codelineno-0-189></a>                    <span class=c1># Fill the mapping array once</span>
</span><span id=__span-0-190><a id=__codelineno-0-190 name=__codelineno-0-190></a>                    <span class=k>for</span> <span class=n>gene_id</span><span class=p>,</span> <span class=n>token_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-0-191><a id=__codelineno-0-191 name=__codelineno-0-191></a>                        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-192><a id=__codelineno-0-192 name=__codelineno-0-192></a>                            <span class=n>gene_id_int</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-193><a id=__codelineno-0-193 name=__codelineno-0-193></a>                                <span class=nb>int</span><span class=p>(</span><span class=n>gene_id</span><span class=p>)</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>gene_id</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=n>gene_id</span>
</span><span id=__span-0-194><a id=__codelineno-0-194 name=__codelineno-0-194></a>                            <span class=p>)</span>
</span><span id=__span-0-195><a id=__codelineno-0-195 name=__codelineno-0-195></a>                            <span class=bp>self</span><span class=o>.</span><span class=n>vocab_mapping</span><span class=p>[</span><span class=n>gene_id_int</span><span class=p>]</span> <span class=o>=</span> <span class=n>token_id</span>
</span><span id=__span-0-196><a id=__codelineno-0-196 name=__codelineno-0-196></a>                        <span class=k>except</span> <span class=p>(</span><span class=ne>ValueError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>):</span>
</span><span id=__span-0-197><a id=__codelineno-0-197 name=__codelineno-0-197></a>                            <span class=k>continue</span>
</span><span id=__span-0-198><a id=__codelineno-0-198 name=__codelineno-0-198></a>                    <span class=k>return</span>
</span><span id=__span-0-199><a id=__codelineno-0-199 name=__codelineno-0-199></a>
</span><span id=__span-0-200><a id=__codelineno-0-200 name=__codelineno-0-200></a>            <span class=c1># If metadata not available, read directly from genes Lance table</span>
</span><span id=__span-0-201><a id=__codelineno-0-201 name=__codelineno-0-201></a>            <span class=c1># This is more efficient for cloud datasets where metadata loading is skipped</span>
</span><span id=__span-0-202><a id=__codelineno-0-202 name=__codelineno-0-202></a>            <span class=kn>import</span><span class=w> </span><span class=nn>polars</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>pl</span>
</span><span id=__span-0-203><a id=__codelineno-0-203 name=__codelineno-0-203></a>
</span><span id=__span-0-204><a id=__codelineno-0-204 name=__codelineno-0-204></a>            <span class=n>genes_table</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span><span class=o>.</span><span class=n>genes</span><span class=o>.</span><span class=n>to_table</span><span class=p>()</span>
</span><span id=__span-0-205><a id=__codelineno-0-205 name=__codelineno-0-205></a>            <span class=n>genes_df</span> <span class=o>=</span> <span class=n>pl</span><span class=o>.</span><span class=n>from_arrow</span><span class=p>(</span><span class=n>genes_table</span><span class=p>)</span>
</span><span id=__span-0-206><a id=__codelineno-0-206 name=__codelineno-0-206></a>
</span><span id=__span-0-207><a id=__codelineno-0-207 name=__codelineno-0-207></a>            <span class=c1># Check if we have the required columns</span>
</span><span id=__span-0-208><a id=__codelineno-0-208 name=__codelineno-0-208></a>            <span class=k>if</span> <span class=s2>&quot;gene_integer_id&quot;</span> <span class=ow>in</span> <span class=n>genes_df</span><span class=o>.</span><span class=n>columns</span> <span class=ow>and</span> <span class=s2>&quot;gene_id&quot;</span> <span class=ow>in</span> <span class=n>genes_df</span><span class=o>.</span><span class=n>columns</span><span class=p>:</span>
</span><span id=__span-0-209><a id=__codelineno-0-209 name=__codelineno-0-209></a>                <span class=n>gene_vocab</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-0-210><a id=__codelineno-0-210 name=__codelineno-0-210></a>
</span><span id=__span-0-211><a id=__codelineno-0-211 name=__codelineno-0-211></a>                <span class=c1># Use Polars native iteration</span>
</span><span id=__span-0-212><a id=__codelineno-0-212 name=__codelineno-0-212></a>                <span class=k>for</span> <span class=n>row</span> <span class=ow>in</span> <span class=n>genes_df</span><span class=o>.</span><span class=n>iter_rows</span><span class=p>(</span><span class=n>named</span><span class=o>=</span><span class=kc>True</span><span class=p>):</span>
</span><span id=__span-0-213><a id=__codelineno-0-213 name=__codelineno-0-213></a>                    <span class=n>gene_id</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;gene_id&quot;</span><span class=p>]</span>
</span><span id=__span-0-214><a id=__codelineno-0-214 name=__codelineno-0-214></a>                    <span class=n>gene_integer_id</span> <span class=o>=</span> <span class=n>row</span><span class=p>[</span><span class=s2>&quot;gene_integer_id&quot;</span><span class=p>]</span>
</span><span id=__span-0-215><a id=__codelineno-0-215 name=__codelineno-0-215></a>
</span><span id=__span-0-216><a id=__codelineno-0-216 name=__codelineno-0-216></a>                    <span class=c1># Only include genes within vocab size limit</span>
</span><span id=__span-0-217><a id=__codelineno-0-217 name=__codelineno-0-217></a>                    <span class=k>if</span> <span class=n>gene_integer_id</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span><span class=p>:</span>
</span><span id=__span-0-218><a id=__codelineno-0-218 name=__codelineno-0-218></a>                        <span class=n>gene_vocab</span><span class=p>[</span><span class=n>gene_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>gene_integer_id</span>
</span><span id=__span-0-219><a id=__codelineno-0-219 name=__codelineno-0-219></a>
</span><span id=__span-0-220><a id=__codelineno-0-220 name=__codelineno-0-220></a>                <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span> <span class=o>=</span> <span class=n>gene_vocab</span>
</span><span id=__span-0-221><a id=__codelineno-0-221 name=__codelineno-0-221></a>                <span class=c1># Account for the +4 offset used in tokenization</span>
</span><span id=__span-0-222><a id=__codelineno-0-222 name=__codelineno-0-222></a>                <span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span> <span class=o>+</span> <span class=mi>4</span><span class=p>:</span> <span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span><span id=__span-0-223><a id=__codelineno-0-223 name=__codelineno-0-223></a>
</span><span id=__span-0-224><a id=__codelineno-0-224 name=__codelineno-0-224></a>                <span class=c1># Pre-build vectorized mapping array for fast lookup</span>
</span><span id=__span-0-225><a id=__codelineno-0-225 name=__codelineno-0-225></a>                <span class=n>max_gene_id</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-226><a id=__codelineno-0-226 name=__codelineno-0-226></a>                    <span class=nb>max</span><span class=p>(</span>
</span><span id=__span-0-227><a id=__codelineno-0-227 name=__codelineno-0-227></a>                        <span class=nb>int</span><span class=p>(</span><span class=n>k</span><span class=p>)</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=n>k</span>
</span><span id=__span-0-228><a id=__codelineno-0-228 name=__codelineno-0-228></a>                        <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
</span><span id=__span-0-229><a id=__codelineno-0-229 name=__codelineno-0-229></a>                    <span class=p>)</span>
</span><span id=__span-0-230><a id=__codelineno-0-230 name=__codelineno-0-230></a>                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span>
</span><span id=__span-0-231><a id=__codelineno-0-231 name=__codelineno-0-231></a>                    <span class=k>else</span> <span class=mi>0</span>
</span><span id=__span-0-232><a id=__codelineno-0-232 name=__codelineno-0-232></a>                <span class=p>)</span>
</span><span id=__span-0-233><a id=__codelineno-0-233 name=__codelineno-0-233></a>                <span class=bp>self</span><span class=o>.</span><span class=n>vocab_mapping</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span><span class=n>max_gene_id</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-234><a id=__codelineno-0-234 name=__codelineno-0-234></a>
</span><span id=__span-0-235><a id=__codelineno-0-235 name=__codelineno-0-235></a>                <span class=c1># Fill the mapping array once</span>
</span><span id=__span-0-236><a id=__codelineno-0-236 name=__codelineno-0-236></a>                <span class=k>for</span> <span class=n>gene_id</span><span class=p>,</span> <span class=n>token_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-0-237><a id=__codelineno-0-237 name=__codelineno-0-237></a>                    <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-238><a id=__codelineno-0-238 name=__codelineno-0-238></a>                        <span class=n>gene_id_int</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-239><a id=__codelineno-0-239 name=__codelineno-0-239></a>                            <span class=nb>int</span><span class=p>(</span><span class=n>gene_id</span><span class=p>)</span> <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>gene_id</span><span class=p>,</span> <span class=nb>str</span><span class=p>)</span> <span class=k>else</span> <span class=n>gene_id</span>
</span><span id=__span-0-240><a id=__codelineno-0-240 name=__codelineno-0-240></a>                        <span class=p>)</span>
</span><span id=__span-0-241><a id=__codelineno-0-241 name=__codelineno-0-241></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>vocab_mapping</span><span class=p>[</span><span class=n>gene_id_int</span><span class=p>]</span> <span class=o>=</span> <span class=n>token_id</span>
</span><span id=__span-0-242><a id=__codelineno-0-242 name=__codelineno-0-242></a>                    <span class=k>except</span> <span class=p>(</span><span class=ne>ValueError</span><span class=p>,</span> <span class=ne>TypeError</span><span class=p>):</span>
</span><span id=__span-0-243><a id=__codelineno-0-243 name=__codelineno-0-243></a>                        <span class=k>continue</span>
</span><span id=__span-0-244><a id=__codelineno-0-244 name=__codelineno-0-244></a>                <span class=k>return</span>
</span><span id=__span-0-245><a id=__codelineno-0-245 name=__codelineno-0-245></a>
</span><span id=__span-0-246><a id=__codelineno-0-246 name=__codelineno-0-246></a>            <span class=c1># Fallback: Mock object or missing columns</span>
</span><span id=__span-0-247><a id=__codelineno-0-247 name=__codelineno-0-247></a>            <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span> <span class=o>=</span> <span class=p>{</span><span class=sa>f</span><span class=s2>&quot;gene_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>:</span> <span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>)}</span>
</span><span id=__span-0-248><a id=__codelineno-0-248 name=__codelineno-0-248></a>            <span class=c1># Account for the +4 offset used in tokenization</span>
</span><span id=__span-0-249><a id=__codelineno-0-249 name=__codelineno-0-249></a>            <span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span> <span class=o>+</span> <span class=mi>4</span><span class=p>:</span> <span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span><span id=__span-0-250><a id=__codelineno-0-250 name=__codelineno-0-250></a>            <span class=c1># No mapping array needed for mock objects</span>
</span><span id=__span-0-251><a id=__codelineno-0-251 name=__codelineno-0-251></a>
</span><span id=__span-0-252><a id=__codelineno-0-252 name=__codelineno-0-252></a>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span><span id=__span-0-253><a id=__codelineno-0-253 name=__codelineno-0-253></a>            <span class=c1># Fallback for testing or error cases</span>
</span><span id=__span-0-254><a id=__codelineno-0-254 name=__codelineno-0-254></a>            <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span> <span class=o>=</span> <span class=p>{</span><span class=sa>f</span><span class=s2>&quot;gene_</span><span class=si>{</span><span class=n>i</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>:</span> <span class=n>i</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>)}</span>
</span><span id=__span-0-255><a id=__codelineno-0-255 name=__codelineno-0-255></a>            <span class=c1># Account for the +4 offset used in tokenization</span>
</span><span id=__span-0-256><a id=__codelineno-0-256 name=__codelineno-0-256></a>            <span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span> <span class=o>=</span> <span class=p>{</span><span class=n>v</span> <span class=o>+</span> <span class=mi>4</span><span class=p>:</span> <span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>
</span><span id=__span-0-257><a id=__codelineno-0-257 name=__codelineno-0-257></a>            <span class=c1># No mapping array needed for fallback</span>
</span><span id=__span-0-258><a id=__codelineno-0-258 name=__codelineno-0-258></a>
</span><span id=__span-0-259><a id=__codelineno-0-259 name=__codelineno-0-259></a>    <span class=k>def</span><span class=w> </span><span class=nf>_setup_special_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-260><a id=__codelineno-0-260 name=__codelineno-0-260></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Setup special tokens for tokenization.&quot;&quot;&quot;</span>
</span><span id=__span-0-261><a id=__codelineno-0-261 name=__codelineno-0-261></a>        <span class=c1># Special token IDs</span>
</span><span id=__span-0-262><a id=__codelineno-0-262 name=__codelineno-0-262></a>        <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-0-263><a id=__codelineno-0-263 name=__codelineno-0-263></a>            <span class=s2>&quot;PAD&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-0-264><a id=__codelineno-0-264 name=__codelineno-0-264></a>            <span class=s2>&quot;CLS&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-265><a id=__codelineno-0-265 name=__codelineno-0-265></a>            <span class=s2>&quot;SEP&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span>
</span><span id=__span-0-266><a id=__codelineno-0-266 name=__codelineno-0-266></a>            <span class=s2>&quot;MASK&quot;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span>
</span><span id=__span-0-267><a id=__codelineno-0-267 name=__codelineno-0-267></a>        <span class=p>}</span>
</span><span id=__span-0-268><a id=__codelineno-0-268 name=__codelineno-0-268></a>
</span><span id=__span-0-269><a id=__codelineno-0-269 name=__codelineno-0-269></a>        <span class=c1># Expression binning setup for scGPT</span>
</span><span id=__span-0-270><a id=__codelineno-0-270 name=__codelineno-0-270></a>        <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span>
</span><span id=__span-0-271><a id=__codelineno-0-271 name=__codelineno-0-271></a>        <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_size</span> <span class=o>=</span> <span class=mf>1.0</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span>
</span><span id=__span-0-272><a id=__codelineno-0-272 name=__codelineno-0-272></a>
</span><span id=__span-0-273><a id=__codelineno-0-273 name=__codelineno-0-273></a>    <span class=k>def</span><span class=w> </span><span class=nf>_expression_to_bin</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>expression_value</span><span class=p>:</span> <span class=nb>float</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span><span id=__span-0-274><a id=__codelineno-0-274 name=__codelineno-0-274></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Convert expression value to bin token ID&quot;&quot;&quot;</span>
</span><span id=__span-0-275><a id=__codelineno-0-275 name=__codelineno-0-275></a>        <span class=k>if</span> <span class=n>expression_value</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-276><a id=__codelineno-0-276 name=__codelineno-0-276></a>            <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>]</span>
</span><span id=__span-0-277><a id=__codelineno-0-277 name=__codelineno-0-277></a>
</span><span id=__span-0-278><a id=__codelineno-0-278 name=__codelineno-0-278></a>        <span class=c1># Bin the expression value</span>
</span><span id=__span-0-279><a id=__codelineno-0-279 name=__codelineno-0-279></a>        <span class=n>bin_id</span> <span class=o>=</span> <span class=nb>min</span><span class=p>(</span>
</span><span id=__span-0-280><a id=__codelineno-0-280 name=__codelineno-0-280></a>            <span class=nb>int</span><span class=p>(</span><span class=n>expression_value</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_size</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span> <span class=o>-</span> <span class=mi>1</span>
</span><span id=__span-0-281><a id=__codelineno-0-281 name=__codelineno-0-281></a>        <span class=p>)</span>
</span><span id=__span-0-282><a id=__codelineno-0-282 name=__codelineno-0-282></a>        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span> <span class=o>+</span> <span class=n>bin_id</span>
</span><span id=__span-0-283><a id=__codelineno-0-283 name=__codelineno-0-283></a>
</span><span id=__span-0-284><a id=__codelineno-0-284 name=__codelineno-0-284></a>    <span class=k>def</span><span class=w> </span><span class=nf>_expression_to_bin_vectorized</span><span class=p>(</span>
</span><span id=__span-0-285><a id=__codelineno-0-285 name=__codelineno-0-285></a>        <span class=bp>self</span><span class=p>,</span> <span class=n>expression_values</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span>
</span><span id=__span-0-286><a id=__codelineno-0-286 name=__codelineno-0-286></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-0-287><a id=__codelineno-0-287 name=__codelineno-0-287></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Vectorized version of expression binning&quot;&quot;&quot;</span>
</span><span id=__span-0-288><a id=__codelineno-0-288 name=__codelineno-0-288></a>        <span class=c1># Handle edge cases</span>
</span><span id=__span-0-289><a id=__codelineno-0-289 name=__codelineno-0-289></a>        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>expression_values</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-290><a id=__codelineno-0-290 name=__codelineno-0-290></a>            <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([],</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-291><a id=__codelineno-0-291 name=__codelineno-0-291></a>
</span><span id=__span-0-292><a id=__codelineno-0-292 name=__codelineno-0-292></a>        <span class=c1># Create bins</span>
</span><span id=__span-0-293><a id=__codelineno-0-293 name=__codelineno-0-293></a>        <span class=n>bins</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>clip</span><span class=p>(</span>
</span><span id=__span-0-294><a id=__codelineno-0-294 name=__codelineno-0-294></a>            <span class=p>(</span><span class=n>expression_values</span> <span class=o>/</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_size</span><span class=p>)</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>),</span>
</span><span id=__span-0-295><a id=__codelineno-0-295 name=__codelineno-0-295></a>            <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-0-296><a id=__codelineno-0-296 name=__codelineno-0-296></a>            <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span> <span class=o>-</span> <span class=mi>1</span><span class=p>,</span>
</span><span id=__span-0-297><a id=__codelineno-0-297 name=__codelineno-0-297></a>        <span class=p>)</span>
</span><span id=__span-0-298><a id=__codelineno-0-298 name=__codelineno-0-298></a>
</span><span id=__span-0-299><a id=__codelineno-0-299 name=__codelineno-0-299></a>        <span class=c1># Convert to token IDs</span>
</span><span id=__span-0-300><a id=__codelineno-0-300 name=__codelineno-0-300></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
</span><span id=__span-0-301><a id=__codelineno-0-301 name=__codelineno-0-301></a>            <span class=n>expression_values</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-0-302><a id=__codelineno-0-302 name=__codelineno-0-302></a>            <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span> <span class=o>+</span> <span class=n>bins</span><span class=p>,</span>
</span><span id=__span-0-303><a id=__codelineno-0-303 name=__codelineno-0-303></a>            <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span>
</span><span id=__span-0-304><a id=__codelineno-0-304 name=__codelineno-0-304></a>        <span class=p>)</span>
</span><span id=__span-0-305><a id=__codelineno-0-305 name=__codelineno-0-305></a>
</span><span id=__span-0-306><a id=__codelineno-0-306 name=__codelineno-0-306></a>        <span class=k>return</span> <span class=n>result</span><span class=o>.</span><span class=n>astype</span><span class=p>(</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-307><a id=__codelineno-0-307 name=__codelineno-0-307></a>
</span><span id=__span-0-308><a id=__codelineno-0-308 name=__codelineno-0-308></a>    <span class=k>def</span><span class=w> </span><span class=nf>_map_gene_ids_to_tokens_vectorized</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>gene_ids</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-0-309><a id=__codelineno-0-309 name=__codelineno-0-309></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Vectorized mapping of gene IDs to token IDs&quot;&quot;&quot;</span>
</span><span id=__span-0-310><a id=__codelineno-0-310 name=__codelineno-0-310></a>        <span class=c1># Handle edge cases</span>
</span><span id=__span-0-311><a id=__codelineno-0-311 name=__codelineno-0-311></a>        <span class=k>if</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>gene_ids</span><span class=p>,</span> <span class=s2>&quot;is_empty&quot;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>gene_ids</span><span class=o>.</span><span class=n>is_empty</span><span class=p>():</span>
</span><span id=__span-0-312><a id=__codelineno-0-312 name=__codelineno-0-312></a>            <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([],</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-313><a id=__codelineno-0-313 name=__codelineno-0-313></a>        <span class=k>elif</span> <span class=nb>hasattr</span><span class=p>(</span><span class=n>gene_ids</span><span class=p>,</span> <span class=s2>&quot;__len__&quot;</span><span class=p>)</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_ids</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-314><a id=__codelineno-0-314 name=__codelineno-0-314></a>            <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([],</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-315><a id=__codelineno-0-315 name=__codelineno-0-315></a>
</span><span id=__span-0-316><a id=__codelineno-0-316 name=__codelineno-0-316></a>        <span class=c1># Convert to numpy array for vectorized operations</span>
</span><span id=__span-0-317><a id=__codelineno-0-317 name=__codelineno-0-317></a>        <span class=n>gene_ids_array</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>gene_ids</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=nb>int</span><span class=p>)</span>
</span><span id=__span-0-318><a id=__codelineno-0-318 name=__codelineno-0-318></a>
</span><span id=__span-0-319><a id=__codelineno-0-319 name=__codelineno-0-319></a>        <span class=c1># Check if we have a real SLAF array or a Mock object</span>
</span><span id=__span-0-320><a id=__codelineno-0-320 name=__codelineno-0-320></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-321><a id=__codelineno-0-321 name=__codelineno-0-321></a>            <span class=c1># Try to access the DataFrame properly</span>
</span><span id=__span-0-322><a id=__codelineno-0-322 name=__codelineno-0-322></a>            <span class=n>var_df</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span><span class=o>.</span><span class=n>var</span><span class=o>.</span><span class=n>reset_index</span><span class=p>()</span>
</span><span id=__span-0-323><a id=__codelineno-0-323 name=__codelineno-0-323></a>
</span><span id=__span-0-324><a id=__codelineno-0-324 name=__codelineno-0-324></a>            <span class=c1># Check if it&#39;s actually a DataFrame with the expected columns</span>
</span><span id=__span-0-325><a id=__codelineno-0-325 name=__codelineno-0-325></a>            <span class=k>if</span> <span class=p>(</span>
</span><span id=__span-0-326><a id=__codelineno-0-326 name=__codelineno-0-326></a>                <span class=nb>hasattr</span><span class=p>(</span><span class=n>var_df</span><span class=p>,</span> <span class=s2>&quot;columns&quot;</span><span class=p>)</span>
</span><span id=__span-0-327><a id=__codelineno-0-327 name=__codelineno-0-327></a>                <span class=ow>and</span> <span class=s2>&quot;gene_integer_id&quot;</span> <span class=ow>in</span> <span class=n>var_df</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-0-328><a id=__codelineno-0-328 name=__codelineno-0-328></a>                <span class=ow>and</span> <span class=s2>&quot;gene_id&quot;</span> <span class=ow>in</span> <span class=n>var_df</span><span class=o>.</span><span class=n>columns</span>
</span><span id=__span-0-329><a id=__codelineno-0-329 name=__codelineno-0-329></a>            <span class=p>):</span>
</span><span id=__span-0-330><a id=__codelineno-0-330 name=__codelineno-0-330></a>                <span class=c1># Real SLAF array - use pre-built vectorized mapping</span>
</span><span id=__span-0-331><a id=__codelineno-0-331 name=__codelineno-0-331></a>                <span class=c1># Vectorized lookup using pre-built mapping array</span>
</span><span id=__span-0-332><a id=__codelineno-0-332 name=__codelineno-0-332></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_mapping</span><span class=p>[</span><span class=n>gene_ids_array</span><span class=p>]</span>
</span><span id=__span-0-333><a id=__codelineno-0-333 name=__codelineno-0-333></a>
</span><span id=__span-0-334><a id=__codelineno-0-334 name=__codelineno-0-334></a>                <span class=c1># Filter out missing genes (-1 values)</span>
</span><span id=__span-0-335><a id=__codelineno-0-335 name=__codelineno-0-335></a>                <span class=n>valid_mask</span> <span class=o>=</span> <span class=n>tokens</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span>
</span><span id=__span-0-336><a id=__codelineno-0-336 name=__codelineno-0-336></a>                <span class=k>return</span> <span class=n>tokens</span><span class=p>[</span><span class=n>valid_mask</span><span class=p>]</span>
</span><span id=__span-0-337><a id=__codelineno-0-337 name=__codelineno-0-337></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-338><a id=__codelineno-0-338 name=__codelineno-0-338></a>                <span class=c1># Mock object - direct mapping (same as original test)</span>
</span><span id=__span-0-339><a id=__codelineno-0-339 name=__codelineno-0-339></a>                <span class=k>return</span> <span class=n>gene_ids_array</span> <span class=o>+</span> <span class=mi>4</span>  <span class=c1># Simple offset like original test</span>
</span><span id=__span-0-340><a id=__codelineno-0-340 name=__codelineno-0-340></a>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span><span id=__span-0-341><a id=__codelineno-0-341 name=__codelineno-0-341></a>            <span class=c1># Fallback for testing - direct mapping with offset</span>
</span><span id=__span-0-342><a id=__codelineno-0-342 name=__codelineno-0-342></a>            <span class=k>return</span> <span class=n>gene_ids_array</span> <span class=o>+</span> <span class=mi>4</span>  <span class=c1># Simple offset like original test</span>
</span><span id=__span-0-343><a id=__codelineno-0-343 name=__codelineno-0-343></a>
</span><span id=__span-0-344><a id=__codelineno-0-344 name=__codelineno-0-344></a>    <span class=k>def</span><span class=w> </span><span class=nf>tokenize</span><span class=p>(</span>
</span><span id=__span-0-345><a id=__codelineno-0-345 name=__codelineno-0-345></a>        <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-346><a id=__codelineno-0-346 name=__codelineno-0-346></a>        <span class=n>gene_sequences</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>|</span> <span class=nb>list</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]],</span>
</span><span id=__span-0-347><a id=__codelineno-0-347 name=__codelineno-0-347></a>        <span class=n>expr_sequences</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-0-348><a id=__codelineno-0-348 name=__codelineno-0-348></a>        <span class=n>max_genes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-0-349><a id=__codelineno-0-349 name=__codelineno-0-349></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>]:</span>
</span><span id=__span-0-350><a id=__codelineno-0-350 name=__codelineno-0-350></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-351><a id=__codelineno-0-351 name=__codelineno-0-351></a><span class=sd>        Tokenize gene expression sequences into model-ready tensors.</span>
</span><span id=__span-0-352><a id=__codelineno-0-352 name=__codelineno-0-352></a>
</span><span id=__span-0-353><a id=__codelineno-0-353 name=__codelineno-0-353></a><span class=sd>        This method converts gene and expression sequences into tokenized tensors</span>
</span><span id=__span-0-354><a id=__codelineno-0-354 name=__codelineno-0-354></a><span class=sd>        suitable for machine learning models. It supports both GeneFormer and scGPT</span>
</span><span id=__span-0-355><a id=__codelineno-0-355 name=__codelineno-0-355></a><span class=sd>        tokenization strategies with optimized vectorized operations.</span>
</span><span id=__span-0-356><a id=__codelineno-0-356 name=__codelineno-0-356></a>
</span><span id=__span-0-357><a id=__codelineno-0-357 name=__codelineno-0-357></a><span class=sd>        Args:</span>
</span><span id=__span-0-358><a id=__codelineno-0-358 name=__codelineno-0-358></a><span class=sd>            gene_sequences: List of gene ID sequences for each cell</span>
</span><span id=__span-0-359><a id=__codelineno-0-359 name=__codelineno-0-359></a><span class=sd>            expr_sequences: List of expression value sequences for each cell (required for scGPT)</span>
</span><span id=__span-0-360><a id=__codelineno-0-360 name=__codelineno-0-360></a><span class=sd>            max_genes: Maximum number of genes per cell (defaults based on tokenizer type)</span>
</span><span id=__span-0-361><a id=__codelineno-0-361 name=__codelineno-0-361></a>
</span><span id=__span-0-362><a id=__codelineno-0-362 name=__codelineno-0-362></a><span class=sd>        Returns:</span>
</span><span id=__span-0-363><a id=__codelineno-0-363 name=__codelineno-0-363></a><span class=sd>            tuple: (input_ids, attention_mask) tensors</span>
</span><span id=__span-0-364><a id=__codelineno-0-364 name=__codelineno-0-364></a><span class=sd>                - input_ids: Tokenized sequences with padding</span>
</span><span id=__span-0-365><a id=__codelineno-0-365 name=__codelineno-0-365></a><span class=sd>                - attention_mask: Boolean mask indicating valid tokens</span>
</span><span id=__span-0-366><a id=__codelineno-0-366 name=__codelineno-0-366></a>
</span><span id=__span-0-367><a id=__codelineno-0-367 name=__codelineno-0-367></a><span class=sd>        Raises:</span>
</span><span id=__span-0-368><a id=__codelineno-0-368 name=__codelineno-0-368></a><span class=sd>            ValueError: If gene_sequences is empty</span>
</span><span id=__span-0-369><a id=__codelineno-0-369 name=__codelineno-0-369></a>
</span><span id=__span-0-370><a id=__codelineno-0-370 name=__codelineno-0-370></a><span class=sd>        Examples:</span>
</span><span id=__span-0-371><a id=__codelineno-0-371 name=__codelineno-0-371></a><span class=sd>            &gt;&gt;&gt; # GeneFormer tokenization</span>
</span><span id=__span-0-372><a id=__codelineno-0-372 name=__codelineno-0-372></a><span class=sd>            &gt;&gt;&gt; gene_sequences = [[1, 2, 3], [4, 5, 6]]</span>
</span><span id=__span-0-373><a id=__codelineno-0-373 name=__codelineno-0-373></a><span class=sd>            &gt;&gt;&gt; input_ids, attention_mask = tokenizer.tokenize(gene_sequences)</span>
</span><span id=__span-0-374><a id=__codelineno-0-374 name=__codelineno-0-374></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Shape: {input_ids.shape}&quot;)</span>
</span><span id=__span-0-375><a id=__codelineno-0-375 name=__codelineno-0-375></a><span class=sd>            Shape: torch.Size([2, 2048])</span>
</span><span id=__span-0-376><a id=__codelineno-0-376 name=__codelineno-0-376></a>
</span><span id=__span-0-377><a id=__codelineno-0-377 name=__codelineno-0-377></a><span class=sd>            &gt;&gt;&gt; # scGPT tokenization</span>
</span><span id=__span-0-378><a id=__codelineno-0-378 name=__codelineno-0-378></a><span class=sd>            &gt;&gt;&gt; gene_sequences = [[1, 2, 3], [4, 5, 6]]</span>
</span><span id=__span-0-379><a id=__codelineno-0-379 name=__codelineno-0-379></a><span class=sd>            &gt;&gt;&gt; expr_sequences = [[0.5, 0.8, 0.2], [0.9, 0.1, 0.7]]</span>
</span><span id=__span-0-380><a id=__codelineno-0-380 name=__codelineno-0-380></a><span class=sd>            &gt;&gt;&gt; input_ids, attention_mask = tokenizer.tokenize(gene_sequences, expr_sequences)</span>
</span><span id=__span-0-381><a id=__codelineno-0-381 name=__codelineno-0-381></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Shape: {input_ids.shape}&quot;)</span>
</span><span id=__span-0-382><a id=__codelineno-0-382 name=__codelineno-0-382></a><span class=sd>            Shape: torch.Size([2, 2050])</span>
</span><span id=__span-0-383><a id=__codelineno-0-383 name=__codelineno-0-383></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-384><a id=__codelineno-0-384 name=__codelineno-0-384></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>gene_sequences</span><span class=p>:</span>
</span><span id=__span-0-385><a id=__codelineno-0-385 name=__codelineno-0-385></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Gene sequences cannot be empty&quot;</span><span class=p>)</span>
</span><span id=__span-0-386><a id=__codelineno-0-386 name=__codelineno-0-386></a>
</span><span id=__span-0-387><a id=__codelineno-0-387 name=__codelineno-0-387></a>        <span class=c1># Set default max_genes based on tokenizer type</span>
</span><span id=__span-0-388><a id=__codelineno-0-388 name=__codelineno-0-388></a>        <span class=k>if</span> <span class=n>max_genes</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-389><a id=__codelineno-0-389 name=__codelineno-0-389></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>:</span>
</span><span id=__span-0-390><a id=__codelineno-0-390 name=__codelineno-0-390></a>                <span class=n>max_genes</span> <span class=o>=</span> <span class=mi>2048</span>
</span><span id=__span-0-391><a id=__codelineno-0-391 name=__codelineno-0-391></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-392><a id=__codelineno-0-392 name=__codelineno-0-392></a>                <span class=c1># For scGPT: CLS + (gene,expr)*n + SEP = 2*n + 2</span>
</span><span id=__span-0-393><a id=__codelineno-0-393 name=__codelineno-0-393></a>                <span class=c1># So if we want max_genes total tokens, n = (max_genes - 2) / 2</span>
</span><span id=__span-0-394><a id=__codelineno-0-394 name=__codelineno-0-394></a>                <span class=n>max_genes</span> <span class=o>=</span> <span class=mi>1024</span>  <span class=c1># This is the number of gene-expression pairs</span>
</span><span id=__span-0-395><a id=__codelineno-0-395 name=__codelineno-0-395></a>
</span><span id=__span-0-396><a id=__codelineno-0-396 name=__codelineno-0-396></a>        <span class=c1># Always define max_sequence_length based on tokenizer type</span>
</span><span id=__span-0-397><a id=__codelineno-0-397 name=__codelineno-0-397></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>:</span>
</span><span id=__span-0-398><a id=__codelineno-0-398 name=__codelineno-0-398></a>            <span class=n>max_sequence_length</span> <span class=o>=</span> <span class=n>max_genes</span>  <span class=c1># For Geneformer, same as max_genes</span>
</span><span id=__span-0-399><a id=__codelineno-0-399 name=__codelineno-0-399></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-400><a id=__codelineno-0-400 name=__codelineno-0-400></a>            <span class=c1># For scGPT: CLS + (gene,expr)*n + SEP = 2*n + 2</span>
</span><span id=__span-0-401><a id=__codelineno-0-401 name=__codelineno-0-401></a>            <span class=n>max_sequence_length</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>max_genes</span> <span class=o>+</span> <span class=mi>2</span>  <span class=c1># Total sequence length</span>
</span><span id=__span-0-402><a id=__codelineno-0-402 name=__codelineno-0-402></a>
</span><span id=__span-0-403><a id=__codelineno-0-403 name=__codelineno-0-403></a>        <span class=c1># For scGPT, gene_sequences now contains struct pairs [(gene, expr), ...]</span>
</span><span id=__span-0-404><a id=__codelineno-0-404 name=__codelineno-0-404></a>        <span class=c1># so we don&#39;t need separate expr_sequences validation</span>
</span><span id=__span-0-405><a id=__codelineno-0-405 name=__codelineno-0-405></a>
</span><span id=__span-0-406><a id=__codelineno-0-406 name=__codelineno-0-406></a>        <span class=n>batch_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>)</span>
</span><span id=__span-0-407><a id=__codelineno-0-407 name=__codelineno-0-407></a>
</span><span id=__span-0-408><a id=__codelineno-0-408 name=__codelineno-0-408></a>        <span class=c1># Use fast numpy-based approach (same as original test)</span>
</span><span id=__span-0-409><a id=__codelineno-0-409 name=__codelineno-0-409></a>        <span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-0-410><a id=__codelineno-0-410 name=__codelineno-0-410></a>
</span><span id=__span-0-411><a id=__codelineno-0-411 name=__codelineno-0-411></a>        <span class=c1># Pre-allocate numpy array with correct dimensions</span>
</span><span id=__span-0-412><a id=__codelineno-0-412 name=__codelineno-0-412></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span><span class=p>:</span>
</span><span id=__span-0-413><a id=__codelineno-0-413 name=__codelineno-0-413></a>            <span class=c1># For scGPT: use max_sequence_length (2*max_genes+2)</span>
</span><span id=__span-0-414><a id=__codelineno-0-414 name=__codelineno-0-414></a>            <span class=n>array_width</span> <span class=o>=</span> <span class=n>max_sequence_length</span>
</span><span id=__span-0-415><a id=__codelineno-0-415 name=__codelineno-0-415></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-416><a id=__codelineno-0-416 name=__codelineno-0-416></a>            <span class=c1># For Geneformer: use max_genes</span>
</span><span id=__span-0-417><a id=__codelineno-0-417 name=__codelineno-0-417></a>            <span class=n>array_width</span> <span class=o>=</span> <span class=n>max_genes</span>
</span><span id=__span-0-418><a id=__codelineno-0-418 name=__codelineno-0-418></a>
</span><span id=__span-0-419><a id=__codelineno-0-419 name=__codelineno-0-419></a>        <span class=n>token_array</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-420><a id=__codelineno-0-420 name=__codelineno-0-420></a>            <span class=p>(</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>array_width</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span>
</span><span id=__span-0-421><a id=__codelineno-0-421 name=__codelineno-0-421></a>        <span class=p>)</span>
</span><span id=__span-0-422><a id=__codelineno-0-422 name=__codelineno-0-422></a>
</span><span id=__span-0-423><a id=__codelineno-0-423 name=__codelineno-0-423></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span><span class=p>:</span>
</span><span id=__span-0-424><a id=__codelineno-0-424 name=__codelineno-0-424></a>            <span class=c1># scGPT format: [CLS] gene1 expr1 gene2 expr2 ... [SEP]</span>
</span><span id=__span-0-425><a id=__codelineno-0-425 name=__codelineno-0-425></a>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>gene_sequence</span><span class=p>,</span> <span class=n>expr_sequence</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span>
</span><span id=__span-0-426><a id=__codelineno-0-426 name=__codelineno-0-426></a>                <span class=nb>zip</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>,</span> <span class=n>expr_sequences</span> <span class=ow>or</span> <span class=p>[],</span> <span class=n>strict</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-0-427><a id=__codelineno-0-427 name=__codelineno-0-427></a>            <span class=p>):</span>
</span><span id=__span-0-428><a id=__codelineno-0-428 name=__codelineno-0-428></a>                <span class=c1># For scGPT, we now use separate gene_sequence and expr_sequence columns</span>
</span><span id=__span-0-429><a id=__codelineno-0-429 name=__codelineno-0-429></a>                <span class=k>if</span> <span class=n>gene_sequence</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_sequence</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-430><a id=__codelineno-0-430 name=__codelineno-0-430></a>                    <span class=c1># Fast path: separate gene_sequence and expr_sequence columns</span>
</span><span id=__span-0-431><a id=__codelineno-0-431 name=__codelineno-0-431></a>                    <span class=n>genes</span> <span class=o>=</span> <span class=n>gene_sequence</span>
</span><span id=__span-0-432><a id=__codelineno-0-432 name=__codelineno-0-432></a>                    <span class=n>exprs</span> <span class=o>=</span> <span class=n>expr_sequence</span> <span class=k>if</span> <span class=n>expr_sequence</span> <span class=k>else</span> <span class=p>[]</span>
</span><span id=__span-0-433><a id=__codelineno-0-433 name=__codelineno-0-433></a>
</span><span id=__span-0-434><a id=__codelineno-0-434 name=__codelineno-0-434></a>                    <span class=c1># Vectorized operations - use simple +4 for performance</span>
</span><span id=__span-0-435><a id=__codelineno-0-435 name=__codelineno-0-435></a>                    <span class=n>gene_tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>genes</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span>
</span><span id=__span-0-436><a id=__codelineno-0-436 name=__codelineno-0-436></a>
</span><span id=__span-0-437><a id=__codelineno-0-437 name=__codelineno-0-437></a>                    <span class=c1># Handle expression tokens - don&#39;t bin if already binned by window function</span>
</span><span id=__span-0-438><a id=__codelineno-0-438 name=__codelineno-0-438></a>                    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>exprs</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exprs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nb>int</span> <span class=o>|</span> <span class=n>np</span><span class=o>.</span><span class=n>integer</span><span class=p>):</span>
</span><span id=__span-0-439><a id=__codelineno-0-439 name=__codelineno-0-439></a>                        <span class=c1># Already binned by window function - just convert to tokens</span>
</span><span id=__span-0-440><a id=__codelineno-0-440 name=__codelineno-0-440></a>                        <span class=n>expr_tokens</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-441><a id=__codelineno-0-441 name=__codelineno-0-441></a>                            <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>exprs</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span>
</span><span id=__span-0-442><a id=__codelineno-0-442 name=__codelineno-0-442></a>                        <span class=p>)</span>
</span><span id=__span-0-443><a id=__codelineno-0-443 name=__codelineno-0-443></a>                    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-444><a id=__codelineno-0-444 name=__codelineno-0-444></a>                        <span class=c1># Raw values - need to bin them</span>
</span><span id=__span-0-445><a id=__codelineno-0-445 name=__codelineno-0-445></a>                        <span class=n>expr_tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_expression_to_bin_vectorized</span><span class=p>(</span>
</span><span id=__span-0-446><a id=__codelineno-0-446 name=__codelineno-0-446></a>                            <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>exprs</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span><span id=__span-0-447><a id=__codelineno-0-447 name=__codelineno-0-447></a>                        <span class=p>)</span>
</span><span id=__span-0-448><a id=__codelineno-0-448 name=__codelineno-0-448></a>
</span><span id=__span-0-449><a id=__codelineno-0-449 name=__codelineno-0-449></a>                    <span class=c1># Vectorized interleaving (much faster than Python loop)</span>
</span><span id=__span-0-450><a id=__codelineno-0-450 name=__codelineno-0-450></a>                    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-451><a id=__codelineno-0-451 name=__codelineno-0-451></a>                        <span class=c1># Pre-allocate full sequence: CLS + (gene,expr)*n + SEP</span>
</span><span id=__span-0-452><a id=__codelineno-0-452 name=__codelineno-0-452></a>                        <span class=n>sequence_length</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span><span id=__span-0-453><a id=__codelineno-0-453 name=__codelineno-0-453></a>                        <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-454><a id=__codelineno-0-454 name=__codelineno-0-454></a>                            <span class=n>sequence_length</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span>
</span><span id=__span-0-455><a id=__codelineno-0-455 name=__codelineno-0-455></a>                        <span class=p>)</span>
</span><span id=__span-0-456><a id=__codelineno-0-456 name=__codelineno-0-456></a>
</span><span id=__span-0-457><a id=__codelineno-0-457 name=__codelineno-0-457></a>                        <span class=c1># Set CLS token</span>
</span><span id=__span-0-458><a id=__codelineno-0-458 name=__codelineno-0-458></a>                        <span class=n>tokens</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>]</span>
</span><span id=__span-0-459><a id=__codelineno-0-459 name=__codelineno-0-459></a>
</span><span id=__span-0-460><a id=__codelineno-0-460 name=__codelineno-0-460></a>                        <span class=c1># Vectorized interleaving</span>
</span><span id=__span-0-461><a id=__codelineno-0-461 name=__codelineno-0-461></a>                        <span class=n>tokens</span><span class=p>[</span><span class=mi>1</span><span class=p>::</span><span class=mi>2</span><span class=p>][:</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)]</span> <span class=o>=</span> <span class=n>gene_tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-462><a id=__codelineno-0-462 name=__codelineno-0-462></a>                        <span class=n>tokens</span><span class=p>[</span><span class=mi>2</span><span class=p>::</span><span class=mi>2</span><span class=p>][:</span> <span class=nb>len</span><span class=p>(</span><span class=n>expr_tokens</span><span class=p>)]</span> <span class=o>=</span> <span class=n>expr_tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-463><a id=__codelineno-0-463 name=__codelineno-0-463></a>
</span><span id=__span-0-464><a id=__codelineno-0-464 name=__codelineno-0-464></a>                        <span class=n>tokens</span><span class=p>[</span><span class=mi>1</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]</span>
</span><span id=__span-0-465><a id=__codelineno-0-465 name=__codelineno-0-465></a>                    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-466><a id=__codelineno-0-466 name=__codelineno-0-466></a>                        <span class=c1># Empty sequence case</span>
</span><span id=__span-0-467><a id=__codelineno-0-467 name=__codelineno-0-467></a>                        <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span>
</span><span id=__span-0-468><a id=__codelineno-0-468 name=__codelineno-0-468></a>                            <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-469><a id=__codelineno-0-469 name=__codelineno-0-469></a>                            <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-470><a id=__codelineno-0-470 name=__codelineno-0-470></a>                        <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-471><a id=__codelineno-0-471 name=__codelineno-0-471></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-472><a id=__codelineno-0-472 name=__codelineno-0-472></a>                    <span class=c1># Empty sequence case</span>
</span><span id=__span-0-473><a id=__codelineno-0-473 name=__codelineno-0-473></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span>
</span><span id=__span-0-474><a id=__codelineno-0-474 name=__codelineno-0-474></a>                        <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-475><a id=__codelineno-0-475 name=__codelineno-0-475></a>                        <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-476><a id=__codelineno-0-476 name=__codelineno-0-476></a>                    <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-477><a id=__codelineno-0-477 name=__codelineno-0-477></a>
</span><span id=__span-0-478><a id=__codelineno-0-478 name=__codelineno-0-478></a>                <span class=c1># Pad/truncate to correct sequence length</span>
</span><span id=__span-0-479><a id=__codelineno-0-479 name=__codelineno-0-479></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span><span class=p>:</span>
</span><span id=__span-0-480><a id=__codelineno-0-480 name=__codelineno-0-480></a>                    <span class=c1># For scGPT: use max_sequence_length (2*max_genes+2)</span>
</span><span id=__span-0-481><a id=__codelineno-0-481 name=__codelineno-0-481></a>                    <span class=n>target_length</span> <span class=o>=</span> <span class=n>max_sequence_length</span>
</span><span id=__span-0-482><a id=__codelineno-0-482 name=__codelineno-0-482></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-483><a id=__codelineno-0-483 name=__codelineno-0-483></a>                    <span class=c1># For Geneformer: use max_genes</span>
</span><span id=__span-0-484><a id=__codelineno-0-484 name=__codelineno-0-484></a>                    <span class=n>target_length</span> <span class=o>=</span> <span class=n>max_genes</span>
</span><span id=__span-0-485><a id=__codelineno-0-485 name=__codelineno-0-485></a>
</span><span id=__span-0-486><a id=__codelineno-0-486 name=__codelineno-0-486></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[:</span><span class=n>target_length</span><span class=p>]</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-487><a id=__codelineno-0-487 name=__codelineno-0-487></a>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>target_length</span><span class=p>:</span>
</span><span id=__span-0-488><a id=__codelineno-0-488 name=__codelineno-0-488></a>                    <span class=n>padding</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-489><a id=__codelineno-0-489 name=__codelineno-0-489></a>                        <span class=n>target_length</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>),</span>
</span><span id=__span-0-490><a id=__codelineno-0-490 name=__codelineno-0-490></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span>
</span><span id=__span-0-491><a id=__codelineno-0-491 name=__codelineno-0-491></a>                        <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-492><a id=__codelineno-0-492 name=__codelineno-0-492></a>                    <span class=p>)</span>
</span><span id=__span-0-493><a id=__codelineno-0-493 name=__codelineno-0-493></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>tokens</span><span class=p>,</span> <span class=n>padding</span><span class=p>])</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-494><a id=__codelineno-0-494 name=__codelineno-0-494></a>
</span><span id=__span-0-495><a id=__codelineno-0-495 name=__codelineno-0-495></a>                <span class=c1># Fill array</span>
</span><span id=__span-0-496><a id=__codelineno-0-496 name=__codelineno-0-496></a>                <span class=n>token_array</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=p>:]</span> <span class=o>=</span> <span class=n>tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-497><a id=__codelineno-0-497 name=__codelineno-0-497></a>
</span><span id=__span-0-498><a id=__codelineno-0-498 name=__codelineno-0-498></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-499><a id=__codelineno-0-499 name=__codelineno-0-499></a>            <span class=c1># Geneformer format: [CLS] gene1 gene2 gene3 ... [SEP]</span>
</span><span id=__span-0-500><a id=__codelineno-0-500 name=__codelineno-0-500></a>            <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>gene_sequence</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>):</span>
</span><span id=__span-0-501><a id=__codelineno-0-501 name=__codelineno-0-501></a>                <span class=c1># Convert gene IDs to tokens (fast mapping)</span>
</span><span id=__span-0-502><a id=__codelineno-0-502 name=__codelineno-0-502></a>                <span class=n>gene_tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>gene_sequence</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span>
</span><span id=__span-0-503><a id=__codelineno-0-503 name=__codelineno-0-503></a>
</span><span id=__span-0-504><a id=__codelineno-0-504 name=__codelineno-0-504></a>                <span class=c1># Vectorized sequence building: use concatenation for speed</span>
</span><span id=__span-0-505><a id=__codelineno-0-505 name=__codelineno-0-505></a>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-506><a id=__codelineno-0-506 name=__codelineno-0-506></a>                    <span class=c1># Use concatenation: CLS + genes + SEP</span>
</span><span id=__span-0-507><a id=__codelineno-0-507 name=__codelineno-0-507></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span>
</span><span id=__span-0-508><a id=__codelineno-0-508 name=__codelineno-0-508></a>                        <span class=p>[</span>
</span><span id=__span-0-509><a id=__codelineno-0-509 name=__codelineno-0-509></a>                            <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>]],</span>
</span><span id=__span-0-510><a id=__codelineno-0-510 name=__codelineno-0-510></a>                            <span class=n>gene_tokens</span><span class=p>,</span>
</span><span id=__span-0-511><a id=__codelineno-0-511 name=__codelineno-0-511></a>                            <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-512><a id=__codelineno-0-512 name=__codelineno-0-512></a>                        <span class=p>]</span>
</span><span id=__span-0-513><a id=__codelineno-0-513 name=__codelineno-0-513></a>                    <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-514><a id=__codelineno-0-514 name=__codelineno-0-514></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-515><a id=__codelineno-0-515 name=__codelineno-0-515></a>                    <span class=c1># Empty sequence case</span>
</span><span id=__span-0-516><a id=__codelineno-0-516 name=__codelineno-0-516></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span>
</span><span id=__span-0-517><a id=__codelineno-0-517 name=__codelineno-0-517></a>                        <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-518><a id=__codelineno-0-518 name=__codelineno-0-518></a>                        <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-519><a id=__codelineno-0-519 name=__codelineno-0-519></a>                    <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-520><a id=__codelineno-0-520 name=__codelineno-0-520></a>
</span><span id=__span-0-521><a id=__codelineno-0-521 name=__codelineno-0-521></a>                <span class=c1># Pad/truncate to max_genes</span>
</span><span id=__span-0-522><a id=__codelineno-0-522 name=__codelineno-0-522></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[:</span><span class=n>max_genes</span><span class=p>]</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-523><a id=__codelineno-0-523 name=__codelineno-0-523></a>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>max_genes</span><span class=p>:</span>
</span><span id=__span-0-524><a id=__codelineno-0-524 name=__codelineno-0-524></a>                    <span class=n>padding</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-525><a id=__codelineno-0-525 name=__codelineno-0-525></a>                        <span class=n>max_genes</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>),</span>
</span><span id=__span-0-526><a id=__codelineno-0-526 name=__codelineno-0-526></a>                        <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span>
</span><span id=__span-0-527><a id=__codelineno-0-527 name=__codelineno-0-527></a>                        <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-528><a id=__codelineno-0-528 name=__codelineno-0-528></a>                    <span class=p>)</span>
</span><span id=__span-0-529><a id=__codelineno-0-529 name=__codelineno-0-529></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>tokens</span><span class=p>,</span> <span class=n>padding</span><span class=p>])</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-530><a id=__codelineno-0-530 name=__codelineno-0-530></a>
</span><span id=__span-0-531><a id=__codelineno-0-531 name=__codelineno-0-531></a>                <span class=c1># Fill array</span>
</span><span id=__span-0-532><a id=__codelineno-0-532 name=__codelineno-0-532></a>                <span class=n>token_array</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=p>:]</span> <span class=o>=</span> <span class=n>tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-533><a id=__codelineno-0-533 name=__codelineno-0-533></a>
</span><span id=__span-0-534><a id=__codelineno-0-534 name=__codelineno-0-534></a>        <span class=c1># Convert to tensors in one operation</span>
</span><span id=__span-0-535><a id=__codelineno-0-535 name=__codelineno-0-535></a>        <span class=n>input_ids</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>token_array</span><span class=p>)</span>
</span><span id=__span-0-536><a id=__codelineno-0-536 name=__codelineno-0-536></a>        <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>input_ids</span> <span class=o>!=</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>]</span>
</span><span id=__span-0-537><a id=__codelineno-0-537 name=__codelineno-0-537></a>
</span><span id=__span-0-538><a id=__codelineno-0-538 name=__codelineno-0-538></a>        <span class=k>return</span> <span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span>
</span><span id=__span-0-539><a id=__codelineno-0-539 name=__codelineno-0-539></a>
</span><span id=__span-0-540><a id=__codelineno-0-540 name=__codelineno-0-540></a>    <span class=k>def</span><span class=w> </span><span class=nf>get_vocab_info</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-0-541><a id=__codelineno-0-541 name=__codelineno-0-541></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-542><a id=__codelineno-0-542 name=__codelineno-0-542></a><span class=sd>        Get vocabulary information for debugging and analysis.</span>
</span><span id=__span-0-543><a id=__codelineno-0-543 name=__codelineno-0-543></a>
</span><span id=__span-0-544><a id=__codelineno-0-544 name=__codelineno-0-544></a><span class=sd>        Returns:</span>
</span><span id=__span-0-545><a id=__codelineno-0-545 name=__codelineno-0-545></a><span class=sd>            dict: Vocabulary information including size, special tokens, etc.</span>
</span><span id=__span-0-546><a id=__codelineno-0-546 name=__codelineno-0-546></a>
</span><span id=__span-0-547><a id=__codelineno-0-547 name=__codelineno-0-547></a><span class=sd>        Examples:</span>
</span><span id=__span-0-548><a id=__codelineno-0-548 name=__codelineno-0-548></a><span class=sd>            &gt;&gt;&gt; vocab_info = tokenizer.get_vocab_info()</span>
</span><span id=__span-0-549><a id=__codelineno-0-549 name=__codelineno-0-549></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Vocabulary size: {vocab_info[&#39;vocab_size&#39;]}&quot;)</span>
</span><span id=__span-0-550><a id=__codelineno-0-550 name=__codelineno-0-550></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Special tokens: {vocab_info[&#39;special_tokens&#39;]}&quot;)</span>
</span><span id=__span-0-551><a id=__codelineno-0-551 name=__codelineno-0-551></a><span class=sd>            Vocabulary size: 50000</span>
</span><span id=__span-0-552><a id=__codelineno-0-552 name=__codelineno-0-552></a><span class=sd>            Special tokens: {&#39;PAD&#39;: 0, &#39;CLS&#39;: 1, &#39;SEP&#39;: 2, &#39;MASK&#39;: 3}</span>
</span><span id=__span-0-553><a id=__codelineno-0-553 name=__codelineno-0-553></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-554><a id=__codelineno-0-554 name=__codelineno-0-554></a>        <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-555><a id=__codelineno-0-555 name=__codelineno-0-555></a>            <span class=s2>&quot;vocab_size&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span><span class=p>,</span>
</span><span id=__span-0-556><a id=__codelineno-0-556 name=__codelineno-0-556></a>            <span class=s2>&quot;tokenizer_type&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span><span class=o>.</span><span class=n>value</span><span class=p>,</span>
</span><span id=__span-0-557><a id=__codelineno-0-557 name=__codelineno-0-557></a>            <span class=s2>&quot;special_tokens&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>,</span>
</span><span id=__span-0-558><a id=__codelineno-0-558 name=__codelineno-0-558></a>            <span class=s2>&quot;n_expression_bins&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span><span class=p>,</span>
</span><span id=__span-0-559><a id=__codelineno-0-559 name=__codelineno-0-559></a>            <span class=s2>&quot;gene_vocab_size&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=p>),</span>
</span><span id=__span-0-560><a id=__codelineno-0-560 name=__codelineno-0-560></a>        <span class=p>}</span>
</span><span id=__span-0-561><a id=__codelineno-0-561 name=__codelineno-0-561></a>
</span><span id=__span-0-562><a id=__codelineno-0-562 name=__codelineno-0-562></a>    <span class=k>def</span><span class=w> </span><span class=nf>decode_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tokens</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-0-563><a id=__codelineno-0-563 name=__codelineno-0-563></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-564><a id=__codelineno-0-564 name=__codelineno-0-564></a><span class=sd>        Decode token sequence back to gene information.</span>
</span><span id=__span-0-565><a id=__codelineno-0-565 name=__codelineno-0-565></a>
</span><span id=__span-0-566><a id=__codelineno-0-566 name=__codelineno-0-566></a><span class=sd>        Args:</span>
</span><span id=__span-0-567><a id=__codelineno-0-567 name=__codelineno-0-567></a><span class=sd>            tokens: List of token IDs to decode</span>
</span><span id=__span-0-568><a id=__codelineno-0-568 name=__codelineno-0-568></a>
</span><span id=__span-0-569><a id=__codelineno-0-569 name=__codelineno-0-569></a><span class=sd>        Returns:</span>
</span><span id=__span-0-570><a id=__codelineno-0-570 name=__codelineno-0-570></a><span class=sd>            dict: Decoded information including genes, expressions, etc.</span>
</span><span id=__span-0-571><a id=__codelineno-0-571 name=__codelineno-0-571></a>
</span><span id=__span-0-572><a id=__codelineno-0-572 name=__codelineno-0-572></a><span class=sd>        Examples:</span>
</span><span id=__span-0-573><a id=__codelineno-0-573 name=__codelineno-0-573></a><span class=sd>            &gt;&gt;&gt; # Decode a token sequence</span>
</span><span id=__span-0-574><a id=__codelineno-0-574 name=__codelineno-0-574></a><span class=sd>            &gt;&gt;&gt; tokens = [1, 100, 50050, 200, 50060, 2]  # CLS, gene1, expr1, gene2, expr2, SEP</span>
</span><span id=__span-0-575><a id=__codelineno-0-575 name=__codelineno-0-575></a><span class=sd>            &gt;&gt;&gt; decoded = tokenizer.decode_tokens(tokens)</span>
</span><span id=__span-0-576><a id=__codelineno-0-576 name=__codelineno-0-576></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Genes: {decoded[&#39;genes&#39;]}&quot;)</span>
</span><span id=__span-0-577><a id=__codelineno-0-577 name=__codelineno-0-577></a><span class=sd>            &gt;&gt;&gt; print(f&quot;Expressions: {decoded[&#39;expressions&#39;]}&quot;)</span>
</span><span id=__span-0-578><a id=__codelineno-0-578 name=__codelineno-0-578></a><span class=sd>            Genes: [&#39;gene_100&#39;, &#39;gene_200&#39;]</span>
</span><span id=__span-0-579><a id=__codelineno-0-579 name=__codelineno-0-579></a><span class=sd>            Expressions: [0.5, 0.6]</span>
</span><span id=__span-0-580><a id=__codelineno-0-580 name=__codelineno-0-580></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-0-581><a id=__codelineno-0-581 name=__codelineno-0-581></a>        <span class=k>if</span> <span class=ow>not</span> <span class=n>tokens</span><span class=p>:</span>
</span><span id=__span-0-582><a id=__codelineno-0-582 name=__codelineno-0-582></a>            <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;genes&quot;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&quot;expressions&quot;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&quot;special_tokens&quot;</span><span class=p>:</span> <span class=p>[]}</span>
</span><span id=__span-0-583><a id=__codelineno-0-583 name=__codelineno-0-583></a>
</span><span id=__span-0-584><a id=__codelineno-0-584 name=__codelineno-0-584></a>        <span class=n>genes</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-585><a id=__codelineno-0-585 name=__codelineno-0-585></a>        <span class=n>expressions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-586><a id=__codelineno-0-586 name=__codelineno-0-586></a>        <span class=n>special_tokens</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-587><a id=__codelineno-0-587 name=__codelineno-0-587></a>
</span><span id=__span-0-588><a id=__codelineno-0-588 name=__codelineno-0-588></a>        <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-589><a id=__codelineno-0-589 name=__codelineno-0-589></a>        <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>):</span>
</span><span id=__span-0-590><a id=__codelineno-0-590 name=__codelineno-0-590></a>            <span class=n>token</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-0-591><a id=__codelineno-0-591 name=__codelineno-0-591></a>
</span><span id=__span-0-592><a id=__codelineno-0-592 name=__codelineno-0-592></a>            <span class=k>if</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>]:</span>
</span><span id=__span-0-593><a id=__codelineno-0-593 name=__codelineno-0-593></a>                <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;CLS&quot;</span><span class=p>)</span>
</span><span id=__span-0-594><a id=__codelineno-0-594 name=__codelineno-0-594></a>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-595><a id=__codelineno-0-595 name=__codelineno-0-595></a>            <span class=k>elif</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]:</span>
</span><span id=__span-0-596><a id=__codelineno-0-596 name=__codelineno-0-596></a>                <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;SEP&quot;</span><span class=p>)</span>
</span><span id=__span-0-597><a id=__codelineno-0-597 name=__codelineno-0-597></a>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-598><a id=__codelineno-0-598 name=__codelineno-0-598></a>            <span class=k>elif</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>]:</span>
</span><span id=__span-0-599><a id=__codelineno-0-599 name=__codelineno-0-599></a>                <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;PAD&quot;</span><span class=p>)</span>
</span><span id=__span-0-600><a id=__codelineno-0-600 name=__codelineno-0-600></a>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-601><a id=__codelineno-0-601 name=__codelineno-0-601></a>            <span class=k>elif</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;MASK&quot;</span><span class=p>]:</span>
</span><span id=__span-0-602><a id=__codelineno-0-602 name=__codelineno-0-602></a>                <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;MASK&quot;</span><span class=p>)</span>
</span><span id=__span-0-603><a id=__codelineno-0-603 name=__codelineno-0-603></a>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-604><a id=__codelineno-0-604 name=__codelineno-0-604></a>            <span class=k>elif</span> <span class=p>(</span>
</span><span id=__span-0-605><a id=__codelineno-0-605 name=__codelineno-0-605></a>                <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span>
</span><span id=__span-0-606><a id=__codelineno-0-606 name=__codelineno-0-606></a>                <span class=ow>and</span> <span class=n>token</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span>
</span><span id=__span-0-607><a id=__codelineno-0-607 name=__codelineno-0-607></a>            <span class=p>):</span>
</span><span id=__span-0-608><a id=__codelineno-0-608 name=__codelineno-0-608></a>                <span class=c1># Expression token</span>
</span><span id=__span-0-609><a id=__codelineno-0-609 name=__codelineno-0-609></a>                <span class=n>bin_id</span> <span class=o>=</span> <span class=n>token</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span>
</span><span id=__span-0-610><a id=__codelineno-0-610 name=__codelineno-0-610></a>                <span class=n>expr_value</span> <span class=o>=</span> <span class=n>bin_id</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_size</span>
</span><span id=__span-0-611><a id=__codelineno-0-611 name=__codelineno-0-611></a>                <span class=n>expressions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>expr_value</span><span class=p>)</span>
</span><span id=__span-0-612><a id=__codelineno-0-612 name=__codelineno-0-612></a>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-613><a id=__codelineno-0-613 name=__codelineno-0-613></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-614><a id=__codelineno-0-614 name=__codelineno-0-614></a>                <span class=c1># Gene token</span>
</span><span id=__span-0-615><a id=__codelineno-0-615 name=__codelineno-0-615></a>                <span class=k>if</span> <span class=n>token</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span><span class=p>:</span>
</span><span id=__span-0-616><a id=__codelineno-0-616 name=__codelineno-0-616></a>                    <span class=n>genes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span><span class=p>[</span><span class=n>token</span><span class=p>])</span>
</span><span id=__span-0-617><a id=__codelineno-0-617 name=__codelineno-0-617></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-618><a id=__codelineno-0-618 name=__codelineno-0-618></a>                    <span class=n>genes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;unknown_gene_</span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-619><a id=__codelineno-0-619 name=__codelineno-0-619></a>                <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-620><a id=__codelineno-0-620 name=__codelineno-0-620></a>
</span><span id=__span-0-621><a id=__codelineno-0-621 name=__codelineno-0-621></a>        <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-622><a id=__codelineno-0-622 name=__codelineno-0-622></a>            <span class=s2>&quot;genes&quot;</span><span class=p>:</span> <span class=n>genes</span><span class=p>,</span>
</span><span id=__span-0-623><a id=__codelineno-0-623 name=__codelineno-0-623></a>            <span class=s2>&quot;expressions&quot;</span><span class=p>:</span> <span class=n>expressions</span><span class=p>,</span>
</span><span id=__span-0-624><a id=__codelineno-0-624 name=__codelineno-0-624></a>            <span class=s2>&quot;special_tokens&quot;</span><span class=p>:</span> <span class=n>special_tokens</span><span class=p>,</span>
</span><span id=__span-0-625><a id=__codelineno-0-625 name=__codelineno-0-625></a>        <span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <h5 id=slaf.ml.tokenizers.SLAFTokenizer-functions>Functions<a href=#slaf.ml.tokenizers.SLAFTokenizer-functions class=headerlink title="Permanent link">&para;</a></h5> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tokenizers.SLAFTokenizer.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>:</span> <span class=n>SLAFArray</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=p>:</span> <span class=n>TokenizerType</span> <span class=o>|</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>,</span> <span class=n>vocab_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span> <span class=n>n_expression_bins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span></code> <a href=#slaf.ml.tokenizers.SLAFTokenizer.__init__ class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Initialize SLAFTokenizer with SLAF array and vocabulary settings.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>slaf_array</code> </td> <td> <code><a class="autorefs autorefs-internal" title=slaf.core.slaf.SLAFArray href=../core/#slaf.core.slaf.SLAFArray>SLAFArray</a></code> </td> <td> <div class=doc-md-description> <p>Initialized SLAFArray instance containing the single-cell data. Used to build the gene vocabulary and access expression data. Must be a valid SLAFArray with proper var DataFrame.</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>tokenizer_type</code> </td> <td> <code><a class="autorefs autorefs-internal" title="TokenizerType (slaf.ml.tokenizers.TokenizerType)" href=#slaf.ml.tokenizers.TokenizerType>TokenizerType</a> | <span title=str>str</span></code> </td> <td> <div class=doc-md-description> <p>Type of tokenizer to use. Options: "geneformer", "scgpt". Can be passed as string or TokenizerType enum.</p> </div> </td> <td> <code><span title=slaf.ml.tokenizers.TokenizerType.GENEFORMER>GENEFORMER</span></code> </td> </tr> <tr class=doc-section-item> <td> <code>vocab_size</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Maximum size of gene vocabulary. Genes beyond this limit are excluded from tokenization. Higher values use more memory.</p> </div> </td> <td> <code>50000</code> </td> </tr> <tr class=doc-section-item> <td> <code>n_expression_bins</code> </td> <td> <code><span title=int>int</span></code> </td> <td> <div class=doc-md-description> <p>Number of expression bins for scGPT tokenization. Higher values provide finer expression resolution. Range: 1-1000, default: 10.</p> </div> </td> <td> <code>10</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If tokenizer_type is not supported or vocab_size is invalid.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=RuntimeError>RuntimeError</span></code> </td> <td> <div class=doc-md-description> <p>If SLAF array is not properly initialized.</p> </div> </td> </tr> <tr class=doc-section-item> <td> <code><span title=TypeError>TypeError</span></code> </td> <td> <div class=doc-md-description> <p>If slaf_array is not a valid SLAFArray instance.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Basic initialization</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>SLAFArray</span><span class=p>(</span><span class=s2>&quot;path/to/data.slaf&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Tokenizer type: </span><span class=si>{</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>tokenizer_type</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=go>Tokenizer type: TokenizerType.GENEFORMER</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># scGPT with custom settings</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>slaf_array</span><span class=o>=</span><span class=n>slaf_array</span><span class=p>,</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span>    <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;scgpt&quot;</span><span class=p>,</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=n>vocab_size</span><span class=o>=</span><span class=mi>30000</span><span class=p>,</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=gp>... </span>    <span class=n>n_expression_bins</span><span class=o>=</span><span class=mi>20</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=gp>... </span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expression bins: </span><span class=si>{</span><span class=n>tokenizer</span><span class=o>.</span><span class=n>n_expression_bins</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=go>Expression bins: 20</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Error handling for invalid tokenizer type</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span><span class=n>slaf_array</span><span class=p>,</span> <span class=n>tokenizer_type</span><span class=o>=</span><span class=s2>&quot;invalid&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span><span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Error: Unsupported tokenizer type: invalid. Supported types: [&#39;geneformer&#39;, &#39;scgpt&#39;]</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Error handling for invalid SLAF array</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>... </span>    <span class=n>tokenizer</span> <span class=o>=</span> <span class=n>SLAFTokenizer</span><span class=p>(</span><span class=kc>None</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>... </span><span class=k>except</span> <span class=ne>TypeError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>... </span>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Error: </span><span class=si>{</span><span class=n>e</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Error: slaf_array must be a valid SLAFArray instance</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tokenizers.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-71> 71</a></span>
<span class=normal><a href=#__codelineno-0-72> 72</a></span>
<span class=normal><a href=#__codelineno-0-73> 73</a></span>
<span class=normal><a href=#__codelineno-0-74> 74</a></span>
<span class=normal><a href=#__codelineno-0-75> 75</a></span>
<span class=normal><a href=#__codelineno-0-76> 76</a></span>
<span class=normal><a href=#__codelineno-0-77> 77</a></span>
<span class=normal><a href=#__codelineno-0-78> 78</a></span>
<span class=normal><a href=#__codelineno-0-79> 79</a></span>
<span class=normal><a href=#__codelineno-0-80> 80</a></span>
<span class=normal><a href=#__codelineno-0-81> 81</a></span>
<span class=normal><a href=#__codelineno-0-82> 82</a></span>
<span class=normal><a href=#__codelineno-0-83> 83</a></span>
<span class=normal><a href=#__codelineno-0-84> 84</a></span>
<span class=normal><a href=#__codelineno-0-85> 85</a></span>
<span class=normal><a href=#__codelineno-0-86> 86</a></span>
<span class=normal><a href=#__codelineno-0-87> 87</a></span>
<span class=normal><a href=#__codelineno-0-88> 88</a></span>
<span class=normal><a href=#__codelineno-0-89> 89</a></span>
<span class=normal><a href=#__codelineno-0-90> 90</a></span>
<span class=normal><a href=#__codelineno-0-91> 91</a></span>
<span class=normal><a href=#__codelineno-0-92> 92</a></span>
<span class=normal><a href=#__codelineno-0-93> 93</a></span>
<span class=normal><a href=#__codelineno-0-94> 94</a></span>
<span class=normal><a href=#__codelineno-0-95> 95</a></span>
<span class=normal><a href=#__codelineno-0-96> 96</a></span>
<span class=normal><a href=#__codelineno-0-97> 97</a></span>
<span class=normal><a href=#__codelineno-0-98> 98</a></span>
<span class=normal><a href=#__codelineno-0-99> 99</a></span>
<span class=normal><a href=#__codelineno-0-100>100</a></span>
<span class=normal><a href=#__codelineno-0-101>101</a></span>
<span class=normal><a href=#__codelineno-0-102>102</a></span>
<span class=normal><a href=#__codelineno-0-103>103</a></span>
<span class=normal><a href=#__codelineno-0-104>104</a></span>
<span class=normal><a href=#__codelineno-0-105>105</a></span>
<span class=normal><a href=#__codelineno-0-106>106</a></span>
<span class=normal><a href=#__codelineno-0-107>107</a></span>
<span class=normal><a href=#__codelineno-0-108>108</a></span>
<span class=normal><a href=#__codelineno-0-109>109</a></span>
<span class=normal><a href=#__codelineno-0-110>110</a></span>
<span class=normal><a href=#__codelineno-0-111>111</a></span>
<span class=normal><a href=#__codelineno-0-112>112</a></span>
<span class=normal><a href=#__codelineno-0-113>113</a></span>
<span class=normal><a href=#__codelineno-0-114>114</a></span>
<span class=normal><a href=#__codelineno-0-115>115</a></span>
<span class=normal><a href=#__codelineno-0-116>116</a></span>
<span class=normal><a href=#__codelineno-0-117>117</a></span>
<span class=normal><a href=#__codelineno-0-118>118</a></span>
<span class=normal><a href=#__codelineno-0-119>119</a></span>
<span class=normal><a href=#__codelineno-0-120>120</a></span>
<span class=normal><a href=#__codelineno-0-121>121</a></span>
<span class=normal><a href=#__codelineno-0-122>122</a></span>
<span class=normal><a href=#__codelineno-0-123>123</a></span>
<span class=normal><a href=#__codelineno-0-124>124</a></span>
<span class=normal><a href=#__codelineno-0-125>125</a></span>
<span class=normal><a href=#__codelineno-0-126>126</a></span>
<span class=normal><a href=#__codelineno-0-127>127</a></span>
<span class=normal><a href=#__codelineno-0-128>128</a></span>
<span class=normal><a href=#__codelineno-0-129>129</a></span>
<span class=normal><a href=#__codelineno-0-130>130</a></span>
<span class=normal><a href=#__codelineno-0-131>131</a></span>
<span class=normal><a href=#__codelineno-0-132>132</a></span>
<span class=normal><a href=#__codelineno-0-133>133</a></span>
<span class=normal><a href=#__codelineno-0-134>134</a></span>
<span class=normal><a href=#__codelineno-0-135>135</a></span>
<span class=normal><a href=#__codelineno-0-136>136</a></span>
<span class=normal><a href=#__codelineno-0-137>137</a></span>
<span class=normal><a href=#__codelineno-0-138>138</a></span>
<span class=normal><a href=#__codelineno-0-139>139</a></span>
<span class=normal><a href=#__codelineno-0-140>140</a></span>
<span class=normal><a href=#__codelineno-0-141>141</a></span>
<span class=normal><a href=#__codelineno-0-142>142</a></span>
<span class=normal><a href=#__codelineno-0-143>143</a></span>
<span class=normal><a href=#__codelineno-0-144>144</a></span>
<span class=normal><a href=#__codelineno-0-145>145</a></span>
<span class=normal><a href=#__codelineno-0-146>146</a></span>
<span class=normal><a href=#__codelineno-0-147>147</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-71><a id=__codelineno-0-71 name=__codelineno-0-71></a><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span>
</span><span id=__span-0-72><a id=__codelineno-0-72 name=__codelineno-0-72></a>    <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-73><a id=__codelineno-0-73 name=__codelineno-0-73></a>    <span class=n>slaf_array</span><span class=p>:</span> <span class=n>SLAFArray</span><span class=p>,</span>
</span><span id=__span-0-74><a id=__codelineno-0-74 name=__codelineno-0-74></a>    <span class=n>tokenizer_type</span><span class=p>:</span> <span class=n>TokenizerType</span> <span class=o>|</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>,</span>
</span><span id=__span-0-75><a id=__codelineno-0-75 name=__codelineno-0-75></a>    <span class=n>vocab_size</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>50000</span><span class=p>,</span>
</span><span id=__span-0-76><a id=__codelineno-0-76 name=__codelineno-0-76></a>    <span class=n>n_expression_bins</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>,</span>
</span><span id=__span-0-77><a id=__codelineno-0-77 name=__codelineno-0-77></a><span class=p>):</span>
</span><span id=__span-0-78><a id=__codelineno-0-78 name=__codelineno-0-78></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-79><a id=__codelineno-0-79 name=__codelineno-0-79></a><span class=sd>    Initialize SLAFTokenizer with SLAF array and vocabulary settings.</span>
</span><span id=__span-0-80><a id=__codelineno-0-80 name=__codelineno-0-80></a>
</span><span id=__span-0-81><a id=__codelineno-0-81 name=__codelineno-0-81></a><span class=sd>    Args:</span>
</span><span id=__span-0-82><a id=__codelineno-0-82 name=__codelineno-0-82></a><span class=sd>        slaf_array: Initialized SLAFArray instance containing the single-cell data.</span>
</span><span id=__span-0-83><a id=__codelineno-0-83 name=__codelineno-0-83></a><span class=sd>                   Used to build the gene vocabulary and access expression data.</span>
</span><span id=__span-0-84><a id=__codelineno-0-84 name=__codelineno-0-84></a><span class=sd>                   Must be a valid SLAFArray with proper var DataFrame.</span>
</span><span id=__span-0-85><a id=__codelineno-0-85 name=__codelineno-0-85></a><span class=sd>        tokenizer_type: Type of tokenizer to use. Options: &quot;geneformer&quot;, &quot;scgpt&quot;.</span>
</span><span id=__span-0-86><a id=__codelineno-0-86 name=__codelineno-0-86></a><span class=sd>                      Can be passed as string or TokenizerType enum.</span>
</span><span id=__span-0-87><a id=__codelineno-0-87 name=__codelineno-0-87></a><span class=sd>        vocab_size: Maximum size of gene vocabulary. Genes beyond this limit</span>
</span><span id=__span-0-88><a id=__codelineno-0-88 name=__codelineno-0-88></a><span class=sd>                   are excluded from tokenization. Higher values use more memory.</span>
</span><span id=__span-0-89><a id=__codelineno-0-89 name=__codelineno-0-89></a><span class=sd>        n_expression_bins: Number of expression bins for scGPT tokenization.</span>
</span><span id=__span-0-90><a id=__codelineno-0-90 name=__codelineno-0-90></a><span class=sd>                         Higher values provide finer expression resolution.</span>
</span><span id=__span-0-91><a id=__codelineno-0-91 name=__codelineno-0-91></a><span class=sd>                         Range: 1-1000, default: 10.</span>
</span><span id=__span-0-92><a id=__codelineno-0-92 name=__codelineno-0-92></a>
</span><span id=__span-0-93><a id=__codelineno-0-93 name=__codelineno-0-93></a><span class=sd>    Raises:</span>
</span><span id=__span-0-94><a id=__codelineno-0-94 name=__codelineno-0-94></a><span class=sd>        ValueError: If tokenizer_type is not supported or vocab_size is invalid.</span>
</span><span id=__span-0-95><a id=__codelineno-0-95 name=__codelineno-0-95></a><span class=sd>        RuntimeError: If SLAF array is not properly initialized.</span>
</span><span id=__span-0-96><a id=__codelineno-0-96 name=__codelineno-0-96></a><span class=sd>        TypeError: If slaf_array is not a valid SLAFArray instance.</span>
</span><span id=__span-0-97><a id=__codelineno-0-97 name=__codelineno-0-97></a>
</span><span id=__span-0-98><a id=__codelineno-0-98 name=__codelineno-0-98></a><span class=sd>    Examples:</span>
</span><span id=__span-0-99><a id=__codelineno-0-99 name=__codelineno-0-99></a><span class=sd>        &gt;&gt;&gt; # Basic initialization</span>
</span><span id=__span-0-100><a id=__codelineno-0-100 name=__codelineno-0-100></a><span class=sd>        &gt;&gt;&gt; slaf_array = SLAFArray(&quot;path/to/data.slaf&quot;)</span>
</span><span id=__span-0-101><a id=__codelineno-0-101 name=__codelineno-0-101></a><span class=sd>        &gt;&gt;&gt; tokenizer = SLAFTokenizer(slaf_array)</span>
</span><span id=__span-0-102><a id=__codelineno-0-102 name=__codelineno-0-102></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Tokenizer type: {tokenizer.tokenizer_type}&quot;)</span>
</span><span id=__span-0-103><a id=__codelineno-0-103 name=__codelineno-0-103></a><span class=sd>        Tokenizer type: TokenizerType.GENEFORMER</span>
</span><span id=__span-0-104><a id=__codelineno-0-104 name=__codelineno-0-104></a>
</span><span id=__span-0-105><a id=__codelineno-0-105 name=__codelineno-0-105></a><span class=sd>        &gt;&gt;&gt; # scGPT with custom settings</span>
</span><span id=__span-0-106><a id=__codelineno-0-106 name=__codelineno-0-106></a><span class=sd>        &gt;&gt;&gt; tokenizer = SLAFTokenizer(</span>
</span><span id=__span-0-107><a id=__codelineno-0-107 name=__codelineno-0-107></a><span class=sd>        ...     slaf_array=slaf_array,</span>
</span><span id=__span-0-108><a id=__codelineno-0-108 name=__codelineno-0-108></a><span class=sd>        ...     tokenizer_type=&quot;scgpt&quot;,</span>
</span><span id=__span-0-109><a id=__codelineno-0-109 name=__codelineno-0-109></a><span class=sd>        ...     vocab_size=30000,</span>
</span><span id=__span-0-110><a id=__codelineno-0-110 name=__codelineno-0-110></a><span class=sd>        ...     n_expression_bins=20</span>
</span><span id=__span-0-111><a id=__codelineno-0-111 name=__codelineno-0-111></a><span class=sd>        ... )</span>
</span><span id=__span-0-112><a id=__codelineno-0-112 name=__codelineno-0-112></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Expression bins: {tokenizer.n_expression_bins}&quot;)</span>
</span><span id=__span-0-113><a id=__codelineno-0-113 name=__codelineno-0-113></a><span class=sd>        Expression bins: 20</span>
</span><span id=__span-0-114><a id=__codelineno-0-114 name=__codelineno-0-114></a>
</span><span id=__span-0-115><a id=__codelineno-0-115 name=__codelineno-0-115></a><span class=sd>        &gt;&gt;&gt; # Error handling for invalid tokenizer type</span>
</span><span id=__span-0-116><a id=__codelineno-0-116 name=__codelineno-0-116></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-117><a id=__codelineno-0-117 name=__codelineno-0-117></a><span class=sd>        ...     tokenizer = SLAFTokenizer(slaf_array, tokenizer_type=&quot;invalid&quot;)</span>
</span><span id=__span-0-118><a id=__codelineno-0-118 name=__codelineno-0-118></a><span class=sd>        ... except ValueError as e:</span>
</span><span id=__span-0-119><a id=__codelineno-0-119 name=__codelineno-0-119></a><span class=sd>        ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-120><a id=__codelineno-0-120 name=__codelineno-0-120></a><span class=sd>        Error: Unsupported tokenizer type: invalid. Supported types: [&#39;geneformer&#39;, &#39;scgpt&#39;]</span>
</span><span id=__span-0-121><a id=__codelineno-0-121 name=__codelineno-0-121></a>
</span><span id=__span-0-122><a id=__codelineno-0-122 name=__codelineno-0-122></a><span class=sd>        &gt;&gt;&gt; # Error handling for invalid SLAF array</span>
</span><span id=__span-0-123><a id=__codelineno-0-123 name=__codelineno-0-123></a><span class=sd>        &gt;&gt;&gt; try:</span>
</span><span id=__span-0-124><a id=__codelineno-0-124 name=__codelineno-0-124></a><span class=sd>        ...     tokenizer = SLAFTokenizer(None)</span>
</span><span id=__span-0-125><a id=__codelineno-0-125 name=__codelineno-0-125></a><span class=sd>        ... except TypeError as e:</span>
</span><span id=__span-0-126><a id=__codelineno-0-126 name=__codelineno-0-126></a><span class=sd>        ...     print(f&quot;Error: {e}&quot;)</span>
</span><span id=__span-0-127><a id=__codelineno-0-127 name=__codelineno-0-127></a><span class=sd>        Error: slaf_array must be a valid SLAFArray instance</span>
</span><span id=__span-0-128><a id=__codelineno-0-128 name=__codelineno-0-128></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-129><a id=__codelineno-0-129 name=__codelineno-0-129></a>    <span class=bp>self</span><span class=o>.</span><span class=n>slaf_array</span> <span class=o>=</span> <span class=n>slaf_array</span>
</span><span id=__span-0-130><a id=__codelineno-0-130 name=__codelineno-0-130></a>    <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span> <span class=o>=</span> <span class=n>vocab_size</span>
</span><span id=__span-0-131><a id=__codelineno-0-131 name=__codelineno-0-131></a>    <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span> <span class=o>=</span> <span class=n>n_expression_bins</span>
</span><span id=__span-0-132><a id=__codelineno-0-132 name=__codelineno-0-132></a>
</span><span id=__span-0-133><a id=__codelineno-0-133 name=__codelineno-0-133></a>    <span class=c1># Convert string to enum if needed</span>
</span><span id=__span-0-134><a id=__codelineno-0-134 name=__codelineno-0-134></a>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>tokenizer_type</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-0-135><a id=__codelineno-0-135 name=__codelineno-0-135></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-0-136><a id=__codelineno-0-136 name=__codelineno-0-136></a>            <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>=</span> <span class=n>TokenizerType</span><span class=p>(</span><span class=n>tokenizer_type</span><span class=o>.</span><span class=n>lower</span><span class=p>())</span>
</span><span id=__span-0-137><a id=__codelineno-0-137 name=__codelineno-0-137></a>        <span class=k>except</span> <span class=ne>ValueError</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
</span><span id=__span-0-138><a id=__codelineno-0-138 name=__codelineno-0-138></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-0-139><a id=__codelineno-0-139 name=__codelineno-0-139></a>                <span class=sa>f</span><span class=s2>&quot;Unsupported tokenizer type: </span><span class=si>{</span><span class=n>tokenizer_type</span><span class=si>}</span><span class=s2>. &quot;</span>
</span><span id=__span-0-140><a id=__codelineno-0-140 name=__codelineno-0-140></a>                <span class=sa>f</span><span class=s2>&quot;Supported types: </span><span class=si>{</span><span class=p>[</span><span class=n>t</span><span class=o>.</span><span class=n>value</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=ow>in</span><span class=w> </span><span class=n>TokenizerType</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-0-141><a id=__codelineno-0-141 name=__codelineno-0-141></a>            <span class=p>)</span> <span class=kn>from</span><span class=w> </span><span class=nn>err</span>
</span><span id=__span-0-142><a id=__codelineno-0-142 name=__codelineno-0-142></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-143><a id=__codelineno-0-143 name=__codelineno-0-143></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>=</span> <span class=n>tokenizer_type</span>
</span><span id=__span-0-144><a id=__codelineno-0-144 name=__codelineno-0-144></a>
</span><span id=__span-0-145><a id=__codelineno-0-145 name=__codelineno-0-145></a>    <span class=c1># Build vocabulary and special tokens</span>
</span><span id=__span-0-146><a id=__codelineno-0-146 name=__codelineno-0-146></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_build_gene_vocabulary</span><span class=p>()</span>
</span><span id=__span-0-147><a id=__codelineno-0-147 name=__codelineno-0-147></a>    <span class=bp>self</span><span class=o>.</span><span class=n>_setup_special_tokens</span><span class=p>()</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tokenizers.SLAFTokenizer.tokenize class="doc doc-heading"> <code class="highlight language-python"><span class=n>tokenize</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>|</span> <span class=nb>list</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]],</span> <span class=n>expr_sequences</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span> <span class=n>max_genes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>]</span></code> <a href=#slaf.ml.tokenizers.SLAFTokenizer.tokenize class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Tokenize gene expression sequences into model-ready tensors.</p> <p>This method converts gene and expression sequences into tokenized tensors suitable for machine learning models. It supports both GeneFormer and scGPT tokenization strategies with optimized vectorized operations.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>gene_sequences</code> </td> <td> <code><span title=list>list</span>[<span title=list>list</span>[<span title=int>int</span>] | <span title=list>list</span>[<span title=tuple>tuple</span>[<span title=int>int</span>, <span title=float>float</span>]]]</code> </td> <td> <div class=doc-md-description> <p>List of gene ID sequences for each cell</p> </div> </td> <td> <em>required</em> </td> </tr> <tr class=doc-section-item> <td> <code>expr_sequences</code> </td> <td> <code><span title=list>list</span>[<span title=list>list</span>[<span title=float>float</span>]] | None</code> </td> <td> <div class=doc-md-description> <p>List of expression value sequences for each cell (required for scGPT)</p> </div> </td> <td> <code>None</code> </td> </tr> <tr class=doc-section-item> <td> <code>max_genes</code> </td> <td> <code><span title=int>int</span> | None</code> </td> <td> <div class=doc-md-description> <p>Maximum number of genes per cell (defaults based on tokenizer type)</p> </div> </td> <td> <code>None</code> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>tuple</code></td> <td> <code><span title=tuple>tuple</span>[<span title=torch.Tensor>Tensor</span>, <span title=torch.Tensor>Tensor</span>]</code> </td> <td> <div class=doc-md-description> <p>(input_ids, attention_mask) tensors - input_ids: Tokenized sequences with padding - attention_mask: Boolean mask indicating valid tokens</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Raises:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code><span title=ValueError>ValueError</span></code> </td> <td> <div class=doc-md-description> <p>If gene_sequences is empty</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># GeneFormer tokenization</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>gene_sequences</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>]]</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>tokenize</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Shape: </span><span class=si>{</span><span class=n>input_ids</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=go>Shape: torch.Size([2, 2048])</span>
</span></code></pre></div> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># scGPT tokenization</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>gene_sequences</span> <span class=o>=</span> <span class=p>[[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>],</span> <span class=p>[</span><span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>,</span> <span class=mi>6</span><span class=p>]]</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>expr_sequences</span> <span class=o>=</span> <span class=p>[[</span><span class=mf>0.5</span><span class=p>,</span> <span class=mf>0.8</span><span class=p>,</span> <span class=mf>0.2</span><span class=p>],</span> <span class=p>[</span><span class=mf>0.9</span><span class=p>,</span> <span class=mf>0.1</span><span class=p>,</span> <span class=mf>0.7</span><span class=p>]]</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>tokenize</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>,</span> <span class=n>expr_sequences</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Shape: </span><span class=si>{</span><span class=n>input_ids</span><span class=o>.</span><span class=n>shape</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Shape: torch.Size([2, 2050])</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tokenizers.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-344>344</a></span>
<span class=normal><a href=#__codelineno-0-345>345</a></span>
<span class=normal><a href=#__codelineno-0-346>346</a></span>
<span class=normal><a href=#__codelineno-0-347>347</a></span>
<span class=normal><a href=#__codelineno-0-348>348</a></span>
<span class=normal><a href=#__codelineno-0-349>349</a></span>
<span class=normal><a href=#__codelineno-0-350>350</a></span>
<span class=normal><a href=#__codelineno-0-351>351</a></span>
<span class=normal><a href=#__codelineno-0-352>352</a></span>
<span class=normal><a href=#__codelineno-0-353>353</a></span>
<span class=normal><a href=#__codelineno-0-354>354</a></span>
<span class=normal><a href=#__codelineno-0-355>355</a></span>
<span class=normal><a href=#__codelineno-0-356>356</a></span>
<span class=normal><a href=#__codelineno-0-357>357</a></span>
<span class=normal><a href=#__codelineno-0-358>358</a></span>
<span class=normal><a href=#__codelineno-0-359>359</a></span>
<span class=normal><a href=#__codelineno-0-360>360</a></span>
<span class=normal><a href=#__codelineno-0-361>361</a></span>
<span class=normal><a href=#__codelineno-0-362>362</a></span>
<span class=normal><a href=#__codelineno-0-363>363</a></span>
<span class=normal><a href=#__codelineno-0-364>364</a></span>
<span class=normal><a href=#__codelineno-0-365>365</a></span>
<span class=normal><a href=#__codelineno-0-366>366</a></span>
<span class=normal><a href=#__codelineno-0-367>367</a></span>
<span class=normal><a href=#__codelineno-0-368>368</a></span>
<span class=normal><a href=#__codelineno-0-369>369</a></span>
<span class=normal><a href=#__codelineno-0-370>370</a></span>
<span class=normal><a href=#__codelineno-0-371>371</a></span>
<span class=normal><a href=#__codelineno-0-372>372</a></span>
<span class=normal><a href=#__codelineno-0-373>373</a></span>
<span class=normal><a href=#__codelineno-0-374>374</a></span>
<span class=normal><a href=#__codelineno-0-375>375</a></span>
<span class=normal><a href=#__codelineno-0-376>376</a></span>
<span class=normal><a href=#__codelineno-0-377>377</a></span>
<span class=normal><a href=#__codelineno-0-378>378</a></span>
<span class=normal><a href=#__codelineno-0-379>379</a></span>
<span class=normal><a href=#__codelineno-0-380>380</a></span>
<span class=normal><a href=#__codelineno-0-381>381</a></span>
<span class=normal><a href=#__codelineno-0-382>382</a></span>
<span class=normal><a href=#__codelineno-0-383>383</a></span>
<span class=normal><a href=#__codelineno-0-384>384</a></span>
<span class=normal><a href=#__codelineno-0-385>385</a></span>
<span class=normal><a href=#__codelineno-0-386>386</a></span>
<span class=normal><a href=#__codelineno-0-387>387</a></span>
<span class=normal><a href=#__codelineno-0-388>388</a></span>
<span class=normal><a href=#__codelineno-0-389>389</a></span>
<span class=normal><a href=#__codelineno-0-390>390</a></span>
<span class=normal><a href=#__codelineno-0-391>391</a></span>
<span class=normal><a href=#__codelineno-0-392>392</a></span>
<span class=normal><a href=#__codelineno-0-393>393</a></span>
<span class=normal><a href=#__codelineno-0-394>394</a></span>
<span class=normal><a href=#__codelineno-0-395>395</a></span>
<span class=normal><a href=#__codelineno-0-396>396</a></span>
<span class=normal><a href=#__codelineno-0-397>397</a></span>
<span class=normal><a href=#__codelineno-0-398>398</a></span>
<span class=normal><a href=#__codelineno-0-399>399</a></span>
<span class=normal><a href=#__codelineno-0-400>400</a></span>
<span class=normal><a href=#__codelineno-0-401>401</a></span>
<span class=normal><a href=#__codelineno-0-402>402</a></span>
<span class=normal><a href=#__codelineno-0-403>403</a></span>
<span class=normal><a href=#__codelineno-0-404>404</a></span>
<span class=normal><a href=#__codelineno-0-405>405</a></span>
<span class=normal><a href=#__codelineno-0-406>406</a></span>
<span class=normal><a href=#__codelineno-0-407>407</a></span>
<span class=normal><a href=#__codelineno-0-408>408</a></span>
<span class=normal><a href=#__codelineno-0-409>409</a></span>
<span class=normal><a href=#__codelineno-0-410>410</a></span>
<span class=normal><a href=#__codelineno-0-411>411</a></span>
<span class=normal><a href=#__codelineno-0-412>412</a></span>
<span class=normal><a href=#__codelineno-0-413>413</a></span>
<span class=normal><a href=#__codelineno-0-414>414</a></span>
<span class=normal><a href=#__codelineno-0-415>415</a></span>
<span class=normal><a href=#__codelineno-0-416>416</a></span>
<span class=normal><a href=#__codelineno-0-417>417</a></span>
<span class=normal><a href=#__codelineno-0-418>418</a></span>
<span class=normal><a href=#__codelineno-0-419>419</a></span>
<span class=normal><a href=#__codelineno-0-420>420</a></span>
<span class=normal><a href=#__codelineno-0-421>421</a></span>
<span class=normal><a href=#__codelineno-0-422>422</a></span>
<span class=normal><a href=#__codelineno-0-423>423</a></span>
<span class=normal><a href=#__codelineno-0-424>424</a></span>
<span class=normal><a href=#__codelineno-0-425>425</a></span>
<span class=normal><a href=#__codelineno-0-426>426</a></span>
<span class=normal><a href=#__codelineno-0-427>427</a></span>
<span class=normal><a href=#__codelineno-0-428>428</a></span>
<span class=normal><a href=#__codelineno-0-429>429</a></span>
<span class=normal><a href=#__codelineno-0-430>430</a></span>
<span class=normal><a href=#__codelineno-0-431>431</a></span>
<span class=normal><a href=#__codelineno-0-432>432</a></span>
<span class=normal><a href=#__codelineno-0-433>433</a></span>
<span class=normal><a href=#__codelineno-0-434>434</a></span>
<span class=normal><a href=#__codelineno-0-435>435</a></span>
<span class=normal><a href=#__codelineno-0-436>436</a></span>
<span class=normal><a href=#__codelineno-0-437>437</a></span>
<span class=normal><a href=#__codelineno-0-438>438</a></span>
<span class=normal><a href=#__codelineno-0-439>439</a></span>
<span class=normal><a href=#__codelineno-0-440>440</a></span>
<span class=normal><a href=#__codelineno-0-441>441</a></span>
<span class=normal><a href=#__codelineno-0-442>442</a></span>
<span class=normal><a href=#__codelineno-0-443>443</a></span>
<span class=normal><a href=#__codelineno-0-444>444</a></span>
<span class=normal><a href=#__codelineno-0-445>445</a></span>
<span class=normal><a href=#__codelineno-0-446>446</a></span>
<span class=normal><a href=#__codelineno-0-447>447</a></span>
<span class=normal><a href=#__codelineno-0-448>448</a></span>
<span class=normal><a href=#__codelineno-0-449>449</a></span>
<span class=normal><a href=#__codelineno-0-450>450</a></span>
<span class=normal><a href=#__codelineno-0-451>451</a></span>
<span class=normal><a href=#__codelineno-0-452>452</a></span>
<span class=normal><a href=#__codelineno-0-453>453</a></span>
<span class=normal><a href=#__codelineno-0-454>454</a></span>
<span class=normal><a href=#__codelineno-0-455>455</a></span>
<span class=normal><a href=#__codelineno-0-456>456</a></span>
<span class=normal><a href=#__codelineno-0-457>457</a></span>
<span class=normal><a href=#__codelineno-0-458>458</a></span>
<span class=normal><a href=#__codelineno-0-459>459</a></span>
<span class=normal><a href=#__codelineno-0-460>460</a></span>
<span class=normal><a href=#__codelineno-0-461>461</a></span>
<span class=normal><a href=#__codelineno-0-462>462</a></span>
<span class=normal><a href=#__codelineno-0-463>463</a></span>
<span class=normal><a href=#__codelineno-0-464>464</a></span>
<span class=normal><a href=#__codelineno-0-465>465</a></span>
<span class=normal><a href=#__codelineno-0-466>466</a></span>
<span class=normal><a href=#__codelineno-0-467>467</a></span>
<span class=normal><a href=#__codelineno-0-468>468</a></span>
<span class=normal><a href=#__codelineno-0-469>469</a></span>
<span class=normal><a href=#__codelineno-0-470>470</a></span>
<span class=normal><a href=#__codelineno-0-471>471</a></span>
<span class=normal><a href=#__codelineno-0-472>472</a></span>
<span class=normal><a href=#__codelineno-0-473>473</a></span>
<span class=normal><a href=#__codelineno-0-474>474</a></span>
<span class=normal><a href=#__codelineno-0-475>475</a></span>
<span class=normal><a href=#__codelineno-0-476>476</a></span>
<span class=normal><a href=#__codelineno-0-477>477</a></span>
<span class=normal><a href=#__codelineno-0-478>478</a></span>
<span class=normal><a href=#__codelineno-0-479>479</a></span>
<span class=normal><a href=#__codelineno-0-480>480</a></span>
<span class=normal><a href=#__codelineno-0-481>481</a></span>
<span class=normal><a href=#__codelineno-0-482>482</a></span>
<span class=normal><a href=#__codelineno-0-483>483</a></span>
<span class=normal><a href=#__codelineno-0-484>484</a></span>
<span class=normal><a href=#__codelineno-0-485>485</a></span>
<span class=normal><a href=#__codelineno-0-486>486</a></span>
<span class=normal><a href=#__codelineno-0-487>487</a></span>
<span class=normal><a href=#__codelineno-0-488>488</a></span>
<span class=normal><a href=#__codelineno-0-489>489</a></span>
<span class=normal><a href=#__codelineno-0-490>490</a></span>
<span class=normal><a href=#__codelineno-0-491>491</a></span>
<span class=normal><a href=#__codelineno-0-492>492</a></span>
<span class=normal><a href=#__codelineno-0-493>493</a></span>
<span class=normal><a href=#__codelineno-0-494>494</a></span>
<span class=normal><a href=#__codelineno-0-495>495</a></span>
<span class=normal><a href=#__codelineno-0-496>496</a></span>
<span class=normal><a href=#__codelineno-0-497>497</a></span>
<span class=normal><a href=#__codelineno-0-498>498</a></span>
<span class=normal><a href=#__codelineno-0-499>499</a></span>
<span class=normal><a href=#__codelineno-0-500>500</a></span>
<span class=normal><a href=#__codelineno-0-501>501</a></span>
<span class=normal><a href=#__codelineno-0-502>502</a></span>
<span class=normal><a href=#__codelineno-0-503>503</a></span>
<span class=normal><a href=#__codelineno-0-504>504</a></span>
<span class=normal><a href=#__codelineno-0-505>505</a></span>
<span class=normal><a href=#__codelineno-0-506>506</a></span>
<span class=normal><a href=#__codelineno-0-507>507</a></span>
<span class=normal><a href=#__codelineno-0-508>508</a></span>
<span class=normal><a href=#__codelineno-0-509>509</a></span>
<span class=normal><a href=#__codelineno-0-510>510</a></span>
<span class=normal><a href=#__codelineno-0-511>511</a></span>
<span class=normal><a href=#__codelineno-0-512>512</a></span>
<span class=normal><a href=#__codelineno-0-513>513</a></span>
<span class=normal><a href=#__codelineno-0-514>514</a></span>
<span class=normal><a href=#__codelineno-0-515>515</a></span>
<span class=normal><a href=#__codelineno-0-516>516</a></span>
<span class=normal><a href=#__codelineno-0-517>517</a></span>
<span class=normal><a href=#__codelineno-0-518>518</a></span>
<span class=normal><a href=#__codelineno-0-519>519</a></span>
<span class=normal><a href=#__codelineno-0-520>520</a></span>
<span class=normal><a href=#__codelineno-0-521>521</a></span>
<span class=normal><a href=#__codelineno-0-522>522</a></span>
<span class=normal><a href=#__codelineno-0-523>523</a></span>
<span class=normal><a href=#__codelineno-0-524>524</a></span>
<span class=normal><a href=#__codelineno-0-525>525</a></span>
<span class=normal><a href=#__codelineno-0-526>526</a></span>
<span class=normal><a href=#__codelineno-0-527>527</a></span>
<span class=normal><a href=#__codelineno-0-528>528</a></span>
<span class=normal><a href=#__codelineno-0-529>529</a></span>
<span class=normal><a href=#__codelineno-0-530>530</a></span>
<span class=normal><a href=#__codelineno-0-531>531</a></span>
<span class=normal><a href=#__codelineno-0-532>532</a></span>
<span class=normal><a href=#__codelineno-0-533>533</a></span>
<span class=normal><a href=#__codelineno-0-534>534</a></span>
<span class=normal><a href=#__codelineno-0-535>535</a></span>
<span class=normal><a href=#__codelineno-0-536>536</a></span>
<span class=normal><a href=#__codelineno-0-537>537</a></span>
<span class=normal><a href=#__codelineno-0-538>538</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-344><a id=__codelineno-0-344 name=__codelineno-0-344></a><span class=k>def</span><span class=w> </span><span class=nf>tokenize</span><span class=p>(</span>
</span><span id=__span-0-345><a id=__codelineno-0-345 name=__codelineno-0-345></a>    <span class=bp>self</span><span class=p>,</span>
</span><span id=__span-0-346><a id=__codelineno-0-346 name=__codelineno-0-346></a>    <span class=n>gene_sequences</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span> <span class=o>|</span> <span class=nb>list</span><span class=p>[</span><span class=nb>tuple</span><span class=p>[</span><span class=nb>int</span><span class=p>,</span> <span class=nb>float</span><span class=p>]]],</span>
</span><span id=__span-0-347><a id=__codelineno-0-347 name=__codelineno-0-347></a>    <span class=n>expr_sequences</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>list</span><span class=p>[</span><span class=nb>float</span><span class=p>]]</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-0-348><a id=__codelineno-0-348 name=__codelineno-0-348></a>    <span class=n>max_genes</span><span class=p>:</span> <span class=nb>int</span> <span class=o>|</span> <span class=kc>None</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-0-349><a id=__codelineno-0-349 name=__codelineno-0-349></a><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>tuple</span><span class=p>[</span><span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>,</span> <span class=n>torch</span><span class=o>.</span><span class=n>Tensor</span><span class=p>]:</span>
</span><span id=__span-0-350><a id=__codelineno-0-350 name=__codelineno-0-350></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-351><a id=__codelineno-0-351 name=__codelineno-0-351></a><span class=sd>    Tokenize gene expression sequences into model-ready tensors.</span>
</span><span id=__span-0-352><a id=__codelineno-0-352 name=__codelineno-0-352></a>
</span><span id=__span-0-353><a id=__codelineno-0-353 name=__codelineno-0-353></a><span class=sd>    This method converts gene and expression sequences into tokenized tensors</span>
</span><span id=__span-0-354><a id=__codelineno-0-354 name=__codelineno-0-354></a><span class=sd>    suitable for machine learning models. It supports both GeneFormer and scGPT</span>
</span><span id=__span-0-355><a id=__codelineno-0-355 name=__codelineno-0-355></a><span class=sd>    tokenization strategies with optimized vectorized operations.</span>
</span><span id=__span-0-356><a id=__codelineno-0-356 name=__codelineno-0-356></a>
</span><span id=__span-0-357><a id=__codelineno-0-357 name=__codelineno-0-357></a><span class=sd>    Args:</span>
</span><span id=__span-0-358><a id=__codelineno-0-358 name=__codelineno-0-358></a><span class=sd>        gene_sequences: List of gene ID sequences for each cell</span>
</span><span id=__span-0-359><a id=__codelineno-0-359 name=__codelineno-0-359></a><span class=sd>        expr_sequences: List of expression value sequences for each cell (required for scGPT)</span>
</span><span id=__span-0-360><a id=__codelineno-0-360 name=__codelineno-0-360></a><span class=sd>        max_genes: Maximum number of genes per cell (defaults based on tokenizer type)</span>
</span><span id=__span-0-361><a id=__codelineno-0-361 name=__codelineno-0-361></a>
</span><span id=__span-0-362><a id=__codelineno-0-362 name=__codelineno-0-362></a><span class=sd>    Returns:</span>
</span><span id=__span-0-363><a id=__codelineno-0-363 name=__codelineno-0-363></a><span class=sd>        tuple: (input_ids, attention_mask) tensors</span>
</span><span id=__span-0-364><a id=__codelineno-0-364 name=__codelineno-0-364></a><span class=sd>            - input_ids: Tokenized sequences with padding</span>
</span><span id=__span-0-365><a id=__codelineno-0-365 name=__codelineno-0-365></a><span class=sd>            - attention_mask: Boolean mask indicating valid tokens</span>
</span><span id=__span-0-366><a id=__codelineno-0-366 name=__codelineno-0-366></a>
</span><span id=__span-0-367><a id=__codelineno-0-367 name=__codelineno-0-367></a><span class=sd>    Raises:</span>
</span><span id=__span-0-368><a id=__codelineno-0-368 name=__codelineno-0-368></a><span class=sd>        ValueError: If gene_sequences is empty</span>
</span><span id=__span-0-369><a id=__codelineno-0-369 name=__codelineno-0-369></a>
</span><span id=__span-0-370><a id=__codelineno-0-370 name=__codelineno-0-370></a><span class=sd>    Examples:</span>
</span><span id=__span-0-371><a id=__codelineno-0-371 name=__codelineno-0-371></a><span class=sd>        &gt;&gt;&gt; # GeneFormer tokenization</span>
</span><span id=__span-0-372><a id=__codelineno-0-372 name=__codelineno-0-372></a><span class=sd>        &gt;&gt;&gt; gene_sequences = [[1, 2, 3], [4, 5, 6]]</span>
</span><span id=__span-0-373><a id=__codelineno-0-373 name=__codelineno-0-373></a><span class=sd>        &gt;&gt;&gt; input_ids, attention_mask = tokenizer.tokenize(gene_sequences)</span>
</span><span id=__span-0-374><a id=__codelineno-0-374 name=__codelineno-0-374></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Shape: {input_ids.shape}&quot;)</span>
</span><span id=__span-0-375><a id=__codelineno-0-375 name=__codelineno-0-375></a><span class=sd>        Shape: torch.Size([2, 2048])</span>
</span><span id=__span-0-376><a id=__codelineno-0-376 name=__codelineno-0-376></a>
</span><span id=__span-0-377><a id=__codelineno-0-377 name=__codelineno-0-377></a><span class=sd>        &gt;&gt;&gt; # scGPT tokenization</span>
</span><span id=__span-0-378><a id=__codelineno-0-378 name=__codelineno-0-378></a><span class=sd>        &gt;&gt;&gt; gene_sequences = [[1, 2, 3], [4, 5, 6]]</span>
</span><span id=__span-0-379><a id=__codelineno-0-379 name=__codelineno-0-379></a><span class=sd>        &gt;&gt;&gt; expr_sequences = [[0.5, 0.8, 0.2], [0.9, 0.1, 0.7]]</span>
</span><span id=__span-0-380><a id=__codelineno-0-380 name=__codelineno-0-380></a><span class=sd>        &gt;&gt;&gt; input_ids, attention_mask = tokenizer.tokenize(gene_sequences, expr_sequences)</span>
</span><span id=__span-0-381><a id=__codelineno-0-381 name=__codelineno-0-381></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Shape: {input_ids.shape}&quot;)</span>
</span><span id=__span-0-382><a id=__codelineno-0-382 name=__codelineno-0-382></a><span class=sd>        Shape: torch.Size([2, 2050])</span>
</span><span id=__span-0-383><a id=__codelineno-0-383 name=__codelineno-0-383></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-384><a id=__codelineno-0-384 name=__codelineno-0-384></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>gene_sequences</span><span class=p>:</span>
</span><span id=__span-0-385><a id=__codelineno-0-385 name=__codelineno-0-385></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Gene sequences cannot be empty&quot;</span><span class=p>)</span>
</span><span id=__span-0-386><a id=__codelineno-0-386 name=__codelineno-0-386></a>
</span><span id=__span-0-387><a id=__codelineno-0-387 name=__codelineno-0-387></a>    <span class=c1># Set default max_genes based on tokenizer type</span>
</span><span id=__span-0-388><a id=__codelineno-0-388 name=__codelineno-0-388></a>    <span class=k>if</span> <span class=n>max_genes</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-0-389><a id=__codelineno-0-389 name=__codelineno-0-389></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>:</span>
</span><span id=__span-0-390><a id=__codelineno-0-390 name=__codelineno-0-390></a>            <span class=n>max_genes</span> <span class=o>=</span> <span class=mi>2048</span>
</span><span id=__span-0-391><a id=__codelineno-0-391 name=__codelineno-0-391></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-392><a id=__codelineno-0-392 name=__codelineno-0-392></a>            <span class=c1># For scGPT: CLS + (gene,expr)*n + SEP = 2*n + 2</span>
</span><span id=__span-0-393><a id=__codelineno-0-393 name=__codelineno-0-393></a>            <span class=c1># So if we want max_genes total tokens, n = (max_genes - 2) / 2</span>
</span><span id=__span-0-394><a id=__codelineno-0-394 name=__codelineno-0-394></a>            <span class=n>max_genes</span> <span class=o>=</span> <span class=mi>1024</span>  <span class=c1># This is the number of gene-expression pairs</span>
</span><span id=__span-0-395><a id=__codelineno-0-395 name=__codelineno-0-395></a>
</span><span id=__span-0-396><a id=__codelineno-0-396 name=__codelineno-0-396></a>    <span class=c1># Always define max_sequence_length based on tokenizer type</span>
</span><span id=__span-0-397><a id=__codelineno-0-397 name=__codelineno-0-397></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>GENEFORMER</span><span class=p>:</span>
</span><span id=__span-0-398><a id=__codelineno-0-398 name=__codelineno-0-398></a>        <span class=n>max_sequence_length</span> <span class=o>=</span> <span class=n>max_genes</span>  <span class=c1># For Geneformer, same as max_genes</span>
</span><span id=__span-0-399><a id=__codelineno-0-399 name=__codelineno-0-399></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-400><a id=__codelineno-0-400 name=__codelineno-0-400></a>        <span class=c1># For scGPT: CLS + (gene,expr)*n + SEP = 2*n + 2</span>
</span><span id=__span-0-401><a id=__codelineno-0-401 name=__codelineno-0-401></a>        <span class=n>max_sequence_length</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>*</span> <span class=n>max_genes</span> <span class=o>+</span> <span class=mi>2</span>  <span class=c1># Total sequence length</span>
</span><span id=__span-0-402><a id=__codelineno-0-402 name=__codelineno-0-402></a>
</span><span id=__span-0-403><a id=__codelineno-0-403 name=__codelineno-0-403></a>    <span class=c1># For scGPT, gene_sequences now contains struct pairs [(gene, expr), ...]</span>
</span><span id=__span-0-404><a id=__codelineno-0-404 name=__codelineno-0-404></a>    <span class=c1># so we don&#39;t need separate expr_sequences validation</span>
</span><span id=__span-0-405><a id=__codelineno-0-405 name=__codelineno-0-405></a>
</span><span id=__span-0-406><a id=__codelineno-0-406 name=__codelineno-0-406></a>    <span class=n>batch_size</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>)</span>
</span><span id=__span-0-407><a id=__codelineno-0-407 name=__codelineno-0-407></a>
</span><span id=__span-0-408><a id=__codelineno-0-408 name=__codelineno-0-408></a>    <span class=c1># Use fast numpy-based approach (same as original test)</span>
</span><span id=__span-0-409><a id=__codelineno-0-409 name=__codelineno-0-409></a>    <span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-0-410><a id=__codelineno-0-410 name=__codelineno-0-410></a>
</span><span id=__span-0-411><a id=__codelineno-0-411 name=__codelineno-0-411></a>    <span class=c1># Pre-allocate numpy array with correct dimensions</span>
</span><span id=__span-0-412><a id=__codelineno-0-412 name=__codelineno-0-412></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span><span class=p>:</span>
</span><span id=__span-0-413><a id=__codelineno-0-413 name=__codelineno-0-413></a>        <span class=c1># For scGPT: use max_sequence_length (2*max_genes+2)</span>
</span><span id=__span-0-414><a id=__codelineno-0-414 name=__codelineno-0-414></a>        <span class=n>array_width</span> <span class=o>=</span> <span class=n>max_sequence_length</span>
</span><span id=__span-0-415><a id=__codelineno-0-415 name=__codelineno-0-415></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-416><a id=__codelineno-0-416 name=__codelineno-0-416></a>        <span class=c1># For Geneformer: use max_genes</span>
</span><span id=__span-0-417><a id=__codelineno-0-417 name=__codelineno-0-417></a>        <span class=n>array_width</span> <span class=o>=</span> <span class=n>max_genes</span>
</span><span id=__span-0-418><a id=__codelineno-0-418 name=__codelineno-0-418></a>
</span><span id=__span-0-419><a id=__codelineno-0-419 name=__codelineno-0-419></a>    <span class=n>token_array</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-420><a id=__codelineno-0-420 name=__codelineno-0-420></a>        <span class=p>(</span><span class=n>batch_size</span><span class=p>,</span> <span class=n>array_width</span><span class=p>),</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span>
</span><span id=__span-0-421><a id=__codelineno-0-421 name=__codelineno-0-421></a>    <span class=p>)</span>
</span><span id=__span-0-422><a id=__codelineno-0-422 name=__codelineno-0-422></a>
</span><span id=__span-0-423><a id=__codelineno-0-423 name=__codelineno-0-423></a>    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span><span class=p>:</span>
</span><span id=__span-0-424><a id=__codelineno-0-424 name=__codelineno-0-424></a>        <span class=c1># scGPT format: [CLS] gene1 expr1 gene2 expr2 ... [SEP]</span>
</span><span id=__span-0-425><a id=__codelineno-0-425 name=__codelineno-0-425></a>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=p>(</span><span class=n>gene_sequence</span><span class=p>,</span> <span class=n>expr_sequence</span><span class=p>)</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span>
</span><span id=__span-0-426><a id=__codelineno-0-426 name=__codelineno-0-426></a>            <span class=nb>zip</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>,</span> <span class=n>expr_sequences</span> <span class=ow>or</span> <span class=p>[],</span> <span class=n>strict</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-0-427><a id=__codelineno-0-427 name=__codelineno-0-427></a>        <span class=p>):</span>
</span><span id=__span-0-428><a id=__codelineno-0-428 name=__codelineno-0-428></a>            <span class=c1># For scGPT, we now use separate gene_sequence and expr_sequence columns</span>
</span><span id=__span-0-429><a id=__codelineno-0-429 name=__codelineno-0-429></a>            <span class=k>if</span> <span class=n>gene_sequence</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_sequence</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-430><a id=__codelineno-0-430 name=__codelineno-0-430></a>                <span class=c1># Fast path: separate gene_sequence and expr_sequence columns</span>
</span><span id=__span-0-431><a id=__codelineno-0-431 name=__codelineno-0-431></a>                <span class=n>genes</span> <span class=o>=</span> <span class=n>gene_sequence</span>
</span><span id=__span-0-432><a id=__codelineno-0-432 name=__codelineno-0-432></a>                <span class=n>exprs</span> <span class=o>=</span> <span class=n>expr_sequence</span> <span class=k>if</span> <span class=n>expr_sequence</span> <span class=k>else</span> <span class=p>[]</span>
</span><span id=__span-0-433><a id=__codelineno-0-433 name=__codelineno-0-433></a>
</span><span id=__span-0-434><a id=__codelineno-0-434 name=__codelineno-0-434></a>                <span class=c1># Vectorized operations - use simple +4 for performance</span>
</span><span id=__span-0-435><a id=__codelineno-0-435 name=__codelineno-0-435></a>                <span class=n>gene_tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>genes</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span>
</span><span id=__span-0-436><a id=__codelineno-0-436 name=__codelineno-0-436></a>
</span><span id=__span-0-437><a id=__codelineno-0-437 name=__codelineno-0-437></a>                <span class=c1># Handle expression tokens - don&#39;t bin if already binned by window function</span>
</span><span id=__span-0-438><a id=__codelineno-0-438 name=__codelineno-0-438></a>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>exprs</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>exprs</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=nb>int</span> <span class=o>|</span> <span class=n>np</span><span class=o>.</span><span class=n>integer</span><span class=p>):</span>
</span><span id=__span-0-439><a id=__codelineno-0-439 name=__codelineno-0-439></a>                    <span class=c1># Already binned by window function - just convert to tokens</span>
</span><span id=__span-0-440><a id=__codelineno-0-440 name=__codelineno-0-440></a>                    <span class=n>expr_tokens</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-0-441><a id=__codelineno-0-441 name=__codelineno-0-441></a>                        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>exprs</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span>
</span><span id=__span-0-442><a id=__codelineno-0-442 name=__codelineno-0-442></a>                    <span class=p>)</span>
</span><span id=__span-0-443><a id=__codelineno-0-443 name=__codelineno-0-443></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-444><a id=__codelineno-0-444 name=__codelineno-0-444></a>                    <span class=c1># Raw values - need to bin them</span>
</span><span id=__span-0-445><a id=__codelineno-0-445 name=__codelineno-0-445></a>                    <span class=n>expr_tokens</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_expression_to_bin_vectorized</span><span class=p>(</span>
</span><span id=__span-0-446><a id=__codelineno-0-446 name=__codelineno-0-446></a>                        <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>exprs</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>float32</span><span class=p>)</span>
</span><span id=__span-0-447><a id=__codelineno-0-447 name=__codelineno-0-447></a>                    <span class=p>)</span>
</span><span id=__span-0-448><a id=__codelineno-0-448 name=__codelineno-0-448></a>
</span><span id=__span-0-449><a id=__codelineno-0-449 name=__codelineno-0-449></a>                <span class=c1># Vectorized interleaving (much faster than Python loop)</span>
</span><span id=__span-0-450><a id=__codelineno-0-450 name=__codelineno-0-450></a>                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-451><a id=__codelineno-0-451 name=__codelineno-0-451></a>                    <span class=c1># Pre-allocate full sequence: CLS + (gene,expr)*n + SEP</span>
</span><span id=__span-0-452><a id=__codelineno-0-452 name=__codelineno-0-452></a>                    <span class=n>sequence_length</span> <span class=o>=</span> <span class=mi>1</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span>
</span><span id=__span-0-453><a id=__codelineno-0-453 name=__codelineno-0-453></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-454><a id=__codelineno-0-454 name=__codelineno-0-454></a>                        <span class=n>sequence_length</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span>
</span><span id=__span-0-455><a id=__codelineno-0-455 name=__codelineno-0-455></a>                    <span class=p>)</span>
</span><span id=__span-0-456><a id=__codelineno-0-456 name=__codelineno-0-456></a>
</span><span id=__span-0-457><a id=__codelineno-0-457 name=__codelineno-0-457></a>                    <span class=c1># Set CLS token</span>
</span><span id=__span-0-458><a id=__codelineno-0-458 name=__codelineno-0-458></a>                    <span class=n>tokens</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>]</span>
</span><span id=__span-0-459><a id=__codelineno-0-459 name=__codelineno-0-459></a>
</span><span id=__span-0-460><a id=__codelineno-0-460 name=__codelineno-0-460></a>                    <span class=c1># Vectorized interleaving</span>
</span><span id=__span-0-461><a id=__codelineno-0-461 name=__codelineno-0-461></a>                    <span class=n>tokens</span><span class=p>[</span><span class=mi>1</span><span class=p>::</span><span class=mi>2</span><span class=p>][:</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)]</span> <span class=o>=</span> <span class=n>gene_tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-462><a id=__codelineno-0-462 name=__codelineno-0-462></a>                    <span class=n>tokens</span><span class=p>[</span><span class=mi>2</span><span class=p>::</span><span class=mi>2</span><span class=p>][:</span> <span class=nb>len</span><span class=p>(</span><span class=n>expr_tokens</span><span class=p>)]</span> <span class=o>=</span> <span class=n>expr_tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-463><a id=__codelineno-0-463 name=__codelineno-0-463></a>
</span><span id=__span-0-464><a id=__codelineno-0-464 name=__codelineno-0-464></a>                    <span class=n>tokens</span><span class=p>[</span><span class=mi>1</span> <span class=o>+</span> <span class=mi>2</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]</span>
</span><span id=__span-0-465><a id=__codelineno-0-465 name=__codelineno-0-465></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-466><a id=__codelineno-0-466 name=__codelineno-0-466></a>                    <span class=c1># Empty sequence case</span>
</span><span id=__span-0-467><a id=__codelineno-0-467 name=__codelineno-0-467></a>                    <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span>
</span><span id=__span-0-468><a id=__codelineno-0-468 name=__codelineno-0-468></a>                        <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-469><a id=__codelineno-0-469 name=__codelineno-0-469></a>                        <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-470><a id=__codelineno-0-470 name=__codelineno-0-470></a>                    <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-471><a id=__codelineno-0-471 name=__codelineno-0-471></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-472><a id=__codelineno-0-472 name=__codelineno-0-472></a>                <span class=c1># Empty sequence case</span>
</span><span id=__span-0-473><a id=__codelineno-0-473 name=__codelineno-0-473></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span>
</span><span id=__span-0-474><a id=__codelineno-0-474 name=__codelineno-0-474></a>                    <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-475><a id=__codelineno-0-475 name=__codelineno-0-475></a>                    <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-476><a id=__codelineno-0-476 name=__codelineno-0-476></a>                <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-477><a id=__codelineno-0-477 name=__codelineno-0-477></a>
</span><span id=__span-0-478><a id=__codelineno-0-478 name=__codelineno-0-478></a>            <span class=c1># Pad/truncate to correct sequence length</span>
</span><span id=__span-0-479><a id=__codelineno-0-479 name=__codelineno-0-479></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span><span class=p>:</span>
</span><span id=__span-0-480><a id=__codelineno-0-480 name=__codelineno-0-480></a>                <span class=c1># For scGPT: use max_sequence_length (2*max_genes+2)</span>
</span><span id=__span-0-481><a id=__codelineno-0-481 name=__codelineno-0-481></a>                <span class=n>target_length</span> <span class=o>=</span> <span class=n>max_sequence_length</span>
</span><span id=__span-0-482><a id=__codelineno-0-482 name=__codelineno-0-482></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-483><a id=__codelineno-0-483 name=__codelineno-0-483></a>                <span class=c1># For Geneformer: use max_genes</span>
</span><span id=__span-0-484><a id=__codelineno-0-484 name=__codelineno-0-484></a>                <span class=n>target_length</span> <span class=o>=</span> <span class=n>max_genes</span>
</span><span id=__span-0-485><a id=__codelineno-0-485 name=__codelineno-0-485></a>
</span><span id=__span-0-486><a id=__codelineno-0-486 name=__codelineno-0-486></a>            <span class=n>tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[:</span><span class=n>target_length</span><span class=p>]</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-487><a id=__codelineno-0-487 name=__codelineno-0-487></a>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>target_length</span><span class=p>:</span>
</span><span id=__span-0-488><a id=__codelineno-0-488 name=__codelineno-0-488></a>                <span class=n>padding</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-489><a id=__codelineno-0-489 name=__codelineno-0-489></a>                    <span class=n>target_length</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>),</span>
</span><span id=__span-0-490><a id=__codelineno-0-490 name=__codelineno-0-490></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span>
</span><span id=__span-0-491><a id=__codelineno-0-491 name=__codelineno-0-491></a>                    <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-492><a id=__codelineno-0-492 name=__codelineno-0-492></a>                <span class=p>)</span>
</span><span id=__span-0-493><a id=__codelineno-0-493 name=__codelineno-0-493></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>tokens</span><span class=p>,</span> <span class=n>padding</span><span class=p>])</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-494><a id=__codelineno-0-494 name=__codelineno-0-494></a>
</span><span id=__span-0-495><a id=__codelineno-0-495 name=__codelineno-0-495></a>            <span class=c1># Fill array</span>
</span><span id=__span-0-496><a id=__codelineno-0-496 name=__codelineno-0-496></a>            <span class=n>token_array</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=p>:]</span> <span class=o>=</span> <span class=n>tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-497><a id=__codelineno-0-497 name=__codelineno-0-497></a>
</span><span id=__span-0-498><a id=__codelineno-0-498 name=__codelineno-0-498></a>    <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-499><a id=__codelineno-0-499 name=__codelineno-0-499></a>        <span class=c1># Geneformer format: [CLS] gene1 gene2 gene3 ... [SEP]</span>
</span><span id=__span-0-500><a id=__codelineno-0-500 name=__codelineno-0-500></a>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>gene_sequence</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>gene_sequences</span><span class=p>):</span>
</span><span id=__span-0-501><a id=__codelineno-0-501 name=__codelineno-0-501></a>            <span class=c1># Convert gene IDs to tokens (fast mapping)</span>
</span><span id=__span-0-502><a id=__codelineno-0-502 name=__codelineno-0-502></a>            <span class=n>gene_tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>gene_sequence</span><span class=p>,</span> <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>)</span> <span class=o>+</span> <span class=mi>4</span>
</span><span id=__span-0-503><a id=__codelineno-0-503 name=__codelineno-0-503></a>
</span><span id=__span-0-504><a id=__codelineno-0-504 name=__codelineno-0-504></a>            <span class=c1># Vectorized sequence building: use concatenation for speed</span>
</span><span id=__span-0-505><a id=__codelineno-0-505 name=__codelineno-0-505></a>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>gene_tokens</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-0-506><a id=__codelineno-0-506 name=__codelineno-0-506></a>                <span class=c1># Use concatenation: CLS + genes + SEP</span>
</span><span id=__span-0-507><a id=__codelineno-0-507 name=__codelineno-0-507></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span>
</span><span id=__span-0-508><a id=__codelineno-0-508 name=__codelineno-0-508></a>                    <span class=p>[</span>
</span><span id=__span-0-509><a id=__codelineno-0-509 name=__codelineno-0-509></a>                        <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>]],</span>
</span><span id=__span-0-510><a id=__codelineno-0-510 name=__codelineno-0-510></a>                        <span class=n>gene_tokens</span><span class=p>,</span>
</span><span id=__span-0-511><a id=__codelineno-0-511 name=__codelineno-0-511></a>                        <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-512><a id=__codelineno-0-512 name=__codelineno-0-512></a>                    <span class=p>]</span>
</span><span id=__span-0-513><a id=__codelineno-0-513 name=__codelineno-0-513></a>                <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-514><a id=__codelineno-0-514 name=__codelineno-0-514></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-515><a id=__codelineno-0-515 name=__codelineno-0-515></a>                <span class=c1># Empty sequence case</span>
</span><span id=__span-0-516><a id=__codelineno-0-516 name=__codelineno-0-516></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span>
</span><span id=__span-0-517><a id=__codelineno-0-517 name=__codelineno-0-517></a>                    <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>],</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]],</span>
</span><span id=__span-0-518><a id=__codelineno-0-518 name=__codelineno-0-518></a>                    <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-519><a id=__codelineno-0-519 name=__codelineno-0-519></a>                <span class=p>)</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-520><a id=__codelineno-0-520 name=__codelineno-0-520></a>
</span><span id=__span-0-521><a id=__codelineno-0-521 name=__codelineno-0-521></a>            <span class=c1># Pad/truncate to max_genes</span>
</span><span id=__span-0-522><a id=__codelineno-0-522 name=__codelineno-0-522></a>            <span class=n>tokens</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[:</span><span class=n>max_genes</span><span class=p>]</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-523><a id=__codelineno-0-523 name=__codelineno-0-523></a>            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span> <span class=o>&lt;</span> <span class=n>max_genes</span><span class=p>:</span>
</span><span id=__span-0-524><a id=__codelineno-0-524 name=__codelineno-0-524></a>                <span class=n>padding</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>full</span><span class=p>(</span>
</span><span id=__span-0-525><a id=__codelineno-0-525 name=__codelineno-0-525></a>                    <span class=n>max_genes</span> <span class=o>-</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>),</span>
</span><span id=__span-0-526><a id=__codelineno-0-526 name=__codelineno-0-526></a>                    <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>],</span>
</span><span id=__span-0-527><a id=__codelineno-0-527 name=__codelineno-0-527></a>                    <span class=n>dtype</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>int64</span><span class=p>,</span>
</span><span id=__span-0-528><a id=__codelineno-0-528 name=__codelineno-0-528></a>                <span class=p>)</span>
</span><span id=__span-0-529><a id=__codelineno-0-529 name=__codelineno-0-529></a>                <span class=n>tokens</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>tokens</span><span class=p>,</span> <span class=n>padding</span><span class=p>])</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-530><a id=__codelineno-0-530 name=__codelineno-0-530></a>
</span><span id=__span-0-531><a id=__codelineno-0-531 name=__codelineno-0-531></a>            <span class=c1># Fill array</span>
</span><span id=__span-0-532><a id=__codelineno-0-532 name=__codelineno-0-532></a>            <span class=n>token_array</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=p>:]</span> <span class=o>=</span> <span class=n>tokens</span>  <span class=c1># type: ignore[assignment]</span>
</span><span id=__span-0-533><a id=__codelineno-0-533 name=__codelineno-0-533></a>
</span><span id=__span-0-534><a id=__codelineno-0-534 name=__codelineno-0-534></a>    <span class=c1># Convert to tensors in one operation</span>
</span><span id=__span-0-535><a id=__codelineno-0-535 name=__codelineno-0-535></a>    <span class=n>input_ids</span> <span class=o>=</span> <span class=n>torch</span><span class=o>.</span><span class=n>from_numpy</span><span class=p>(</span><span class=n>token_array</span><span class=p>)</span>
</span><span id=__span-0-536><a id=__codelineno-0-536 name=__codelineno-0-536></a>    <span class=n>attention_mask</span> <span class=o>=</span> <span class=n>input_ids</span> <span class=o>!=</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>]</span>
</span><span id=__span-0-537><a id=__codelineno-0-537 name=__codelineno-0-537></a>
</span><span id=__span-0-538><a id=__codelineno-0-538 name=__codelineno-0-538></a>    <span class=k>return</span> <span class=n>input_ids</span><span class=p>,</span> <span class=n>attention_mask</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tokenizers.SLAFTokenizer.get_vocab_info class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_vocab_info</span><span class=p>()</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span></code> <a href=#slaf.ml.tokenizers.SLAFTokenizer.get_vocab_info class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Get vocabulary information for debugging and analysis.</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>dict</code></td> <td> <code><span title=dict>dict</span>[<span title=str>str</span>, <span title=typing.Any>Any</span>]</code> </td> <td> <div class=doc-md-description> <p>Vocabulary information including size, special tokens, etc.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=n>vocab_info</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>get_vocab_info</span><span class=p>()</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Vocabulary size: </span><span class=si>{</span><span class=n>vocab_info</span><span class=p>[</span><span class=s1>&#39;vocab_size&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Special tokens: </span><span class=si>{</span><span class=n>vocab_info</span><span class=p>[</span><span class=s1>&#39;special_tokens&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=go>Vocabulary size: 50000</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=go>Special tokens: {&#39;PAD&#39;: 0, &#39;CLS&#39;: 1, &#39;SEP&#39;: 2, &#39;MASK&#39;: 3}</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tokenizers.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-540>540</a></span>
<span class=normal><a href=#__codelineno-0-541>541</a></span>
<span class=normal><a href=#__codelineno-0-542>542</a></span>
<span class=normal><a href=#__codelineno-0-543>543</a></span>
<span class=normal><a href=#__codelineno-0-544>544</a></span>
<span class=normal><a href=#__codelineno-0-545>545</a></span>
<span class=normal><a href=#__codelineno-0-546>546</a></span>
<span class=normal><a href=#__codelineno-0-547>547</a></span>
<span class=normal><a href=#__codelineno-0-548>548</a></span>
<span class=normal><a href=#__codelineno-0-549>549</a></span>
<span class=normal><a href=#__codelineno-0-550>550</a></span>
<span class=normal><a href=#__codelineno-0-551>551</a></span>
<span class=normal><a href=#__codelineno-0-552>552</a></span>
<span class=normal><a href=#__codelineno-0-553>553</a></span>
<span class=normal><a href=#__codelineno-0-554>554</a></span>
<span class=normal><a href=#__codelineno-0-555>555</a></span>
<span class=normal><a href=#__codelineno-0-556>556</a></span>
<span class=normal><a href=#__codelineno-0-557>557</a></span>
<span class=normal><a href=#__codelineno-0-558>558</a></span>
<span class=normal><a href=#__codelineno-0-559>559</a></span>
<span class=normal><a href=#__codelineno-0-560>560</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-540><a id=__codelineno-0-540 name=__codelineno-0-540></a><span class=k>def</span><span class=w> </span><span class=nf>get_vocab_info</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-0-541><a id=__codelineno-0-541 name=__codelineno-0-541></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-542><a id=__codelineno-0-542 name=__codelineno-0-542></a><span class=sd>    Get vocabulary information for debugging and analysis.</span>
</span><span id=__span-0-543><a id=__codelineno-0-543 name=__codelineno-0-543></a>
</span><span id=__span-0-544><a id=__codelineno-0-544 name=__codelineno-0-544></a><span class=sd>    Returns:</span>
</span><span id=__span-0-545><a id=__codelineno-0-545 name=__codelineno-0-545></a><span class=sd>        dict: Vocabulary information including size, special tokens, etc.</span>
</span><span id=__span-0-546><a id=__codelineno-0-546 name=__codelineno-0-546></a>
</span><span id=__span-0-547><a id=__codelineno-0-547 name=__codelineno-0-547></a><span class=sd>    Examples:</span>
</span><span id=__span-0-548><a id=__codelineno-0-548 name=__codelineno-0-548></a><span class=sd>        &gt;&gt;&gt; vocab_info = tokenizer.get_vocab_info()</span>
</span><span id=__span-0-549><a id=__codelineno-0-549 name=__codelineno-0-549></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Vocabulary size: {vocab_info[&#39;vocab_size&#39;]}&quot;)</span>
</span><span id=__span-0-550><a id=__codelineno-0-550 name=__codelineno-0-550></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Special tokens: {vocab_info[&#39;special_tokens&#39;]}&quot;)</span>
</span><span id=__span-0-551><a id=__codelineno-0-551 name=__codelineno-0-551></a><span class=sd>        Vocabulary size: 50000</span>
</span><span id=__span-0-552><a id=__codelineno-0-552 name=__codelineno-0-552></a><span class=sd>        Special tokens: {&#39;PAD&#39;: 0, &#39;CLS&#39;: 1, &#39;SEP&#39;: 2, &#39;MASK&#39;: 3}</span>
</span><span id=__span-0-553><a id=__codelineno-0-553 name=__codelineno-0-553></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-554><a id=__codelineno-0-554 name=__codelineno-0-554></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-555><a id=__codelineno-0-555 name=__codelineno-0-555></a>        <span class=s2>&quot;vocab_size&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>vocab_size</span><span class=p>,</span>
</span><span id=__span-0-556><a id=__codelineno-0-556 name=__codelineno-0-556></a>        <span class=s2>&quot;tokenizer_type&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span><span class=o>.</span><span class=n>value</span><span class=p>,</span>
</span><span id=__span-0-557><a id=__codelineno-0-557 name=__codelineno-0-557></a>        <span class=s2>&quot;special_tokens&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>,</span>
</span><span id=__span-0-558><a id=__codelineno-0-558 name=__codelineno-0-558></a>        <span class=s2>&quot;n_expression_bins&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>n_expression_bins</span><span class=p>,</span>
</span><span id=__span-0-559><a id=__codelineno-0-559 name=__codelineno-0-559></a>        <span class=s2>&quot;gene_vocab_size&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>gene_vocab</span><span class=p>),</span>
</span><span id=__span-0-560><a id=__codelineno-0-560 name=__codelineno-0-560></a>    <span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h6 id=slaf.ml.tokenizers.SLAFTokenizer.decode_tokens class="doc doc-heading"> <code class="highlight language-python"><span class=n>decode_tokens</span><span class=p>(</span><span class=n>tokens</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span></code> <a href=#slaf.ml.tokenizers.SLAFTokenizer.decode_tokens class=headerlink title="Permanent link">&para;</a></h6> <div class="doc doc-contents "> <p>Decode token sequence back to gene information.</p> <p><span class=doc-section-title>Parameters:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> <th>Default</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> <code>tokens</code> </td> <td> <code><span title=list>list</span>[<span title=int>int</span>]</code> </td> <td> <div class=doc-md-description> <p>List of token IDs to decode</p> </div> </td> <td> <em>required</em> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Name</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td><code>dict</code></td> <td> <code><span title=dict>dict</span>[<span title=str>str</span>, <span title=typing.Any>Any</span>]</code> </td> <td> <div class=doc-md-description> <p>Decoded information including genes, expressions, etc.</p> </div> </td> </tr> </tbody> </table> <p><span class=doc-section-title>Examples:</span></p> <div class="language-pycon highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=gp>&gt;&gt;&gt; </span><span class=c1># Decode a token sequence</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=gp>&gt;&gt;&gt; </span><span class=n>tokens</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>50050</span><span class=p>,</span> <span class=mi>200</span><span class=p>,</span> <span class=mi>50060</span><span class=p>,</span> <span class=mi>2</span><span class=p>]</span>  <span class=c1># CLS, gene1, expr1, gene2, expr2, SEP</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=gp>&gt;&gt;&gt; </span><span class=n>decoded</span> <span class=o>=</span> <span class=n>tokenizer</span><span class=o>.</span><span class=n>decode_tokens</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Genes: </span><span class=si>{</span><span class=n>decoded</span><span class=p>[</span><span class=s1>&#39;genes&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=gp>&gt;&gt;&gt; </span><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Expressions: </span><span class=si>{</span><span class=n>decoded</span><span class=p>[</span><span class=s1>&#39;expressions&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=go>Genes: [&#39;gene_100&#39;, &#39;gene_200&#39;]</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=go>Expressions: [0.5, 0.6]</span>
</span></code></pre></div> <details class=mkdocstrings-source> <summary>Source code in <code>slaf/ml/tokenizers.py</code></summary> <div class="language-python highlight"><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-562>562</a></span>
<span class=normal><a href=#__codelineno-0-563>563</a></span>
<span class=normal><a href=#__codelineno-0-564>564</a></span>
<span class=normal><a href=#__codelineno-0-565>565</a></span>
<span class=normal><a href=#__codelineno-0-566>566</a></span>
<span class=normal><a href=#__codelineno-0-567>567</a></span>
<span class=normal><a href=#__codelineno-0-568>568</a></span>
<span class=normal><a href=#__codelineno-0-569>569</a></span>
<span class=normal><a href=#__codelineno-0-570>570</a></span>
<span class=normal><a href=#__codelineno-0-571>571</a></span>
<span class=normal><a href=#__codelineno-0-572>572</a></span>
<span class=normal><a href=#__codelineno-0-573>573</a></span>
<span class=normal><a href=#__codelineno-0-574>574</a></span>
<span class=normal><a href=#__codelineno-0-575>575</a></span>
<span class=normal><a href=#__codelineno-0-576>576</a></span>
<span class=normal><a href=#__codelineno-0-577>577</a></span>
<span class=normal><a href=#__codelineno-0-578>578</a></span>
<span class=normal><a href=#__codelineno-0-579>579</a></span>
<span class=normal><a href=#__codelineno-0-580>580</a></span>
<span class=normal><a href=#__codelineno-0-581>581</a></span>
<span class=normal><a href=#__codelineno-0-582>582</a></span>
<span class=normal><a href=#__codelineno-0-583>583</a></span>
<span class=normal><a href=#__codelineno-0-584>584</a></span>
<span class=normal><a href=#__codelineno-0-585>585</a></span>
<span class=normal><a href=#__codelineno-0-586>586</a></span>
<span class=normal><a href=#__codelineno-0-587>587</a></span>
<span class=normal><a href=#__codelineno-0-588>588</a></span>
<span class=normal><a href=#__codelineno-0-589>589</a></span>
<span class=normal><a href=#__codelineno-0-590>590</a></span>
<span class=normal><a href=#__codelineno-0-591>591</a></span>
<span class=normal><a href=#__codelineno-0-592>592</a></span>
<span class=normal><a href=#__codelineno-0-593>593</a></span>
<span class=normal><a href=#__codelineno-0-594>594</a></span>
<span class=normal><a href=#__codelineno-0-595>595</a></span>
<span class=normal><a href=#__codelineno-0-596>596</a></span>
<span class=normal><a href=#__codelineno-0-597>597</a></span>
<span class=normal><a href=#__codelineno-0-598>598</a></span>
<span class=normal><a href=#__codelineno-0-599>599</a></span>
<span class=normal><a href=#__codelineno-0-600>600</a></span>
<span class=normal><a href=#__codelineno-0-601>601</a></span>
<span class=normal><a href=#__codelineno-0-602>602</a></span>
<span class=normal><a href=#__codelineno-0-603>603</a></span>
<span class=normal><a href=#__codelineno-0-604>604</a></span>
<span class=normal><a href=#__codelineno-0-605>605</a></span>
<span class=normal><a href=#__codelineno-0-606>606</a></span>
<span class=normal><a href=#__codelineno-0-607>607</a></span>
<span class=normal><a href=#__codelineno-0-608>608</a></span>
<span class=normal><a href=#__codelineno-0-609>609</a></span>
<span class=normal><a href=#__codelineno-0-610>610</a></span>
<span class=normal><a href=#__codelineno-0-611>611</a></span>
<span class=normal><a href=#__codelineno-0-612>612</a></span>
<span class=normal><a href=#__codelineno-0-613>613</a></span>
<span class=normal><a href=#__codelineno-0-614>614</a></span>
<span class=normal><a href=#__codelineno-0-615>615</a></span>
<span class=normal><a href=#__codelineno-0-616>616</a></span>
<span class=normal><a href=#__codelineno-0-617>617</a></span>
<span class=normal><a href=#__codelineno-0-618>618</a></span>
<span class=normal><a href=#__codelineno-0-619>619</a></span>
<span class=normal><a href=#__codelineno-0-620>620</a></span>
<span class=normal><a href=#__codelineno-0-621>621</a></span>
<span class=normal><a href=#__codelineno-0-622>622</a></span>
<span class=normal><a href=#__codelineno-0-623>623</a></span>
<span class=normal><a href=#__codelineno-0-624>624</a></span>
<span class=normal><a href=#__codelineno-0-625>625</a></span></pre></div></td><td class=code><div><pre><span></span><code><span id=__span-0-562><a id=__codelineno-0-562 name=__codelineno-0-562></a><span class=k>def</span><span class=w> </span><span class=nf>decode_tokens</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tokens</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>int</span><span class=p>])</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]:</span>
</span><span id=__span-0-563><a id=__codelineno-0-563 name=__codelineno-0-563></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-0-564><a id=__codelineno-0-564 name=__codelineno-0-564></a><span class=sd>    Decode token sequence back to gene information.</span>
</span><span id=__span-0-565><a id=__codelineno-0-565 name=__codelineno-0-565></a>
</span><span id=__span-0-566><a id=__codelineno-0-566 name=__codelineno-0-566></a><span class=sd>    Args:</span>
</span><span id=__span-0-567><a id=__codelineno-0-567 name=__codelineno-0-567></a><span class=sd>        tokens: List of token IDs to decode</span>
</span><span id=__span-0-568><a id=__codelineno-0-568 name=__codelineno-0-568></a>
</span><span id=__span-0-569><a id=__codelineno-0-569 name=__codelineno-0-569></a><span class=sd>    Returns:</span>
</span><span id=__span-0-570><a id=__codelineno-0-570 name=__codelineno-0-570></a><span class=sd>        dict: Decoded information including genes, expressions, etc.</span>
</span><span id=__span-0-571><a id=__codelineno-0-571 name=__codelineno-0-571></a>
</span><span id=__span-0-572><a id=__codelineno-0-572 name=__codelineno-0-572></a><span class=sd>    Examples:</span>
</span><span id=__span-0-573><a id=__codelineno-0-573 name=__codelineno-0-573></a><span class=sd>        &gt;&gt;&gt; # Decode a token sequence</span>
</span><span id=__span-0-574><a id=__codelineno-0-574 name=__codelineno-0-574></a><span class=sd>        &gt;&gt;&gt; tokens = [1, 100, 50050, 200, 50060, 2]  # CLS, gene1, expr1, gene2, expr2, SEP</span>
</span><span id=__span-0-575><a id=__codelineno-0-575 name=__codelineno-0-575></a><span class=sd>        &gt;&gt;&gt; decoded = tokenizer.decode_tokens(tokens)</span>
</span><span id=__span-0-576><a id=__codelineno-0-576 name=__codelineno-0-576></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Genes: {decoded[&#39;genes&#39;]}&quot;)</span>
</span><span id=__span-0-577><a id=__codelineno-0-577 name=__codelineno-0-577></a><span class=sd>        &gt;&gt;&gt; print(f&quot;Expressions: {decoded[&#39;expressions&#39;]}&quot;)</span>
</span><span id=__span-0-578><a id=__codelineno-0-578 name=__codelineno-0-578></a><span class=sd>        Genes: [&#39;gene_100&#39;, &#39;gene_200&#39;]</span>
</span><span id=__span-0-579><a id=__codelineno-0-579 name=__codelineno-0-579></a><span class=sd>        Expressions: [0.5, 0.6]</span>
</span><span id=__span-0-580><a id=__codelineno-0-580 name=__codelineno-0-580></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-0-581><a id=__codelineno-0-581 name=__codelineno-0-581></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>tokens</span><span class=p>:</span>
</span><span id=__span-0-582><a id=__codelineno-0-582 name=__codelineno-0-582></a>        <span class=k>return</span> <span class=p>{</span><span class=s2>&quot;genes&quot;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&quot;expressions&quot;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&quot;special_tokens&quot;</span><span class=p>:</span> <span class=p>[]}</span>
</span><span id=__span-0-583><a id=__codelineno-0-583 name=__codelineno-0-583></a>
</span><span id=__span-0-584><a id=__codelineno-0-584 name=__codelineno-0-584></a>    <span class=n>genes</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-585><a id=__codelineno-0-585 name=__codelineno-0-585></a>    <span class=n>expressions</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-586><a id=__codelineno-0-586 name=__codelineno-0-586></a>    <span class=n>special_tokens</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-0-587><a id=__codelineno-0-587 name=__codelineno-0-587></a>
</span><span id=__span-0-588><a id=__codelineno-0-588 name=__codelineno-0-588></a>    <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-0-589><a id=__codelineno-0-589 name=__codelineno-0-589></a>    <span class=k>while</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>):</span>
</span><span id=__span-0-590><a id=__codelineno-0-590 name=__codelineno-0-590></a>        <span class=n>token</span> <span class=o>=</span> <span class=n>tokens</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span><span id=__span-0-591><a id=__codelineno-0-591 name=__codelineno-0-591></a>
</span><span id=__span-0-592><a id=__codelineno-0-592 name=__codelineno-0-592></a>        <span class=k>if</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;CLS&quot;</span><span class=p>]:</span>
</span><span id=__span-0-593><a id=__codelineno-0-593 name=__codelineno-0-593></a>            <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;CLS&quot;</span><span class=p>)</span>
</span><span id=__span-0-594><a id=__codelineno-0-594 name=__codelineno-0-594></a>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-595><a id=__codelineno-0-595 name=__codelineno-0-595></a>        <span class=k>elif</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;SEP&quot;</span><span class=p>]:</span>
</span><span id=__span-0-596><a id=__codelineno-0-596 name=__codelineno-0-596></a>            <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;SEP&quot;</span><span class=p>)</span>
</span><span id=__span-0-597><a id=__codelineno-0-597 name=__codelineno-0-597></a>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-598><a id=__codelineno-0-598 name=__codelineno-0-598></a>        <span class=k>elif</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;PAD&quot;</span><span class=p>]:</span>
</span><span id=__span-0-599><a id=__codelineno-0-599 name=__codelineno-0-599></a>            <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;PAD&quot;</span><span class=p>)</span>
</span><span id=__span-0-600><a id=__codelineno-0-600 name=__codelineno-0-600></a>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-601><a id=__codelineno-0-601 name=__codelineno-0-601></a>        <span class=k>elif</span> <span class=n>token</span> <span class=o>==</span> <span class=bp>self</span><span class=o>.</span><span class=n>special_tokens</span><span class=p>[</span><span class=s2>&quot;MASK&quot;</span><span class=p>]:</span>
</span><span id=__span-0-602><a id=__codelineno-0-602 name=__codelineno-0-602></a>            <span class=n>special_tokens</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;MASK&quot;</span><span class=p>)</span>
</span><span id=__span-0-603><a id=__codelineno-0-603 name=__codelineno-0-603></a>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-604><a id=__codelineno-0-604 name=__codelineno-0-604></a>        <span class=k>elif</span> <span class=p>(</span>
</span><span id=__span-0-605><a id=__codelineno-0-605 name=__codelineno-0-605></a>            <span class=bp>self</span><span class=o>.</span><span class=n>tokenizer_type</span> <span class=o>==</span> <span class=n>TokenizerType</span><span class=o>.</span><span class=n>SCPGPT</span>
</span><span id=__span-0-606><a id=__codelineno-0-606 name=__codelineno-0-606></a>            <span class=ow>and</span> <span class=n>token</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span>
</span><span id=__span-0-607><a id=__codelineno-0-607 name=__codelineno-0-607></a>        <span class=p>):</span>
</span><span id=__span-0-608><a id=__codelineno-0-608 name=__codelineno-0-608></a>            <span class=c1># Expression token</span>
</span><span id=__span-0-609><a id=__codelineno-0-609 name=__codelineno-0-609></a>            <span class=n>bin_id</span> <span class=o>=</span> <span class=n>token</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_start</span>
</span><span id=__span-0-610><a id=__codelineno-0-610 name=__codelineno-0-610></a>            <span class=n>expr_value</span> <span class=o>=</span> <span class=n>bin_id</span> <span class=o>*</span> <span class=bp>self</span><span class=o>.</span><span class=n>expr_bin_size</span>
</span><span id=__span-0-611><a id=__codelineno-0-611 name=__codelineno-0-611></a>            <span class=n>expressions</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>expr_value</span><span class=p>)</span>
</span><span id=__span-0-612><a id=__codelineno-0-612 name=__codelineno-0-612></a>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-613><a id=__codelineno-0-613 name=__codelineno-0-613></a>        <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-614><a id=__codelineno-0-614 name=__codelineno-0-614></a>            <span class=c1># Gene token</span>
</span><span id=__span-0-615><a id=__codelineno-0-615 name=__codelineno-0-615></a>            <span class=k>if</span> <span class=n>token</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span><span class=p>:</span>
</span><span id=__span-0-616><a id=__codelineno-0-616 name=__codelineno-0-616></a>                <span class=n>genes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>token_to_gene</span><span class=p>[</span><span class=n>token</span><span class=p>])</span>
</span><span id=__span-0-617><a id=__codelineno-0-617 name=__codelineno-0-617></a>            <span class=k>else</span><span class=p>:</span>
</span><span id=__span-0-618><a id=__codelineno-0-618 name=__codelineno-0-618></a>                <span class=n>genes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;unknown_gene_</span><span class=si>{</span><span class=n>token</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-0-619><a id=__codelineno-0-619 name=__codelineno-0-619></a>            <span class=n>i</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-0-620><a id=__codelineno-0-620 name=__codelineno-0-620></a>
</span><span id=__span-0-621><a id=__codelineno-0-621 name=__codelineno-0-621></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-0-622><a id=__codelineno-0-622 name=__codelineno-0-622></a>        <span class=s2>&quot;genes&quot;</span><span class=p>:</span> <span class=n>genes</span><span class=p>,</span>
</span><span id=__span-0-623><a id=__codelineno-0-623 name=__codelineno-0-623></a>        <span class=s2>&quot;expressions&quot;</span><span class=p>:</span> <span class=n>expressions</span><span class=p>,</span>
</span><span id=__span-0-624><a id=__codelineno-0-624 name=__codelineno-0-624></a>        <span class=s2>&quot;special_tokens&quot;</span><span class=p>:</span> <span class=n>special_tokens</span><span class=p>,</span>
</span><span id=__span-0-625><a id=__codelineno-0-625 name=__codelineno-0-625></a>    <span class=p>}</span>
</span></code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> </div> </div> </div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="September 6, 2025 01:03:31 UTC">September 6, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="July 3, 2025 19:35:35 UTC">July 3, 2025</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Contributors> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg> </span> <nav> Pavan Ramkumar </nav> </span> </aside> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2026 Pavan Ramkumar </div> </div> <div class=md-social> <a href=https://github.com/slaf-project/slaf target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.sections", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src=../../javascripts/theme-reset.js></script> <script src=../../javascripts/copy-enhancement.js></script> <script src=../../javascripts/theme-aware-assets.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>